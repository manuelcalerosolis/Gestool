#line 112 "hbclass.ch"
   DYNAMIC DivertConstructorCall
















DECLARE HBClass  New( cName AS String, OPTIONAL SuperParams ) AS CLASS HBClass  Create() AS Object  Instance() AS Object  AddClsMethod( cName AS String, @MethodName(), nScope AS Numeric, n2 AS Numeric, n3 AS Numeric )  AddDelegate( cName AS String, cDelegate AS String, cObject AS String, nScope AS Numeric, lPersistent AS LOGICAL )  AddMultiClsData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String )  AddMultiData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String, x AS LOGICAL, lPer AS LOGICAL )  AddMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  AddInLine( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  AddVirtual( cName AS String )  ModMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  ModClsMethod( cName AS String, @MethodName(), nScope AS Numeric )  ModInline( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  SetOnError( @MethodName() )
#line 85 "\Fwh1204\Include\FiveWin.Ch"
   EXTERNAL GetProcAdd
   EXTERNAL TActiveX




extern errorsys
#line 11 ".\Prg\Remmov.prg"
memvar oDbf
memvar cDbf
memvar cDbfCol
memvar oDbfCol
memvar cDbfAlm
memvar cDbfPro
memvar cDbfFam
memvar cDbfMov
memvar cDbfArt
memvar cDbfAge
memvar oThis
memvar cPouDivRem
memvar cPorDivRem
memvar nPagina
memvar lEnd
memvar nTotMov

static oRemesas
static oMenu

static cTmpLin
static dbfTmpLin

static dbfRemMov
static dbfHisMov
static dbfTMov
static dbfAlm
static dbfAge
static dbfArticulo
static dbfCount
static dbfPro
static dbfTblPro
static dbfAlbCliT
static dbfAlbCliL
static dbfFacCliT
static dbfFacCliL

static cOldCodArt       := ""



_HB_CLASS TRemMovAlm ; UTILITY FUNCTION TRemMovAlm(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TRemMovAlm" , {TMasDet():classh} ) ) ; ;

   _HB_MEMBER { oArt} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oArt" }, .F., .F. ), )
   _HB_MEMBER { oArtKit} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oArtKit" }, .F., .F. ), )
   _HB_MEMBER { oUsr} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oUsr" }, .F., .F. ), )
   _HB_MEMBER { oDbfDoc} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDbfDoc" }, .F., .F. ), )
   _HB_MEMBER { oDbfCnt} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDbfCnt" }, .F., .F. ), )
   _HB_MEMBER { oDelega} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDelega" }, .F., .F. ), )
   _HB_MEMBER { aCal} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "aCal" }, .F., .F. ), )
   _HB_MEMBER { cMru} ; IIF( !.F., s_oClass:AddMultiData(, "Pencil_Package_16", nScope + IIF( .F., 32, 0 ), { "cMru" }, .F., .F. ), )
   _HB_MEMBER { cBitmap} ; IIF( !.F., s_oClass:AddMultiData(, ( 128 + ( 57 * 256 ) + ( 123 * 65536 ) ), nScope + IIF( .F., 32, 0 ), { "cBitmap" }, .F., .F. ), )
   _HB_MEMBER { oAlm} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oAlm" }, .F., .F. ), )
   _HB_MEMBER { oFam} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFam" }, .F., .F. ), )
   _HB_MEMBER { oTipArt} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oTipArt" }, .F., .F. ), )
   _HB_MEMBER { oPro} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oPro" }, .F., .F. ), )
   _HB_MEMBER { oTblPro} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oTblPro" }, .F., .F. ), )
   _HB_MEMBER { oArtCom} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oArtCom" }, .F., .F. ), )
   _HB_MEMBER { oTMov} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oTMov" }, .F., .F. ), )
   _HB_MEMBER { oStock} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oStock" }, .F., .F. ), )

   _HB_MEMBER { oPedPrvT} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oPedPrvT" }, .F., .F. ), )
   _HB_MEMBER { oPedPrvL} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oPedPrvL" }, .F., .F. ), )
   _HB_MEMBER { oAlbPrvT} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oAlbPrvT" }, .F., .F. ), )
   _HB_MEMBER { oAlbPrvL} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oAlbPrvL" }, .F., .F. ), )
   _HB_MEMBER { oAlbPrvS} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oAlbPrvS" }, .F., .F. ), )
   _HB_MEMBER { oFacPrvT} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFacPrvT" }, .F., .F. ), )
   _HB_MEMBER { oFacPrvL} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFacPrvL" }, .F., .F. ), )
   _HB_MEMBER { oFacPrvS} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFacPrvS" }, .F., .F. ), )
   _HB_MEMBER { oRctPrvT} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oRctPrvT" }, .F., .F. ), )
   _HB_MEMBER { oRctPrvL} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oRctPrvL" }, .F., .F. ), )
   _HB_MEMBER { oRctPrvS} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oRctPrvS" }, .F., .F. ), )
   _HB_MEMBER { oPedCliT} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oPedCliT" }, .F., .F. ), )
   _HB_MEMBER { oPedCliL} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oPedCliL" }, .F., .F. ), )
   _HB_MEMBER { oPedCliR} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oPedCliR" }, .F., .F. ), )
   _HB_MEMBER { oAlbCliT} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oAlbCliT" }, .F., .F. ), )
   _HB_MEMBER { oAlbCliL} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oAlbCliL" }, .F., .F. ), )
   _HB_MEMBER { oAlbCliS} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oAlbCliS" }, .F., .F. ), )
   _HB_MEMBER { oFacCliT} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFacCliT" }, .F., .F. ), )
   _HB_MEMBER { oFacCliL} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFacCliL" }, .F., .F. ), )
   _HB_MEMBER { oFacCliS} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFacCliS" }, .F., .F. ), )
   _HB_MEMBER { oFacRecT} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFacRecT" }, .F., .F. ), )
   _HB_MEMBER { oFacRecL} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFacRecL" }, .F., .F. ), )
   _HB_MEMBER { oFacRecS} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFacRecS" }, .F., .F. ), )
   _HB_MEMBER { oTikCliT} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oTikCliT" }, .F., .F. ), )
   _HB_MEMBER { oTikCliL} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oTikCliL" }, .F., .F. ), )
   _HB_MEMBER { oTikCliS} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oTikCliS" }, .F., .F. ), )
   _HB_MEMBER { oHisMov} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oHisMov" }, .F., .F. ), )
   _HB_MEMBER { oHisMovS} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oHisMovS" }, .F., .F. ), )
   _HB_MEMBER { oDbfAge} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDbfAge" }, .F., .F. ), )
   _HB_MEMBER { oDbfBar} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDbfBar" }, .F., .F. ), )
   _HB_MEMBER { oDbfEmp} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDbfEmp" }, .F., .F. ), )

   _HB_MEMBER { oAlmOrg} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oAlmOrg" }, .F., .F. ), )
   _HB_MEMBER { oAlmDes} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oAlmDes" }, .F., .F. ), )
   _HB_MEMBER { oCodMov} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oCodMov" }, .F., .F. ), )
   _HB_MEMBER { oFecRem} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFecRem" }, .F., .F. ), )
   _HB_MEMBER { oSufRem} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSufRem" }, .F., .F. ), )
   _HB_MEMBER { oNumRem} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oNumRem" }, .F., .F. ), )

   _HB_MEMBER { oCodAge} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oCodAge" }, .F., .F. ), )

   _HB_MEMBER { oDbfProLin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDbfProLin" }, .F., .F. ), )
   _HB_MEMBER { oDbfProMat} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDbfProMat" }, .F., .F. ), )
   _HB_MEMBER { oDbfProSer} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDbfProSer" }, .F., .F. ), )
   _HB_MEMBER { oDbfMatSer} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDbfMatSer" }, .F., .F. ), )

   _HB_MEMBER { cText} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cText" }, .F., .F. ), )
   _HB_MEMBER { oSender} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSender" }, .F., .F. ), )
   _HB_MEMBER { lSelectSend} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "lSelectSend" }, .F., .F. ), )
   _HB_MEMBER { lSelectRecive} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "lSelectRecive" }, .F., .F. ), )
   _HB_MEMBER { cIniFile} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cIniFile" }, .F., .F. ), )
   _HB_MEMBER { lSuccesfullSend} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "lSuccesfullSend" }, .F., .F. ), )

   _HB_MEMBER { lReclculado} ; IIF( !.F., s_oClass:AddMultiData(, .F., nScope + IIF( .F., 32, 0 ), { "lReclculado" }, .F., .F. ), )

   _HB_MEMBER { nNumberSend} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nNumberSend" }, .F., .F. ), )
   _HB_MEMBER { nNumberRecive} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nNumberRecive" }, .F., .F. ), )

   _HB_MEMBER { oDlgImport} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDlgImport" }, .F., .F. ), )
   _HB_MEMBER { lFamilia} ; IIF( !.F., s_oClass:AddMultiData(, .T., nScope + IIF( .F., 32, 0 ), { "lFamilia" }, .F., .F. ), )
   _HB_MEMBER { oFamiliaInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFamiliaInicio" }, .F., .F. ), )
   _HB_MEMBER { cFamiliaInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cFamiliaInicio" }, .F., .F. ), )
   _HB_MEMBER { oFamiliaFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFamiliaFin" }, .F., .F. ), )
   _HB_MEMBER { cFamiliaFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cFamiliaFin" }, .F., .F. ), )

   _HB_MEMBER { lArticulo} ; IIF( !.F., s_oClass:AddMultiData(, .T., nScope + IIF( .F., 32, 0 ), { "lArticulo" }, .F., .F. ), )
   _HB_MEMBER { oArticuloInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oArticuloInicio" }, .F., .F. ), )
   _HB_MEMBER { cArticuloInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cArticuloInicio" }, .F., .F. ), )
   _HB_MEMBER { oArticuloFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oArticuloFin" }, .F., .F. ), )
   _HB_MEMBER { cArticuloFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cArticuloFin" }, .F., .F. ), )

   _HB_MEMBER { lTipoArticulo} ; IIF( !.F., s_oClass:AddMultiData(, .T., nScope + IIF( .F., 32, 0 ), { "lTipoArticulo" }, .F., .F. ), )
   _HB_MEMBER { oTipoArticuloInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oTipoArticuloInicio" }, .F., .F. ), )
   _HB_MEMBER { cTipoArticuloInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cTipoArticuloInicio" }, .F., .F. ), )
   _HB_MEMBER { oTipoArticuloFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oTipoArticuloFin" }, .F., .F. ), )
   _HB_MEMBER { cTipoArticuloFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cTipoArticuloFin" }, .F., .F. ), )

   _HB_MEMBER { oMtrStock} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oMtrStock" }, .F., .F. ), )
   _HB_MEMBER { nMtrStock} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nMtrStock" }, .F., .F. ), )

   _HB_MEMBER { oMeter} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oMeter" }, .F., .F. ), )
   _HB_MEMBER { nMeter} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nMeter" }, .F., .F. ), )

   _HB_MEMBER { oRadTipoMovimiento} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oRadTipoMovimiento" }, .F., .F. ), )

   _HB_MEMBER { lOpenFiles} ; IIF( !.F., s_oClass:AddMultiData(, .F., nScope + IIF( .F., 32, 0 ), { "lOpenFiles" }, .F., .F. ), )

   _HB_MEMBER { oBtnKit} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBtnKit" }, .F., .F. ), )

   _HB_MEMBER { oDetMovimientos} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDetMovimientos" }, .F., .F. ), )
   _HB_MEMBER { oDetSeriesMovimientos} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDetSeriesMovimientos" }, .F., .F. ), )

   _HB_MEMBER New( cPath, oWndParent, oMenuItem) AS CLASS TRemMovAlm; IIF( .F., s_oClass:ModMethod( "New", @TRemMovAlm_New(), nScope + IIF( .T., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "New", @TRemMovAlm_New(), nScope + IIF( .T., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Initiate( cText, oSender) AS CLASS TRemMovAlm; IIF( .F., s_oClass:ModMethod( "Initiate", @TRemMovAlm_Initiate(), nScope + IIF( .T., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Initiate", @TRemMovAlm_Initiate(), nScope + IIF( .T., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER OpenFiles( lExclusive); IIF( .F., s_oClass:ModMethod( "OpenFiles", @TRemMovAlm_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "OpenFiles", @TRemMovAlm_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER CloseFiles(); IIF( .F., s_oClass:ModMethod( "CloseFiles", @TRemMovAlm_CloseFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CloseFiles", @TRemMovAlm_CloseFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER OpenService( lExclusive); IIF( .F., s_oClass:ModMethod( "OpenService", @TRemMovAlm_OpenService(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "OpenService", @TRemMovAlm_OpenService(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER CloseService(); IIF( .F., s_oClass:ModMethod( "CloseService", @TRemMovAlm_CloseService(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CloseService", @TRemMovAlm_CloseService(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER CloseIndex(); IIF( .F., s_oClass:ModMethod( "CloseIndex", @TRemMovAlm_CloseIndex(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CloseIndex", @TRemMovAlm_CloseIndex(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Reindexa( oMeter); IIF( .F., s_oClass:ModMethod( "Reindexa", @TRemMovAlm_Reindexa(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Reindexa", @TRemMovAlm_Reindexa(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER GetNewCount(); IIF( .F., s_oClass:ModMethod( "GetNewCount", @TRemMovAlm_GetNewCount(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "GetNewCount", @TRemMovAlm_GetNewCount(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER DefineFiles(); IIF( .F., s_oClass:ModMethod( "DefineFiles", @TRemMovAlm_DefineFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DefineFiles", @TRemMovAlm_DefineFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER DefineCalculate(); IIF( .F., s_oClass:ModMethod( "DefineCalculate", @TRemMovAlm_DefineCalculate(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DefineCalculate", @TRemMovAlm_DefineCalculate(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Resource( nMode); IIF( .F., s_oClass:ModMethod( "Resource", @TRemMovAlm_Resource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Resource", @TRemMovAlm_Resource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER Activate(); IIF( .F., s_oClass:ModMethod( "Activate", @TRemMovAlm_Activate(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Activate", @TRemMovAlm_Activate(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER AppendDet( oDlg); IIF( .F., s_oClass:ModMethod( "AppendDet", @TRemMovAlm_AppendDet(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "AppendDet", @TRemMovAlm_AppendDet(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER EditDet( oDlg); IIF( .F., s_oClass:ModMethod( "EditDet", @TRemMovAlm_EditDet(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "EditDet", @TRemMovAlm_EditDet(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER DeleteDet( oDlg); IIF( .F., s_oClass:ModMethod( "DeleteDet", @TRemMovAlm_DeleteDet(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DeleteDet", @TRemMovAlm_DeleteDet(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER lSave(); IIF( .F., s_oClass:ModMethod( "lSave", @TRemMovAlm_lSave(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lSave", @TRemMovAlm_lSave(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER ShwAlm( oSay, oBtnImp); IIF( .F., s_oClass:ModMethod( "ShwAlm", @TRemMovAlm_ShwAlm(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "ShwAlm", @TRemMovAlm_ShwAlm(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER nTotRemMov( lPic); IIF( .F., s_oClass:ModMethod( "nTotRemMov", @TRemMovAlm_nTotRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nTotRemMov", @TRemMovAlm_nTotRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Search(); IIF( .F., s_oClass:ModMethod( "Search", @TRemMovAlm_Search(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Search", @TRemMovAlm_Search(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER lSelAll( lSel); IIF( .F., s_oClass:ModMethod( "lSelAll", @TRemMovAlm_lSelAll(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lSelAll", @TRemMovAlm_lSelAll(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER lSelAllMov( lSel ); IIF( !.F., s_oClass:AddVirtual( "lSelAllMov" ), )
   _HB_MEMBER lSelMov(); IIF( .F., s_oClass:ModMethod( "lSelMov", @TRemMovAlm_lSelMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lSelMov", @TRemMovAlm_lSelMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER lSelAllDoc( lSel); IIF( .F., s_oClass:ModMethod( "lSelAllDoc", @TRemMovAlm_lSelAllDoc(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lSelAllDoc", @TRemMovAlm_lSelAllDoc(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER lSelDoc(); IIF( .F., s_oClass:ModMethod( "lSelDoc", @TRemMovAlm_lSelDoc(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lSelDoc", @TRemMovAlm_lSelDoc(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER cTextoMovimiento(); IIF( .F., s_oClass:ModInline( "cTextoMovimiento", {|Self | Self, { "Entre almacenes", "Regularización", "Objetivos", "Consolidación" }[ Min( Max( ( ::oDbf:nArea )->nTipMov, 1 ), 4 ) ] }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "cTextoMovimiento", {|Self | Self, { "Entre almacenes", "Regularización", "Objetivos", "Consolidación" }[ Min( Max( ( ::oDbf:nArea )->nTipMov, 1 ), 4 ) ] }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER CheckFiles(); IIF( .F., s_oClass:ModMethod( "CheckFiles", @TRemMovAlm_CheckFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CheckFiles", @TRemMovAlm_CheckFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER LoadAlmacen( nMode); IIF( .F., s_oClass:ModMethod( "LoadAlmacen", @TRemMovAlm_LoadAlmacen(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "LoadAlmacen", @TRemMovAlm_LoadAlmacen(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER ImportAlmacen( nMode, oDlg); IIF( .F., s_oClass:ModMethod( "ImportAlmacen", @TRemMovAlm_ImportAlmacen(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "ImportAlmacen", @TRemMovAlm_ImportAlmacen(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER nClrText(); IIF( .F., s_oClass:ModMethod( "nClrText", @TRemMovAlm_nClrText(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nClrText", @TRemMovAlm_nClrText(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER ShowKit( lSet); IIF( .F., s_oClass:ModMethod( "ShowKit", @TRemMovAlm_ShowKit(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "ShowKit", @TRemMovAlm_ShowKit(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER DataReport( oFr); IIF( .F., s_oClass:ModMethod( "DataReport", @TRemMovAlm_DataReport(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DataReport", @TRemMovAlm_DataReport(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER VariableReport( oFr); IIF( .F., s_oClass:ModMethod( "VariableReport", @TRemMovAlm_VariableReport(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "VariableReport", @TRemMovAlm_VariableReport(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER DesignReportRemMov( oFr, dbfDoc); IIF( .F., s_oClass:ModMethod( "DesignReportRemMov", @TRemMovAlm_DesignReportRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DesignReportRemMov", @TRemMovAlm_DesignReportRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER PrintReportRemMov( nDevice, nCopies, cPrinter, dbfDoc); IIF( .F., s_oClass:ModMethod( "PrintReportRemMov", @TRemMovAlm_PrintReportRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "PrintReportRemMov", @TRemMovAlm_PrintReportRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER GenRemMov( lPrinter, cCaption, cCodDoc, cPrinter); IIF( .F., s_oClass:ModMethod( "GenRemMov", @TRemMovAlm_GenRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "GenRemMov", @TRemMovAlm_GenRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER bGenRemMov( lImprimir, cTitle, cCodDoc); IIF( .F., s_oClass:ModMethod( "bGenRemMov", @TRemMovAlm_bGenRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "bGenRemMov", @TRemMovAlm_bGenRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER lGenRemMov( oBrw, oBtn, lImp); IIF( .F., s_oClass:ModMethod( "lGenRemMov", @TRemMovAlm_lGenRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lGenRemMov", @TRemMovAlm_lGenRemMov(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER EPage( oInf, cCodDoc); IIF( .F., s_oClass:ModMethod( "EPage", @TRemMovAlm_EPage(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "EPage", @TRemMovAlm_EPage(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Save(); IIF( .F., s_oClass:ModMethod( "Save", @TRemMovAlm_Save(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Save", @TRemMovAlm_Save(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER Load(); IIF( .F., s_oClass:ModMethod( "Load", @TRemMovAlm_Load(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Load", @TRemMovAlm_Load(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER nGetNumberToSend(); IIF( .F., s_oClass:ModMethod( "nGetNumberToSend", @TRemMovAlm_nGetNumberToSend(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nGetNumberToSend", @TRemMovAlm_nGetNumberToSend(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER SetNumberToSend(); IIF( .F., s_oClass:ModInline( "SetNumberToSend", {|Self | Self, WritePProString( "Numero", ::cText, cValToChar( ::nNumberSend ), ::cIniFile ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "SetNumberToSend", {|Self | Self, WritePProString( "Numero", ::cText, cValToChar( ::nNumberSend ), ::cIniFile ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER IncNumberToSend(); IIF( .F., s_oClass:ModInline( "IncNumberToSend", {|Self | Self, WritePProString( "Numero", ::cText, cValToChar( ++::nNumberSend ), ::cIniFile ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "IncNumberToSend", {|Self | Self, WritePProString( "Numero", ::cText, cValToChar( ++::nNumberSend ), ::cIniFile ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER CreateData(); IIF( .F., s_oClass:ModMethod( "CreateData", @TRemMovAlm_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CreateData", @TRemMovAlm_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER RestoreData(); IIF( .F., s_oClass:ModMethod( "RestoreData", @TRemMovAlm_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "RestoreData", @TRemMovAlm_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER SendData(); IIF( .F., s_oClass:ModMethod( "SendData", @TRemMovAlm_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SendData", @TRemMovAlm_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER ReciveData(); IIF( .F., s_oClass:ModMethod( "ReciveData", @TRemMovAlm_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "ReciveData", @TRemMovAlm_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER Process(); IIF( .F., s_oClass:ModMethod( "Process", @TRemMovAlm_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Process", @TRemMovAlm_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Report(); IIF( .F., s_oClass:ModInline( "Report", {|Self | Self, TInfRemMov():New( "Remesas de movimientos", , , , , , { ::oDbf, ::oDetMovimientos:oDbf, ::oArt } ):Play() }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "Report", {|Self | Self, TInfRemMov():New( "Remesas de movimientos", , , , , , { ::oDbf, ::oDetMovimientos:oDbf, ::oArt } ):Play() }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TRemMovAlm ;



UTILITY STATIC function TRemMovAlm_New( cPath, oWndParent, oMenuItem) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   IIF( cPath == nil, cPath := cPatEmp(), ) ;
   IIF( oWndParent == nil, oWndParent := oWnd(), ) ;
   IIF( oMenuItem == nil, oMenuItem := "01050", ) ;

   ::nLevel                := nLevelUsr( oMenuItem )

   ::cPath                 := cPath
   ::oWndParent            := oWndParent
   ::oDbf                  := nil

   ::lAutoActions          := .F.

   ::cNumDocKey            := "nNumRem"
   ::cSufDocKey            := "cSufRem"

   ::cPicUnd               := MasUnd()

   ::bFirstKey             := {|| Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem }
   ::bWhile                := {|| Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem == Str( ::oDetMovimientos:oDbf:nNumRem, 9 ) + ::oDetMovimientos:oDbf:cSufRem .AND. !::oDetMovimientos:oDbf:Eof() }

   ::oDetMovimientos       := TDetMovimientos():New( cPath, Self )
   ::AddDetail( ::oDetMovimientos )

   ::oDetSeriesMovimientos := TDetSeriesMovimientos():New( cPath, Self )
   ::AddDetail( ::oDetSeriesMovimientos )

   ::oDetSeriesMovimientos:bOnPreSaveDetail  := {|| ::oDetSeriesMovimientos:SaveDetails() }

RETURN ( Self )




UTILITY STATIC function TRemMovAlm_Initiate( cText, oSender) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   ::cText              := cText
   ::oSender            := oSender
   ::cIniFile           := cPatEmp() + "Empresa.Ini"
   ::lSuccesfullSend    := .F.

RETURN ( Self )



UTILITY STATIC function TRemMovAlm_GetNewCount() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   ::oDbf:nNumRem    := nNewDoc( nil, ::oDbf:nArea, "nMovAlm", nil, ::oDbfCnt:nArea )

RETURN ( Self )



UTILITY STATIC function TRemMovAlm_DefineFiles( cPath, cDriver) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   IIF( cPath == nil, cPath := ::cPath, ) ;
   IIF( cDriver == nil, cDriver := cDriver(), ) ;

   ::oDbf := DbfServer( "REMMOVT.DBF", "TRemMovT" ):New( "REMMOVT.DBF", "RemMovT", ( cDriver ), "Movimientos de almacén", ( cPath ) )

      ::oDbf:AddField( "lSelDoc", "L", 1, 0,,,,, "", .F.,, .T., {} )
      ::oDbf:AddField( "Send16", "B", 1, 0,,,, {|| ::oDbf:lSelDoc }, { "Enviar", "Lbl16" , 3 }, .F., 20, .F., {"Sel16", "Nil16"} )
      ::oDbf:AddField( "nNumRem", "N", 9, 0, "999999999", 0,,, "Número", .F.,, .T., {} )
      ::oDbf:AddField( "cSufRem", "C", 2, 0, "@!", RetSufEmp(),,, "Sufijo", .F.,, .T., {} )
      ::oDbf:AddField( "cNumRem", "B", 12, 0,,,, {|| ( Str( ( ::oDbf:nArea )->nNumRem, 9 ) + "/" + ( ::oDbf:nArea )->cSufRem )}, "Número", .F., 80, .F., {} )
      ::oDbf:AddField( "nTipMov", "N", 1, 0,,,,, "Tipo del movimiento", .F.,, .T., {} )
      ::oDbf:AddField( "cTipMov", "B", 12, 0,,,, {|| ( ::cTextoMovimiento() )}, "Tipo", .F., 90, .F., {} )
      ::oDbf:AddField( "cCodUsr", "C", 3, 0,, cCurUsr(),,, "Código usuario", .F.,, .T., {} )
      ::oDbf:AddField( "cCodDlg", "C", 2, 0,,,,, "Delegación", .F., 20, .F., {} )
      ::oDbf:AddField( "cCodAge", "C", 3, 0,,,,, "Código agente", .F.,, .T., {} )
      ::oDbf:AddField( "cCodMov", "C", 2, 0,,,,, "Tipo de movimiento", .F.,, .T., {} )
      ::oDbf:AddField( "dFecRem", "D", 8, 0,, Date(),,, "Fecha", .F., 80, .F., {} )
      ::oDbf:AddField( "cTimRem", "C", 5, 0,, Time(),,, "Hora", .F.,, .T., {} )
      ::oDbf:AddField( "cAlmOrg", "C", 3, 0, "@!",,,, "Alm. org.", .F., 60, .F., {} )
      ::oDbf:AddField( "cNomAlmOrg", "B", 20, 0, "@!",,, {|| ( oRetFld( ( ::oDbf:nArea )->cAlmOrg, ::oAlm, "cNomAlm" ) )},, .F.,, .T., {} )
      ::oDbf:AddField( "cAlmDes", "C", 3, 0, "@!",,,, "Alm. des.", .F., 60, .F., {} )
      ::oDbf:AddField( "cNomAlmDes", "B", 20, 0, "@!",,, {|| ( oRetFld( ( ::oDbf:nArea )->cAlmDes, ::oAlm, "cNomAlm" ) )},, .F.,, .T., {} )
      ::oDbf:AddField( "cCodDiv", "C", 3, 0, "@!",,,, "Div.", .F.,, .T., {} )
      ::oDbf:AddField( "nVdvDiv", "N", 13, 6, "@E 999,999.999999",,,, "Cambio de la divisa", .F.,, .T., {} )
      ::oDbf:AddField( "cComMov", "C", 100, 0, "@!",,,, "Comentario", .F., 240, .F., {} )
      ::oDbf:AddField( "nTotRem", "N", 16, 6, "@E 999,999,999,999.99",,,, "Importe", .T., 100, .F., {} )

      ::oDbf:AddIndex( "cNumRem", "RemMovT.Cdx", "Str( nNumRem ) + cSufRem",,, .F., .F., "Número",,, .T., .F. )
      ::oDbf:AddIndex( "dFecRem", "RemMovT.Cdx", "Dtos( dFecRem ) + cTimRem",,, .F., .F., "Fecha",,, .T., .F. )



RETURN ( ::oDbf )








UTILITY STATIC function TRemMovAlm_DefineCalculate() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   ::aCal  := {}

   aAdd( ::aCal, { "( RetFld( ( cDbfCol )->cRefMov, cDbfArt, 'Nombre' ) )",   "C",100, 0, "Nombre artículo",  "",             "" } )
   aAdd( ::aCal, { "nTotNMovAlm( oDbfCol )",                                  "N", 16, 6, "Total unidades",   "cPorDivRem",   "" } )
   aAdd( ::aCal, { "nTotLMovAlm( oDbfCol )",                                  "N", 16, 6, "Total importe",    "cPorDivRem",   "" } )

RETURN ( ::aCal )



UTILITY STATIC function TRemMovAlm_Activate() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local oSnd
   local oDel
   local oImp
   local oPrv

   if nAnd( ::nLevel, 1 ) == 0





      if ::oWndParent <> nil
         ::oWndParent:CloseAll()
      end

      ::CreateShell( ::nLevel )








      ::oWndBrw:NewAt( "BUS",,, {||( ::oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )
         ::oWndBrw:AddSeaBar()








      ::oWndBrw:NewAt( "NEW",,, {||( ::oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )






      ::oWndBrw:NewAt( "DUP",,, {||( ::oWndBrw:RecDup() )}, "(D)uplicar", "D",,, 2,, .F. )






      ::oWndBrw:NewAt( "EDIT",,, {||( ::oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )






      ::oWndBrw:NewAt( "ZOOM",,, {||( ::oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 8,, .F. )






      oDel := ::oWndBrw:NewAt( "DEL",,, {||( ::oWndBrw:RecDel() )}, "(E)liminar", "E",,, 16,, .F. )







         ::oWndBrw:NewAt( "DEL",,, {||( ::Del( .T., .F. ), ::oWndBrw:Refresh() )}, "Solo cabecera",,,, 16, oDel, .F. )







         ::oWndBrw:NewAt( "DEL",,, {||( ::Del( .F., .T. ), ::oWndBrw:Refresh() )}, "Solo detalle",,,, 16, oDel, .F. )






      ::oWndBrw:NewAt( "IMP",,, {||( ::Report() )}, "(L)istado", "L",,, 32,, .F. )





      oImp := ::oWndBrw:NewAt( "IMP",,, {||( ::GenRemMov( .T. ) )}, "(I)mprimir", "I",,, 32,, .F. )

      ::lGenRemMov( ::oWndBrw:oBrw, oImp, .T. )





      oPrv := ::oWndBrw:NewAt( "PREV1",,, {||( ::GenRemMov( .F. ) )}, "(P)revisualizar", "P",,, 32,, .F. )

      ::lGenRemMov( ::oWndBrw:oBrw, oPrv, .F. )






      oSnd := ::oWndBrw:NewAt( "LBL",,, {||( ::lSelMov(), ::oWndBrw:Refresh() )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )






         ::oWndBrw:NewAt( "LBL",,, {||( ::lSelAll( .T. ) )}, "Todos",,,, 4, oSnd, .F. )






         ::oWndBrw:NewAt( "LBL",,, {||( ::lSelAll( .F. ) )}, "Ninguno",,,, 4, oSnd, .F. )

      ::oWndBrw:EndButtons( Self )

      if ::cHtmlHelp <> nil
         ::oWndBrw:cHtmlHelp  := ::cHtmlHelp
      end

      ::oWndBrw:Activate( nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, {|| ::CloseFiles() }, nil, nil )

   else

      msgStop( "Acceso no permitido." )

   end

RETURN ( Self )



UTILITY STATIC function TRemMovAlm_OpenFiles( lExclusive) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local oError
   local oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   IIF( lExclusive == nil, lExclusive := .F., ) ;

   BEGIN SEQUENCE

   if !::lOpenFiles

      if Empty( ::oDbf )
         ::DefineFiles()
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

      ::OpenDetails()

      ::oDelega := DbfServer( "Delega.Dbf", ):NewOpen( "Delega.Dbf",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDelega:AddBag( "Delega.Cdx" ) ; ::oDelega:AddBag( ) ; ::oDelega:AutoIndex()

      ::oUsr := DbfServer( "Users.Dbf", ):NewOpen( "Users.Dbf",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oUsr:AddBag( "Users.Cdx" ) ; ::oUsr:AddBag( ) ; ::oUsr:AutoIndex()

      ::oTMov := DbfServer( "TMOV.DBF", ):NewOpen( "TMOV.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oTMov:AddBag( "TMov.Cdx" ) ; ::oTMov:AddBag( ) ; ::oTMov:AutoIndex()

      ::oAlm := DbfServer( "ALMACEN.DBF", ):NewOpen( "ALMACEN.DBF", "ALMACEN", ( cDriver() ),, ( cPatAlm() ), .F., .T., .F., .F. ) ; ::oAlm:AddBag( "ALMACEN.CDX" ) ; ::oAlm:AddBag( ) ; ::oAlm:AutoIndex()

      ::oArtCom := DbfServer( "ARTDIV.DBF", ):NewOpen( "ARTDIV.DBF", "ARTDIV", ( cDriver() ),, ( cPatArt() ), .F., .T., .F., .F. ) ; ::oArtCom:AddBag( "ARTDIV.CDX" ) ; ::oArtCom:AddBag( ) ; ::oArtCom:AutoIndex()

      ::oPro := DbfServer( "PRO.DBF", ):NewOpen( "PRO.DBF", "PRO", ( cDriver() ),, ( cPatArt() ), .F., .T., .F., .F. ) ; ::oPro:AddBag( "PRO.CDX" ) ; ::oPro:AddBag( ) ; ::oPro:AutoIndex()

      ::oTblPro := DbfServer( "TBLPRO.DBF", ):NewOpen( "TBLPRO.DBF", "TBLPRO", ( cDriver() ),, ( cPatArt() ), .F., .T., .F., .F. ) ; ::oTblPro:AddBag( "TBLPRO.CDX" ) ; ::oTblPro:AddBag( ) ; ::oTblPro:AutoIndex()

      ::oFam := DbfServer( "FAMILIAS.DBF", ):NewOpen( "FAMILIAS.DBF", "FAMILIAS", ( cDriver() ),, ( cPatArt() ), .F., .T., .F., .F. ) ; ::oFam:AddBag( "FAMILIAS.CDX" ) ; ::oFam:AddBag( ) ; ::oFam:AutoIndex()

      ::oArt := DbfServer( "ARTICULO.DBF", ):NewOpen( "ARTICULO.DBF", "ARTICULO", ( cDriver() ),, ( cPatArt() ), .F., .T., .F., .F. ) ; ::oArt:AddBag( "ARTICULO.CDX" ) ; ::oArt:AddBag( ) ; ::oArt:AutoIndex()

      ::oArtKit := DbfServer( "ARTKIT.DBF", ):NewOpen( "ARTKIT.DBF", "ARTKIT", ( cDriver() ),, ( cPatArt() ), .F., .T., .F., .F. ) ; ::oArtKit:AddBag( "ARTKIT.CDX" ) ; ::oArtKit:AddBag( ) ; ::oArtKit:AutoIndex()

      ::oDbfAge := DbfServer( "AGENTES.DBF", ):NewOpen( "AGENTES.DBF",, ( cDriver() ),, ( cPatCli() ), .F., .T., .F., .F. ) ; ::oDbfAge:AddBag( "AGENTES.CDX" ) ; ::oDbfAge:AddBag( ) ; ::oDbfAge:AutoIndex()

      ::oPedPrvT := DbfServer( "PEDPROVT.DBF", ):NewOpen( "PEDPROVT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oPedPrvT:AddBag( "PEDPROVT.CDX" ) ; ::oPedPrvT:AddBag( ) ; ::oPedPrvT:AutoIndex()

      ::oPedPrvL := DbfServer( "PEDPROVL.DBF", ):NewOpen( "PEDPROVL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oPedPrvL:AddBag( "PEDPROVL.CDX" ) ; ::oPedPrvL:AddBag( ) ; ::oPedPrvL:AutoIndex()
      ::oPedPrvL:SetOrder( "cRef" )

      ::oAlbPrvT := DbfServer( "ALBPROVT.DBF", ):NewOpen( "ALBPROVT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbPrvT:AddBag( "ALBPROVT.CDX" ) ; ::oAlbPrvT:AddBag( ) ; ::oAlbPrvT:AutoIndex()

      ::oAlbPrvL := DbfServer( "ALBPROVL.DBF", ):NewOpen( "ALBPROVL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbPrvL:AddBag( "ALBPROVL.CDX" ) ; ::oAlbPrvL:AddBag( ) ; ::oAlbPrvL:AutoIndex()
      ::oAlbPrvL:SetOrder( "cRef" )

      ::oAlbPrvS := DbfServer( "AlbPrvS.DBF", ):NewOpen( "AlbPrvS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbPrvS:AddBag( "AlbPrvS.CDX" ) ; ::oAlbPrvS:AddBag( ) ; ::oAlbPrvS:AutoIndex()

      ::oFacPrvT := DbfServer( "FACPRVT.DBF", ):NewOpen( "FACPRVT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacPrvT:AddBag( "FACPRVT.CDX" ) ; ::oFacPrvT:AddBag( ) ; ::oFacPrvT:AutoIndex()

      ::oFacPrvL := DbfServer( "FACPRVL.DBF", ):NewOpen( "FACPRVL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacPrvL:AddBag( "FACPRVL.CDX" ) ; ::oFacPrvL:AddBag( ) ; ::oFacPrvL:AutoIndex()
      ::oFacPrvL:SetOrder( "cRef" )

      ::oFacPrvS := DbfServer( "FACPRVS.DBF", ):NewOpen( "FACPRVS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacPrvS:AddBag( "FACPRVS.CDX" ) ; ::oFacPrvS:AddBag( ) ; ::oFacPrvS:AutoIndex()

      ::oRctPrvT := DbfServer( "RctPrvT.DBF", ):NewOpen( "RctPrvT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oRctPrvT:AddBag( "RctPrvT.CDX" ) ; ::oRctPrvT:AddBag( ) ; ::oRctPrvT:AutoIndex()

      ::oRctPrvL := DbfServer( "RctPrvL.DBF", ):NewOpen( "RctPrvL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oRctPrvL:AddBag( "RctPrvL.CDX" ) ; ::oRctPrvL:AddBag( ) ; ::oRctPrvL:AutoIndex()
      ::oRctPrvL:SetOrder( "cRef" )

      ::oRctPrvS := DbfServer( "RctPrvS.DBF", ):NewOpen( "RctPrvS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oRctPrvS:AddBag( "RctPrvS.CDX" ) ; ::oRctPrvS:AddBag( ) ; ::oRctPrvS:AutoIndex()

      ::oPedCliT := DbfServer( "PedCliT.DBF", ):NewOpen( "PedCliT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oPedCliT:AddBag( "PedCliT.CDX" ) ; ::oPedCliT:AddBag( ) ; ::oPedCliT:AutoIndex()

      ::oPedCliL := DbfServer( "PedCliL.DBF", ):NewOpen( "PedCliL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oPedCliL:AddBag( "PedCliL.CDX" ) ; ::oPedCliL:AddBag( ) ; ::oPedCliL:AutoIndex()
      ::oPedCliL:OrdSetFocus( "cRef" )

      ::oPedCliR := DbfServer( "PedCliR.DBF", ):NewOpen( "PedCliR.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oPedCliR:AddBag( "PedCliR.CDX" ) ; ::oPedCliR:AddBag( ) ; ::oPedCliR:AutoIndex()

      ::oAlbCliT := DbfServer( "ALBCLIT.DBF", ):NewOpen( "ALBCLIT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbCliT:AddBag( "ALBCLIT.CDX" ) ; ::oAlbCliT:AddBag( ) ; ::oAlbCliT:AutoIndex()

      ::oAlbCliL := DbfServer( "ALBCLIL.DBF", ):NewOpen( "ALBCLIL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbCliL:AddBag( "ALBCLIL.CDX" ) ; ::oAlbCliL:AddBag( ) ; ::oAlbCliL:AutoIndex()
      ::oAlbCliL:OrdSetFocus( "cRef" )

      ::oAlbCliS := DbfServer( "ALBCLIS.DBF", ):NewOpen( "ALBCLIS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbCliS:AddBag( "ALBCLIS.CDX" ) ; ::oAlbCliS:AddBag( ) ; ::oAlbCliS:AutoIndex()

      ::oFacCliT := DbfServer( "FacCliT.DBF", ):NewOpen( "FacCliT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacCliT:AddBag( "FacCLIT.CDX" ) ; ::oFacCliT:AddBag( ) ; ::oFacCliT:AutoIndex()

      ::oFacCliL := DbfServer( "FacCliL.DBF", ):NewOpen( "FacCliL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacCliL:AddBag( "FacCliL.CDX" ) ; ::oFacCliL:AddBag( ) ; ::oFacCliL:AutoIndex()
      ::oFacCliL:OrdSetFocus( "cRef" )

      ::oFacCliS := DbfServer( "FacCliS.DBF", ):NewOpen( "FacCliS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacCliS:AddBag( "FacCliS.CDX" ) ; ::oFacCliS:AddBag( ) ; ::oFacCliS:AutoIndex()

      ::oFacRecT := DbfServer( "FacRecT.DBF", ):NewOpen( "FacRecT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacRecT:AddBag( "FacRecT.CDX" ) ; ::oFacRecT:AddBag( ) ; ::oFacRecT:AutoIndex()

      ::oFacRecL := DbfServer( "FacRecL.DBF", ):NewOpen( "FacRecL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacRecL:AddBag( "FacRecL.CDX" ) ; ::oFacRecL:AddBag( ) ; ::oFacRecL:AutoIndex()
      ::oFacRecL:OrdSetFocus( "cRef" )

      ::oFacRecS := DbfServer( "FacRecS.DBF", ):NewOpen( "FacRecS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacRecS:AddBag( "FacRecS.CDX" ) ; ::oFacRecS:AddBag( ) ; ::oFacRecS:AutoIndex()

      ::oTikCliT := DbfServer( "TikeT.DBF", ):NewOpen( "TikeT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oTikCliT:AddBag( "TikeT.CDX" ) ; ::oTikCliT:AddBag( ) ; ::oTikCliT:AutoIndex()

      ::oTikCliL := DbfServer( "TikeL.DBF", ):NewOpen( "TikeL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oTikCliL:AddBag( "TikeL.CDX" ) ; ::oTikCliL:AddBag( ) ; ::oTikCliL:AutoIndex()
      ::oTikCliL:OrdSetFocus( "cCbaTil" )

      ::oTikCliS := DbfServer( "TikeS.DBF", ):NewOpen( "TikeS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oTikCliS:AddBag( "TikeS.CDX" ) ; ::oTikCliS:AddBag( ) ; ::oTikCliS:AutoIndex()

      ::oHisMov := DbfServer( "HisMov.DBF", ):NewOpen( "HisMov.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oHisMov:AddBag( "HisMov.CDX" ) ; ::oHisMov:AddBag( ) ; ::oHisMov:AutoIndex()
      ::oHisMov:OrdSetFocus( "cRefMov" )

      ::oHisMovS := DbfServer( "MovSer.Dbf", ):NewOpen( "MovSer.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oHisMovS:AddBag( "MovSer.Cdx" ) ; ::oHisMovS:AddBag( ) ; ::oHisMovS:AutoIndex()

      ::oDbfBar := DbfServer( "ArtCodebar.Dbf", ):NewOpen( "ArtCodebar.Dbf",, ( cDriver() ),, ( cPatArt() ), .F., .T., .F., .F. ) ; ::oDbfBar:AddBag( "ArtCodebar.Cdx" ) ; ::oDbfBar:AddBag( ) ; ::oDbfBar:AutoIndex()

      ::oDbfDoc := DbfServer( "RDocumen.Dbf", ):NewOpen( "RDocumen.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfDoc:AddBag( "RDocumen.Cdx" ) ; ::oDbfDoc:AddBag( ) ; ::oDbfDoc:AutoIndex()
      ::oDbfDoc:OrdSetFocus( "cTipo" )

      ::oDbfCnt := DbfServer( "nCount.Dbf", ):NewOpen( "nCount.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfCnt:AddBag( "nCount.Cdx" ) ; ::oDbfCnt:AddBag( ) ; ::oDbfCnt:AutoIndex()

      ::oDbfEmp := DbfServer( "EMPRESA.DBF", ):NewOpen( "EMPRESA.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDbfEmp:AddBag( "EMPRESA.CDX" ) ; ::oDbfEmp:AddBag( ) ; ::oDbfEmp:AutoIndex()

      ::oDbfProLin := DbfServer( "PROLIN.DBF", ):NewOpen( "PROLIN.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfProLin:AddBag( "PROLIN.CDX" ) ; ::oDbfProLin:AddBag( ) ; ::oDbfProLin:AutoIndex()

      ::oDbfProMat := DbfServer( "PROMAT.DBF", ):NewOpen( "PROMAT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfProMat:AddBag( "PROMAT.CDX" ) ; ::oDbfProMat:AddBag( ) ; ::oDbfProMat:AutoIndex()

      ::oDbfProSer := DbfServer( "ProSer.Dbf", ):NewOpen( "ProSer.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfProSer:AddBag( "ProSer.Cdx" ) ; ::oDbfProSer:AddBag( ) ; ::oDbfProSer:AutoIndex()

      ::oDbfMatSer := DbfServer( "MatSer.Dbf", ):NewOpen( "MatSer.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfMatSer:AddBag( "MatSer.Cdx" ) ; ::oDbfMatSer:AddBag( ) ; ::oDbfMatSer:AutoIndex()

      ::oTipArt           := TTipArt():Create( cPatArt() )
      ::oTipArt:OpenFiles()

      ::oStock             := TStock():Create( cPatGrp() )
      if ::oStock:lOpenFiles()

         ::oStock:cAlm     := ::oAlm:cAlias
         ::oStock:cArt     := ::oArt:cAlias
         ::oStock:cHisMov  := ::oHisMov:cAlias
         ::oStock:cHisMovS := ::oHisMovS:cAlias

         ::oStock:cPedPrvT := ::oPedPrvT:cAlias
         ::oStock:cPedPrvL := ::oPedPrvL:cAlias

         ::oStock:cAlbPrvT := ::oAlbPrvT:cAlias
         ::oStock:cAlbPrvL := ::oAlbPrvL:cAlias
         ::oStock:cAlbPrvS := ::oAlbPrvS:cAlias

         ::oStock:cFacPrvT := ::oFacPrvT:cAlias
         ::oStock:cFacPrvL := ::oFacPrvL:cAlias
         ::oStock:cFacPrvS := ::oFacPrvS:cAlias

         ::oStock:cRctPrvT := ::oRctPrvT:cAlias
         ::oStock:cRctPrvL := ::oRctPrvL:cAlias
         ::oStock:cRctPrvS := ::oRctPrvS:cAlias

         ::oStock:cPedCliT := ::oPedCliT:cAlias
         ::oStock:cPedCliL := ::oPedCliL:cAlias
         ::oStock:cPedCliR := ::oPedCliR:cAlias

         ::oStock:cAlbCliT := ::oAlbCliT:cAlias
         ::oStock:cAlbCliL := ::oAlbCliL:cAlias
         ::oStock:cAlbCliS := ::oAlbCliS:cAlias

         ::oStock:cFacCliT := ::oFacCliT:cAlias
         ::oStock:cFacCliL := ::oFacCliL:cAlias
         ::oStock:cFacCliS := ::oFacCliS:cAlias

         ::oStock:cFacRecT := ::oFacRecT:cAlias
         ::oStock:cFacRecL := ::oFacRecL:cAlias
         ::oStock:cFacRecS := ::oFacRecS:cAlias

         ::oStock:cTikT    := ::oTikCliT:cAlias
         ::oStock:cTikL    := ::oTikCliL:cAlias
         ::oStock:cTikS    := ::oTikCliS:cAlias

         ::oStock:cProducL := ::oDbfProLin:cAlias
         ::oStock:cProducM := ::oDbfProMat:cAlias
         ::oStock:cProducS := ::oDbfProSer:cAlias
         ::oStock:cProducP := ::oDbfMatSer:cAlias

      else

         ::lOpenFiles      := .F.

      end

      ::lLoadDivisa()

      ::lOpenFiles         := .T.

   end

   RECOVER USING oError

      ::lOpenFiles         := .F.

      msgStop( "Imposible abrir todas las bases de datos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   if !::lOpenFiles
      ::CloseFiles()
   end

RETURN ( ::lOpenFiles )



UTILITY STATIC function TRemMovAlm_CloseFiles() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   ::CloseDetails()

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
   end

   if ::oAlm <> nil .AND. ::oAlm:Used()
      ::oAlm:End()
   end

   if ::oArt <> nil .AND. ::oArt:Used()
      ::oArt:End()
   end

   if ::oArtKit <> nil .AND. ::oArtKit:Used()
      ::oArtKit:End()
   end

   if ::oFam <> nil .AND. ::oFam:Used()
      ::oFam:End()
   end

   if ::oPro <> nil .AND. ::oPro:Used()
      ::oPro:End()
   end

   if ::oTblPro <> nil .AND. ::oTblPro:Used()
      ::oTblPro:End()
   end

   if ::oArtCom <> nil .AND. ::oArtCom:Used()
      ::oArtCom:End()
   end

   if ::oTMov <> nil .AND. ::oTMov:Used()
      ::oTMov:End()
   end

   if ::oPedPrvT <> nil .AND. ::oPedPrvT:Used()
      ::oPedPrvT:End()
   end

   if ::oPedPrvL <> nil .AND. ::oPedPrvL:Used()
      ::oPedPrvL:End()
   end

   if ::oAlbPrvT <> nil .AND. ::oAlbPrvT:Used()
      ::oAlbPrvT:End()
   end

   if ::oAlbPrvL <> nil .AND. ::oAlbPrvL:Used()
      ::oAlbPrvL:End()
   end

   if ::oAlbPrvS <> nil .AND. ::oAlbPrvS:Used()
      ::oAlbPrvS:End()
   end

   if ::oFacPrvT <> nil .AND. ::oFacPrvT:Used()
      ::oFacPrvT:End()
   end

   if ::oFacPrvL <> nil .AND. ::oFacPrvL:Used()
      ::oFacPrvL:End()
   end

   if ::oFacPrvS <> nil .AND. ::oFacPrvS:Used()
      ::oFacPrvS:End()
   end

   if ::oRctPrvT <> nil .AND. ::oRctPrvT:Used()
      ::oRctPrvT:End()
   end

   if ::oRctPrvL <> nil .AND. ::oRctPrvL:Used()
      ::oRctPrvL:End()
   end

   if ::oRctPrvS <> nil .AND. ::oRctPrvS:Used()
      ::oRctPrvS:End()
   end

   if !Empty( ::oPedCliT ) .AND. ::oPedCliT:Used()
      ::oPedCliT:End()
   end

   if !Empty( ::oPedCliR ) .AND. ::oPedCliR:Used()
      ::oPedCliR:End()
   end

   if !Empty( ::oPedCliL ) .AND. ::oPedCliL:Used()
      ::oPedCliL:End()
   end

   if !Empty( ::oAlbCliT ) .AND. ::oAlbCliT:Used()
      ::oAlbCliT:End()
   end

   if !Empty( ::oAlbCliL ) .AND. ::oAlbCliL:Used()
      ::oAlbCliL:End()
   end

   if !Empty( ::oAlbCliS ) .AND. ::oAlbCliS:Used()
      ::oAlbCliS:End()
   end

   if !Empty( ::oFacCliT ) .AND. ::oFacCliT:Used()
      ::oFacCliT:End()
   end

   if !Empty( ::oFacCliL ) .AND. ::oFacCliL:Used()
      ::oFacCliL:End()
   end

   if !Empty( ::oFacCliS ) .AND. ::oFacCliS:Used()
      ::oFacCliS:End()
   end

   if !Empty( ::oFacRecT ) .AND. ::oFacRecT:Used()
      ::oFacRecT:End()
   end

   if !Empty( ::oFacRecL ) .AND. ::oFacRecL:Used()
      ::oFacRecL:End()
   end

   if !Empty( ::oTikCliT ) .AND. ::oTikCliT:Used()
      ::oTikCliT:End()
   end

   if !Empty( ::oTikCliL ) .AND. ::oTikCliL:Used()
      ::oTikCliL:End()
   end

   if !Empty( ::oTikCliS ) .AND. ::oTikCliS:Used()
      ::oTikCliS:End()
   end

   if !Empty( ::oHisMov ) .AND. ::oHisMov:Used()
      ::oHisMov:End()
   end

   if ::oStock <> nil
      ::oStock:End()
   end

   if ::oDbfDiv <> nil .AND. ::oDbfDiv:Used()
      ::oDbfDiv:End()
   end

   if ::oDbfAge <> nil .AND. ::oDbfAge:Used()
      ::oDbfAge:End()
   end

   if ::oDbfBar <> nil .AND. ::oDbfBar:Used()
      ::oDbfBar:End()
   end

   if ::oDelega <> nil .AND. ::oDelega:Used()
      ::oDelega:End()
   end

   if ::oUsr <> nil .AND. ::oUsr:Used()
      ::oUsr:End()
   end

   if ::oDbfDoc <> nil .AND. ::oDbfDoc:Used()
      ::oDbfDoc:End()
   end

   if ::oDbfCnt <> nil .AND. ::oDbfCnt:Used()
      ::oDbfCnt:End()
   end

   if ::oDbfEmp <> nil .AND. ::oDbfEmp:Used()
      ::oDbfEmp:End()
   end

   if ::oDbfProLin <> nil .AND. ::oDbfProLin:Used()
      ::oDbfProLin:End()
   end

   if ::oDbfProMat <> nil .AND. ::oDbfProMat:Used()
      ::oDbfProMat:End()
   end

   if ::oDbfProSer <> nil .AND. ::oDbfProSer:Used()
      ::oDbfProSer:End()
   end

   if ::oDbfMatSer <> nil .AND. ::oDbfMatSer:Used()
      ::oDbfMatSer:End()
   end

   if ::oBandera <> nil
      ::oBandera:End()
   end

   if !Empty( ::oTipArt )
      ::oTipArt:end()
   end

   ::oDbf         := nil
   ::oAlm         := nil
   ::oArt         := nil
   ::oArtKit      := nil
   ::oFam         := nil
   ::oPro         := nil
   ::oTblPro      := nil
   ::oArtCom      := nil
   ::oTMov        := nil
   ::oStock       := nil
   ::oAlbPrvT     := nil
   ::oAlbPrvL     := nil
   ::oAlbPrvS     := nil
   ::oFacPrvT     := nil
   ::oRctPrvT     := nil
   ::oRctPrvL     := nil
   ::oPedCliT     := nil
   ::oPedCliL     := nil
   ::oPedCliR     := nil
   ::oAlbCliT     := nil
   ::oAlbCliL     := nil
   ::oFacCliT     := nil
   ::oFacCliL     := nil
   ::oTikCliT     := nil
   ::oTikCliL     := nil
   ::oHisMov      := nil
   ::oDbfDiv      := nil
   ::oDbfAge      := nil
   ::oDbfBar      := nil
   ::oDbfDoc      := nil
   ::oTipArt      := nil
   ::oDbfEmp      := nil
   ::oDbfProLin   := nil
   ::oDbfProMat   := nil

   ::oBandera     := nil

   ::lOpenFiles   := .F.

RETURN ( .T. )



UTILITY STATIC function TRemMovAlm_OpenService( lExclusive) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local lOpen          := .T.
   local oError
   local oBlock

   IIF( lExclusive == nil, lExclusive := .F., ) ;

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::oDbf         := ::DefineFiles()
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

      ::OpenDetails()

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos de remesas de movimientos" )

      ::CloseFiles()

      lOpen             := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



UTILITY STATIC function TRemMovAlm_CloseService() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   if !Empty( ::oDbf ) .AND. ::oDbf:Used()
      ::oDbf:End()
   end

   ::CloseDetails()

RETURN ( .T. )



UTILITY STATIC function TRemMovAlm_CloseIndex() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   if !Empty( ::oDbf ) .AND. ::oDbf:Used()
      ::oDbf:OrdListClear()
   end

RETURN ( .T. )



UTILITY STATIC function TRemMovAlm_Resource( nMode) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local oDlg
   local oSay        := Array( 7 )
   local cSay        := Array( 7 )
   local oBtnImp
   local oBmpGeneral





   ::oDetMovimientos:oDbfVir:OrdSetFocus( "nNumLin" )

   if nMode == 1
      ::oDbf:lSelDoc := .T.
      ::oDbf:cCodUsr := cCurUsr()
      ::oDbf:cCodDlg := oRetFld( cCurUsr(), ::oUsr, "cCodDlg" )
   end

   cSay[ 1 ]         := oRetFld( ::oDbf:cAlmOrg, ::oAlm )
   cSay[ 2 ]         := oRetFld( ::oDbf:cAlmDes, ::oAlm )
   cSay[ 3 ]         := oRetFld( ::oDbf:cCodMov, ::oTMov )
   cSay[ 5 ]         := oRetFld( cCodEmp() + ::oDbf:cCodDlg, ::oDelega, "cNomDlg" )
   cSay[ 6 ]         := Rtrim( oRetFld( ::oDbf:cCodAge, ::oDbfAge, 2 ) ) + ", " + Rtrim( oRetFld( ::oDbf:cCodAge, ::oDbfAge, 3 ) )
   cSay[ 7 ]         := oRetFld( ::oDbf:cCodUsr, ::oUsr )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "movimientos entre almacenes", "RemMov",, .F.,,,,,, .F.,,,,,, .F., )





      oBmpGeneral := TBitmap():ReDefine( 990, "movimiento_almacen_48_alpha",, oDlg,,, .F., .F.,,, .F.,,, .T. )





      ::oNumRem := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::oDbf:nNumRem, ::oDbf:nNumRem:= u ) }, oDlg,, ::oDbf:FieldByName( "nNumRem" ):cPict,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      ::oSufRem := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::oDbf:cSufRem, ::oDbf:cSufRem:= u ) }, oDlg,, ::oDbf:FieldByName( "cSufRem" ):cPict,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      ::oFecRem := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::oDbf:dFecRem, ::oDbf:dFecRem:= u ) }, oDlg,,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      TGetHlp():ReDefine( 220, { | u | If( PCount()==0, ::oDbf:cCodUsr, ::oDbf:cCodUsr:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 7 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, cSay[ 7 ], cSay[ 7 ]:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 240, { | u | If( PCount()==0, ::oDbf:cCodDlg, ::oDbf:cCodDlg:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 5 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, cSay[ 5 ], cSay[ 5 ]:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






      ::oRadTipoMovimiento := TRadMenu():Redefine( { | u | If( PCount()==0, ::oDbf:nTipMov, ::oDbf:nTipMov:= u ) }, oDlg,, { 130, 131, 132, 133 }, {||( ::ShwAlm( oSay, oBtnImp ) )},,,, .F., {||     ( nMode == 1 .AND. Empty( ::oDetMovimientos:oDbfVir:OrdKeyCount() ) )}, )





      ::oCodMov := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::oDbf:cCodMov, ::oDbf:cCodMov:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

      ::oCodMov:bValid     := {|| cTMov( ::oCodMov, ::oTMov:cAlias, oSay[ 3 ] ) }
      ::oCodMov:bHelp      := {|| BrwTMov( ::oCodMov, ::oTMov:cAlias, oSay[ 3 ] ) }




      oSay[ 3 ] := TGetHlp():ReDefine( 141, { | u | If( PCount()==0, cSay[ 3 ], cSay[ 3 ]:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )



      oSay[ 4 ] := TSay():ReDefine( 152, {|| "Almacén origen"}, oDlg,,,, .F.,, .F., .F. )






      ::oAlmOrg := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::oDbf:cAlmOrg, ::oDbf:cAlmOrg:= u ) }, oDlg,, ::oDbf:FieldByName( "cAlmOrg" ):cPict,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )
      ::oAlmOrg:bValid     := {|| cAlmacen( ::oAlmOrg, ::oAlm:cAlias, oSay[1] ) }
      ::oAlmOrg:bHelp      := {|| BrwAlmacen( ::oAlmOrg, oSay[1] ) }





      oSay[ 1 ] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, cSay[ 1 ], cSay[ 1 ]:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )






      ::oAlmDes := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::oDbf:cAlmDes, ::oDbf:cAlmDes:= u ) }, oDlg,, ::oDbf:FieldByName( "cAlmDes" ):cPict,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

      ::oAlmDes:bValid     := {|| cAlmacen( ::oAlmDes, ::oAlm:cAlias, oSay[2] ) }
      ::oAlmDes:bHelp      := {|| BrwAlmacen( ::oAlmDes, oSay[2] ) }




      oSay[ 2 ] := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cSay[ 2 ], cSay[ 2 ]:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

      ::oDefDiv( 190, 191, 192, oDlg, nMode )





      TGetHlp():ReDefine( 170, { | u | If( PCount()==0, ::oDbf:cComMov, ::oDbf:cComMov:= u ) }, oDlg,,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      ::oCodAge := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::oDbf:cCodAge, ::oDbf:cCodAge:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

         ::oCodAge:bValid  := {|| cAgentes( ::oCodAge, ::oDbfAge:cAlias, oSay[ 6 ] ) }
         ::oCodAge:bHelp   := {|| BrwAgentes( ::oCodAge, oSay[ 6 ] ) }




      oSay[ 6 ] := TGetHlp():ReDefine( 211, { | u | If( PCount()==0, cSay[ 6 ], cSay[ 6 ]:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









        TButton():ReDefine( 500, {||( ::AppendDet( oDlg ) )}, oDlg,,, .F., {||     ( nMode <> 3 .AND. !Empty( ::oDbf:cAlmDes ) )},,, .F. )





      TButton():ReDefine( 501, {||( ::EditDet() )}, oDlg,,, .F., {||     ( nMode <> 3 .AND. !Empty( ::oDbf:cAlmDes ) )},,, .F. )





        TButton():ReDefine( 502, {||( ::DeleteDet() )}, oDlg,,, .F., {||     ( nMode <> 3 .AND. !Empty( ::oDbf:cAlmDes ) )},,, .F. )





      TButton():ReDefine( 503, {||( ::Search() )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 507, {||( ::lSelDoc() )}, oDlg,,, .F., {||     ( nMode == 1 )},,, .F. )





      TButton():ReDefine( 504, {||( ::lSelAll( .T. ) )}, oDlg,,, .F., {||     ( nMode == 1 )},,, .F. )





      TButton():ReDefine( 505, {||( ::lSelAll( .F. ) )}, oDlg,,, .F., {||     ( nMode == 1 )},,, .F. )




      ::oBtnKit := TButton():ReDefine( 508, {||( ::ShowKit( .T. ) )}, oDlg,,, .F.,,,, .F. )





      oBtnImp := TButton():ReDefine( 506, {||( ::ImportAlmacen( nMode, oDlg ) )}, oDlg,,, .F., {||     ( nMode <> 3 .AND. !Empty( ::oDbf:cAlmDes ) )},,, .F. )

      ::oBrwDet               := IXBrowse():New( oDlg )

      ::oBrwDet:bClrSel       := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwDet:bClrSelFocus  := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      ::oBrwDet:nMarqueeStyle := 6
      ::oBrwDet:lHScroll      := .F.
      ::oBrwDet:lFooter       := .T.
      if nMode <> 3
         ::oBrwDet:bLDblClick := {|| ::EditDet() }
      end

      ::oBrwDet:cName         := "Detalle movimientos de almacén"

      ::oDetMovimientos:oDbfVir:SetBrowse( ::oBrwDet )

      ::oBrwDet:CreateFromResource( 180 )

      with object ( ::oBrwDet:addCol() )
         :cHeader          := "Se.  Seleccionado"
         :bStrData         := {|| "" }
         :bEditValue       := {|| ::oDetMovimientos:oDbfVir:FieldGetByName( "lSelDoc" ) }
         :nWidth           := 24
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Número"
         :bStrData      := {|| if( ::oDetMovimientos:oDbfVir:FieldGetByName( "lKitEsc" ), "", Trans( ::oDetMovimientos:oDbfVir:FieldGetByName( "nNumLin" ), "@EZ 9999" ) ) }
         :nWidth        := 60
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Código"
         :bStrData      := {|| ::oDetMovimientos:oDbfVir:FieldGetByName( "cRefMov" ) }
         :nWidth        := 100
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Nombre"
         :bStrData      := {|| RetArticulo( ::oDetMovimientos:oDbfVir:FieldGetByName( "cRefMov" ), ::oArt:cAlias ) }
         :nWidth        := 300
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Prop. 1"
         :bStrData      := {|| ::oDetMovimientos:oDbfVir:FieldGetByName( "cValPr1" ) }
         :nWidth        := 40
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Prop. 2"
         :bStrData      := {|| ::oDetMovimientos:oDbfVir:FieldGetByName( "cValPr2" ) }
         :nWidth        := 40
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Lote"
         :bStrData      := {|| ::oDetMovimientos:oDbfVir:FieldGetByName( "cLote" ) }
         :nWidth        := 80
         :lHide         := .T.
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Unidades"
         :bEditValue    := {|| nTotNMovAlm( ::oDetMovimientos:oDbfVir ) }
         :bFooter       := {|| ::oDetMovimientos:nTotUnidadesVir( .T. ) }
         :cEditPicture  := ::cPicUnd
         :nWidth        := 80
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Unidades ant."
         :bEditValue    := {|| nTotNMovOld( ::oDetMovimientos:oDbfVir ) }
         :cEditPicture  := ::cPicUnd
         :lHide         := .T.
         :nWidth        := 80
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Importe"
         :bEditValue    := {|| ::oDetMovimientos:oDbfVir:FieldGetByName( "nPreDiv" ) }
         :cEditPicture  := ::cPorDiv
         :nWidth        := 100
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Total"
         :bEditValue    := {|| nTotLMovAlm( ::oDetMovimientos:oDbfVir ) }
         :bFooter       := {|| ::oDetMovimientos:nTotRemVir( .T. ) }
         :cEditPicture  := ::cPorDiv
         :nWidth        := 100
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Total peso"
         :bEditValue    := {|| ( nTotNMovAlm( ::oDetMovimientos:oDbfVir ) * ::oDetMovimientos:oDbfVir:nPesoKg ) }
         :bFooter       := {|| ::oDetMovimientos:nTotPesoVir() }
         :cEditPicture  := MasUnd()
         :nWidth        := 80
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
         :lHide         := .T.
      end

      with object ( ::oBrwDet:addCol() )
         :cHeader       := "Total volumen"
         :bEditValue    := {|| ( nTotNMovAlm( ::oDetMovimientos:oDbfVir ) * ::oDetMovimientos:oDbfVir:nVolumen ) }
         :bFooter       := {|| ::oDetMovimientos:nTotVolumenVir() }
         :cEditPicture  := MasUnd()
         :nWidth        := 80
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
         :lHide         := .T.
      end

      ::nMeter          := 0
      ::oMeter          := TMeter():ReDefine( 400, { | u | if( pCount() == 0, ::nMeter, ::nMeter := u ) }, 10, oDlg, .F., , , .T., ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ), , ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) ) )





      TButton():ReDefine( 511, {||( if( ::lSave( nMode ), ( ::EndResource( .T., nMode, oDlg ), oDlg:End( 1 ) ), ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 510, {||( oDlg:End() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 559, {||( ChmHelp( "Movimientosalmacen" ) )}, oDlg,,, .F.,,,, .F. )

      if nMode <> 3
         oDlg:AddFastKey( 113, {|| ::AppendDet( oDlg ) } )
         oDlg:AddFastKey( 114, {|| ::EditDet() } )
         oDlg:AddFastKey( 115, {|| ::DeleteDet() } )
         oDlg:AddFastKey( 116, {|| if( ::lSave( nMode ), ( ::EndResource( .T., nMode, oDlg ), oDlg:End( 1 ) ), ) } )
      end

      oDlg:AddFastKey( 112, {|| ChmHelp( "Movimientosalmacen" ) } )

      oDlg:bStart := {|| ::ShwAlm( oSay, oBtnImp ), ::ShowKit( .F. ), ::oBrwDet:Load() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   oBmpGeneral:End()

   if oDlg:nResult <> 1
      ::EndResource( .F., nMode )
   end





   ::oBrwDet:CloseData()

RETURN ( oDlg:nResult == 1 )



UTILITY STATIC function TRemMovAlm_Search() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

    local oDlg
    local oIndice
   local cIndice  := "Código"
   local aIndice  := { "Código" }
    local oCadena
   local xCadena  := Space( 100 )
   local nOrdAnt  := ::oDetMovimientos:oDbfVir:OrdSetFocus( "cRefMov" )

   oDlg = TDialog():New(,,,,, "sSearch",, .F.,,,,,, .F.,,,,,, .F., )



    oCadena := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, xCadena, xCadena:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )
      oCadena:bChange   := {| nKey | oCadena:Assign(), ::oDetMovimientos:oDbfVir:Seek( Rtrim( xCadena ) + Chr( nKey ), .T. ), ::oBrwDet:Refresh() }





    oIndice := TComboBox():ReDefine( 101, { | u | If( PCount()==0, cIndice, cIndice:= u ) }, aIndice, oDlg,,, {|Self|( oCadena:SetFocus(), oCadena:SelectAll() )},,,, .F.,,,,,, )




    TButton():ReDefine( 510, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   ::oDetMovimientos:oDbfVir:OrdSetFocus( nOrdAnt )

RETURN NIL



UTILITY STATIC function TRemMovAlm_lSave( nMode) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   if Empty( ::oDbf:cCodAge ) .AND. lRecogerAgentes()
      MsgStop( "Código de agente no puede estar vacío." )
      ::oCodAge:SetFocus()
      Return .F.
   end

   if ::oDbf:nTipMov == 1

      if Empty( ::oDbf:cAlmOrg )
         MsgStop( "Almacén origen no puede estar vacío." )
         ::oAlmOrg:SetFocus()
         Return .F.
      end

      if ::oDbf:cAlmDes == ::oDbf:cAlmOrg
         MsgStop( "Almacén origen y destino no pueden ser iguales." )
         ::oAlmOrg:SetFocus()
         Return .F.
      end

   else

      if Empty( ::oDbf:cAlmDes )
         MsgStop( "Almacén destino no puede estar vacío." )
         ::oAlmDes:SetFocus()
         Return .F.
      end

   end

   if !::oDetMovimientos:oDbfVir:LastRec() > 0
      MsgStop( "No puede hacer un movimiento de almacén sin líneas" )
      Return .F.
   end





   ::oDbf:nTotRem    := ::oDetMovimientos:nTotRemVir()





   ::oMeter:nTotal   := ::nRegisterToProcess()

Return .T.



UTILITY STATIC function TRemMovAlm_GenRemMov( lPrinter, cCaption, cCodDoc, cPrinter, nCopies) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local oInf
   local oDevice
   local nNumRem

   IIF( lPrinter == nil, lPrinter := .F., ) ;
   IIF( cCaption == nil, cCaption := "Imprimiendo remesas de movimientos", ) ;
   IIF( cCodDoc == nil, cCodDoc := cFormatoDocumento(   nil, "nMovAlm", ::oDbfCnt:cAlias ), ) ;
   IIF( nCopies == nil, nCopies := nCopiasDocumento(    nil, "nMovAlm", ::oDbfCnt:cAlias ), ) ;

   if ::oDbf:Lastrec() == 0
      Return nil
   end

   if Empty( cCodDoc )
      cCodDoc           := "RM1"
   end

   if !lExisteDocumento( cCodDoc, ::oDbfDoc:cAlias )
      return nil
   end

   nNumRem              := Str( ::oDbf:nNumRem ) + ::oDbf:cSufRem

   private oThis        := Self

   ::oDbf:GetStatus( .T. )

   ::oDbf:Seek( nNumRem )
   ::oDetMovimientos:oDbf:Seek( nNumRem )
   ::oDetSeriesMovimientos:oDbf:Seek( nNumRem )
   ::oDbfAge:Seek( ::oDbf:cCodAge )

   if lVisualDocumento( cCodDoc, ::oDbfDoc:cAlias )

      public nTotMov       := ::nTotRemMov( .T. )

      ::PrintReportRemMov( if( lPrinter, 1, 2 ), nCopies, cPrinter, ::oDbfDoc:cAlias )

   else

      private oDbf         := ::oDbf
      private cDbf         := ::oDbf:cAlias
      private oDbfCol      := ::oDetMovimientos:oDbf
      private cDbfCol      := ::oDetMovimientos:oDbf:cAlias
      private cDbfAlm      := ::oAlm:cAlias
      private cDbfPro      := ::oTblPro:cAlias
      private cDbfFam      := ::oFam:cAlias
      private cDbfMov      := ::oTMov:cAlias
      private cDbfArt      := ::oArt:cAlias
      private cDbfAge      := ::oDbfAge:cAlias

      private cPouDivRem   := ::cPouDiv
      private cPorDivRem   := ::cPorDiv

      ::nTotRemMov( .T. )





      if !Empty( cPrinter )
         oDevice           := TPrinter():New( cCaption, .F., .T., cPrinter )
         oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .F.,, oDevice, cCaption,,, )
      else
         oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .T.,,, cCaption,,, )
      end

      if !Empty( oInf ) .AND. oInf:lCreated

         oInf:lAutoland          := .F.
         oInf:lFinish            := .F.
         oInf:lNoCancel          := .T.
         oInf:bSkip              := {|| ::::oDetMovimientos:oDbf:Skip() }

         oInf:oDevice:lPrvModal  := .T.

         if lPrinter
            oInf:bPreview        := {| oDevice | PrintPreview( oDevice ) }
         end

         SetMargin(  cCodDoc, oInf )
         PrintColum( cCodDoc, oInf )

      end

      RptEnd()

      if !Empty( oInf )




      oInf:Activate({||         ( !::::oDetMovimientos:oDbf:lImpLin )}, {||       ( Str( ::oDetMovimientos:oDbf:nNumRem ) + ::oDetMovimientos:oDbf:cSufRem == nNumRem .AND. !::oDetMovimientos:oDbf:Eof() )},,,, {||  ::EPage( oInf, cCodDoc )},,,,,,,, )

         if lPrinter
            oInf:oDevice:end()
         end

      end

      oInf  := nil

   end

   ::oDbf:SetStatus()

Return Nil



UTILITY STATIC function TRemMovAlm_EPage( oInf, cCodDoc) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

    private nPagina        := oInf:nPage
    private lEnd            := oInf:lFinish

   PrintItems( cCodDoc, oInf )

Return ( Self )



Function aDocRemMov()

   local aDoc  := {}





   aAdd( aDoc, { "Almacén",               "AL" } )
   aAdd( aDoc, { "Divisas",               "DV" } )
   aAdd( aDoc, { "Remesas movimientos",   "RM" } )

RETURN ( aDoc )



UTILITY STATIC function TRemMovAlm_lSelAll( lSel) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local nOrdAnt        := ::oDetMovimientos:oDbf:OrdSetFocus( "nNumRem" )

   IIF( lSel == nil, lSel := .T., ) ;

   ::oDbf:GetStatus()
   ::oDetMovimientos:oDbf:GetStatus()

   ::oDbf:GoTop()
   while !::oDbf:Eof()





      ::oDbf:Load()
      ::oDbf:lSelDoc := lSel
      ::oDbf:Save()





      ::oDetMovimientos:oDbf:GoTop()

      if ::oDetMovimientos:oDbf:Seek( Str( ::oDbf:nNumRem ) + ::oDbf:cSufRem )

         while Str( ::oDetMovimientos:oDbf:nNumRem ) + ::oDetMovimientos:oDbf:cSufRem == Str( ::oDbf:nNumRem ) + ::oDbf:cSufRem .AND. !::oDetMovimientos:oDbf:Eof()

            ::oDetMovimientos:oDbf:Load()
            ::oDetMovimientos:oDbf:lSndDoc    := ::oDbf:lSelDoc
            ::oDetMovimientos:oDbf:Save()

            ::oDetMovimientos:oDbf:Skip()

         end

      end

      ::oDbf:Skip()

   end

   ::oDbf:SetStatus()

   ::oDetMovimientos:oDbf:SetStatus()

   ::oDetMovimientos:oDbf:OrdSetFocus( nOrdAnt )

   if !Empty( ::oWndBrw )
      ::oWndBrw:Refresh()
   end

RETURN NIL



UTILITY STATIC function TRemMovAlm_lSelMov() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local nOrdAnt  := ::oDetMovimientos:oDbf:OrdSetFocus( "nNumRem" )

   ::oDbf:Load()
   ::oDbf:lSelDoc := !::oDbf:lSelDoc
   ::oDbf:Save()

   ::oDetMovimientos:oDbf:GetStatus()

   ::oDetMovimientos:oDbf:GoTop()

   if ::oDetMovimientos:oDbf:Seek( Str( ::oDbf:nNumRem ) + ::oDbf:cSufRem )

      while Str( ::oDetMovimientos:oDbf:nNumRem ) + ::oDetMovimientos:oDbf:cSufRem == Str( ::oDbf:nNumRem ) + ::oDbf:cSufRem .AND. !::oDetMovimientos:oDbf:Eof()

         ::oDetMovimientos:oDbf:Load()
         ::oDetMovimientos:oDbf:lSndDoc    := ::oDbf:lSelDoc
         ::oDetMovimientos:oDbf:Save()

         ::oDetMovimientos:oDbf:Skip()

      end

   end

   ::oDetMovimientos:oDbf:SetStatus()

   ::oDetMovimientos:oDbf:OrdSetFocus( nOrdAnt )

Return( .T. )



UTILITY STATIC function TRemMovAlm_CreateData() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local lSnd        := .T.
   local oRemMov
   local oRemMovTmp
   local cFileName

   if ::oSender:lServer
      cFileName      := "MovAlm" + StrZero( ::nGetNumberToSend(), 6 ) + ".All"
   else
      cFileName      := "MovAlm" + StrZero( ::nGetNumberToSend(), 6 ) + "." + RetSufEmp()
   end

   ::oSender:SetText( "Enviando movimientos de almacén" )

   oRemMov           := TRemMovAlm():New( cPatEmp() )
   oRemMov:OpenService()

   oRemMov:oDetMovimientos:oDbf:OrdSetFocus( "nNumRem" )





   oRemMovTmp        := TRemMovAlm():New( cPatSnd() )
   oRemMovTmp:OpenService()

   oRemMovTmp:oDetMovimientos:oDbf:OrdSetFocus( "nNumRem" )





   while !oRemMov:oDbf:eof()

      if oRemMov:oDbf:lSelDoc

         lSnd  := .T.

         dbPass( oRemMov:oDbf:nArea, oRemMovTmp:oDbf:nArea, .T. )

         ::oSender:SetText( Str( oRemMov:oDbf:nNumRem, 9 ) + "/" + oRemMov:oDbf:cSufRem )

         if oRemMov:oDetMovimientos:oDbf:Seek( Str( oRemMov:oDbf:nNumRem, 9 ) + oRemMov:oDbf:cSufRem )

            while Str( oRemMov:oDbf:nNumRem, 9 ) + oRemMov:oDbf:cSufRem == Str( oRemMov:oDetMovimientos:oDbf:nNumRem, 9 ) + oRemMov:oDetMovimientos:oDbf:cSufRem .AND. !oRemMov:oDetMovimientos:oDbf:Eof()
               dbPass( oRemMov:oDetMovimientos:oDbf:nArea, oRemMovTmp:oDetMovimientos:oDbf:nArea, .T. )
               oRemMov:oDetMovimientos:oDbf:Skip()
            end

         end

      end

      oRemMov:oDbf:Skip()

   end





   oRemMov:CloseService()
   oRemMov:End()

   oRemMovTmp:CloseService()
   oRemMovTmp:End()

   if lSnd





      ::oSender:SetText( "Comprimiendo movimientos de almacén" )

      if ::oSender:lZipData( cFileName )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay movimientos de almacén para enviar" )

   end

Return ( Self )



UTILITY STATIC function TRemMovAlm_RestoreData() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local oRemMov

   if ::lSuccesfullSend

      oRemMov  := TRemMovAlm():Create( cPatEmp() )
      oRemMov:OpenService()

      oRemMov:oDbf:GoTop()

      while !oRemMov:oDbf:Eof()

         if oRemMov:oDbf:lSelDoc
            oRemMov:oDbf:Load()
            oRemMov:oDbf:lSelDoc := .F.
            oRemMov:oDbf:Save()
         end

         oRemMov:oDbf:Skip()

      end

      oRemMov:CloseService()

      oRemMov:End()

   end

Return ( Self )



UTILITY STATIC function TRemMovAlm_SendData() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local cFileName

   if ::oSender:lServer
      cFileName      := "MovAlm" + StrZero( ::nGetNumberToSend(), 6 ) + ".All"
   else
      cFileName      := "MovAlm" + StrZero( ::nGetNumberToSend(), 6 ) + "." + RetSufEmp()
   end

   if file( cPatOut() + cFileName )

      if ftpSndFile( cPatOut() + cFileName, cFileName, 2000, ::oSender )
         ::lSuccesfullSend := .T.
         ::IncNumberToSend()
         ::oSender:SetText( "Fichero enviado " + cFileName )
      else
         ::oSender:SetText( "ERROR fichero no enviado" )
      end

   end

Return ( Self )



UTILITY STATIC function TRemMovAlm_ReciveData() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local n
   local aExt

   if ::oSender:lServer
      aExt        := aRetDlgEmp()
   else
      aExt        := { "All" }
   end





   ::oSender:SetText( "Recibiendo movimientos de almacén" )

   for n := 1 to len( aExt )
      ftpGetFiles( "MovAlm*." + aExt[ n ], cPatIn(), 2000, ::oSender )
   next

   ::oSender:SetText( "Movimientos de almacén recibidos" )

Return Self



UTILITY STATIC function TRemMovAlm_Process() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local m
   local oAlm
   local oBlock
   local oError
   local oRemMov
   local oRemMovTmp
   local dbfRemMovTmp
   local dbfRemMovFix
   local aFiles               := Directory( cPatIn() )

   oAlm := DbfServer( "ALMACEN.DBF", ):NewOpen( "ALMACEN.DBF",, ( cDriver() ),, ( cPatAlm() ), .F., .T., .F., .F. ) ; oAlm:AddBag( "ALMACEN.CDX" ) ; oAlm:AddBag( ) ; oAlm:AutoIndex()





   ::oSender:SetText( "Importando movimientos de almacén" )

   for m := 1 to len( aFiles )

      oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE





      if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )





         ::oSender:SetText( "Procesando fichero " + cPatIn() + aFiles[ m, 1 ] )

         if file( cPatSnd() + "RemMovT.Dbf" )

            oRemMovTmp        := TRemMovAlm():New( cPatSnd() )
            oRemMovTmp:OpenService( .F., .T. )

            oRemMovTmp:oDetMovimientos:oDbf:OrdSetFocus( "nNumRem" )

            oRemMov           := TRemMovAlm():New( cPatEmp() )
            oRemMov:OpenService()

            oRemMov:oDetMovimientos:oDbf:OrdSetFocus( "nNumRem" )

            dbfRemMovTmp      := oRemMovTmp:oDbf:cAlias
            dbfRemMovFix      := oRemMov:oDbf:cAlias





            oRemMovTmp:oDbf:GoTop()
            while !oRemMovTmp:oDbf:eof()

               do case
               case oAlm:Seek( oRemMovTmp:oDbf:cAlmOrg ) .AND. oAlm:Seek( oRemMovTmp:oDbf:cAlmDes )

                  if oRemMov:oDbf:Seek( Str( oRemMovTmp:oDbf:nNumRem, 9 ) + oRemMovTmp:oDbf:cSufRem )
                     dbPass( oRemMovTmp:oDbf:cAlias, oRemMov:oDbf:cAlias, .F. )
                     ::oSender:SetText( "Reemplazado : " + AllTrim( Str( oRemMovTmp:oDbf:nNumRem, 9 ) ) + "/" + AllTrim( oRemMovTmp:oDbf:cSufRem ) + "; " + Dtoc( oRemMovTmp:oDbf:dFecRem ) )
                  else
                     dbPass( oRemMovTmp:oDbf:cAlias, oRemMov:oDbf:cAlias, .T. )
                     ::oSender:SetText( "Añadido     : " + AllTrim( Str( oRemMovTmp:oDbf:nNumRem, 9 ) ) + "/" + AllTrim( oRemMovTmp:oDbf:cSufRem ) + "; " + Dtoc( oRemMovTmp:oDbf:dFecRem ) )
                  end

               case oAlm:Seek( oRemMovTmp:oDbf:cAlmOrg ) .AND. !oAlm:Seek( oRemMovTmp:oDbf:cAlmDes )

                  if oRemMov:oDbf:Seek( Str( oRemMovTmp:oDbf:nNumRem, 9 ) + oRemMovTmp:oDbf:cSufRem )
                     dbPass( oRemMovTmp:oDbf:cAlias, oRemMov:oDbf:cAlias, .F. )
                     ::oSender:SetText( "Reemplazado : " + AllTrim( Str( oRemMovTmp:oDbf:nNumRem, 9 ) ) + "/" + AllTrim( oRemMovTmp:oDbf:cSufRem ) + "; " + Dtoc( oRemMovTmp:oDbf:dFecRem ) )
                  else
                     dbPass( oRemMovTmp:oDbf:cAlias, oRemMov:oDbf:cAlias, .T. )
                     ::oSender:SetText( "Añadido     : " + AllTrim( Str( oRemMovTmp:oDbf:nNumRem, 9 ) ) + "/" + AllTrim( oRemMovTmp:oDbf:cSufRem ) + "; " + Dtoc( oRemMovTmp:oDbf:dFecRem ) )
                  end

                  ::oSender:SetText( "No existe almacen destino : " + AllTrim( Str( oRemMovTmp:oDbf:nNumRem, 9 ) ) + "/" + AllTrim( oRemMovTmp:oDbf:cSufRem ) + "; " + Dtoc( oRemMovTmp:oDbf:dFecRem ) )
                  oRemMov:oDbf:FieldPutByName( "cAlmDes", Space( 3 ) )

               case !oAlm:Seek( oRemMovTmp:oDbf:cAlmOrg ) .AND. oAlm:Seek( oRemMovTmp:oDbf:cAlmDes )

                  if oRemMov:oDbf:Seek( Str( oRemMovTmp:oDbf:nNumRem, 9 ) + oRemMovTmp:oDbf:cSufRem )
                     dbPass( oRemMovTmp:oDbf:cAlias, oRemMov:oDbf:cAlias, .F. )
                     ::oSender:SetText( "Reemplazado : " + AllTrim( Str( oRemMovTmp:oDbf:nNumRem, 9 ) ) + "/" + AllTrim( oRemMovTmp:oDbf:cSufRem ) + "; " + Dtoc( oRemMovTmp:oDbf:dFecRem ) )
                  else
                     dbPass( oRemMovTmp:oDbf:cAlias, oRemMov:oDbf:cAlias, .T. )
                     ::oSender:SetText( "Añadido     : " + AllTrim( Str( oRemMovTmp:oDbf:nNumRem, 9 ) ) + "/" + AllTrim( oRemMovTmp:oDbf:cSufRem ) + "; " + Dtoc( oRemMovTmp:oDbf:dFecRem ) )
                  end

                  ::oSender:SetText( "No existe almacen origen : " + AllTrim( Str( oRemMovTmp:oDbf:nNumRem, 9 ) ) + "/" + AllTrim( oRemMovTmp:oDbf:cSufRem ) + "; " + Dtoc( oRemMovTmp:oDbf:dFecRem ) )
                  oRemMov:oDbf:FieldPutByName( "cAlmOrg", Space( 3 ) )

               end





               if oRemMovTmp:oDbf:nNumRem <> 0
                  while oRemMov:oDetMovimientos:oDbf:Seek( Str( oRemMovTmp:oDbf:nNumRem, 9 ) + oRemMovTmp:oDbf:cSufRem ) .AND. !oRemMov:oDetMovimientos:oDbf:eof()
                     oRemMov:oDetMovimientos:oDbf:Delete()
                  end
               end





               if oRemMovTmp:oDetMovimientos:oDbf:Seek( Str( oRemMovTmp:oDbf:nNumRem, 9 ) + oRemMovTmp:oDbf:cSufRem )

                  while Str( oRemMovTmp:oDetMovimientos:oDbf:nNumRem, 9 ) + oRemMovTmp:oDetMovimientos:oDbf:cSufRem == Str( oRemMovTmp:oDbf:nNumRem, 9 ) + oRemMovTmp:oDbf:cSufRem .AND. !oRemMovTmp:oDetMovimientos:oDbf:eof()

                     do case
                     case oAlm:Seek( oRemMovTmp:oDetMovimientos:oDbf:cAliMov ) .AND. oAlm:Seek( oRemMovTmp:oDetMovimientos:oDbf:cAloMov )

                        dbPass( oRemMovTmp:oDetMovimientos:oDbf:cAlias, oRemMov:oDetMovimientos:oDbf:cAlias, .T. )

                     case !oAlm:Seek( oRemMovTmp:oDetMovimientos:oDbf:cAliMov ) .AND. oAlm:Seek( oRemMovTmp:oDetMovimientos:oDbf:cAloMov )

                        dbPass( oRemMovTmp:oDetMovimientos:oDbf:cAlias, oRemMov:oDetMovimientos:oDbf:cAlias, .T. )
                        oRemMov:oDetMovimientos:oDbf:FieldPutByName( "cAliMov", Space( 3 ) )

                     case oAlm:Seek( oRemMovTmp:oDetMovimientos:oDbf:cAliMov ) .AND. !oAlm:Seek( oRemMovTmp:oDetMovimientos:oDbf:cAloMov )

                        dbPass( oRemMovTmp:oDetMovimientos:oDbf:cAlias, oRemMov:oDetMovimientos:oDbf:cAlias, .T. )
                        oRemMov:oDetMovimientos:oDbf:FieldPutByName( "cAloMov", Space( 3 ) )

                     end

                     oRemMovTmp:oDetMovimientos:oDbf:Skip()

                  end

               end

               oRemMovTmp:oDbf:Skip()

            end





            oRemMov:CloseService()
            oRemMov:End()

            oRemMovTmp:CloseService()
            oRemMovTmp:End()

            ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

         else

            ::oSender:SetText( "Faltan ficheros" )

            if !File( cPatSnd() + "RemMovT.Dbf" )
               ::oSender:SetText( "Falta " + cPatSnd() + "RemMovT.Dbf" )
            end

         end

      end

      RECOVER USING oError

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

   next

   if !Empty( oAlm ) .AND. oAlm:Used()
      oAlm:End()
   end

Return Self



UTILITY STATIC function TRemMovAlm_nGetNumberToSend() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   ::nNumberSend     := GetPvProfInt( "Numero", ::cText, ::nNumberSend, ::cIniFile )

Return ( ::nNumberSend )



UTILITY STATIC function TRemMovAlm_Save() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   WritePProString( "Envio",     ::cText, cValToChar( ::lSelectSend ), ::cIniFile )
   WritePProString( "Recepcion", ::cText, cValToChar( ::lSelectRecive ), ::cIniFile )

RETURN ( Self )



UTILITY STATIC function TRemMovAlm_Load() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   ::lSelectSend     := ( Upper( GetPvProfString( "Envio",     ::cText, cValToChar( ::lSelectSend ),   ::cIniFile ) ) == ".T." )
   ::lSelectRecive   := ( Upper( GetPvProfString( "Recepcion", ::cText, cValToChar( ::lSelectRecive ), ::cIniFile ) ) == ".T." )

RETURN ( Self )



UTILITY STATIC function TRemMovAlm_lGenRemMov( oBrw, oBtn, lImp) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local bAction

   IIF( lImp == nil, lImp := .F., ) ;

   if !::oDbfDoc:Seek( "RM" )








      ::oWndBrw:NewAt( "DOCUMENT",,, {||( msgStop( "No hay documentos predefinidos" ) )}, "No hay documentos", "N",,, 4, oBtn, .F. )

   else

      while ::oDbfDoc:cTipo == "RM" .AND. !::oDbfDoc:eof()

         bAction  := ::bGenRemMov( lImp, "Imprimiendo movimientoo de almacén", ::oDbfDoc:Codigo )

         ::oWndBrw:NewAt( "Document", , , bAction, Rtrim( ::oDbfDoc:cDescrip ) , , , , , oBtn )

         ::oDbfDoc:Skip()

      end

   end

RETURN nil



UTILITY STATIC function TRemMovAlm_bGenRemMov( lImprimir, cTitle, cCodDoc) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local bGen
   local lImp  := by( lImprimir )
   local cTit  := by( cTitle    )
   local cCod  := by( cCodDoc   )

   bGen        := {|| ::GenRemMov( lImp, cTit, cCod ) }

RETURN ( bGen )



UTILITY STATIC function TRemMovAlm_Reindexa() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   if Empty( ::oDbf )
      ::oDbf      := ::DefineFiles()
   end

   ::oDbf:IdxFDel()

   ::oDbf:Activate( .F., .T., .F. )

   ::oDbf:Pack()

   ::oDbf:End()

RETURN ( Self )



UTILITY STATIC function TRemMovAlm_CheckFiles() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   if ::OpenService()
      ::CloseFiles()
   end

Return ( Self )



UTILITY STATIC function TRemMovAlm_AppendDet( oDlg) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local nDetalle



   while .T.

      ::oDetMovimientos:oDbfVir:Blank()

      nDetalle    := ::oDetMovimientos:Resource( 1 )

      do case
      case nDetalle == 1

         ::oDetMovimientos:oDbfVir:Insert()

         IIF( ::oBrwDet <> nil, ::oBrwDet:Refresh(), )

         ::oDetMovimientos:AppendKit()

         if lEntCon()
            loop
         else
            exit
         end

      case nDetalle == 3

         ::oDetMovimientos:oDbfVir:Cancel()

         IIF( ::oBrwDet <> nil, ::oBrwDet:Refresh(), )

         if lEntCon()
            loop
         else
            exit
         end

      otherwise

         ::oDetMovimientos:oDbfVir:Cancel()

         IIF( ::oBrwDet <> nil, ::oBrwDet:Refresh(), )

         exit

      end

   end



RETURN ( Self )



UTILITY STATIC function TRemMovAlm_EditDet() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   if ::oDetMovimientos:oDbfVir:OrdKeyCount() == 0
      Return ( Self )
   end

   ::oDetMovimientos:oDbfVir:Load()

   if ::oDetMovimientos:Resource( 2 ) == 1
      ::oDetMovimientos:oDbfVir:Save()
   else
      ::oDetMovimientos:oDbfVir:Cancel()
   end

   IIF( ::oBrwDet <> nil, ::oBrwDet:Refresh(), )

RETURN ( Self )



UTILITY STATIC function TRemMovAlm_DeleteDet() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local nNum
   local nNumLin
   local nNumRec
   local nMarked
   local cTxtDel

   if ::oDetMovimientos:oDbfVir:OrdKeyCount() == 0
      Return ( Self )
   end

   nMarked           := len( ::oBrwDet:aSelected )
   if nMarked > 1
      cTxtDel        := "¿ Desea eliminar definitivamente " + AllTrim( Str( nMarked, 3 ) ) + " registros ?"
   else
      cTxtDel        := "¿Desea eliminar el registro en curso?"
   end

   if oUser():lNotConfirmDelete() .OR.  ApoloMsgNoYes(cTxtDel, "Confirme supersión" )

      for each nNum in ( ::oBrwDet:aSelected )

         ::oDetMovimientos:oDbfVir:GoTo( nNum )

         nNumLin        := ::oDetMovimientos:oDbfVir:nNumLin
         nNumRec        := ::oDetMovimientos:oDbfVir:Recno()





         ::oDetMovimientos:oDbfVir:GoTop()

         while !::oDetMovimientos:oDbfVir:Eof()
            if !Empty( nNumLin ) .AND. ( ::oDetMovimientos:oDbfVir:nNumLin == nNumLin )
               ::oDetMovimientos:oDbfVir:Delete()
            end
            ::oDetMovimientos:oDbfVir:Skip()
         end

         ::oDetMovimientos:oDbfVir:GoTo( nNumRec )





         ::oDetMovimientos:oDbfVir:Delete()

         ::oBrwDet:Refresh()

      next

   end

   if ::oDetMovimientos:oDbfVir:OrdKeyCount() == 0
      ::oRadTipoMovimiento:Enable()
   end

   ::oBrwDet:Select()

Return ( Self )



UTILITY STATIC function TRemMovAlm_ImportAlmacen( nMode, oDlg) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm



   ::cFamiliaInicio        := dbFirst( ::oFam, 1 )
   ::cFamiliaFin           := dbLast ( ::oFam, 1 )
   ::cArticuloInicio       := dbFirst( ::oArt, 1 )
   ::cArticuloFin          := dbLast ( ::oArt, 1 )
   ::cTipoArticuloInicio   := dbFirst( ::oTipArt:oDbf, 1 )
   ::cTipoArticuloFin      := dbLast ( ::oTipArt:oDbf, 1 )

   ::oDlgImport = TDialog():New(,,,,, "ImportAlmacen",, .F.,,,,,, .F.,,,,,, .F., )




      TCheckBox():ReDefine( 200, { | u | If( PCount()==0, ::lFamilia, ::lFamilia:= u ) }, ::oDlgImport,,,,,,, .F.,, .F. )






      ::oFamiliaInicio := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::cFamiliaInicio, ::cFamiliaInicio:= u ) }, ::oDlgImport,,,,,,,,, .F., {||     ( !::lFamilia )},, .F., .F.,,,,,, nil, "LUPA",, 220 )
      ::oFamiliaInicio:bValid    := {|| cFamilia( ::oFamiliaInicio, ::oFam:cAlias, ::oFamiliaInicio:oHelpText ) }
      ::oFamiliaInicio:bHelp     := {|| brwFamilia( ::oFamiliaInicio, ::oFamiliaInicio:oHelpText ) }







      ::oFamiliaFin := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, ::cFamiliaFin, ::cFamiliaFin:= u ) }, ::oDlgImport,,,,,,,,, .F., {||     ( !::lFamilia )},, .F., .F.,,,,,, nil, "LUPA",, 240 )
      ::oFamiliaFin:bValid       := {|| cFamilia( ::oFamiliaFin, ::oFam:cAlias, ::oFamiliaFin:oHelpText ) }
      ::oFamiliaFin:bHelp        := {|| brwFamilia( ::oFamiliaFin, ::oFamiliaFin:oHelpText ) }




      TCheckBox():ReDefine( 370, { | u | If( PCount()==0, ::lTipoArticulo, ::lTipoArticulo:= u ) }, ::oDlgImport,,,,,,, .F.,, .F. )






      ::oTipoArticuloInicio := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, ::cTipoArticuloInicio, ::cTipoArticuloInicio:= u ) }, ::oDlgImport,,,,,,,,, .F., {||     ( !::lTipoArticulo )},, .F., .F.,,,,,, nil, "LUPA",, 351 )
      ::oTipoArticuloInicio:bValid    := {|| ::oTipArt:lValid( ::oTipoArticuloInicio, ::oTipoArticuloInicio:oHelpText ) }
      ::oTipoArticuloInicio:bHelp     := {|| ::oTipArt:Buscar( ::oTipoArticuloInicio ) }







      ::oTipoArticuloFin := TGetHlp():ReDefine( 360, { | u | If( PCount()==0, ::cTipoArticuloFin, ::cTipoArticuloFin:= u ) }, ::oDlgImport,,,,,,,,, .F., {||     ( !::lTipoArticulo )},, .F., .F.,,,,,, nil, "LUPA",, 361 )
      ::oTipoArticuloFin:bValid       := {|| ::oTipArt:lValid( ::oTipoArticuloFin, ::oTipoArticuloFin:oHelpText ) }
      ::oTipoArticuloFin:bHelp        := {|| ::oTipArt:Buscar( ::oTipoArticuloFin ) }




      TCheckBox():ReDefine( 300, { | u | If( PCount()==0, ::lArticulo, ::lArticulo:= u ) }, ::oDlgImport,,,,,,, .F.,, .F. )






      ::oArticuloInicio := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, ::cArticuloInicio, ::cArticuloInicio:= u ) }, ::oDlgImport,,,,,,,,, .F., {||     ( !::lArticulo )},, .F., .F.,,,,,, nil, "LUPA",, 320 )
      ::oArticuloInicio:bValid    := {|| cArticulo( ::oArticuloInicio, ::oArt:cAlias, ::oArticuloInicio:oHelpText ) }
      ::oArticuloInicio:bHelp     := {|| brwArticulo( ::oArticuloInicio, ::oArticuloInicio:oHelpText ) }







      ::oArticuloFin := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, ::cArticuloFin, ::cArticuloFin:= u ) }, ::oDlgImport,,,,,,,,, .F., {||     ( !::lArticulo )},, .F., .F.,,,,,, nil, "LUPA",, 340 )
      ::oArticuloFin:bValid       := {|| cArticulo( ::oArticuloFin, ::oArt:cAlias, ::oArticuloFin:oHelpText ) }
      ::oArticuloFin:bHelp        := {|| brwArticulo( ::oArticuloFin, ::oArticuloFin:oHelpText ) }





      ::oMtrStock := TMeter():ReDefine( 400, { | u | If( PCount()==0, ::nMtrStock, ::nMtrStock:= u ) },, ::oDlgImport, .F.,, "", .F.,,,, )




      TButton():ReDefine( 1, {||( ::loadAlmacen( nMode ) )}, ::oDlgImport,,, .F.,,,, .F. )




      TButton():ReDefine( 2, {||( ::oDlgImport:End() )}, ::oDlgImport,,, .F.,,,, .F. )

   ::oDlgImport:bStart  := {|| ::oFamiliaInicio:lValid(), ::oFamiliaFin:lValid(), ::oArticuloInicio:lValid(), ::oArticuloFin:lValid(), ::oTipoArticuloInicio:lValid(), ::oTipoArticuloFin:lValid() }

   ::oDlgImport:AddFastKey( 116, {|| ::loadAlmacen( nMode ) } )

   ::oDlgImport:Activate( ::oDlgImport:bLClicked, ::oDlgImport:bMoved, ::oDlgImport:bPainted, .T.,,,, ::oDlgImport:bRClicked,,, )



Return nil



UTILITY STATIC function TRemMovAlm_LoadAlmacen( nMode) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local nPreMed
   local cCodFam
   local cCodTip
   local sStkAlm
   local aStkAlm

   CursorWait()

   ::oDlgImport:Disable()

   if ( nMode == 1 ) .AND. ( ::oDbf:nTipMov >= 2 )

      ::oMtrStock:cText    := "Importando artículos "
      ::oMtrStock:nTotal   := ( ::oStock:cArt )->( LastRec() )
      ::oMtrStock:Refresh()

      aStkAlm              := ::oStock:aStockAlmacen( Self )

      for each sStkAlm in aStkAlm

         if ::oDetMovimientos:oDbfVir:Append()

            ::oDetMovimientos:oDbfVir:Blank()

            ::oDetMovimientos:oDbfVir:lSelDoc   := .T.

            ::oDetMovimientos:oDbfVir:cRefMov   := sStkAlm:cCodigo

            ::oDetMovimientos:oDbfVir:cCodPr1   := sStkAlm:cCodigoPropiedad1
            ::oDetMovimientos:oDbfVir:cCodPr2   := sStkAlm:cCodigoPropiedad1
            ::oDetMovimientos:oDbfVir:cValPr1   := sStkAlm:cValorPropiedad1
            ::oDetMovimientos:oDbfVir:cValPr2   := sStkAlm:cValorPropiedad1
            ::oDetMovimientos:oDbfVir:cLote     := sStkAlm:cLote

            ::oDetMovimientos:oDbfVir:nNumRem   := ::oDbf:nNumRem
            ::oDetMovimientos:oDbfVir:cSufRem   := ::oDbf:cSufRem

            ::oDetMovimientos:oDbfVir:nNumLin   := nLastNum( ::oDetMovimientos:oDbfVir:cAlias )

            ::oDetMovimientos:oDbfVir:dFecMov   := ::oDbf:dFecRem
            ::oDetMovimientos:oDbfVir:cTimMov   := ::oDbf:cTimRem

            ::oDetMovimientos:oDbfVir:nTipMov   := ::oDbf:nTipMov
            ::oDetMovimientos:oDbfVir:cCodMov   := ::oDbf:cCodMov
            ::oDetMovimientos:oDbfVir:cAliMov   := ::oDbf:cAlmDes
            ::oDetMovimientos:oDbfVir:cAloMov   := Space( 3 )

            ::oDetMovimientos:oDbfVir:nUndMov   := 0
            ::oDetMovimientos:oDbfVir:nUndAnt   := ::oStock:nStockAlmacen( sStkAlm:cCodigo, ::oDbf:cAlmDes, ::oDetMovimientos:oDbfVir:cValPr1, ::oDetMovimientos:oDbfVir:cValPr2, ::oDetMovimientos:oDbfVir:cLote )

            if !uFieldEmpresa( "lCosAct" )

               nPreMed                          := ::oStock:nPrecioMedioCompra( sStkAlm:cCodigo, ::oDbf:cAlmDes, nil, GetSysDate() )

               if nPreMed == 0
                  nPreMed                       := nCosto( sStkAlm:cCodigo, ::oArt:cAlias, ::oArtKit:cAlias )
               end

            else

               nPreMed                          := nCosto( sStkAlm:cCodigo, ::oArt:cAlias, ::oArtKit:cAlias )

            end

            ::oDetMovimientos:oDbfVir:nPreDiv    := nPreMed

            ::oDetMovimientos:oDbfVir:Save()

         end

      next

      ::oDetMovimientos:oDbfVir:GoTop()

      ::oBrwDet:Refresh()

      ::oMtrStock:Set( ( ::oStock:cArt )->( LastRec() ) )

   end

   ::oMtrStock:Set( 0 )

   ::oDlgImport:Enable()
   ::oDlgImport:End()

   CursorWE()

RETURN ( .T. )



UTILITY STATIC function TRemMovAlm_nClrText() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local cClr

   if ::oDbfVir:lKitEsc
      cClr     := 8421504
   else
      cClr     := 0
   end

RETURN cClr



UTILITY STATIC function TRemMovAlm_ShowKit( lSet) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local lShwKit     := lShwKit()

   if lSet
      lShwKit        := !lShwKit
   end

   if lShwKit
      SetWindowText( ::oBtnKit:hWnd, "Mostrar Esc&ll." )
      ::oDetMovimientos:oDbfVir:SetFilter( "!lKitEsc" )
   else
      SetWindowText( ::oBtnKit:hWnd, "Ocultar Esc&ll." )
      ::oDetMovimientos:oDbfVir:KillFilter()
   end

   if lSet
      lShwKit( lShwKit )
   end

   ::oBrwDet:Refresh()

RETURN ( Self )



UTILITY STATIC function TRemMovAlm_ShwAlm( oSay, oBtnImp) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   if ::oDbf:nTipMov >= 2
      oSay[ 1 ]:Hide()
      oSay[ 4 ]:Hide()
      ::oAlmOrg:Hide()
      oSay[ 1 ]:cText( Space(3) )
      ::oAlmOrg:cText( Space(3) )
      if !Empty( oBtnImp )
         oBtnImp:Show()
      end
   else
      oSay[ 1 ]:Show()
      oSay[ 4 ]:Show()
      ::oAlmOrg:Show()
      if !Empty( oBtnImp )
         oBtnImp:Hide()
      end
   end

return .T.






UTILITY STATIC function TRemMovAlm_nTotRemMov( lPic) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local nTot     := 0

   if !Empty( ::oDbf ) .AND. ::oDbf:Used() .AND. !Empty( ::oDetMovimientos ) .AND. ::oDetMovimientos:oDbf:Used()

      if ::oDetMovimientos:oDbf:Seek( Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem )
         while Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem == Str( ::oDetMovimientos:oDbf:nNumRem, 9 ) + ::oDetMovimientos:oDbf:cSufRem .AND. !::oDetMovimientos:oDbf:Eof()
            nTot  +=  nTotLMovAlm( ::oDetMovimientos:oDbf )
            ::oDetMovimientos:oDbf:Skip()
         end
      end

   end

RETURN ( if( IsTrue( lPic ), Trans( nTot, ::cPorDiv ), nTot ) )



FUNCTION RemMovAlm( oMenuItem, oWnd )

   IIF( oMenuItem == nil, oMenuItem := "01050", ) ;
   IIF( oWnd == nil, oWnd := oWnd(), ) ;

   if Empty( oRemesas )





      if oWnd <> nil
         SysRefresh(); oWnd:CloseAll(); SysRefresh()
      end





      AddMnuNext( "Movimientos de almacén", ProcName() )

      oRemesas          := TRemMovAlm():New( cPatEmp(), oWnd, oMenuItem )
      if !Empty( oRemesas )
         oRemesas:Play()
      end

      oRemesas          := nil

   end

RETURN NIL



UTILITY STATIC function TRemMovAlm_lSelAllDoc( lSel) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   IIF( lSel == nil, lSel := .T., ) ;

   ::oDbfVir:GetStatus()

   ::oDbfVir:GoTop()
   while !::oDbfVir:Eof()
      ::oDbfVir:lSelDoc := lSel
      ::oDbfVir:Skip()
   end

   ::oDbfVir:SetStatus()

   ::oBrwDet:Refresh()

RETURN NIL



UTILITY STATIC function TRemMovAlm_lSelDoc() ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   ::oDbfVir:Load()
   ::oDbfVir:lSelDoc := !::oDbfVir:lSelDoc
   ::oDbfVir:Save()

   ::oBrwDet:Refresh()

RETURN nil




UTILITY STATIC function TRemMovAlm_DataReport( oFr) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "Movimiento", ::oDbf:nArea, .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "Movimiento", cObjectsToReport( ::oDbf ) )

   if !Empty( ::oDetMovimientos )
      oFr:SetWorkArea(     "Lineas de movimientos", ::oDetMovimientos:oDbf:nArea )
      oFr:SetFieldAliases( "Lineas de movimientos", cObjectsToReport( ::oDetMovimientos:oDbf ) )
   end

   oFr:SetWorkArea(     "Empresa", ::oDbfEmp:nArea )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Almacén origen", ::oAlm:nArea )
   oFr:SetFieldAliases( "Almacén origen", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Almacén destino", ::oAlm:nArea )
   oFr:SetFieldAliases( "Almacén destino", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Agentes", ::oDbfAge:nArea )
   oFr:SetFieldAliases( "Agentes", cItemsToReport( aItmAge() ) )

   if !Empty( ::oDetMovimientos )
      oFr:SetMasterDetail( "Movimiento", "Lineas de movimientos", {|| Str( ::oDbf:nNumRem ) + ::oDbf:cSufRem } )
   end

   oFr:SetMasterDetail( "Movimiento", "Empresa",               {|| cCodigoEmpresaEnUso() } )
   oFr:SetMasterDetail( "Movimiento", "Almacén origen",        {|| ::oDbf:cAlmOrg } )
   oFr:SetMasterDetail( "Movimiento", "Almacén destino",       {|| ::oDbf:cAlmDes } )
   oFr:SetMasterDetail( "Movimiento", "Agentes",               {|| ::oDbf:cCodAge } )

   if !Empty( ::oDetMovimientos )
      oFr:SetResyncPair(   "Movimiento", "Lineas de movimientos" )
   end

   oFr:SetResyncPair(   "Movimiento", "Empresa" )
   oFr:SetResyncPair(   "Movimiento", "Almacén origen" )
   oFr:SetResyncPair(   "Movimiento", "Almacén destino" )
   oFr:SetResyncPair(   "Movimiento", "Agentes" )

Return nil



UTILITY STATIC function TRemMovAlm_VariableReport( oFr) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   oFr:DeleteCategory(  "Movimiento" )
   oFr:DeleteCategory(  "Lineas de movimientos" )





   oFr:AddVariable(     "Movimiento",              "Total movimiento",                  "GetHbVar('nTotMov')" )
   oFr:AddVariable(     "Movimiento",              "Tipo de movimiento formato texto",  "CallHbFunc('cTipoMovimiento')" )

   oFr:AddVariable(     "Lineas de movimientos",   "Detalle del artículo",              "CallHbFunc('cNombreArticuloMovimiento')" )
   oFr:AddVariable(     "Lineas de movimientos",   "Total unidades",                    "CallHbFunc('nUnidadesLineaMovimiento')" )
   oFr:AddVariable(     "Lineas de movimientos",   "Total linea movimiento",            "CallHbFunc('nImporteLineaMovimiento')" )

Return nil



UTILITY STATIC function TRemMovAlm_DesignReportRemMov( oFr, dbfDoc) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   if ::OpenFiles()

      private oThis        := Self
      public nTotMov       := ::nTotRemMov()





      ::DataReport( oFr )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "CabeceraColumnas",  "MainPage", 6 )
         oFr:SetProperty(     "CabeceraColumnas",  "Top", 200 )
         oFr:SetProperty(     "CabeceraColumnas",  "Height", 0 )
         oFr:SetProperty(     "CabeceraColumnas",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "CabeceraColumnas",  "DataSet", "Movimiento" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de movimientos" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      ::VariableReport( oFr )





      oFr:DesignReport()





      oFr:DestroyFr()





      ::CloseFiles()

   else

      Return .F.

   end

Return .T.



UTILITY STATIC function TRemMovAlm_PrintReportRemMov( nDevice, nCopies, cPrinter, dbfDoc) ; local Self AS CLASS TRemMovAlm := QSelf() AS CLASS TRemMovAlm

   local oFr

   IIF( nDevice == nil, nDevice := 2, ) ;
   IIF( nCopies == nil, nCopies := 1, ) ;
   IIF( cPrinter == nil, cPrinter := PrnGetName(), ) ;

   SysRefresh()

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





   ::DataReport( oFr )





   if !Empty( ( dbfDoc )->mReport )

      oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





      ::VariableReport( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2
            oFr:ShowPreparedReport()

         case nDevice == 1
            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:Print()

         case nDevice == 3
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:DoExport(     "PDFExport" )

      end

   end





   oFr:DestroyFr()

Return .T.



function cNombreArticuloMovimiento()

   local cNombre     := RetFld( oThis:oDetMovimientos:oDbf:cRefMov, oThis:oArt:cAlias, "Nombre" )

Return cNombre



function nUnidadesLineaMovimiento()

Return nTotNMovAlm( oThis:oDetMovimientos:oDbf )



function nImporteLineaMovimiento()

Return nTotLMovAlm( oThis:oDetMovimientos:oDbf )



function cTipoMovimiento()

   local cTipo    := ""

   do case
      case oThis:oDbf:nTipMov <= 1
         cTipo    := "Entre almacenes"
      case oThis:oDbf:nTipMov == 2
         cTipo    := "Regularización"
      case oThis:oDbf:nTipMov == 3
         cTipo    := "Regularización por objetivos"
      case oThis:oDbf:nTipMov == 4
         cTipo    := "Consolidación"
   end

Return cTipo




FUNCTION rxRemMov( cPath, oMeter )

   local dbfRemMovT

   IIF( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "REMMOVT.DBF" )

      CreateFiles( cPath )

   end

   fEraseIndex( cPath + "REMMOVT.CDX" )

   dbUseArea( .T., cDriver(), cPath + "REMMOVT.DBF", cCheckArea( "REMMOVT", @dbfRemMovT ), .F. )

   if !( dbfRemMovT )->( neterr() )
      ( dbfRemMovT )->( __dbPack() )

      ( dbfRemMovT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfRemMovT )->( ordCreate( cPath + "REMMOVT.CDX", "CNUMREM", "Str( NNUMREM ) + CSUFREM", {|| Str( Field->NNUMREM ) + Field->CSUFREM } ) )

      ( dbfRemMovT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfRemMovT )->( ordCreate( cPath + "REMMOVT.CDX", "DFECREM", "Dtos( DFECREM ) + CTIMREM", {|| Dtos( Field->DFECREM ) + Field->CTIMREM } ) )

      ( dbfRemMovT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de albaranes de clientes" )
   end

RETURN NIL



STATIC FUNCTION CreateFiles( cPath )

   if !lExistTable( cPath + "RemMovT.Dbf" )
      dbCreate( cPath + "RemMovT.Dbf", aSqlStruct( aItmRemMov() ), cDriver() )
   end

RETURN NIL



Function aItmRemMov()

   local aBase := {}

   aAdd( aBase, { "lSelDoc",   "L",   1,  0, "Lógico Seleccionado"  } )
   aAdd( aBase, { "nNumRem",   "N",   9,  0, "Número"               } )
   aAdd( aBase, { "cSufRem",   "C",   2,  0, "Sufijo"               } )
   aAdd( aBase, { "nTipMov",   "N",   1,  0, "Tipo del movimiento"  } )
   aAdd( aBase, { "cCodUsr",   "C",   3,  0, "Código usuario"       } )
   aAdd( aBase, { "cCodDlg",   "C",   2,  0, "Delegación"           } )
   aAdd( aBase, { "cCodAge",   "C",   3,  0, "Código agente"        } )
   aAdd( aBase, { "cCodMov",   "C",   2,  0, "Tipo de movimiento"   } )
   aAdd( aBase, { "dFecRem",   "D",   8,  0, "Fecha"                } )
   aAdd( aBase, { "cTimRem",   "C",   5,  0, "Hora"                 } )
   aAdd( aBase, { "cAlmOrg",   "C",   3,  0, "Alm. org."            } )
   aAdd( aBase, { "cAlmDes",   "C",   3,  0, "Alm. des."            } )
   aAdd( aBase, { "cCodDiv",   "C",   3,  0, "Div."                 } )
   aAdd( aBase, { "nVdvDiv",   "N",  13,  6, "Cambio de la divisa"  } )
   aAdd( aBase, { "cComMov",   "C", 100,  0, "Comentario"           } )

Return ( aBase )



FUNCTION IsRemMov( cPath )

   IIF( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "RemMovT.Dbf" )
      dbCreate( cPath + "RemMovT.Dbf", aSqlStruct( aItmRemMov() ), cDriver() )
   end

   if !lExistTable( cPath + "HisMov.Dbf" )
      dbCreate( cPath + "HisMov.Dbf", aSqlStruct( aItmMov() ), cDriver() )
   end

   if !lExistIndex( cPath + "RemMovT.Cdx" )
      rxRemMov( cPath )
   end

   if !lExistIndex( cPath + "HisMov.Cdx" )
      rxHisMov( cPath )
   end

Return ( .T. )



function nTotNRemMov( uDbf )

   local nTotUnd

   IIF( uDbf == nil, uDbf := dbfAlbCliL, ) ;

   do case
      case IsChar( uDbf )

         nTotUnd  := NotCaja( ( uDbf )->nCajMov )
         nTotUnd  *= ( uDbf )->nUndMov

      case IsObject( uDbf )

         nTotUnd  := NotCaja( uDbf:nCajMov )
         nTotUnd  *= uDbf:nUndMov

   end

RETURN ( nTotUnd )



STATIC FUNCTION LoaArt( cCodArt, aTmp, aGet, oSay )

   local lChgCodArt  := ( Empty( cOldCodArt ) .OR. Rtrim( cOldCodArt ) <> Rtrim( cCodArt ) )

   if Empty( cCodArt )
      MsgStop( "No se pueden añadir líneas sin codificar" )
      return .F.
   end





   if ( dbfArticulo )->( dbSeek( cCodArt ) ) .OR. ( dbfArticulo )->( dbSeek( Upper( cCodArt ) ) )

      if ( dbfArticulo )->lObs
         MsgStop( "Artículo catalogado como obsoleto" )
         return .F.
      end

      if ( lChgCodArt )

         aGet[ ( dbfTmpLin )->( FieldPos( "cRefMov" ) ) ]:cText( ( dbfArticulo )->Codigo )

         oSay[ 1 ]:cText( ( dbfArticulo )->Nombre )






         aTmp[ ( dbfTmpLin )->( FieldPos( "LLOTE" ) ) ]     := ( dbfArticulo )->lLote

         if ( dbfArticulo )->lLote
            oSay[2]:Show()
            aGet[ ( dbfTmpLin )->( FieldPos( "CLOTE" ) ) ]:Show()
            aGet[ ( dbfTmpLin )->( FieldPos( "CLOTE" ) ) ]:cText( ( dbfArticulo )->cLote )
         else
            if !Empty( oSay[2] ) .AND. !Empty( aGet[ ( dbfTmpLin )->( FieldPos( "CLOTE" ) ) ] )
               oSay[2]:Hide()
               aGet[ ( dbfTmpLin )->( FieldPos( "CLOTE" ) ) ]:Hide()
            end
         end





         aTmp[ ( dbfTmpLin )->( FieldPos( "CCODPR1" ) ) ]   := ( dbfArticulo )->cCodPrp1
         aTmp[ ( dbfTmpLin )->( FieldPos( "CCODPR2" ) ) ]   := ( dbfArticulo )->cCodPrp2

         if !Empty( aTmp[ ( dbfTmpLin )->( FieldPos( "CCODPR1" ) ) ] )

            if aGet[ ( dbfTmpLin )->( FieldPos( "CVALPR1" ) ) ] <> nil
               aGet[ ( dbfTmpLin )->( FieldPos( "CVALPR1" ) ) ]:Show()
               aGet[ ( dbfTmpLin )->( FieldPos( "CVALPR1" ) ) ]:SetFocus()
            end

            if oSay[3] <> nil
               oSay[3]:SetText( retProp( ( dbfArticulo )->cCodPrp1, dbfPro ) )
               oSay[3]:show()
            end

            if oSay[4] <> nil
               oSay[4]:SetText( "" )
               oSay[4]:Show()
            end

         else

            if !Empty( aGet[ ( dbfTmpLin )->( FieldPos( "CVALPR1" ) ) ] )
               aGet[ ( dbfTmpLin )->( FieldPos( "CVALPR1" ) ) ]:Hide()
            end

            if !Empty( oSay[3] )
               oSay[3]:Hide()
            end

            if !Empty( oSay[4] )
               oSay[4]:Hide()
            end

         end

         if !Empty( aTmp[ ( dbfTmpLin )->( FieldPos( "CCODPR2" ) ) ] )

            if aGet[ ( dbfTmpLin )->( FieldPos( "CVALPR2" ) ) ] <> nil
               aGet[ ( dbfTmpLin )->( FieldPos( "CVALPR2" ) ) ]:show()
            end

            if oSay[5] <> nil
               oSay[5]:SetText( retProp( ( dbfArticulo )->cCodPrp2, dbfPro ) )
               oSay[5]:show()
            end

            if oSay[6] <> nil
               oSay[6]:SetText( "" )
               oSay[6]:Show()
            end

         else

            if !Empty( aGet[ ( dbfTmpLin )->( FieldPos( "CVALPR2" ) ) ] )
               aGet[ ( dbfTmpLin )->( FieldPos( "CVALPR2" ) ) ]:Hide()
            end

            if !Empty( oSay[5] )
               oSay[5]:Hide()
            end

            if !Empty( oSay[6] )
               oSay[6]:Hide()
            end

         end

      end

      cOldCodArt     := cCodArt

   else

      MsgStop( "Artículo no encontrado" )
      Return ( .F. )

   end

RETURN ( .T. )



Static Function QuiHisMov()

   local nOrdAnt  := ( dbfHisMov )->( OrdSetFocus( "nNumRem" ) )





   while ( ( dbfHisMov )->( dbSeek( Str( ( dbfRemMov )->nNumRem ) + ( dbfRemMov  )->cSufRem ) ) .AND. !( dbfHisMov )->( eof() ) )

      if dbLock( dbfHisMov )
         ( dbfHisMov )->( dbDelete() )
         ( dbfHisMov )->( dbUnLock() )
      end

   end

   ( dbfHisMov )->( OrdSetFocus( nOrdAnt ) )

RETURN ( .T. )








_HB_CLASS SImportaAlmacen ; UTILITY FUNCTION SImportaAlmacen(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "SImportaAlmacen" , { HBObject():Classh } ) ) ;

   _HB_MEMBER {AS CHARACTER cCodigo} ; IIF( !.F., s_oClass:AddMultiData( "CHARACTER", "", nScope + IIF( .F., 32, 0 ), { "cCodigo" }, .F., .F. ), )
   _HB_MEMBER {AS CHARACTER cDescripcion} ; IIF( !.F., s_oClass:AddMultiData( "CHARACTER", "", nScope + IIF( .F., 32, 0 ), { "cDescripcion" }, .F., .F. ), )
   _HB_MEMBER {AS NUMERIC nEntrada} ; IIF( !.F., s_oClass:AddMultiData( "NUMERIC", 0, nScope + IIF( .F., 32, 0 ), { "nEntrada" }, .F., .F. ), )
   _HB_MEMBER {AS NUMERIC nSalida} ; IIF( !.F., s_oClass:AddMultiData( "NUMERIC", 0, nScope + IIF( .F., 32, 0 ), { "nSalida" }, .F., .F. ), )

   _HB_MEMBER SumaEntrada(n); IIF( .F., s_oClass:ModInline( "SumaEntrada", {|Self,n | Self, ( ::nEntrada   += n ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "SumaEntrada", {|Self,n | Self, ( ::nEntrada   += n ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER SumaSalida(n); IIF( .F., s_oClass:ModInline( "SumaSalida", {|Self,n | Self, ( ::nSalida    += n ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "SumaSalida", {|Self,n | Self, ( ::nSalida    += n ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER Saldo(); IIF( .F., s_oClass:ModInline( "Saldo", {|Self | Self, ( ::nEntrada - ::nSalida ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "Saldo", {|Self | Self, ( ::nEntrada - ::nSalida ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS SImportaAlmacen ;



Function SynRemMov( cPath )

   local oBlock
   local oError
   local dFecMov
   local dbfRemMov
   local dbfHisMov
   local nTotRem  := 0

   IIF( cPath == nil, cPath := cPatEmp(), ) ;

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPath + "REMMOVT.DBF" ), ( cCheckArea( "REMMOV", @dbfRemMov ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPath + "REMMOVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPath + "HISMOV.DBF" ), ( cCheckArea( "HISMOV", @dbfHisMov ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPath + "HISMOV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   while !( dbfRemMov )->( eof() )





      if ( dbfRemMov )->nTotRem == 0

         if dbSeekInOrd( Str( ( dbfRemMov )->nNumRem ) + ( dbfRemMov )->cSufRem, "NNUMREM", dbfHisMov )

            while Str( ( dbfRemMov )->nNumRem ) + ( dbfRemMov )->cSufRem == Str( ( dbfHisMov )->nNumRem ) + ( dbfHisMov )->cSufRem .AND. !( dbfHisMov )->( Eof() )

               nTotRem  += nTotLMovAlm( dbfHisMov )

               ( dbfHisMov )->( dbSkip() )

            end

         end

         if dbLock( dbfRemMov )
            ( dbfRemMov )->nTotRem        := nTotRem
            ( dbfRemMov )->( dbUnLock() )
         end

      end

      nTotRem  := 0

      ( dbfRemMov )->( dbSkip() )

   end

   ( dbfHisMov )->( ordSetFocus( "nNumRem" ) )

   ( dbfHisMov )->( dbGoTop() )
   while !( dbfHisMov )->( eof() )

      if Empty( ( dbfHisMov )->dFecMov )

         dFecMov                          := RetFld( Str( ( dbfHisMov )->nNumRem ) + ( dbfHisMov )->cSufRem, dbfRemMov, "dFecRem", "cNumRem" )

         if Empty( dFecMov )
            dFecMov                       := CtoD( "01/01/" + Str( Year( Date() ) ) )
         end

         if dbLock( dbfHisMov )
            ( dbfHisMov )->dFecMov        := dFecMov
            ( dbfHisMov )->( dbUnLock() )
         end

      end

      ( dbfHisMov )->( dbSkip() )

   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos de movimientos de almacén" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfRemMov )->( dbCloseArea() )
   ( dbfHisMov )->( dbCloseArea() )

return nil











_HB_CLASS TDetMovimientos ; UTILITY FUNCTION TDetMovimientos(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TDetMovimientos" , {TDet():classh} ) ) ; ;

   _HB_MEMBER { cOldCodArt} ; IIF( !.F., s_oClass:AddMultiData(, "", nScope + IIF( .F., 32, 0 ), { "cOldCodArt" }, .F., .F. ), )
   _HB_MEMBER { cOldLote} ; IIF( !.F., s_oClass:AddMultiData(, "", nScope + IIF( .F., 32, 0 ), { "cOldLote" }, .F., .F. ), )
   _HB_MEMBER { cOldValPr1} ; IIF( !.F., s_oClass:AddMultiData(, "", nScope + IIF( .F., 32, 0 ), { "cOldValPr1" }, .F., .F. ), )
   _HB_MEMBER { cOldValPr2} ; IIF( !.F., s_oClass:AddMultiData(, "", nScope + IIF( .F., 32, 0 ), { "cOldValPr2" }, .F., .F. ), )

   _HB_MEMBER { nStockActual} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nStockActual" }, .F., .F. ), )
   _HB_MEMBER { aStockActual} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "aStockActual" }, .F., .F. ), )

   _HB_MEMBER { oRefMov} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oRefMov" }, .F., .F. ), )
   _HB_MEMBER { oValPr1} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oValPr1" }, .F., .F. ), )
   _HB_MEMBER { oValPr2} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oValPr2" }, .F., .F. ), )
   _HB_MEMBER { oSayVp1} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSayVp1" }, .F., .F. ), )
   _HB_MEMBER { cSayVp1} ; IIF( !.F., s_oClass:AddMultiData(, "", nScope + IIF( .F., 32, 0 ), { "cSayVp1" }, .F., .F. ), )
   _HB_MEMBER { oSayVp2} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSayVp2" }, .F., .F. ), )
   _HB_MEMBER { cSayVp2} ; IIF( !.F., s_oClass:AddMultiData(, "", nScope + IIF( .F., 32, 0 ), { "cSayVp2" }, .F., .F. ), )
   _HB_MEMBER { oSayPr1} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSayPr1" }, .F., .F. ), )
   _HB_MEMBER { cSayPr1} ; IIF( !.F., s_oClass:AddMultiData(, "", nScope + IIF( .F., 32, 0 ), { "cSayPr1" }, .F., .F. ), )
   _HB_MEMBER { oSayPr2} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSayPr2" }, .F., .F. ), )
   _HB_MEMBER { cSayPr2} ; IIF( !.F., s_oClass:AddMultiData(, "", nScope + IIF( .F., 32, 0 ), { "cSayPr2" }, .F., .F. ), )
   _HB_MEMBER { oSayCaj} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSayCaj" }, .F., .F. ), )
   _HB_MEMBER { cSayCaj} ; IIF( !.F., s_oClass:AddMultiData(, "", nScope + IIF( .F., 32, 0 ), { "cSayCaj" }, .F., .F. ), )
   _HB_MEMBER { oSayUnd} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSayUnd" }, .F., .F. ), )
   _HB_MEMBER { cSayUnd} ; IIF( !.F., s_oClass:AddMultiData(, "", nScope + IIF( .F., 32, 0 ), { "cSayUnd" }, .F., .F. ), )
   _HB_MEMBER { oSayLote} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSayLote" }, .F., .F. ), )
   _HB_MEMBER { oGetLote} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetLote" }, .F., .F. ), )

   _HB_MEMBER { oCajMov} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oCajMov" }, .F., .F. ), )
   _HB_MEMBER { oUndMov} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oUndMov" }, .F., .F. ), )

   _HB_MEMBER { oGetStockOrigen} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetStockOrigen" }, .F., .F. ), )
   _HB_MEMBER { oGetStockDestino} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetStockDestino" }, .F., .F. ), )

   _HB_MEMBER { oGetAlmacenOrigen} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetAlmacenOrigen" }, .F., .F. ), )
   _HB_MEMBER { oGetAlmacenDestino} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetAlmacenDestino" }, .F., .F. ), )

   _HB_MEMBER { oTxtAlmacenOrigen} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oTxtAlmacenOrigen" }, .F., .F. ), )
   _HB_MEMBER { oTxtAlmacenDestino} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oTxtAlmacenDestino" }, .F., .F. ), )

   _HB_MEMBER { cTxtAlmacenOrigen} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cTxtAlmacenOrigen" }, .F., .F. ), )
   _HB_MEMBER { cTxtAlmacenDestino} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cTxtAlmacenDestino" }, .F., .F. ), )

   _HB_MEMBER { oPreDiv} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oPreDiv" }, .F., .F. ), )

   _HB_MEMBER { oBrwPrp} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBrwPrp" }, .F., .F. ), )
   _HB_MEMBER { oBrwStock} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBrwStock" }, .F., .F. ), )

   _HB_MEMBER { oBtnSerie} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBtnSerie" }, .F., .F. ), )

   _HB_MEMBER DefineFiles(); IIF( .F., s_oClass:ModMethod( "DefineFiles", @TDetMovimientos_DefineFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DefineFiles", @TDetMovimientos_DefineFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER OpenFiles( lExclusive); IIF( .F., s_oClass:ModMethod( "OpenFiles", @TDetMovimientos_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "OpenFiles", @TDetMovimientos_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER CloseFiles(); IIF( .F., s_oClass:ModMethod( "CloseFiles", @TDetMovimientos_CloseFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CloseFiles", @TDetMovimientos_CloseFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER OpenService(lExclusive); IIF( .F., s_oClass:ModMethod( "OpenService", @TDetMovimientos_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ) ), s_oClass:AddMethod( "OpenService", @TDetMovimientos_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ) ) );

   _HB_MEMBER Resource( nMode, lLiteral); IIF( .F., s_oClass:ModMethod( "Resource", @TDetMovimientos_Resource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Resource", @TDetMovimientos_Resource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER ValidResource( nMode, oDlg, oBtn); IIF( .F., s_oClass:ModMethod( "ValidResource", @TDetMovimientos_ValidResource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "ValidResource", @TDetMovimientos_ValidResource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER RollBack(); IIF( .F., s_oClass:ModMethod( "RollBack", @TDetMovimientos_RollBack(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "RollBack", @TDetMovimientos_RollBack(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER LoaArt( oGetDet, oDlg, lValidDetalle, nMode); IIF( .F., s_oClass:ModMethod( "LoaArt", @TDetMovimientos_LoaArt(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "LoaArt", @TDetMovimientos_LoaArt(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Save(); IIF( .F., s_oClass:ModMethod( "Save", @TDetMovimientos_Save(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Save", @TDetMovimientos_Save(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER Asigna(); IIF( .F., s_oClass:ModMethod( "Asigna", @TDetMovimientos_Asigna(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Asigna", @TDetMovimientos_Asigna(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER AppendKit(); IIF( .F., s_oClass:ModMethod( "AppendKit", @TDetMovimientos_AppendKit(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "AppendKit", @TDetMovimientos_AppendKit(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER ActualizaKit( nMode); IIF( .F., s_oClass:ModMethod( "ActualizaKit", @TDetMovimientos_ActualizaKit(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "ActualizaKit", @TDetMovimientos_ActualizaKit(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER nStockActualAlmacen( cCodAlm); IIF( .F., s_oClass:ModMethod( "nStockActualAlmacen", @TDetMovimientos_nStockActualAlmacen(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nStockActualAlmacen", @TDetMovimientos_nStockActualAlmacen(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER SetDlgMode( nMode); IIF( .F., s_oClass:ModMethod( "SetDlgMode", @TDetMovimientos_SetDlgMode(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SetDlgMode", @TDetMovimientos_SetDlgMode(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER aStkArticulo(); IIF( .F., s_oClass:ModMethod( "aStkArticulo", @TDetMovimientos_aStkArticulo(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "aStkArticulo", @TDetMovimientos_aStkArticulo(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER nTotRemVir( lPic); IIF( .F., s_oClass:ModMethod( "nTotRemVir", @TDetMovimientos_nTotRemVir(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nTotRemVir", @TDetMovimientos_nTotRemVir(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER nTotUnidadesVir( lPic); IIF( .F., s_oClass:ModMethod( "nTotUnidadesVir", @TDetMovimientos_nTotUnidadesVir(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nTotUnidadesVir", @TDetMovimientos_nTotUnidadesVir(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER nTotVolumenVir( lPic); IIF( .F., s_oClass:ModMethod( "nTotVolumenVir", @TDetMovimientos_nTotVolumenVir(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nTotVolumenVir", @TDetMovimientos_nTotVolumenVir(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER nTotPesoVir( lPic); IIF( .F., s_oClass:ModMethod( "nTotPesoVir", @TDetMovimientos_nTotPesoVir(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nTotPesoVir", @TDetMovimientos_nTotPesoVir(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TDetMovimientos ;



UTILITY STATIC function TDetMovimientos_DefineFiles( cPath, cVia, lUniqueName, cFileName) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local oDbf

   IIF( cPath == nil, cPath := ::cPath, ) ;
   IIF( lUniqueName == nil, lUniqueName := .F., ) ;
   IIF( cFileName == nil, cFileName := "HisMov", ) ;
   IIF( cVia == nil, cVia := cDriver(), ) ;

   if lUniqueName
      cFileName         := cGetNewFileName( cFileName, , , cPatTmp() )
   end

   oDbf := DbfServer( ( cFileName ), "HisMov" ):New( ( cFileName ), ( cFileName ), ( cVia ),, ( cPath ) )

      oDbf:AddField( "dFecMov", "D", 8, 0,,,,, "Fecha movimiento", .F.,, .F., {} )
      oDbf:AddField( "cTimMov", "C", 5, 0,,,,, "Hora movimiento", .F.,, .F., {} )
      oDbf:AddField( "nTipMov", "N", 1, 0,,,,, "Tipo movimiento", .F.,, .F., {} )
      oDbf:AddField( "cAliMov", "C", 3, 0,,,,, "Alm. ent.", .F.,, .F., {} )
      oDbf:AddField( "cAloMov", "C", 3, 0,,,,, "Alm. sal.", .F.,, .F., {} )
      oDbf:AddField( "cRefMov", "C", 18, 0,,,,, "Código", .F.,, .F., {} )
      oDbf:AddField( "cCodMov", "C", 2, 0,,,,, "TM", .F.,, .F., {} )
      oDbf:AddField( "cCodPr1", "C", 10, 0,,,,, "Cod. propiedad 1", .F.,, .F., {} )
      oDbf:AddField( "cCodPr2", "C", 10, 0,,,,, "Cod. propiedad 2", .F.,, .F., {} )
      oDbf:AddField( "cValPr1", "C", 10, 0,,,,, "Prp.1", .F.,, .F., {} )
      oDbf:AddField( "cValPr2", "C", 10, 0,,,,, "Prp.2", .F.,, .F., {} )
      oDbf:AddField( "cCodUsr", "C", 3, 0,,,,, "Código usuario", .F.,, .F., {} )
      oDbf:AddField( "cCodDlg", "C", 2, 0,,,,, "Código delegación", .F.,, .F., {} )
      oDbf:AddField( "lLote", "L", 1, 0,,,,, "Lógico lote", .F.,, .F., {} )
      oDbf:AddField( "nLote", "N", 9, 0,,,,, "Número de lote", .F.,, .F., {} )
      oDbf:AddField( "cLote", "C", 12, 0,,,,, "Lote", .F.,, .F., {} )
      oDbf:AddField( "nCajMov", "N", 19, 6, {|| MasUnd() },,,, "Caj.", .F.,, .F., {} )
      oDbf:AddField( "nUndMov", "N", 19, 6, {|| MasUnd() },,,, "Und.", .F.,, .F., {} )
      oDbf:AddField( "nCajAnt", "N", 19, 6,,,,, "Caj. ant.", .F.,, .F., {} )
      oDbf:AddField( "nUndAnt", "N", 19, 6,,,,, "Und. ant.", .F.,, .F., {} )
      oDbf:AddField( "nPreDiv", "N", 19, 6, {|| PicOut() },,,, "Precio", .F.,, .F., {} )
      oDbf:AddField( "lSndDoc", "L", 1, 0,,,,, "Lógico enviar", .F.,, .F., {} )
      oDbf:AddField( "nNumRem", "N", 9, 0,,,,, "Número remesa", .F.,, .F., {} )
      oDbf:AddField( "cSufRem", "C", 2, 0,,,,, "Sufijo remesa", .F.,, .F., {} )
      oDbf:AddField( "lSelDoc", "L", 1, 0,,,,, "Lógico selecionar", .F.,, .F., {} )
      oDbf:AddField( "lNoStk", "L", 1, 0,,,,, "Lógico no stock", .F.,, .F., {} )
      oDbf:AddField( "lKitArt", "L", 1, 0,,,,, "Línea con escandallo", .F.,, .F., {} )
      oDbf:AddField( "lKitEsc", "L", 1, 0,,,,, "Línea perteneciente a escandallo", .F.,, .F., {} )
      oDbf:AddField( "lImpLin", "L", 1, 0,,,,, "Lógico imprimir linea", .F.,, .F., {} )
      oDbf:AddField( "lKitPrc", "L", 1, 0,,,,, "Lógico precio escandallo", .F.,, .F., {} )
      oDbf:AddField( "nNumLin", "N", 4, 0,,,,, "Número de linea", .F.,, .F., {} )
      oDbf:AddField( "mNumSer", "M", 10, 0,,,,, "Numeros de serie", .F.,, .F., {} )
      oDbf:AddField( "nVolumen", "N", 16, 6,,,,, "Volumen del producto", .F.,, .F., {} )
      oDbf:AddField( "cVolumen", "C", 2, 0,,,,, "Unidad del volumen", .F.,, .F., {} )
      oDbf:AddField( "nPesoKg", "N", 16, 6,,,,, "Peso del producto", .F.,, .F., {} )
      oDbf:AddField( "cPesoKg", "C", 2, 0,,,,, "Unidad de peso del producto", .F.,, .F., {} )

      oDbf:AddIndex( "nNumRem", ( cFileName ), "Str( nNumRem ) + cSufRem",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "dFecMov", ( cFileName ), "Dtoc( dFecMov ) + cTimMov",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cRefMov", ( cFileName ), "cRefMov + cValPr1 + cValPr2 + cLote",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cAloMov", ( cFileName ), "cAloMov",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cAliMov", ( cFileName ), "cAliMov",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cRefAlm", ( cFileName ), "cRefMov + cValPr1 + cValPr2 + cAliMov",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cLote", ( cFileName ), "cLote",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "nNumLin", ( cFileName ), "Str( nNumLin )",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "lSndDoc", ( cFileName ), "lSndDoc", "lSndDoc",, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "nTipMov", ( cFileName ), "cRefMov + Dtos( dFecMov )", "nTipMov == 4",, .F., .F.,,,, .T., .F. )



RETURN ( oDbf )



UTILITY STATIC function TDetMovimientos_OpenFiles(lExclusive) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local lOpen             := .T.
   local oBlock

   IIF( lExclusive == nil, lExclusive := .F., ) ;

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::oDbf            := ::DefineFiles()
      end

      ::oDbf:Activate( .F., !lExclusive )

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos" )
      lOpen                := .F.

   end

   ErrorBlock( oBlock )

   if !lOpen
      ::CloseFiles()
   end

RETURN ( lOpen )



UTILITY STATIC function TDetMovimientos_CloseFiles() ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
      ::oDbf         := nil
   end

RETURN .T.






UTILITY STATIC function TDetMovimientos_Resource( nMode) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local oDlg
   local oBtn
   local oSayPre
   local oGetDet
   local cGetDet           := ""
   local nStockOrigen      := 0
   local nStockDestino     := 0
   local oTotUnd
   local cSayLote          := "Lote"
   local oBtnSer

   if nMode == 1
      ::oDbfVir:nUndMov    := 1
      ::oDbfVir:nNumLin    := nLastNum( ::oDbfVir:cAlias )
   end

   ::cOldCodArt            := ::oDbfVir:cRefMov
   ::cOldValPr1            := ::oDbfVir:cValPr1
   ::cOldValPr2            := ::oDbfVir:cValPr2
   ::cOldLote              := ::oDbfVir:cLote

   cGetDet                 := oRetFld( ::oDbfVir:cRefMov, ::oParent:oArt, "Nombre" )

   ::aStockActual          := { { "", "", "", "", "", 0, 0, 0 } }

   ::cTxtAlmacenOrigen     := oRetFld( ::oParent:oDbf:cAlmOrg, ::oParent:oAlm )
   ::cTxtAlmacenDestino    := oRetFld( ::oParent:oDbf:cAlmDes, ::oParent:oAlm )

   oDlg = TDialog():New(,,,, lblTitle( nMode ) + "lineas de movimientos de almacén", "LMovAlm",, .F.,,,,,, .F.,,,,,, .F., )





      ::oRefMov := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::oDbfVir:cRefMov, ::oDbfVir:cRefMov:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

      ::oRefMov:bValid     := {|| if( !Empty( ::oDbfVir:cRefMov ), ::LoaArt( oGetDet, oDlg, .F., nMode ), .T. ) }
      ::oRefMov:bHelp      := {|| BrwArticulo( ::oRefMov, oGetDet ) }




      oGetDet := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cGetDet, cGetDet:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      ::oBrwPrp := TWBrowse():ReDefine( 600, {|| { "" } }, oDlg, {""},,,,,,,,,,,,, .F.,,,,, )



      ::oSayLote := TSay():ReDefine( 154, {|| cSayLote}, oDlg,,,, .F.,, .F., .F. )




      ::oGetLote := TGetHlp():ReDefine( 155, { | u | If( PCount()==0, ::oDbfVir:cLote, ::oDbfVir:cLote:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      ::oGetLote:bValid    := {|| if( !Empty( ::oDbfVir:cLote ), ::LoaArt( oGetDet, oDlg, .F., nMode ), .T. ) }





      ::oValPr1 := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::oDbfVir:cValPr1, ::oDbfVir:cValPr1:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

      ::oValPr1:bValid     := {|| if( lPrpAct( ::oValPr1, ::oSayVp1, ::oDbfVir:cCodPr1, ::oParent:oTblPro:cAlias ), ::LoaArt( oGetDet, oDlg, .F., nMode ), .F. ) }
      ::oValPr1:bHelp      := {|| brwPrpAct( ::oValPr1, ::oSayVp1, ::oDbfVir:cCodPr1 ) }




      ::oSayVp1 := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, ::cSayVp1, ::cSayVp1:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      ::oSayPr1 := TSay():ReDefine( 122, {|| "Propiedad 1"}, oDlg,,,, .F.,, .F., .F. )





      ::oValPr2 := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::oDbfVir:cValPr2, ::oDbfVir:cValPr2:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

      ::oValPr2:bValid     := {|| if( lPrpAct( ::oValPr2, ::oSayVp2, ::oDbfVir:cCodPr2, ::oParent:oTblPro:cAlias ), ::LoaArt( oGetDet, oDlg, .F., nMode ), .F. ) }
      ::oValPr2:bHelp      := {|| brwPrpAct( ::oValPr2, ::oSayVp2, ::oDbfVir:cCodPr2 ) }




      ::oSayVp2 := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, ::cSayVp2, ::cSayVp2:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      ::oSayPr2 := TSay():ReDefine( 132, {|| "Propiedad 2"}, oDlg,,,, .F.,, .F., .F. )








      ::oCajMov := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::oDbfVir:nCajMov, ::oDbfVir:nCajMov:= u ) }, oDlg,, ::oParent:cPicUnd, {||    ( oTotUnd:Refresh(), oSayPre:Refresh(), .T. )},,,,,, .F., {||     ( lUseCaj() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( oTotUnd:Refresh(), oSayPre:Refresh() ) }, .F., .T.,,,,,, nil,,, )



      ::oSayCaj := TSay():ReDefine( 142, {|| cNombreCajas()}, oDlg,,,, .F.,, .F., .F. )








      ::oUndMov := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::oDbfVir:nUndMov, ::oDbfVir:nUndMov:= u ) }, oDlg,, ::oParent:cPicUnd, {||    ( oTotUnd:Refresh(), oSayPre:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oTotUnd:Refresh(), oSayPre:Refresh() ) }, .F., .T.,,,,,, nil,,, )



      ::oSayUnd := TSay():ReDefine( 152, {|| cNombreUnidades()}, oDlg,,,, .F.,, .F., .F. )




      oTotUnd := TSay():ReDefine( 160, {|| nTotNMovAlm( ::oDbfVir )}, oDlg, ::oParent:cPicUnd,,, .F.,, .F., .F. )








      ::oPreDiv := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, ::oDbfVir:nPreDiv, ::oDbfVir:nPreDiv:= u ) }, oDlg,, ::oParent:cPorDiv, {||    ( oSayPre:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oSayPre:Refresh() ) }, .F., .T.,,,,,, nil,,, )




      oSayPre := TSay():ReDefine( 190, {|| nTotLMovAlm( ::oDbfVir )}, oDlg, ::oParent:cPorDiv,,, .F.,, .F., .F. )








































































































      ::oGetAlmacenOrigen := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, ::oParent:oDbf:cAlmOrg, ::oParent:oDbf:cAlmOrg:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil, "Lupa", 403, )




      ::oTxtAlmacenOrigen := TGetHlp():ReDefine( 401, { | u | If( PCount()==0, ::cTxtAlmacenOrigen, ::cTxtAlmacenOrigen:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      ::oGetStockOrigen := TGetHlp():ReDefine( 402, { | u | If( PCount()==0, nStockOrigen, nStockOrigen:= u ) }, oDlg,, ::oParent:cPicUnd,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )









      ::oGetAlmacenDestino := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, ::oParent:oDbf:cAlmDes, ::oParent:oDbf:cAlmDes:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil, "Lupa",, )




      ::oTxtAlmacenDestino := TGetHlp():ReDefine( 411, { | u | If( PCount()==0, ::cTxtAlmacenDestino, ::cTxtAlmacenDestino:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      ::oGetStockDestino := TGetHlp():ReDefine( 412, { | u | If( PCount()==0, nStockDestino, nStockDestino:= u ) }, oDlg,, ::oParent:cPicUnd,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )









      TGetHlp():ReDefine( 200, { | u | If( PCount()==0, ::oDbfVir:nPesoKg, ::oDbfVir:nPesoKg:= u ) }, oDlg,, "@E 999.99",,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::oDbfVir:cPesoKg, ::oDbfVir:cPesoKg:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 220, { | u | If( PCount()==0, ::oDbfVir:nVolumen, ::oDbfVir:nVolumen:= u ) }, oDlg,, "@E 999.99",,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 230, { | u | If( PCount()==0, ::oDbfVir:cVolumen, ::oDbfVir:cVolumen:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      ::oBtnSerie := TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F.,,,, .F. )

      ::oBtnSerie:bAction     := {|| ::oParent:oDetSeriesMovimientos:Resource( nMode ) }





      oBtn := TButton():ReDefine( 510, {||(  ::ValidResource( nMode, oDlg, oBtn ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 520, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

      if nMode <> 3
         oDlg:AddFastKey( 117, {|| ::oBtnSerie:Click() } )
         oDlg:AddFastKey( 116, {|| ::ValidResource( nMode, oDlg, oBtn ) } )
      end

      oDlg:bStart             := {|| ::SetDlgMode( nMode  ) }

   oDlg:Activate( , , , .T., , , {|| EdtDetMenu( Self, oDlg ) } )





   if ( oDlg:nResult == 1 )
      ::oDbfVir:lSelDoc       := .T.
   end

   EndEdtDetMenu()

RETURN ( oDlg:nResult )



Static Function EdtDetMenu( oThis, oDlg )

   oMenu := MenuBegin( .F.,,, .F., .F. )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F. )

         MenuBegin( .F.,,, .F., .F. )





            MenuAddItem( "&1. Modificar de artículo", "Modificar la ficha del artículo", .F.,, {|oMenuItem|( EdtArticulo( oThis:oRefMov:VarGet() ) )},, "Cube_Yellow_16",,,,, .F.,,, .F. )




            MenuAddItem( "&2. Informe de artículo", "Abrir el informe del artículo", .F.,, {|oMenuItem|( InfArticulo( oThis:oRefMov:VarGet() ) )},, "Info16",,,,, .F.,,, .F. )
         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMenu )

Return ( oMenu )



Static Function EndEdtDetMenu()

Return( oMenu:End() )



UTILITY STATIC function TDetMovimientos_ValidResource( nMode, oDlg, oBtn) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local n
   local i
   local cLote
   local lProp       := .F.
   local lFound
   local cRefMov
   local nCajMov
   local nUndMov
   local cCodPr1
   local cCodPr2
   local cValPr1
   local cValPr2
   local nStkAct     := 0
   local nTotUnd     := 0
   local dFecMov
   local cTimMov
   local nTipMov
   local cAliMov
   local cAloMov
   local cCodMov
   local lNowSer
   local lNumSer

   oBtn:SetFocus()

   if nMode == 1 .AND. !::LoaArt( nil, nil, .T., nMode )
      ::oRefMov:SetFocus()
      Return .F.
   end

   if Empty( ::oDbfVir:cRefMov )
      MsgStop( "Código de artículo vacío." )
      ::oRefMov:SetFocus()
      Return .F.
   end





   lNumSer           := RetFld( ::oDbfVir:cRefMov, ::oParent:oArt:cAlias, "lNumSer" )
   lNowSer           := ::oParent:oDetSeriesMovimientos:oDbfVir:SeekInOrd( Str( ::oDbfVir:nNumLin, 4 ) + ::oDbfVir:cRefMov, "nNumLin" )




   if ( nMode == 1 )                                            .AND. ( lNumSer )                                                       .AND. (!lNowSer )                                                       .AND. ( ::oParent:oDbf:nTipMov <> 3 )

      MsgStop( "Tiene que introducir números de serie para este artículo." )

      ::oBtnSerie:Click()

      Return .F.

   end

   CursorWait()

   lFound            := .F.

   do case
   case ( nMode == 1 .AND. !lNumSer )

      cRefMov        := ::oDbfVir:cRefMov
      nCajMov        := ::oDbfVir:nCajMov
      nUndMov        := ::oDbfVir:nUndMov
      cLote          := ::oDbfVir:cLote
      cCodPr1        := ::oDbfVir:cCodPr1
      cCodPr2        := ::oDbfVir:cCodPr2
      cValPr1        := ::oDbfVir:cValPr1
      cValPr2        := ::oDbfVir:cValPr2

      ::oDbfVir:GetStatus()

      ::oDbfVir:GoTop()
      while !::oDbfVir:Eof()








         if !( lNowSer )                                    .AND.  ::oDbfVir:FieldGetName( "cRefMov" ) == cRefMov  .AND.  ::oDbfVir:FieldGetName( "cLote"   ) == cLote    .AND.  ::oDbfVir:FieldGetName( "cCodPr1" ) == cCodPr1  .AND.  ::oDbfVir:FieldGetName( "cCodPr2" ) == cCodPr2  .AND.  ::oDbfVir:FieldGetName( "cValPr1" ) == cValPr1  .AND.  ::oDbfVir:FieldGetName( "cValPr2" ) == cValPr2  .AND.  ::oDbfVir:FieldGetName( "nCajMov" ) == nCajMov

            nCajMov  += ::oDbfVir:FieldGetName( "nCajMov" )
            nUndMov  += ::oDbfVir:FieldGetName( "nUndMov" )

            ::oDbfVir:FieldPutByName( "nCajMov", nCajMov )
            ::oDbfVir:FieldPutByName( "nUndMov", nUndMov )

            if ::oDbfVir:FieldGetName( "lKitArt" )
               ::ActualizaKit( nMode )
            end

            lFound   := .T.

            exit

         end

         ::oDbfVir:Skip()

      end

      ::oDbfVir:SetStatus()

   case nMode == 2

      ::ActualizaKit( nMode )

   end






   if ( ::oDbf:nTipMov == 1 )

      nTotUnd        := nTotNRemMov( ::oDbfVir )
      nStkAct        := ::nStockActualAlmacen( ::oParent:oDbf:cAlmOrg )

      if nTotUnd <> 0 .AND. oRetFld( ::oDbfVir:cRefMov, ::oParent:oArt, "lMsgMov" )

         if ( nStkAct - nTotUnd ) < oRetFld( ::oDbfVir:cRefMov, ::oParent:oArt, "nMinimo" )

            if !ApoloMsgNoYes( "El stock está por debajo del minimo.", "¿Desea continuar?" )
               return nil
            end

         end

      end

   end





   if !Empty( ::oBrwPrp:Cargo )





      dFecMov  := ::oDbfVir:dFecMov
      cTimMov  := ::oDbfVir:cTimMov
      nTipMov  := ::oDbfVir:nTipMov
      cAliMov  := ::oDbfVir:cAliMov
      cAloMov  := ::oDbfVir:cAloMov
      cCodMov  := ::oDbfVir:cCodMov
      cRefMov  := ::oDbfVir:cRefMov





      for n := 1 to len( ::oBrwPrp:Cargo )

         for i := 1 to len( ::oBrwPrp:Cargo[ n ] )

            if IsNum( ::oBrwPrp:Cargo[ n, i ]:Value ) .AND. ::oBrwPrp:Cargo[ n, i ]:Value <> 0

               ::oDbfVir:Append()

               ::oDbfVir:dFecMov    := dFecMov
               ::oDbfVir:cTimMov    := cTimMov
               ::oDbfVir:nTipMov    := nTipMov
               ::oDbfVir:cAliMov    := cAliMov
               ::oDbfVir:cAloMov    := cAloMov
               ::oDbfVir:cCodMov    := cCodMov
               ::oDbfVir:cRefMov    := cRefMov
               ::oDbfVir:cCodPr1    := ::oBrwPrp:Cargo[ n, i ]:cCodigoPropiedad1
               ::oDbfVir:cCodPr2    := ::oBrwPrp:Cargo[ n, i ]:cCodigoPropiedad2
               ::oDbfVir:cValPr1    := ::oBrwPrp:Cargo[ n, i ]:cValorPropiedad1
               ::oDbfVir:cValPr2    := ::oBrwPrp:Cargo[ n, i ]:cValorPropiedad2
               ::oDbfVir:cCodUsr    := cCurUsr()
               ::oDbfVir:cCodDlg    := oRetFld( cCurUsr(), ::oParent:oUsr, "cCodDlg" )
               ::oDbfVir:nCajMov    := 1
               ::oDbfVir:nUndMov    := ::oBrwPrp:Cargo[ n, i ]:Value
               ::oDbfVir:nPreDiv    := ::oBrwPrp:Cargo[ n, i ]:nPrecioCompra
               ::oDbfVir:lSndDoc    := .T.
               ::oDbfVir:nNumLin    := nLastNum( ::oDbfVir:cAlias )
               ::oDbfVir:nVolumen   := oRetFld( cRefMov, ::oParent:oArt, "" )
               ::oDbfVir:cVolumen   := oRetFld( cRefMov, ::oParent:oArt, "" )
               ::oDbfVir:nPesoKg    := oRetFld( cRefMov, ::oParent:oArt, "" )
               ::oDbfVir:cPesoKg    := oRetFld( cRefMov, ::oParent:oArt, "" )

               ::oDbfVir:Save()

            end

         next

      next

      lProp       := .T.

   end

   ::cOldCodArt   := ""
   ::cOldValPr1   := ""
   ::cOldValPr2   := ""
   ::cOldLote     := ""

   CursorWE()

   if lProp
      oDlg:end( 2 )
   else
      if lFound
         oDlg:end( 3 )
      else
         oDlg:end( 1 )
      end
   end

RETURN ( .T. )



UTILITY STATIC function TDetMovimientos_RollBack() ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   ::oParent:GetFirstKey()

   if ::oParent:cFirstKey <> nil

      while ::oDbf:Seek( ::oParent:cFirstKey )

         ::oDbf:Delete()

         if !Empty( ::oParent ) .AND. !Empty( ::oParent:oMeter )
            ::oParent:oMeter:AutoInc()
         end

      end

   end

Return .T.



UTILITY STATIC function TDetMovimientos_LoaArt( oGetDet, oDlg, lValidDetalle, nMode) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local a
   local nPos
   local nPreMed
   local cValPr1           := ""
   local cValPr2           := ""
   local cCodArt           := ::oDbfVir:cRefMov
   local lChgCodArt        := ( Empty( ::cOldCodArt ) .OR. Rtrim( ::cOldCodArt ) <> Rtrim( cCodArt ) .OR. ::cOldLote <> ::oDbfVir:cLote .OR. ::cOldValPr1 <> ::oDbfVir:cValPr1 .OR. ::cOldValPr2 <> ::oDbfVir:cValPr2 )

   IIF( lValidDetalle == nil, lValidDetalle := .F., ) ;

   if Empty( cCodArt )

      if !Empty( ::oBrwPrp )
         ::oBrwPrp:Hide()
      end

      Return .T.

   end





   cCodArt                 := cSeekCodebar( cCodArt, ::oParent:oDbfBar:cAlias, ::oParent:oArt:cAlias )





   if ( ::oParent:oDbf:nTipMov == 3 ) .AND. ( RetFld( cCodArt, ::oParent:oArt:cAlias, "lNumSer" ) )

      MsgStop( "Artículos con números de serie no pueden incluirse regularizaciones por objetivo." )

      Return .F.

   end





   if aSeekProp( @cCodArt, @cValPr1, @cValPr2, ::oParent:oArt:cAlias, ::oParent:oTblPro:cAlias )

      if !lValidDetalle

         CursorWait()

         if ( lChgCodArt )

            ::oRefMov:cText( ::oParent:oArt:Codigo )





            oGetDet:cText( ::oParent:oArt:Nombre )





            if !Empty( cValPr1 )
               ::oValPr1:cText( cValPr1 )
            end

            if !Empty( cValPr2 )
               ::oValPr2:cText( cValPr2 )
            end





            if ::oParent:oArt:lKitArt
               ::oDbfVir:lNoStk     := !lStockCompuestos( ::oParent:oArt:Codigo, ::oParent:oArt:cAlias )
               ::oDbfVir:lKitArt    := .T.
               ::oDbfVir:lKitEsc    := .F.
               ::oDbfVir:lImpLin    := lImprimirCompuesto( ::oParent:oArt:Codigo, ::oParent:oArt:cAlias )
               ::oDbfVir:lKitPrc    := !lPreciosCompuestos( ::oParent:oArt:Codigo, ::oParent:oArt:cAlias )
            else
               ::oDbfVir:lNoStk     := ( ::oParent:oArt:nCtlStock > 1 )
               ::oDbfVir:lKitArt    := .F.
               ::oDbfVir:lKitEsc    := .F.
               ::oDbfVir:lImpLin    := .F.
               ::oDbfVir:lKitPrc    := .F.
            end

            if ::oParent:oArt:nCajEnt <> 0 .AND. ::oDbfVir:nCajMov == 0
               ::oCajMov:cText( ::oParent:oArt:nCajEnt )
            end

            if ::oParent:oArt:nUniCaja <> 0 .AND. ::oDbfVir:nUndMov == 0
               ::oUndMov:cText( ::oParent:oArt:nUniCaja )
            end





            ::oDbfVir:nVolumen      := ::oParent:oArt:nVolumen
            ::oDbfVir:cVolumen      := ::oParent:oArt:cVolumen
            ::oDbfVir:nPesoKg       := ::oParent:oArt:nPesoKg
            ::oDbfVir:cPesoKg       := ::oParent:oArt:cUndDim





            ::oDbfVir:lLote         := ::oParent:oArt:lLote

            if ::oParent:oArt:lLote
               ::oSayLote:Show()
               ::oGetLote:Show()
            else
               ::oSayLote:Hide()
               ::oGetLote:Hide()
            end





            ::oDbfVir:cCodPr1       := ::oParent:oArt:cCodPrp1
            ::oDbfVir:cCodPr2       := ::oParent:oArt:cCodPrp2




            if ( !Empty( ::oDbfVir:cCodPr1 ) .OR. !Empty( ::oDbfVir:cCodPr2 ) )  .AND. ( Empty( ::oDbfVir:cValPr1 ) .OR. Empty( ::oDbfVir:cValPr2 ) )    .AND. ( uFieldEmpresa( "lUseTbl" )                                      .AND. ( nMode == 1 ) )

               ::oBrwPrp:Show()
               ::oValPr1:Hide()
               ::oSayPr1:Hide()
               ::oSayVp1:Hide()
               ::oValPr2:Hide()
               ::oSayPr2:Hide()
               ::oSayVp2:Hide()
               ::oSayLote:Hide()
               ::oGetLote:Hide()

               LoadPropertiesTable( ::oParent:oArt:Codigo, 0, ::oDbfVir:cCodPr1, ::oDbfVir:cCodPr2, ::oParent:oPro:cAlias, ::oParent:oTblPro:cAlias, ::oParent:oArtCom:cAlias, ::oBrwPrp, ::oUndMov, ::oPreDiv )

            else

               if !Empty( ::oDbfVir:cCodPr1 )
                  ::oValPr1:show()
                  ::oSayPr1:show()
                  ::oSayPr1:setText( retProp( ::oDbfVir:cCodPr1 ) )
                  ::oSayVp1:show()
               else
                  ::oValPr1:Hide()
                  ::oSayPr1:Hide()
                  ::oSayVp1:Hide()
               end

               if !Empty( ::oDbfVir:cCodPr2 )
                  ::oValPr2:show()
                  ::oSayPr2:show()
                  ::oSayPr2:setText( retProp( ::oDbfVir:cCodPr2 ) )
                  ::oSayVp2:show()
               else
                  ::oValPr2:Hide()
                  ::oSayPr2:Hide()
                  ::oSayVp2:Hide()
               end





               do case
                  case !Empty( ::oDbfVir:cCodPr1 ) .AND. Empty( ::oDbfVir:cValPr1 )
                     ::oValPr1:SetFocus()

                  case !Empty( ::oDbfVir:cCodPr2 ) .AND. Empty( ::oDbfVir:cValPr2 )
                     ::oValPr2:SetFocus()

                  otherwise
                     ::oUndMov:SetFocus()

               end

            end





            if !uFieldEmpresa( "lCosAct" )

               nPreMed     := ::oParent:oStock:nPrecioMedioCompra( ::oParent:oArt:Codigo, ::oParent:oDbf:cAlmDes, nil, GetSysDate() )

               if nPreMed == 0
                  nPreMed  := nCosto( ::oParent:oArt:Codigo, ::oParent:oArt:cAlias, ::oParent:oArtKit:cAlias )
               end

            else

               nPreMed     := nCosto( ::oParent:oArt:Codigo, ::oParent:oArt:cAlias, ::oParent:oArtKit:cAlias )

            end

            ::oPreDiv:cText( nPreMed )







            ::oParent:oStock:lPutStockActual( ::oDbfVir:cRefMov, ::oParent:oDbf:cAlmOrg, ::oDbfVir:cValPr1, ::oDbfVir:cValPr2, ::oDbfVir:cLote, .F., ::oParent:oArt:nCtlStock, ::oGetStockOrigen )

            ::oParent:oStock:lPutStockActual( ::oDbfVir:cRefMov, ::oParent:oDbf:cAlmDes, ::oDbfVir:cValPr1, ::oDbfVir:cValPr2, ::oDbfVir:cLote, .F., ::oParent:oArt:nCtlStock, ::oGetStockDestino )





            SysRefresh()

            nPos                 := aScan( ::oParent:oStock:aStocks, {|o| o:cCodigo == ::oParent:oArt:Codigo .AND. o:cCodigoAlmacen == ::oParent:oDbf:cAlmDes .AND. o:cValorPropiedad1 == ::oDbfVir:cValPr1 .AND. o:cValorPropiedad2 == ::oDbfVir:cValPr2 .AND. o:cLote == ::oDbfVir:cLote .AND. o:cNumeroSerie == ::oDbfVir:mNumSer } )
            if ( nPos <> 0 ) .AND. IsNum( ::oParent:oStock:aStocks[ nPos ]:nUnidades )
               ::oDbfVir:nUndAnt := ::oParent:oStock:aStocks[ nPos ]:nUnidades
            end

         end

         ::cOldCodArt            := cCodArt

         CursorWE()

      end

   else

      if !lValidDetalle
         MsgStop( "Artículo no encontrado." )
      end

      Return .F.

   end

Return .T.



UTILITY STATIC function TDetMovimientos_nStockActualAlmacen( cCodAlm) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local aStock      := {}
   local nTotStock   := 0

   for each aStock in ::aStockActual

      if aStock[1] == cCodAlm
         nTotStock   += aStock[6]
      end

   next

RETURN nTotStock



UTILITY STATIC function TDetMovimientos_SetDlgMode( nMode) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   ::oBrwPrp:Hide()

   if ( ::oParent:oDbf:nTipMov == 3 )
      ::oBtnSerie:Hide()
   end

   if nMode == 1

      ::oSayLote:Hide()
      ::oGetLote:Hide()

      ::oValPr1:Hide()
      ::oSayPr1:Hide()
      ::oSayVp1:Hide()

      ::oValPr2:Hide()
      ::oSayPr2:Hide()
      ::oSayVp2:Hide()

      if !lUseCaj()
         ::oCajMov:Hide()
         ::oSayCaj:Hide()
      end

   else

      if ::oDbfVir:lLote
         ::oGetLote:Show()
         ::oSayLote:Show()
      else
         ::oGetLote:Hide()
         ::oSayLote:Hide()
      end

      if !Empty( ::oDbfVir:cValPr1 )
         ::oSayPr1:Show()
         ::oSayVp1:Show()
         ::oValPr1:Show()
         ::oSayPr1:SetText( retProp( ::oDbfVir:cCodPr1 ) )
         lPrpAct( ::oDbfVir:cValPr1, ::oSayVp1, ::oDbfVir:cCodPr1, ::oParent:oTblPro:cAlias )
      else
         ::oValPr1:Hide()
         ::oSayPr1:Hide()
         ::oSayVp1:Hide()
      end

      if !Empty( ::oDbfVir:cValPr2 )
         ::oSayPr2:Show()
         ::oSayVp2:Show()
         ::oValPr2:Show()
         ::oSayPr2:SetText( retProp( ::oDbfVir:cCodPr2 ) )
         lPrpAct( ::oDbfVir:cValPr2, ::oSayVp2, ::oDbfVir:cCodPr2, ::oParent:oTblPro:cAlias )
      else
         ::oValPr2:Hide()
         ::oSayPr2:Hide()
         ::oSayVp2:Hide()
      end

      if !lUseCaj()
         ::oCajMov:Hide()
         ::oSayCaj:Hide()
         ::oSayUnd:SetText( "Unidades" )
      end

   end





   if Empty( ::oParent:oDbf:cAlmOrg )
      ::oGetAlmacenOrigen:Hide()
      ::oTxtAlmacenOrigen:Hide()
      ::oGetStockOrigen:Hide()
   end

RETURN ( Self )



UTILITY STATIC function TDetMovimientos_AppendKit() ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local nRec     := ::oDbfVir:Recno()
   local nNumLin  := ::oDbfVir:nNumLin
   local cCodArt  := ::oDbfVir:cRefMov
   local nTipMov  := ::oDbfVir:nTipMov
   local cAliMov  := ::oParent:oDbf:cAlmDes
   local cAloMov  := ::oParent:oDbf:cAlmOrg
   local cCodMov  := ::oDbfVir:cCodMov
   local nCajMov  := ::oDbfVir:nCajMov
   local nUndMov  := ::oDbfVir:nUndMov
   local nNumRem  := ::oDbfVir:nNumRem
   local cSufRem  := ::oDbfVir:cSufRem
   local cCodUsr  := ::oDbfVir:cCodUsr
   local cCodDlg  := ::oDbfVir:cCodDlg
   local nTotUnd  := 0
   local nStkAct  := 0
   local nMinimo  := 0

   if ::oParent:oArtKit:SeekInOrd( cCodArt, "cCodKit" )

      while ( ::oParent:oArtKit:cCodKit == cCodArt ) .AND. !( ::oParent:oArtKit:Eof() )

         if ::oParent:oArt:SeekInOrd( ::oParent:oArtKit:cRefKit, "Codigo" ) .AND. lStockComponentes( cCodArt, ::oParent:oArt:cAlias )

            nStkAct              := ::oParent:oStock:nStockAlmacen( ::oParent:oArtKit:cRefKit, cAloMov )

            ::oDbfVir:Append()

            ::oDbfVir:dFecMov    := GetSysDate()
            ::oDbfVir:cTimMov    := Time()
            ::oDbfVir:nTipMov    := nTipMov
            ::oDbfVir:cAliMov    := cAliMov
            ::oDbfVir:cAloMov    := cAloMov
            ::oDbfVir:cRefMov    := ::oParent:oArtKit:cRefKit
            ::oDbfVir:cCodMov    := cCodMov
            ::oDbfVir:cCodPr1    := Space( 10 )
            ::oDbfVir:cCodPr2    := Space( 10 )
            ::oDbfVir:cValPr1    := Space( 10 )
            ::oDbfVir:cValPr2    := Space( 10 )
            ::oDbfVir:cCodUsr    := cCodUsr
            ::oDbfVir:cCodDlg    := cCodDlg
            ::oDbfVir:lLote      := ::oParent:oArt:lLote
            ::oDbfVir:nLote      := ::oParent:oArt:nLote
            ::oDbfVir:cLote      := ::oParent:oArt:cLote
            ::oDbfVir:nCajMov    := nCajMov
            ::oDbfVir:nUndMov    := ::oParent:oArtKit:nUndKit * nUndMov

            if nTipMov == 3
               ::oDbfVir:nCajAnt := 0
               ::oDbfVir:nUndAnt := nStkAct
            end

            ::oDbfVir:nPreDiv    := ::oParent:oArt:pCosto
            ::oDbfVir:lSndDoc    := .T.
            ::oDbfVir:nNumRem    := nNumRem
            ::oDbfVir:cSufRem    := cSufRem
            ::oDbfVir:lSelDoc    := .T.

            ::oDbfVir:lKitArt    := .F.
            ::oDbfVir:lNoStk     := .F.
            ::oDbfVir:lImpLin    := lImprimirComponente( cCodArt, ::oParent:oArt:cAlias )
            ::oDbfVir:lKitPrc    := !lPreciosComponentes( cCodArt, ::oParent:oArt:cAlias )

            if lKitAsociado( cCodArt, ::oParent:oArt:cAlias )
               ::oDbfVir:nNumLin := nLastNum( ::oDbfVir:cAlias )
               ::oDbfVir:lKitEsc := .F.
            else
               ::oDbfVir:nNumLin := nNumLin
               ::oDbfVir:lKitEsc := .T.
            end





            nTotUnd              := NotCaja( ::oDbfVir:nCajMov ) * ::oDbfVir:nUndMov
            nMinimo              := oRetFld( ::oDbfVir:cRefMov, ::oParent:oArt, "nMinimo" )

            if nTotUnd <> 0 .AND. oRetFld( ::oDbfVir:cRefMov, ::oParent:oArt, "lMsgMov" )

               if ( ( nStkAct - nTotUnd ) < nMinimo )






                  MsgStop( "El stock del componente " + AllTrim( ::oDbfVir:cRefMov ) + " - " + AllTrim( oRetFld( ::oDbfVir:cRefMov, ::oParent:oArt, "Nombre" ) ) + Chr(13)+Chr(10) +  "está bajo minimo." + Chr(13)+Chr(10) +  "Unidades a vender : " + AllTrim( Trans( nTotUnd, MasUnd() ) ) + Chr(13)+Chr(10) +  "Stock actual : " + AllTrim( Trans( nStkAct, MasUnd() ) )      + Chr(13)+Chr(10) +  "Stock minimo : " + AllTrim( Trans( nMinimo, MasUnd() ) ), "¡Atención!" )

               end

            end

            ::oDbfVir:Save()

         end

         ::oParent:oArtKit:Skip()

      end

   end





   ::oDbfVir:GoTo( nRec )

   ::oParent:oBrwDet:Refresh()

RETURN ( Self )



UTILITY STATIC function TDetMovimientos_aStkArticulo() ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   ::nStockActual       := 0

   if !Empty( ::oDbfVir:cRefMov ) .AND. oRetFld( ::oDbfVir:cRefMov, ::oParent:oArt, "nCtlStock" ) <= 1

      ::oParent:oStock:aStockArticulo( ::oDbfVir:cRefMov, , ::oBrwStock )

      aEval( ::oBrwStock:aArrayData, {|o| ::nStockActual += o:nUnidades } )

      ::oBrwStock:Show()

   else

      ::oBrwStock:Hide()

   end

RETURN ( Self )



UTILITY STATIC function TDetMovimientos_ActualizaKit( nMode) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local nRec     := ::oDbfVir:Recno()
   local nOrdAnt  := ::oDbfVir:OrdSetFocus( "nNumLin" )
   local cRefMov  := ::oDbfVir:cRefMov
   local nNumLin  := ::oDbfVir:FieldGetName( "nNumLin" )
   local nCajMov
   local nUndMov

   do case
      case nMode == 1
         nCajMov  := ::oDbfVir:FieldGetName( "nCajMov" )
         nUndMov  := ::oDbfVir:FieldGetName( "nUndMov" )

      case nMode == 2
         nCajMov  := ::oDbfVir:nCajMov
         nUndMov  := ::oDbfVir:nUndMov

   end

   ::oDbfVir:GoTop()

   while !::oDbfVir:Eof()



      if ::oDbfVir:FieldGetName( "nNumLin" ) == nNumLin        .AND. ::oDbfVir:FieldGetName( "lKitEsc" )                   .AND. ::oParent:oArtKit:SeekInOrd( cRefMov + ::oDbfVir:FieldGetName( "cRefMov" ), "cCodRef" )

         ::oDbfVir:FieldPutByName( "nCajMov", nCajMov )
         ::oDbfVir:FieldPutByName( "nUndMov", ( nUndMov * ::oParent:oArtKit:nUndKit ) )

      end

      ::oDbfVir:Skip()

   end

   ::oDbfVir:OrdSetFocus( nOrdAnt )

   ::oDbfVir:GoTo( nRec )

RETURN ( Self )



UTILITY STATIC function TDetMovimientos_Save() ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local nSec





   CursorWait()

   ::oDbfVir:KillFilter()

   ::oDbfVir:GetStatus()
   ::oDbfVir:OrdSetFocus( 0 )

   do case
   case ::oParent:oDbf:nTipMov == 1

      ::oDbfVir:GoTop()
      while !::oDbfVir:Eof()

         ::oDbfVir:Load()
         ::Asigna()
         ::oDbfVir:Save()

         ::oDbf:AppendFromObject( ::oDbfVir )

         ::oDbfVir:Skip()

         ::oParent:oMeter:AutoInc()

      end

   case ::oParent:oDbf:nTipMov == 2

      ::oDbfVir:GoTop()
      while !::oDbfVir:Eof()

         ::oDbfVir:Load()
         ::Asigna()
         ::oDbfVir:Save()

         ::oDbf:AppendFromObject( ::oDbfVir )

         ::oDbfVir:Skip()

         ::oParent:oMeter:AutoInc()

      end

   case ::oParent:oDbf:nTipMov == 3

      ::oDbfVir:GoTop()
      while !::oDbfVir:Eof()

         if ::oDbfVir:lSelDoc

            ::oDbfVir:Load()
            ::Asigna()

            ::oDbfVir:lSelDoc := .F.
            ::oDbfVir:nUndMov := ( nTotNMovAlm( ::oDbfVir ) - nTotNMovOld( ::oDbfVir ) ) / NotCero( ::oDbfVir:nCajMov )
            ::oDbfVir:nUndAnt := 0
            ::oDbfVir:nCajAnt := 0

            ::oDbfVir:Save()

            ::oDbf:AppendFromObject( ::oDbfVir )

         else

            ::oDbfVir:Load()
            ::Asigna()
            ::oDbfVir:Save()

            ::oDbf:AppendFromObject( ::oDbfVir )

         end

         ::oDbfVir:Skip()

         ::oParent:oMeter:AutoInc()

      end

   case ::oParent:oDbf:nTipMov == 4

      ::oDbfVir:GoTop()
      while !::oDbfVir:Eof()

         ::Asigna()

         ::oDbf:AppendFromObject( ::oDbfVir )

         ::oDbfVir:Skip()

         ::oParent:oMeter:AutoInc()

      end

   end

   ::oDbfVir:SetStatus()

   CursorWE()

Return .T.



UTILITY STATIC function TDetMovimientos_Asigna() ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   ::oDbfVir:nNumRem    := ::oParent:oDbf:nNumRem
   ::oDbfVir:cSufRem    := ::oParent:oDbf:cSufRem
   ::oDbfVir:dFecMov    := ::oParent:oDbf:dFecRem
   ::oDbfVir:nTipMov    := ::oParent:oDbf:nTipMov
   ::oDbfVir:cCodMov    := ::oParent:oDbf:cCodMov
   ::oDbfVir:cAliMov    := ::oParent:oDbf:cAlmDes
   ::oDbfVir:cAloMov    := ::oParent:oDbf:cAlmOrg
   ::oDbfVir:cCodUsr    := ::oParent:oDbf:cCodUsr
   ::oDbfVir:cCodDlg    := ::oParent:oDbf:cCodDlg
   ::oDbfVir:lSndDoc    := .T.

RETURN ( Self )



UTILITY STATIC function TDetMovimientos_nTotRemVir( lPic) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local nTot     := 0

   IIF( lPic == nil, lPic := .F., ) ;

   if ::oDbfVir <> nil .AND. ::oDbfVir:Used()

      ::oDbfVir:GetStatus()
      ::oDbfVir:GoTop()

      while !::oDbfVir:eof()
         nTot     += nTotLMovAlm( ::oDbfVir )
         ::oDbfVir:Skip()
      end

      ::oDbfVir:SetStatus()

   end

RETURN ( if( lPic, Trans( nTot, ::oParent:cPorDiv ), nTot ) )



UTILITY STATIC function TDetMovimientos_nTotUnidadesVir( lPic) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local nTot     := 0

   IIF( lPic == nil, lPic := .F., ) ;

   if ::oDbfVir <> nil .AND. ::oDbfVir:Used()

      ::oDbfVir:GetStatus()
      ::oDbfVir:GoTop()

      while !::oDbfVir:eof()
         nTot     += nTotNMovAlm( ::oDbfVir )
         ::oDbfVir:Skip()
      end

      ::oDbfVir:SetStatus()

   end

RETURN ( if( lPic, Trans( nTot, ::oParent:cPicUnd ), nTot ) )



UTILITY STATIC function TDetMovimientos_nTotPesoVir( lPic) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local nPeso    := 0

   IIF( lPic == nil, lPic := .F., ) ;

   if ::oDbfVir <> nil .AND. ::oDbfVir:Used()

      ::oDbfVir:GetStatus()
      ::oDbfVir:GoTop()

      while !::oDbfVir:Eof()
         nPeso    += ( NotCaja( ::oDbfVir:nCajMov ) * ::oDbfVir:nUndMov ) * ::oDbfVir:nPesoKg
         ::oDbfVir:Skip()
      end

      ::oDbfVir:SetStatus()

   end

RETURN ( if( lPic, Trans( nPeso, MasUnd() ), nPeso ) )



UTILITY STATIC function TDetMovimientos_nTotVolumenVir( lPic) ; local Self AS CLASS TDetMovimientos := QSelf() AS CLASS TDetMovimientos

   local nVolumen    := 0

   IIF( lPic == nil, lPic := .F., ) ;

   if ::oDbfVir <> nil .AND. ::oDbfVir:Used()

      ::oDbfVir:GetStatus()
      ::oDbfVir:GoTop()

      while !::oDbfVir:Eof()
         nVolumen    += ( NotCaja( ::oDbfVir:nCajMov ) * ::oDbfVir:nUndMov ) * ::oDbfVir:nVolumen
         ::oDbfVir:Skip()
      end

      ::oDbfVir:SetStatus()

   end

RETURN ( if( lPic, Trans( nVolumen, MasUnd() ), nVolumen ) )













_HB_CLASS TDetSeriesMovimientos ; UTILITY FUNCTION TDetSeriesMovimientos(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TDetSeriesMovimientos" , {TDet():classh} ) ) ; ;

   _HB_MEMBER DefineFiles(); IIF( .F., s_oClass:ModMethod( "DefineFiles", @TDetSeriesMovimientos_DefineFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DefineFiles", @TDetSeriesMovimientos_DefineFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER OpenFiles( lExclusive); IIF( .F., s_oClass:ModMethod( "OpenFiles", @TDetSeriesMovimientos_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "OpenFiles", @TDetSeriesMovimientos_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER CloseFiles(); IIF( .F., s_oClass:ModMethod( "CloseFiles", @TDetSeriesMovimientos_CloseFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CloseFiles", @TDetSeriesMovimientos_CloseFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER OpenService(lExclusive); IIF( .F., s_oClass:ModMethod( "OpenService", @TDetSeriesMovimientos_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ) ), s_oClass:AddMethod( "OpenService", @TDetSeriesMovimientos_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ) ) );

   _HB_MEMBER Save(); IIF( .F., s_oClass:ModMethod( "Save", @TDetSeriesMovimientos_Save(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Save", @TDetSeriesMovimientos_Save(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER RollBack(); IIF( .F., s_oClass:ModMethod( "RollBack", @TDetSeriesMovimientos_RollBack(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "RollBack", @TDetSeriesMovimientos_RollBack(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Resource( nMode, lLiteral); IIF( .F., s_oClass:ModMethod( "Resource", @TDetSeriesMovimientos_Resource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Resource", @TDetSeriesMovimientos_Resource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TDetSeriesMovimientos ;



UTILITY STATIC function TDetSeriesMovimientos_DefineFiles( cPath, cVia, lUniqueName, cFileName) ; local Self AS CLASS TDetSeriesMovimientos := QSelf() AS CLASS TDetSeriesMovimientos

   local oDbf

   IIF( cPath == nil, cPath := ::cPath, ) ;
   IIF( lUniqueName == nil, lUniqueName := .F., ) ;
   IIF( cFileName == nil, cFileName := "MovSer", ) ;
   IIF( cVia == nil, cVia := cDriver(), ) ;

   if lUniqueName
      cFileName         := cGetNewFileName( cFileName, , , cPath )
   end

   oDbf := DbfServer( ( cFileName ), ( cFileName ) ):New( ( cFileName ), ( cFileName ), ( cVia ), "Números de serie de movimientos de almacen", ( cPath ) )

      oDbf:AddField( "nNumRem", "N", 9, 0, "999999999",,,,, .F.,, .T., {} )
      oDbf:AddField( "cSufRem", "C", 2, 0, "@!",,,,, .F.,, .T., {} )
      oDbf:AddField( "dFecRem", "D", 8, 0,,,,,, .F.,, .T., {} )
      oDbf:AddField( "nNumLin", "N", 04, 0,,,,, "Número de línea", .F., 60, .F., {} )
      oDbf:AddField( "cCodArt", "C", 18, 0,,,,, "Artículo", .F., 60, .F., {} )
      oDbf:AddField( "cAlmOrd", "C", 03, 0,,,,, "Almacén", .F., 50, .F., {} )
      oDbf:AddField( "lUndNeg", "L", 01, 0,,,,, "Lógico de unidades en negativo", .F.,, .T., {} )
      oDbf:AddField( "cNumSer", "C", 30, 0,,,,, "Número de serie", .F.,, .T., {} )

      oDbf:AddIndex( "cNumOrd", ( cFileName ), "Str( nNumRem,9 ) + cSufRem",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodArt", ( cFileName ), "cCodArt + cAlmOrd + cNumSer",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cNumSer", ( cFileName ), "cNumSer",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "nNumLin", ( cFileName ), "Str( nNumLin, 4 ) + cCodArt",,, .F., .F.,,,, .T., .F. )



RETURN ( oDbf )



UTILITY STATIC function TDetSeriesMovimientos_OpenFiles(lExclusive) ; local Self AS CLASS TDetSeriesMovimientos := QSelf() AS CLASS TDetSeriesMovimientos

   local lOpen             := .T.
   local oBlock

   IIF( lExclusive == nil, lExclusive := .F., ) ;

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::oDbf            := ::DefineFiles()
      end

      ::oDbf:Activate( .F., !lExclusive )

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos" )
      lOpen                := .F.

   end

   ErrorBlock( oBlock )

   if !lOpen
      ::CloseFiles()
   end

RETURN ( lOpen )



UTILITY STATIC function TDetSeriesMovimientos_CloseFiles() ; local Self AS CLASS TDetSeriesMovimientos := QSelf() AS CLASS TDetSeriesMovimientos

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
      ::oDbf         := nil
   end

RETURN .T.



UTILITY STATIC function TDetSeriesMovimientos_Save() ; local Self AS CLASS TDetSeriesMovimientos := QSelf() AS CLASS TDetSeriesMovimientos

   local nNumRem  := ::oParent:oDbf:nNumRem
   local cSufRem  := ::oParent:oDbf:cSufRem
   local dFecRem  := ::oParent:oDbf:dFecRem
   local cAlmDes  := ::oParent:oDbf:cAlmDes

   ::oDbfVir:OrdSetFocus( 0 )

   ( ::oDbfVir:nArea )->( dbGoTop() )
   while !( ::oDbfVir:nArea )->( eof() )

      ( ::oDbf:nArea )->( dbAppend() )

      if !( ::oDbf:nArea )->( NetErr() )

         ( ::oDbf:nArea )->nNumRem  := nNumRem
         ( ::oDbf:nArea )->cSufRem  := cSufRem
         ( ::oDbf:nArea )->dFecRem  := dFecRem
         ( ::oDbf:nArea )->cAlmOrd  := cAlmDes
         ( ::oDbf:nArea )->nNumLin  := ( ::oDbfVir:nArea )->nNumLin
         ( ::oDbf:nArea )->cCodArt  := ( ::oDbfVir:nArea )->cCodArt
         ( ::oDbf:nArea )->lUndNeg  := ( ::oDbfVir:nArea )->lUndNeg
         ( ::oDbf:nArea )->cNumSer  := ( ::oDbfVir:nArea )->cNumSer

         ( ::oDbf:nArea )->( dbUnLock() )

      end

      ( ::oDbfVir:nArea )->( dbSkip() )

      if !Empty( ::oParent ) .AND. !Empty( ::oParent:oMeter )
         ::oParent:oMeter:AutoInc()
      end

   end

   ::Cancel()

   if !Empty( ::oParent ) .AND. !Empty( ::oParent:oMeter )
      ::oParent:oMeter:Refresh()
   end

RETURN ( Self )



UTILITY STATIC function TDetSeriesMovimientos_RollBack() ; local Self AS CLASS TDetSeriesMovimientos := QSelf() AS CLASS TDetSeriesMovimientos

   local cKey  := ::oParent:cFirstKey
   local nArea := ::oDbf:nArea

   if cKey <> nil

      while ( nArea )->( dbSeek( cKey ) )

         if ( nArea )->( dbRlock() )
            ( nArea )->( dbDelete() )
         end

         if !Empty( ::oParent ) .AND. !Empty( ::oParent:oMeter )
            ::oParent:oMeter:AutoInc()
         end

      end

   end

RETURN ( Self )



UTILITY STATIC function TDetSeriesMovimientos_Resource( nMode) ; local Self AS CLASS TDetSeriesMovimientos := QSelf() AS CLASS TDetSeriesMovimientos

   ::oDbfVir:GetStatus()
   ::oDbfVir:OrdSetFocus( "nNumLin" )

   with object ( TNumerosSerie() )

      :nMode            := nMode

      :lCompras         := ( ::oParent:oDbf:nTipMov <> 1 )

      :cCodArt          := ::oParent:oDetMovimientos:oDbfVir:cRefMov
      :nNumLin          := ::oParent:oDetMovimientos:oDbfVir:nNumLin
      :cCodAlm          := ::oParent:oDbf:cAlmOrg

      :nTotalUnidades   := nTotNMovAlm( ::oParent:oDetMovimientos:oDbfVir )

      :oStock           := ::oParent:oStock

      :uTmpSer          := ::oDbfVir

      :Resource()

   end

   ::oDbfVir:SetStatus()

RETURN ( Self )



Function AppMovimientosAlmacen()

   local oRemMovAlm

   oRemMovAlm           := TRemMovAlm():New( cPatEmp() )

   if oRemMovAlm:OpenFiles()

      oRemMovAlm:Append()

      oRemMovAlm:CloseFiles()

   end

   if oRemMovAlm <> nil
      oRemMovAlm:End()
   end

return .T.



Function EditMovimientosAlmacen( cNumParte, oBrw )

   local oRemMovAlm

   oRemMovAlm           := TRemMovAlm():New( cPatEmp() )

   if oRemMovAlm:OpenFiles()

      if oRemMovAlm:oDbf:SeekInOrd( cNumParte, "cNumRem" )

         oRemMovAlm:Edit( oBrw )

      end

      oRemMovAlm:CloseFiles()

   end

   if oRemMovAlm <> nil
      oRemMovAlm:End()
   end

return .T.




function ZoomMovimientosAlmacen( cNumParte, oBrw )

   local oRemMovAlm

   oRemMovAlm           := TRemMovAlm():New( cPatEmp() )

   if oRemMovAlm:OpenFiles()

      if oRemMovAlm:oDbf:SeekInOrd( cNumParte, "cNumRem" )

         oRemMovAlm:Zoom( oBrw )

      end

      oRemMovAlm:CloseFiles()

   end

   if oRemMovAlm <> nil
      oRemMovAlm:End()
   end

return .T.




function DelMovimientosAlmacen( cNumParte, oBrw )

   local oRemMovAlm

   oRemMovAlm           := TRemMovAlm():New( cPatEmp() )

   if oRemMovAlm:OpenFiles()

      if oRemMovAlm:oDbf:SeekInOrd( cNumParte, "cNumRem" )

         oRemMovAlm:Del( oBrw )

      end

      oRemMovAlm:CloseFiles()

   end

   if oRemMovAlm <> nil
      oRemMovAlm:End()
   end

return .T.






function PrnMovimientosAlmacen( cNumParte )

   local oRemMovAlm

   oRemMovAlm           := TRemMovAlm():New( cPatEmp() )

   if oRemMovAlm:OpenFiles()

      if oRemMovAlm:oDbf:SeekInOrd( cNumParte, "cNumRem" )

         oRemMovAlm:GenRemMov( 1 )

      end

      oRemMovAlm:CloseFiles()

   end

   if oRemMovAlm <> nil
      oRemMovAlm:End()
   end

RETURN ( .T. )






function VisMovimientosAlmacen( cNumParte )

   local oRemMovAlm

   oRemMovAlm           := TRemMovAlm():New( cPatEmp() )

   if oRemMovAlm:OpenFiles()

      if oRemMovAlm:oDbf:SeekInOrd( cNumParte, "cNumRem" )

         oRemMovAlm:GenRemMov( 2 )

      end

      oRemMovAlm:CloseFiles()

   end

   if oRemMovAlm <> nil
      oRemMovAlm:End()
   end

RETURN ( .T. )
