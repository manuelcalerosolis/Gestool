#line 112 "hbclass.ch"
   DYNAMIC DivertConstructorCall
















DECLARE HBClass  New( cName AS String, OPTIONAL SuperParams ) AS CLASS HBClass  Create() AS Object  Instance() AS Object  AddClsMethod( cName AS String, @MethodName(), nScope AS Numeric, n2 AS Numeric, n3 AS Numeric )  AddDelegate( cName AS String, cDelegate AS String, cObject AS String, nScope AS Numeric, lPersistent AS LOGICAL )  AddMultiClsData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String )  AddMultiData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String, x AS LOGICAL, lPer AS LOGICAL )  AddMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  AddInLine( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  AddVirtual( cName AS String )  ModMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  ModClsMethod( cName AS String, @MethodName(), nScope AS Numeric )  ModInline( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  SetOnError( @MethodName() )
#line 85 "\Fwh1204\Include\FiveWin.Ch"
   EXTERNAL GetProcAdd
   EXTERNAL TActiveX




extern errorsys
#line 10 ".\Prg\TDetProduccion.prg"
_HB_CLASS TDetProduccion ; UTILITY FUNCTION TDetProduccion(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TDetProduccion" , {TDet():classh} ) ) ; ;

   _HB_MEMBER { oGetCaja} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetCaja" }, .F., .F. ), )
   _HB_MEMBER { oGetUnd} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetUnd" }, .F., .F. ), )
   _HB_MEMBER { oImpOrd} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oImpOrd" }, .F., .F. ), )
   _HB_MEMBER { oMenu} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oMenu" }, .F., .F. ), )

   _HB_MEMBER { oGetTotalUnidades} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetTotalUnidades" }, .F., .F. ), )
   _HB_MEMBER { nGetTotalUnidades} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nGetTotalUnidades" }, .F., .F. ), )
   _HB_MEMBER { oGetTotalPrecio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetTotalPrecio" }, .F., .F. ), )
   _HB_MEMBER { nGetTotalPrecio} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nGetTotalPrecio" }, .F., .F. ), )
   _HB_MEMBER { oLote} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oLote" }, .F., .F. ), )
   _HB_MEMBER { oSayPr1} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSayPr1" }, .F., .F. ), )
   _HB_MEMBER { oValPr1} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oValPr1" }, .F., .F. ), )
   _HB_MEMBER { oSayVp1} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSayVp1" }, .F., .F. ), )
   _HB_MEMBER { oSayPr2} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSayPr2" }, .F., .F. ), )
   _HB_MEMBER { oValPr2} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oValPr2" }, .F., .F. ), )
   _HB_MEMBER { oSayVp2} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSayVp2" }, .F., .F. ), )
   _HB_MEMBER { oGetPes} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetPes" }, .F., .F. ), )
   _HB_MEMBER { oGetUndPes} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetUndPes" }, .F., .F. ), )
   _HB_MEMBER { oGetTotPes} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetTotPes" }, .F., .F. ), )
   _HB_MEMBER { nGetTotPes} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nGetTotPes" }, .F., .F. ), )
   _HB_MEMBER { oGetVol} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetVol" }, .F., .F. ), )
   _HB_MEMBER { oGetUndVol} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetUndVol" }, .F., .F. ), )
   _HB_MEMBER { oGetTotVol} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oGetTotVol" }, .F., .F. ), )
   _HB_MEMBER { nGetTotVol} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nGetTotVol" }, .F., .F. ), )
   _HB_MEMBER { cOldCodArt} ; IIF( !.F., s_oClass:AddMultiData(, "", nScope + IIF( .F., 32, 0 ), { "cOldCodArt" }, .F., .F. ), )
   _HB_MEMBER { oStkAct} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oStkAct" }, .F., .F. ), )
   _HB_MEMBER { nStkAct} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nStkAct" }, .F., .F. ), )

   _HB_MEMBER { oDbfSeries} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDbfSeries" }, .F., .F. ), )

   _HB_MEMBER DefineFiles(); IIF( .F., s_oClass:ModMethod( "DefineFiles", @TDetProduccion_DefineFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DefineFiles", @TDetProduccion_DefineFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER OpenFiles( lExclusive); IIF( .F., s_oClass:ModMethod( "OpenFiles", @TDetProduccion_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "OpenFiles", @TDetProduccion_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER CloseFiles(); IIF( .F., s_oClass:ModMethod( "CloseFiles", @TDetProduccion_CloseFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CloseFiles", @TDetProduccion_CloseFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER OpenService(lExclusive); IIF( .F., s_oClass:ModMethod( "OpenService", @TDetProduccion_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ) ), s_oClass:AddMethod( "OpenService", @TDetProduccion_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ) ) );

   _HB_MEMBER Resource( nMode, lLiteral); IIF( .F., s_oClass:ModMethod( "Resource", @TDetProduccion_Resource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Resource", @TDetProduccion_Resource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER SetDialogMode(); IIF( .F., s_oClass:ModMethod( "SetDialogMode", @TDetProduccion_SetDialogMode(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SetDialogMode", @TDetProduccion_SetDialogMode(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER lPreSave( oGetArt, oDlg, nMode); IIF( .F., s_oClass:ModMethod( "lPreSave", @TDetProduccion_lPreSave(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lPreSave", @TDetProduccion_lPreSave(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER LoaArticulo( oGetArticulo, oGetNombre); IIF( .F., s_oClass:ModMethod( "LoaArticulo", @TDetProduccion_LoaArticulo(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "LoaArticulo", @TDetProduccion_LoaArticulo(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER SaveDetails(); IIF( .F., s_oClass:ModMethod( "SaveDetails", @TDetProduccion_SaveDetails(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SaveDetails", @TDetProduccion_SaveDetails(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER DeleteDetails(); IIF( .F., s_oClass:ModMethod( "DeleteDetails", @TDetProduccion_DeleteDetails(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DeleteDetails", @TDetProduccion_DeleteDetails(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER nTotUnidades( oDbf); IIF( .F., s_oClass:ModMethod( "nTotUnidades", @TDetProduccion_nTotUnidades(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nTotUnidades", @TDetProduccion_nTotUnidades(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER cTotUnidades( oDbf); IIF( .F., s_oClass:ModMethod( "cTotUnidades", @TDetProduccion_cTotUnidades(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "cTotUnidades", @TDetProduccion_cTotUnidades(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER lTotUnidades( oDbf); IIF( .F., s_oClass:ModMethod( "lTotUnidades", @TDetProduccion_lTotUnidades(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lTotUnidades", @TDetProduccion_lTotUnidades(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER nTotPrecio( oDbf); IIF( .F., s_oClass:ModMethod( "nTotPrecio", @TDetProduccion_nTotPrecio(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nTotPrecio", @TDetProduccion_nTotPrecio(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER cTotPrecio( oDbf); IIF( .F., s_oClass:ModMethod( "cTotPrecio", @TDetProduccion_cTotPrecio(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "cTotPrecio", @TDetProduccion_cTotPrecio(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER lTotPrecio( oDbf); IIF( .F., s_oClass:ModMethod( "lTotPrecio", @TDetProduccion_lTotPrecio(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lTotPrecio", @TDetProduccion_lTotPrecio(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER nTotal( oDbf); IIF( .F., s_oClass:ModMethod( "nTotal", @TDetProduccion_nTotal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nTotal", @TDetProduccion_nTotal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER cTotal( oDbf); IIF( .F., s_oClass:ModMethod( "cTotal", @TDetProduccion_cTotal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "cTotal", @TDetProduccion_cTotal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER lTotal( oDbf); IIF( .F., s_oClass:ModMethod( "lTotal", @TDetProduccion_lTotal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lTotal", @TDetProduccion_lTotal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER nTotPeso( oDbf); IIF( .F., s_oClass:ModMethod( "nTotPeso", @TDetProduccion_nTotPeso(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nTotPeso", @TDetProduccion_nTotPeso(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER lTotPeso( oDbf); IIF( .F., s_oClass:ModMethod( "lTotPeso", @TDetProduccion_lTotPeso(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lTotPeso", @TDetProduccion_lTotPeso(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER nTotVolumen( oDbf); IIF( .F., s_oClass:ModMethod( "nTotVolumen", @TDetProduccion_nTotVolumen(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "nTotVolumen", @TDetProduccion_nTotVolumen(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER lTotVolumen( oDbf); IIF( .F., s_oClass:ModMethod( "lTotVolumen", @TDetProduccion_lTotVolumen(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lTotVolumen", @TDetProduccion_lTotVolumen(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER EdtRotor( oDlg); IIF( .F., s_oClass:ModMethod( "EdtRotor", @TDetProduccion_EdtRotor(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "EdtRotor", @TDetProduccion_EdtRotor(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER lStkAct(); IIF( .F., s_oClass:ModMethod( "lStkAct", @TDetProduccion_lStkAct(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lStkAct", @TDetProduccion_lStkAct(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Del( oBrw1, oBrw2); IIF( .F., s_oClass:ModMethod( "Del", @TDetProduccion_Del(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Del", @TDetProduccion_Del(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TDetProduccion ;



UTILITY STATIC function TDetProduccion_DefineFiles( cPath, cVia, lUniqueName, cFileName) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   local oDbf

   IIF( cPath == nil, cPath := ::cPath, ) ;
   IIF( lUniqueName == nil, lUniqueName := .F., ) ;
   IIF( cFileName == nil, cFileName := "ProLin", ) ;
   IIF( cVia == nil, cVia := cDriver(), ) ;

   if lUniqueName
      cFileName         := cGetNewFileName( cFileName, , , cPath )
   end

   oDbf := DbfServer( ( cFileName ), ( cFileName ) ):New( ( cFileName ), ( cFileName ), ( cVia ), "Materiales producidos", ( cPath ) )

      oDbf:AddField( "cSerOrd", "C", 01, 0,,,,, "Código", .F.,, .T., {} )
      oDbf:AddField( "nNumOrd", "N", 09, 0,,,,, "Número", .F.,, .T., {} )
      oDbf:AddField( "cSufOrd", "C", 02, 0,,,,, "Sufijo", .F.,, .T., {} )
      oDbf:AddField( "nNumLin", "N", 04, 0,,,,, "Número de línea", .F., 20, .F., {} )
      oDbf:AddField( "cCodArt", "C", 18, 0,,,,, "Artículo", .F., 60, .F., {} )
      oDbf:AddField( "cNomArt", "C", 100, 0,,,,, "Nombre", .F., 240, .F., {} )
      oDbf:AddField( "cAlmOrd", "C", 03, 0,,,,, "Almacén", .F., 50, .F., {} )
      oDbf:AddField( "nCajOrd", "N", 16, 6,,,,, "Cajas", .F.,, .T., {} )
      oDbf:AddField( "nUndOrd", "N", 16, 6,,,,, "Unidades", .F.,, .T., {} )
      oDbf:AddField( "nImpOrd", "N", 16, 6,,,,, "Precio", .F., 80, .F., {} )
      oDbf:AddField( "nPeso", "N", 16, 6,,,,, "Peso del artículo", .F., 80, .F., {} )
      oDbf:AddField( "cUndPes", "C", 2, 0,,,,, "Unidad del peso", .F., 80, .F., {} )
      oDbf:AddField( "nVolumen", "N", 16, 6,,,,, "Volumen del artículo", .F., 80, .F., {} )
      oDbf:AddField( "cUndVol", "C", 2, 0,,,,, "Unidad del volumen", .F., 80, .F., {} )
      oDbf:AddField( "cCodPr1", "C", 10, 0,,,,, "Código de primera propiedad", .F., 80, .F., {} )
      oDbf:AddField( "cCodPr2", "C", 10, 0,,,,, "Código de segunda propiedad", .F., 80, .F., {} )
      oDbf:AddField( "cValPr1", "C", 10, 0,,,,, "Valor de primera propiedad", .F., 80, .F., {} )
      oDbf:AddField( "cValPr2", "C", 10, 0,,,,, "Valor de segunda propiedad", .F., 80, .F., {} )
      oDbf:AddField( "lLote", "L", 1, 0,,,,, "Lógico lote", .F., 80, .F., {} )
      oDbf:AddField( "cLote", "C", 12, 0,,,,, "Lote", .F., 80, .F., {} )
      oDbf:AddField( "dFecOrd", "D", 8, 0,,,,, "Fecha", .F.,, .T., {} )

      oDbf:AddIndex( "cNumOrd", ( cFileName ), "cSerOrd + Str( nNumOrd,9 ) + cSufOrd",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodArt", ( cFileName ), "cCodArt",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "nNumLin", ( cFileName ), "Str( nNumLin, 4 )",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cLote", ( cFileName ), "cLote",,, .F., .F.,,,, .T., .F. )



RETURN ( oDbf )



UTILITY STATIC function TDetProduccion_OpenFiles(lExclusive) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   local lOpen             := .T.
   local oBlock

   IIF( lExclusive == nil, lExclusive := .F., ) ;

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::oDbf            := ::DefineFiles()
      end

      ::oDbf:Activate( .F., !lExclusive )

      ::bOnPreSaveDetail   := {|| ::SaveDetails() }
      ::bOnPreDelete       := {|| ::DeleteDetails() }

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos" )
      lOpen                := .F.

   end

   ErrorBlock( oBlock )

   if !lOpen
      ::CloseFiles()
   end

RETURN ( lOpen )



UTILITY STATIC function TDetProduccion_CloseFiles() ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
      ::oDbf               := nil
   end

RETURN .T.



UTILITY STATIC function TDetProduccion_Resource( nMode) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   local oDlg
   local oGetArt
   local oGetNom
   local oGetAlm
   local oSayAlm
   local cSayAlm
   local cSayPr1
   local cSayVp1
   local cSayPr2
   local cSayVp2
   local oBtnSer

   ::cOldCodArt         := ::oDbfVir:cCodArt

   if nMode == 1
      ::oDbfVir:cAlmOrd := ::oParent:oDbf:cAlmOrd
      ::oDbfVir:nCajOrd := 1
      ::oDbfVir:nUndOrd := 1
      ::oDbfVir:nNumLin := nLastNum( ::oDbfVir )
   else
      cSayVp1           :=  oRetFld( ::oDbfVir:cCodPr1 + ::oDbfVir:cValPr1, ::oParent:oTblPro, "cDesTbl" )
      cSayVp2           :=  oRetFld( ::oDbfVir:cCodPr2 + ::oDbfVir:cValPr2, ::oParent:oTblPro, "cDesTbl" )
   end





   if !uFieldEmpresa( "lNStkAct" )
      ::nStkAct         := ::oParent:oStock:nStockActual( ::oDbfVir:cCodArt, ::oDbfVir:cAlmOrd )
   else
      ::nStkAct         := 0
   end

   ::nGetTotalUnidades  := ::nTotUnidades( ::oDbfVir )
   ::nGetTotalPrecio    := ::nTotPrecio( ::oDbfVir )
   ::nGetTotPes         := ::nTotPeso( ::oDbfVir )
   ::nGetTotVol         := ::nTotVolumen( ::oDbfVir )

   cSayAlm              := RetAlmacen( ::oDbfVir:cAlmOrd, ::oParent:oAlm )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "articulos producidos", "LPRODUCIDO",, .F.,,,,,, .F.,,,,,, .F., )









      oGetArt := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::oDbfVir:cCodArt, ::oDbfVir:cCodArt:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,,, nil, "LUPA",, )

      oGetArt:bValid := {|| cArticulo( oGetArt, ::oParent:oArt:cAlias, oGetNom ), ::LoaArticulo( oGetArt, oGetNom ) }
      oGetArt:bHelp  := {|| BrwArticulo( oGetArt, oGetNom ), ::LoaArticulo( oGetArt, oGetNom ) }




      oGetNom := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, ::oDbfVir:cNomArt, ::oDbfVir:cNomArt:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,,, nil,,, )









      ::oLote := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::oDbfVir:cLote, ::oDbfVir:cLote:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,, 211, )







      ::oSayPr1 := TSay():ReDefine( 221, {|| cSayPr1}, oDlg,,,, .F.,, .F., .F. )






      ::oValPr1 := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, ::oDbfVir:cValPr1, ::oDbfVir:cValPr1:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

         ::oValPr1:bValid := {|| lPrpAct( ::oDbfVir:cValPr1, ::oSayVp1, ::oDbfVir:cCodPr1, ::oParent:oTblPro:cAlias ) }
         ::oValPr1:bHelp  := {|| brwPrpAct( ::oValPr1, ::oSayVp1, ::oDbfVir:cCodPr1 ) }





      ::oSayVp1 := TGetHlp():ReDefine( 222, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      ::oSayPr2 := TSay():ReDefine( 231, {|| cSayPr2}, oDlg,,,, .F.,, .F., .F. )






      ::oValPr2 := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, ::oDbfVir:cValPr2, ::oDbfVir:cValPr2:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

         ::oValPr2:bValid := {|| lPrpAct( ::oDbfVir:cValPr2, ::oSayVp2, ::oDbfVir:cCodPr2, ::oParent:oTblPro:cAlias ) }
         ::oValPr2:bHelp  := {|| brwPrpAct( ::oValPr2, ::oSayVp2, ::oDbfVir:cCodPr2 ) }





      ::oSayVp2 := TGetHlp():ReDefine( 232, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











      ::oGetCaja := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::oDbfVir:nCajOrd, ::oDbfVir:nCajOrd:= u ) }, oDlg,, ::oParent:cPicUnd,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 121, )

      ::oGetCaja:bChange   := {|| ::lTotUnidades( ::oDbfVir ), ::lTotPrecio( ::oDbfVir ), ::lTotPeso( ::oDbfVir ), ::lTotVolumen( ::oDbfVir ) }
      ::oGetCaja:bValid    := {|| ::lTotUnidades( ::oDbfVir ), ::lTotPrecio( ::oDbfVir ), ::lTotPeso( ::oDbfVir ), ::lTotVolumen( ::oDbfVir ) }






      ::oGetUnd := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::oDbfVir:nUndOrd, ::oDbfVir:nUndOrd:= u ) }, oDlg,, ::oParent:cPicUnd,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      ::oGetUnd:bChange   := {|| ::lTotUnidades( ::oDbfVir ), ::lTotPrecio( ::oDbfVir ), ::lTotPeso( ::oDbfVir ), ::lTotVolumen( ::oDbfVir ) }
      ::oGetUnd:bValid    := {|| ::lTotUnidades( ::oDbfVir ), ::lTotPrecio( ::oDbfVir ), ::lTotPeso( ::oDbfVir ), ::lTotVolumen( ::oDbfVir ) }





      ::oGetTotalUnidades := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::nGetTotalUnidades, ::nGetTotalUnidades:= u ) }, oDlg,, ::oParent:cPicUnd,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )










      ::oImpOrd := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::oDbfVir:nImpOrd, ::oDbfVir:nImpOrd:= u ) }, oDlg,, ::oParent:cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      ::oImpOrd:bChange   := {|| ::lTotPrecio( ::oDbfVir ) }
      ::oImpOrd:bValid    := {|| ::lTotPrecio( ::oDbfVir ) }





      ::oGetTotalPrecio := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::nGetTotalPrecio, ::nGetTotalPrecio:= u ) }, oDlg,, ::oParent:cPorDiv,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )










      ::oGetPes := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, ::oDbfVir:nPeso, ::oDbfVir:nPeso:= u ) }, oDlg,, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      ::oGetPes:bChange   := {|| ::lTotPeso( ::oDbfVir ) }
      ::oGetPes:bValid    := {|| ::lTotPeso( ::oDbfVir ) }




      ::oGetUndPes := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, ::oDbfVir:cUndPes, ::oDbfVir:cUndPes:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      ::oGetTotPes := TGetHlp():ReDefine( 172, { | u | If( PCount()==0, ::nGetTotPes, ::nGetTotPes:= u ) }, oDlg,, MasUnd(),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )










      ::oGetVol := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, ::oDbfVir:nVolumen, ::oDbfVir:nVolumen:= u ) }, oDlg,, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      ::oGetVol:bChange   := {|| ::lTotVolumen( ::oDbfVir ) }
      ::oGetVol:bValid    := {|| ::lTotVolumen( ::oDbfVir ) }




      ::oGetUndVol := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, ::oDbfVir:cUndVol, ::oDbfVir:cUndVol:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      ::oGetTotVol := TGetHlp():ReDefine( 182, { | u | If( PCount()==0, ::nGetTotVol, ::nGetTotVol:= u ) }, oDlg,, MasUnd(),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )










      oGetAlm := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, ::oDbfVir:cAlmOrd, ::oDbfVir:cAlmOrd:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( oGetAlm, oSayAlm ) )}, nil, "LUPA",, )

      oGetAlm:bChange   := {|| ::lStkAct() }
      oGetAlm:bValid    := {|| cAlmacen( oGetAlm, ::oParent:oAlm, oSayAlm ), ::lStkAct() }




      oSayAlm := TGetHlp():ReDefine( 191, { | u | If( PCount()==0, cSayAlm, cSayAlm:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )









      ::oStkAct := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, ::nStkAct, ::nStkAct:= u ) }, oDlg,, MasUnd(),,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      oBtnSer := TButton():ReDefine( 552, {||( nil )}, oDlg,,, .F.,,,, .F. )

      oBtnSer:bAction   := {|| ::oParent:oDetSeriesProduccion:Resource( nMode ) }





      TButton():ReDefine( 1, {||( ::lPreSave( oGetArt, oDlg, nMode ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 9, {||( MsgInfo( "Ayuda no disponible", "Perdonen las molestias" ) )}, oDlg,,, .F.,,,, .F. )

      if nMode <> 3
         oDlg:AddFastKey( 112, {|| MsgInfo( "Ayuda no disponible", "Perdonen las molestias" ) } )
         oDlg:AddFastKey( 117, {|| oBtnSer:Click() })
         oDlg:AddFastKey( 116, {|| ::lPreSave( oGetArt, oDlg, nMode ) } )
      end

      oDlg:bStart := {|| ::EdtRotor( oDlg ), ::SetDialogMode( nMode ) }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   ::oMenu:End()

RETURN ( oDlg:nResult == 1 )



UTILITY STATIC function TDetProduccion_SetDialogMode( nMode) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   if !lUseCaj()
      ::oGetCaja:Hide()
   end

   if nMode == 1

      ::oLote:Hide()

      ::oSayPr1:Hide()
      ::oValPr1:Hide()
      ::oSayVp1:Hide()

      ::oSayPr2:Hide()
      ::oValPr2:Hide()
      ::oSayVp2:Hide()

   else

      if ::oDbfVir:lLote
         ::oLote:Show()
      else
         ::oLote:Hide()
      end

      if !Empty( ::oDbfVir:cCodPr1 )
         ::oSayPr1:Show()
         ::oSayPr1:SetText( retProp( ::oDbfVir:cCodPr1, ::oParent:oPro:cAlias ) )
         ::oValPr1:Show()
         ::oSayVp1:Show()
      else
         ::oSayPr1:Hide()
         ::oValPr1:Hide()
         ::oSayVp1:Hide()
      end

      if !Empty( ::oDbfVir:cCodPr2 )
         ::oSayPr2:Show()
         ::oSayPr2:SetText( retProp( ::oDbfVir:cCodPr2, ::oParent:oPro:cAlias ) )
         ::oValPr2:Show()
         ::oSayVp2:Show()
      else
         ::oSayPr2:Hide()
         ::oValPr2:Hide()
         ::oSayVp2:Hide()
      end

   end

RETURN ( Self )



UTILITY STATIC function TDetProduccion_LoaArticulo( oGetArticulo, oGetNombre) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   local cCodArt     := oGetArticulo:VarGet()
   local lChgCodArt  := ( Empty( ::cOldCodArt ) .OR. Rtrim( ::cOldCodArt ) <> Rtrim( cCodArt ) )

   if Empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir lineas sin codificar" )
         return .F.
      end

      return .T.

   else












      ::oParent:oArt:ordSetFocus( "CodeBar" )

      if ::oParent:oArt:Seek( cCodArt )
         cCodArt  := ::oParent:oArt:Codigo
      end





      ::oParent:oArt:ordSetFocus( "Codigo" )

      if ::oParent:oArt:Seek( cCodArt ) .OR. ::oParent:oArt:Seek( Upper( cCodArt ) )

         cCodArt  := ::oParent:oArt:Codigo

         if !uFieldEmpresa( "lNStkAct" )
            ::oStkAct:cText( ::oParent:oStock:nStockActual( cCodArt, ::oDbfVir:cAlmOrd ) )
         end

         if lChgCodArt

            oGetNombre:cText( ::oParent:oArt:Nombre )

            if ::oParent:oArt:nCajEnt <> 0
               ::oGetCaja:cText( ::oParent:oArt:nCajEnt )
            end

            if ::oParent:oArt:nUniCaja <> 0
               ::oGetUnd:cText( ::oParent:oArt:nUniCaja )
            end

            ::oGetPes:cText(     ::oParent:oArt:nPesoKg )
            ::oGetVol:cText(     ::oParent:oArt:nVolumen )
            ::oImpOrd:cText(     ::oParent:oArt:pCosto )
            ::oGetUndPes:cText(  ::oParent:oArt:cUndDim )
            ::oGetUndVol:cText(  ::oParent:oArt:cVolumen )

            if ::oParent:oArt:lLote
               ::oLote:Show()
               ::oLote:cText( ::oParent:oArt:cLote )
               ::oDbfVir:lLote   := ::oParent:oArt:lLote
            else
               ::oLote:Hide()
            end

         end

         ::lTotUnidades( ::oDbfVir )
         ::lTotPrecio( ::oDbfVir )
         ::lTotPeso( ::oDbfVir )
         ::lTotVolumen( ::oDbfVir )

         if ::oParent:oFam:Seek( ::oParent:oArt:Familia )
            ::oDbfVir:cCodPr1 := ::oParent:oFam:cCodPrp1
            ::oDbfVir:cCodPr2 := ::oParent:oFam:cCodPrp2
         else
            ::oDbfVir:cCodPr1 := Space( 10 )
            ::oDbfVir:cCodPr2 := Space( 10 )
         end

         if !Empty( ::oDbfVir:cCodPr1 )
            ::oSayPr1:Show()
            ::oSayPr1:SetText( retProp( ::oDbfVir:cCodPr1, ::oParent:oPro:cAlias ) )
            ::oValPr1:Show()
            ::oSayVp1:Show()
         else
            ::oSayPr1:Hide()
            ::oValPr1:Hide()
            ::oSayVp1:Hide()
         end

         if !Empty( ::oDbfVir:cCodPr2 )
            ::oSayPr2:Show()
            ::oSayPr2:SetText( retProp( ::oDbfVir:cCodPr2, ::oParent:oPro:cAlias ) )
            ::oValPr2:Show()
            ::oSayVp2:Show()
         else
            ::oSayPr2:Hide()
            ::oValPr2:Hide()
            ::oSayVp2:Hide()
         end

         ::cOldCodArt   := cCodArt

         return .T.

      else

         MsgStop( "Artículo no encontrado" )

         return .F.

      end

   end

RETURN .T.



UTILITY STATIC function TDetProduccion_nTotUnidades( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( if( !Empty( ::oParent:nDouDiv ), Round( NotCaja( oDbf:nCajOrd ) * oDbf:nUndOrd, ::oParent:nDouDiv ), ( NotCaja( oDbf:nCajOrd ) * oDbf:nUndOrd ) ) )



UTILITY STATIC function TDetProduccion_cTotUnidades( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( Trans( ::nTotUnidades( oDbf ), ::oParent:cPicUnd ) )



UTILITY STATIC function TDetProduccion_lTotUnidades( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( ::oGetTotalUnidades:cText( ::nTotUnidades( oDbf ) ), .T. )



UTILITY STATIC function TDetProduccion_nTotPrecio( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( Round( ::nTotUnidades( oDbf ) * oDbf:nImpOrd, ::oParent:nDorDiv ) )



UTILITY STATIC function TDetProduccion_cTotPrecio( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( Trans( ::nTotPrecio( oDbf ), ::oParent:cPorDiv ) )



UTILITY STATIC function TDetProduccion_lTotPrecio( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( ::oGetTotalPrecio:cText( ::nTotPrecio( oDbf ) ), .T. )



UTILITY STATIC function TDetProduccion_nTotal( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   local nTotal   := 0

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

   oDbf:GetStatus()

   oDbf:GoTop()

   while !oDbf:Eof()
      nTotal      += ::nTotPrecio( oDbf )
      oDbf:Skip()
   end

   oDbf:SetStatus()

RETURN ( nTotal )



UTILITY STATIC function TDetProduccion_cTotal( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( Trans( ::nTotal( oDbf ), ::oParent:cPorDiv ) )



UTILITY STATIC function TDetProduccion_lTotal( oDbf, oGet) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( oGet:cText( ::nTotal( oDbf ) ), .T. )



UTILITY STATIC function TDetProduccion_SaveDetails() ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   ::oDbfVir:cSerOrd := ::oParent:oDbf:cSerOrd
   ::oDbfVir:nNumOrd := ::oParent:oDbf:nNumOrd
   ::oDbfVir:cSufOrd := ::oParent:oDbf:cSufOrd
   ::oDbfVir:dFecOrd := ::oParent:oDbf:dFecOrd

RETURN ( Self )



UTILITY STATIC function TDetProduccion_DeleteDetails() ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   while ::oParent:oDetSeriesProduccion:oDbfVir:SeekInOrd( Str( ::oDbfVir:nNumLin, 4 ) + ::oDbfVir:cCodArt, "nNumLin" )
      ::oParent:oDetSeriesProduccion:oDbfVir:Delete()
   end

RETURN ( Self )



UTILITY STATIC function TDetProduccion_EdtRotor( oDlg) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   ::oMenu := MenuBegin( .F.,,, .F., .F. )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F. )

         MenuBegin( .F.,,, .F., .F. )





            MenuAddItem( "&1. Modificar artículo", "Modificar la ficha del artículo", .F.,, {|oMenuItem|( if( Empty( ::oDbfVir:cCodArt ), msgStop( "No hay artículo seleccionado" ), EdtArticulo( ::oDbfVir:cCodArt ) ) )},, "Cube_Yellow_16",,,,, .F.,,, .F. )




            MenuAddItem( "&2. Informe de artículo", "Abrir el informe del articulo", .F.,, {|oMenuItem|( if( Empty( ::oDbfVir:cCodArt ), msgStop( "No hay artículo seleccionado" ), InfArticulo( ::oDbfVir:cCodArt ) ) )},, "Info16",,,,, .F.,,, .F. )
         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( ::oMenu )

RETURN ( ::oMenu )



UTILITY STATIC function TDetProduccion_nTotPeso( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( Round( NotCaja( oDbf:nCajOrd ) * oDbf:nUndOrd, ::oParent:nDouDiv ) * oDbf:nPeso )



UTILITY STATIC function TDetProduccion_nTotVolumen( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( Round( NotCaja( oDbf:nCajOrd ) * oDbf:nUndOrd, ::oParent:nDouDiv ) * oDbf:nVolumen )



UTILITY STATIC function TDetProduccion_lTotPeso( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( ::oGetTotPes:cText( ::nTotPeso( oDbf ) ), .T. )



UTILITY STATIC function TDetProduccion_lTotVolumen( oDbf) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   IIF( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( ::oGetTotVol:cText( ::nTotVolumen( oDbf ) ), .T. )



UTILITY STATIC function TDetProduccion_lPreSave( oGetArt, oDlg, nMode) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   local nOrdAnt

   if Empty( ::oDbfVir:cCodArt )
      MsgStop( "Tiene que seleccionar un artículo." )
      oGetArt:SetFocus()
      Return .F.
   end

   do case
      case nMode == 1



         if ::oParent:oArt:Seek( ::oDbfVir:cCodArt )



            if ::oParent:oArt:lKitArt .AND. !::oParent:oArt:lKitAsc



               if ::oParent:oKitArt:Seek( ::oDbfVir:cCodArt )

                  while ::oParent:oKitArt:cCodKit == ::oDbfVir:cCodArt .AND. !::oParent:oKitArt:Eof()



                     if !::oParent:oKitArt:lExcPro

                        ::oParent:oDetMaterial:oDbfVir:Append()

                        ::oParent:oDetMaterial:oDbfVir:cCodArt    := ::oParent:oKitArt:cRefKit
                        ::oParent:oDetMaterial:oDbfVir:cNomArt    := ::oParent:oKitArt:cDesKit
                        ::oParent:oDetMaterial:oDbfVir:cAlmOrd    := ::oParent:oDbf:cAlmOrg
                        ::oParent:oDetMaterial:oDbfVir:nCajOrd    := 1
                        ::oParent:oDetMaterial:oDbfVir:nUndOrd    := ::nTotUnidades( ::oDbfVir ) * ::oParent:oKitArt:nUndKit
                        ::oParent:oDetMaterial:oDbfVir:nImpOrd    := oRetFld( ::oParent:oKitArt:cRefKit, ::oParent:oArt, "pCosto" )
                        ::oParent:oDetMaterial:oDbfVir:nPeso      := oRetFld( ::oParent:oKitArt:cRefKit, ::oParent:oArt, "nPesoKg" )
                        ::oParent:oDetMaterial:oDbfVir:cUndPes    := oRetFld( ::oParent:oKitArt:cRefKit, ::oParent:oArt, "cUnidad" )
                        ::oParent:oDetMaterial:oDbfVir:nVolumen   := oRetFld( ::oParent:oKitArt:cRefKit, ::oParent:oArt, "nVolumen" )
                        ::oParent:oDetMaterial:oDbfVir:cUndVol    := oRetFld( ::oParent:oKitArt:cRefKit, ::oParent:oArt, "cVolumen" )
                        ::oParent:oDetMaterial:oDbfVir:cCodPr1    := Space(5)
                        ::oParent:oDetMaterial:oDbfVir:cCodPr2    := Space(5)
                        ::oParent:oDetMaterial:oDbfVir:cValPr1    := Space(5)
                        ::oParent:oDetMaterial:oDbfVir:cValPr2    := Space(5)
                        ::oParent:oDetMaterial:oDbfVir:lLote      := oRetFld( ::oParent:oKitArt:cRefKit, ::oParent:oArt, "lLote" )
                        ::oParent:oDetMaterial:oDbfVir:cLote      := oRetFld( ::oParent:oKitArt:cRefKit, ::oParent:oArt, "cLote" )
                        ::oParent:oDetMaterial:oDbfVir:cCodPro    := ::oDbfVir:cCodArt

                        ::oParent:oDetMaterial:oDbfVir:Save()

                     end

                     ::oParent:oKitArt:Skip()

                  end

               end

            end

         end

      case nMode == 2



         nOrdAnt  := ::oParent:oDetMaterial:oDbfVir:OrdsetFocus( "cCodPro" )

         ::oParent:oDetMaterial:oDbfVir:GoTop()

         if ::oParent:oDetMaterial:oDbfVir:Seek( ::oDbfVir:cCodArt )

            while ::oParent:oDetMaterial:oDbfVir:cCodPro == ::oDbfVir:cCodArt .AND. !::oParent:oDetMaterial:oDbfVir:Eof()

               ::oParent:oDetMaterial:oDbfVir:Load()

               if ::oParent:oKitArt:SeekInOrd( ::oDbfVir:cCodArt + ::oParent:oDetMaterial:oDbfVir:cCodArt, "cCodRef" )
                  ::oParent:oDetMaterial:oDbfVir:nUndOrd    := ::nTotUnidades( ::oDbfVir ) * ::oParent:oKitArt:nUndKit
               end

               ::oParent:oDetMaterial:oDbfVir:Save()

               ::oParent:oDetMaterial:oDbfVir:Skip()

            end

         end

         ::oParent:oDetMaterial:oDbfVir:OrdSetFocus( nOrdAnt )

   end

   ::oParent:oDetMaterial:oDbfVir:GoTop()

   ::oParent:oTotProducido:Refresh()
   ::oParent:oTotMaterias:Refresh()
   ::oParent:oTotPersonal:Refresh()

RETURN oDlg:end( 1 )



UTILITY STATIC function TDetProduccion_lStkAct() ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

RETURN ( if ( !uFieldEmpresa( "lNStkAct" ), ::oStkAct:cText( ::oParent:oStock:nStockActual( ::oDbfVir:cCodArt, ::oDbfVir:cAlmOrd ) ), ), .T. )



UTILITY STATIC function TDetProduccion_Del( oBrw1, oBrw2) ; local Self AS CLASS TDetProduccion := QSelf() AS CLASS TDetProduccion

   while ::oParent:oDetMaterial:oDbfVir:SeekInOrd( ::oDbfVir:cCodArt, "cCodPro" )
      ::oParent:oDetMaterial:oDbfVir:Delete()
   end

   while ::oParent:oDetSeriesProduccion:oDbfVir:SeekInOrd( Str( ::oDbfVir:nNumLin, 4 ), "nNumLin" )
      ::oParent:oDetSeriesProduccion:oDbfVir:Delete()
   end

   ::TDet:Del( oBrw1 )

   ::oParent:oTotProducido:Refresh()

   ::oParent:oTotMaterias:Refresh()

   oBrw1:Refresh()
   oBrw2:Refresh()

RETURN .T.



Function nTotNProduccion( uDbf )

   local nTotUnd

   do case
      case ValType( uDbf ) == "O"
         nTotUnd  := NotCaja( uDbf:nCajOrd )
         nTotUnd  *= uDbf:nUndOrd

      otherwise
         nTotUnd  := NotCaja( ( uDbf )->nCajOrd )
         nTotUnd  *= ( uDbf )->nUndOrd

   end

RETURN ( nTotUnd )










_HB_CLASS TDetSeriesProduccion ; UTILITY FUNCTION TDetSeriesProduccion(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TDetSeriesProduccion" , {TDet():classh} ) ) ; ;

   _HB_MEMBER DefineFiles(); IIF( .F., s_oClass:ModMethod( "DefineFiles", @TDetSeriesProduccion_DefineFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DefineFiles", @TDetSeriesProduccion_DefineFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER OpenFiles( lExclusive); IIF( .F., s_oClass:ModMethod( "OpenFiles", @TDetSeriesProduccion_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "OpenFiles", @TDetSeriesProduccion_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER CloseFiles(); IIF( .F., s_oClass:ModMethod( "CloseFiles", @TDetSeriesProduccion_CloseFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CloseFiles", @TDetSeriesProduccion_CloseFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER OpenService(lExclusive); IIF( .F., s_oClass:ModMethod( "OpenService", @TDetSeriesProduccion_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ) ), s_oClass:AddMethod( "OpenService", @TDetSeriesProduccion_OpenFiles(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ) ) );

   _HB_MEMBER SaveDetails(); IIF( .F., s_oClass:ModMethod( "SaveDetails", @TDetSeriesProduccion_SaveDetails(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SaveDetails", @TDetSeriesProduccion_SaveDetails(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Resource( nMode, lLiteral); IIF( .F., s_oClass:ModMethod( "Resource", @TDetSeriesProduccion_Resource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Resource", @TDetSeriesProduccion_Resource(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TDetSeriesProduccion ;



UTILITY STATIC function TDetSeriesProduccion_DefineFiles( cPath, cVia, lUniqueName, cFileName) ; local Self AS CLASS TDetSeriesProduccion := QSelf() AS CLASS TDetSeriesProduccion

   local oDbf

   IIF( cPath == nil, cPath := ::cPath, ) ;
   IIF( lUniqueName == nil, lUniqueName := .F., ) ;
   IIF( cFileName == nil, cFileName := "ProSer", ) ;
   IIF( cVia == nil, cVia := cDriver(), ) ;

   if lUniqueName
      cFileName         := cGetNewFileName( cFileName, , , cPath )
   end

   oDbf := DbfServer( ( cFileName ), ( cFileName ) ):New( ( cFileName ), ( cFileName ), ( cVia ), "Números de serie de materiales producidos", ( cPath ) )

      oDbf:AddField( "cSerOrd", "C", 01, 0,,,,, "Código", .F.,, .T., {} )
      oDbf:AddField( "nNumOrd", "N", 09, 0,,,,, "Número", .F.,, .T., {} )
      oDbf:AddField( "cSufOrd", "C", 02, 0,,,,, "Sufijo", .F.,, .T., {} )
      oDbf:AddField( "dFecOrd", "D", 08, 0,,,,, "Fecha", .F.,, .F., {} )
      oDbf:AddField( "nNumLin", "N", 04, 0,,,,, "Número de línea", .F., 60, .F., {} )
      oDbf:AddField( "cCodArt", "C", 18, 0,,,,, "Artículo", .F., 60, .F., {} )
      oDbf:AddField( "cAlmOrd", "C", 03, 0,,,,, "Almacén", .F., 50, .F., {} )
      oDbf:AddField( "lUndNeg", "L", 01, 0,,,,, "Lógico de unidades en negativo", .F.,, .T., {} )
      oDbf:AddField( "cNumSer", "C", 30, 0,,,,, "Número de serie", .F.,, .T., {} )

      oDbf:AddIndex( "cNumOrd", ( cFileName ), "cSerOrd + Str( nNumOrd,9 ) + cSufOrd",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodArt", ( cFileName ), "cCodArt + cAlmOrd + cNumSer",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cNumSer", ( cFileName ), "cNumSer",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "nNumLin", ( cFileName ), "Str( nNumLin, 4 ) + cCodArt",,, .F., .F.,,,, .T., .F. )



RETURN ( oDbf )



UTILITY STATIC function TDetSeriesProduccion_OpenFiles(lExclusive) ; local Self AS CLASS TDetSeriesProduccion := QSelf() AS CLASS TDetSeriesProduccion

   local lOpen             := .T.
   local oBlock

   IIF( lExclusive == nil, lExclusive := .F., ) ;

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::oDbf            := ::DefineFiles()
      end

      ::oDbf:Activate( .F., !lExclusive )

      ::bOnPreSaveDetail   := {|| ::SaveDetails() }

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos" )
      lOpen                := .F.

   end

   ErrorBlock( oBlock )

   if !lOpen
      ::CloseFiles()
   end

RETURN ( lOpen )



UTILITY STATIC function TDetSeriesProduccion_CloseFiles() ; local Self AS CLASS TDetSeriesProduccion := QSelf() AS CLASS TDetSeriesProduccion

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
      ::oDbf         := nil
   end

RETURN .T.



UTILITY STATIC function TDetSeriesProduccion_SaveDetails() ; local Self AS CLASS TDetSeriesProduccion := QSelf() AS CLASS TDetSeriesProduccion

   ::oDbfVir:cSerOrd    := ::oParent:oDbf:cSerOrd
   ::oDbfVir:nNumOrd    := ::oParent:oDbf:nNumOrd
   ::oDbfVir:cSufOrd    := ::oParent:oDbf:cSufOrd
   ::oDbfVir:dFecOrd    := ::oParent:oDbf:dFecFin

RETURN ( Self )




UTILITY STATIC function TDetSeriesProduccion_Resource( nMode) ; local Self AS CLASS TDetSeriesProduccion := QSelf() AS CLASS TDetSeriesProduccion

   with object ( TNumerosSerie() )

      :nMode            := nMode

      :lCompras         := .T.

      :cCodArt          := ::oParent:oDetProduccion:oDbfVir:cCodArt
      :nNumLin          := ::oParent:oDetProduccion:oDbfVir:nNumLin
      :cCodAlm          := ::oParent:oDbf:cAlmOrd

      :nTotalUnidades   := ::oParent:oDetProduccion:nTotUnidades( ::oParent:oDetProduccion:oDbfVir )

      :oStock           := ::oParent:oStock

      ::oDbfVir:GetStatus()
      ::oDbfVir:OrdSetFocus( "nNumLin" )

      :uTmpSer          := ::oDbfVir

      :Resource()

      ::oDbfVir:SetStatus()

   end

RETURN ( Self )
