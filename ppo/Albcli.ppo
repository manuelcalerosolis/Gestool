#line 112 "hbclass.ch"
   DYNAMIC DivertConstructorCall
















DECLARE HBClass  New( cName AS String, OPTIONAL SuperParams ) AS CLASS HBClass  Create() AS Object  Instance() AS Object  AddClsMethod( cName AS String, @MethodName(), nScope AS Numeric, n2 AS Numeric, n3 AS Numeric )  AddDelegate( cName AS String, cDelegate AS String, cObject AS String, nScope AS Numeric, lPersistent AS LOGICAL )  AddMultiClsData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String )  AddMultiData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String, x AS LOGICAL, lPer AS LOGICAL )  AddMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  AddInLine( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  AddVirtual( cName AS String )  ModMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  ModClsMethod( cName AS String, @MethodName(), nScope AS Numeric )  ModInline( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  SetOnError( @MethodName() )
#line 85 "\Fwh1204\Include\FiveWin.Ch"
   EXTERNAL GetProcAdd
   EXTERNAL TActiveX




extern errorsys
#line 252 ".\Prg\Albcli.prg"
memvar cDbf
memvar cDbfCol
memvar cDbfPag
memvar cCliente
memvar cDbfCli
memvar cIva
memvar cDbfIva
memvar cDbfDiv
memvar cDbfUsr
memvar cFPago
memvar cDbfPgo
memvar cAgent
memvar cDbfAge
memvar cTvta
memvar cObras
memvar cDbfObr
memvar cTarPreL
memvar cTarPreS
memvar cDbfRut
memvar cDbfTrn
memvar cDbfPro
memvar cDbfDlg
memvar cDbfTblPro
memvar cDbfAnt
memvar aTotIva
memvar cCtaCli
memvar nTotBrt
memvar nTotDto
memvar nTotDpp
memvar nTotUno
memvar nTotDos
memvar nTotNet
memvar nTotIva
memvar nTotIvm
memvar aTotIvm
memvar nTotReq
memvar nTotImp
memvar nTotAlb
memvar nTotPag
memvar nTotEur
memvar nTotPnt
memvar nTotPes
memvar nTotCos
memvar nTotAge
memvar nTotTrn
memvar nTotRnt
memvar nTotDif
memvar nTotAtp
memvar nPctRnt
memvar aIvaUno
memvar aIvaDos
memvar aIvaTre
memvar aIvmUno
memvar aIvmDos
memvar aIvmTre
memvar nVdvDivAlb
memvar cPicUndAlb
memvar cPouDivAlb
memvar cPorDivAlb
memvar cPpvDivAlb
memvar cPouEurAlb
memvar nDouDivAlb
memvar nRouDivAlb
memvar nTotArt
memvar nTotCaj
memvar cPorDivEnt
memvar cDbfEnt
memvar nTotPage
memvar oStk
memvar nTotalDto

memvar lEnd
memvar nRow
memvar oInf
memvar nPagina
memvar oReport





static oWndBrw
static oBrwIva
static dbfUsr
static dbfAlbCliT
static dbfAlbCliL
static dbfAlbCliI
static dbfAlbCliD
static dbfAlbCliP
static dbfAlbCliS
static dbfProSer
static dbfMatSer
static dbfAlbPrvL
static dbfAlbPrvS
static dbfTmpLin
static dbfTmpInc
static dbfTmpDoc
static dbfTmpPgo
static dbfTmpSer
static dbfAntCliT
static dbfDelega
static dbfCount
static cTmpLin
static cTmpInc
static cTmpDoc
static cTmpPgo
static cTmpSer
static dbfInci
static dbfRuta
static dbfIva
static dbfClient
static dbfCliInc
static dbfCliBnc
static dbfArtPrv
static dbfAlm
static dbfFPago
static dbfAgent
static dbfTarPreL
static dbfTarPreS
static dbfPedCliT
static dbfPedCliL
static dbfPedCliR
static dbfPedCliP
static dbfPedCliI
static dbfPedCliD
static dbfFacCliT
static dbfFacCliL
static dbfFacCliS
static dbfFacCliP
static dbfFacRecT
static dbfFacRecL
static dbfFacRecS
static dbfPedPrvL
static dbfTikT
static dbfTikL
static dbfTikS
static dbfArticulo
static dbfCodebar
static dbfPromoT
static dbfPromoL
static dbfPromoC
static dbfCliAtp
static dbfTVta
static dbfTblPro
static dbfPro
static dbfCajT
static dbfFacPrvL
static dbfFacPrvS
static dbfRctPrvL
static dbfRctPrvS
static dbfProLin
static dbfProMat
static dbfHisMov
static dbfHisMovS
static dbfEmp
static oFont
static oMenu
static oStock
static oGrpCli
static oTrans
static oNewImp
static oUndMedicion
static dbfDiv
static oBandera
static dbfKit
static dbfDoc
static dbfFlt
static dbfTblCnv
static dbfOferta
static dbfObrasT
static dbfFamilia
static dbfArtDiv
static dbfUbicaL
static dbfAgeCom
static oGetTotal
static oGetIvm
static oGetRnt
static oGetMasDiv
static cGetMasDiv       := ""
static oGetNet
static oGetIva
static oGetReq
static oGetAge
static oComisionLinea
static nComisionLinea   := 0
static oGetTrn
static oGetPnt
static cPouDiv
static cPorDiv
static cPpvDiv
static cPouEur
static cPicUnd
static nVdvDiv
static nDouDiv
static nRouDiv
static nDorDiv
static nDpvDiv

static oTipArt
static oGrpFam
static oFraPub

static aNumPed          := {}
static oGetAlb
static oGetEnt
static oGetPdt
static oGetPes
static oGetDif
static nTotOld
static nNumCaj          := 0
static cOldCodCli       := ""
static cOldCodArt       := ""
static cOldPrpArt       := ""
static cOldUndMed       := ""
static lOpenFiles       := .F.
static lExternal        := .F.
static aTipAlb          := { "Venta", "Alquiler" }
static oTipAlb
static aAlbaranes       := {}
static cFiltroUsuario   := ""
static oTotAlbLin



static bEdtRec          := { | aTmp, aGet, dbfAlbCliT, oBrw, bWhen, bValid, nMode, cCodPed | EdtRec( aTmp, aGet, dbfAlbCliT, oBrw, bWhen, bValid, nMode, cCodPed ) }
static bEdtDet          := { | aTmp, aGet, dbfAlbCliL, oBrw, bWhen, bValid, nMode, aTmpAlb | EdtDet( aTmp, aGet, dbfAlbCliL, oBrw, bWhen, bValid, nMode, aTmpAlb ) }
static bEdtInc          := { | aTmp, aGet, dbfAlbCliI, oBrw, bWhen, bValid, nMode, aTmpLin | EdtInc( aTmp, aGet, dbfAlbCliI, oBrw, bWhen, bValid, nMode, aTmpLin ) }
static bEdtDoc          := { | aTmp, aGet, dbfAlbCliD, oBrw, bWhen, bValid, nMode, aTmpLin | EdtDoc( aTmp, aGet, dbfAlbCliD, oBrw, bWhen, bValid, nMode, aTmpLin ) }
static bEdtPgo          := { | aTmp, aGet, dbfAlbCliP, oBrw, bWhen, bValid, nMode, aTmpAlb | EdtEnt( aTmp, aGet, dbfAlbCliP, oBrw, bWhen, bValid, nMode, aTmpAlb ) }















STATIC FUNCTION OpenFiles()

   local oError
   local oBlock

   if lOpenFiles
      MsgStop( "Imposible abrir ficheros de albaranes de clientes" )
      Return ( .F. )
   end

   oBlock               := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE



      lOpenFiles        := .T.

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIT.DBF" ), ( cCheckArea( "ALBCLIT", @dbfAlbCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIL.DBF" ), ( cCheckArea( "ALBCLIL", @dbfAlbCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLII.DBF" ), ( cCheckArea( "ALBCLII", @dbfAlbCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLID.DBF" ), ( cCheckArea( "ALBCLID", @dbfAlbCliD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLID.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIP.DBF" ), ( cCheckArea( "ALBCLIP", @dbfAlbCliP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIS.DBF" ), ( cCheckArea( "ALBCLIS", @dbfAlbCliS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIT.DBF" ), ( cCheckArea( "PEDCLIT", @dbfPedCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIL.DBF" ), ( cCheckArea( "PEDCLIL", @dbfPedCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIR.DBF" ), ( cCheckArea( "PEDCLIR", @dbfPedCliR ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIR.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIP.DBF" ), ( cCheckArea( "PEDCLIP", @dbfPedCliP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLII.DBF" ), ( cCheckArea( "PEDCLII", @dbfPedCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLID.DBF" ), ( cCheckArea( "PEDCLID", @dbfPedCliD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLID.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKET.DBF" ), ( cCheckArea( "TIKET", @dbfTikT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKET.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cNumDoc" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKEL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKES.DBF" ), ( cCheckArea( "TIKES", @dbfTikS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfClient ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CliInc.Dbf" ), ( cCheckArea( "CliInc", @dbfCliInc ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "CliInc.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CliBnc.Dbf" ), ( cCheckArea( "CLIBNC", @dbfCliBnc ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "CliBnc.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROVART.DBF" ), ( cCheckArea( "PROVART", @dbfArtPrv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROVART.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatGrp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatGrp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CliAtp.Dbf" ), ( cCheckArea( "CLIATP", @dbfCliAtp ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "CliAtp.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "AGENTES.DBF" ), ( cCheckArea( "AGENTES", @dbfAgent ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "AGENTES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TARPREL.DBF" ), ( cCheckArea( "TARPREL", @dbfTarPreL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TARPREL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TARPRES.DBF" ), ( cCheckArea( "TARPRES", @dbfTarPreS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TARPRES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROMOT.DBF" ), ( cCheckArea( "PROMOT", @dbfPromoT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROMOT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROMOL.DBF" ), ( cCheckArea( "PROMOL", @dbfPromoL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROMOL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROMOC.DBF" ), ( cCheckArea( "PROMOC", @dbfPromoC ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROMOC.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ArtCodebar.Dbf" ), ( cCheckArea( "CODEBAR", @dbfCodebar ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ArtCodebar.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTKIT.DBF" ), ( cCheckArea( "ARTTIK", @dbfKit ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTKIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TVTA.DBF" ), ( cCheckArea( "TVTA", @dbfTVta ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TVTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "CNFFLT.DBF" ), ( cCheckArea( "CNFFLT", @dbfFlt ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "CNFFLT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RDOCUMEN.DBF" ), ( cCheckArea( "RDOCUMEN", @dbfDoc ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RDOCUMEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CTIPO" )

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TBLCNV.DBF" ), ( cCheckArea( "TBLCNV", @dbfTblCnv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TBLCNV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "OFERTA.DBF" ), ( cCheckArea( "OFERTA", @dbfOferta ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "OFERTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "ObrasT.Dbf" ), ( cCheckArea( "OBRAST", @dbfObrasT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "ObrasT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PRO.DBF" ), ( cCheckArea( "PRO", @dbfPro ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TBLPRO.DBF" ), ( cCheckArea( "TBLPRO", @dbfTblPro ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TBLPRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "RUTA.DBF" ), ( cCheckArea( "RUTA", @dbfRuta ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "RUTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTDIV.DBF" ), ( cCheckArea( "ARTDIV", @dbfArtDiv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTDIV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "Cajas.Dbf" ), ( cCheckArea( "CAJAS", @dbfCajT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "Cajas.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatAlm() + "Almacen.Dbf" ), ( cCheckArea( "ALMACEN", @dbfAlm ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatAlm() + "Almacen.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "USERS.DBF" ), ( cCheckArea( "USERS", @dbfUsr ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "USERS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIPINCI.DBF" ), ( cCheckArea( "TIPINCI", @dbfInci ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIPINCI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DELEGA.DBF" ), ( cCheckArea( "DELEGA", @dbfDelega ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DELEGA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "NCOUNT.DBF" ), ( cCheckArea( "NCOUNT", @dbfCount ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "NCOUNT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatAlm() + "UBICAL.DBF" ), ( cCheckArea( "UBICAL", @dbfUbicaL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatAlm() + "UBICAL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatGrp() + "AGECOM.DBF" ), ( cCheckArea( "AGECOM", @dbfAgeCom ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatGrp() + "AGECOM.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIT.DBF" ), ( cCheckArea( "FACCLIT", @dbfFacCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIL.DBF" ), ( cCheckArea( "FACCLIL", @dbfFacCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIS.DBF" ), ( cCheckArea( "FACCLIS", @dbfFacCliS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACRECT.DBF" ), ( cCheckArea( "FACRECT", @dbfFacRecT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACRECT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACRECL.DBF" ), ( cCheckArea( "FACRECL", @dbfFacRecL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACRECL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACRECS.DBF" ), ( cCheckArea( "FACRECS", @dbfFacRecS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACRECS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "EMPRESA.DBF" ), ( cCheckArea( "EMPRESA", @dbfEmp ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "EMPRESA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVL.DBF" ), ( cCheckArea( "ALBPROVL", @dbfAlbPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cStkFast" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPRVS.DBF" ), ( cCheckArea( "ALBPRVS", @dbfAlbPrvS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPRVS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @dbfFacPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVS.DBF" ), ( cCheckArea( "FACPRVS", @dbfFacPrvS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "RctPrvL", @dbfRctPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvS.DBF" ), ( cCheckArea( "RctPrvS", @dbfRctPrvS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROLIN.DBF" ), ( cCheckArea( "PROLIN", @dbfProLin ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROLIN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMAT.DBF" ), ( cCheckArea( "PROMAT", @dbfProMat ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMAT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "HISMOV.DBF" ), ( cCheckArea( "HISMOV", @dbfHisMov ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "HISMOV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRefMov" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "MOVSER.DBF" ), ( cCheckArea( "MOVSER", @dbfHisMovS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "MOVSER.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDPROVL.DBF" ), ( cCheckArea( "PedPrvL", @dbfPedPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliP.Dbf" ), ( cCheckArea( "FacCliP", @dbfFacCliP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliP.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROSER.DBF" ), ( cCheckArea( "PROSER", @dbfProSer ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROSER.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "MATSER.DBF" ), ( cCheckArea( "MATSER", @dbfMatSer ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "MATSER.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      oBandera             := TBandera():New()

      oStock               := TStock():Create( cPatGrp() )
      if !oStock:lOpenFiles()
         lOpenFiles        := .F.
      else
         oStock:cKit       := dbfKit

         oStock:cPedCliT   := dbfPedCliT
         oStock:cPedCliL   := dbfPedCliL
         oStock:cPedCliR   := dbfPedCliR

         oStock:cAlbCliT   := dbfAlbCliT
         oStock:cAlbCliL   := dbfAlbCliL
         oStock:cAlbCliS   := dbfAlbCliS

         oStock:cFacCliT   := dbfFacCliT
         oStock:cFacCliL   := dbfFacCliL
         oStock:cFacCliS   := dbfFacCliS
         oStock:cFacCliP   := dbfFacCliP

         oStock:cAntCliT   := dbfAntCliT
         oStock:cFacRecT   := dbfFacRecT
         oStock:cFacRecL   := dbfFacRecL
         oStock:cFacRecS   := dbfFacRecS

         oStock:cTikT      := dbfTikT
         oStock:cTikL      := dbfTikL
         oStock:cTikS      := dbfTikS

         oStock:cProducL   := dbfProLin
         oStock:cProducM   := dbfProMat
         oStock:cProducS   := dbfProSer
         oStock:cProducP   := dbfMatSer

         oStock:cHisMov    := dbfHisMov
         oStock:cHisMovS   := dbfHisMovS

         oStock:cPedPrvL   := dbfPedPrvL

         oStock:cAlbPrvL   := dbfAlbPrvL
         oStock:cAlbPrvS   := dbfAlbPrvS

         oStock:cFacPrvL   := dbfFacPrvL
         oStock:cFacPrvS   := dbfFacPrvS

         oStock:cRctPrvL   := dbfRctPrvL
         oStock:cRctPrvS   := dbfRctPrvS

      end

      oGrpCli           := TGrpCli():Create( cPatCli() )
      if !oGrpCli:OpenFiles()
         lOpenFiles     := .F.
      end

      oNewImp           := TNewImp():Create( cPatEmp() )
      if !oNewImp:OpenFiles()
         lOpenFiles     := .F.
      end

      oTrans            := TTrans():Create( cPatCli() )
      if !oTrans:OpenFiles()
         lOpenFiles     := .F.
      end

      oTipArt           := TTipArt():Create( cPatArt() )
      if !oTipArt:OpenFiles()
         lOpenFiles     := .F.
      end

      oGrpFam           := TGrpFam():Create( cPatArt() )
      if !oGrpFam:OpenFiles()
         lOpenFiles     := .F.
      end

      oUndMedicion      := UniMedicion():Create( cPatGrp() )
      if !oUndMedicion:OpenFiles()
         lOpenFiles     := .F.
      end

      oFraPub           := TFrasesPublicitarias():Create( cPatArt() )
      if !oFraPub:OpenFiles()
         lOpenFiles     := .F.
      end





      public nTotBrt    := 0
      public nTotAlb    := 0
      public nTotDto    := 0
      public nTotDPP    := 0
      public nTotNet    := 0
      public nTotIva    := 0
      public nTotIvm    := 0
      public nTotAge    := 0
      public nTotReq    := 0
      public nTotPnt    := 0
      public nTotUno    := 0
      public nTotDos    := 0
      public nTotCos    := 0
      public nTotPes    := 0
      public nTotDif    := 0
      public nTotAtp    := 0
      public nTotTrn    := 0
      public nPctRnt    := 0
      public nTotRnt    := 0

      public aTotIva    := { { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 } }
      public aIvaUno    := aTotIva[ 1 ]
      public aIvaDos    := aTotIva[ 2 ]
      public aIvaTre    := aTotIva[ 3 ]

      public aTotIvm    := { { 0,nil,0 }, { 0,nil,0 }, { 0,nil,0 }, }
      public aIvmUno    := aTotIvm[ 1 ]
      public aIvmDos    := aTotIvm[ 2 ]
      public aIvmTre    := aTotIvm[ 3 ]

      public nTotPag    := 0

      public nTotArt    := 0
      public nTotCaj    := 0





      if oUser():lFiltroVentas()
         cFiltroUsuario    := "Field->cCodUsr == '" + oUser():cCodigo() + "' .and. Field->cCodCaj == '" + oUser():cCaja() + "'"
      end



   RECOVER USING oError

      lOpenFiles        := .F.



      msgStop( "Imposible abrir todas las bases de datos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   if !lOpenFiles
      CloseFiles()
   end

Return ( lOpenFiles )



STATIC FUNCTION CloseFiles()

   DisableAcceso()

   DestroyFastFilter( dbfAlbCliT, .T., .T. )

   if !Empty( oFont )
      oFont:end()
   end

   if !Empty( dbfAlbCliT )
      ( dbfAlbCliT )->( dbCloseArea() )
   end

   if !Empty( dbfClient )
      ( dbfClient    )->( dbCloseArea() )
   end
   if !Empty( dbfIva )
      ( dbfIva       )->( dbCloseArea() )
   end
   if !Empty( dbfFPago )
      ( dbfFPago     )->( dbCloseArea() )
   end
   if !Empty( dbfAlbCliL )
      ( dbfAlbCliL   )->( dbCloseArea() )
   end
   if !Empty( dbfAlbCliI )
      ( dbfAlbCliI   )->( dbCloseArea() )
   end
   if !Empty( dbfAlbCliD )
      ( dbfAlbCliD   )->( dbCloseArea() )
   end
   if !Empty( dbfAlbCliP )
      ( dbfAlbCliP   )->( dbCloseArea() )
   end
   if !Empty( dbfAlbCliS )
      ( dbfAlbCliS   )->( dbCloseArea() )
   end
   if !Empty( dbfTikT )
      ( dbfTikT      )->( dbCloseArea() )
   end
   if !Empty( dbfPedCliT )
      ( dbfPedCliT   )->( dbCloseArea() )
   end
   if !Empty( dbfPedCliL )
      ( dbfPedCliL   )->( dbCloseArea() )
   end
   if !Empty( dbfPedCliR )
      ( dbfPedCliR   )->( dbCloseArea() )
   end
   if !Empty( dbfPedCliP )
      ( dbfPedCliP   )->( dbCloseArea() )
   end
   if !Empty( dbfPedCliI )
      ( dbfPedCliI   )->( dbCloseArea() )
   end
   if !Empty( dbfPedCliD )
      ( dbfPedCliD   )->( dbCloseArea() )
   end
   if !Empty( dbfAgent )
      ( dbfAgent     )->( dbCloseArea() )
   end
   if !Empty( dbfTarPreL )
      ( dbfTarPreL   )->( dbCloseArea() )
   end
   if !Empty( dbfTarPreS )
      ( dbfTarPreS   )->( dbCloseArea() )
   end
   if !Empty( dbfPromoT )
      ( dbfPromoT    )->( dbCloseArea() )
   end
   if !Empty( dbfPromoL )
      ( dbfPromoL    )->( dbCloseArea() )
   end
   if !Empty( dbfPromoC )
      ( dbfPromoC    )->( dbCloseArea() )
   end
   if !Empty( dbfArticulo )
      ( dbfArticulo  )->( dbCloseArea() )
   end
   if !Empty( dbfCodebar )
      ( dbfCodebar   )->( dbCloseArea() )
   end
   if !Empty( dbfFamilia )
      ( dbfFamilia   )->( dbCloseArea() )
   end
   if !Empty( dbfKit )
      ( dbfKit       )->( dbCloseArea() )
   end
   if !Empty( dbfFlt )
      ( dbfFlt       )->( dbCloseArea() )
   end
   if !Empty( dbfAlm )
      ( dbfAlm       )->( dbCloseArea() )
   end
   if !Empty( dbfCliAtp )
      ( dbfCliAtp    )->( dbCloseArea() )
   end
   if !Empty( dbfTVta )
      ( dbfTVta      )->( dbCloseArea() )
   end
   if !Empty( dbfDiv )
      ( dbfDiv       )->( dbCloseArea() )
   end
   if !Empty( dbfDoc )
      ( dbfDoc       )->( dbCloseArea() )
   end
   if !Empty( dbfTblCnv )
      ( dbfTblCnv    )->( dbCloseArea() )
   end
   if !Empty( dbfOferta )
      ( dbfOferta    )->( dbCloseArea() )
   end
   if !Empty( dbfObrasT )
      ( dbfObrasT    )->( dbCloseArea() )
   end
   if !Empty( dbfPro )
      ( dbfPro       )->( dbCloseArea() )
   end
   if !Empty( dbfTblPro )
      ( dbfTblPro    )->( dbCloseArea() )
   end
   if !Empty( dbfRuta )
      ( dbfRuta      )->( dbCloseArea() )
   end
   if !Empty( dbfArtDiv )
      ( dbfArtDiv    )->( dbCloseArea() )
   end
   if !Empty( dbfCajT )
      ( dbfCajT )->( dbCloseArea() )
   end
   if !Empty( dbfUsr )
      ( dbfUsr )->( dbCloseArea() )
   end
   if dbfInci <> nil
      ( dbfInci )->( dbCloseArea() )
   end
   if dbfArtPrv <> nil
      ( dbfArtPrv )->( dbCloseArea() )
   end
   if dbfAntCliT <> nil
      ( dbfAntCliT )->( dbCloseArea() )
   end
   if dbfDelega <> nil
      ( dbfDelega )->( dbCloseArea() )
   end
   if dbfCount <> nil
      ( dbfCount )->( dbCloseArea() )
   end
   if dbfUbicaL <> nil
      ( dbfUbicaL )->( dbCloseArea() )
   end
   if dbfAgeCom <> nil
      ( dbfAgeCom )->( dbCloseArea() )
   end
   if dbfFacCliT <> nil
      ( dbfFacCliT )->( dbCloseArea() )
   end
   if dbfFacCliL <> nil
      ( dbfFacCliL )->( dbCloseArea() )
   end
   if dbfFacCliS <> nil
      ( dbfFacCliS )->( dbCloseArea() )
   end
   if dbfFacCliP <> nil
      ( dbfFacCliP )->( dbCloseArea() )
   end
   if dbfFacRecT <> nil
      ( dbfFacRecT )->( dbCloseArea() )
   end
   if dbfFacRecL <> nil
      ( dbfFacRecL )->( dbCloseArea() )
   end
   if dbfFacRecS <> nil
      ( dbfFacRecS )->( dbCloseArea() )
   end
   if dbfTikT <> nil
      ( dbfTikT )->( dbCloseArea() )
   end
   if dbfTikL <> nil
      ( dbfTikL )->( dbCloseArea() )
   end
   if dbfTikS <> nil
      ( dbfTikS )->( dbCloseArea() )
   end
   if dbfEmp <> nil
      ( dbfEmp )->( dbCloseArea() )
   end
   if dbfProLin <> nil
      ( dbfProLin )->( dbCloseArea() )
   end
   if dbfProMat <> nil
      ( dbfProMat )->( dbCloseArea() )
   end
   if dbfProSer <> nil
      ( dbfProSer )->( dbCloseArea() )
   end
   if dbfMatSer <> nil
      ( dbfMatSer )->( dbCloseArea() )
   end
   if dbfHisMov <> nil
      ( dbfHisMov )->( dbCloseArea() )
   end
   if dbfHisMovS <> nil
      ( dbfHisMovS )->( dbCloseArea() )
   end
   if dbfAlbPrvL <> nil
      ( dbfAlbPrvL )->( dbCloseArea() )
   end
   if dbfAlbPrvS <> nil
      ( dbfAlbPrvS )->( dbCloseArea() )
   end
   if dbfFacPrvL <> nil
      ( dbfFacPrvL )->( dbCloseArea() )
   end
   if dbfFacPrvS <> nil
      ( dbfFacPrvS )->( dbCloseArea() )
   end
   if dbfRctPrvL <> nil
      ( dbfRctPrvL )->( dbCloseArea() )
   end
   if dbfRctPrvS <> nil
      ( dbfRctPrvS )->( dbCloseArea() )
   end
   if dbfCliInc <> nil
      ( dbfCliInc )->( dbCloseArea() )
   end
   if dbfPedPrvL <> nil
      ( dbfPedPrvL )->( dbCloseArea() )
   end
   if !Empty( dbfCliBnc  )
      ( dbfCliBnc  )->( dbCloseArea() )
   end

   if !Empty( oStock )
      oStock:end()
   end
   if !Empty( oGrpCli )
      oGrpCli:end()
   end
   if !Empty( oNewImp )
      oNewImp:end()
   end
   if !Empty( oTrans )
      oTrans:end()
   end
   if !Empty( oTipArt )
      oTipArt:end()
   end
   if !Empty( oGrpFam )
      oGrpFam:end()
   end
   if !Empty( oUndMedicion )
      oUndMedicion:end()
   end
   if !Empty( oFraPub )
      oFraPub:end()
   end

   dbfClient      := nil
   dbfIva         := nil
   dbfAlbCliL     := nil
   dbfAlbCliT     := nil
   dbfAlbCliI     := nil
   dbfAlbCliD     := nil
   dbfAlbCliP     := nil
   dbfAlbCliS     := nil
   dbfPedCliT     := nil
   dbfPedCliL     := nil
   dbfPedCliR     := nil
   dbfPedCliP     := nil
   dbfPedCliI     := nil
   dbfPedCliD     := nil
   dbfTikT        := nil
   dbfFPago       := nil
   dbfAgent       := nil
   dbfAlm         := nil
   dbfTarPreL     := nil
   dbfTarPreS     := nil
   dbfPromoT      := nil
   dbfPromoL      := nil
   dbfPromoC      := nil
   dbfArticulo    := nil
   dbfCodebar     := nil
   dbfFamilia     := nil
   dbfKit         := nil
   dbfCliAtp      := nil
   dbfTVta        := nil
   dbfDiv         := nil
   oBandera       := nil
   dbfDoc         := nil
   dbfTblCnv      := nil
   dbfOferta      := nil
   dbfObrasT      := nil
   dbfPro         := nil
   dbfFlt         := nil
   dbfTblPro      := nil
   dbfRuta        := nil
   dbfArtDiv      := nil
   dbfCajT        := nil
   dbfUsr         := nil
   dbfInci        := nil
   dbfArtPrv      := nil
   dbfAntCliT     := nil
   dbfDelega      := nil
   dbfCount       := nil
   dbfUbicaL      := nil
   dbfAgeCom      := nil
   dbfFacCliT     := nil
   dbfFacCliL     := nil
   dbfFacCliS     := nil
   dbfFacRecT     := nil
   dbfFacRecL     := nil
   dbfTikT        := nil
   dbfTikL        := nil
   dbfTikS        := nil
   dbfEmp         := nil
   dbfProLin      := nil
   dbfProMat      := nil
   dbfHisMov      := nil
   dbfHisMovS     := nil
   dbfAlbPrvL     := nil
   dbfCliInc      := nil
   dbfPedPrvL     := nil
   dbfCliBnc      := nil

   oStock         := nil
   oGrpCli        := nil
   oNewImp        := nil
   oTrans         := nil
   oTipArt        := nil
   oGrpFam        := nil
   oUndMedicion   := nil
   oFraPub        := nil

   lOpenFiles     := .F.

   oWndBrw        := nil

   EnableAcceso()

Return .T.



STATIC FUNCTION GenAlbCli( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local oDevice
   local cAlbaran

   if ( dbfAlbCliT )->( Lastrec() ) == 0
      Return nil
   end

   cAlbaran             := ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb

   IIF( nDevice == nil, nDevice := 1, ) ;
   IIF( cCaption == nil, cCaption := "Imprimiendo albaranes a clientes", ) ;
   IIF( cCodDoc == nil, cCodDoc := cFormatoDocumento( ( dbfAlbCliT )->cSerAlb, "nAlbCli", dbfCount ), ) ;
   IIF( nCopies == nil, nCopies := if( nCopiasDocumento( ( dbfAlbCliT )->cSerAlb, "nAlbCli", dbfCount ) == 0, Max( Retfld( ( dbfAlbCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( ( dbfAlbCliT )->cSerAlb, "nAlbCli", dbfCount ) ), ) ;

   if Empty( cCodDoc )
      cCodDoc           := cFirstDoc( "AC", dbfDoc )
   end

   if !lExisteDocumento( cCodDoc, dbfDoc )
      return nil
   end





   if !Empty( oAuditor() )
      if nDevice == 1
         oAuditor():AddEvent( "Impreso albaran a clientes",    cAlbaran, "10" )
      else
         oAuditor():AddEvent( "Previsualizado albaran a clientes",  cAlbaran, "10" )
      end
   end





   if lVisualDocumento( cCodDoc, dbfDoc )

      PrintReportAlbCli( nDevice, nCopies, cPrinter, dbfDoc )

   else





      nTotAlbCli( cAlbaran, dbfAlbCliT, dbfAlbCliL, dbfIva, dbfDiv )
      nPagAlbCli( cAlbaran, dbfAlbCliP, dbfDiv )





      ( dbfAlbCliL )->( dbSeek( cAlbaran ) )
      ( dbfAlbCliP )->( dbSeek( cAlbaran ) )





      ( dbfClient)->( dbSeek( ( dbfAlbCliT )->cCodCli ) )
      ( dbfAgent )->( dbSeek( ( dbfAlbCliT )->cCodAge ) )
      ( dbfFPago )->( dbSeek( ( dbfAlbCliT )->cCodPago) )
      ( dbfObrasT)->( dbSeek( ( dbfAlbCliT )->cCodCli + ( dbfAlbCliT )->cCodObr ) )
      ( dbfDelega)->( dbSeek( ( dbfAlbCliT )->cCodDlg ) )

      oTrans:oDbf:Seek( ( dbfAlbCliT )->cCodTrn )

      private oInf
      private cDbf         := dbfAlbCliT
      private cDbfCol      := dbfAlbCliL
      private cDbfPag      := dbfAlbCliP
      private cCliente     := dbfClient
      private cDbfCli      := dbfClient
      private cDbfDiv      := dbfDiv
      private cIva         := dbfIva
      private cDbfIva      := dbfIva
      private cFPago       := dbfFPago
      private cDbfPgo      := dbfFPago
      private cAgent       := dbfAgent
      private cDbfAge      := dbfAgent
      private cTvta        := dbfTvta
      private cObras       := dbfObrasT
      private cDbfObr      := dbfObrasT
      private cTarPreL     := dbfTarPreL
      private cTarPreS     := dbfTarPreS
      private cDbfRut      := dbfRuta
      private cDbfUsr      := dbfUsr
      private cDbfAnt      := dbfAntCliT
      private cDbfDlg      := dbfDelega
      private cDbfTrn      := oTrans:GetAlias()
      private cDbfPro      := dbfPro
      private cDbfTblPro   := dbfTblPro

      private nTotPage     := nTotLAlbCli( dbfAlbCliL )
      private nVdvDivAlb   := nVdvDiv
      private cPicUndAlb   := cPicUnd
      private cPouDivAlb   := cPouDiv
      private cPorDivAlb   := cPorDiv
      private cPpvDivAlb   := cPpvDiv
      private cPouEurAlb   := cPouEur
      private nDouDivAlb   := nDouDiv
      private nRouDivAlb   := nRouDiv

      private nTotCaj      := nNumCaj

      private oStk         := oStock





      if !Empty( cPrinter )
         oDevice           := TPrinter():New( cCaption, .F., .T., cPrinter )
         oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .F.,, oDevice, cCaption,,, )
      else
         oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .T.,,, cCaption,,, )
      end

      if !Empty( oInf ) .AND. oInf:lCreated

         oInf:lAutoland    := .F.
         oInf:lFinish      := .F.
         oInf:lNoCancel    := .T.
         oInf:bSkip        := {|| AlbCliReportSkipper( dbfAlbCliL ) }

         oInf:oDevice:lPrvModal  := .T.

         do case
            case nDevice == 1

               oInf:oDevice:SetCopies( nCopies )

               oInf:bPreview  := {| oDevice | PrintPreview( oDevice ) }

            case nDevice == 3

               oInf:bPreview  := {| oDevice | PrintPdf( oDevice ) }

         end

         SetMargin( cCodDoc, oInf )
         PrintColum( cCodDoc, oInf )

      else

         MsgStop( "No se ha podido crear el documento " + cCodDoc )

      end

      RptEnd()

      if !Empty( oInf )

         private oReport   := oInf




         oInf:Activate({||         ( !( dbfAlbCliL )->lImpLin )}, {||       ( ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb == cAlbaran .AND. !( dbfAlbCliL )->( Eof() ) )},,,, {||  ( ePage( oInf, cCodDoc ) )},,,,,,,, )

            if nDevice == 1
               oInf:oDevice:end()
            end

      end

      oInf                 := nil

   end





   lChgImpDoc( dbfAlbCliT )

Return nil



Static Function AlbCliReportSkipper( dbfAlbCliL )

   ( dbfAlbCliL )->( dbSkip() )

   nTotPage              += nTotLAlbCli( dbfAlbCliL )

Return nil



STATIC FUNCTION EPage( oInf, cCodDoc )

    private nPagina        := oInf:nPage
    private lEnd            := oInf:lFinish
   private nRow         := oInf:nRow

   PrintItems( cCodDoc, oInf )

RETURN NIL



FUNCTION AlbCli( oMenuItem, oWnd, cCodCli, cCodArt, cCodPed )

   local oRpl
   local oSnd
   local oPrv
   local oImp
   local oDel
   local oPdf
   local oMail
   local oDup
   local oBtnEur
   local nLevel
   local oRotor
   local lEuro          := .F.

   IIF( oMenuItem == nil, oMenuItem := "01057", ) ;
   IIF( oWnd == nil, oWnd := oWnd(), ) ;
   IIF( cCodCli == nil, cCodCli := "", ) ;
   IIF( cCodArt == nil, cCodArt := "", ) ;
   IIF( cCodPed == nil, cCodPed := "", ) ;

   nLevel               := nLevelUsr( oMenuItem )
   if nAnd( nLevel, 1 ) <> 0
      msgStop( "Acceso no permitido." )
      return .F.
   end





   if oWnd <> nil
      oWnd:CloseAll()
   end

   if !OpenFiles()
      return .F.
   end

   DisableAcceso()





















   oWndBrw := TShell():New( 0, 0, 22, 80, "Albaranes de clientes",, oWnd,,, .F.,,, ( dbfAlbCliT ),,,,, {"Número", "Fecha", "Código", "Nombre", "Obra", "Agente", "Su albarán", "Facturado"}, {||( WinAppRec( oWndBrw:oBrw, bEdtRec, dbfAlbCliT, cCodCli, cCodArt, cCodPed ) )}, {||( WinEdtRec( oWndBrw:oBrw, bEdtRec, dbfAlbCliT, cCodCli, cCodArt, cCodPed ) )}, {||( WinDelRec( oWndBrw:oBrw, dbfAlbCliT, {|| QuiAlbCli() } ) )}, {||( WinDupRec( oWndBrw:oBrw, bEdtRec, dbfAlbCliT, cCodCli, cCodArt, cCodPed ) )}, nil, nLevel, "Document_plain_user1_16", ( 104 + ( 0 * 256 ) + ( 63 * 65536 ) ),, {||( WinZooRec( oWndBrw:oBrw, bEdtRec, dbfAlbCliT ) )}, .T. )

      oWndBrw:lFechado     := .T.

      oWndBrw:bChgIndex    := {|| if( oUser():lFiltroVentas(), CreateFastFilter( cFiltroUsuario, dbfAlbCliT, .F., , cFiltroUsuario ), CreateFastFilter( "", dbfAlbCliT, .F. ) ) }

      oWndBrw:SetYearComboBoxChange( {|| YearComboBoxChange() } )

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión cerrada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfAlbCliT )->lCloAlb }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Zoom16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Facturado"
         :nHeadBmpNo       := 3
         :cSortOrder       := "lFacturado"
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfAlbCliT )->lFacturado }
         :nWidth           := 20
         :SetCheck( { "Bullet_Square_Green_16", "Bullet_Square_Red_16" } )
         :AddResource( "trafficlight_on_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfAlbCliT )->lSndDoc }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Lbl16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Entregado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfAlbCliT )->lEntregado }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "hand_paper_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Incidencia"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nEstadoIncidencia( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb ) }
         :nWidth           := 20
         :lHide            := .T.
         :AddResource( "Bullet_Square_Red_16" )
         :AddResource( "Bullet_Square_Yellow_16" )
         :AddResource( "Bullet_Square_Green_16" )
         :AddResource( "informacion_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Impreso"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfAlbCliT )->lImprimido }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "IMP16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Tipo"
         :bEditValue       := {|| aTipAlb[ if( ( dbfAlbCliT )->lAlquiler, 2, 1 ) ] }
         :nWidth           := 50
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumAlb"
         :bEditValue       := {|| ( dbfAlbCliT )->cSerAlb + "/" + Alltrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + "/" + ( dbfAlbCliT )->cSufAlb }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :bEditValue       := {|| ( dbfAlbCliT )->cCodDlg }
         :nWidth           := 20
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión"
         :bEditValue       := {|| Trans( ( dbfAlbCliT )->cTurAlb, "######" ) }
         :nWidth           := 40
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecAlb"
         :bEditValue       := {|| Dtoc( ( dbfAlbCliT )->dFecAlb ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( dbfAlbCliT )->cCodCaj }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Usuario"
         :bEditValue       := {|| ( dbfAlbCliT )->cCodUsr }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| AllTrim( ( dbfAlbCliT )->cCodCli ) }
         :nWidth           := 70
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| ( dbfAlbCliT )->cNomCli }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Su albarán"
         :cSortOrder       := "cCodSuAlb"
         :bEditValue       := {|| ( dbfAlbCliT )->cCodSuAlb }
         :nWidth           := 40
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Agente"
         :cSortOrder       := "cCodAge"
         :bEditValue       := {|| ( dbfAlbCliT )->cCodAge }
         :nWidth           := 50
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Ruta"
         :bEditValue       := {|| ( dbfAlbCliT )->cCodRut }
         :nWidth           := 40
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Almacén"
         :bEditValue       := {|| ( dbfAlbCliT )->cCodAlm }
         :nWidth           := 60
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Obra"
         :cSortOrder       := "cObra"
         :bEditValue       := {|| ( dbfAlbCliT )->cCodObr }
         :nWidth           := 40
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Su pedido"
         :cSortOrder       := "cSuPed"
         :bEditValue       := {|| ( dbfAlbCliT )->cSuPed }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end


      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( dbfAlbCliT )->nTotNet }
         :cEditPicture     := cPorDiv( ( dbfAlbCliT )->cDivAlb, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( dbfAlbCliT )->nTotIva }
         :cEditPicture     := cPorDiv( ( dbfAlbCliT )->cDivAlb, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "R.E."
         :bEditValue       := {|| ( dbfAlbCliT )->nTotReq }
         :cEditPicture     := cPorDiv( ( dbfAlbCliT )->cDivAlb, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( dbfAlbCliT )->nTotAlb }
         :cEditPicture     := cPorDiv( ( dbfAlbCliT )->cDivAlb, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( if( lEuro, cDivChg(), ( dbfAlbCliT )->cDivAlb ), dbfDiv ) }
         :nWidth           := 30
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end


      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Entregado"
         :bEditValue       := {|| ( dbfAlbCliT )->nTotPag }
         :cEditPicture     := cPorDiv( ( dbfAlbCliT )->cDivAlb, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total und."
         :bEditValue       := {|| nTotalUnd( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb, dbfAlbCliL, MasUnd() ) }
         :nWidth           := 95
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      oWndBrw:CreateXFromCode()





   oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

   oWndBrw:AddSeaBar()








   oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )







   oDup := oWndBrw:NewAt( "DUP",,, {||( oWndBrw:RecDup() )}, "(D)uplicar", "D",, {|This|This:Toggle()}, 2,, .F. )









      oWndBrw:NewAt( "Dup",,, {||( DupSerie( oWndBrw ) )}, "Series",,,, 2, oDup, .F. )









   oWndBrw:NewAt( "EDIT",,, {||( oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )







   oWndBrw:NewAt( "ZOOM",,, {||( oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 8,, .F. )






   oDel := oWndBrw:NewAt( "DEL",,, {||( WinDelRec( oWndBrw:oBrw, dbfAlbCliT, {|| QuiAlbCli() } ) )}, "(E)liminar", "E",,, 16,, .F. )























      oWndBrw:NewAt( "DEL",,, {||( DelSerie( oWndBrw ) )}, "Series",,,, 16, oDel, .F. )







   oImp := oWndBrw:NewAt( "IMP",,, {||( GenAlbCli( 1 ), oWndBrw:Refresh() )}, "(I)mprimir", "I",, {|This|This:Toggle()}, 32,, .F. )


      lGenAlbCli( oWndBrw:oBrw, oImp, 1 )





   oWndBrw:NewAt( "SERIE1",,, {||( PrnSerie(), oWndBrw:Refresh() )}, "Imp(r)imir series", "R",,, 32,, .F. )







   oPrv := oWndBrw:NewAt( "PREV1",,, {||( GenAlbCli( 2 ), oWndBrw:Refresh() )}, "(P)revisualizar", "P",, {|This|This:Toggle()}, 32,, .F. )


      lGenAlbCli( oWndBrw:oBrw, oPrv, 2 )






   oPdf := oWndBrw:NewAt( "DOCLOCK",,, {||( GenAlbCli( 3 ) )}, "Pd(f)", "F",, {|This|This:Toggle()}, 32,, .F. )


      lGenAlbCli( oWndBrw:oBrw, oPdf, 3 )





   oMail := oWndBrw:NewAt( "Mail",,, {||( GenAlbCli( 6 ) )}, "Correo electrónico",,, {|This|This:Toggle()}, 32,, .F. )


      lGenAlbCli( oWndBrw:oBrw, oMail, 6 )





   oWndBrw:NewAt( "Money2_",,, {||( If( !( dbfAlbCliT )->lFacturado, WinAppRec( oWndBrw:oBrw, bEdtPgo, dbfAlbCliP ), MsgStop( "El albarán ya fue facturado." ) ) )}, "Entregas a (c)uenta", "C",,, 2,, .F. )

   if oUser():lAdministrador()






      oWndBrw:NewAt( "GENFAC",,, {||( GenFCli( oWndBrw:oBrw, dbfAlbCliT, dbfAlbCliL, dbfAlbCliP, dbfAlbCliS, dbfClient, dbfCliAtp, dbfIva, dbfDiv, dbfFPago, dbfUsr, dbfCount, oGrpCli, oStock ) )}, "(G)enerar facturas", "G",,, 2,, .F. )






      oWndBrw:NewAt( "CHGSTATE",,, {||( if( ApoloMsgNoYes(  "¿ Está seguro de cambiar el estado del documento ?", "Elija una opción" ), SetFacturadoAlbaranCliente( !( dbfAlbCliT )->lFacturado, oWndBrw:oBrw ), ) )}, "Cambiar Es(t)ado", "T",,, 4,, .F. )

   end






   oWndBrw:NewAt( "Sel",,, {||( SelSend( oWndBrw:oBrw ) )}, "Entregad(o)", "O",,, 2,, .F. )








   oSnd := oWndBrw:NewAt( "LBL",, "Seleccionar albaranes para ser enviados", {||lSnd( oWndBrw, dbfAlbCliT )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, dbfAlbCliT, "lSndDoc", .T., .T., .T. ) )}, "Todos",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, dbfAlbCliT, "lSndDoc", .F., .T., .T. ) )}, "Ninguno",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, dbfAlbCliT, "lSndDoc", .T., .F., .T. ) )}, "Abajo",,,, 4, oSnd, .F. )





   oBtnEur := oWndBrw:NewAt( "BAL_EURO",,, {||( lEuro := !lEuro, oWndBrw:Refresh() )}, "M(o)neda", "O",,,,, .F. )

   if oUser():lAdministrador()






      oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( TDlgFlt():New( aItmAlbCli(), dbfAlbCliT ):ChgFields(), oWndBrw:Refresh() )}, "Cambiar campos",,, {|This|This:Toggle()}, 4,, .F. )






         oWndBrw:NewAt( "BMPCHG",,, {||( TDlgFlt():New( aColAlbCli(), dbfAlbCliL ):ChgFields(), oWndBrw:Refresh() )}, "Líneas",,,, 4, oRpl, .F. )

    end





   oWndBrw:NewAt( "INFO",,, {||( TTrazaDocumento():Activate( "10", ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb ) )}, "I(n)forme documento", "N",,, 4,, .F. )





   oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,,,,, .F. )





      oWndBrw:NewAt( "USER1_",,, {||( EdtCli( ( dbfAlbCliT )->cCodCli ) )}, "Modificar cliente",,,,, oRotor, .F. )





      oWndBrw:NewAt( "INFO",,, {||( InfCliente( ( dbfAlbCliT )->cCodCli ) )}, "Informe de cliente",,,,, oRotor, .F. )





      oWndBrw:NewAt( "WORKER",,, {||( EdtObras( ( dbfAlbCliT )->cCodCli, ( dbfAlbCliT )->cCodObr, dbfObrasT ) )}, "Modificar obra",,,,, oRotor, .F. )




      oWndBrw:NewAt( "CLIPBOARD_EMPTY_USER1_",,, {||( if( !Empty( ( dbfAlbCliT )->cNumPed ), ZooPedCli( ( dbfAlbCliT )->cNumPed ), MsgStop( "El albarán no procede de un pedido" ) ) )}, "Visualizar pedido",,,,, oRotor, .F. )





      oWndBrw:NewAt( "DOCUMENT_USER1_",,, {||( if( !( dbfAlbCliT )->lFacturado, FactCli( nil, nil, nil, nil, nil, { nil, nil, ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb, nil } ), MsgStop( "Albarán facturado" ) ) )}, "Generar factura",,,,, oRotor, .T. )




      oWndBrw:NewAt( "DOCUMENT_USER1_",,, {||( if( !Empty( ( dbfAlbCliT )->cNumFac ), EdtFacCli( ( dbfAlbCliT )->cNumFac ), msgStop( "No hay factura asociada" ) ) )}, "Modificar factura",,,,, oRotor, .F. )





      oWndBrw:NewAt( "DOCUMENT_MONEY2_",,, {||( FacAntCli( nil, nil, ( dbfAlbCliT )->cCodCli ) )}, "Generar anticipo",,,,, oRotor, .T. )





      oWndBrw:NewAt( "Note_",,, {||( AlbCliNotas() )}, "Generar nota de agenda",,,,, oRotor, .T. )





      oWndBrw:NewAt( "CASHIER_USER1_",,, {||( if( !( dbfAlbCliT )->lFacturado .AND. Empty( ( dbfAlbCliT )->cNumTik ), FrontTpv( nil, nil, nil, nil, .F., .F., { nil, nil, ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb } ), MsgStop( "Albarán facturado o convertido a ticket" ) ) )}, "Convertir a ticket",,,,, oRotor, .T. )




   oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .F. )





   if !oUser():lFiltroVentas()
      oWndBrw:oActiveFilter:aTField       := aItmAlbCli()
      oWndBrw:oActiveFilter:cDbfFilter    := dbfFlt
      oWndBrw:oActiveFilter:cTipFilter    := "10"
   end

   oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles() )},, oWndBrw:bLButtonUp )

   EnableAcceso()

   if !Empty( cCodCli ) .OR. !Empty( cCodArt ) .OR. !Empty( cCodPed )

      if !Empty( oWndBrw )
         oWndBrw:RecAdd()
      end

      cCodCli  := nil
      cCodArt  := nil
      cCodPed  := nil

   end

Return .T.



STATIC FUNCTION EdtRec( aTmp, aGet, dbfAlbCliT, oBrw, cCodCli, cCodArt, nMode, cCodPed )

    local oDlg
   local oBrwLin
   local oBrwInc
   local oBrwDoc
    local oFld
   local oBtnKit
   local nOrd
   local cEstAlb
   local oSay        := Array( 11 )
   local cSay        := Array( 11 )
   local oSayLabels  := Array( 10 )
   local oBmpDiv
   local oBmpEmp
   local oRieCli
   local nRieCli
   local oTlfCli
   local cTlfCli
   local oBrwPgo
   local lWhen       := if( oUser():lAdministrador(), nMode <> 3, if( nMode == 2, !aTmp[ 67 ], nMode <> 3 ) )
   local oSayGetRnt
   local cTipAlb
   local oSayDias
   local oSayTxtDias
   local oBmpGeneral

   IIF( cCodCli == nil, cCodCli := "", ) ;
   IIF( cCodArt == nil, cCodArt := "", ) ;
   IIF( cCodPed == nil, cCodPed := "", ) ;





   cOldCodCli                 := aTmp[ 6 ]

   do case
      case nMode == 1

         if !lCurSesion()
            MsgStop( "No hay sesiones activas, imposible añadir documentos" )
            Return .F.
         end

         if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
            msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada." )
            Return .F.
         end

         aTmp[ 4   ]   := cCurSesion()
         aTmp[ 7   ]   := oUser():cAlmacen()
         aTmp[ 51   ]   := cDivEmp()
         aTmp[ 23  ]   := cDefFpg()
         aTmp[ 8   ]   := oUser():cCaja()
         aTmp[ 68   ]   := cCurUsr()
         aTmp[ 52   ]   := nChgDiv( aTmp[ 51 ], dbfDiv )
         aTmp[ 16]   := .F.
         aTmp[ 50   ]   := .T.
         aTmp[ 3   ]   := RetSufEmp()
         aTmp[ 1   ]   := cNewSer( "NALBCLI", dbfCount )
         aTmp[ 71   ]   := Ctod( "" )
         aTmp[ 74   ]   := Ctod( "" )
         aTmp[ 76   ]   := oUser():cDelegacion()
         aTmp[ 57   ]   := uFieldEmpresa( "lIvaInc" )
         aTmp[ 63   ]   := nIva( dbfIva, cDefIva() )
         aTmp[ 83   ]   := Padr( "Gastos", 250 )

         if !Empty( cCodPed )
            aTmp[ 30 ]  := cCodPed
         end

      case nMode == 4

         if !lCurSesion()
            MsgStop( "No hay sesiones activas, imposible añadir documentos" )
            Return .F.
         end

         if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
            msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada." )
            Return .F.
         end

         aTmp[ 5   ]   := GetSysDate()
         aTmp[ 4   ]   := cCurSesion()
         aTmp[ 8   ]   := oUser():cCaja()
         aTmp[ 16]   := .F.
         aTmp[ 50   ]   := .T.
         aTmp[ 30   ]   := ""
         aTmp[ 67   ]   := .F.

      case nMode == 2

         if aTmp[ 67 ] .AND. !oUser():lAdministrador()
            MsgStop( "El albarán está cerrado." )
            Return .F.
         end

         if aTmp[ 16 ]
            MsgStop( "El albarán ya fue facturado." )
            return .T.
         end

   end

   if Empty( aTmp[ 1 ] )
      aTmp[ 1 ]        := cDefSer()
   end

   if Empty( aTmp[ 34 ] )
      aTmp[ 34 ]        := Max( uFieldEmpresa( "nPreVta" ), 1 )
   end

   if Empty( aTmp[ 35 ] )
      aTmp[ 35 ]        := Padr( "General", 50 )
   end

   if Empty( aTmp[ 37 ] )
      aTmp[ 37 ]           := Padr( "Pronto pago", 50 )
   end





   cTipAlb           := aTipAlb[ if( aTmp[ 82 ], 2, 1  ) ]





   if BeginTrans( aTmp, nMode )
      Return .F.
   end





   nRieCli                    := oStock:nRiesgo( aTmp[ 6 ] )

   if Empty( aTmp[ 86 ] )
      aTmp[ 86 ]        := RetFld( aTmp[ 6 ], dbfClient, "Telefono" )
   end

   nOrd                       := ( dbfAlbCliT )->( ordSetFocus( "nNumAlb" ) )

   oFont                      := TFont():New( "Arial", 8, 26, .F., .T. )

   cPicUnd                    := MasUnd()
   cPouDiv                    := cPouDiv( aTmp[ 51 ], dbfDiv )
   cPorDiv                    := cPorDiv( aTmp[ 51 ], dbfDiv )
   cPpvDiv                    := cPpvDiv( aTmp[ 51 ], dbfDiv )
   nDouDiv                    := nDouDiv( aTmp[ 51 ], dbfDiv )
   nDorDiv                    := nRouDiv( aTmp[ 51 ], dbfDiv )
   nDpvDiv                    := nDpvDiv( aTmp[ 51 ], dbfDiv )

   if aTmp[ 16 ]
      cEstAlb                 := "Facturado"
   else
      cEstAlb                 := "Pendiente"
   end





   cSay[ 2 ]                  := RetFld( aTmp[ 7 ], dbfAlm )
   cSay[ 3 ]                  := RetFld( aTmp[ 23], dbfFPago )
   cSay[ 4 ]                  := RetFld( aTmp[ 26 ], dbfAgent )
   cSay[ 5 ]                  := RetFld( aTmp[ 28 ], dbfTarPreS )
   cSay[ 6 ]                  := RetFld( aTmp[ 6 ] + aTmp[ 27 ], dbfObrasT, "cNomObr" )
   cSay[ 7 ]                  := RetFld( aTmp[ 29 ], dbfRuta )
   cSay[ 8 ]                  := oTrans:cNombre( aTmp[ 65 ] )
   cSay[ 9 ]                  := RetFld( aTmp[ 8 ], dbfCajT )
   cSay[ 10]                  := RetFld( aTmp[ 68 ], dbfUsr, "cNbrUse" )
   cSay[ 11]                  := RetFld( cCodEmp() + aTmp[ 76 ], dbfDelega, "cNomDlg" )





   InitTarifaCabecera( aTmp[ 34 ] )





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "albaranes a clientes", "PEDCLI",, .F.,,,,,, .F.,,,,,, .F., )



      oFld := TFolder():ReDefine( 200, {"Albará&n", "Da&tos",   "&Incidencias", "D&ocumentos"}, { "ALBCLI_1","ALBCLI_2","PEDCLI_3","PEDCLI_4" }, oDlg,,,,, .F., )









      oBmpGeneral := TBitmap():ReDefine( 990, "albaran_cliente_48_alpha",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "folder2_red_alpha_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "information_48_alpha",, oFld:aDialogs[3],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "address_book2_alpha_48",, oFld:aDialogs[4],,, .F., .F.,,, .F.,,, .T. )








      aGet[ 6 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],,, {||    ( LoaCli( aGet, aTmp, nMode, oRieCli ), RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwClient( aGet[6], aGet[9] ) )}, nil, "LUPA",, )





      aGet[9] := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, aTmp[9], aTmp[9]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 15 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )





      aGet[14] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[14], aTmp[14]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 15 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 10 ] := TGetHlp():ReDefine( 102, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 15 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 10 ], Rtrim( aTmp[ 11 ] ) + Space( 1 ) + Rtrim( aTmp[ 12 ] ) )}, nil, "Environnment_View_16",, )





      aGet[ 11 ] := TGetHlp():ReDefine( 103, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 15 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 12 ] := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, aTmp[ 12 ], aTmp[ 12 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 15 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 13 ] := TGetHlp():ReDefine( 107, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 15 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )









      aGet[ 34 ] := TGetHlp():ReDefine( 172, { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( ChangeTarifaCabecera( aTmp[ 34 ], dbfTmpLin, oBrwLin ) )},,,,,, .F., {||     ( nMode <> 3 .AND. ( lUsrMaster() .OR. oUser():lCambiarPrecio() ) )},, .F., .T.,,, {||      1}, {||      6},, nil,,, )





      oRieCli := TGetHlp():ReDefine( 173, { | u | If( PCount()==0, nRieCli, nRieCli:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[86] := TGetHlp():ReDefine( 106, { | u | If( PCount()==0, aTmp[86], aTmp[86]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 15 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 68 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 68 ], aTmp[ 68 ]:= u ) }, oFld:aDialogs[2],,, {||    ( SetUsuario( aGet[ 68 ], oSay[ 10 ], nil, dbfUsr ) )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 10 ] := TGetHlp():ReDefine( 126, { | u | If( PCount()==0, cSay[ 10 ], cSay[ 10 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )












      aGet[28] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[28], aTmp[28]:= u ) }, oFld:aDialogs[1],,, {||    ( cTarifa( aGet[28], oSay[ 5 ] ) )}, "N/W*",,,,, .F., {||     ( lWhen .AND. oUser():lAdministrador() )},, .F., .F.,,,,, {|Self|( BrwTarifa( aGet[28], oSay[ 5 ] ) )}, nil, "LUPA",, )




      oSay[ 5 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, cSay[ 5 ], cSay[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )












      aGet[27] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[27], aTmp[27]:= u ) }, oFld:aDialogs[1],,, {||    ( cObras( aGet[27], oSay[ 6 ], aTmp[6], dbfObrasT ) )}, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwObras( aGet[27], oSay[ 6 ], aTmp[6], dbfObrasT ) )}, nil, "LUPA",, )




      oSay[ 6 ] := TGetHlp():ReDefine( 191, { | u | If( PCount()==0, cSay[ 6 ], cSay[ 6 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )












      aGet[ 7 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[ 7 ], , oSay[ 2 ] ) )}, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 7 ], oSay[ 2 ] ) )}, nil, "LUPA",, )






      oSay[ 2 ] := TGetHlp():ReDefine( 201, { | u | If( PCount()==0, cSay[ 2 ], cSay[ 2 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( ExpAlmacen( aTmp[ 7 ], dbfTmpLin, oBrwLin ) )}, nil, "Bot",, )












      aGet[ 23 ] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cFPago( aGet[ 23 ], dbfFPago, oSay[ 3 ] ) )},,,,,, .F., {||     ( lWhen .AND. oUser():lAdministrador() )},, .F., .F.,,,,, {|Self|( BrwFPago( aGet[ 23 ], oSay[ 3 ] ) )}, nil, "LUPA",, )




      oSay[ 3 ] := TGetHlp():ReDefine( 211, { | u | If( PCount()==0, cSay[ 3 ], cSay[ 3 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ 93 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 93 ], aTmp[ 93 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwBncCli( aGet[ 93 ], aGet[ 94 ], aGet[ 95 ], aGet[ 96 ], aGet[ 97 ], aTmp[ 6 ] ) )}, nil, "LUPA",, )





      aGet[ 94 ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ 94 ], aTmp[ 94 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lCalcDC( aTmp[ 94 ], aTmp[ 95 ], aTmp[ 96 ], aTmp[ 97 ], aGet[ 96 ] ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )





      aGet[ 95 ] := TGetHlp():ReDefine( 421, { | u | If( PCount()==0, aTmp[ 95 ], aTmp[ 95 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lCalcDC( aTmp[ 94 ], aTmp[ 95 ], aTmp[ 96 ], aTmp[ 97], aGet[ 96 ] ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )





      aGet[ 96 ] := TGetHlp():ReDefine( 422, { | u | If( PCount()==0, aTmp[ 96 ], aTmp[ 96 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lCalcDC( aTmp[ 94 ], aTmp[ 95 ], aTmp[ 96 ], aTmp[ 97 ], aGet[ 96 ] ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )






      aGet[ 97 ] := TGetHlp():ReDefine( 423, { | u | If( PCount()==0, aTmp[ 97 ], aTmp[ 97 ]:= u ) }, oFld:aDialogs[1],, "9999999999", {||    ( lCalcDC( aTmp[ 94 ], aTmp[ 95 ], aTmp[ 96 ], aTmp[ 97 ], aGet[ 96 ] ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )












      aGet[ 26 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 26 ], aTmp[ 26 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAgentes( aGet[26], dbfAgent, oSay[ 4 ], aGet[ 49 ], dbfAgeCom ) )}, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[26], oSay[ 4 ] ) )}, nil, "LUPA",, )






      oSay[ 4 ] := TGetHlp():ReDefine( 221, { | u | If( PCount()==0, cSay[ 4 ], cSay[ 4 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( !Empty( aTmp[ 26 ] ) .AND. lWhen )},, .F., .F.,,,,, {|Self|( ExpAgente( aTmp[ 26 ], aTmp[ 49 ], dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, nil, "Bot",, )






      aGet[ 49 ] := TGetHlp():ReDefine( 222, { | u | If( PCount()==0, aTmp[ 49 ], aTmp[ 49 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99",,,,,,, .F., {||     ( !Empty( aTmp[ 26 ] ) .AND. lWhen )},, .F., .T.,,,,,, nil,,, )




      oGetAge := TGetHlp():ReDefine( 223, { | u | If( PCount()==0, nTotAge, nTotAge:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )












        aGet[29] := TGetHlp():ReDefine( 225, { | u | If( PCount()==0, aTmp[29], aTmp[29]:= u ) }, oFld:aDialogs[1],,, {||    ( cRuta( aGet[29], dbfRuta, oSay[ 7 ] ) )}, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwRuta( aGet[29 ], dbfRuta, oSay[ 7 ] ) )}, nil, "LUPA",, )





      oSay[ 7 ] := TGetHlp():ReDefine( 226, { | u | If( PCount()==0, cSay[ 7 ], cSay[ 7 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )





      oSay[ 9 ] := TGetHlp():ReDefine( 166, { | u | If( PCount()==0, cSay[ 9 ], cSay[ 9 ]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )













      aGet[ 51 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cDivOut( aGet[ 51 ], oBmpDiv, aTmp[ 52 ], @cPouDiv, @nDouDiv, @cPorDiv, @nDorDiv, @cPpvDiv, @nDpvDiv, oGetMasDiv, dbfDiv, oBandera ) )}, "N/W*",,,,, .F., {||     ( nMode == 1 .AND. ( dbfTmpLin )->( LastRec() ) == 0 )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ 51 ], oBmpDiv, aTmp[ 52 ], dbfDiv, oBandera )}, nil, "LUPA",, )




        oBmpDiv := TBitmap():ReDefine( 231, ( cBmpDiv( aTmp[ 51 ], dbfDiv ) ),, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .F. )
















      oBmpEmp := TBitmap():ReDefine( 500,, "Bmp\ImgAlbCli.bmp", oDlg,,, .F., .F.,,, .F.,,, .F. )





      oBrwLin                 := IXBrowse():New( oFld:aDialogs[1] )

      oBrwLin:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwLin:cAlias          := dbfTmpLin

      oBrwLin:nMarqueeStyle   := 6
      oBrwLin:cName           := "Albaran de cliente.Detalle"

      oBrwLin:CreateFromResource( 240 )

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Oferta"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfTmpLin )->lLinOfe }
         :nWidth              := 60
         :SetCheck( { "Star_Red_16", "Nil16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Número"
         :bEditValue          := {|| ( dbfTmpLin )->nNumLin }
         :cEditPicture        := "9999"
         :nWidth              := 65
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Código"
         :bEditValue          := {|| ( dbfTmpLin )->cRef }
         :nWidth              := 70
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "C. Barras"
         :bEditValue          := {|| cCodigoBarrasDefecto( ( dbfTmpLin )->cRef, dbfCodeBar ) }
         :nWidth              := 100
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Descripción"
         :bEditValue          := {|| Descrip( dbfTmpLin ) }
         :nWidth              := 260
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Código proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cCodPrv ) }
         :nWidth              := 50
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Nombre proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cNomPrv ) }
         :nWidth              := 150
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Referencia proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cRefPrv ) }
         :nWidth              := 50
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 1"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr1 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 2"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr2 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Lote"
         :bEditValue          := {|| ( dbfTmpLin )->cLote }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Caducidad"
         :bEditValue          := {|| Dtoc( ( dbfTmpLin )->dFecCad ) }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := cNombreCajas()
         :bEditValue          := {|| ( dbfTmpLin )->nCanEnt }
         :cEditPicture        := MasUnd()
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := cNombreUnidades()
         :bEditValue          := {|| nTotNAlbCli( dbfTmpLin ) }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "UM. Unidad de medición"
         :bEditValue          := {|| ( dbfTmpLin )->cUnidad }
         :nWidth              := 25
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Alm."
         :bEditValue          := {|| ( dbfTmpLin )->cAlmLin }
         :nWidth              := 35
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Precio"
         :bEditValue          := {|| nTotUAlbCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Dto."
         :bEditValue          := {|| ( dbfTmpLin )->nDto }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Dto. Lin."
         :bEditValue          := {|| nDtoUAlbCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Prm."
         :bEditValue          := {|| ( dbfTmpLin )->nDtoPrm }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Age"
         :bEditValue          := {|| ( dbfTmpLin )->nComAge }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% " + cImp()
         :bEditValue          := {|| ( dbfTmpLin )->nIva }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Portes"
         :bEditValue          := {|| nTrnUAlbCli( dbfTmpLin, nRouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "P. verde"
         :bEditValue          := {|| nPntUAlbCli( dbfTmpLin, nDpvDiv ) }
         :cEditPicture        := cPpvDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Total"
         :bEditValue          := {|| nTotLAlbCli( dbfTmpLin, nDouDiv, nRouDiv, nil, .T., aTmp[ 92 ], .T. ) }
         :cEditPicture        := cPorDiv
         :nWidth              := 102
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      if nMode <> 3
         oBrwLin:bLDblClick   := {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) }
      end








      aGet[ 35 ] := TGetHlp():ReDefine( 249, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )








      aGet[ 36 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      oSayLabels[ 2 ] := TButton():ReDefine( 248, {||( aGet[ 36 ]:cText( Val( GetPvProfString( "Descuentos", "Descuento especial", 0, cPatEmp() + "Empresa.Ini" ) ) ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[ 1 ],,, .F., {||     ( lWhen )},,, .F. )




      aGet[ 37 ] := TGetHlp():ReDefine( 259, { | u | If( PCount()==0, aTmp[ 37 ], aTmp[ 37 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )








        aGet[ 38 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      oSayLabels[ 3 ] := TButton():ReDefine( 258, {||( aGet[ 38 ]:cText( Val( GetPvProfString( "Descuentos", "Descuento pronto pago", 0, cPatEmp() + "Empresa.Ini" ) ) ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[ 1 ],,, .F., {||     ( lWhen )},,, .F. )




        aGet[ 39 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )








        aGet[ 40 ] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[ 40 ], aTmp[ 40 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      oSayLabels[ 4 ] := TButton():ReDefine( 268, {||( aGet[ 40 ]:cText( Val( GetPvProfString( "Descuentos", "Descuento uno", 0, cPatEmp() + "Empresa.Ini" ) ) ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[ 1 ],,, .F., {||     ( lWhen )},,, .F. )




      aGet[ 41 ] := TGetHlp():ReDefine( 290, { | u | If( PCount()==0, aTmp[ 41 ], aTmp[ 41 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )








      aGet[ 42 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      oSayLabels[ 5 ] := TButton():ReDefine( 288, {||( aGet[ 42 ]:cText( Val( GetPvProfString( "Descuentos", "Descuento dos", 0, cPatEmp() + "Empresa.Ini" ) ) ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[ 1 ],,, .F., {||     ( lWhen )},,, .F. )

      if IsMuebles()







         aGet[79] := TGetHlp():ReDefine( 750, { | u | If( PCount()==0, aTmp[79], aTmp[79]:= u ) }, oFld:aDialogs[1],, "@E 999.99",, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .T.,,,,,, nil,,, )

      end





      oBrwIva                        := TXBrowse():New( oFld:aDialogs[ 1 ] )

      oBrwIva:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwIva:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwIva:SetArray( aTotIva, , , .F. )

      oBrwIva:nMarqueeStyle          := 5
      oBrwIva:lRecordSelector        := .F.
      oBrwIva:lHScroll               := .F.

      oBrwIva:CreateFromResource( 310 )

      with object ( oBrwIva:AddCol() )
         :cHeader          := "Base"
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil, Trans( aTotIva[ oBrwIva:nArrayAt, 2 ], cPorDiv ), "" ) }
         :nWidth           := 96
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "%" + cImp()
         :bStrData         := {|| if( !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ), aTotIva[ oBrwIva:nArrayAt, 3 ], "" ) }
         :bEditValue       := {|| aTotIva[ oBrwIva:nArrayAt, 3 ] }
         :nWidth           := 55
         :cEditPicture     := "@E 999.99"
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nFootStrAlign    := 1
         :nEditType        := 1
         :bEditWhen        := {|| !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ) }
         :bOnPostEdit      := {|o,x| EdtIva( o, x, aTotIva[ oBrwIva:nArrayAt, 3 ], dbfTmpLin, dbfIva, oBrwLin ), RecalculaTotal( aTmp ) }
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := cImp()
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil, Trans( aTotIva[ oBrwIva:nArrayAt, 8 ], cPorDiv ), "" ) }
         :nWidth           := 58
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "% R.E."
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil .AND. aTmp[ 48 ], Trans( aTotIva[ oBrwIva:nArrayAt, 4 ], "@E 99.9"), "" ) }
         :nWidth           := 54
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "R.E."
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil .AND. aTmp[ 48 ], Trans( aTotIva[ oBrwIva:nArrayAt, 9 ], cPorDiv ), "" ) }
         :nWidth           := 54
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end










      aGet[ 83 ] := TGetHlp():ReDefine( 411, { | u | If( PCount()==0, aTmp[ 83 ], aTmp[ 83 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )









      aGet[ 63 ] := TGetHlp():ReDefine( 412, { | u | If( PCount()==0, aTmp[ 63 ], aTmp[ 63 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lTiva( dbfIva, aTmp[ 63 ] ) .AND. RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 63 ], dbfIva, , .T. ) )}, nil, "LUPA",, )






      aGet[ 64 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 64 ], aTmp[ 64 ]:= u ) }, oFld:aDialogs[1],, cPorDiv, {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )



      oGetNet := TSay():ReDefine( 401, {|| nTotNet}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oGetTrn := TSay():ReDefine( 402, {|| nTotTrn}, oFld:aDialogs[1],,,, .F.,, .F., .F. )

      oSayGetRnt := TSay():ReDefine( 709,, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oGetRnt := TGetHlp():ReDefine( 408, { | u | If( PCount()==0, nTotRnt, nTotRnt:= u ) }, oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )



      oGetIvm := TSay():ReDefine( 403, {|| nTotIvm}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[ 92 ] := TCheckBox():ReDefine( 409, { | u | If( PCount()==0, aTmp[ 92  ], aTmp[ 92  ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ), oBrwLin:Refresh() )},,,,, .F., {||     ( lWhen )}, .F. )



      oGetPnt := TSay():ReDefine( 404, {|| nTotPnt}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oGetIva := TSay():ReDefine( 405, {|| nTotIva}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[ 48 ] := TCheckBox():ReDefine( 406, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ) )},,,,, .F., {||     ( lWhen )}, .F. )



      oGetReq := TSay():ReDefine( 407, {|| nTotReq}, oFld:aDialogs[1],,,, .F.,, .F., .F. )




      oGetTotal := TSay():ReDefine( 360, {|| nTotAlb}, oFld:aDialogs[1],,,, .F., oFont, .F., .F. )









      TButton():ReDefine( 515, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .T., nMode ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen )},,, .F. )





        TButton():ReDefine( 500, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .F., nMode ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen )},,, .F. )





        TButton():ReDefine( 501, {||( EdtDeta( oBrwLin, bEdtDet, aTmp, .F., nMode ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwLin, dbfTmpLin, {|| delDeta() }, {|| RecalculaTotal( aTmp ) } ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwLin, bEdtDet, dbfTmpLin, .F., nMode, aTmp ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )





        TButton():ReDefine( 512, {||( GrpPed( aGet, aTmp, oBrwLin  ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode == 1 .AND. Empty( aTmp[ 30 ] ) )},,, .F. )





        TButton():ReDefine( 524, {||( DbSwapUp( dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen )},,, .F. )





        TButton():ReDefine( 525, {||( DbSwapDown( dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen )},,, .F. )




      oBtnKit := TButton():ReDefine( 526, {||( ShowKit( dbfAlbCliT, dbfTmpLin, oBtnKit, oBrwLin, .T. ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )










      aGet[ 1 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 1 ], aTmp[ 1 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( aTmp[ 1 ] >= "A" .AND. aTmp[ 1 ] <= "Z"  )}, "N/W*",,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[ 1 ] ) )}, {||  ( DwSerie( aGet[ 1 ] ) )},,,, nil,,, )





      aGet[ 2 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 2 ], aTmp[ 2 ]:= u ) }, oFld:aDialogs[1],, "999999999",,,,,,, .F., {||      ( .F. )},, .F., .F.,,,,,, nil,,, )





      aGet[3] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[3], aTmp[3]:= u ) }, oFld:aDialogs[1],, "@!",,,,,,, .F., {||      ( .F. )},, .F., .F.,,,,,, nil,,, )






        aGet[5] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[5], aTmp[5]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .T.,,,,,, nil,,, )






      oTipAlb := TComboBox():ReDefine( 217, { | u | If( PCount()==0, cTipAlb, cTipAlb:= u ) }, aTipAlb, oFld:aDialogs[1],,, {|Self|(SetDialog( aGet, oSayDias, oSayTxtDias, oSayGetRnt, oGetRnt ) )},,,, .F., {||     ( ( dbfTmpLin )->( LastRec() ) == 0 )},,,,, )








      aGet[ 81 ] := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 81 ], aTmp[ 81 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,, 112, )








      aGet[ 80 ] := TGetHlp():ReDefine( 113, { | u | If( PCount()==0, aTmp[ 80 ], aTmp[ 80 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,, 114, )





      oSayDias := TSay():ReDefine( 115, {||      ( aTmp[ 80 ] - aTmp[ 81 ] )}, oFld:aDialogs[1], "9999",,, .F.,, .F., .F. )



      oSayTxtDias := TSay():ReDefine( 116,, oFld:aDialogs[1],,,, .F.,, .F., .F. )






        aGet[19] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[19], aTmp[19]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,, 141, )















      aGet[ 30 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[1],, "@R #/#########/##", {||    ( cPedCli( aGet, aTmp, oBrwLin, oBrwPgo, nMode ), RecalculaTotal( aTmp ), SetDialog( aGet, oSayDias, oSayTxtDias, oSayGetRnt, oGetRnt ) )}, "N/W*",,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,, {|Self|( BrwPedCli( aGet[ 30 ], dbfPedCliT, dbfPedCliL, dbfIva, dbfDiv, dbfFPago, aGet[ 57 ] ), RecalculaTotal( aTmp ) )}, nil, "LUPA",, )




      aGet[ 16 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cEstAlb, cEstAlb:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      aGet[ 57 ] := TCheckBox():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 57 ], aTmp[ 57 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( lWhen .AND. ( dbfTmpLin )->( LastRec() ) == 0 )}, .F. )






















      aGet[ 65 ] := TGetHlp():ReDefine( 235, { | u | If( PCount()==0, aTmp[ 65 ], aTmp[ 65 ]:= u ) }, oFld:aDialogs[2],,, {||    ( LoadTrans( aTmp, aGet[ 65 ], aGet[ 66 ], oSay[ 8 ] ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( oTrans:Buscar( aGet[ 65 ] ), .T. )}, nil, "LUPA",, )



      oSay[ 8 ] := TGetHlp():ReDefine( 236, { | u | If( PCount()==0, cSay[ 8 ], cSay[ 8 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )





      aGet[ 66 ] := TGetHlp():ReDefine( 237, { | u | If( PCount()==0, aTmp[ 66 ], aTmp[ 66 ]:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )







      aGet[ 24 ] := TGetHlp():ReDefine( 128, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[2],, "999",, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .T.,,,,,, nil,,, )




      aGet[ 56 ] := TGetHlp():ReDefine( 129, { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )












      aGet[ 8 ] := TGetHlp():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[2],,, {||    cCajas( aGet[ 8 ], dbfCajT, oSay[ 9 ] )}, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 8 ], oSay[ 9 ] ) )}, nil, "LUPA",, )









      aGet[53] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[53], aTmp[53]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )





      aGet[54] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[54], aTmp[54]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )









      aGet[17] := TCheckBox():ReDefine( 200, { | u | If( PCount()==0, aTmp[17], aTmp[17]:= u ) }, oFld:aDialogs[2],, {||( ValCheck( aGet, aTmp ) )},,,,, .F., {||     ( lWhen )}, .F. )





      aGet[71] := TGetHlp():ReDefine( 127, { | u | If( PCount()==0, aTmp[71], aTmp[71]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen )},, .F., .T.,,,,,, nil,,, )









        aGet[20] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[20], aTmp[20]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )





      aGet[22] := TMultiGet():ReDefine( 240, { | u | If( PCount()==0, aTmp[22], aTmp[22]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||     ( lWhen )}, .F.,, )





      aGet[21] := TMultiGet():ReDefine( 250, { | u | If( PCount()==0, aTmp[21], aTmp[21]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||     ( lWhen )}, .F.,, )




      aGet[76] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[76], aTmp[76]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 11 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSay[ 11 ], cSay[ 11 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )






      aGet[ 73 ] := TCheckBox():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( lWhen .AND. lUsrMaster() )}, .F. )




      aGet[ 74 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 74 ], aTmp[ 74 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )




      aGet[ 75 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 75 ], aTmp[ 75 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )




      oGetMasDiv := TSay():ReDefine( 488, {|| cGetMasDiv}, oFld:aDialogs[1],,,, .F., oFont, .F., .F. )






      oBrwPgo                 := IXBrowse():New( oFld:aDialogs[2] )

      oBrwPgo:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwPgo:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwPgo:cAlias          := dbfTmpPgo
      oBrwPgo:cName           := "Albaran de cliente.Pagos"

      oBrwPgo:nMarqueeStyle   := 6
      oBrwPgo:lHScroll        := .F.

      oBrwPgo:CreateFromResource( 310 )

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Sesión cerrada"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfTmpPgo )->lCloPgo }
         :nWidth              := 20
         :SetCheck( { "Cnt16", "Nil16" } )
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Fecha"
         :bEditValue          := {|| Dtoc( ( dbfTmpPgo )->dEntrega ) }
         :nWidth              := 80
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Sesión"
         :bEditValue          := {|| ( dbfTmpPgo )->cTurRec }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Caja"
         :bEditValue          := {|| ( dbfTmpPgo )->cCodCaj }
         :nWidth              := 50
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Agente"
         :bEditValue          := {|| ( dbfTmpPgo )->cCodAge }
         :nWidth              := 60
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Concepto"
         :bEditValue          := {|| ( dbfTmpPgo )->cDescrip }
         :nWidth              := 155
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Importe"
         :bEditValue          := {|| nEntAlbCli( dbfTmpPgo, dbfDiv, cDivEmp(), .T. ) }
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Forma pago"
         :bEditValue          := {|| ( dbfTmpPgo )->cCodPgo }
         :nWidth              := 120
         :lHide               := .T.
      end

      if nMode == 2
         oBrwPgo:bLDblClick   := {|| WinEdtRec( oBrwPgo, bEdtPgo, dbfTmpPgo, nil, nil, aTmp ), RecalculaTotal( aTmp ) }
      end





      TButton():ReDefine( 501, {||( WinAppRec( oBrwPgo, bEdtPgo, dbfTmpPgo, nil, nil, aTmp ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( WinEdtRec( oBrwPgo, bEdtPgo, dbfTmpPgo, nil, nil, aTmp ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 503, {||( if( ( dbfTmpPgo )->lCloPgo .AND. !oUser():lAdministrador(), MsgStop( "Solo pueden eliminar las entregas cerradas los administradores." ), ( WinDelRec( oBrwPgo, dbfTmpPgo ), RecalculaTotal( aTmp ) ) ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 600, {||( PrnEntregas( .F., dbfTmpPgo ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 610, {||( PrnEntregas( .T., dbfTmpPgo ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )








      oGetAlb := TSay():ReDefine( 320, {|| nTotAlb}, oFld:aDialogs[2],,,, .F.,, .F., .F. )



      oGetEnt := TSay():ReDefine( 330, {|| 0}, oFld:aDialogs[2],,,, .F.,, .F., .F. )



      oGetPdt := TSay():ReDefine( 340, {|| 0}, oFld:aDialogs[2],,,, .F.,, .F., .F. )





      oGetPes := TGetHlp():ReDefine( 570, { | u | If( PCount()==0, nTotPes, nTotPes:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oGetDif := TGetHlp():ReDefine( 580, { | u | If( PCount()==0, nTotDif, nTotDif:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oBrwInc                 := IXBrowse():New( oFld:aDialogs[ 3 ] )

      oBrwInc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwInc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwInc:cAlias          := dbfTmpInc

      oBrwInc:nMarqueeStyle   := 6
      oBrwInc:cName           := "Albaran de cliente.Incidencias"

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Resuelta"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpInc )->lListo }
            :nWidth           := 65
            :SetCheck( { "Sel16", "Cnt16" } )
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Código"
            :bEditValue       := {|| ( dbfTmpInc )->cCodTip }
            :nWidth           := 80
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Incidencia"
            :bEditValue       := {|| cNomInci( ( dbfTmpInc )->cCodTip, dbfInci ) }
            :nWidth           := 230
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpInc )->dFecInc ) }
            :nWidth           := 90
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpInc )->mDesInc }
            :nWidth           := 480
         end

         if nMode <> 3
            oBrwInc:bLDblClick   := {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) }
         else
            oBrwInc:bLDblClick   := {|| WinZooRec( oBrwInc, bEdtDet, aTmp ) }
         end

         oBrwInc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( lWhen )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( lWhen )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( lWhen )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F.,,,, .F. )



      oBrwDoc                 := TXBrowse():New( oFld:aDialogs[ 4 ] )

      oBrwDoc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDoc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDoc:cAlias          := dbfTmpDoc

      oBrwDoc:nMarqueeStyle   := 6
      oBrwDoc:nRowHeight      := 40
      oBrwDoc:nDataLines      := 2

      with object ( oBrwDoc:AddCol() )
         :cHeader          := "Documento"
         :bEditValue       := {|| Rtrim( ( dbfTmpDoc )->cNombre ) + Chr(13)+Chr(10) + Space( 5 ) + Rtrim( ( dbfTmpDoc )->cRuta ) }
         :nWidth           := 860
      end

      if nMode <> 3
         oBrwDoc:bLDblClick   := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( ( dbfTmpDoc )->cRuta ) ) }
      end

      oBrwDoc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( lWhen )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( lWhen )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( lWhen )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwDoc, bEdtDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( ShellExecute( oDlg:hWnd, "open", rTrim( ( dbfTmpDoc )->cRuta ) ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )









      TButton():ReDefine( 3, {||( RecAlbCli( aTmp, oDlg ), oBrwLin:Refresh(), RecalculaTotal( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





      TButton():ReDefine( 4, {||( if( EndTrans( aTmp, aGet, oBrw, oBrwInc, nMode, oDlg ), GenAlbCli( 1 ), ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 1, {||( EndTrans( aTmp, aGet, oBrw, oBrwInc, nMode, oDlg ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( If( ExitNoSave( nMode, dbfTmpLin ), oDlg:end(), ) )}, oDlg,,, .F.,,,, .T. )

      oSayLabels[ 1 ] := TGroup():ReDefine( 700,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 6 ] := TSay():ReDefine( 708,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 7 ] := TSay():ReDefine( 710,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 8 ] := TSay():ReDefine( 711,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 9 ] := TSay():ReDefine( 712,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )

   if nMode <> 3

      oFld:aDialogs[1]:AddFastKey( 113, {|| AppDeta( oBrwLin, bEdtDet, aTmp, .F., nMode ) } )
      oFld:aDialogs[1]:AddFastKey( 114, {|| EdtDeta( oBrwLin, bEdtDet, aTmp, .F., nMode ) } )
      oFld:aDialogs[1]:AddFastKey( 115, {|| WinDelRec( oBrwLin, dbfTmpLin, {|| delDeta() }, {|| RecalculaTotal( aTmp ) } ) } )

      oFld:aDialogs[2]:AddFastKey( 113, {|| WinAppRec( oBrwPgo, bEdtPgo, dbfTmpPgo, nil, nil, aTmp ), RecalculaTotal( aTmp ) } )
      oFld:aDialogs[2]:AddFastKey( 114, {|| WinEdtRec( oBrwPgo, bEdtPgo, dbfTmpPgo, nil, nil, aTmp ), RecalculaTotal( aTmp ) } )
      oFld:aDialogs[2]:AddFastKey( 115, {|| if( ( dbfTmpPgo )->lCloPgo .AND. !oUser():lAdministrador(), MsgStop( "Solo pueden eliminar las entregas cerradas los administradores." ), ( WinDelRec( oBrwPgo, dbfTmpPgo ), RecalculaTotal( aTmp ) ) ) } )

      oFld:aDialogs[3]:AddFastKey( 113, {|| WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 114, {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 115, {|| WinDelRec( oBrwInc, dbfTmpInc ) } )

      oFld:aDialogs[4]:AddFastKey( 113, {|| WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 114, {|| WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 115, {|| WinDelRec( oBrwDoc, dbfTmpDoc ) } )

      oDlg:AddFastKey( 117,             {|| if( EndTrans( aTmp, aGet, oBrw, oBrwInc, nMode, oDlg ), GenAlbCli( 1 ), ) } )
      oDlg:AddFastKey( 116,             {|| EndTrans( aTmp, aGet, oBrw, oBrwInc, nMode, oDlg ) } )
      oDlg:AddFastKey( 65,                {|| if( GetKeyState( 17 ), CreateInfoArticulo(), ) } )

   end

   oDlg:AddFastKey ( 112, {|| ChmHelp( "Albaranes2" ) } )

   do case
      case nMode == 1 .AND. lRecogerUsuario() .AND. Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 68 ], dbfUsr ), , oDlg:End() ) }
      case nMode == 1 .AND. lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 68 ], dbfUsr ), AppDeta( oBrwLin, bEdtDet, aTmp, nil, nMode, cCodArt ), oDlg:End() ) }
      case nMode == 1 .AND. !lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| AppDeta( oBrwLin, bEdtDet, aTmp, nil, nMode, cCodArt ) }
      otherwise
         oDlg:bStart := {|| ShowKit( dbfAlbCliT, dbfTmpLin, oBtnKit, oBrwLin, .F., dbfTmpInc, cCodCli, dbfClient, oRieCli, oGetRnt, aGet, oSayGetRnt ) }
   end









   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|(  RecalculaTotal( aTmp ) )}, .T.,,, {|Self|(  EdtRecMenu( aTmp, oDlg ),  SetDialog( aGet, oSayDias, oSayTxtDias, oSayGetRnt, oGetRnt ), oBrwLin:Load() , oBrwInc:Load() , oBrwPgo:Load() , if( !Empty( cCodPed ), aGet[ 30 ]:lValid(), ) )}, oDlg:bRClicked,,, )

   oMenu:End()

   oFont:end()

   oBmpEmp:end()
   oBmpDiv:end()
   oBmpGeneral:End()

   oBrwLin:CloseData()
   oBrwPgo:CloseData()
   oBrwInc:CloseData()

   ( dbfAlbCliT )->( ordSetFocus( nOrd ) )

   KillTrans()

RETURN ( oDlg:nResult == 1 )



Static Function EdtRecMenu( aTmp, oDlg )

   oMenu := MenuBegin( .F.,,, .F., .F. )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F. )

         MenuBegin( .F.,,, .F., .F. )




            MenuAddItem( "&1. Visualizar pedido", "Visualiza el pedido del que proviene", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 30 ] ), ZooPedCli( aTmp[ 30 ] ), MsgStop( "El albarán no procede de un pedido" ) ) )},, "Clipboard_Empty_User1_16",,,,, .F.,,, .F. )

            MenuAddItem()






            MenuAddItem( "&2. Generar anticipo", "Genera factura de anticipo", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), CreateAntCli( aTmp[ 6 ] ), msgStop("Debe seleccionar un cliente para hacer una factura de anticipo" ) ) )},, "Document_Money2_16",,,,, .F.,,, .F. )

            MenuAddItem()





            MenuAddItem( "&3. Modificar cliente", "Modifica la ficha del cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), EdtCli( aTmp[ 6 ] ), MsgStop( "Código de cliente vacío" ) ) )},, "User1_16",,,,, .F.,,, .F. )




            MenuAddItem( "&4. Informe de cliente", "Informe de cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), InfCliente( aTmp[ 6 ] ), MsgStop( "Código de cliente vacío" ) ) )},, "Info16",,,,, .F.,,, .F. )




            MenuAddItem( "&5. Modificar obra", "Modifica ficha de la obra", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 27 ] ), EdtObras( aTmp[ 6 ], aTmp[ 27 ], dbfObrasT ), MsgStop( "Código de obra vacío" ) ) )},, "Worker16",,,,, .F.,,, .F. )
            MenuAddItem()





            MenuAddItem( "&6. Informe del documento", "Informe del documento", .F.,, {|oMenuItem|( TTrazaDocumento():Activate( "10", aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ] ) )},, "Info16",,,,, .F.,,, .F. )
         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMenu )

Return ( oMenu )



static function ValCheck( aGet, aTmp )

   if aTmp[ 17 ]
      aGet[ 71 ]:cText( GetSysDate() )
   else
      aGet[ 71 ]:cText( Ctod( "" ) )
   end

return .T.







STATIC FUNCTION EdtDet( aTmp, aGet, dbfAlbCliL, oBrw, lTotLin, cCodArtEnt, nMode, aTmpAlb )

    local oDlg
   local oFld
   local oBtn
    local oGet2
    local cGet2
   local oGet3
   local cGet3
   local oTotal
   local nTotal        := 0
   local oSayPr1
   local oSayPr2
   local cSayPr1       := ""
   local cSayPr2       := ""
   local oSayVp1
   local oSayVp2
   local cSayVp1       := ""
   local cSayVp2       := ""
   local bmpImage
   local oSayAlm
   local cSayAlm
   local oStkAct
   local nStkAct        := 0
   local oBtnSer
   local oSayGrp
   local cSayGrp        := ""
   local oSayFam
   local cSayFam        := ""
   local cCodArt        := Padr( aTmp[ 4 ], 32 )
   local oRentLin
   local cRentLin       := ""
   local cCodDiv        := aTmpAlb[ 51 ]
   local oSayDias

   do case
   case nMode == 1

      aTmp[1]   := aTmpAlb[1]
      aTmp[2]   := aTmpAlb[2]
      aTmp[12 ]   := 1
      aTmp[19]   := 1
      aTmp[21  ]   := GetSysDate()
      aTmp[22 ]   := cDefVta()
      aTmp[24 ]   := lTotLin
      aTmp[26 ]   := .T.
      aTmp[38 ]   := aTmpAlb[ 7 ]
      aTmp[39 ]   := aTmpAlb[ 57 ]
      aTmp[27]   := aTmpAlb[ 30 ]
      aTmp[76 ]   := aTmpAlb[ 34 ]
      aTmp[86 ]   := .T.

      if !Empty( cCodArtEnt )
         cCodArt           := cCodArtEnt
      end

      aTmp[ 69 ]    := aTmpAlb[ 81 ]
      aTmp[ 68 ]    := aTmpAlb[ 80 ]

      if !Empty( oTipAlb ) .AND. oTipAlb:nAt == 2
         aTmp[ 71 ] := .T.
      else
         aTmp[ 71 ]:= .F.
      end

   case nMode == 2

      lTotLin           := aTmp[ 24 ]

   end





   cOldCodArt           := aTmp[ 4 ]
   cOldPrpArt           := aTmp[ 28 ] + aTmp[ 29 ] + aTmp[ 30 ] + aTmp[ 31 ]
   cOldUndMed           := aTmp[ 17 ]

   cSayGrp              := RetFld( aTmp[ 55 ], oGrpFam:GetAlias() )
   cSayFam              := RetFld( aTmp[ 54 ], dbfFamilia )





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "líneas a albaranes de clientes", "LFACCLI",, .F.,,,,,, .F.,,,,,, .F., )

      if aTmp[ 71 ]





      oFld := TFolder():ReDefine( 400, {"&General",    "Da&tos",    "&Observaciones"}, { "LPEDCLI_8","LALBCLI_2","LFACCLI_3" }, oDlg,,,,, .F., )

      else





      oFld := TFolder():ReDefine( 400, {"&General",    "Da&tos",    "&Observaciones"}, { "LPEDCLI_1","LALBCLI_2","LFACCLI_3" }, oDlg,,,,, .F., )

      end





      aGet[ 4 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cCodArt, cCodArt:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

      aGet[ 4 ]:bValid       := {|| LoaArt( cCodArt, aTmp, aGet, aTmpAlb, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode ) }
      aGet[ 4 ]:bHelp        := {|| BrwArticulo( aGet[ 4 ], aGet[ 5 ], .F., .T., oBtn, aGet[ 44 ], aTmp[ 28 ], aTmp[ 29 ], aGet[ 30 ], aGet[ 31 ], aGet[ 45 ] ) }
      aGet[ 4 ]:bLostFocus   := {|| lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) }




      aGet[ 5 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 5 ] ) ) .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 23 ] := TMultiGet():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 23 ] ) ) .AND. nMode <> 3 )}, .F.,, )











      aGet[ 44 ] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 113, )

         aGet[ 44 ]:bValid   := {|| lValidLote( aTmp, aGet, oStkAct ) }

      if !aTmp[ 71 ]






      aGet[ 45 ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 341, )

      end






      if !aTmp[ 71 ]










      aGet[ 30 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[30], aTmp[30]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[ 30 ], oSayVp1, aTmp[ 28 ], dbfTblPro ), LoaArt( cCodArt, aTmp, aGet, aTmpAlb, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ), .F. ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[30], oSayVp1, aTmp[28 ] ) )}, nil, "LUPA",, )

         aGet[ 30 ]:bChange      := {|| aGet[ 30 ]:Assign(), if( !uFieldEmpresa( "lNStkAct" ), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 38 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 44 ], aTmp[ 46 ], aTmp[ 35 ], oStkAct ), .T. ) }
         aGet[ 30 ]:bLostFocus   := {|| lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) }



      oSayPr1 := TSay():ReDefine( 271, {|| cSayPr1}, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      oSayVp1 := TGetHlp():ReDefine( 272, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )










      aGet[31] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[31], aTmp[31]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[ 31 ], oSayVp2, aTmp[ 29 ], dbfTblPro ), LoaArt( cCodArt, aTmp, aGet, aTmpAlb, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ), .F. ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[31], oSayVp2, aTmp[29 ] ) )}, nil, "LUPA",, )

         aGet[ 31 ]:bChange      := {|| aGet[ 31 ]:Assign(), if( !uFieldEmpresa( "lNStkAct" ), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 38 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 44 ], aTmp[ 46 ], aTmp[ 35 ], oStkAct ), .T. ) }
         aGet[ 31 ]:bLostFocus   := {|| lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) }



      oSayPr2 := TSay():ReDefine( 281, {|| cSayPr2}, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      oSayVp2 := TGetHlp():ReDefine( 282, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )

      end














      aGet[ 11 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lTiva( dbfIva, aTmp[ 11 ], @aTmp[ 56 ] ) )},,,,,, .F., {||     ( !aTmp[ 14 ] .AND. lModIva() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 11 ], dbfIva, , .T. ) )}, nil, "LUPA",, )

      if aTmp[ 71 ]







      aGet[ 69 ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ 69 ], aTmp[ 69 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ), oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,,, )







      aGet[ 68 ] := TGetHlp():ReDefine( 430, { | u | If( PCount()==0, aTmp[ 68 ], aTmp[ 68 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ), oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,,, )





      oSayDias := TSay():ReDefine( 440, {||      ( aTmp[ 68 ] - aTmp[ 69 ] )}, oFld:aDialogs[1], "9999",,, .F.,, .F., .F. )

      else










      aGet[ 40 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 40 ], aTmp[ 40 ]:= u ) }, oFld:aDialogs[1],, cPouDiv,, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,, {|Self|( oNewImp:nBrwImp( aGet[ 40 ] ) )}, nil,, 126, )

      end









        aGet[12] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( cCodArt, aTmp, aGet, aTmpAlb, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ) )},,,,,, .F., {||     ( !aTmp[14] .AND. lUseCaj() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( cCodArt, aTmp, aGet, aTmpAlb, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 131, )









        aGet[19] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[19], aTmp[19]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( cCodArt, aTmp, aGet, aTmpAlb, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ) )},,,,,, .F., {||     ( !aTmp[14] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( cCodArt, aTmp, aGet, aTmpAlb, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 141, )





      aGet[ 32 ] := TGetHlp():ReDefine( 295, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( !aTmp[14] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 6 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( !aTmp[14] .AND. nMode <> 3 .AND. !lTotLin)}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )










      aGet[ 76 ] := TGetHlp():ReDefine( 156, { | u | If( PCount()==0, aTmp[ 76 ], aTmp[ 76 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( aTmp[ 76 ] >= 1 .AND. aTmp[ 76 ] <= 6 )},,,,,, .F., {||     ( nMode <> 3 .AND. ( lUsrMaster() .OR. oUser():lCambiarPrecio() ) )}, {|nKey,nFlags,Self| ( ChangeTarifa( aTmp, aGet, aTmpAlb ), lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,, {||      1}, {||      6},, nil,,, )








      aGet[ 17 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 17 ], aTmp[ 17 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oUndMedicion:Existe( aGet[ 17 ], aGet[ 17 ]:oHelpText, "cNombre" ), ValidaMedicion( aTmp, aGet ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oUndMedicion:Buscar( aGet[ 17 ] ), ValidaMedicion( aTmp, aGet ) )}, nil, "LUPA",, 171 )











      aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ] := TGetHlp():ReDefine( 520, { | u | If( PCount()==0, aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ], aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 521, )

         aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetColor( 8388608 )










      aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ] := TGetHlp():ReDefine( 530, { | u | If( PCount()==0, aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ], aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 531, )

         aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetColor( 8388608 )










      aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ] := TGetHlp():ReDefine( 540, { | u | If( PCount()==0, aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ], aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 541, )

         aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetColor( 8388608 )

      if aTmp[ 71 ]









         aGet[ 70 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 70 ], aTmp[ 70 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )

      end









      aGet[ 8 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 351, )








      aGet[ 7 ] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],, cPpvDiv, {||    ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( !aTmp[14] .AND. nMode <> 3 .AND. !lTotLin)},, .F., .T.,,,,,, nil,, 152, )





      aGet[ 15 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 15 ], aTmp[ 15 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( !aTmp[14] .AND. nMode <> 3 .AND. !lTotLin)},, .F., .F.,,,,,, nil,,, )




      aGet[ 16 ] := TGetHlp():ReDefine( 175, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( !aTmp[14] .AND. nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )





      aGet[ 66 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 66 ], aTmp[ 66 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( !aTmp[14] .AND. nMode <> 3 .AND. !lTotLin)},, .F., .F.,,,,,, nil,,, )





      aGet[ 67 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 67 ], aTmp[ 67 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( !aTmp[14] .AND. nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )








        aGet[9] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[9], aTmp[9]:= u ) }, oFld:aDialogs[1],, "@E 999.99",, "N/W*",,,,, .F., {||     ( !aTmp[14] .AND. nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )








        aGet[10] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[10], aTmp[10]:= u ) }, oFld:aDialogs[1],, "@E 999.99",, "N/W*",,,,, .F., {||     ( !aTmp[14] .AND. nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )







        aGet[18] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[18], aTmp[18]:= u ) }, oFld:aDialogs[1],, "@E 999.99",, "N/W*",,,,, .F., {||     ( !aTmp[14] .AND. nMode <> 3 .AND. !lTotLin )},, .F., .T.,,,,,, nil,,, )

      if !aTmp[ 71 ]





      oComisionLinea := TGetHlp():ReDefine( 201, { | u | If( PCount()==0, nComisionLinea, nComisionLinea:= u ) }, oFld:aDialogs[ 1 ],, cPorDiv,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

      end











      aGet[33] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[33], aTmp[33]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( !aTmp[14] .AND. aTmp[33] >= 0 )}, ( 255 + ( 0 * 256 ) + ( 0 * 65536 ) ),,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,, {||      0},,, nil,, 261, )













      aGet[ 22 ] := TGetHlp():ReDefine( 290, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cTVta( aGet[ 22 ], dbfTVta, oGet2 ) )},,,,,, .F., {||     ( !aTmp[ 14 ] .AND. nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( BrwTVta( aGet[ 22 ], dbfTVta, oGet2 ) )}, nil, "LUPA", 292, )





        oGet2 := TGetHlp():ReDefine( 291, { | u | If( PCount()==0, cGet2, cGet2:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )











      aGet[ 53 ] := TGetHlp():ReDefine( 205, { | u | If( PCount()==0, aTmp[ 53 ], aTmp[ 53 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oTipArt:lValid( aGet[ 53 ], oGet3 ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( oTipArt:Buscar( aGet[ 53 ] ) )}, nil, "LUPA",, )





      oGet3 := TGetHlp():ReDefine( 206, { | u | If( PCount()==0, cGet3, cGet3:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )












      aGet[ 38 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cNomUbica( aTmp, aGet, dbfAlm ), cAlmacen( aGet[ 38 ], , oSayAlm ), if( !uFieldEmpresa( "lNStkAct" ), oStock:lPutStockActual( aTmp[ 4 ], aTmp[ 38 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 44 ], aTmp[ 46 ], aTmp[ 35 ], oStkAct ), .T. ) )}, "N/W*",,,,, .F., {||     ( !aTmp[ 14 ] .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 38 ], oSayAlm ) )}, nil, "LUPA",, )




      oSayAlm := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSayAlm, cSayAlm:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      aGet[77] := TSay():ReDefine( 612, {|| aTmp[77]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[80] := TGetHlp():ReDefine( 610, { | u | If( PCount()==0, aTmp[80], aTmp[80]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[80], aGet[83], aTmp[77], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[83] := TGetHlp():ReDefine( 611, { | u | If( PCount()==0, aTmp[83], aTmp[83]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      aGet[78] := TSay():ReDefine( 622, {|| aTmp[78]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[81] := TGetHlp():ReDefine( 620, { | u | If( PCount()==0, aTmp[81], aTmp[81]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[81], aGet[84], aTmp[78], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[84] := TGetHlp():ReDefine( 621, { | u | If( PCount()==0, aTmp[84], aTmp[84]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      aGet[79] := TSay():ReDefine( 632, {|| aTmp[79]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[82] := TGetHlp():ReDefine( 630, { | u | If( PCount()==0, aTmp[82], aTmp[82]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[82], aGet[85], aTmp[79], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[85] := TGetHlp():ReDefine( 631, { | u | If( PCount()==0, aTmp[85], aTmp[85]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      oStkAct := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, nStkAct, nStkAct:= u ) }, oFld:aDialogs[1],, cPicUnd,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





        oTotal := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nTotal, nTotal:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






      aGet[36] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[36], aTmp[36]:= u ) }, oFld:aDialogs[1],, cPouDiv,,,,,,, .F., {||     ( oUser():lAdministrador() .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,, 321, )






      aGet[49] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[49], aTmp[49]:= u ) }, oFld:aDialogs[1],, "99",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )










      aGet[ 34 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[2],, "9999",,,,,,, .F., {||     ( .F. )},, .F., .T.,,,,,, nil,,, )




      aGet[25] := TCheckBox():ReDefine( 110, { | u | If( PCount()==0, aTmp[25], aTmp[25]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      aGet[21] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[21], aTmp[21]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[14] := TCheckBox():ReDefine( 130, { | u | If( PCount()==0, aTmp[14], aTmp[14]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )






      aGet[37] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[37], aTmp[37]:= u ) }, oFld:aDialogs[2],, cPouDiv,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








      aGet[ 60 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 60 ], aTmp[ 60 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( ChgBmp( aGet[ 60 ], bmpImage ) ) }, .F., .F.,,,,, {|Self|( GetBmp( aGet[ 60 ], bmpImage ) )}, nil, "LUPA",, )











      aGet[ 55 ] := TGetHlp():ReDefine( ( 150 ), { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[ 2 ],,, {||    ( oSayGrp:cText( RetFld( aTmp[ 55  ], oGrpFam:GetAlias() ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oGrpFam:Buscar( aGet[ 55 ] ) )}, nil, "LUPA",, )




      oSayGrp := TGetHlp():ReDefine( ( 151 ), { | u | If( PCount()==0, cSayGrp, cSayGrp:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











      aGet[ 54 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oSayFam:cText( RetFld( aTmp[ 54  ], dbfFamilia ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFamilia( aGet[ 54 ], oSayFam ) )}, nil, "LUPA",, )




      oSayFam := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cSayFam, cSayFam:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )




      aGet[ 86 ] := TCheckBox():ReDefine( 310, { | u | If( PCount()==0, aTmp[ 86 ], aTmp[ 86 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      aGet[ 87 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ 87 ], aTmp[ 87 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

         aGet[ 87 ]:bValid := {|| oFraPub:lValid( aGet[ 87 ], aGet[ 88 ] ) }
         aGet[ 87 ]:bHelp  := {|| oFraPub:Buscar( aGet[ 87 ] ) }




      aGet[ 88 ] := TGetHlp():ReDefine( 321, { | u | If( PCount()==0, aTmp[ 88 ], aTmp[ 88 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oRentLin := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, cRentLin, cRentLin:= u ) }, oFld:aDialogs[2],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,, 301, )




      aGet[ 47 ] := TCheckBox():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 48 ] := TCheckBox():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 35 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[ 2 ],, { 350, 351, 352 },,,,, .F., {||     ( nMode <> 3 )}, )





      aGet[57] := TMultiGet():ReDefine( 100, { | u | If( PCount()==0, aTmp[57], aTmp[57]:= u ) }, oFld:aDialogs[ 3 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      aGet[ 89 ] := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 89 ], aTmp[ 89 ]:= u ) }, oFld:aDialogs[ 3 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      bmpImage := TBitmap():ReDefine( 220,, ( cFileBitmap( cPatImg(), aTmp[ 60 ] ) ), oDlg,, { |nRow,nCol,nKeyFlags| ( bmpImage:lStretch := !bmpImage:lStretch, bmpImage:Refresh() ) }, .F., .F.,,, .F.,,, .F. )

         bmpImage:SetColor( , GetSysColor( 15 ) )





      oBtn := TButton():ReDefine( 1, {||SaveDeta( aTmp, aTmpAlb, oFld, aGet, oBrw, bmpImage, oDlg, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGet2, oStkAct, nStkAct, oTotal, cCodArt, oBtn, oBtnSer )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 9, {||( ChmHelp( "Añadir_v" ) )}, oDlg,,, .F.,,,, .F. )




      oBtnSer := TButton():ReDefine( 552, {||( EditarNumeroSerie( aTmp, oStock, nMode ) )}, oDlg,,, .F.,,,, .F. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| SaveDeta( aTmp, aTmpAlb, oFld, aGet, oBrw, bmpImage, oDlg, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGet2, oStkAct, nStkAct, oTotal, cCodArt, oBtn, oBtnSer ) } )
   end

   oDlg:AddFastKey( 117, {|| oBtnSer:Click() } )




   oDlg:bStart    := {||   SetDlgMode( aTmp, aGet, oFld, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oStkAct, oGet2, oTotal, aTmpAlb, oRentLin ), if( !Empty( cCodArtEnt ), aGet[ 4 ]:lValid(), ), aGet[ 17 ]:lValid(), lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oRentLin, cCodDiv ) }



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( EdtDetMenu( aGet[ 4 ], oDlg ) )}, oDlg:bRClicked,,, )

   EndDetMenu()

RETURN ( oDlg:nResult == 1 )



Static Function EdtInc( aTmp, aGet, dbfAlbCliI, oBrw, bWhen, bValid, nMode, aTmpAlb )

   local oDlg
   local oNomInci
   local cNomInci       := RetFld( aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], dbfInci )
   local oTitulo
   local cTitulo        := LblTitle( nMode ) + " incidencia"


   if nMode == 1
      aTmp[ 1  ] := aTmpAlb[ 1 ]
      aTmp[ 2  ] := aTmpAlb[ 2 ]
      aTmp[ 3  ] := aTmpAlb[ 3 ]

      if IsMuebles()
         aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]  := .T.
      end
   end

   if ( "PDA" $ cParamsMain() )
      oDlg = TDialog():New(,,,,, "ALBCLI_INC_PDA",, .F.,,,,,, .F.,,,,,, .F., )
   else
      oDlg = TDialog():New(,,,, LblTitle( nMode ) + "incidencias de albaranes a clientes", "INCIDENCIA",, .F.,,,,,, .F.,,,,,, .F., )
   end








      aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ]:= u ) }, oDlg,,, {||    ( cTipInci( aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], dbfInci, oNomInci ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwIncidencia( dbfInci, aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], oNomInci ) )}, nil, "LUPA",, )




      oNomInci := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, cNomInci, cNomInci:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )





      TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )

      if ( "PDA" $ cParamsMain() )



         oTitulo := TSay():ReDefine( 1000, {|| cTitulo}, oDlg,,,, .F.,, .F., .F. )

      end





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



Static Function EdtDoc( aTmp, aGet, dbfAlbCliD, oBrw, bWhen, bValid, nMode, aTmpLin )

   local oDlg
   local oRuta
   local oNombre
   local oObservacion

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "documento de albaranes de clientes", "DOCUMENTOS",, .F.,,,,,, .F.,,,,,, .F., )




      oNombre := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      oRuta := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oRuta:cText( cGetFile( "Doc ( *.* ) | *.*", "Seleccione el nombre del fichero" ) ) )}, nil, "FOLDER",, )





      oObservacion := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



STATIC FUNCTION PrnSerie()

    local oDlg
   local oFmtDoc
   local cFmtDoc     := cFormatoDocumento( ( dbfAlbCliT )->cSerAlb, "nAlbCli", dbfCount )
   local oSayFmt
   local cSayFmt
   local oSerIni
   local oSerFin
   local nRecno      := (dbfAlbCliT)->( Recno() )
   local nOrdAnt     := (dbfAlbCliT)->( OrdSetFocus( 1 ) )
   local cSerIni     := (dbfAlbCliT)->cSerAlb
   local cSerFin     := (dbfAlbCliT)->cSerAlb
   local nDocIni     := (dbfAlbCliT)->nNumAlb
   local nDocFin     := (dbfAlbCliT)->nNumAlb
   local cSufIni     := (dbfAlbCliT)->cSufAlb
   local cSufFin     := (dbfAlbCliT)->cSufAlb
   local oPrinter
   local cPrinter    := PrnGetName()
   local lCopiasPre  := .T.
   local lInvOrden   := .F.
   local oNumCop
   local nNumCop     := if( nCopiasDocumento( ( dbfAlbCliT )->cSerAlb, "nAlbCli", dbfCount ) == 0, Max( Retfld( ( dbfAlbCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( ( dbfAlbCliT )->cSerAlb, "nAlbCli", dbfCount ) )

   if Empty( cFmtDoc )
      cFmtDoc        := cSelPrimerDoc( "AC" )
   end

   cSayFmt           := cNombreDoc( cFmtDoc )

   oDlg = TDialog():New(,,,, "Imprimir series de albaranes", "IMPSERDOC",, .F.,,,,,, .F.,,,,,, .F., )









   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z"  )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )









   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z"  )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )





   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )



   TCheckBox():ReDefine( 500, { | u | If( PCount()==0, lInvOrden, lInvOrden:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 170, { | u | If( PCount()==0, lCopiasPre, lCopiasPre:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oNumCop := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, nNumCop, nNumCop:= u ) }, oDlg,, "999999999", {||    nNumCop > 0},,,,,, .F., {||     !lCopiasPre},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )







   oFmtDoc := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cFmtDoc, cFmtDoc:= u ) }, oDlg,,, {||    ( cDocumento( oFmtDoc, oSayFmt, dbfDoc ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oFmtDoc, oSayFmt, "AC" ) )}, nil, "LUPA",, )





   oSayFmt := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayFmt, cSayFmt:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 92, "Printer_pencil_16",,,,,{|| EdtDocumento( cFmtDoc ) }, oDlg, .F., , .F.,  )




   oPrinter := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cPrinter, cPrinter:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 161, "Printer_preferences_16",,,,,{|| PrinterPreferences( oPrinter ) }, oDlg, .F., , .F.,  )





   TButton():ReDefine( 1, {||(  StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:bStart := { || oSerIni:SetFocus() }

   oDlg:AddFastKey( 116, {|| StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden ), oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   ( dbfAlbCliT )->( dbGoTo( nRecNo ) )
   ( dbfAlbCliT )->( ordSetFocus( nOrdAnt ) )

    oWndBrw:oBrw:refresh()

RETURN NIL



STATIC FUNCTION StartPrint( cFmtDoc, cDocIni, cDocFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden )

   local nCopyClient

   oDlg:disable()

   if !lInvOrden

      ( dbfAlbCliT )->( DbSeek( cDocIni, .T. ) )


      while ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb >= cDocIni .AND.  ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb <= cDocFin

            lChgImpDoc( dbfAlbCliT )

         if lCopiasPre

            nCopyClient := if( nCopiasDocumento( ( dbfAlbCliT )->cSerAlb, "nAlbCli", dbfCount ) == 0, Max( Retfld( ( dbfAlbCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( ( dbfAlbCliT )->cSerAlb, "nAlbCli", dbfCount ) )

            GenAlbCli( 1, "Imprimiendo documento : " + (dbfAlbCliT)->cSerAlb + Str( (dbfAlbCliT)->nNumAlb ) + (dbfAlbCliT)->cSufAlb, cFmtDoc, cPrinter, nCopyClient )

         else

            GenAlbCli( 1, "Imprimiendo documento : " + (dbfAlbCliT)->cSerAlb + Str( (dbfAlbCliT)->nNumAlb ) + (dbfAlbCliT)->cSufAlb, cFmtDoc, cPrinter, nNumCop )

         end

         ( dbfAlbCliT )->( DbSkip( 1 ) )

      end

   else

   ( dbfAlbCliT )->( DbSeek( cDocFin ) )



      while ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb >= cDocIni .AND. ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb <= cDocFin .AND. !( dbfAlbCliT )->( Bof() )

            lChgImpDoc( dbfAlbCliT )

         if lCopiasPre

            nCopyClient := if( nCopiasDocumento( ( dbfAlbCliT )->cSerAlb, "nAlbCli", dbfCount ) == 0, Max( Retfld( ( dbfAlbCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( ( dbfAlbCliT )->cSerAlb, "nAlbCli", dbfCount ) )

            GenAlbCli( 1, "Imprimiendo documento : " + ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb, cFmtDoc, cPrinter, nCopyClient )

         else

            GenAlbCli( 1, "Imprimiendo documento : " + ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb, cFmtDoc, cPrinter, nNumCop )

         end

         ( dbfAlbCliT )->( DbSkip( -1 ) )

      end

   end

   oDlg:enable()

RETURN NIL






static function nTotalUnd( nAlbaran, dbfAlbCliL, cPicUnd )

   local nTotUnd  := 0
   local nRecNum  := ( dbfAlbCliL )->( RecNo() )

   if ( dbfAlbCliL )->( DbSeek( nAlbaran ) )
      while  ( dbfAlbCliL )->CSERALB + Str( ( dbfAlbCliL )->NNUMALB ) + ( dbfAlbCliL )->CSUFALB == nAlbaran .AND. ( dbfAlbCliL )->( !eof() )
         nTotUnd  += nTotNAlbCli( dbfAlbCliL )
         ( dbfAlbCliL )->( dbSkip() )
      end
   end

   ( dbfAlbCliL )->( dbGoTo( nRecNum ) )

RETURN ( Trans( nTotUnd, cPicUnd ) )



Function aTotAlbCli( cAlbaran, dbfMaster, dbfLine, dbfIva, dbfDiv, cDivRet, lExcCnt )

   nTotAlbCli( cAlbaran, dbfMaster, dbfLine, dbfIva, dbfDiv, nil, cDivRet, .F., lExcCnt )

Return ( { nTotNet, nTotIva, nTotReq, nTotAlb, nTotPnt, nTotTrn, nTotAge, aTotIva, nTotCos, nTotIvm, nTotRnt, nTotDto, nTotDpp, nTotUno, nTotDos, nTotBrt } )



Function sTotAlbCli( cAlbaran, dbfMaster, dbfLine, dbfIva, dbfDiv, cDivRet, lExcCnt )

   local sTotal

   nTotAlbCli( cAlbaran, dbfMaster, dbfLine, dbfIva, dbfDiv, nil, cDivRet, .F., lExcCnt )

   sTotal                                 := sTotal()
   sTotal:nTotalBruto                     := nTotBrt
   sTotal:nTotalNeto                      := nTotNet
   sTotal:nTotalIva                       := nTotIva
   sTotal:aTotalIva                       := aTotIva
   sTotal:nTotalRecargoEquivalencia       := nTotReq
   sTotal:nTotalDocumento                 := nTotAlb
   sTotal:nTotalPuntoVerde                := nTotPnt
   sTotal:nTotalTransporte                := nTotTrn
   sTotal:nTotalAgente                    := nTotAge
   sTotal:nTotalCosto                     := nTotCos
   sTotal:nTotalImpuestoHidrocarburos     := nTotIvm
   sTotal:nTotalRentabilidad              := nTotRnt
   sTotal:nTotalDescuentoGeneral          := nTotDto
   sTotal:nTotalDescuentoProntoPago       := nTotDpp
   sTotal:nTotalDescuentoUno              := nTotUno
   sTotal:nTotalDescuentoDos              := nTotDos

Return ( sTotal )



Static Function QuiAlbCli()

   local nOrdLin
   local nOrdPgo
   local nOrdInc
   local nOrdDoc
   local cNumPed

   if ( dbfAlbCliT )->lCloAlb .AND. !oUser():lAdministrador()
      msgStop( "Solo pueden eliminar albarares cerrados los administradores." )
      Return .F.
   end

   cNumPed        := ( dbfAlbCliT )->cNumPed
   nOrdLin        := ( dbfAlbCliL )->( OrdSetFocus( "nNumAlb" ) )
   nOrdPgo        := ( dbfAlbCliP )->( OrdSetFocus( "nNumAlb" ) )
   nOrdInc        := ( dbfAlbCliI )->( OrdSetFocus( "nNumAlb" ) )
   nOrdDoc        := ( dbfAlbCliD )->( OrdSetFocus( "nNumAlb" ) )





   while ( dbfAlbCliP )->( dbSeek( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb ) ) .AND. !( dbfAlbCliP )->( eof() )

      if ( dbfPedCliP )->( dbSeek( ( dbfAlbCliP )->cNumRec ) )
         if dbLock( dbfPedCliP )
            ( dbfPedCliP )->lPasado := .F.
            ( dbfPedCliP )->( dbUnLock() )
         end
      end

      if dbDialogLock( dbfAlbCliP )
         ( dbfAlbCliP )->( dbDelete() )
         ( dbfAlbCliP )->( dbUnLock() )
      end

      ( dbfAlbCliP )->( dbSkip() )

   end





   while ( dbfAlbCliL )->( dbSeek( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT  )->cSufAlb ) ) .AND. !( dbfAlbCliL )->( eof() )
      if dbLock( dbfAlbCliL )
         ( dbfAlbCliL )->( dbDelete() )
         ( dbfAlbCliL )->( dbUnLock() )
      end
   end





   while ( dbfAlbCliI )->( dbSeek( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT  )->cSufAlb ) ) .AND. !( dbfAlbCliI )->( eof() )
      if dbLock( dbfAlbCliI )
         ( dbfAlbCliI )->( dbDelete() )
         ( dbfAlbCliI )->( dbUnLock() )
      end
   end





   while ( dbfAlbCliD )->( dbSeek( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT  )->cSufAlb ) ) .AND. !( dbfAlbCliD )->( eof() )
      if dbLock( dbfAlbCliD )
         ( dbfAlbCliD )->( dbDelete() )
         ( dbfAlbCliD )->( dbUnLock() )
      end
   end





   while ( dbfAlbCliS )->( dbSeek( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT  )->cSufAlb ) ) .AND. !( dbfAlbCliS )->( eof() )
      if dbLock( dbfAlbCliS )
         ( dbfAlbCliS )->( dbDelete() )
         ( dbfAlbCliS )->( dbUnLock() )
      end
   end





   if !Empty( cNumPed )
      oStock:SetEstadoPedCli( cNumPed, .T., ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT  )->cSufAlb )
   end





   if dbSeekInOrd( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT  )->cSufAlb, "cNumAlb", dbfPedCliT )

      while ( dbfPedCliT )->cNumAlb == ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT  )->cSufAlb .AND. !( dbfPedCliT )->( Eof() )

         if dbLock( dbfPedCliT )
            ( dbfPedCliT )->cNumAlb    := ""
            ( dbfPedCliT )->nEstado    := 1
            ( dbfPedCliT )->( dbUnLock() )
         end

         ( dbfPedCliT )->( dbSkip() )

      end

   end

   ( dbfAlbCliL )->( OrdSetFocus( nOrdLin ) )
   ( dbfAlbCliP )->( OrdSetFocus( nOrdPgo ) )
   ( dbfAlbCliI )->( OrdSetFocus( nOrdInc ) )
   ( dbfAlbCliD )->( OrdSetFocus( nOrdDoc ) )

Return .T.



FUNCTION BrwAlbCli( oGet, oIva )

    local oDlg
    local oBrw
   local oGet1
   local cGet1
   local lIva     := oIva:VarGet()
   local oCbxOrd
   local cCbxOrd
   local nOrd
   local aCbxOrd

   if !OpenFiles()
      Return .F.
   end

   aCbxOrd        := { "N. albarán", "Fecha", "Cliente", "Nombre", "Su albarán" }
   nOrd           := GetBrwOpt( "BrwAlbCli" )
   nOrd           := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd        := aCbxOrd[ nOrd ]

   ( dbfAlbCliT )->( dbSetFilter( {|| !Field->lFacturado .AND. Field->lIvaInc == lIva }, "!lFacturado .and. lIvaInc == lIva" ) )
   ( dbfAlbCliT )->( dbGoTop() )

   oDlg = TDialog():New(,,,, if( lIva, "Albaranes de clientes con " + cImp() + " incluido", "Albaranes de clientes con " + cImp() + " desglosado" ), "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F., )






        oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, dbfAlbCliT ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, dbfAlbCliT, .T., nil, .T. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( dbfAlbCliT )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:refresh(), oGet1:SetFocus() )},,,, .F.,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := dbfAlbCliT
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Albaran de cliente.Browse"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Tipo"
         :bEditValue       := {|| aTipAlb[ if( ( dbfAlbCliT )->lAlquiler, 2, 1  ) ] }
         :nWidth           := 50
         :lHide            := .T.
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumAlb"
         :bEditValue       := {|| ( dbfAlbCliT )->cSerAlb + "/" + Alltrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + "/" + ( dbfAlbCliT )->cSufAlb }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecAlb"
         :bEditValue       := {|| dtoc( ( dbfAlbCliT )->dFecAlb ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Cliente"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| AllTrim( ( dbfAlbCliT )->cCodCli ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| AllTrim( ( dbfAlbCliT )->cNomCli ) }
         :nWidth           := 200
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotAlbCli( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb, dbfAlbCliT, dbfAlbCliL, dbfIva, dbfDiv, nil, cDivEmp(), .T. )  }
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end




        TButton():ReDefine( 500, {||( WinAppRec( oBrw, bEdtRec, dbfAlbCliT ) )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 501, {||( WinEdtRec( oBrw, bEdtRec, dbfAlbCliT ) )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

      oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

      oDlg:bStart    := {|| oBrw:Refresh( .T. ) }



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   DestroyFastFilter( dbfAlbCliT )

   SetBrwOpt( "BrwAlbCli", ( dbfAlbCliT )->( OrdNumber() ) )

   ( dbfAlbCliT )->( dbClearFilter() )

   if oDlg:nResult == 1
      oGet:cText( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb )
      oGet:lValid()
   end

   CloseFiles()

RETURN ( oDlg:nResult == 1 )







STATIC FUNCTION cPedCli( aGet, aTmp, oBrwLin, oBrwPgo, nMode )

   local nDiv
   local cDesAlb
   local nTotRet
   local cPedido  := aGet[ 30 ]:VarGet()
   local lValid   := .F.

   if nMode <> 1 .OR. Empty( cPedido )
      Return .T.
   end

   if ( dbfPedCliT )->( dbSeek( cPedido ) )

      CursorWait()

      if ( dbfPedCliT )->nEstado == 3

         MsgStop( "Pedido recibido" )
         lValid   := .F.

      else

         aGet[ 1 ]:cText( (dbfPedCliT)->cSerPed )
         aGet[ 30 ]:bWhen := {|| .F. }

         aGet[ 6 ]:cText( (dbfPedCliT)->CCODCLI )
         aGet[ 6 ]:lValid()
         aGet[ 6 ]:Disable()

         aGet[ 9 ]:cText( (dbfPedCliT)->CNOMCLI )
         aGet[ 10 ]:cText( (dbfPedCliT)->CDIRCLI )
         aGet[ 11 ]:cText( (dbfPedCliT)->CPOBCLI )
         aGet[ 12 ]:cText( (dbfPedCliT)->CPRVCLI )
         aGet[ 13 ]:cText( (dbfPedCliT)->CPOSCLI )
         aGet[ 14 ]:cText( (dbfPedCliT)->CDNICLI )
         aGet[ 7 ]:cText( (dbfPedCliT)->CCODALM )
         aGet[ 86 ]:cText( (dbfPedCliT)->CTLFCLI )
         aGet[ 7 ]:lValid()

         aGet[ 8 ]:cText( (dbfPedCliT)->cCodCaj )
         aGet[ 8 ]:lValid()

         aGet[ 23]:cText( (dbfPedCliT)->CCODPGO )
         aGet[ 23]:lValid()

         aGet[ 26 ]:cText( (dbfPedCliT)->CCODAGE )
         aGet[ 26 ]:lValid()

         aGet[ 49 ]:cText( ( dbfPedCliT )->nPctComAge )

         aGet[ 28 ]:cText( (dbfPedCliT)->CCODTAR )
         aGet[ 28 ]:lValid()

         aGet[ 27 ]:cText( (dbfPedCliT)->CCODOBR )
         aGet[ 27 ]:lValid()

         aGet[ 34 ]:cText( ( dbfPedCliT )->nTarifa )

         aGet[ 65 ]:cText( ( dbfPedCliT )->cCodTrn )
         aGet[ 65 ]:lValid()

         aGet[ 57 ]:Click( ( dbfPedCliT )->lIvaInc )
         aGet[ 48]:Click( ( dbfPedCliT )->lRecargo )
         aGet[ 92 ]:Click( ( dbfPedCliT )->lOperPv )





         aGet[ 20 ]:cText( ( dbfPedCliT )->cCondEnt )
         aGet[ 21  ]:cText( ( dbfPedCliT )->mComent )
         aGet[ 22  ]:cText( ( dbfPedCliT )->mObserv )





         aGet[35]:cText( ( dbfPedCliT )->cDtoEsp )
         aGet[36]:cText( ( dbfPedCliT )->nDtoEsp )
         aGet[37   ]:cText( ( dbfPedCliT )->cDpp    )
         aGet[38   ]:cText( ( dbfPedCliT )->nDpp    )
         aGet[39]:cText( ( dbfPedCLiT )->cDtoUno )
         aGet[40]:cText( ( dbfPedCLiT )->nDtoUno )
         aGet[41]:cText( ( dbfPedCLiT )->cDtoDos )
         aGet[42]:cText( ( dbfPedCLiT )->nDtoDos )
         aGet[83]:cText( ( dbfPedCliT )->cManObr )
         aGet[63]:cText( ( dbfPedCliT )->nIvaMan )
         aGet[64]:cText( ( dbfPedCliT )->nManObr )
         aGet[24]:cText( ( dbfPedCliT )->nBultos )

         aTmp[56 ]                := ( dbfPedCliT )->cSuPed





         aTmp[72]                := ( dbfPedCliT )->cCodGrp
         aTmp[15]                := ( dbfPedCliT )->lModCli
         aTmp[92]                := ( dbfPedCliT )->lOperPv





         aTmp[ 82 ]            := ( dbfPedCliT )->lAlquiler
         aTmp[ 80  ]            := ( dbfPedCliT )->dFecEntr
         aTmp[ 81   ]            := ( dbfPedCliT )->dFecSal

         if !Empty( oTipAlb )
            if ( dbfPedCliT )->lAlquiler
               oTipAlb:Select( 2 )
            else
               oTipAlb:Select( 1 )
            end
         end





         if ( dbfPedCliL )->( dbSeek( cPedido ) )

            if lNumPed()
               ( dbfTmpLin )->( dbAppend() )
               cDesAlb                 := Rtrim( cNumPed() ) + Space( 1 ) + ( dbfPedCliT )->cSerPed + "/" + AllTrim( Str( ( dbfPedCliT )->NNUMPED ) ) + "/" + ( dbfPedCliT )->CSUFPED
               cDesAlb                 += " - Fecha " + Dtoc( (dbfPedCliT)->dFecPed )
               (dbfTmpLin)->cDetalle   := cDesAlb
               (dbfTmpLin)->lControl   := .T.
            end

            while ( ( dbfPedCliL )->cSerPed + Str( ( dbfPedCliL )->nNumPed ) + ( dbfPedCliL )->cSufPed == cPedido )

               nTotRet              := ( dbfPedCliL )->nUniCaja
               nTotRet              -= nUnidadesRecibidasAlbCli( cPedido, ( dbfPedCliL )->cRef, ( dbfPedCliL )->cCodPr1, ( dbfPedCliL )->cCodPr2, ( dbfPedCliL )->cRefPrv, ( dbfPedCliL )->cDetalle, dbfAlbCliL )
               nTotRet              -= nUnidadesRecibidasFacCli( cPedido, ( dbfPedCliL )->cRef, ( dbfPedCliL )->cCodPr1, ( dbfPedCliL )->cCodPr2, dbfFacCliL )



                  (dbfTmpLin)->( dbAppend() )

                  (dbfTmpLin)->nNumAlb    := 0
                  (dbfTmpLin)->nNumLin    := (dbfPedCliL)->nNumLin
                  (dbfTmpLin)->cRef       := (dbfPedCliL)->cRef
                  (dbfTmpLin)->cDetalle   := (dbfPedCliL)->cDetalle
                  (dbfTmpLin)->mLngDes    := (dbfPedCliL)->mLngDes
                  (dbfTmpLin)->mNumSer    := (dbfPedCliL)->mNumSer
                  (dbfTmpLin)->nPreUnit   := (dbfPedCliL)->nPreDiv
                  (dbfTmpLin)->nPntVer    := (dbfPedCliL)->nPntVer
                  (dbfTmpLin)->nImpTrn    := (dbfPedCliL)->nImpTrn
                  (dbfTmpLin)->nUndKit    := (dbfPedCliL)->nUndKit
                  (dbfTmpLin)->nPesoKg    := (dbfPedCliL)->nPesoKg
                  (dbfTmpLin)->cPesoKg    := (dbfPedCliL)->cPesoKg
                  (dbfTmpLin)->cUnidad    := (dbfPedCliL)->cUnidad
                  (dbfTmpLin)->nVolumen   := (dbfPedCliL)->nVolumen
                  (dbfTmpLin)->cVolumen   := (dbfPedCliL)->cVolumen
                  (dbfTmpLin)->nIva       := (dbfPedCliL)->nIva
                  (dbfTmpLin)->nReq       := (dbfPedCliL)->nReq
                  (dbfTmpLin)->cUnidad    := (dbfPedCliL)->cUnidad
                  (dbfTmpLin)->nDto       := (dbfPedCliL)->nDto
                  (dbfTmpLin)->nDtoPrm    := (dbfPedCliL)->nDtoPrm
                  (dbfTmpLin)->nComAge    := (dbfPedCliL)->nComAge
                  (dbfTmpLin)->lTotLin    := (dbfPedCliL)->lTotLin
                  (dbfTmpLin)->nDtoDiv    := (dbfPedCliL)->nDtoDiv
                  (dbfTmpLin)->nCtlStk    := (dbfPedCliL)->nCtlStk
                  (dbfTmpLin)->nCosDiv    := (dbfPedCliL)->nCosDiv
                  (dbfTmpLin)->nPvpRec    := (dbfPedCliL)->nPvpRec
                  (dbfTmpLin)->cTipMov    := (dbfPedCliL)->cTipMov
                  (dbfTmpLin)->cAlmLin    := (dbfPedCliL)->cAlmLin
                  (dbfTmpLin)->lIvaLin    := (dbfPedCliL)->lIvaLin
                  (dbfTmpLin)->cCodImp    := (dbfPedCLiL)->cCodImp
                  (dbfTmpLin)->nValImp    := (dbfPedCliL)->nValImp
                  (dbfTmpLin)->nMesGrt    := (dbfPedCliL)->nMesGrt
                  (dbfTmpLin)->lLote      := (dbfPedCliL)->lLote
                  (dbfTmpLin)->nLote      := (dbfPedCliL)->nLote
                  (dbfTmpLin)->cLote      := (dbfPedCliL)->cLote
                  (dbfTmpLin)->lKitArt    := (dbfPedCliL)->lKitArt
                  (dbfTmpLin)->lKitChl    := (dbfPedCliL)->lKitChl
                  (dbfTmpLin)->lKitPrc    := (dbfPedCliL)->lKitPrc
                  (dbfTmpLin)->lMsgVta    := (dbfPedCliL)->lMsgVta
                  (dbfTmpLin)->lNotVta    := (dbfPedCliL)->lNotVta
                  (dbfTmpLin)->cCodPr1    := (dbfPedCliL)->cCodPr1
                  (dbfTmpLin)->cCodPr2    := (dbfPedCliL)->cCodPr2
                  (dbfTmpLin)->cValPr1    := (dbfPedCliL)->cValPr1
                  (dbfTmpLin)->cValPr2    := (dbfPedCliL)->cValPr2
                  (dbfTmpLin)->lImpLin    := (dbfPedCliL)->lImpLin
                  (dbfTmpLin)->cCodTip    := (dbfPedCliL)->cCodTip
                  (dbfTmpLin)->mObsLin    := (dbfPedCliL)->mObsLin
                  (dbfTmpLin)->Descrip    := (dbfPedCliL)->Descrip
                  (dbfTmpLin)->cCodPrv    := (dbfPedCliL)->cCodPrv
                  (dbfTmpLin)->cNomPrv    := (dbfPedCliL)->cNomPrv
                  (dbfTmpLin)->cImagen    := (dbfPedCliL)->cImagen
                  (dbfTmpLin)->cCodFam    := (dbfPedCliL)->cCodFam
                  (dbfTmpLin)->cGrpFam    := (dbfPedCliL)->cGrpFam
                  (dbfTmpLin)->cRefPrv    := (dbfPedCliL)->cRefPrv
                  (dbfTmpLin)->dFecEnt    := (dbfPedCliL)->dFecEnt
                  (dbfTmpLin)->dFecSal    := (dbfPedCliL)->dFecSal
                  (dbfTmpLin)->nPreAlq    := (dbfPedCliL)->nPreAlq
                  (dbfTmpLin)->lAlquiler  := (dbfPedCliL)->lAlquiler
                  (dbfTmpLin)->nNumMed    := (dbfPedCliL)->nNumMed
                  (dbfTmpLin)->nMedUno    := (dbfPedCliL)->nMedUno
                  (dbfTmpLin)->nMedDos    := (dbfPedCliL)->nMedDos
                  (dbfTmpLin)->nMedTre    := (dbfPedCliL)->nMedTre
                  (dbfTmpLin)->nPuntos    := (dbfPedCliL)->nPuntos
                  (dbfTmpLin)->nValPnt    := (dbfPedCliL)->nValPnt
                  (dbfTmpLin)->nDtoPnt    := (dbfPedCliL)->nDtoPnt
                  (dbfTmpLin)->nIncPnt    := (dbfPedCliL)->nIncPnt
                  (dbfTmpLin)->cNumPed    := cPedido
                  (dbfTmpLin)->lControl   := (dbfPedCliL)->lControl
                  (dbfTmpLin)->lLinOfe    := (dbfPedCliL)->lLinOfe





                  if dbSeekInOrd( cPedido + ( dbfPedCliL )->cRef + ( dbfPedCliL )->cValPr1 + ( dbfPedCliL )->cValPr2 + ( dbfPedCliL )->cLote + ( dbfPedCliL )->cDetalle, "cPCliDet", dbfAlbPrvL )

                     ( dbfTmpLin )->cCodUbi1 := ( dbfAlbPrvL )->cCodUbi1
                     ( dbfTmpLin )->cCodUbi2 := ( dbfAlbPrvL )->cCodUbi2
                     ( dbfTmpLin )->cCodUbi3 := ( dbfAlbPrvL )->cCodUbi3
                     ( dbfTmpLin )->cValUbi1 := ( dbfAlbPrvL )->cValUbi1
                     ( dbfTmpLin )->cValUbi2 := ( dbfAlbPrvL )->cValUbi2
                     ( dbfTmpLin )->cValUbi3 := ( dbfAlbPrvL )->cValUbi3
                     ( dbfTmpLin )->cNomUbi1 := ( dbfAlbPrvL )->cNomUbi1
                     ( dbfTmpLin )->cNomUbi2 := ( dbfAlbPrvL )->cNomUbi2
                     ( dbfTmpLin )->cNomUbi3 := ( dbfAlbPrvL )->cNomUbi3

                  end

                  if !( dbfPedCliL )->lKitArt





                     if lCalCaj()

                        nDiv                       := DecimalMod( nTotRet, ( dbfPedCliL )->nCanPed )
                        if nDiv == 0 .AND. ( dbfPedCliL )->nCanPed <> 0
                           ( dbfTmpLin )->nCanEnt  := ( dbfPedCliL )->nCanPed
                           ( dbfTmpLin )->nUniCaja := nTotRet
                        else
                           ( dbfTmpLin )->nCanEnt  := ( dbfPedCliL )->nCanPed
                           ( dbfTmpLin )->nUniCaja := nTotRet
                        end

                     else

                        ( dbfTmpLin )->nUniCaja    := nTotRet

                     end

                  else

                     ( dbfTmpLin )->nCanEnt  := ( dbfPedCliL )->nCanPed
                     ( dbfTmpLin )->nUniCaja := ( dbfPedCliL )->nUniCaja

                  end



               ( dbfPedCliL )->( dbSkip( 1 ) )

            end

            ( dbfTmpLin )->( dbGoTop() )





            if ( dbfPedCliP )->( dbSeek( cPedido ) )

               while ( dbfPedCliP )->cSerPed + Str( ( dbfPedCliP )->nNumPed ) + ( dbfPedCliP )->cSufPed == cPedido .AND. !( dbfPedCliP )->( Eof() )

                  if !( dbfPedCliP )->lPasado

                     ( dbfTmpPgo )->( dbAppend() )

                     ( dbfTmpPgo )->nNumRec  := ( dbfTmpPgo )->( Recno() )
                     ( dbfTmpPgo )->cCodCaj  := ( dbfPedCliP )->cCodCaj
                     ( dbfTmpPgo )->cTurRec  := ( dbfPedCliP )->cTurRec
                     ( dbfTmpPgo )->cCodCli  := ( dbfPedCliP )->cCodCli
                     ( dbfTmpPgo )->dEntrega := ( dbfPedCliP )->dEntrega
                     ( dbfTmpPgo )->nImporte := ( dbfPedCliP )->nImporte
                     ( dbfTmpPgo )->cDescrip := ( dbfPedCliP )->cDesCrip
                     ( dbfTmpPgo )->cPgdoPor := ( dbfPedCliP )->cPgdoPor
                     ( dbfTmpPgo )->cDocPgo  := ( dbfPedCliP )->cDocPgo
                     ( dbfTmpPgo )->cDivPgo  := ( dbfPedCliP )->cDivPgo
                     ( dbfTmpPgo )->nVdvPgo  := ( dbfPedCliP )->nVdvPgo
                     ( dbfTmpPgo )->cCodAge  := ( dbfPedCliP )->cCodAge
                     ( dbfTmpPgo )->cCodPgo  := ( dbfPedCliP )->cCodPgo
                     ( dbfTmpPgo )->cBncEmp  := ( dbfPedCliP )->cBncEmp
                     ( dbfTmpPgo )->cBncCli  := ( dbfPedCliP )->cBncCli
                     ( dbfTmpPgo )->cEntEmp  := ( dbfPedCliP )->cEntEmp
                     ( dbfTmpPgo )->cSucEmp  := ( dbfPedCliP )->cSucEmp
                     ( dbfTmpPgo )->cDigEmp  := ( dbfPedCliP )->cDigEmp
                     ( dbfTmpPgo )->cCtaEmp  := ( dbfPedCliP )->cCtaEmp
                     ( dbfTmpPgo )->cEntCli  := ( dbfPedCliP )->cEntCli
                     ( dbfTmpPgo )->cSucCli  := ( dbfPedCliP )->cSucCli
                     ( dbfTmpPgo )->cDigCli  := ( dbfPedCliP )->cDigCli
                     ( dbfTmpPgo )->cCtaCli  := ( dbfPedCliP )->cCtaCli
                     ( dbfTmpPgo )->lCloPgo  := .F.
                     ( dbfTmpPgo )->cNumRec  := ( dbfPedCliP )->cSerPed + Str( ( dbfPedCliP )->nNumPed ) + ( dbfPedCliP )->cSufPed + Str( ( dbfPedCliP )->nNumRec )

                  end

                  ( dbfPedCliP )->( dbSkip() )

               end

            end

            ( dbfPedCliP )->( dbGoTop() )





            if ( dbfPedCliI )->( dbSeek( cPedido ) )

               while ( dbfPedCliI )->cSerPed + Str( ( dbfPedCliI )->nNumPed ) + ( dbfPedCliI )->cSufPed == cPedido .AND. !( dbfPedCliI )->( Eof() )
                  dbPass( dbfPedCliI, dbfTmpInc, .T. )
                  ( dbfPedCliI )->( dbSkip() )
               end

            end

            ( dbfPedCliI )->( dbGoTop() )





            if ( dbfPedCliD )->( dbSeek( cPedido ) )

               while ( dbfPedCliD )->cSerPed + Str( ( dbfPedCliD )->nNumPed ) + ( dbfPedCliD )->cSufPed == cPedido .AND. !( dbfPedCliD )->( Eof() )
                  dbPass( dbfPedCliD, dbfTmpDoc, .T. )
                  ( dbfPedCliD )->( dbSkip() )
               end

            end

            ( dbfPedCliD )->( dbGoTop() )





            oBrwLin:Refresh()
            oBrwPgo:Refresh()

            oBrwLin:SetFocus()

         end

         lValid   := .T.

      end

      aGet[ 30 ]:Disable()

      CursorWE()

   else

        MsgStop( "Pedido no existe" )

   end

RETURN lValid



FUNCTION nNetUAlbCli( uTmp, nDec, nVdv, lIva )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lIva == nil, lIva := .F., ) ;

   nCalculo          := nTotUAlbCli( uTmp, nDec, nVdv )

   if ( dbfAlbCliL )->nIva <> 0
      do case
         case !lIva .AND. ( dbfAlbCliL )->lIvaLin
            nCalculo -= Round( nCalculo / ( 100 / ( dbfAlbCliL )->nIva + 1 ), nDec )
         case lIva .AND. !( dbfAlbCliL )->lIvaLin
            nCalculo += Round( nCalculo * ( dbfAlbCliL )->nIva / 100, nDec )
      end
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nBrtLAlbCli( uTmpCab, uTmpLin, nDec, nRec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( nDec == nil, nDec := 2, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nImpUAlbCli( uTmpCab, uTmpLin, nDec, nVdv, cPorDiv )
   nCalculo          *= nTotNAlbCli( uTmpLin )

   nCalculo          := Round( nCalculo / nVdv, nRec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )


































FUNCTION nIncUAlbCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUAlbCli( dbfTmpLin, nDec, nVdv )

   if !( dbfTmpLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfTmpLin )->nIva / 100
   end

    IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
    end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION cDesAlbCli( cAlbCliL, cAlbCliS )

   IIF( cAlbCliL == nil, cAlbCliL := dbfAlbCliL, ) ;
   IIF( cAlbCliS == nil, cAlbCliS := dbfAlbCliS, ) ;

RETURN ( Descrip( cAlbCliL, cAlbCliS ) )



Function cFraAlbCli( cAlbCliL )

   local cTxtFra     := ""

   IIF( cAlbCliL == nil, cAlbCliL := dbfAlbCliL, ) ;

   if ( cAlbCliL )->lImpFra
      cTxtFra        := ( cAlbCliL )->cTxtFra
   end

Return ( cTxtFra )






FUNCTION nTotPAlbCli( dbfLin, nDec, nVdv, lDto, cPouDiv )

    local nCalculo

   IIF( dbfLin == nil, dbfLin := dbfAlbCliL, ) ;
   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lDto == nil, lDto := .T., ) ;

   if ( dbfLin )->lTotLin

      nCalculo       := nTotUAlbCli( dbfLin, nDec, nVdv )

   else





      nCalculo       := nTotUAlbCli( dbfLin, nDec, nVdv )

      nCalculo       -= Round( ( dbfLin )->nDtoDiv , nDec )





      IF lDto

         IF ( dbfLin )->NDTO <> 0
            nCalculo -= nCalculo * ( dbfLin )->NDTO / 100
         end

         IF ( dbfLin )->NDTOPRM <> 0
            nCalculo -= nCalculo * ( dbfLin )->NDTOPRM / 100
         end

      end

      nCalculo       := Round( nCalculo, nDec )

   end

RETURN ( if( cPouDiv <> NIL, trans( nCalculo, cPouDiv ), nCalculo ) )







FUNCTION nIncLAlbCli( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo := nTotLAlbCli( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   if !( dbfLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfLin )->nIva / 100
   end

RETURN ( if( cPouDiv <> NIL, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nIvaLAlbCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo := nTotLAlbCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   if !( dbfLin )->lIvaLin
      nCalculo    := nCalculo * ( dbfLin )->nIva / 100
   else
      nCalculo    -= nCalculo / ( 1 + ( dbfLin )->nIva / 100 )
   end

   nCalculo       := Round( nCalculo, nRou )

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )






FUNCTION nNetLAlbCli( cAlbCliT, cAlbCliL, nDec, nRou, nVdv, lIva, lDto, lImpTrn, lPntVer, cPouDiv )

   local nCalculo

   IIF( cAlbCliT == nil, cAlbCliT := dbfAlbCliT, ) ;
   IIF( cAlbCliL == nil, cAlbCliL := dbfAlbCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nRou == nil, nRou := nRouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lIva == nil, lIva := .T., ) ;
   IIF( lDto == nil, lDto := .T., ) ;
   IIF( lPntVer == nil, lPntVer := .T., ) ;
   IIF( lImpTrn == nil, lImpTrn := .T., ) ;

   nCalculo          := nTotLAlbCli( cAlbCliL, nDec, nRou, nVdv, lDto, lImpTrn, lPntVer )

   if ( cAlbCliL )->nIva <> 0
      do case
         case !lIva .AND. ( cAlbCliT )->lIvaInc
            nCalculo -= Round( nCalculo / ( 100 / ( cAlbCliL )->nIva  + 1 ), nRou )
         case lIva .AND. !( cAlbCliT )->lIvaInc
            nCalculo += nCalculo * ( cAlbCliL )->nIva / 100
      end
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nDtoAtpAlbCli( uAlbCliT, dbfAlbCliL, nDec, nRou, nVdv, lImpTrn, lPntVer )

   local nCalculo
   local nDtoAtp  := 0

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRou == nil, nRou := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lPntVer == nil, lPntVer := .F., ) ;
   IIF( lImpTrn == nil, lImpTrn := .F., ) ;

   nCalculo       := nTotLAlbCli( dbfAlbCliL, nDec, nRou, nVdv, .T., lImpTrn, lPntVer )

   if ( uAlbCliT )->nSbrAtp <= 1 .AND. ( uAlbCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uAlbCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDtoEsp / 100, nRou )

   if ( uAlbCliT )->nSbrAtp == 2 .AND. ( uAlbCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uAlbCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDpp    / 100, nRou )

   if ( uAlbCliT )->nSbrAtp == 3 .AND. ( uAlbCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uAlbCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDtoUno / 100, nRou )

   if ( uAlbCliT )->nSbrAtp == 4 .AND. ( uAlbCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uAlbCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDtoDos / 100, nRou )

   if ( uAlbCliT )->nSbrAtp == 5 .AND. ( uAlbCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uAlbCliT )->nDtoAtp / 100, nRou )
   end

RETURN ( nDtoAtp )







FUNCTION Ped2AlbCli( cNumPed )

   local oBlock
   local oError
   local cNumAlb

   oBlock         := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIT.DBF" ), ( cCheckArea( "ALBCLIT", @dbfAlbCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ( dbfAlbCliT )->( OrdSetFocus( "cNumPed" ) )

      if ( dbfAlbCliT )->( dbSeek( cNumPed ) )
         cNumAlb := ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb
      end

      if !Empty( cNumAlb )
         EdtAlbCli( cNumAlb )
      else
         msgStop( "No hay albarán asociado" )
      end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos de albaranes" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end
   ErrorBlock( oBlock )

   ( dbfAlbCliT )->( dbCloseArea() )

RETURN NIL



















STATIC FUNCTION SelSend( oBrw )

   local oDlg
   local oFecEnv
   local dFecEnv  := GetSysDate()

   if dbDialogLock( dbfAlbCliT )

      if ( dbfAlbCliT )->lEntregado

         if lUsrMaster()

            ( dbfAlbCliT )->lEntregado := !( dbfAlbCliT )->lEntregado
            ( dbfAlbCliT )->dFecEnv    := Ctod( "" )

         else

            MsgStop( "Sin autorizacion para cambio de entrega" )

         end

      else

         oDlg = TDialog():New(,,,, "Fecha entrega", "ENVIADO",, .F.,,,,,, .F.,,,,,, .F., )






            oFecEnv := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, dFecEnv, dFecEnv:= u ) }, oDlg,,,, "N/W*",,,,, .F.,,, .F., .T.,,,,,, nil, "LUPA",, )







            TButton():ReDefine( 501, {||(  ( dbfAlbCliT )->lEntregado := !( dbfAlbCliT )->lEntregado , ( dbfAlbCliT )->dFecEnv    := dFecEnv , ( dbfAlbCliT )->lSndDoc    := .T. , oDlg:end() )}, oDlg,,, .F.,,,, .F. )




            TButton():ReDefine( 502, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

         oDlg:AddFastKey( 116, {|| ( dbfAlbCliT )->lEntregado := !( dbfAlbCliT )->lEntregado , ( dbfAlbCliT )->dFecEnv    := dFecEnv , ( dbfAlbCliT )->lSndDoc    := .T. , oDlg:end() } )
         oDlg:bStart := { || oFecEnv:SetFocus() }

         oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

      end

   ( dbfAlbCliT )->( dbUnLock() )

   end

   oBrw:Refresh()
   oBrw:SetFocus()

RETURN NIL






































FUNCTION dFecAlbCli( cAlbCli, uAlbCliT )

   local dFecAlb  := CtoD( "" )

   if ValType( uAlbCliT ) == "C"

      if dbSeekInOrd( cAlbCli, "nNumAlb", uAlbCliT )
         dFecAlb  := ( uAlbCliT )->dFecAlb
      end

   else

      if uAlbCliT:SeekInOrd( cAlbCli, "nNumAlb" )
         dFecAlb  := uAlbCliT:dFecAlb
      end

   end

RETURN ( dFecAlb )



FUNCTION cCliAlbCli( cAlbCli, uAlbCliT )

   local cCodCli  := ""

   do case
      case ValType( uAlbCliT ) == "C"
         if (uAlbCliT)->( dbSeek( cAlbCli ) )
            cCodCli     := (uAlbCliT)->CCODCLI
         end
      case ValType( uAlbCliT ) == "O"
         if uAlbCliT:Seek( cAlbCli )
            cCodCli     := uAlbCliT:cCodCli
         end
   end

RETURN ( cCodCli )



FUNCTION cNbrAlbCli( cAlbCli, uAlbCliT )

   local cCodCli  := ""

   do case
      case ValType( uAlbCliT ) == "C"
         if (uAlbCliT)->( dbSeek( cAlbCli ) )
            cCodCli     := ( uAlbCliT )->cNomCli
         end
      case ValType( uAlbCliT ) == "O"
         if uAlbCliT:Seek( cAlbCli )
            cCodCli     := uAlbCliT:cNomCli
         end
   end

RETURN ( cCodCli )







STATIC FUNCTION GrpPed( aGet, aTmp, oBrw )

    local oDlg
   local nDiv
   local cCodAge
   local oBrwLin
   local nOrdAnt
   local nNumLin
   local lCodAge     := .F.
   local nOffSet     := 0
   local cDesAlb     := ""
    local nItem         := 1
   local cCodCli     := aGet[ 6 ]:varGet()
   local nTotPed
   local nTotRec
   local nTotPdt
   local lAlquiler   := .F.

   aAlbaranes        := {}

   if Empty( cCodCli )
      msgStop( "Es necesario codificar un cliente", "Agrupar pedidos" )
      return .T.
   end

   if !Empty( aGet[ 30 ]:VarGet() )
      msgStop( "Ya ha importado un pedido", "Agrupar pedidos" )
      return .T.
   end

   nOrdAnt           := ( dbfPedCliT )->( ordSetFocus( "CCODCLI" ) )

   if !Empty( oTipAlb ) .AND. oTipAlb:nAt == 2
      lAlquiler      := .T.
   end






   if ( dbfPedCliT )->( dbSeek( cCodCli ) )

      while ( dbfPedCliT )->CCODCLI == cCodCli .AND. ( dbfPedCliT )->( !eof() )





         if ( dbfPedCliT )->lAlquiler == lAlquiler                                              .AND. ( dbfPedCliT )->nEstado <> 3                                                        .AND. ( dbfPedCliT )->lIvaInc == aTmp[ 57 ]                                         .AND. if( Empty( aTmp[ 27 ] ), .T., ( dbfPedCliT )->cCodObr == aTmp[ 27 ] )   .AND. aScan( aNumPed, ( dbfPedCliT )->cSerPed + Str( ( dbfPedCliT )->nNumPed ) + ( dbfPedCliT )->cSufPed ) == 0









            aAdd( aAlbaranes,    {  .F. , ( if( ( dbfPedCliT )->nEstado == 1, 3, ( dbfPedCliT )->nEstado ) ), ( dbfPedCliT )->cSerPed + Str( ( dbfPedCliT )->nNumPed ) + ( dbfPedCliT )->cSufPed, ( dbfPedCliT )->dFecPed , ( dbfPedCliT )->cCodCli , ( dbfPedCliT )->cNomCli , ( dbfPedCliT )->cCodObr , RetObras( ( dbfPedCliT )->cCodCli, ( dbfPedCliT )->cCodObr, dbfObrasT ), ( dbfPedCliT )->cCodAge  } )

         endif

         ( dbfPedCliT )->( dbSkip( 1 ) )

      end

   else

      msgStop( "No existen pedidos de este cliente" )

   end

   ( dbfPedCliT )->( ordSetFocus( nOrdAnt ) )





   if Len( aAlbaranes ) == 0

      msgStop( "No existen pedidos pendientes de albaranar de este cliente" )

      return .T.

   end










   oDlg = TDialog():New(,,,, "Cliente : "   + RTrim( aTmp[9] ) + Space(1) +  "Obra : "      + if( Empty( aTmp[27] ), "TODAS", Rtrim( aTmp[27] ) ) + Space(1) +  "Pedidos: "    + if( aTmp[ 57 ], "IGIC incluido", "IGIC desglosado" ), "SET_ALBARAN",, .F.,,,,,, .F.,,,,,, .F., )

      oBrwLin                       := TXBrowse():New( oDlg )

      oBrwLin:bClrSel               := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus          := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwLin:SetArray( aAlbaranes, , , .F. )
      oBrwLin:lHscroll              := .F.

      oBrwLin:nMarqueeStyle         := 5
      oBrwLin:lRecordSelector       := .F.

      oBrwLin:CreateFromResource( 130 )

      oBrwLin:bLDblClick            := {|| aAlbaranes[ oBrwLin:nArrayAt, 1 ] := !aAlbaranes[ oBrwLin:nArrayAt, 1 ], oBrwLin:refresh() }

      with object ( oBrwLin:AddCol() )
         :cHeader          := "Seleccionado"
         :bStrData         := {|| "" }
         :bEditValue       := {|| aAlbaranes[ oBrwLin:nArrayAt, 1 ] }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader          := "Estado"
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( aAlbaranes[ oBrwLin:nArrayAt, 2 ] == 2 ) }
         :nWidth           := 20
         :SetCheck( { "Bullet_Square_Yellow_16", "Bullet_Square_Red_16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader          := "Número"
         :bEditValue       := {|| aAlbaranes[ oBrwLin:nArrayAt, 3 ] }
         :cEditPicture     := "@R #/999999999/##"
         :nWidth           := 80
      end

      with object ( oBrwLin:AddCol() )
         :cHeader          := "Fecha"
         :bEditValue       := {|| Dtoc( aAlbaranes[ oBrwLin:nArrayAt, 4 ] ) }
         :nWidth           := 80
      end

      with object ( oBrwLin:AddCol() )
         :cHeader          := "Cliente"
         :bEditValue       := {|| Rtrim( aAlbaranes[ oBrwLin:nArrayAt, 5 ] ) + Space(1) + aAlbaranes[ oBrwLin:nArrayAt, 6 ] }
         :nWidth           := 250
      end

      with object ( oBrwLin:AddCol() )
         :cHeader          := "Obra"
         :bEditValue       := {|| Rtrim( aAlbaranes[ oBrwLin:nArrayAt, 7 ] ) + Space(1) + aAlbaranes[ oBrwLin:nArrayAt, 8 ] }
         :nWidth           := 220
      end

      with object ( oBrwLin:AddCol() )
         :cHeader          := "Agente"
         :bEditValue       := {|| aAlbaranes[ oBrwLin:nArrayAt, 9 ] }
         :lHide            := .T.
         :nWidth           := 60
      end






      TButton():ReDefine( 514, {||(  aAlbaranes[ oBrwLin:nArrayAt, 1 ] := !aAlbaranes[ oBrwLin:nArrayAt, 1 ], oBrwLin:refresh(), oBrwLin:setFocus() )}, oDlg,,, .F.,,,, .F. )






      TButton():ReDefine( 516, {||(  aEval( aAlbaranes, { |aItem| aItem[1] := .T. } ), oBrwLin:refresh(), oBrwLin:setFocus() )}, oDlg,,, .F.,,,, .F. )






      TButton():ReDefine( 517, {||(  aEval( aAlbaranes, { |aItem| aItem[1] := .F. } ), oBrwLin:Refresh(), oBrwLin:SetFocus() )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult <> 1
      aAlbaranes  := {}
   end





   if oDlg:nResult == 1 .AND. Len( aAlbaranes ) >= 1





      for nItem := 1 to Len( aAlbaranes )

         if ( aAlbaranes[ nItem, 1 ] )

            aAdd( aNumPed, aAlbaranes[ nItem, 3 ] )

            if Empty( cCodAge )
               cCodAge  := aAlbaranes[ nItem, 9 ]
            end

            if cCodAge <> aAlbaranes[ nItem, 9 ]
               lCodAge  := .T.
            end

         end

      next

      if lCodAge
         MsgInfo( "Existen conflictos de agentes" )
      end

      for nItem := 1 to Len( aAlbaranes )





         if !lCodAge .AND. cCodAge <> nil
            aGet[ 26 ]:cText( cCodAge )
            aGet[ 26 ]:lValid()
         end

         if ( dbfPedCliT )->( dbSeek( aAlbaranes[ nItem, 3 ] ) ) .AND. aAlbaranes[ nItem, 1 ]

            if ( dbfPedCliT )->lRecargo
               aTmp[ 48 ] := .T.
               aGet[ 48 ]:Refresh()
            end

            if ( dbfPedCliT )->lOperPv
               aTmp[ 92 ] := .T.
               aGet[ 92 ]:Refresh()
            end

         end





         if ( dbfPedCliL )->( dbSeek( aAlbaranes[ nItem, 3] ) ) .AND. aAlbaranes[ nItem, 1]





            nNumLin                    := nil

            if lNumPed()
               (dbfTmpLin)->( dbAppend() )
               cDesAlb                 := Rtrim( cNumPed() )
               cDesAlb                 += " Pedido Nº " + Alltrim( Trans( aAlbaranes[ nItem, 3 ], "@R #/999999999/##" ) )
               cDesAlb                 += " - Fecha " + Dtoc( aAlbaranes[ nItem, 4] )
               (dbfTmpLin)->mLngDes    := cDesAlb
               (dbfTmpLin)->lControl   := .T.
               (dbfTmpLin)->nNumLin    := ++nOffSet
            end





            while ( dbfPedCliL )->cSerPed + Str( ( dbfPedCliL )->nNumPed ) + ( dbfPedCliL )->cSufPed == aAlbaranes[ nItem, 3]

               if aAlbaranes[ nItem, 2 ] == 2

                  nTotPed              := nTotNPedCli( dbfPedCliL )
                  nTotRec              := nUnidadesRecibidasAlbCli( aAlbaranes[ nItem, 3 ], ( dbfPedCliL )->cRef, ( dbfPedCliL )->cCodPr1, ( dbfPedCliL )->cCodPr2, ( dbfPedCliL )->cRefPrv, ( dbfPedCliL )->cDetalle, dbfAlbCliL )
                  nTotPdt              := nTotPed - nTotRec

                  if nTotPdt > 0

                     if nNumLin <> (dbfPedCliL)->nNumLin
                        ++nOffSet
                        nNumLin        := (dbfPedCliL)->nNumLin
                     end

                     ( dbfTmpLin )->( dbAppend() )

                     ( dbfTmpLin )->cNumPed    := aAlbaranes[ nItem, 3]

                     (dbfTmpLin)->nNumAlb    := 0
                     (dbfTmpLin)->nNumLin    := nOffSet
                     (dbfTmpLin)->cRef       := (dbfPedCliL)->cRef
                     (dbfTmpLin)->cDetalle   := (dbfPedCliL)->cDetalle
                     (dbfTmpLin)->mLngDes    := (dbfPedCliL)->mLngDes
                     (dbfTmpLin)->nPreUnit   := (dbfPedCliL)->nPreDiv
                     (dbfTmpLin)->cUnidad    := (dbfPedCliL)->cUnidad
                     (dbfTmpLin)->nPesoKg    := (dbfPedCliL)->nPesoKg
                     (dbfTmpLin)->cPesoKg    := (dbfPedCliL)->cPesoKg
                     (dbfTmpLin)->nVolumen   := (dbfPedCliL)->nVolumen
                     (dbfTmpLin)->cVolumen   := (dbfPedCliL)->cVolumen
                     (dbfTmpLin)->lIvaLin    := (dbfPedCliL)->lIvaLin
                     (dbfTmpLin)->nIva       := (dbfPedClil)->nIva
                     (dbfTmpLin)->nReq       := (dbfPedClil)->nReq
                     (dbfTmpLin)->nDto       := (dbfPedClil)->nDto
                     (dbfTmpLin)->nPntVer    := (dbfPedCliL)->nPntVer
                     (dbfTmpLin)->nImpTrn    := (dbfPedCliL)->nImpTrn
                     (dbfTmpLin)->nDtoPrm    := (dbfPedCliL)->nDtoPrm
                     (dbfTmpLin)->nComAge    := (dbfPedCliL)->nComAge
                     (dbfTmpLin)->dFecHa     := (dbfPedCliL)->dFecha
                     (dbfTmpLin)->cTipMov    := (dbfPedCliL)->cTipMov
                     (dbfTmpLin)->nDtoDiv    := (dbfPedCliL)->nDtoDiv
                     (dbfTmpLin)->nUndKit    := (dbfPedCliL)->nUndKit
                     (dbfTmpLin)->lKitArt    := (dbfPedCliL)->lKitArt
                     (dbfTmpLin)->lKitChl    := (dbfPedCliL)->lKitChl
                     (dbfTmpLin)->lKitPrc    := (dbfPedCliL)->lKitPrc
                     (dbfTmpLin)->cCodPr1    := (dbfPedCliL)->cCodPr1
                     (dbfTmpLin)->cCodPr2    := (dbfPedCliL)->cCodPr2
                     (dbfTmpLin)->cValPr1    := (dbfPedCliL)->cValPr1
                     (dbfTmpLin)->cValPr2    := (dbfPedCliL)->cValPr2
                     (dbfTmpLin)->nCosDiv    := (dbfPedCliL)->nCosDiv
                     (dbfTmpLin)->nMesGrt    := (dbfPedCliL)->nMesGrt
                     (dbfTmpLin)->lMsgVta    := (dbfPedCliL)->lMsgVta
                     (dbfTmpLin)->lNotVta    := (dbfPedCliL)->lNotVta
                     (dbfTmpLin)->lLote      := (dbfPedCliL)->lLote
                     (dbfTmpLin)->nLote      := (dbfPedCliL)->nLote
                     (dbfTmpLin)->cLote      := (dbfPedCliL)->cLote
                     (dbfTmpLin)->mObsLin    := (dbfPedCliL)->mObsLin
                     (dbfTmpLin)->Descrip    := (dbfPedCliL)->Descrip
                     (dbfTmpLin)->cCodPrv    := (dbfPedCliL)->cCodPrv
                     (dbfTmpLin)->cNomPrv    := (dbfPedCliL)->cNomPrv
                     (dbfTmpLin)->cCodFam    := (dbfPedCliL)->cCodFam
                     (dbfTmpLin)->cGrpFam    := (dbfPedCliL)->cGrpFam
                     (dbfTmpLin)->cAlmLin    := (dbfPedCliL)->cAlmLin
                     (dbfTmpLin)->cRefPrv    := (dbfPedCliL)->cRefPrv
                     (dbfTmpLin)->dFecEnt    := (dbfPedCliL)->dFecEnt
                     (dbfTmpLin)->dFecSal    := (dbfPedCliL)->dFecSal
                     (dbfTmpLin)->lAlquiler  := (dbfPedCliL)->lAlquiler
                     (dbfTmpLin)->nPreAlq    := (dbfPedCliL)->nPreAlq
                     (dbfTmpLin)->nPuntos    := (dbfPedCliL)->nPuntos
                     (dbfTmpLin)->nValPnt    := (dbfPedCliL)->nValPnt
                     (dbfTmpLin)->nDtoPnt    := (dbfPedCliL)->nDtoPnt
                     (dbfTmpLin)->nIncPnt    := (dbfPedCliL)->nIncPnt
                     (dbfTmpLin)->lImpLin    := (dbfPedCliL)->lImpLin
                     (dbfTmpLin)->lLinOfe    := (dbfPedCliL)->lLinOfe

                     if lCalCaj()
                        if nTotRec <> 0
                           nDiv                       := DecimalMod( nTotPdt, ( dbfPedCliL )->nCanPed )
                           if nDiv == 0 .AND. ( dbfPedCliL )->nCanPed <> 0
                              ( dbfTmpLin )->nCanEnt  := ( dbfPedCliL )->nCanPed
                              ( dbfTmpLin )->nUniCaja := nTotPdt / ( dbfPedCliL )->nCanPed
                           else
                              ( dbfTmpLin )->nCanEnt  := 0
                              ( dbfTmpLin )->nUniCaja := nTotPdt
                           end
                        else
                           ( dbfTmpLin )->nCanEnt     := ( dbfPedCliL )->nCanPed
                           ( dbfTmpLin )->nUniCaja    := ( dbfPedCliL )->nUniCaja
                        end
                     else
                        ( dbfTmpLin )->nUniCaja       := nTotPdt
                     end

                  end

               else

                  if nNumLin <> (dbfPedCliL)->nNumLin
                     ++nOffSet
                     nNumLin              := (dbfPedCliL)->nNumLin
                  end

                  (dbfTmpLin)->( dbAppend() )

                  (dbfTmpLin)->cNumPed    := aAlbaranes[ nItem, 3]
                  (dbfTmpLin)->nNumAlb    := 0
                  (dbfTmpLin)->nNumLin    := nOffSet
                  (dbfTmpLin)->cRef       := (dbfPedCliL)->cRef
                  (dbfTmpLin)->cDetalle   := (dbfPedCliL)->cDetalle
                  (dbfTmpLin)->mLngDes    := (dbfPedCliL)->mLngDes
                  (dbfTmpLin)->nPreUnit   := (dbfPedCliL)->nPreDiv
                  (dbfTmpLin)->cUnidad    := (dbfPedCliL)->cUnidad
                  (dbfTmpLin)->nPesoKg    := (dbfPedCliL)->nPesoKg
                  (dbfTmpLin)->cPesoKg    := (dbfPedCliL)->cPesoKg
                  (dbfTmpLin)->nVolumen   := (dbfPedCliL)->nVolumen
                  (dbfTmpLin)->cVolumen   := (dbfPedCliL)->cVolumen
                  (dbfTmpLin)->nIva       := (dbfpedclil)->nIva
                  (dbfTmpLin)->nReq       := (dbfpedclil)->nReq
                  (dbfTmpLin)->nDto       := (dbfpedclil)->nDto
                  (dbfTmpLin)->nPntVer    := (dbfPedCliL)->nPntVer
                  (dbfTmpLin)->nImpTrn    := (dbfPedCliL)->nImpTrn
                  (dbfTmpLin)->nDtoPrm    := (dbfPedCliL)->nDtoPrm
                  (dbfTmpLin)->nComAge    := (dbfPedCliL)->nComAge
                  (dbfTmpLin)->dFecHa     := (dbfPedCliL)->dFecha
                  (dbfTmpLin)->cTipMov    := (dbfPedCliL)->cTipMov
                  (dbfTmpLin)->nDtoDiv    := (dbfPedCliL)->nDtoDiv
                  (dbfTmpLin)->cNumPed    := aAlbaranes[ nItem, 3]
                  (dbfTmpLin)->nUniCaja   := (dbfPedCliL)->nUniCaja - (dbfPedCliL)->nUniEnt
                  (dbfTmpLin)->nCanEnt    := (dbfPedCliL)->nCanPed  - (dbfPedCliL)->nCanEnt
                  (dbfTmpLin)->nUndKit    := (dbfPedCliL)->nUndKit
                  (dbfTmpLin)->lKitArt    := (dbfPedCliL)->lKitArt
                  (dbfTmpLin)->lKitChl    := (dbfPedCliL)->lKitChl
                  (dbfTmpLin)->lKitPrc    := (dbfPedCliL)->lKitPrc
                  (dbfTmpLin)->cCodPr1    := (dbfPedCliL)->cCodPr1
                  (dbfTmpLin)->cCodPr2    := (dbfPedCliL)->cCodPr2
                  (dbfTmpLin)->cValPr1    := (dbfPedCliL)->cValPr1
                  (dbfTmpLin)->cValPr2    := (dbfPedCliL)->cValPr2
                  (dbfTmpLin)->nCosDiv    := (dbfPedCliL)->nCosDiv
                  (dbfTmpLin)->nMesGrt    := (dbfPedCliL)->nMesGrt
                  (dbfTmpLin)->lMsgVta    := (dbfPedCliL)->lMsgVta
                  (dbfTmpLin)->lNotVta    := (dbfPedCliL)->lNotVta
                  (dbfTmpLin)->lLote      := (dbfPedCliL)->lLote
                  (dbfTmpLin)->nLote      := (dbfPedCliL)->nLote
                  (dbfTmpLin)->cLote      := (dbfPedCliL)->cLote
                  (dbfTmpLin)->mObsLin    := (dbfPedCliL)->mObsLin
                  (dbfTmpLin)->Descrip    := (dbfPedCliL)->Descrip
                  (dbfTmpLin)->cCodPrv    := (dbfPedCliL)->cCodPrv
                  (dbfTmpLin)->cNomPrv    := (dbfPedCliL)->cNomPrv
                  (dbfTmpLin)->cCodFam    := (dbfPedCliL)->cCodFam
                  (dbfTmpLin)->cGrpFam    := (dbfPedCliL)->cGrpFam
                  (dbfTmpLin)->cAlmLin    := (dbfPedCliL)->cAlmLin
                  (dbfTmpLin)->cRefPrv    := (dbfPedCliL)->cRefPrv
                  (dbfTmpLin)->dFecEnt    := (dbfPedCliL)->dFecEnt
                  (dbfTmpLin)->dFecSal    := (dbfPedCliL)->dFecSal
                  (dbfTmpLin)->lAlquiler  := (dbfPedCliL)->lAlquiler
                  (dbfTmpLin)->nPreAlq    := (dbfPedCliL)->nPreAlq
                  (dbfTmpLin)->cUnidad    := (dbfPedCliL)->cUnidad
                  (dbfTmpLin)->nNumMed    := (dbfPedCliL)->nNumMed
                  (dbfTmpLin)->nMedUno    := (dbfPedCliL)->nMedUno
                  (dbfTmpLin)->nMedDos    := (dbfPedCliL)->nMedDos
                  (dbfTmpLin)->nMedTre    := (dbfPedCliL)->nMedTre
                  (dbfTmpLin)->nPuntos    := (dbfPedCliL)->nPuntos
                  (dbfTmpLin)->nValPnt    := (dbfPedCliL)->nValPnt
                  (dbfTmpLin)->nDtoPnt    := (dbfPedCliL)->nDtoPnt
                  (dbfTmpLin)->nIncPnt    := (dbfPedCliL)->nIncPnt
                  (dbfTmpLin)->lLinOfe    := (dbfPedCliL)->lLinOfe

               end

               ( dbfPedCliL )->( dbSkip( 1 ) )

            end

            ( dbfTmpLin )->( dbGoTop() )



            if ( dbfPedCliP )->( dbSeek( aAlbaranes[ nItem, 3 ] ) ) .AND. aAlbaranes[ nItem, 1 ]

               while ( dbfPedCliP )->cSerPed + Str( ( dbfPedCliP )->nNumPed ) + ( dbfPedCliP )->cSufPed == aAlbaranes[ nItem, 3 ] .AND. !( dbfPedCliP )->( Eof() )

                  if !( dbfPedCliP )->lPasado

                     ( dbfTmpPgo )->( dbAppend() )

                     ( dbfTmpPgo )->nNumRec  := ( dbfTmpPgo )->( Recno() )
                     ( dbfTmpPgo )->cCodCaj  := ( dbfPedCliP )->cCodCaj
                     ( dbfTmpPgo )->cTurRec  := ( dbfPedCliP )->cTurRec
                     ( dbfTmpPgo )->cCodCli  := ( dbfPedCliP )->cCodCli
                     ( dbfTmpPgo )->dEntrega := ( dbfPedCliP )->dEntrega
                     ( dbfTmpPgo )->nImporte := ( dbfPedCliP )->nImporte
                     ( dbfTmpPgo )->cDescrip := ( dbfPedCliP )->cDesCrip
                     ( dbfTmpPgo )->cPgdoPor := ( dbfPedCliP )->cPgdoPor
                     ( dbfTmpPgo )->cDocPgo  := ( dbfPedCliP )->cDocPgo
                     ( dbfTmpPgo )->cDivPgo  := ( dbfPedCliP )->cDivPgo
                     ( dbfTmpPgo )->nVdvPgo  := ( dbfPedCliP )->nVdvPgo
                     ( dbfTmpPgo )->cCodAge  := ( dbfPedCliP )->cCodAge
                     ( dbfTmpPgo )->cCodPgo  := ( dbfPedCliP )->cCodPgo
                     ( dbfTmpPgo )->lCloPgo  := .F.

                  end

                  if dbLock( dbfPedCliP )
                     ( dbfPedCliP )->lPasado := .T.
                     ( dbfPedCliP )->( dbUnLock() )
                  end

                  ( dbfPedCliP )->( dbSkip() )

               end

            end

            ( dbfTmpPgo )->( dbGoTop() )

            oBrw:Refresh()

         end

      next





      aGet[ 30 ]:bWhen           := {|| .F. }
      aGet[ 30 ]:Disable()





      RecalculaTotal( aTmp )

  end

return .T.



function lGenAlbCli( oBrw, oBtn, nDevice )

   local bAction

   IIF( nDevice == nil, nDevice := 1, ) ;

   if Empty( oBtn )
      return nil
   end

   IF !( dbfDoc )->( dbSeek( "AC" ) )







      oWndBrw:NewAt( "DOCUMENT",,, {||( msgStop( "No hay documentos predefinidos" ) )}, "No hay documentos",,,, 4, oBtn, .F. )

   ELSE

      WHILE ( dbfDoc )->CTIPO == "AC" .AND. !( dbfDoc )->( eof() )

         bAction  := bGenAlbCli( nDevice, "Imprimiendo albaranes de clientes", ( dbfDoc )->CODIGO )

         oWndBrw:NewAt( "Document", , , bAction, Rtrim( ( dbfDoc )->cDescrip ) , , , , , oBtn )

         ( dbfDoc )->( dbSkip() )

      end

   end

   SysRefresh()

return nil


































function nTotDAlbCli( cCodArt, dbfAlbCliL, dbfAlbCliT, cCodAlm )

   local lFacAlb        := .F.
   local nTotVta        := 0
   local nRecno         := ( dbfAlbCliL )->( Recno() )

   if ( dbfAlbCliL )->( dbSeek( cCodArt ) )

      while ( dbfAlbCliL )->cRef == cCodArt .AND. !( dbfAlbCliL )->( eof() )

         if dbfAlbCliT <> nil
            lFacAlb     := lFacAlbCli( ( dbfAlbCliL )->CSERALB + Str( ( dbfAlbCliL )->NNUMALB ) + ( dbfAlbCliL )->CSUFALB, dbfAlbCliT )
         end

         if !( dbfAlbCliL )->lTotLin .AND. !lFacAlb
            if cCodAlm <> nil
               if cCodAlm == ( dbfAlbCliL )->cAlmLin
                  nTotVta  += nTotNAlbPrv( dbfAlbCliL ) * NotCero( ( dbfAlbCliL )->nFacCnv )
               end
            else
               nTotVta     += nTotNAlbCli( dbfAlbCliL ) * NotCero( ( dbfAlbCliL )->nFacCnv )
            end
         end

         ( dbfAlbCliL )->( dbSkip() )

      end

   end

   ( dbfAlbCliL )->( dbGoTo( nRecno ) )

return ( nTotVta )




































































static function bGenAlbCli( nDevice, cTitle, cCodDoc )

   local bGen
   local nDev  := by( nDevice )
   local cTit  := by( cTitle  )
   local cCod  := by( cCodDoc )

   if nDev == 1
      bGen     := {|| GenAlbCli( nDev, cTit, cCod ) }
   else
      bGen     := {|| GenAlbCli( nDev, cTit, cCod ) }
   end

return ( bGen )







function nVtaAlbCli( cCodCli, dDesde, dHasta, dbfAlbCliT, dbfAlbCliL, dbfIva, dbfDiv, lNotFac, nYear )

   local nCon        := 0
   local nRec        := ( dbfAlbCliT )->( Recno() )

   IIF( lNotFac == nil, lNotFac := .F., ) ;





   if ( dbfAlbCliT )->( dbSeek( cCodCli ) )

      while ( dbfAlbCliT )->cCodCli == cCodCli .AND. !( dbfAlbCliT )->( Eof() )




         if ( dDesde == nil .OR. ( dbfAlbCliT )->dFecAlb >= dDesde )    .AND. ( dHasta == nil .OR. ( dbfAlbCliT )->dFecAlb <= dHasta )    .AND. ( if( lNotFac, !( dbfAlbCliT )->lFacturado, .T. ) )         .AND. ( nYear == nil .OR. Year( ( dbfAlbCliT )->dFecAlb ) == nYear )

            nCon  += nTotAlbCli( ( dbfAlbCliT )->CSERALB + Str( ( dbfAlbCliT )->NNUMALB ) + ( dbfAlbCliT )->CSUFALB, dbfAlbCliT, dbfAlbCliL, dbfIva, dbfDiv, nil, cDivEmp(), .F. )

         end

         ( dbfAlbCliT )->( dbSkip() )

         SysRefresh()

      end

   end

   ( dbfAlbCliT )->( dbGoTo( nRec ) )

return nCon





















































































FUNCTION EdmAlbCli( cCodRut, cPathTo, oStru, aSucces )

   local n           := 0
   local cSerie
   local cFilEdm
   local oFilEdm
   local dFecAlb
   local cCodCli
   local nNumAlb
   local cNumDoc
   local nCajEnt     := 0
   local cTipDoc
   local aHeadLine   := {}
   local aLotes      := {}

   IIF( cCodRut == nil, cCodRut := "001", ) ;
   IIF( cPathTo == nil, cPathTo := "C:\INTERS~1\", ) ;





   cCodRut           := SubStr( cCodRut, -3 )

   cFilEdm           := cPathTo + "TALBA" + cCodRut + ".PSI"

   if !file( cFilEdm )
      msgWait( "No existe el fichero " + cFilEdm, "Atención", 1 )
      return nil
   end

   oFilEdm           := TTxtFile():New( cFilEdm )





   while ! oFilEdm:lEoF()
      aAdd( aHeadLine, { SubStr( oFilEdm:cLine, 8, 10 ), Ctod( SubStr( oFilEdm:cLine, 127, 10 ) ) } )
      oFilEdm:Skip()
   end

   oFilEdm:Close()





   cFilEdm           := cPathTo + "LALBA" + cCodRut + ".PSI"

   if !file( cFilEdm )

      msgWait( "No existe el fichero " + cFilEdm, "Atención", 1 )

   else

      oFilEdm           := TTxtFile():New( cFilEdm )





      while ! oFilEdm:lEoF()

         cTipDoc        := SubStr( oFilEdm:cLine, 18,  1 )

         if ( cTipDoc == "3" .OR. cTipDoc == "4" )


            aAdd( aLotes, { SubStr( oFilEdm:cLine, 8, 10 ), LTrim( SubStr( oFilEdm:cLine, 19, 13 ) ), RTrim( SubStr( oFilEdm:cLine, 43, 21 ) ) } )
         end

         oFilEdm:Skip()

      end

   oFilEdm:Close()

   end





   cFilEdm           := cPathTo + "EALBA" + cCodRut + ".PSI"





   if !file( cFilEdm )
      msgStop( cFilEdm, "No existe" )
      return nil
   end

   oFilEdm           := TTxtFile():New( cFilEdm )





   OpenFiles()

   oStru:oMetDos:cText   := "Alb. Clientes"
   oStru:oMetDos:SetTotal( oFilEdm:nTLines )





   while !oFilEdm:lEoF()




      cCodCli        := SubStr( oFilEdm:cLine,  1,  7 )
      cNumDoc        := SubStr( oFilEdm:cLine,  8, 10 )
      cTipDoc        := SubStr( oFilEdm:cLine, 18,  1 )

      if ( cTipDoc == "3" .OR. cTipDoc == "4" )

         if dbSeekInOrd( cCodCli, "Cod", dbfClient )

            nNumAlb                          := Val( StrTran( cNumDoc, "/", "" ) )

            if Empty( ( dbfClient )->Serie )
               cSerie                        := "A"
            else
               cSerie                        := ( dbfClient )->Serie
            end

            if !( dbfAlbCliT )->( dbSeek( cSerie + Str( nNumAlb, 9 ) + RetSufEmp() ) )

               n  := aScan( aHeadLine, {|a| a[1] == cNumDoc } )
               if n <> 0
                  dFecAlb                    := aHeadLine[n,2]

                  ( dbfAlbCliT )->( dbAppend() )
                  ( dbfAlbCliT )->cSerAlb    := cSerie
                  ( dbfAlbCliT )->nNumAlb    := nNumAlb
                  ( dbfAlbCliT )->cSufAlb    := RetSufEmp()
                  ( dbfAlbCliT )->dFecAlb    := dFecAlb
                  ( dbfAlbCliT )->cCodAlm    := oUser():cAlmacen()
                  ( dbfAlbCliT )->cDivAlb    := cDivEmp()
                  ( dbfAlbCliT )->nVdvAlb    := nChgDiv( ( dbfAlbCliT )->cDivAlb, dbfDiv )
                  ( dbfAlbCliT )->lFacturado := .F.
                  ( dbfAlbCliT )->cCodCli    := ( dbfClient )->Cod
                  ( dbfAlbCliT )->cNomCli    := ( dbfClient )->Titulo
                  ( dbfAlbCliT )->cDirCli    := ( dbfClient )->Domicilio
                  ( dbfAlbCliT )->cPobCli    := ( dbfClient )->Poblacion
                  ( dbfAlbCliT )->cPrvCli    := ( dbfClient )->Provincia
                  ( dbfAlbCliT )->cPosCli    := ( dbfClient )->CodPostal
                  ( dbfAlbCliT )->cDniCli    := ( dbfClient )->Nif
                  ( dbfAlbCliT )->cCodTar    := ( dbfClient )->cCodTar
                  ( dbfAlbCliT )->cCodPago   := ( dbfClient )->CodPago
                  ( dbfAlbCliT )->cCodAge    := ( dbfClient )->cAgente
                  ( dbfAlbCliT )->cCodRut    := ( dbfClient )->cCodRut
                  ( dbfAlbCliT )->nTarifa    := ( dbfClient )->nTarifa
                  ( dbfAlbCliT )->lRecargo   := ( dbfClient )->lReq
                  ( dbfAlbCliT )->lOperPv    := ( dbfClient )->lPntVer
                  ( dbfAlbCliT )->cDtoEsp    := ( dbfClient )->cDtoEsp
                  ( dbfAlbCliT )->cDpp       := ( dbfClient )->cDpp
                  ( dbfAlbCliT )->nDtoEsp    := ( dbfClient )->nDtoEsp
                  ( dbfAlbCliT )->nDpp       := ( dbfClient )->nDpp
                  ( dbfAlbCliT )->nDtoUno    := ( dbfClient )->nDtoCnt
                  ( dbfAlbCliT )->cDtoUno    := ( dbfClient )->cDtoUno
                  ( dbfAlbCliT )->nDtoDos    := ( dbfClient )->nDtoRap
                  ( dbfAlbCliT )->cDtoDos    := ( dbfClient )->cDtoDos
                  ( dbfAlbCliT )->( dbUnLock() )

                  aAdd( aSucces, { .T., "Nuevo albarán de clientes " + ( dbfAlbCliT )->cSerAlb + "/" + AllTrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + "/" + ( dbfAlbCliT )->cSufAlb } )





                  while cNumDoc == SubStr( oFilEdm:cLine,  8, 10 ) .AND. ! oFilEdm:lEoF()

                     if cTipDoc == "3" .OR. cTipDoc == "4"

                        if ( dbfAlbCliT )->( dbSeek( cSerie + Str( nNumAlb, 9 ) + RetSufEmp() ) )

                           ( dbfAlbCliL )->( dbAppend() )
                           ( dbfAlbCliL )->cSerAlb       := ( dbfAlbCliT )->cSerAlb
                           ( dbfAlbCliL )->nNumAlb       := ( dbfAlbCliT )->nNumAlb
                           ( dbfAlbCliL )->cSufAlb       := ( dbfAlbCliT )->cSufAlb
                           ( dbfAlbCliL )->cRef          := Ltrim( SubStr( oFilEdm:cLine, 19, 13 ) )
                           ( dbfAlbCliL )->cDetalle      := RetFld( ( dbfAlbCliL )->cRef, dbfArticulo )
                           ( dbfAlbCliL )->nPreUnit      := Val( SubStr( oFilEdm:cLine, 32,  7 ) )
                           ( dbfAlbClil )->nDtoDiv       := Val( SubStr( oFilEdm:cLine, 39,  5 ) )
                           ( dbfAlbClil )->nDto          := Val( SubStr( oFilEdm:cLine, 44,  5 ) )
                           ( dbfAlbClil )->nIva          := nIvaCodTer( SubStr( oFilEdm:cLine, 61, 1 ), dbfIva )
                           ( dbfAlbClil )->nPntVer       := Val( SubStr( oFilEdm:cLine, 63, 7 ) )
                           ( dbfAlbCliL )->nCanEnt       := 1
                           ( dbfAlbCliL )->nUniCaja      := Val( SubStr( oFilEdm:cLine, 53,  7 ) )





                           if ( n  := aScan( aLotes, {|a| a[1] == cNumDoc .AND. a[2] == Ltrim( SubStr( oFilEdm:cLine, 19, 13 ) ) } ) ) <> 0
                              ( dbfAlbCliL )->lLote      := .T.
                              ( dbfAlbCliL )->cLote      := aLotes[ n, 3 ]
                           end

                           ( dbfAlbCliL )->( dbUnLock() )

                        end

                     end

                     oFilEdm:Skip()

                  end

               else

                  aAdd( aSucces, { .F., "Líneas de albarán huerfanas, cliente " + cCodCli + " documento : " + cNumDoc } )
                  oFilEdm:Skip()

               end

            else

               aAdd( aSucces, { .F., "Albarán de clientes ya existe " + ( dbfAlbCliT )->cSerAlb + "/" + AllTrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + "/" + ( dbfAlbCliT )->cSufAlb } )
               oFilEdm:Skip()

            end

         else

            aAdd( aSucces, { .F., "No existe cliente " + cCodCli + " de albarán " + AllTrim( cNumDoc ) } )
            oFilEdm:Skip()

         end

      else

         oFilEdm:Skip()

      end

      oStru:oMetDos:Set( oFilEdm:nLine )

   end

   oStru:oMetDos:SetTotal( oFilEdm:nTLines )

   CloseFiles()

   oFilEdm:Close()

RETURN ( aSucces )






Function aDocAlbCli( lEntregas )

   local aDoc        := {}

   IIF( lEntregas == nil, lEntregas := .F., ) ;





   aAdd( aDoc, { "Empresa",         "EM" } )
   aAdd( aDoc, { "Albaran",         "AC" } )

   if lEntregas
      aAdd( aDoc, { "Entregas a cuenta",  "EA" } )
   end

   aAdd( aDoc, { "Cliente",         "CL" } )
   aAdd( aDoc, { "Almacen",         "AL" } )
   aAdd( aDoc, { "Obras",           "OB" } )
   aAdd( aDoc, { "Rutas",           "RT" } )
   aAdd( aDoc, { "Agentes",         "AG" } )
   aAdd( aDoc, { "Divisas",         "DV" } )
   aAdd( aDoc, { "Formas de pago",  "PG" } )
   aAdd( aDoc, { "Transportistas",  "TR" } )

RETURN ( aDoc )



Function aCalAlbCli()

   local aCalAlbCli  := {}

   aAdd( aCalAlbCli, { "nTotArt",                                                   "N", 16,  6, "Total artículos",             "cPicUndAlb",  "" } )
   aAdd( aCalAlbCli, { "nTotCaj",                                                   "N", 16,  6, "Total cajas",                 "cPicUndAlb",  "" } )
   aAdd( aCalAlbCli, { "aTotIva[1,1]",                                              "N", 16,  6, "Bruto primer tipo de " + cImp(),    "cPorDivAlb",  "aTotIva[1,1] != 0" } )
   aAdd( aCalAlbCli, { "aTotIva[2,1]",                                              "N", 16,  6, "Bruto segundo tipo de " + cImp(),   "cPorDivAlb",  "aTotIva[2,1] != 0" } )
   aAdd( aCalAlbCli, { "aTotIva[3,1]",                                              "N", 16,  6, "Bruto tercer tipo de " + cImp(),    "cPorDivAlb",  "aTotIva[3,1] != 0" } )
   aAdd( aCalAlbCli, { "aTotIva[1,2]",                                              "N", 16,  6, "Base primer tipo de " + cImp(),     "cPorDivAlb",  "aTotIva[1,2] != 0" } )
   aAdd( aCalAlbCli, { "aTotIva[2,2]",                                              "N", 16,  6, "Base segundo tipo de " + cImp(),    "cPorDivAlb",  "aTotIva[2,2] != 0" } )
   aAdd( aCalAlbCli, { "aTotIva[3,2]",                                              "N", 16,  6, "Base tercer tipo de " + cImp(),     "cPorDivAlb",  "aTotIva[3,2] != 0" } )
   aAdd( aCalAlbCli, { "aTotIva[1,3]",                                              "N",  5,  2, "Porcentaje primer tipo " + cImp(),  "'@R 99.99%'", "aTotIva[1,3] != 0" } )
   aAdd( aCalAlbCli, { "aTotIva[2,3]",                                              "N",  5,  2, "Porcentaje segundo tipo " + cImp(), "'@R 99.99%'", "aTotIva[2,3] != 0" } )
   aAdd( aCalAlbCli, { "aTotIva[3,3]",                                              "N",  5,  2, "Porcentaje tercer tipo " + cImp(),  "'@R 99.99%'", "aTotIva[3,3] != 0" } )
   aAdd( aCalAlbCli, { "aTotIva[1,4]",                                              "N",  5,  2, "Porcentaje primer tipo RE",   "'@R 99.99%'", "aTotIva[1,4] != 0" } )
   aAdd( aCalAlbCli, { "aTotIva[2,4]",                                              "N",  5,  2, "Porcentaje segundo tipo RE",  "'@R 99.99%'", "aTotIva[2,4] != 0" } )
   aAdd( aCalAlbCli, { "aTotIva[3,4]",                                              "N",  5,  2, "Porcentaje tercer tipo RE",   "'@R 99.99%'", "aTotIva[3,4] != 0" } )
   aAdd( aCalAlbCli, { "round( aTotIva[1,2] * aTotIva[1,3] / 100, nDouDivAlb )",    "N", 16,  6, "Importe primer tipo " + cImp(),     "cPorDivAlb",  "aTotIva[1,2] != 0" } )
   aAdd( aCalAlbCli, { "round( aTotIva[2,2] * aTotIva[2,3] / 100, nDouDivAlb )",    "N", 16,  6, "Importe segundo tipo " + cImp(),    "cPorDivAlb",  "aTotIva[2,2] != 0" } )
   aAdd( aCalAlbCli, { "round( aTotIva[3,2] * aTotIva[3,3] / 100, nDouDivAlb )",    "N", 16,  6, "Importe tercer tipo " + cImp(),     "cPorDivAlb",  "aTotIva[3,2] != 0" } )
   aAdd( aCalAlbCli, { "round( aTotIva[1,2] * aTotIva[1,4] / 100, nDouDivAlb )",    "N", 16,  6, "Importe primer RE",           "cPorDivAlb",  "aTotIva[1,2] != 0" } )
   aAdd( aCalAlbCli, { "round( aTotIva[2,2] * aTotIva[2,4] / 100, nDouDivAlb )",    "N", 16,  6, "Importe segundo RE",          "cPorDivAlb",  "aTotIva[2,2] != 0" } )
   aAdd( aCalAlbCli, { "round( aTotIva[3,2] * aTotIva[3,4] / 100, nDouDivAlb )",    "N", 16,  6, "Importe tercer RE",           "cPorDivAlb",  "aTotIva[3,2] != 0" } )
   aAdd( aCalAlbCli, { "nTotBrt",                                                   "N", 16,  6, "Total bruto",                 "cPorDivAlb",  "lEnd" }              )
   aAdd( aCalAlbCli, { "nTotDto",                                                   "N", 16,  6, "Total descuento",             "cPorDivAlb",  "lEnd" }              )
   aAdd( aCalAlbCli, { "nTotDpp",                                                   "N", 16,  6, "Total descuento pronto pago", "cPorDivAlb",  "lEnd" }              )
   aAdd( aCalAlbCli, { "nTotUno",                                                   "N", 16,  6, "Total primer descuento personalizable",  "cPorDivAlb",  "lEnd" }   )
   aAdd( aCalAlbCli, { "nTotDos",                                                   "N", 16,  6, "Total segundo descuento personalizable", "cPorDivAlb",  "lEnd" }   )
   aAdd( aCalAlbCli, { "nTotNet",                                                   "N", 16,  6, "Total neto",                  "cPorDivAlb",  "lEnd" }              )
   aAdd( aCalAlbCli, { "nTotIva",                                                   "N", 16,  6, "Total " + cImp(),                   "cPorDivAlb",  "lEnd" }              )
   aAdd( aCalAlbCli, { "nTotIvm",                                                   "N", 16,  6, "Total IVMH",                  "cPorDivAlb",  "lEnd" }              )
   aAdd( aCalAlbCli, { "nTotReq",                                                   "N", 16,  6, "Total RE",                    "cPorDivAlb",  "lEnd" }              )
   aAdd( aCalAlbCli, { "nTotAlb",                                                   "N", 16,  6, "Total albarán",               "cPorDivAlb",  "lEnd" }              )
   aAdd( aCalAlbCli, { "nTotPage",                                                  "N", 16,  6, "Total página",                "cPorDivAlb",  "!lEnd"}              )
   aAdd( aCalAlbCli, { "nTotPes",                                                   "N", 16,  6, "Total peso",                  "'@E 99,999.99'","lEnd" }            )
   aAdd( aCalAlbCli, { "nTotCos",                                                   "N", 16,  6, "Total costo",                 "cPorDivAlb",  "lEnd" }            )
   aAdd( aCalAlbCli, { "nImpEuros( nTotAlb, (cDbf)->cDivAlb, cDbfDiv )",            "N", 16,  6, "Total albarán (Euros)",       "",            "lEnd" }              )
   aAdd( aCalAlbCli, { "nImpPesetas( nTotAlb, (cDbf)->cDivAlb, cDbfDiv )",          "N", 16,  6, "Total albarán (Pesetas)",     "",            "lEnd" }              )
   aAdd( aCalAlbCli, { "nPagina",                                                   "N",  2,  0, "Número de página",            "'99'",        "" }                  )
   aAdd( aCalAlbCli, { "lEnd",                                                      "L",  1,  0, "Fin del documento",           "",            "" }                  )

Return ( aCalAlbCli )



Function aCocAlbCli()

   local aCocAlbCli  := {}

   aAdd( aCocAlbCli, { "( Descrip( cDbfCol ) )",                                                   "C", 100,0, "Detalle del artículo",           "",            "Descripción", "" } )
   aAdd( aCocAlbCli, { "( nTotNAlbCli( cDbfCol ) )",                                               "N", 16, 6, "Total unidades",                 "cPicUndAlb",  "Unds.",       "" } )
   aAdd( aCocAlbCli, { "( nTotUAlbCli( cDbfCol, nDouDivAlb, nVdvDivAlb ) )",                       "N", 16, 6, "Precio unitario",                "cPouDivAlb",  "Precio",      "" } )
   aAdd( aCocAlbCli, { "( nNetUAlbCli( cDbfCol, nDouDivAlb, nVdvDivAlb, .f. ) )",                  "N", 16, 6, "Precio unitario sin " + cImp(),     "cPouDivAlb",  "Precio",      "" } )
   aAdd( aCocAlbCli, { "( nTotPAlbCli( cDbfCol, nVdvDivAlb ) )",                                   "N", 16, 6, "Precio unitario con descuentos", "cPouDivAlb",  "Precio",      "" } )
   aAdd( aCocAlbCli, { "( nPesLAlbCli( cDbfCol ) )",                                               "N", 16, 6, "Total peso por línea",           "'@E 999,999.99'","Peso",     "" } )
   aAdd( aCocAlbCli, { "( nTotLAlbCli( cDbfCol, nDouDivAlb, nRouDivAlb, nVdvDivAlb ) )",           "N", 16, 6, "Total linea de albarán",         "cPorDivAlb",  "Total",       "" } )
   aAdd( aCocAlbCli, { "( nNetLAlbCli( cDbf, cDbfCol, nDouDivAlb, nRouDivAlb, nVdvDivAlb, .f. ) )","N", 16, 6, "Total linea sin " + cImp(),         "cPorDivAlb",  "Total",       "" } )
   aAdd( aCocAlbCli, { "cFrasePublicitaria( cDbfCol )",                                            "C", 50, 0, "Texto de frase publicitaria",    "",            "Publicidad",  "" } )

Return ( aCocAlbCli )



function aSerAlbCli()

   local aColAlbCli  := {}

   aAdd( aColAlbCli,  { "cSerAlb",     "C",  1,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli,  { "nNumAlb",     "N",  9,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli,  { "cSufAlb",     "C",  2,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli,  { "dFecAlb",     "D",  8,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli,  { "nNumLin",     "N",  4,   0, "Número de la línea",               "'9999'",            "", "( cDbfCol )" } )
   aAdd( aColAlbCli,  { "lFacturado",  "L",  1,   0, "Lógico de facturado",              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli,  { "lUndNeg",     "L",  1,   0, "Lógico de unidades en negativo",   "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli,  { "cRef",        "C", 18,   0, "Referencia del artículo",          "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli,  { "cAlmLin",     "C",  3,   0, "Almacen del artículo",             "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli,  { "cNumSer",     "C", 30,   0, "Número de serie",                  "",                  "", "( cDbfCol )" } )

return ( aColAlbCli )



Static Function RecAlbCli( aTmpAlb, oDlg )

    local nDtoAge
   local nRecno
   local cCodFam
   local nImpAtp  := 0
   local nImpOfe  := 0




   if !ApoloMsgNoYes( "¡Atención!,"                                      + Chr(13)+Chr(10) +  "todos los precios se recalcularán en función de"  + Chr(13)+Chr(10) +  "los valores en las bases de datos.", "¿ Desea proceder ?" )
      return nil
   end

   oDlg:aEvalWhen()

   ( dbfArticulo )->( ordSetFocus( "Codigo" ) )

   nRecno         := ( dbfTmpLin )->( RecNo() )

   ( dbfTmpLin )->( dbGotop() )
   while !( dbfTmpLin )->( eof() )





      if ( dbfArticulo )->( dbSeek( ( dbfTmpLin )->cRef ) )

         if aTmpAlb[ 58 ] <= 1
            ( dbfTmpLin )->nIva     := nIva( dbfIva, ( dbfArticulo )->TipoIva )
            ( dbfTmpLin )->nReq     := nReq( dbfIva, ( dbfArticulo )->TipoIva )
         end





         if !Empty( ( dbfArticulo )->cCodImp )
            ( dbfTmpLin )->cCodImp  := ( dbfArticulo )->cCodImp
            ( dbfTmpLin )->nValImp  := oNewImp:nValImp( ( dbfArticulo )->cCodImp, aTmpAlb[ 57 ], ( dbfTmpLin )->nIva )
         end





         ( dbfTmpLin )->nPreUnit    := nRetPreArt( ( dbfTmpLin )->nTarLin, aTmpAlb[ 51 ], aTmpAlb[ 57 ], dbfArticulo, dbfDiv, dbfKit, dbfIva )





         ( dbfTmpLin )->nCtlStk     := ( dbfArticulo )->nCtlStock
         ( dbfTmpLin )->nPvpRec     := ( dbfArticulo )->PvpRec
         ( dbfTmpLin )->nCosDiv     := nCosto( nil, dbfArticulo, dbfKit )





         ( dbfTmpLin )->nPntVer     := ( dbfArticulo )->nPntVer1





         do case

         case lSeekAtpArt( aTmpAlb[ 6 ] + ( dbfTmpLin )->cRef, ( dbfTmpLin )->cCodPr1 + ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1 + ( dbfTmpLin )->cValPr2, aTmpAlb[ 5 ], dbfCliAtp ) .AND.  ( dbfCliAtp )->lAplAlb

               nImpAtp              := nImpAtp( ( dbfTmpLin )->nTarLin, dbfCliAtp )
               if nImpAtp <> 0
                  ( dbfTmpLin )->nPreUnit := nImpAtp
               end

               nImpAtp              := nDtoAtp( ( dbfTmpLin )->nTarLin, dbfCliAtp )
               if nImpAtp <> 0
                  ( dbfTmpLin )->nDto     := nImpAtp
               end

               if ( dbfCliAtp )->nDprArt <> 0
                  ( dbfTmpLin )->nDtoPrm  := ( dbfCliAtp )->nDprArt
               end

               if ( dbfCliAtp )->nComAge <> 0
                  ( dbfTmpLin )->nComAge  := ( dbfCliAtp )->nComAge
               end





         case !Empty( aTmpAlb[ 28 ] )

            cCodFam  := RetFamArt( ( dbfTmpLin )->cRef, dbfArticulo )

            nImpOfe  := RetPrcTar( ( dbfTmpLin )->cRef, aTmpAlb[ 28 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL, ( dbfTmpLin )->nTarLin )
            if nImpOfe <> 0
               ( dbfTmpLin )->nPreUnit := nImpOfe
            end

            nImpOfe  := RetPctTar( ( dbfTmpLin )->cRef, cCodFam, aTmpAlb[ 28 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL )
            if nImpOfe <> 0
               ( dbfTmpLin )->nDto     := nImpOfe
            end

            nImpOfe  := RetComTar( ( dbfTmpLin )->cRef, cCodFam, aTmpAlb[ 28 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpAlb[ 26 ], dbfTarPreL, dbfTarPreS )

            if nImpOfe <> 0
               ( dbfTmpLin )->nComAge  := nImpOfe
            end






            nImpOfe     := RetDtoPrm( ( dbfTmpLin )->cRef, cCodFam, aTmpAlb[ 28 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpAlb[ 5 ], dbfTarPreL )
            if nImpOfe  <> 0
               ( dbfTmpLin )->nDtoPrm  := nImpOfe
            end





            nDtoAge     := RetDtoAge( ( dbfTmpLin )->cRef, cCodFam, aTmpAlb[ 28 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpAlb[ 5 ], aTmpAlb[ 26 ], dbfTarPreL, dbfTarPreS )

            if nDtoAge  <> 0
               ( dbfTmpLin )->nComAge  := nDtoAge
            end

         end





         nImpOfe     := nImpOferta( ( dbfTmpLin )->cRef, aTmpAlb[ 6 ], aTmpAlb[ 72 ], ( dbfTmpLin )->nUniCaja, aTmpAlb[ 5 ], dbfOferta, ( dbfTmpLin )->nTarLin, nil, ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2 )
         if nImpOfe  <> 0
            ( dbfTmpLin )->nPreUnit := nCnv2Div( nImpOfe, cDivEmp(), aTmpAlb[ 51 ], dbfDiv )
         end





         nImpOfe     := nDtoOferta( ( dbfTmpLin )->cRef, aTmpAlb[ 6 ], aTmpAlb[ 72 ], ( dbfTmpLin )->nUniCaja, aTmpAlb[ 5 ], dbfOferta, ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2 )
         if nImpOfe  <> 0
            ( dbfTmpLin )->nDtoPrm  := nImpOfe
         end

      end

      ( dbfTmpLin )->( dbSkip() )

   end

   ( dbfTmpLin )->( dbGoTo( nRecno ) )

return nil



function SynAlbCli( cPath )

   local oError
   local oBlock
   local aTotAlb
   local cCodImp
   local cNumSer
   local aNumSer

   IIF( cPath == nil, cPath := cPatEmp(), ) ;

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., cDriver(), cPath + "ALBCLIT.DBF", cCheckArea( "ALBCLIT", @dbfAlbCliT ), .F. )
   ordListAdd( cPath + "ALBCLIT.CDX" )

   dbUseArea( .T., cDriver(), cPath + "ALBCLIL.DBF", cCheckArea( "ALBCLIL", @dbfAlbCliL ), .F. )
   ordListAdd( cPath + "ALBCLIL.CDX" )

   dbUseArea( .T., cDriver(), cPath + "ALBCLIS.DBF", cCheckArea( "ALBCLIS", @dbfAlbCliS ), .F. )
   ordListAdd( cPath + "ALBCLIS.CDX" )

   dbUseArea( .T., cDriver(), cPath + "ALBCLII.DBF", cCheckArea( "ALBCLII", @dbfAlbCliI ), .F. )
   ordListAdd( cPath + "ALBCLII.CDX" )

   dbUseArea( .T., cDriver(), cPath + "ALBCLIP.DBF", cCheckArea( "ALBCLIP", @dbfAlbCliP ), .F. )
   ordListAdd( cPath + "ALBCLIP.CDX" )

   dbUseArea( .T., cDriver(), cPatArt() + "FAMILIAS.DBF", cCheckArea( "FAMILIAS", @dbfFamilia ), .F. )
   ordListAdd( cPatArt() + "FAMILIAS.CDX" )

   dbUseArea( .T., cDriver(), cPatArt() + "ARTICULO.DBF", cCheckArea( "ARTICULO", @dbfArticulo ), .F. )
   ordListAdd( cPatArt() + "ARTICULO.CDX" )

   dbUseArea( .T., cDriver(), cPatCli() + "CLIENT.DBF", cCheckArea( "CLIENT", @dbfClient ), .F. )
   ordListAdd( cPatCli() + "CLIENT.CDX" )

   dbUseArea( .T., cDriver(), cPatDat() + "TIVA.DBF", cCheckArea( "TIVA", @dbfIva ), .T. )
   ordListAdd( cPatDat() + "TIVA.CDX" )

   dbUseArea( .T., cDriver(), cPatDat() + "DIVISAS.DBF", cCheckArea( "DIVISAS", @dbfDiv ), .T. )
   ordListAdd( cPatDat() + "DIVISAS.CDX" )

   dbUseArea( .T., cDriver(), cPath + "PEDCLIT.DBF", cCheckArea( "PEDCLIT", @dbfPedCliT ), .F. )
   ordListAdd( cPath + "PEDCLIT.CDX" )

   dbUseArea( .T., cDriver(), cPath + "PEDCLIL.DBF", cCheckArea( "PEDCLIL", @dbfPedCliL ), .F. )
   ordListAdd( cPath + "PEDCLIL.CDX" )

   dbUseArea( .T., cDriver(), cPath + "FACCLIL.DBF", cCheckArea( "FACCLIL", @dbfFacCliL ), .F. )
   ordListAdd( cPath + "FACCLIL.CDX" )

   oNewImp              := TNewImp():Create( cPatEmp() )
      if !oNewImp:OpenFiles()
         lOpenFiles     := .F.
      end

   oStock               := TStock():Create( cPatGrp() )
   if !oStock:lOpenFiles()
      lOpenFiles        := .F.
   else
      oStock:cPedCliT   := dbfPedCliT
      oStock:cPedCliL   := dbfPedCliL
      oStock:cAlbCliL   := dbfAlbCliL
      oStock:cFacCliL   := dbfFacCliL

   end

   while !( dbfAlbCliT )->( eof() )

      if Empty( ( dbfAlbCliT )->cCodCaj )
         ( dbfAlbCliT )->cCodCaj := "000"
      end

      if Empty( ( dbfAlbCliT )->cCodGrp )
         ( dbfAlbCliT )->cCodGrp := RetGrpCli( ( dbfAlbCliT )->cCodCli, dbfClient )
      end

      if !( ( dbfAlbCliT )->cSerAlb >= "A" .AND. ( dbfAlbCliT )->cSerAlb <= "Z" )
         ( dbfAlbCliT )->( dbDelete() )
      end

      if Empty( ( dbfAlbCliT )->cNomCli ) .AND. !Empty ( ( dbfAlbCliT )->cCodCli )
         if dbLock( dbfAlbCliT )
         ( dbfAlbCliT )->cNomCli    := RetFld( ( dbfAlbCliT )->cCodCli, dbfClient, "Titulo" )
         ( dbfAlbCliT )->( dbUnLock() )
         end
      end





      if ( dbfAlbCliT )->nTotAlb == 0 .AND. dbLock( dbfAlbCliT )

         aTotAlb                 := aTotAlbCli( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb, dbfAlbCliT, dbfAlbCliL, dbfIva, dbfDiv, ( dbfAlbCliT )->cDivAlb )

         ( dbfAlbCliT )->nTotNet := aTotAlb[1]
         ( dbfAlbCliT )->nTotIva := aTotAlb[2]
         ( dbfAlbCliT )->nTotReq := aTotAlb[3]
         ( dbfAlbCliT )->nTotAlb := aTotAlb[4]

         ( dbfAlbCliT )->( dbUnLock() )

      end





      if ( dbfAlbCliT )->nTotPag == 0 .AND. dbLock( dbfAlbCliT )
         ( dbfAlbCliT )->nTotPag := nPagAlbCli( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb, dbfAlbCliP, dbfDiv )
         ( dbfAlbCliT )->( dbUnLock() )
      end





      if !Empty( ( dbfAlbCliT )->cNumPed )
         oStock:SetEstadoPedCli( ( dbfAlbCliT )->cNumPed )
      end

      ( dbfAlbCliT )->( dbSkip() )

   end

   while !( dbfAlbCliL )->( eof() )

      if !( dbfAlbCliT )->( dbSeek( ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb ) )

         ( dbfAlbCliL )->( dbDelete() )

      else

         if Empty( ( dbfAlbCliL )->cLote ) .AND. !Empty( ( dbfAlbCliL )->nLote )
            ( dbfAlbCliL )->cLote   := AllTrim( Str( ( dbfAlbCliL )->nLote ) )
         end

         if Empty( ( dbfAlbCliL )->nValImp )
            cCodImp                     :=  RetFld( ( dbfAlbCliL )->CREF, dbfArticulo, "cCodImp" )
            if !Empty( cCodImp )
               if dbLock( dbfAlbCliL )
               ( dbfAlbCliL )->nValImp  := oNewImp:nValImp( cCodImp )
               ( dbfAlbCliL )->( dbUnLock() )
               end
            end
         end

         if Empty( ( dbfAlbCliL )->nVolumen )
            if dbLock( dbfAlbCliL )
               ( dbfAlbCliL )->nVolumen :=  RetFld( ( dbfAlbCliL )->CREF, dbfArticulo, "nVolumen" )
               ( dbfAlbCliL )->( dbUnLock() )
            end
         end

         if ( dbfAlbCliL )->lIvaLin <> ( dbfAlbCliT )->lIvaInc
            ( dbfAlbCliL )->lIvaLin    := ( dbfAlbCliT )->lIvaInc
         end

         if !Empty( ( dbfAlbCliL )->cRef ) .AND. Empty( ( dbfAlbCliL )->cCodFam )
            ( dbfAlbCliL )->cCodFam    := RetFamArt( ( dbfAlbCliL )->cRef, dbfArticulo )
         end

         if !Empty( ( dbfAlbCliL )->cRef ) .AND. !Empty( ( dbfAlbCliL )->cCodFam )
            ( dbfAlbCliL )->cGrpFam    := cGruFam( ( dbfAlbCliL )->cCodFam, dbfFamilia )
         end

         if Empty( ( dbfAlbCliL )->nReq )
            ( dbfAlbCliL )->nReq       := nPReq( dbfIva, ( dbfAlbCliL )->nIva )
         end

         if ( dbfAlbCliL )->lFacturado <> ( dbfAlbCliT )->lFacturado
            ( dbfAlbCliL )->lFacturado := ( dbfAlbCliT )->lFacturado
         end

         if ( dbfAlbCliL )->dFecAlb <> ( dbfAlbCliT )->dFecAlb
            ( dbfAlbCliL )->dFecAlb    := ( dbfAlbCliT )->dFecAlb
         end

         if !Empty( ( dbfAlbCliL )->mNumSer )

            aNumSer                       := hb_aTokens( ( dbfAlbCliL )->mNumSer, "," )
            for each cNumSer in aNumSer
               ( dbfAlbCliS )->( dbAppend() )
               ( dbfAlbCliS )->cSerAlb    := ( dbfAlbCliL )->cSerAlb
               ( dbfAlbCliS )->nNumAlb    := ( dbfAlbCliL )->nNumAlb
               ( dbfAlbCliS )->cSufAlb    := ( dbfAlbCliL )->cSufAlb
               ( dbfAlbCliS )->cRef       := ( dbfAlbCliL )->cRef
               ( dbfAlbCliS )->cAlmLin    := ( dbfAlbCliL )->cAlmLin
               ( dbfAlbCliS )->nNumLin    := ( dbfAlbCliL )->nNumLin
               ( dbfAlbCliS )->lFacturado := ( dbfAlbCliL )->lFacturado
               ( dbfAlbCliS )->cNumSer    := cNumSer
            next

            ( dbfAlbCliL )->mNumSer       := ""

         end

      end

      ( dbfAlbCliL )->( dbSkip() )

      SysRefresh()

   end

   while !( dbfAlbCliI )->( eof() )

      if !( dbfAlbCliT )->( dbSeek( ( dbfAlbCliI )->cSerAlb + Str( ( dbfAlbCliI )->nNumAlb ) + ( dbfAlbCliI )->cSufAlb ) )
         ( dbfAlbCliI )->( dbDelete() )
      end

      ( dbfAlbCliI )->( dbSkip() )

      SysRefresh()

   end



   while !( dbfAlbCliS )->( eof() )

      if !( dbfAlbCliT )->( dbSeek( ( dbfAlbCliS )->cSerAlb + Str( ( dbfAlbCliS )->nNumAlb ) + ( dbfAlbCliS )->cSufAlb ) )

         ( dbfAlbCliS )->( dbDelete() )

      else

         if ( dbfAlbCliS )->dFecAlb <> ( dbfAlbCliT )->dFecAlb
            ( dbfAlbCliS )->dFecAlb    := ( dbfAlbCliT )->dFecAlb
         end

      end

      ( dbfAlbCliS )->( dbSkip() )

      SysRefresh()

   end

   RECOVER USING oError

      msgStop( "Imposible sincronizar albaranes de clientes" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   if !Empty( dbfAlbCliT ) .AND. ( dbfAlbCliT )->( Used() )
      ( dbfAlbCliT )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliL ) .AND. ( dbfAlbCliL )->( Used() )
      ( dbfAlbCliL )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliS ) .AND. ( dbfAlbCliS )->( Used() )
      ( dbfAlbCliS )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliI ) .AND. ( dbfAlbCliI )->( Used() )
      ( dbfAlbCliI )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliP ) .AND. ( dbfAlbCliP )->( Used() )
      ( dbfAlbCliP )->( dbCloseArea() )
   end

   if !Empty( dbfArticulo ) .AND. ( dbfArticulo )->( Used() )
      ( dbfArticulo )->( dbCloseArea() )
   end

   if !Empty( dbfFamilia ) .AND. ( dbfFamilia )->( Used() )
      ( dbfFamilia )->( dbCloseArea() )
   end

   if !Empty( dbfClient ) .AND. ( dbfClient )->( Used() )
      ( dbfClient )->( dbCloseArea() )
   end

   if !Empty( dbfIva ) .AND. ( dbfIva )->( Used() )
      ( dbfIva )->( dbCloseArea() )
   end

   if !Empty( dbfDiv ) .AND. ( dbfDiv )->( Used() )
      ( dbfDiv )->( dbCloseArea() )
   end

   if !Empty( dbfPedCliT ) .AND. ( dbfPedCliT )->( Used() )
      ( dbfPedCliT )->( dbCloseArea() )
   end

   if !Empty( dbfPedCliL ) .AND. ( dbfPedCliL )->( Used() )
      ( dbfPedCliL )->( dbCloseArea() )
   end

   if !Empty( dbfFacCliL ) .AND. ( dbfFacCliL )->( Used() )
      ( dbfFacCliL )->( dbCloseArea() )
   end

   if !Empty( oNewImp )
      oNewImp:end()
   end

   if !Empty( oStock )
      oStock:end()
   end

   oNewImp     := nil
   oStock      := nil

return nil



Function lGetUsuario( oGetUsuario, dbfUsr )

   local oDlg
   local oCodigoUsuario
   local cCodigoUsuario := Space( 3 )
   local oNombreUsuario
   local cNombreUsuario := ""

   if !lRecogerUsuario()
      Return .T.
   end

   oDlg = TDialog():New(,,,,, "GetUsuario",, .F.,,,,,, .F.,,,,,, .F., )







      oCodigoUsuario := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cCodigoUsuario, cCodigoUsuario:= u ) }, oDlg,,, {||    ( SetUsuario( oCodigoUsuario, oNombreUsuario, oDlg, dbfUsr ) )},,,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwUser( oCodigoUsuario, dbfUsr ) )}, nil, "LUPA",, )





      oNombreUsuario := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cNombreUsuario, cNombreUsuario:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      TButton():ReDefine( 1, {||( if( oCodigoUsuario:lValid(), oDlg:end( 1 ), ) )}, oDlg,,, .F.,,,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:bStart       := { || oCodigoUsuario:SetFocus(), oCodigoUsuario:SelectAll() }
      oDlg:bKeyDown     := { | nKey | if( nKey == 65 .AND. GetKeyState( 17 ), CreateInfoArticulo(), 0 ) }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      oCodigoUsuario:cText( cCodigoUsuario )
      oCodigoUsuario:lValid()

      if !Empty( oGetUsuario )
         oGetUsuario:cText( cCodigoUsuario )
         oGetUsuario:lValid()
      end

   end

Return ( oDlg:nResult == 1 )



Function SetUsuario( oCodUsr, oSay, oDlg, dbfUsr )

   local lSetUsr  := .T.
   local cCodUsr  := oCodUsr:VarGet()

   if ( dbfUsr )->( dbSeek( cCodUsr ) )
      oSay:cText( Rtrim( ( dbfUsr )->cNbrUse ) )
      if !Empty( oDlg )
         oDlg:End( 1 )
      end
   else
      oCodUsr:cText( Space( 3 ) )
      lSetUsr     := .F.
   end

Return ( lSetUsr )



Static Function EdtEnt( aTmp, aGet, dbfTmpPgo, oBrw, bWhen, bValid, nMode, aTmpAlb )

   local oDlg
   local oFld
   local oBmp
   local oFpago
   local cFpago
   local oBmpDiv
   local oGetCli
   local cGetCli
   local oGetAge
   local cGetAge
   local oGetCaj
   local cGetCaj
   local cPorDiv
   local oBmpBancos

   IIF( aTmpAlb == nil, aTmpAlb := dbScatter( dbfAlbCliT ), ) ;

   do case
      case nMode == 1

         aTmp[ ( dbfTmpPgo )->( FieldPos( "cTurRec" ) ) ]      := cCurSesion()
         aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCaj" ) ) ]      := oUser():cCaja()

         aTmp[ ( dbfTmpPgo )->( FieldPos( "cSerAlb" ) ) ]      := aTmpAlb[ 1 ]
         aTmp[ ( dbfTmpPgo )->( FieldPos( "nNumAlb" ) ) ]      := aTmpAlb[ 2 ]
         aTmp[ ( dbfTmpPgo )->( FieldPos( "cSufAlb" ) ) ]      := aTmpAlb[ 3 ]
         aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCli" ) ) ]      := aTmpAlb[ 6 ]
         aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodAge" ) ) ]      := aTmpAlb[ 26 ]
         aTmp[ ( dbfTmpPgo )->( FieldPos( "cDivPgo" ) ) ]      := aTmpAlb[ 51 ]
         aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodPgo" ) ) ]      := aTmpAlb[ 23]

         if dbSeekInOrd( aTmpAlb[ 23 ], "cCodPago", dbfFPago ) .AND. ( dbfFPago )->lUtlBnc

            aTmp[ ( dbfTmpPgo )->( FieldPos( "cBncEmp" ) ) ]   := ( dbfFPago )->cBanco
            aTmp[ ( dbfTmpPgo )->( FieldPos( "cEntEmp" ) ) ]   := ( dbfFPago )->cEntBnc
            aTmp[ ( dbfTmpPgo )->( FieldPos( "cSucEmp" ) ) ]   := ( dbfFPago )->cSucBnc
            aTmp[ ( dbfTmpPgo )->( FieldPos( "cDigEmp" ) ) ]   := ( dbfFPago )->cDigBnc
            aTmp[ ( dbfTmpPgo )->( FieldPos( "cCtaEmp" ) ) ]   := ( dbfFPago )->cCtaBnc

            aTmp[ ( dbfTmpPgo )->( FieldPos( "cBncCli" ) ) ]   := aTmpAlb[ 93  ]
            aTmp[ ( dbfTmpPgo )->( FieldPos( "cEntCli" ) ) ]   := aTmpAlb[ 94 ]
            aTmp[ ( dbfTmpPgo )->( FieldPos( "cSucCli" ) ) ]   := aTmpAlb[ 95 ]
            aTmp[ ( dbfTmpPgo )->( FieldPos( "cDigCli" ) ) ]   := aTmpAlb[ 96 ]
            aTmp[ ( dbfTmpPgo )->( FieldPos( "cCtaCli" ) ) ]   := aTmpAlb[ 97 ]

         end

      case nMode == 2

         if aTmp[ ( dbfTmpPgo )->( FieldPos( "lCloPgo" ) ) ] .AND. !oUser():lAdministrador()
            msgStop( "Solo pueden modificar las entregas cerradas los administradores." )
            return .F.
         end

   end

   cGetCli           := RetFld( aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCli" ) ) ], dbfClient, "Titulo" )
   cGetAge           := cNbrAgent( aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodAge" ) ) ], dbfAgent )
   cGetCaj           := RetFld( aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCaj" ) ) ], dbfCajT, "cNomCaj" )
   cPorDiv           := cPorDiv(aTmp[ ( dbfTmpPgo )->( FieldPos( "cDivPgo" ) ) ], dbfDiv )
   cFPago            := RetFld( aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodPgo" ) ) ], dbfFPago )



   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "Entregas a cuenta", "Recibos",, .F.,,,,,, .F.,,,,,, .F., )







      oFld := TFolder():ReDefine( 500, {"&General", "Bancos"}, { "Entregas_1","Recibos_4" }, oDlg,,,,, .F., )





      oBmp := TBitmap():ReDefine( 500, "Money_Alpha_48",, oFld:aDialogs[ 1 ],,, .F., .F.,,, .F.,,, .T. )








      aGet[ ( dbfTmpPgo )->( FieldPos( "nImporte" ) ) ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "nImporte" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "nImporte" ) ) ]:= u ) }, oFld:aDialogs[ 1 ],, ( cPorDiv ),,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )











      aGet[ ( dbfTmpPgo )->( FieldPos( "cDivPgo" ) ) ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "cDivPgo" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "cDivPgo" ) ) ]:= u ) }, oFld:aDialogs[ 1 ],, "@!", {||    ( cDivOut( aGet[ ( dbfTmpPgo )->( FieldPos( "cDivPgo" ) ) ], oBmpDiv, aGet[ ( dbfTmpPgo )->( FieldPos( "nVdvPgo" ) ) ], nil, nil, @cPorDiv, nil, nil, nil, nil, dbfDiv, oBandera ) )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ ( dbfTmpPgo )->( FieldPos( "cDivPgo" ) ) ], oBmpDiv, aGet[ ( dbfTmpPgo )->( FieldPos( "nVdvPgo" ) ) ], dbfDiv, oBandera )}, nil, "LUPA",, )




      oBmpDiv := TBitmap():ReDefine( 151, "BAN_EURO",, oFld:aDialogs[ 1 ],,, .F., .F.,,, .F.,,, .F. )










      aGet[ ( dbfTmpPgo )->( FieldPos( "cCodPgo" ) ) ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodPgo" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodPgo" ) ) ]:= u ) }, oFld:aDialogs[ 1 ],, "@!", {||    ( cFPago( aGet[ ( dbfTmpPgo )->( FieldPos( "cCodPgo" ) ) ], dbfFPago, oFpago ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFPago( aGet[ ( dbfTmpPgo )->( FieldPos( "cCodPgo" ) ) ], oFpago ) )}, nil, "LUPA",, )




      oFpago := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, cFpago, cFpago:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ ( dbfTmpPgo )->( FieldPos( "dEntrega" ) ) ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "dEntrega" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "dEntrega" ) ) ]:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ ( dbfTmpPgo )->( FieldPos( "dEntrega" ) ) ]:cText( Calendario( aTmp[ ( dbfTmpPgo )->( FieldPos( "dEntrega" ) ) ] ) )}, nil, "LUPA",, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "cTurRec" ) ) ] := TGetHlp():ReDefine( 335, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "cTurRec" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "cTurRec" ) ) ]:= u ) }, oFld:aDialogs[ 1 ],, "999999",,,,,,, .F., {||     ( nMode <> 3 .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )










      aGet[ ( dbfTmpPgo )->( FieldPos( "cCodCli" ) ) ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCli" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCli" ) ) ]:= u ) }, oFld:aDialogs[ 1 ],,, {||    ( cClient( aGet[ ( dbfTmpPgo )->( FieldPos( "cCodCli" ) ) ], dbfClient, oGetCli ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwClient( aGet[ ( dbfTmpPgo )->( FieldPos( "cCodCli" ) ) ], oGetCli ) )}, nil, "LUPA",, )




      oGetCli := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, cGetCli, cGetCli:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ ( dbfTmpPgo )->( FieldPos( "cCodAge" ) ) ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodAge" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodAge" ) ) ]:= u ) }, oFld:aDialogs[ 1 ],,, {||    ( cAgentes( aGet[ ( dbfTmpPgo )->( FieldPos( "cCodAge" ) ) ], dbfAgent, oGetAge ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ ( dbfTmpPgo )->( FieldPos( "cCodAge" ) ) ], oGetAge ) )}, nil, "LUPA",, )




      oGetAge := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, cGetAge, cGetAge:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      aGet[ ( dbfTmpPgo )->( FieldPos( "cDescrip" ) ) ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "cDescrip" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "cDescrip" ) ) ]:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ ( dbfTmpPgo )->( FieldPos( "cPgdoPor" ) ) ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "cPgdoPor" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "cPgdoPor" ) ) ]:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )










      aGet[ ( dbfTmpPgo )->( FieldPos( "cCodCaj" ) ) ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCaj" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCaj" ) ) ]:= u ) }, oFld:aDialogs[ 1 ],,, {||    cCajas( aGet[ ( dbfTmpPgo )->( FieldPos( "cCodCaj" ) ) ], dbfCajT, oGetCaj )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ ( dbfTmpPgo )->( FieldPos( "cCodCaj" ) ) ], oGetCaj ) )}, nil, "LUPA",, )




      oGetCaj := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, cGetCaj, cGetCaj:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      oBmpBancos := TBitmap():ReDefine( 500, "office_building_48_alpha",, oFld:aDialogs[ 2 ],,, .F., .F.,,, .F.,,, .T. )






      aGet[ ( dbfTmpPgo )->( FieldPos( "CBNCEMP" ) ) ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CBNCEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CBNCEMP" ) ) ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwBncEmp( aGet[ ( dbfTmpPgo )->( FieldPos( "CBNCEMP" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CENTEMP" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CSUCEMP" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAEMP" ) ) ] ) )}, nil, "LUPA",, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CENTEMP" ) ) ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTEMP" ) ) ]:= u ) }, oFld:aDialogs[2],,, {||    ( lCalcDC( aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAEMP" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CSUCEMP" ) ) ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCEMP" ) ) ]:= u ) }, oFld:aDialogs[2],,, {||    ( lCalcDC( aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAEMP" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ]:= u ) }, oFld:aDialogs[2],,, {||    ( lCalcDC( aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAEMP" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAEMP" ) ) ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAEMP" ) ) ]:= u ) }, oFld:aDialogs[2],,, {||    ( lCalcDC( aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAEMP" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGEMP" ) ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ ( dbfTmpPgo )->( FieldPos( "CBNCCLI" ) ) ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CBNCCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CBNCCLI" ) ) ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwBncCli( aGet[ ( dbfTmpPgo )->( FieldPos( "CBNCCLI" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CENTCLI" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CSUCCLI" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CCTACLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCLI" ) ) ] ) )}, nil, "LUPA",, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CENTCLI" ) ) ] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTCLI" ) ) ]:= u ) }, oFld:aDialogs[2],,, {||    ( lCalcDC( aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTACLI" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CSUCCLI" ) ) ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCCLI" ) ) ]:= u ) }, oFld:aDialogs[2],,, {||    ( lCalcDC( aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTACLI" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ]:= u ) }, oFld:aDialogs[2],,, {||    ( lCalcDC( aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTACLI" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CCTACLI" ) ) ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTACLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTACLI" ) ) ]:= u ) }, oFld:aDialogs[2],,, {||    ( lCalcDC( aTmp[ ( dbfTmpPgo )->( FieldPos( "CENTCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUCCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTACLI" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CDIGCLI" ) ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      TButton():ReDefine( 1, {||( ValidEdtEnt( aTmp, aGet, oBrw, oDlg, nMode, dbfTmpPgo ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( oDlg:End() )}, oDlg,,, .F.,,,, .T. )

   oDlg:bStart    := {|| aGet[ ( dbfTmpPgo )->( FieldPos( "nImporte" ) ) ]:SetFocus() }

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| ValidEdtEnt( aTmp, aGet, oBrw, oDlg, nMode, dbfTmpPgo ) } )
   end


   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( CreateMenuEntrega( aTmp, oDlg ) )}, oDlg:bRClicked,,, )

   if !Empty( oMenu )
      oMenu:End()
   end

   if !Empty( oBmpDiv )
      oBmpDiv:End()
   end

   if !Empty( oBmp )
      oBmp:End()
   end

   if !Empty( oBmpBancos )
      oBmpBancos:End()
   end

RETURN ( oDlg:nResult == 1 )



Static Function ValidEdtEnt( aTmp, aGet, oBrw, oDlg, nMode, dbfTmpPgo )

   if nMode == 1
      aTmp[ ( dbfTmpPgo )->( FieldPos( "nNumRec" ) ) ]   := ( dbfTmpPgo )->( LastRec() ) + 1
   end

   WinGather( aTmp, aGet, dbfTmpPgo, oBrw, nMode )

   oDlg:End( 1 )

Return .T.



Static Function CreateMenuEntrega( aTmp, oDlg )

   oMenu := MenuBegin( .F.,,, .F., .F. )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F. )

         MenuBegin( .F.,,, .F., .F. )




            MenuAddItem( "&2. Modificar cliente", "Modifica la ficha del cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCli" ) ) ] ), EdtCli( aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCli" ) ) ] ), MsgStop( "Código de cliente vacío" ) ) )},, "User1_16",,,,, .F.,,, .F. )





            MenuAddItem( "&3. Informe de cliente", "Informe de cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCli" ) ) ] ), InfCliente( aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCli" ) ) ] ), MsgStop( "Código de cliente vacío" ) ) )},, "Info16",,,,, .F.,,, .F. )
         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMenu )

RETURN ( oMenu )



_HB_CLASS TAlbaranesClientesSenderReciver ; UTILITY FUNCTION TAlbaranesClientesSenderReciver(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TAlbaranesClientesSenderReciver" , {TSenderReciverItem():classh} ) ) ; ;

   _HB_MEMBER CreateData(); IIF( .F., s_oClass:ModMethod( "CreateData", @TAlbaranesClientesSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CreateData", @TAlbaranesClientesSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER RestoreData(); IIF( .F., s_oClass:ModMethod( "RestoreData", @TAlbaranesClientesSenderReciver_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "RestoreData", @TAlbaranesClientesSenderReciver_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER SendData(); IIF( .F., s_oClass:ModMethod( "SendData", @TAlbaranesClientesSenderReciver_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SendData", @TAlbaranesClientesSenderReciver_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER ReciveData(); IIF( .F., s_oClass:ModMethod( "ReciveData", @TAlbaranesClientesSenderReciver_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "ReciveData", @TAlbaranesClientesSenderReciver_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Process(); IIF( .F., s_oClass:ModMethod( "Process", @TAlbaranesClientesSenderReciver_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Process", @TAlbaranesClientesSenderReciver_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TAlbaranesClientesSenderReciver ;



UTILITY STATIC function TAlbaranesClientesSenderReciver_CreateData() ; local Self AS CLASS TAlbaranesClientesSenderReciver := QSelf() AS CLASS TAlbaranesClientesSenderReciver

   local oBlock
   local oError
   local lSnd        := .F.
   local nOrd
   local dbfAlbCliT
   local dbfAlbCliL
   local dbfAlbCliI
   local tmpAlbCliT
   local tmpAlbCliL
   local tmpAlbCliI
   local cFileName

   if ::oSender:lServer
      cFileName      := "AlbCli" + StrZero( ::nGetNumberToSend(), 6 ) + ".All"
   else
      cFileName      := "AlbCli" + StrZero( ::nGetNumberToSend(), 6 ) + "." + RetSufEmp()
   end

   ::oSender:SetText( "Enviando albaranes de clientes" )

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbCLIT.DBF" ), ( cCheckArea( "AlbCLIT", @dbfAlbCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbCLIL.DBF" ), ( cCheckArea( "AlbCLIL", @dbfAlbCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbCliI.DBF" ), ( cCheckArea( "AlbCliI", @dbfAlbCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end





   rxAlbCli( cPatSnd() )

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "AlbCliT.DBF" ), ( cCheckArea( "AlbCliT", @tmpAlbCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "AlbCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "AlbCliL.DBF" ), ( cCheckArea( "AlbCliL", @tmpAlbCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "AlbCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "AlbCliI.DBF" ), ( cCheckArea( "AlbCliI", @tmpAlbCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "AlbCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   if !Empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( dbfAlbCliT )->( LastRec() )
   end

   nOrd  := ( dbfAlbCliT )->( OrdSetFocus( "lSndDoc" ) )

   if ( dbfAlbCliT )->( dbSeek( .T. ) )

      while !( dbfAlbCliT )->( eof() )

         if ( lEnviarEntregados() .AND. ( dbfAlbCliT )->lEntregado ) .OR. !lEnviarEntregados()

            lSnd  := .T.

            dbPass( dbfAlbCliT, tmpAlbCliT, .T. )
            ::oSender:SetText( ( dbfAlbCliT )->cSerAlb + "/" + AllTrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + "/" + AllTrim( ( dbfAlbCliT )->cSufAlb ) + "; " + Dtoc( ( dbfAlbCliT )->dFecAlb ) + "; " + AllTrim( ( dbfAlbCliT )->cCodCli ) + "; " + ( dbfAlbCliT )->cNomCli )

            if ( dbfAlbCliL )->( dbSeek( ( dbfAlbCliT )->CSERAlb + Str( ( dbfAlbCliT )->NNUMAlb ) + ( dbfAlbCliT )->CSUFAlb ) )
               while ( ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->NNUMAlb ) + ( dbfAlbCliL )->CSUFAlb ) == ( ( dbfAlbCliT )->CSERAlb + Str( ( dbfAlbCliT )->NNUMAlb ) + ( dbfAlbCliT )->CSUFAlb ) .AND. !( dbfAlbCliL )->( eof() )
                  dbPass( dbfAlbCliL, tmpAlbCliL, .T. )
                  ( dbfAlbCliL )->( dbSkip() )
               end
            end

            if ( dbfAlbCliI )->( dbSeek( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb ) )
               while ( ( dbfAlbCliI )->cSerAlb + Str( ( dbfAlbCliI )->nNumAlb ) + ( dbfAlbCliI )->cSufAlb ) == ( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb ) .AND. !( dbfAlbCliI )->( eof() )
                  dbPass( dbfAlbCliI, tmpAlbCliI, .T. )
                  ( dbfAlbCliI )->( dbSkip() )
               end
            end

         end

         SysRefresh()

         ( dbfAlbCliT )->( dbSkip() )

         if !Empty( ::oSender:oMtr )
            ::oSender:oMtr:Set( ( dbfAlbCliT )->( OrdKeyNo() ) )
         end

      end

   end

   ( dbfAlbCliT )->( OrdSetFocus( nOrd ) )

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos de albaranes" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end
   ErrorBlock( oBlock )

   ( dbfAlbCliT )->( dbCloseArea() )
   ( dbfAlbCliL )->( dbCloseArea() )
   ( dbfAlbCliI )->( dbCloseArea() )
   ( tmpAlbCliT )->( dbCloseArea() )
   ( tmpAlbCliL )->( dbCloseArea() )
   ( tmpAlbCliI )->( dbCloseArea() )

   if lSnd

      ::oSender:SetText( "Comprimiendo albaranes de clientes" )

      if ::oSender:lZipData( cFileName )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay albaranes de clientes para enviar" )

   end

Return ( Self )



UTILITY STATIC function TAlbaranesClientesSenderReciver_RestoreData() ; local Self AS CLASS TAlbaranesClientesSenderReciver := QSelf() AS CLASS TAlbaranesClientesSenderReciver

   local oBlock
   local oError
   local dbfAlbCliT





   if ::lSuccesfullSend

      oBlock         := ErrorBlock( { | oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

         dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbCliT.Dbf" ), ( cCheckArea( "AlbCliT", @dbfAlbCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
         if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbCliT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end
         ( dbfAlbCliT )->( OrdSetFocus( "lSndDoc" ) )

         while ( dbfAlbCliT )->( dbSeek( .T. ) ) .AND. !( dbfAlbCliT )->( eof() )
            if dbLock( dbfAlbCliT )
               ( dbfAlbCliT )->lSndDoc := .F.
               ( dbfAlbCliT )->( dbRUnlock() )
            end
         end

      RECOVER USING oError

         msgStop( "Imposible abrir todas las bases de datos de albaranes" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      end
      ErrorBlock( oBlock )

      ( dbfAlbCliT )->( dbCloseArea() )

   end

Return ( Self )



UTILITY STATIC function TAlbaranesClientesSenderReciver_SendData() ; local Self AS CLASS TAlbaranesClientesSenderReciver := QSelf() AS CLASS TAlbaranesClientesSenderReciver

   local cFileName

   if ::oSender:lServer
      cFileName         := "AlbCli" + StrZero( ::nGetNumberToSend(), 6 ) + ".All"
   else
      cFileName         := "AlbCli" + StrZero( ::nGetNumberToSend(), 6 ) + "." + RetSufEmp()
   end





   if File( cPatOut() + cFileName )

      if ftpSndFile( cPatOut() + cFileName, cFileName, 2000, ::oSender )
         ::IncNumberToSend()
         ::lSuccesfullSend := .T.
         ::oSender:SetText( "Fichero enviado " + cFileName )
      else
         ::oSender:SetText( "ERROR al enviar fichero" )
      end

   end

Return ( Self )



UTILITY STATIC function TAlbaranesClientesSenderReciver_ReciveData() ; local Self AS CLASS TAlbaranesClientesSenderReciver := QSelf() AS CLASS TAlbaranesClientesSenderReciver

   local n
   local aExt

   if ::oSender:lServer
      aExt        := aRetDlgEmp()
   else
      aExt        := { "All" }
   end





   ::oSender:SetText( "Recibiendo albaranes de clientes" )

   for n := 1 to len( aExt )
      ftpGetFiles( "AlbCli*." + aExt[ n ], cPatIn(), 2000, ::oSender )
   next

   ::oSender:SetText( "Albaranes de clientes recibidos" )

Return Self



UTILITY STATIC function TAlbaranesClientesSenderReciver_Process() ; local Self AS CLASS TAlbaranesClientesSenderReciver := QSelf() AS CLASS TAlbaranesClientesSenderReciver

   local m
   local dbfAlbCliT
   local dbfAlbCliL
   local dbfAlbCliI
   local tmpAlbCliT
   local tmpAlbCliL
   local tmpAlbCliI
   local oBlock
   local oError
   local aFiles      := Directory( cPatIn() + "AlbCli*.*" )
   local lClient     := ::oSender:lServer

   for m := 1 to len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      oBlock         := ErrorBlock( { | oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

         if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )







            if lExistTable( cPatSnd() + "AlbCliT.DBF" )   .AND. lExistTable( cPatSnd() + "AlbCliL.DBF" )   .AND. lExistTable( cPatSnd() + "AlbCliI.DBF" )

               dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "AlbCliT.DBF" ), ( cCheckArea( "AlbCliT", @tmpAlbCliT ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
               if !lAIS() ; ordListAdd( ( cPatSnd() + "AlbCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "AlbCliL.DBF" ), ( cCheckArea( "AlbCliL", @tmpAlbCliL ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
               if !lAIS() ; ordListAdd( ( cPatSnd() + "AlbCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "AlbCliI.DBF" ), ( cCheckArea( "AlbCliI", @tmpAlbCliI ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
               if !lAIS() ; ordListAdd( ( cPatSnd() + "AlbCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbCliT.DBF" ), ( cCheckArea( "AlbCliT", @dbfAlbCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbCliL.DBF" ), ( cCheckArea( "AlbCliL", @dbfAlbCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbCliI.DBF" ), ( cCheckArea( "AlbCliI", @dbfAlbCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               while ( tmpAlbCliT )->( !eof() )


                  if lValidaOperacion( ( tmpAlbCliT )->dFecAlb, .F. ) .AND.  !( dbfAlbCliT )->( dbSeek( ( tmpAlbCliT )->cSerAlb + Str( ( tmpAlbCliT )->nNumAlb ) + ( tmpAlbCliT )->cSufAlb ) )

                     dbPass( tmpAlbCliT, dbfAlbCliT, .T. )

                     if lClient .AND. dbLock( dbfAlbCliT )
                        ( dbfAlbCliT )->lSndDoc := .F.
                        ( dbfAlbCliT )->( dbUnLock() )
                     end

                     ::oSender:SetText( "Añadido     : " + ( tmpAlbCliT )->cSerAlb + "/" + AllTrim( Str( ( tmpAlbCliT )->nNumAlb ) ) + "/" + AllTrim( ( tmpAlbCliT )->cSufAlb ) + "; " + Dtoc( ( tmpAlbCliT )->dFecAlb ) + "; " + AllTrim( ( tmpAlbCliT )->cCodCli ) + "; " + ( tmpAlbCliT )->cNomCli )

                     if ( tmpAlbCliL )->( dbSeek( ( tmpAlbCliT )->cSerAlb + Str( ( tmpAlbCliT )->nNumAlb ) + ( tmpAlbCliT )->cSufAlb ) )
                        while ( tmpAlbCliL )->cSerAlb + Str( ( tmpAlbCliL )->nNumAlb ) + ( tmpAlbCliL )->cSufAlb == ( tmpAlbCliT )->cSerAlb + Str( ( tmpAlbCliT )->nNumAlb ) + ( tmpAlbCliT )->cSufAlb .AND. !( tmpAlbCliL )->( eof() )
                           dbPass( tmpAlbCliL, dbfAlbCliL, .T. )
                           ( tmpAlbCliL )->( dbSkip() )
                        end
                     end

                     if ( tmpAlbCliI )->( dbSeek( ( tmpAlbCliT )->cSerAlb + Str( ( tmpAlbCliT )->nNumAlb ) + ( tmpAlbCliT )->cSufAlb ) )
                        while ( tmpAlbCliI )->cSerAlb + Str( ( tmpAlbCliI )->nNumAlb ) + ( tmpAlbCliI )->cSufAlb == ( tmpAlbCliT )->cSerAlb + Str( ( tmpAlbCliT )->nNumAlb ) + ( tmpAlbCliT )->cSufAlb .AND. !( tmpAlbCliI )->( eof() )
                           dbPass( tmpAlbCliI, dbfAlbCliI, .T. )
                           ( tmpAlbCliI )->( dbSkip() )
                        end
                     end

                  else

                     ::oSender:SetText( "Desestimado : " + ( tmpAlbCliT )->cSerAlb + "/" + AllTrim( Str( ( tmpAlbCliT )->nNumAlb ) ) + "/" + AllTrim( ( tmpAlbCliT )->cSufAlb ) + "; " + Dtoc( ( tmpAlbCliT )->dFecAlb ) + "; " + AllTrim( ( tmpAlbCliT )->cCodCli ) + "; " + ( tmpAlbCliT )->cNomCli )

                  end

                  SysRefresh()

                  ( tmpAlbCliT )->( dbSkip() )

               end

               ( dbfAlbCliT )->( dbCloseArea() )
               ( dbfAlbCliL )->( dbCloseArea() )
               ( dbfAlbCliI )->( dbCloseArea() )
               ( tmpAlbCliT )->( dbCloseArea() )
               ( tmpAlbCliL )->( dbCloseArea() )
               ( tmpAlbCliI )->( dbCloseArea() )

               ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

            else

               ::oSender:SetText( "Faltan ficheros" )

               if !file( cPatSnd() + "AlbCliT.Dbf" )
                  ::oSender:SetText( "Falta" + cPatSnd() + "AlbCliT.Dbf" )
               end

               if !file( cPatSnd() + "AlbCliL.Dbf" )
                  ::oSender:SetText( "Falta" + cPatSnd() + "AlbCliL.Dbf" )
               end

               if !file( cPatSnd() + "AlbCliI.Dbf" )
                  ::oSender:SetText( "Falta" + cPatSnd() + "AlbCliI.Dbf" )
               end

            end

            fErase( cPatSnd() + "AlbCliT.DBF" )
            fErase( cPatSnd() + "AlbCliL.DBF" )
            fErase( cPatSnd() + "AlbCliI.DBF" )

         else

            ::oSender:SetText( "Error al descomprimir los ficheros" )

         end

      RECOVER USING oError

         ( dbfAlbCliT )->( dbCloseArea() )
         ( dbfAlbCliL )->( dbCloseArea() )
         ( dbfAlbCliI )->( dbCloseArea() )
         ( tmpAlbCliT )->( dbCloseArea() )
         ( tmpAlbCliL )->( dbCloseArea() )
         ( tmpAlbCliI )->( dbCloseArea() )

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end
      ErrorBlock( oBlock )

   next

Return Self


















STATIC FUNCTION DelSerie( oWndBrw )

    local oDlg
   local oSerIni
   local oSerFin
   local oTxtDel
   local nTxtDel     := 0
   local nRecno      := ( dbfAlbCliT )->( Recno() )
   local nOrdAnt     := ( dbfAlbCliT )->( OrdSetFocus( 1 ) )
   local oDesde      := TDesdeHasta():Init( ( dbfAlbCliT )->cSerAlb, ( dbfAlbCliT )->nNumAlb, ( dbfAlbCliT )->cSufAlb, GetSysDate() )
   local lCancel     := .F.
   local oBtnAceptar
   local oBtnCancel




   oDlg = TDialog():New(,,,, "Eliminar series de albaranes", "DelSerDoc",, .F.,,,,, oWndBrw, .F.,,,,,, .F., )



   TRadMenu():Redefine( { | u | If( PCount()==0, oDesde:nRadio, oDesde:nRadio:= u ) }, oDlg,, { 90, 91 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, oDesde:cSerieInicio, oDesde:cSerieInicio:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieInicio >= "A" .AND. oDesde:cSerieInicio <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, oDesde:cSerieFin, oDesde:cSerieFin:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieFin >= "A" .AND. oDesde:cSerieFin <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, oDesde:nNumeroInicio, oDesde:nNumeroInicio:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, oDesde:nNumeroFin, oDesde:nNumeroFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, oDesde:cSufijoInicio, oDesde:cSufijoInicio:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, oDesde:cSufijoFin, oDesde:cSufijoFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 170, { | u | If( PCount()==0, oDesde:dFechaInicio, oDesde:dFechaInicio:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 180, { | u | If( PCount()==0, oDesde:dFechaFin, oDesde:dFechaFin:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )




   oBtnAceptar := TButton():ReDefine( 1, {||( DelStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDel, @lCancel ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( lCancel := .T., oDlg:end() )}, oDlg,,, .F.,,,, .T. )





   oTxtDel := TMeter():ReDefine( 160, { | u | If( PCount()==0, nTxtDel, nTxtDel:= u ) }, ( dbfAlbCliT )->( OrdKeyCount() ), oDlg, .F.,,, .T.,,,, )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T., {|Self|( lCancel )},,, oDlg:bRClicked,,, )

   ( dbfAlbCliT )->( dbGoTo( nRecNo ) )
   ( dbfAlbCliT )->( ordSetFocus( nOrdAnt ) )

   oWndBrw:SetFocus()
   oWndBrw:Refresh()

RETURN NIL



STATIC FUNCTION DelStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDel, lCancel )

   local nOrd
   local nDeleted          := 0
   local nProcesed         := 0

   oBtnAceptar:Hide()
   oBtnCancel:bAction      := {|| lCancel := .T. }

   if oDesde:nRadio == 1

      nOrd                 := ( dbfAlbCliT )->( OrdSetFocus( "nNumAlb" ) )

      ( dbfAlbCliT )->( dbSeek( oDesde:cNumeroInicio(), .T. ) )
      while !lCancel .AND. ( dbfAlbCliT )->( !eof() )






         if ( dbfAlbCliT )->cSerAlb >= oDesde:cSerieInicio  .AND. ( dbfAlbCliT )->cSerAlb <= oDesde:cSerieFin     .AND. ( dbfAlbCliT )->nNumAlb >= oDesde:nNumeroInicio .AND. ( dbfAlbCliT )->nNumAlb <= oDesde:nNumeroFin    .AND. ( dbfAlbCliT )->cSufAlb >= oDesde:cSufijoInicio .AND. ( dbfAlbCliT )->cSufAlb <= oDesde:cSufijoFin

            ++nDeleted

            oTxtDel:cText  := "Eliminando : " + ( dbfAlbCliT )->cSerAlb + "/" + Alltrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + "/" + ( dbfAlbCliT )->cSufAlb



            WinDelRec( nil, dbfAlbCliT, {|| QuiAlbCli() } )

         else

            ( dbfAlbCliT )->( dbSkip() )

         end

         ++nProcesed

         oTxtDel:Set( ( dbfAlbCliT )->( OrdKeyNo() ) )

      end

      ( dbfAlbCliT )->( OrdSetFocus( nOrd ) )

   else

      nOrd                 := ( dbfAlbCliT )->( OrdSetFocus( "dFecAlb" ) )

      ( dbfAlbCliT )->( dbSeek( oDesde:dFechaInicio, .T. ) )
      while !lCancel .AND. ( dbfAlbCliT )->( !eof() )


         if ( dbfAlbCliT )->dFecAlb >= oDesde:dFechaInicio  .AND. ( dbfAlbCliT )->dFecAlb <= oDesde:dFechaFin

            ++nDeleted

            oTxtDel:cText  := "Eliminando : " + ( dbfAlbCliT )->cSerAlb + "/" + Alltrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + "/" + ( dbfAlbCliT )->cSufAlb



            WinDelRec( nil, dbfAlbCliT, {|| QuiAlbCli() } )

         else

            ( dbfAlbCliT )->( dbSkip() )

         end

         ++nProcesed

         oTxtDel:Set( ( dbfAlbCliT )->( OrdKeyNo() ) )

      end

      ( dbfAlbCliT )->( OrdSetFocus( nOrd ) )

   end

   lCancel                 := .T.

   oBtnAceptar:Show()

   if lCancel
      msgStop( "Total de registros borrados : " + Str( nDeleted ), "Proceso cancelado" )
   else
      msgInfo( "Total de registros borrados : " + Str( nDeleted ), "Proceso finalizado" )
   end

RETURN ( oDlg:End() )



 Static Function nEstadoIncidencia( cNumAlb )

   local nEstado  := 0
   local aBmp     := ""
   local nOrdAnt  := ( dbfAlbCliI )->( OrdSetFocus( "nNumAlb" ) )

   if ( dbfAlbCliI )->( dbSeek( cNumAlb ) )

      while ( dbfAlbCliI )->cSerAlb + Str( ( dbfAlbCliI )->nNumAlb ) + ( dbfAlbCliI )->cSufAlb == cNumAlb .AND. !( dbfAlbCliI )->( Eof() )

         if ( dbfAlbCliI )->lListo
            do case
               case nEstado == 0 .OR. nEstado == 3
                    nEstado := 3
               case nEstado == 1
                    nEstado := 2
            end
         else
            do case
               case nEstado == 0
                    nEstado := 1
               case nEstado == 3
                    nEstado := 2
            end
         end

         ( dbfAlbCliI )->( dbSkip() )

      end

   end

   ( dbfAlbCliI )->( OrdSetFocus( nOrdAnt ) )

Return ( nEstado )





function nEstadoGenerado( cNumPed, dbfPedCliL, dbfPedPrvL )

   local nEstado := 0
   local nOrdAnt

   if IsMuebles()
      nOrdAnt := ( dbfPedPrvL )->( OrdSetFocus( "CPEDCLIREFDET" ) )
   else
      nOrdAnt := ( dbfPedPrvL )->( OrdSetFocus( "CPEDCLIREF" ) )
   end

   ( dbfPedCliL )->( dbSeek( cNumPed ) )

   while ( dbfPedCliL )->cSerPed + Str( ( dbfPedCliL )->nNumPed ) + ( dbfPedCliL )->cSufPed == cNumPed .AND. !( dbfPedCliL )->( Eof() )

      if IsMuebles()

         if ( dbfPedPrvL )->( dbSeek( cNumPed + ( dbfPedCliL )->cRef + ( dbfPedCliL )->cRefPrv + ( dbfPedCliL )->cDetalle ) )

            do case
               case nEstado == 0 .OR. nEstado == 3
                  nEstado := 3
               case nEstado == 1
                  nEstado := 2
            end
         else
            do case
               case nEstado == 0
                  nEstado := 1
               case nEstado == 3
                  nEstado := 2
            end
         end

      else

         if( dbfPedPrvL )->( dbSeek( cNumPed + ( dbfPedCliL )->cRef ) )
            do case
               case nEstado == 0 .OR. nEstado == 3
                  nEstado := 3
               case nEstado == 1
                  nEstado := 2
            end
         else
            do case
               case nEstado == 0
                  nEstado := 1
               case nEstado == 3
                  nEstado := 2
            end
         end

      end

   ( dbfPedCliL )->( dbSkip() )

   end

   ( dbfPedPrvL )->( OrdSetFocus( nOrdAnt ) )

return ( Max( nEstado, 1 ) )



Function AppAlbCli( cCodCli, cCodArt, lOpenBrowse )

   local nLevel         := nLevelUsr( "01057" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 2 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbCli( nil, nil, cCodCli, cCodArt )
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( nil, .T. )
         nTotAlbCli()
         WinAppRec( nil, bEdtRec, dbfAlbCliT, cCodCli, cCodArt )
         CloseFiles()
      end

   end

RETURN .T.



Function EdtAlbCli( cNumAlb, lOpenBrowse )

   local nLevel         := nLevelUsr( "01057" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbCli()
         if dbSeekInOrd( cNumAlb, "nNumAlb", dbfAlbCliT )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra albaran" )
         end
      end

   else

      if OpenFiles( nil, .T. )

         if dbSeekInOrd( cNumAlb, "nNumAlb", dbfAlbCliT )
            nTotAlbCli()
            WinEdtRec( nil, bEdtRec, dbfAlbCliT )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION ZooAlbCli( cNumAlb, lOpenBrowse )

   local nLevel         := nLevelUsr( "01057" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbCli()
         if dbSeekInOrd( cNumAlb, "nNumAlb", dbfAlbCliT )
            oWndBrw:RecZoom()
         else
            MsgStop( "No se encuentra albaran" )
         end
      end

   else

      if OpenFiles( nil, .T. )

         if dbSeekInOrd( cNumAlb, "nNumAlb", dbfAlbCliT )
            nTotAlbCli()
            WinZooRec( nil, bEdtRec, dbfAlbCliT )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION DelAlbCli( cNumAlb, lOpenBrowse )

   local nLevel         := nLevelUsr( "01057" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 16 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbCli()
         if dbSeekInOrd( cNumAlb, "nNumAlb", dbfAlbCliT )
            WinDelRec( nil, dbfAlbCliT, {|| QuiAlbCli() } )
         else
            MsgStop( "No se encuentra albaran" )
         end
      end

   else

      if OpenFiles( nil, .T. )

         if dbSeekInOrd( cNumAlb, "nNumAlb", dbfAlbCliT )
            nTotAlbCli()
            WinDelRec( nil, dbfAlbCliT, {|| QuiAlbCli() } )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION PrnAlbCli( cNumAlb, lOpenBrowse, cCaption, cFormato, cPrinter )

   local nLevel         := nLevelUsr( "01057" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbCli()
         if dbSeekInOrd( cNumAlb, "nNumAlb", dbfAlbCliT )
            GenAlbCli( 1, cCaption, cFormato, cPrinter )
         else
            MsgStop( "No se encuentra albaran" )
         end
      end

   else

      if OpenFiles( nil, .T. )

         if dbSeekInOrd( cNumAlb, "nNumAlb", dbfAlbCliT )
            nTotAlbCli()
            GenAlbCli( 1, cCaption, cFormato, cPrinter )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION VisAlbCli( cNumAlb, lOpenBrowse, cCaption, cFormato, cPrinter )

   local nLevel         := nLevelUsr( "01057" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbCli()
         if dbSeekInOrd( cNumAlb, "nNumAlb", dbfAlbCliT )
            GenAlbCli( 2, cCaption, cFormato, cPrinter )
         else
            MsgStop( "No se encuentra albaran" )
         end
      end

   else

      if OpenFiles( nil, .T. )

         if dbSeekInOrd( cNumAlb, "nNumAlb", dbfAlbCliT )
            nTotAlbCli()
            GenAlbCli( 2, cCaption, cFormato, cPrinter )
         end

         CloseFiles()

      end

   end

Return .T.



Static Function DesgPnt( cCodArt, aTmp, nTarifa, oPreDiv, oCosDiv, nMode )

   local oDlg
   local oPuntos
   local oValorPunto
   local oDtoPnt
   local oIncPnt
   local oImporte
   local nPuntos     := 0
   local nValorPunto := 0
   local nDtoPnt     := 0
   local nIncPnt     := 0



   if Empty( cCodArt )
      MsgInfo( "Debe seleccinar un artículo", "Código vacío" )
      return .F.
   end



   nPuntos           := aTmp[ 61 ]
   nValorPunto       := aTmp[ 62 ]
   nDtoPnt           := aTmp[ 63 ]
   nIncPnt           := aTmp[ 64 ]

   oDlg = TDialog():New(,,,, "Desglose de puntos", "DESGPUNTOS",, .F.,,,,,, .F.,,,,,, .F., )







   oPuntos := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, nPuntos, nPuntos:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,,,,, nil,,, )







   oValorPunto := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, nValorPunto, nValorPunto:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,,,,, nil,,, )









   oDtoPnt := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nDtoPnt, nDtoPnt:= u ) }, oDlg,, "999.99",,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,, {||      0}, {||      100},, nil,,, )









   oIncPnt := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, nIncPnt, nIncPnt:= u ) }, oDlg,, "999.99",,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,, {||      0}, {||      100},, nil,,, )





   oImporte := TSay():ReDefine( 240, {|| nCalculoPuntos( nPuntos, nValorPunto, nDtoPnt, nIncPnt )}, oDlg, cPouDiv, "N/W*",, .F.,, .F., .F. )





   TButton():ReDefine( 500, {||( EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, dbfArticulo, nDouDiv ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




   TButton():ReDefine( 550, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, dbfArticulo, nDouDiv ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      aTmp[ 61 ]     := nPuntos
      aTmp[ 62 ]     := nValorPunto
      aTmp[ 63 ]     := nDtoPnt
      aTmp[ 64 ]     := nIncPnt
      oCosDiv:cText( oImporte:VarGet() )
      oCosDiv:Refresh()

   end

Return ( .T. )



Static Function AlbCliNotas()

   local cObserv  := ""
   local aData    := {}

   aAdd( aData, "Albaran " + ( dbfAlbCliT )->cSerAlb + "/" + AllTrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + "/" + Alltrim( ( dbfAlbCliT )->cSufAlb ) + " de " + Rtrim( ( dbfAlbCliT )->cNomCli ) )
   aAdd( aData, "10" )
   aAdd( aData, ( dbfAlbCliT )->cCodCli )
   aAdd( aData, ( dbfAlbCliT )->cNomCli )
   aAdd( aData, ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb )

   if ( dbfClient )->( dbSeek( ( dbfAlbCliT )->cCodCli ) )

      if !Empty( ( dbfClient )->cPerCto )
         cObserv  += Rtrim( ( dbfClient )->cPerCto ) + Space( 1 )
      end

      if !Empty( ( dbfClient )->Telefono )
         cObserv  += "Télefono : " + Rtrim( ( dbfClient )->Telefono ) + Space( 1 )
      end

      if !Empty( ( dbfClient )->Movil )
         cObserv  += "Móvil : " + Rtrim( ( dbfClient )->Movil ) + Space( 1 )
      end

      if !Empty( ( dbfClient )->Fax )
         cObserv  += "Fax : " + Rtrim( ( dbfClient )->Fax ) + Space( 1 )
      end

   end

   aAdd( aData, cObserv )

   GenerarNotas( aData )

Return ( nil )




STATIC FUNCTION PrnEntregas( lPrint, cAlbCliP, lTicket )

    local oDlg
   local oFmtEnt
   local cFmtEnt
   local oSayEnt
   local cSayEnt
   local cPrinter
   local oPrinter
   local nCopPrn
   local oCopPrn

   IIF( lPrint == nil, lPrint := .T., ) ;
   IIF( lTicket == nil, lTicket := .F., ) ;

   if lTicket
      cFmtEnt        := cFormatoEntregasCuentaEnCaja( oUser():cCaja(), dbfCajT )
      cPrinter       := cPrinterEntregasCuenta( oUser():cCaja(), dbfCajT )
      nCopPrn        := nCopiasEntregasCuentaEnCaja( oUser():cCaja(), dbfCajT )
   else
      cFmtEnt        := cFormatoDocumento( nil, "NENTALB", dbfCount )
      cPrinter       := PrnGetName()
      nCopPrn        := nCopiasDocumento( nil, "NENTALB", dbfCount )
   end

   cSayEnt           := cNombreDoc( cFmtEnt )

   oDlg = TDialog():New(,,,,, "IMPSERENT",, .F.,,,,,, .F.,,,,,, .F., )







   oFmtEnt := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cFmtEnt, cFmtEnt:= u ) }, oDlg,,, {||    ( cDocumento( oFmtEnt, oSayEnt, dbfDoc ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oFmtEnt, oSayEnt, "EA" ) )}, nil, "LUPA",, )





   oSayEnt := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, cSayEnt, cSayEnt:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




   oPrinter := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cPrinter, cPrinter:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 111, "Printer_preferences_16",,,,,{|| PrinterPreferences( oPrinter ) }, oDlg, .F., , .F.,  )








   oCopPrn := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nCopPrn, nCopPrn:= u ) }, oDlg,, "999999999", {||    nCopPrn > 0},,,,,, .F.,,, .F., .T.,,, {||      1}, {||      99999},, nil,,, )




   TButton():ReDefine( 500, {||( GenPrnEntregas( lPrint, cFmtEnt, cPrinter, if( lPrint, nCopPrn, 1 ), cAlbCliP, lTicket ), oDlg:End( 1 ) )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 550, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:bStart := {|| if( !lPrint, oCopPrn:Disable(), oCopPrn:Enable() ) }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

return nil






Static Function GenPrnEntregas( lPrint, cFmtEnt, cPrinter, nCopies, cAlbCliP, lTicket )

   local n              := 1
   local oRpt
   local oDevice
   local cCaption       := "Imprimiendo entrega a cuenta"
   local nRecno         := ( cAlbCliP )->( Recno() )

   IIF( lPrint == nil, lPrint := .T., ) ;
   IIF( nCopies == nil, nCopies := 1, ) ;
   IIF( lTicket == nil, lTicket := .F., ) ;

   if Empty( cFmtEnt )
      MsgStop( "Es necesario elegir un formato" )
      return nil
   end

   if !lExisteDocumento( cFmtEnt, dbfDoc )
      return nil
   end

   if lVisualDocumento( cFmtEnt, dbfDoc )

      PrintReportEntAlbCli( if( lPrint, 1, 2 ), nCopies, cPrinter, dbfDoc, cAlbCliP, lTicket )

   else

      private cDbf         := dbfAlbCliT
      private cDbfEnt      := cAlbCliP
      private cCliente     := dbfClient
      private cDbfCli      := dbfClient
      private cFPago       := dbfFPago
      private cDbfPgo      := dbfFPago
      private cDbfAge      := dbfAgent
      private cDbfDiv      := dbfDiv
      private cPorDivEnt   := cPorDiv( ( cAlbCliP )->cDivPgo, dbfDiv )

      while n <= nCopies

         if !Empty( cPrinter )
            oDevice           := TPrinter():New( cCaption, .F., .T., cPrinter )
            oRpt := RptBegin({}, {}, {}, {}, {}, .F.,,,, .F.,, oDevice, cCaption,,, )
         else
            oRpt := RptBegin({}, {}, {}, {}, {}, .F.,,,, .T.,,, cCaption,,, )
         end

         if !Empty( oRpt ) .AND. oRpt:lCreated
            oRpt:lFinish      := .F.
            oRpt:lAutoland    := .T.
            oRpt:lNoCancel    := .T.
            oRpt:bSkip        := {|| .T. }

            if lPrint
               oRpt:bPreview  := {| oDevice | PrintPreview( oDevice ) }
            else
            end
         end

         SetMargin( cFmtEnt, oRpt )
         PrintColum( cFmtEnt, oRpt )

         RptEnd()

         if !Empty( oRpt )

            private nPagina   := oRpt:nPage
            private lEnd      := oRpt:lFinish



            oRpt:Activate(, {||       ( .F. )},,,, {||  ( PrintItems( cFmtEnt, oRpt ) )},,,,,,,, )

            if lPrint
               oRpt:oDevice:end()
            end

         end

         ( cAlbCliP )->( dbGoTo( nRecno ) )

         oRpt              := nil

         n++

      end

   end

Return nil



FUNCTION PrnEntAlb( cNumEnt, lPrint, dbfAlbCliP )

   local nLevel         := nLevelUsr( "01057" )

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if OpenFiles( nil, .T. )

      if dbSeekInOrd( cNumEnt, "nNumAlb", dbfAlbCliP )
         PrnEntregas( lPrint, dbfAlbCliP )
      end

      CloseFiles()

   end

Return .T.













































STATIC FUNCTION DupSerie( oWndBrw )

   local oDlg
   local oSerIni
   local oSerFin
   local oTxtDup
   local nTxtDup     := 0
   local nRecno      := ( dbfAlbCliT )->( Recno() )
   local nOrdAnt     := ( dbfAlbCliT )->( OrdSetFocus( 1 ) )
   local oDesde      := TDesdeHasta():Init( ( dbfAlbCliT )->cSerAlb, ( dbfAlbCliT )->nNumAlb, ( dbfAlbCliT )->cSufAlb, GetSysDate() )
   local lCancel     := .F.
   local oBtnAceptar
   local oBtnCancel
   local oFecDoc
   local cFecDoc     := GetSysDate()




   oDlg = TDialog():New(,,,, "Duplicar series de albaranes", "DUPSERDOC",, .F.,,,,, oWndBrw, .F.,,,,,, .F., )



   TRadMenu():Redefine( { | u | If( PCount()==0, oDesde:nRadio, oDesde:nRadio:= u ) }, oDlg,, { 90, 91 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, oDesde:cSerieInicio, oDesde:cSerieInicio:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieInicio >= "A" .AND. oDesde:cSerieInicio <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, oDesde:cSerieFin, oDesde:cSerieFin:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieFin >= "A" .AND. oDesde:cSerieFin <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, oDesde:nNumeroInicio, oDesde:nNumeroInicio:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, oDesde:nNumeroFin, oDesde:nNumeroFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, oDesde:cSufijoInicio, oDesde:cSufijoInicio:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, oDesde:cSufijoFin, oDesde:cSufijoFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 170, { | u | If( PCount()==0, oDesde:dFechaInicio, oDesde:dFechaInicio:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 180, { | u | If( PCount()==0, oDesde:dFechaFin, oDesde:dFechaFin:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )




   oFecDoc := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, cFecDoc, cFecDoc:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   oBtnAceptar := TButton():ReDefine( 1, {||( DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, cFecDoc ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( lCancel := .T., oDlg:end() )}, oDlg,,, .F.,,,, .T. )





   oTxtDup := TMeter():ReDefine( 160, { | u | If( PCount()==0, nTxtDup, nTxtDup:= u ) }, ( dbfAlbCliT )->( OrdKeyCount() ), oDlg, .F.,,, .T.,,,, )

      oDlg:AddFastKey( 116, {|| DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, cFecDoc ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T., {|Self|( lCancel )},,, oDlg:bRClicked,,, )

   ( dbfAlbCliT )->( dbGoTo( nRecNo ) )
   ( dbfAlbCliT )->( ordSetFocus( nOrdAnt ) )

   oWndBrw:SetFocus()
   oWndBrw:Refresh()

RETURN NIL



STATIC FUNCTION DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, lCancel, cFecDoc )

   local nOrd
   local nDuplicados    := 0
   local nProcesed      := 0

   oBtnAceptar:Hide()
   oBtnCancel:bAction   := {|| lCancel := .T. }

   if oDesde:nRadio == 1

      nOrd              := ( dbfAlbCliT )->( OrdSetFocus( "nNumAlb" ) )

      ( dbfAlbCliT )->( dbSeek( oDesde:cNumeroInicio(), .T. ) )

      while !lCancel .AND. ( dbfAlbCliT )->( !eof() )






         if ( dbfAlbCliT )->cSerAlb >= oDesde:cSerieInicio  .AND. ( dbfAlbCliT )->cSerAlb <= oDesde:cSerieFin     .AND. ( dbfAlbCliT )->nNumAlb >= oDesde:nNumeroInicio .AND. ( dbfAlbCliT )->nNumAlb <= oDesde:nNumeroFin    .AND. ( dbfAlbCliT )->cSufAlb >= oDesde:cSufijoInicio .AND. ( dbfAlbCliT )->cSufAlb <= oDesde:cSufijoFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( dbfAlbCliT )->cSerAlb + "/" + Alltrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + "/" + ( dbfAlbCliT )->cSufAlb

            DupAlbaran( cFecDoc )

         end

         ( dbfAlbCliT )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( dbfAlbCliT )->( OrdSetFocus( nOrd ) )

   else

      nOrd              := ( dbfAlbCliT )->( OrdSetFocus( "dFecAlb" ) )

      ( dbfAlbCliT )->( dbSeek( oDesde:dFechaInicio, .T. ) )

      while !lCancel .AND. ( dbfAlbCliT )->( !eof() )


         if ( dbfAlbCliT )->dFecAlb >= oDesde:dFechaInicio  .AND. ( dbfAlbCliT )->dFecAlb <= oDesde:dFechaFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( dbfAlbCliT )->cSerAlb + "/" + Alltrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + "/" + ( dbfAlbCliT )->cSufAlb

            DupAlbaran( cFecDoc )

         end

         ( dbfAlbCliT )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( dbfAlbCliT )->( OrdSetFocus( nOrd ) )

   end

   lCancel              := .T.

   oBtnAceptar:Show()

   if lCancel
      msgStop( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso cancelado" )
   else
      msgInfo( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso finalizado" )
   end

RETURN ( oDlg:End() )



STATIC FUNCTION AlbRecDup( cDbf, xField1, xField2, xField3, lCab, cFecDoc )

   local nRec           := ( cDbf )->( Recno() )
   local aTabla         := {}
   local nOrdAnt

   IIF( lCab == nil, lCab := .F., ) ;

   aTabla               := DBScatter( cDbf )
   aTabla[ 1 ]   := xField1
   aTabla[ 2 ]   := xField2
   aTabla[ 3 ]   := xField3

   if lCab

      aTabla[ 4     ]  := cCurSesion()
      if !Empty( cFecDoc )
         aTabla[ 5  ]  := cFecDoc
      end
      aTabla[ 8     ]  := oUser():cCaja()
      aTabla[ 17  ]  = .F.
      aTabla[ 18     ]  := Ctod("")
      aTabla[ 30     ]  := Space( 12 )
      aTabla[ 32     ]  := Space( 12 )
      aTabla[ 50     ]  := .T.
      aTabla[ 67     ]  := .F.
      aTabla[ 71     ]  := GetSysDate()
      aTabla[ 68     ]  := cCurUsr()
      aTabla[ 69     ]  := GetSysDate()
      aTabla[ 70     ]  := Time()
      aTabla[ 73  ]  := .F.
      aTabla[ 74     ]  := Ctod("")
      aTabla[ 75     ]  := Space( 5 )
      aTabla[ 76     ]  := oUser():cDelegacion()
      aTabla[ 16  ]  := .F.

      nOrdAnt                 := ( cDbf )->( OrdSetFocus( "NNUMALB" ) )

   end

   if dbDialogLock( cDbf, .T. )
      aEval( aTabla, { | uTmp, n | ( cDbf )->( fieldPut( n, uTmp ) ) } )
      ( cDbf )->( dbUnLock() )
   end

   if lCab
      ( cDbf )->( OrdSetFocus( nOrdAnt ) )
   end

   ( cDbf )->( dbGoTo( nRec ) )

RETURN ( .T. )



STATIC FUNCTION DupAlbaran( cFecDoc )

   local nNewNumAlb  := 0



   nNewNumAlb        := nNewDoc( ( dbfAlbCliT )->cSerAlb, dbfAlbCliT, "NALBCLI", , dbfCount )



   AlbRecDup( dbfAlbCliT, ( dbfAlbCliT )->cSerAlb, nNewNumAlb, ( dbfAlbCliT )->cSufAlb, .T., cFecDoc )



   if ( dbfAlbCliL )->( dbSeek( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb ) )


      while ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb == ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb .AND.  !( dbfAlbCliL )->( Eof() )

         AlbRecDup( dbfAlbCliL, ( dbfAlbCliT )->cSerAlb, nNewNumAlb, ( dbfAlbCliT )->cSufAlb, .F. )

         ( dbfAlbCliL )->( dbSkip() )

      end

   end



   if ( dbfAlbCliD )->( dbSeek( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb ) )


      while ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb == ( dbfAlbCliD )->cSerAlb + Str( ( dbfAlbCliD )->nNumAlb ) + ( dbfAlbCliD )->cSufAlb .AND.  !( dbfAlbCliD )->( Eof() )

         AlbRecDup( dbfAlbCliD, ( dbfAlbCliT )->cSerAlb, nNewNumAlb, ( dbfAlbCliT )->cSufAlb, .F. )

         ( dbfAlbCliD )->( dbSkip() )

      end

   end

RETURN ( .T. )




STATIC FUNCTION SetDialog( aGet, oSayDias, oSayTxtDias, oSayGetRnt, oGetRnt )

   if !Empty( oTipAlb )

      if oTipAlb:nAt == 2
         aGet[ 80  ]:Show()
         aGet[ 81   ]:Show()
         aGet[ 19 ]:Hide()
         oSayDias:Show()
         oSayTxtDias:Show()
      else
         aGet[ 80  ]:Hide()
         aGet[ 81   ]:Hide()
         aGet[ 19 ]:Show()
         oSayDias:Hide()
         oSayTxtDias:Hide()
      end

      aGet[ 81   ]:Refresh()
      aGet[ 80  ]:Refresh()
      aGet[ 19 ]:Refresh()
      oSayDias:Refresh()
      oSayTxtDias:Refresh()

   end

   if !lAccArticulo() .OR. oUser():lNotRentabilidad()

      if !Empty( oSayGetRnt )
         oSayGetRnt:Hide()
      end

      if !Empty( oGetRnt )
         oGetRnt:Hide()
      end

   end

Return .T.



Static Function LoadTrans( aTmp, oGetCod, oGetKgs, oSayTrn )

   local uValor   := oGetCod:VarGet()

   if Empty( uValor )

      oSayTrn:cText( "" )
      oGetKgs:cText( 0 )

   else

      if oTrans:oDbf:SeekInOrd( uValor, "cCodTrn" )
         oGetCod:cText( uValor )
         oSayTrn:cText( oTrans:oDbf:cNomTrn )
         oGetKgs:cText( oTrans:oDbf:nKgsTrn )
      else
         msgStop( "Código de transportista no encontrado." )
         Return .F.
      end

   end

   RecalculaTotal( aTmp )

Return .T.



Function nPesAlbCli( cAlbaran, dbfAlbCliL, lPicture )

   local nOrd           := ( dbfAlbCliL )->( OrdSetFocus( "nNumAlb" ) )
   local nTotPes        := 0

   IIF( lPicture == nil, lPicture := .F., ) ;

   if ( dbfAlbCliL )->( dbSeek( cAlbaran ) )

      while ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb == cAlbaran .AND. ( dbfAlbCliL )->( !eof() )

         if lValLine( dbfAlbCliL )

            nTotPes     += nPesLAlbCli( dbfAlbCliL )

         end

         ( dbfAlbCliL )->( dbSkip() )

      end

   end

   ( dbfAlbCliL )->( OrdSetFocus( nOrd ) )

Return ( if( lPicture, Trans( nTotPes, MasUnd() ), nTotPes ) )



STATIC FUNCTION ValidaMedicion( aTmp, aGet )

   local cNewUndMed  := aGet[ 17 ]:VarGet





   if ( Empty( cOldUndMed ) .OR. cOldUndMed <> cNewUndMed )

      if oUndMedicion:oDbf:Seek( aTmp[ 17 ] )

         if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
            if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:cText( ( dbfArticulo )->nLngArt )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:Show()
            else
               aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]  := ( dbfArticulo )->nLngArt
            end
         else
            if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:Hide()
            else
               aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
            if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:cText( ( dbfArticulo )->nAltArt )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:Show()
            else
               aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]  := ( dbfArticulo )->nAltArt
            end

         else
            if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:Hide()
            else
                 aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
            if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:cText( ( dbfArticulo )->nAncArt )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:Show()
            else
               aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]  := ( dbfArticulo )->nAncArt
            end
         else
            if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:Hide()
            else
               aTmp[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]  := 0
            end
         end

      else

         if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ] )
            aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:Hide()
            aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ] )
            aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:Hide()
            aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ] )
            aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:Hide()
            aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
         end

      end

      cOldUndMed := cNewUndMed

   end

RETURN .T.



Static Function ChangeTarifa( aTmp, aGet, aTmpAlb )

    local nPrePro  := 0

   if !aTmp[ 71 ]

      nPrePro     := nPrePro( aTmp[ 4 ], aTmp[ 28 ], aTmp[ 30 ], aTmp[ 29 ], aTmp[ 31 ], aTmp[ 76 ], aTmpAlb[ 57 ], dbfArtDiv, aTmpAlb[ 28 ] )

      if nPrePro == 0
         nPrePro  := nRetPreArt( aTmp[ 76 ], aTmpAlb[ 51 ], aTmpAlb[ 57 ], dbfArticulo, dbfDiv, dbfKit, dbfIva )
      end

      if nPrePro <> 0
         aGet[ 6 ]:cText( nPrePro )
      end

   else

      aGet[ 6 ]:cText( 0 )
      aGet[ 70  ]:cText( nPreAlq( aTmp[ 4 ], aTmp[ 76 ], aTmpAlb[ 57 ], dbfArticulo ) )

   end

return .T.



static Function cNomUbica( aTmp, aGet, dbfAlm )

   aTmp[77]      := cGetUbica( aTmp[38], dbfAlm, 1 )
   aTmp[78]      := cGetUbica( aTmp[38], dbfAlm, 2 )
   aTmp[79]      := cGetUbica( aTmp[38], dbfAlm, 3 )

   if Empty( aTmp[77] )
      aGet[77]:Hide()
      aGet[80]:Hide()
      aGet[83]:Hide()
   else
      aGet[77]:Show()
      aGet[80]:Show()
      aGet[83]:Show()
   end

   if Empty( aTmp[78] )
      aGet[78]:Hide()
      aGet[81]:Hide()
      aGet[84]:Hide()
   else
      aGet[78]:Show()
      aGet[81]:Show()
      aGet[84]:Show()
   end

   if Empty( aTmp[79] )
      aGet[79]:Hide()
      aGet[82]:Hide()
      aGet[85]:Hide()
   else
      aGet[79]:Show()
      aGet[82]:Show()
      aGet[85]:Show()
   end

   aGet[77]:Refresh()
   aGet[80]:Refresh()
   aGet[83]:Refresh()
   aGet[78]:Refresh()
   aGet[81]:Refresh()
   aGet[85]:Refresh()
   aGet[79]:Refresh()
   aGet[82]:Refresh()
   aGet[85]:Refresh()

return .T.
#line 10131 ".\Prg\Albcli.prg"
Static Function DataReport( oFr )





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "Albaranes", ( dbfAlbCliT )->( Select() ), .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "Albaranes", cItemsToReport( aItmAlbCli() ) )

   oFr:SetWorkArea(     "Lineas de albaranes", ( dbfAlbCliL )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de albaranes", cItemsToReport( aColAlbCli() ) )

   oFr:SetWorkArea(     "Series de lineas de albaranes", ( dbfAlbCliS )->( Select() ) )
   oFr:SetFieldAliases( "Series de lineas de albaranes", cItemsToReport( aSerAlbCli() ) )

   oFr:SetWorkArea(     "Incidencias de albaranes", ( dbfAlbCliI )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de albaranes", cItemsToReport( aIncAlbCli() ) )

   oFr:SetWorkArea(     "Documentos de albaranes", ( dbfAlbCliD )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de albaranes", cItemsToReport( aAlbCliDoc() ) )

   oFr:SetWorkArea(     "Entregas de albaranes", ( dbfAlbCliP )->( Select() ) )
   oFr:SetFieldAliases( "Entregas de albaranes", cItemsToReport( aItmAlbPgo() ) )

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Clientes", ( dbfClient )->( Select() ) )
   oFr:SetFieldAliases( "Clientes", cItemsToReport( aItmCli() ) )

   oFr:SetWorkArea(     "Obras", ( dbfObrasT )->( Select() ) )
   oFr:SetFieldAliases( "Obras",  cItemsToReport( aItmObr() ) )

   oFr:SetWorkArea(     "Almacenes", ( dbfAlm )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Rutas", ( dbfRuta )->( Select() ) )
   oFr:SetFieldAliases( "Rutas", cItemsToReport( aItmRut() ) )

   oFr:SetWorkArea(     "Agentes", ( dbfAgent )->( Select() ) )
   oFr:SetFieldAliases( "Agentes", cItemsToReport( aItmAge() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Transportistas", oTrans:Select() )
   oFr:SetFieldAliases( "Transportistas", cObjectsToReport( oTrans:oDbf ) )

   oFr:SetWorkArea(     "Artículos", ( dbfArticulo )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Tipo de venta", ( dbfTVta )->( Select() ) )
   oFr:SetFieldAliases( "Tipo de venta", cItemsToReport( aItmTVta() ) )

   oFr:SetWorkArea(     "Usuarios", ( dbfUsr )->( Select() ) )
   oFr:SetFieldAliases( "Usuarios", cItemsToReport( aItmUsr() ) )

   oFr:SetWorkArea(     "Ofertas", ( dbfOferta )->( Select() ) )
   oFr:SetFieldAliases( "Ofertas", cItemsToReport( aItmOfe() ) )

   oFr:SetWorkArea(     "Unidades de medición",  oUndMedicion:Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( oUndMedicion:oDbf ) )

   oFr:SetMasterDetail( "Albaranes", "Lineas de albaranes",             {|| ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb } )
   oFr:SetMasterDetail( "Albaranes", "Series de ineas de albaranes",    {|| ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb } )
   oFr:SetMasterDetail( "Albaranes", "Incidencias de albaranes",        {|| ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb } )
   oFr:SetMasterDetail( "Albaranes", "Documentos de albaranes",         {|| ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb } )
   oFr:SetMasterDetail( "Albaranes", "Entregas de albaranes",           {|| ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb } )
   oFr:SetMasterDetail( "Albaranes", "Clientes",                        {|| ( dbfAlbCliT )->cCodCli } )
   oFr:SetMasterDetail( "Albaranes", "Obras",                           {|| ( dbfAlbCliT )->cCodCli + ( dbfAlbCliT )->cCodObr } )
   oFr:SetMasterDetail( "Albaranes", "Almacen",                         {|| ( dbfAlbCliT )->cCodAlm } )
   oFr:SetMasterDetail( "Albaranes", "Rutas",                           {|| ( dbfAlbCliT )->cCodRut } )
   oFr:SetMasterDetail( "Albaranes", "Agentes",                         {|| ( dbfAlbCliT )->cCodAge } )
   oFr:SetMasterDetail( "Albaranes", "Formas de pago",                  {|| ( dbfAlbCliT )->cCodPago} )
   oFr:SetMasterDetail( "Albaranes", "Transportistas",                  {|| ( dbfAlbCliT )->cCodTrn } )
   oFr:SetMasterDetail( "Albaranes", "Empresa",                         {|| cCodigoEmpresaEnUso() } )
   oFr:SetMasterDetail( "Albaranes", "Usuarios",                        {|| ( dbfAlbCliT )->cCodUsr } )

   oFr:SetMasterDetail( "Lineas de albaranes", "Artículos",             {|| ( dbfAlbCliL )->cRef } )
   oFr:SetMasterDetail( "Lineas de albaranes", "Tipo de venta",         {|| ( dbfAlbCliL )->cTipMov } )
   oFr:SetMasterDetail( "Lineas de albaranes", "Ofertas",               {|| ( dbfAlbCliL )->cRef } )
   oFr:SetMasterDetail( "Lineas de albaranes", "Unidades de medición",  {|| ( dbfAlbCliL )->cUnidad } )

   oFr:SetResyncPair(   "Albaranes", "Lineas de albaranes" )
   oFr:SetResyncPair(   "Albaranes", "Series de lineas de albaranes" )
   oFr:SetResyncPair(   "Albaranes", "Incidencias de albaranes" )
   oFr:SetResyncPair(   "Albaranes", "Documentos de albaranes" )
   oFr:SetResyncPair(   "Albaranes", "Entregas de albaranes" )
   oFr:SetResyncPair(   "Albaranes", "Empresa" )
   oFr:SetResyncPair(   "Albaranes", "Clientes" )
   oFr:SetResyncPair(   "Albaranes", "Obras" )
   oFr:SetResyncPair(   "Albaranes", "Almacenes" )
   oFr:SetResyncPair(   "Albaranes", "Rutas" )
   oFr:SetResyncPair(   "Albaranes", "Agentes" )
   oFr:SetResyncPair(   "Albaranes", "Formas de pago" )
   oFr:SetResyncPair(   "Albaranes", "Transportistas" )
   oFr:SetResyncPair(   "Albaranes", "Usuarios" )

   oFr:SetResyncPair(   "Lineas de albaranes", "Artículos" )
   oFr:SetResyncPair(   "Lineas de albaranes", "Tipo de venta" )
   oFr:SetResyncPair(   "Lineas de albaranes", "Ofertas" )
   oFr:SetResyncPair(   "Lineas de albaranes", "Unidades de medición" )

Return nil



Static Function VariableReport( oFr )

   oFr:DeleteCategory(  "Albaranes" )
   oFr:DeleteCategory(  "Lineas de albaranes" )





   oFr:AddVariable(     "Albaranes",             "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Albaranes",             "Total albaran",                       "GetHbVar('nTotAlb')" )
   oFr:AddVariable(     "Albaranes",             "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Albaranes",             "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Albaranes",             "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Albaranes",             "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Albaranes",             "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Albaranes",             "Total descuentos",                    "GetHbVar('nTotalDto')" )
   oFr:AddVariable(     "Albaranes",             "Total neto",                          "GetHbVar('nTotNet')" )
   oFr:AddVariable(     "Albaranes",             "Total primer descuento definible",    "GetHbVar('nTotUno')" )
   oFr:AddVariable(     "Albaranes",             "Total segundo descuento definible",   "GetHbVar('nTotDos')" )
   oFr:AddVariable(     "Albaranes",             "Total " + cImp(),                     "GetHbVar('nTotIva')" )
   oFr:AddVariable(     "Albaranes",             "Total RE",                            "GetHbVar('nTotReq')" )
   oFr:AddVariable(     "Albaranes",             "Total entregado a cuenta",            "GetHbVar('nTotPag')" )
   oFr:AddVariable(     "Albaranes",             "Total retención",                     "GetHbVar('nTotRet')" )
   oFr:AddVariable(     "Albaranes",             "Total peso",                          "GetHbVar('nTotPes')" )
   oFr:AddVariable(     "Albaranes",             "Total costo",                         "GetHbVar('nTotCos')" )
   oFr:AddVariable(     "Albaranes",             "Total artículos",                     "GetHbVar('nTotArt')" )
   oFr:AddVariable(     "Albaranes",             "Total cajas",                         "GetHbVar('nTotCaj')" )
   oFr:AddVariable(     "Albaranes",             "Total punto verde",                   "GetHbVar('nTotPnt')" )
   oFr:AddVariable(     "Albaranes",             "Cuenta por defecto del cliente",      "GetHbVar('cCtaCli')" )

   oFr:AddVariable(     "Albaranes",             "Bruto primer tipo de " + cImp(),     "GetHbArrayVar('aIvaUno',1)" )
   oFr:AddVariable(     "Albaranes",             "Bruto segundo tipo de " + cImp(),    "GetHbArrayVar('aIvaDos',1)" )
   oFr:AddVariable(     "Albaranes",             "Bruto tercer tipo de " + cImp(),     "GetHbArrayVar('aIvaTre',1)" )
   oFr:AddVariable(     "Albaranes",             "Base primer tipo de " + cImp(),      "GetHbArrayVar('aIvaUno',2)" )
   oFr:AddVariable(     "Albaranes",             "Base segundo tipo de " + cImp(),     "GetHbArrayVar('aIvaDos',2)" )
   oFr:AddVariable(     "Albaranes",             "Base tercer tipo de " + cImp(),      "GetHbArrayVar('aIvaTre',2)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje primer tipo " + cImp(),   "GetHbArrayVar('aIvaUno',3)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje segundo tipo " + cImp(),  "GetHbArrayVar('aIvaDos',3)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje tercer tipo " + cImp(),   "GetHbArrayVar('aIvaTre',3)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje primer tipo RE",           "GetHbArrayVar('aIvaUno',4)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje segundo tipo RE",          "GetHbArrayVar('aIvaDos',4)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje tercer tipo RE",           "GetHbArrayVar('aIvaTre',4)" )
   oFr:AddVariable(     "Albaranes",             "Importe primer tipo " + cImp(),      "GetHbArrayVar('aIvaUno',8)" )
   oFr:AddVariable(     "Albaranes",             "Importe segundo tipo " + cImp(),     "GetHbArrayVar('aIvaDos',8)" )
   oFr:AddVariable(     "Albaranes",             "Importe tercer tipo " + cImp(),      "GetHbArrayVar('aIvaTre',8)" )
   oFr:AddVariable(     "Albaranes",             "Importe primer RE",                   "GetHbArrayVar('aIvaUno',9)" )
   oFr:AddVariable(     "Albaranes",             "Importe segundo RE",                  "GetHbArrayVar('aIvaDos',9)" )
   oFr:AddVariable(     "Albaranes",             "Importe tercer RE",                   "GetHbArrayVar('aIvaTre',9)" )

   oFr:AddVariable(     "Albaranes",             "Total unidades primer tipo de impuestos especiales",            "GetHbArrayVar('aIvmUno',1 )" )
   oFr:AddVariable(     "Albaranes",             "Total unidades segundo tipo de impuestos especiales",           "GetHbArrayVar('aIvmDos',1 )" )
   oFr:AddVariable(     "Albaranes",             "Total unidades tercer tipo de impuestos especiales",            "GetHbArrayVar('aIvmTre',1 )" )
   oFr:AddVariable(     "Albaranes",             "Importe del primer tipo de impuestos especiales",               "GetHbArrayVar('aIvmUno',2 )" )
   oFr:AddVariable(     "Albaranes",             "Importe del segundo tipo de impuestos especiales",              "GetHbArrayVar('aIvmDos',2 )" )
   oFr:AddVariable(     "Albaranes",             "Importe del tercer tipo de impuestos especiales",               "GetHbArrayVar('aIvmTre',2 )" )
   oFr:AddVariable(     "Albaranes",             "Total importe primer tipo de impuestos especiales",             "GetHbArrayVar('aIvmUno',3 )" )
   oFr:AddVariable(     "Albaranes",             "Total importe segundo tipo de impuestos especiales",            "GetHbArrayVar('aIvmDos',3 )" )
   oFr:AddVariable(     "Albaranes",             "Total importe tercer tipo de impuestos especiales",             "GetHbArrayVar('aIvmTre',3 )" )

   oFr:AddVariable(     "Albaranes",             "Fecha del primer vencimiento",        "GetHbArrayVar('aDatVto',1)" )
   oFr:AddVariable(     "Albaranes",             "Fecha del segundo vencimiento",       "GetHbArrayVar('aDatVto',2)" )
   oFr:AddVariable(     "Albaranes",             "Fecha del tercer vencimiento",        "GetHbArrayVar('aDatVto',3)" )
   oFr:AddVariable(     "Albaranes",             "Fecha del cuarto vencimiento",        "GetHbArrayVar('aDatVto',4)" )
   oFr:AddVariable(     "Albaranes",             "Fecha del quinto vencimiento",        "GetHbArrayVar('aDatVto',5)" )
   oFr:AddVariable(     "Albaranes",             "Importe del primer vencimiento",      "GetHbArrayVar('aImpVto',1)" )
   oFr:AddVariable(     "Albaranes",             "Importe del segundo vencimiento",     "GetHbArrayVar('aImpVto',2)" )
   oFr:AddVariable(     "Albaranes",             "Importe del tercero vencimiento",     "GetHbArrayVar('aImpVto',3)" )
   oFr:AddVariable(     "Albaranes",             "Importe del cuarto vencimiento",      "GetHbArrayVar('aImpVto',4)" )
   oFr:AddVariable(     "Albaranes",             "Importe del quinto vencimiento",      "GetHbArrayVar('aImpVto',5)" )

   oFr:AddVariable(     "Lineas de albaranes",   "Detalle del artículo",                "CallHbFunc('cDesAlbCli')"  )
   oFr:AddVariable(     "Lineas de albaranes",   "Total unidades artículo",             "CallHbFunc('nTotNAlbCli')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Precio unitario del artículo",        "CallHbFunc('nTotUAlbCli')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Total línea de albaran",              "CallHbFunc('nTotLAlbCli')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Total peso por línea",                "CallHbFunc('nPesLAlbCli')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Total línea sin " + cImp(),          "CallHbFunc('nNetLAlbCli')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Frase publicitaria en línea",         "CallHbFunc('cFraAlbCli')" )


   oFr:AddVariable(     "Lineas de albaranes",   "Fecha en juliano 6 meses",            "CallHbFunc('dJulianoAlbCli')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Fecha en juliano 8 meses",            "CallHbFunc('dJulianoAlbAnio')" )


Return nil



Function DesignReportAlbCli( oFr, dbfDoc )

   local lOpen    := .F.
   local lFlag    := .F.





   if lOpenFiles
      lFlag       := .T.
   else
      if Openfiles()
         lFlag    := .T.
         lOpen    := .T.
      else
         lFlag    := .F.
      end
   end

   if lFlag





      DataReport( oFr )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "   CallHbFunc('nTotAlbCli');"                              + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "CabeceraColumnas",  "MainPage", 6 )
         oFr:SetProperty(     "CabeceraColumnas",  "Top", 200 )
         oFr:SetProperty(     "CabeceraColumnas",  "Height", 0 )
         oFr:SetProperty(     "CabeceraColumnas",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "CabeceraColumnas",  "DataSet", "Albaranes" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de albaranes" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      VariableReport( oFr )





      oFr:DesignReport()





      oFr:DestroyFr()





      if lOpen
         CloseFiles()
      end

   else

      Return .F.

   end

Return .T.



Function PrintReportAlbCli( nDevice, nCopies, cPrinter, dbfDoc )

   local oFr
   local cFilePdf       := cPatTmp() + "AlbaranesCliente" + StrTran( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb, " ", "" ) + ".Pdf"

   IIF( nDevice == nil, nDevice := 2, ) ;
   IIF( nCopies == nil, nCopies := 1, ) ;
   IIF( cPrinter == nil, cPrinter := PrnGetName(), ) ;

   SysRefresh()

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





   DataReport( oFr )





   if !Empty( ( dbfDoc )->mReport )

      oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





      VariableReport( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2

            oFr:ShowPreparedReport()

         case nDevice == 1

            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:Print()

         case nDevice == 3

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatTmp() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .T. )
            oFr:DoExport(     "PDFExport" )

         case nDevice == 6

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatTmp() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .F. )
            oFr:DoExport(     "PDFExport" )

            if file( cFilePdf )

               with object ( TGenMailing():New() )

                  :SetTypeDocument( "nAlbCli" )
                  :SetDe(           uFieldEmpresa( "cNombre" ) )
                  :SetCopia(        uFieldEmpresa( "cCcpMai" ) )
                  :SetAdjunto(      cFilePdf )
                  :SetPara(         RetFld( ( dbfAlbCliT )->cCodCli, dbfClient, "cMeiInt" ) )
                  :SetAsunto(       "Envio de albaran de cliente número " + ( dbfAlbCliT )->cSerAlb + "/" + Alltrim( Str( ( dbfAlbCliT )->nNumAlb ) ) )
                  :SetMensaje(      "Adjunto le remito nuestro albaran de cliente " + ( dbfAlbCliT )->cSerAlb + "/" + Alltrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + Space( 1 ) )
                  :SetMensaje(      "de fecha " + Dtoc( ( dbfAlbCliT )->dFecAlb ) + Space( 1 ) )
                  :SetMensaje(      Chr(13)+Chr(10) )
                  :SetMensaje(      Chr(13)+Chr(10) )
                  :SetMensaje(      "Reciba un cordial saludo." )

                  :GeneralResource( dbfAlbCliT, aItmAlbCli() )

               end

            end

      end

   end





   oFr:DestroyFr()

Return .T.



Static Function DataReportEntAlbCli( oFr, cAlbCliP, lTicket )

   IIF( lTicket == nil, lTicket := .F., ) ;





   oFr:ClearDataSets()

   if !Empty( cAlbCliP )
      oFr:SetWorkArea(  "Entrega", ( cAlbCliP )->( Select() ), .F., { 1, 1, 0 } )
   else
      oFr:SetWorkArea(  "Entrega", ( dbfAlbCliP )->( Select() ), .F., { 1, 1, 0 } )
   end
   oFr:SetFieldAliases( "Entrega", cItemsToReport( aItmAlbPgo() ) )

   if lTicket
   oFr:SetWorkArea(     "Albarán de cliente", ( dbfAlbCliT )->( Select() ) )
   oFr:SetFieldAliases( "Albarán de cliente", cItemsToReport( aItmAlbCli() ) )
   else
   oFr:SetWorkArea(     "Albarán de cliente", ( dbfAlbCliT )->( Select() ), .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "Albarán de cliente", cItemsToReport( aItmAlbCli() ) )
   end

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Clientes", ( dbfClient )->( Select() ) )
   oFr:SetFieldAliases( "Clientes", cItemsToReport( aItmCli() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   if lTicket
      if !Empty( cAlbCliP )
         oFr:SetMasterDetail( "Entrega", "Albarán de cliente",       {|| ( cAlbCliP )->cSerAlb + Str( ( cAlbCliP )->nNumAlb ) + ( cAlbCliP )->cSufAlb } )
      else
         oFr:SetMasterDetail( "Entrega", "Albarán de cliente",       {|| ( dbfAlbCliP )->cSerAlb + Str( ( dbfAlbCliP )->nNumAlb ) + ( dbfAlbCliP )->cSufAlb } )
      end
   end

   if !Empty( cAlbCliP )
   oFr:SetMasterDetail( "Entrega", "Clientes",                 {|| ( cAlbCliP )->cCodCli } )
   oFr:SetMasterDetail( "Entrega", "Formas de pago",           {|| ( cAlbCliP )->cCodPgo } )
   else
   oFr:SetMasterDetail( "Entrega", "Clientes",                 {|| ( dbfAlbCliP )->cCodCli } )
   oFr:SetMasterDetail( "Entrega", "Formas de pago",           {|| ( dbfAlbCliP )->cCodPgo } )
   end

   oFr:SetMasterDetail( "Entrega", "Empresa",                  {|| cCodigoEmpresaEnUso() } )

   oFr:SetResyncPair(   "Entrega", "Empresa" )
   oFr:SetResyncPair(   "Entrega", "Clientes" )
   oFr:SetResyncPair(   "Entrega", "Formas de pago" )

Return nil



Static Function VariableReportEntAlbCli( oFr )





   oFr:AddVariable( "Albarán de cliente",    "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable( "Albarán de cliente",    "Total albaran",                       "GetHbVar('nTotAlb')" )
   oFr:AddVariable( "Albarán de cliente",    "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable( "Albarán de cliente",    "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable( "Albarán de cliente",    "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable( "Albarán de cliente",    "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable( "Albarán de cliente",    "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable( "Albarán de cliente",    "Total neto",                          "GetHbVar('nTotNet')" )
   oFr:AddVariable( "Albarán de cliente",    "Total primer descuento definible",    "GetHbVar('nTotUno')" )
   oFr:AddVariable( "Albarán de cliente",    "Total segundo descuento definible",   "GetHbVar('nTotDos')" )
   oFr:AddVariable( "Albarán de cliente",    "Total " + cImp(),                     "GetHbVar('nTotIva')" )
   oFr:AddVariable( "Albarán de cliente",    "Total RE",                            "GetHbVar('nTotReq')" )
   oFr:AddVariable( "Albarán de cliente",    "Total entregado a cuenta",            "GetHbVar('nTotPag')" )
   oFr:AddVariable( "Albarán de cliente",    "Total retención",                     "GetHbVar('nTotRet')" )
   oFr:AddVariable( "Albarán de cliente",    "Total peso",                          "GetHbVar('nTotPes')" )
   oFr:AddVariable( "Albarán de cliente",    "Total costo",                         "GetHbVar('nTotCos')" )
   oFr:AddVariable( "Albarán de cliente",    "Total anticipado",                    "GetHbVar('nTotAnt')" )
   oFr:AddVariable( "Albarán de cliente",    "Total artículos",                     "GetHbVar('nTotArt')" )
   oFr:AddVariable( "Albarán de cliente",    "Total cajas",                         "GetHbVar('nTotCaj')" )
   oFr:AddVariable( "Albarán de cliente",    "Bruto primer tipo de " + cImp(),      "GetHbArrayVar('aIvaUno',1)" )
   oFr:AddVariable( "Albarán de cliente",    "Bruto segundo tipo de " + cImp(),     "GetHbArrayVar('aIvaDos',1)" )
   oFr:AddVariable( "Albarán de cliente",    "Bruto tercer tipo de " + cImp(),      "GetHbArrayVar('aIvaTre',1)" )
   oFr:AddVariable( "Albarán de cliente",    "Base primer tipo de " + cImp(),       "GetHbArrayVar('aIvaUno',2)" )
   oFr:AddVariable( "Albarán de cliente",    "Base segundo tipo de " + cImp(),      "GetHbArrayVar('aIvaDos',2)" )
   oFr:AddVariable( "Albarán de cliente",    "Base tercer tipo de " + cImp(),       "GetHbArrayVar('aIvaTre',2)" )
   oFr:AddVariable( "Albarán de cliente",    "Porcentaje primer tipo " + cImp(),    "GetHbArrayVar('aIvaUno',3)" )
   oFr:AddVariable( "Albarán de cliente",    "Porcentaje segundo tipo " + cImp(),   "GetHbArrayVar('aIvaDos',3)" )
   oFr:AddVariable( "Albarán de cliente",    "Porcentaje tercer tipo " + cImp(),    "GetHbArrayVar('aIvaTre',3)" )
   oFr:AddVariable( "Albarán de cliente",    "Porcentaje primer tipo RE",           "GetHbArrayVar('aIvaUno',4)" )
   oFr:AddVariable( "Albarán de cliente",    "Porcentaje segundo tipo RE",          "GetHbArrayVar('aIvaDos',4)" )
   oFr:AddVariable( "Albarán de cliente",    "Porcentaje tercer tipo RE",           "GetHbArrayVar('aIvaTre',4)" )
   oFr:AddVariable( "Albarán de cliente",    "Importe primer tipo " + cImp(),       "GetHbArrayVar('aIvaUno',8)" )
   oFr:AddVariable( "Albarán de cliente",    "Importe segundo tipo " + cImp(),      "GetHbArrayVar('aIvaDos',8)" )
   oFr:AddVariable( "Albarán de cliente",    "Importe tercer tipo " + cImp(),       "GetHbArrayVar('aIvaTre',8)" )
   oFr:AddVariable( "Albarán de cliente",    "Importe primer RE",                   "GetHbArrayVar('aIvaUno',9)" )
   oFr:AddVariable( "Albarán de cliente",    "Importe segundo RE",                  "GetHbArrayVar('aIvaDos',9)" )
   oFr:AddVariable( "Albarán de cliente",    "Importe tercer RE",                   "GetHbArrayVar('aIvaTre',9)" )
   oFr:AddVariable( "Albarán de cliente",    "Fecha del primer vencimiento",        "GetHbArrayVar('aDatVto',1)" )
   oFr:AddVariable( "Albarán de cliente",    "Fecha del segundo vencimiento",       "GetHbArrayVar('aDatVto',2)" )
   oFr:AddVariable( "Albarán de cliente",    "Fecha del tercer vencimiento",        "GetHbArrayVar('aDatVto',3)" )
   oFr:AddVariable( "Albarán de cliente",    "Fecha del cuarto vencimiento",        "GetHbArrayVar('aDatVto',4)" )
   oFr:AddVariable( "Albarán de cliente",    "Fecha del quinto vencimiento",        "GetHbArrayVar('aDatVto',5)" )
   oFr:AddVariable( "Albarán de cliente",    "Importe del primer vencimiento",      "GetHbArrayVar('aImpVto',1)" )
   oFr:AddVariable( "Albarán de cliente",    "Importe del segundo vencimiento",     "GetHbArrayVar('aImpVto',2)" )
   oFr:AddVariable( "Albarán de cliente",    "Importe del tercero vencimiento",     "GetHbArrayVar('aImpVto',3)" )
   oFr:AddVariable( "Albarán de cliente",    "Importe del cuarto vencimiento",      "GetHbArrayVar('aImpVto',4)" )
   oFr:AddVariable( "Albarán de cliente",    "Importe del quinto vencimiento",      "GetHbArrayVar('aImpVto',5)" )

Return nil



Function DesignReportEntAlbCli( oFr, dbfDoc )

   if OpenFiles()





      DataReportEntAlbCli( oFr )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "CallHbFunc('nTotAlbCli');"                                 + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:SetProperty(     "MainPage",          "OnBeforePrint", "DetalleOnMasterDetail" )

         oFr:AddBand(         "CuerpoDocumento",   "MainPage", 2 )
         oFr:SetProperty(     "CuerpoDocumento",   "Top", 0 )
         oFr:SetProperty(     "CuerpoDocumento",   "Height", 300 )

         oFr:AddBand(         "CabeceraColumnas",  "MainPage", 6 )
         oFr:SetProperty(     "CabeceraColumnas",  "Top", 300 )
         oFr:SetProperty(     "CabeceraColumnas",  "Height", 0 )
         oFr:SetProperty(     "CabeceraColumnas",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "CabeceraColumnas",  "DataSet", "Entrega" )

      end





      VariableReportEntAlbCli( oFr )





      oFr:DesignReport()





      oFr:DestroyFr()





      CloseFiles()

   else

      Return .F.

   end

Return .T.



Function PrintReportEntAlbCli( nDevice, nCopies, cPrinter, dbfDoc, cAlbCliP, lTicket )

   local oFr
   local nRecAlbCliT    := ( dbfAlbCliT )->( Recno() )

   IIF( nDevice == nil, nDevice := 2, ) ;
   IIF( nCopies == nil, nCopies := 1, ) ;
   IIF( cPrinter == nil, cPrinter := PrnGetName(), ) ;
   IIF( lTicket == nil, lTicket := .F., ) ;

   SysRefresh()

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





   DataReportEntAlbCli( oFr, cAlbCliP, lTicket )





   if !Empty( ( dbfDoc )->mReport )

      oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





      VariableReportEntAlbCli( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2
            oFr:ShowPreparedReport()

         case nDevice == 1
            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:Print()

         case nDevice == 3
            oFr:DoExport( "PDFExport" )

      end

   end





   oFr:DestroyFr()

   ( dbfAlbCliT )->( dbGoTo( nRecAlbCliT ) )

Return .T.



FUNCTION PrnEntAlbCli( cNumDoc, lPrint, dbfTmpEnt )

   local nLevel         := nLevelUsr( "01057" )

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if OpenFiles( nil, .T. )

      if ( dbfTmpEnt )->( Used() )
         ( dbfTmpEnt )->( dbSetFilter( {|| Field->cSerAlb + Str( Field->nNumAlb ) + Field->cSufAlb + Str( Field->nNumRec ) == cNumDoc }, "cSerAlb + Str( nNumAlb ) + cSufAlb + Str( nNumRec ) == cNumDoc" ) )
         ( dbfTmpEnt )->( dbGoTop() )
      end

      PrnEntregas( lPrint, dbfTmpEnt, .T. )

      ( dbfTmpEnt )->( DbClearFilter() )

      CloseFiles()

   end

Return .T.














































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































_HB_CLASS pdaAlbCliSenderReciver ; UTILITY FUNCTION pdaAlbCliSenderReciver(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "pdaAlbCliSenderReciver" , { HBObject():Classh } ) ) ;

   _HB_MEMBER CreateData(); IIF( .F., s_oClass:ModMethod( "CreateData", @pdaAlbCliSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CreateData", @pdaAlbCliSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS pdaAlbCliSenderReciver ;



UTILITY STATIC function pdaAlbCliSenderReciver_CreateData( oPgrActual, oSayStatus, cPatPreVenta) ; local Self AS CLASS pdaAlbCliSenderReciver := QSelf() AS CLASS pdaAlbCliSenderReciver

   local pdaAlbCliT
   local pdaAlbCliL
   local pdaAlbCliI
   local pdaAlbCliP
   local pdaAlbCliD
   local dbfAlbCliT
   local dbfAlbCliL
   local dbfAlbCliI
   local dbfAlbCliP
   local dbfAlbCliD
   local lExist         := .F.
   local cFileName
   local cNumAlbCliT
   local cPatPc      := if( Empty( cPatPreVenta ), cPatPc(), cPatPreVenta )



   dbUseArea( .T., ( cDriver() ), ( cPatPc + "AlbCliT.DBF" ), ( cCheckArea( "AlbCliT", @dbfAlbCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatPc + "AlbCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
   ( dbfAlbCliT )->( OrdSetFocus( "lSndDoc" ) )

   dbUseArea( .T., ( cDriver() ), ( cPatPc + "AlbCliL.DBF" ), ( cCheckArea( "AlbCliL", @dbfAlbCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatPc + "AlbCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatPc + "AlbCliI.DBF" ), ( cCheckArea( "AlbCliI", @dbfAlbCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatPc + "AlbCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatPc + "AlbCliP.DBF" ), ( cCheckArea( "AlbCliP", @dbfAlbCliP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatPc + "AlbCliP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatPc + "AlbCliD.Dbf" ), ( cCheckArea( "AlbCliD", @dbfAlbCliD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatPc + "AlbCliD.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., cDriver(), cPatEmp() + "AlbCliT.Dbf", cCheckArea( "AlbCliT", @pdaAlbCliT ), .T. )
   ( pdaAlbCliT )->( ordListAdd( cPatEmp() + "AlbCliT.Cdx" ) )

   dbUseArea( .T., cDriver(), cPatEmp() + "AlbCliL.Dbf", cCheckArea( "AlbCliL", @pdaAlbCliL ), .T. )
   ( pdaAlbCliL )->( ordListAdd( cPatEmp() + "AlbCliL.Cdx" ) )

   dbUseArea( .T., cDriver(), cPatEmp() + "AlbCliI.Dbf", cCheckArea( "AlbCliI", @pdaAlbCliI ), .T. )
   ( pdaAlbCliI )->( ordListAdd( cPatEmp() + "AlbCliI.Cdx" ) )

   dbUseArea( .T., cDriver(), cPatEmp() + "AlbCliP.Dbf", cCheckArea( "AlbCliP", @pdaAlbCliP ), .T. )
   ( pdaAlbCliP )->( ordListAdd( cPatEmp() + "AlbCliP.Cdx" ) )

   dbUseArea( .T., cDriver(), cPatEmp() + "AlbCliD.Dbf", cCheckArea( "AlbCliD", @pdaAlbCliD ), .T. )
   ( pdaAlbCliD )->( ordListAdd( cPatEmp() + "AlbCliD.Cdx" ) )

   if !Empty( oPgrActual )
      oPgrActual:SetRange( 0, ( pdaAlbCliT )->( OrdKeyCount() ) )
   end

   ( pdaAlbCliT )->( dbGoTop() )
   while !( pdaAlbCliT )->( eof() )

      if ( pdaAlbCliT )->lSndDoc

         cNumAlbCliT    := ( pdaAlbCliT )->cSeralb + Str( ( pdaAlbCliT )->nNumalb ) + ( pdaAlbCliT )->cSufalb

         if !( dbfAlbCliT )->( dbSeek( cNumAlbCliT ) )

            dbPass( pdaAlbCliT, dbfAlbCliT, .T. )





            if ( pdaAlbCliL )->( dbSeek( cNumAlbCliT ) )
               while ( pdaAlbCliL )->cSeralb + Str( ( pdaAlbCliL )->nNumalb ) + ( pdaAlbCliL )->cSufalb == cNumAlbCliT .AND. !( pdaAlbCliL )->( eof() )
                  dbPass( pdaAlbCliL, dbfAlbCliL, .T. )
                  ( pdaAlbCliL )->( dbSkip() )
               end
            end





            if ( pdaAlbCliI )->( dbSeek( cNumAlbCliT ) )
               while ( pdaAlbCliI )->cSeralb + Str( ( pdaAlbCliI )->nNumalb ) + ( pdaAlbCliI )->cSufalb == cNumAlbCliT .AND. !( pdaAlbCliI )->( eof() )
                  dbPass( pdaAlbCliI, dbfAlbCliI, .T. )
                  ( pdaAlbCliI )->( dbSkip() )
               end
            end





            if ( pdaAlbCliP )->( dbSeek( cNumAlbCliT ) )
               while ( pdaAlbCliP )->cSeralb + Str( ( pdaAlbCliP )->nNumalb ) + ( pdaAlbCliP )->cSufalb == cNumAlbCliT .AND. !( pdaAlbCliP )->( eof() )
                  dbPass( pdaAlbCliP, dbfAlbCliP, .T. )
                  ( pdaAlbCliP )->( dbSkip() )
               end
            end





            if ( pdaAlbCliD )->( dbSeek( cNumAlbCliT ) )
               while ( pdaAlbCliD )->cSeralb + Str( ( pdaAlbCliD )->nNumalb ) + ( pdaAlbCliD )->cSufalb == cNumAlbCliT .AND. !( pdaAlbCliD )->( eof() )
                  dbPass( pdaAlbCliD, dbfAlbCliD, .T. )
                  ( pdaAlbCliD )->( dbSkip() )
               end
            end

             if dbLock( pdaAlbCliT )
               ( pdaAlbCliT )->lSndDoc  := .F.
               ( pdaAlbCliT )->( dbUnLock() )
            end

         end

      end

      ( pdaAlbCliT )->( dbSkip() )

      if !Empty( oSayStatus )
         oSayStatus:SetText( "Sincronizando albaranes " + Alltrim( Str( ( pdaAlbCliT )->( OrdKeyNo() ) ) ) + " de " + Alltrim( Str( ( pdaAlbCliT )->( OrdKeyCount() ) ) ) )
      end

      SysRefresh()

      if !Empty( oPgrActual )
         oPgrActual:SetPos( ( pdaAlbCliT )->( OrdKeyNo() ) )
      end

      SysRefresh()

   end

   ( pdaAlbCliT )->( dbCloseArea() )
   ( pdaAlbCliL )->( dbCloseArea() )
   ( pdaAlbCliI )->( dbCloseArea() )
   ( pdaAlbCliP )->( dbCloseArea() )
   ( pdaAlbCliD )->( dbCloseArea() )
   ( dbfAlbCliT )->( dbCloseArea() )
   ( dbfAlbCliL )->( dbCloseArea() )
   ( dbfAlbCliI )->( dbCloseArea() )
   ( dbfAlbCliP )->( dbCloseArea() )
   ( dbfAlbCliD )->( dbCloseArea() )

Return ( Self )











function nUnidadesRecibidasAlbCli( cNumPed, cCodArt, cCodPr1, cCodPr2, cRefPrv, cDetalle, dbfAlbCliL )

   local nTot        := 0
   local aStaLin     := aGetStatus( dbfAlbCliL, .F. )

   IIF( cCodPr1 == nil, cCodPr1 := Space( 10 ), ) ;
   IIF( cCodPr2 == nil, cCodPr2 := Space( 10 ), ) ;
   IIF( cRefPrv == nil, cRefPrv := Space( 18 ), ) ;
   IIF( cDetalle == nil, cDetalle := Space( 250 ), ) ;

   if ( IsMuebles() )

      ( dbfAlbCliL )->( OrdSetFocus( "cNumPedDet" ) )

      if ( dbfAlbCliL )->( dbSeek( cNumPed + cCodArt + cCodPr1 + cCodPr2 + cRefPrv + cDetalle ) )
         while ( dbfAlbCliL )->cNumPed + ( dbfAlbCliL )->cRef + ( dbfAlbCliL )->cCodPr1 + ( dbfAlbCliL )->cCodPr2 + ( dbfAlbCliL )->cRefPrv + ( dbfAlbCliL )->cDetalle == cNumPed + cCodArt + cCodPr1 + cCodPr2 + cRefPrv + cDetalle .AND. !( dbfAlbCliL )->( eof() )
            nTot     += nTotNAlbCli( dbfAlbCliL )
            ( dbfAlbCliL )->( dbSkip() )
         end
      end

   else

      ( dbfAlbCliL )->( OrdSetFocus( "cNumPedRef" ) )

      if ( dbfAlbCliL )->( dbSeek( cNumPed + cCodArt + cCodPr1 + cCodPr2 ) )
         while ( dbfAlbCliL )->cNumPed + ( dbfAlbCliL )->cRef + ( dbfAlbCliL )->cCodPr1 + ( dbfAlbCliL )->cCodPr2 == cNumPed + cCodArt + cCodPr1 + cCodPr2 .AND. !( dbfAlbCliL )->( eof() )
            nTot     += nTotNAlbCli( dbfAlbCliL )
            ( dbfAlbCliL )->( dbSkip() )
         end
      end

   end

   SetStatus( dbfAlbCliL, aStaLin )

return ( nTot )



function nTotNAlbCli( uDbf )

   local nTotUnd

   IIF( uDbf == nil, uDbf := dbfAlbCliL, ) ;

   do case
      case ValType( uDbf ) == "A"

         if uDbf[ 71 ]

            nTotUnd  := NotCaja( uDbf[ 12 ] )
            nTotUnd  *= uDbf[ 19 ]
            nTotUnd  *= NotCero( uDbf[ 20 ] )
            nTotUnd  *= NotCero( uDbf[ 68 ] - uDbf[ 69 ] )
            nTotUnd  *= NotCero( uDbf[ 73 ] )
            nTotUnd  *= NotCero( uDbf[ 74 ] )
            nTotUnd  *= NotCero( uDbf[ 75 ] )


         else

            nTotUnd  := NotCaja( uDbf[ 12 ] )
            nTotUnd  *= uDbf[ 19 ]
            nTotUnd  *= NotCero( uDbf[ 20 ] )
            nTotUnd  *= NotCero( uDbf[ 73 ] )
            nTotUnd  *= NotCero( uDbf[ 74 ] )
            nTotUnd  *= NotCero( uDbf[ 75 ] )


         end

      case ValType( uDbf ) == "C"

         if ( uDbf )->lAlquiler

            nTotUnd  := NotCaja( ( uDbf )->nCanEnt )
            nTotUnd  *= ( uDbf )->nUniCaja
            nTotUnd  *= NotCero( ( uDbf )->nUndKit )
            nTotUnd  *= NotCero( ( uDbf )->dFecEnt - ( uDbf )->dFecSal )
            nTotUnd  *= NotCero( ( uDbf )->nMedUno )
            nTotUnd  *= NotCero( ( uDbf )->nMedDos )
            nTotUnd  *= NotCero( ( uDbf )->nMedTre )

         else

            nTotUnd  := NotCaja( ( uDbf )->nCanEnt )
            nTotUnd  *= ( uDbf )->nUniCaja
            nTotUnd  *= NotCero( ( uDbf )->nUndKit )
            nTotUnd  *= NotCero( ( uDbf )->nMedUno )
            nTotUnd  *= NotCero( ( uDbf )->nMedDos )
            nTotUnd  *= NotCero( ( uDbf )->nMedTre )

         end


      otherwise

         if uDbf:lAlquiler

            nTotUnd  := NotCaja( uDbf:nCanEnt )
            nTotUnd  *= uDbf:nUniCaja
            nTotUnd  *= NotCero( uDbf:nUndKit )
            nTotUnd  *= NotCero( uDbf:dFecEnt - uDbf:dFecSal )
            nTotUnd  *= NotCero( uDbf:nMedUno )
            nTotUnd  *= NotCero( uDbf:nMedDos )
            nTotUnd  *= NotCero( uDbf:nMedTre )


         else

            nTotUnd  := NotCaja( uDbf:nCanEnt )
            NtotUnd  *= uDbf:nUniCaja
            nTotUnd  *= NotCero( uDbf:nUndKit )
            nTotUnd  *= NotCero( uDbf:nMedUno )
            nTotUnd  *= NotCero( uDbf:nMedDos )
            nTotUnd  *= NotCero( uDbf:nMedTre )

         end

   end

return ( nTotUnd )



function nTotVAlbCli( uDbf )

   local nTotUnd

   IIF( uDbf == nil, uDbf := dbfAlbCliL, ) ;

   do case
      case ValType( uDbf ) == "A"

         nTotUnd  := nTotNAlbCli( uDbf ) * NotCero( uDbf[ 32 ] )

      case ValType( uDbf ) == "C"

         nTotUnd  := nTotNAlbCli( uDbf ) * NotCero( ( uDbf )->nFacCnv )

      otherwise

         nTotUnd  := nTotNAlbCli( uDbf ) * NotCero( uDbf:nFacCnv )

   end

return ( nTotUnd )



FUNCTION nTotLAlbCli( cAlbCliL, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

    local nCalculo

   IIF( cAlbCliL == nil, cAlbCliL := dbfAlbCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nRou == nil, nRou := nRouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lDto == nil, lDto := .T., ) ;
   IIF( lPntVer == nil, lPntVer := .T., ) ;
   IIF( lImpTrn == nil, lImpTrn := .T., ) ;

   if ( cAlbCliL )->lTotLin

      nCalculo       := nTotUAlbCli( cAlbCliL, nDec, nVdv )

   else





      nCalculo       := nTotUAlbCli( cAlbCliL, nDec, nVdv )
      nCalculo       -= Round( ( cAlbCliL )->nDtoDiv , nDec )





      if lDto

         if ( cAlbCliL )->nDto <> 0
            nCalculo -= nCalculo * ( cAlbCliL )->nDto / 100
         end

         if ( cAlbCliL )->nDtoPrm <> 0
            nCalculo -= nCalculo * ( cAlbCliL )->nDtoPrm / 100
         end

      end





      nCalculo       *= nTotNAlbCli( cAlbCliL )





      if lPntVer
         nCalculo    += nPntLAlbCli( cAlbCliL, nDec, nVdv )
      end


      if nRou <> nil
         nCalculo    := Round( nCalculo, nRou )
      end





      if lImpTrn .AND. ( cAlbCliL )->nImpTrn <> 0
         nCalculo    += ( cAlbCliL )->nImpTrn * nTotNAlbCli( cAlbCliL )
      end

   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )







FUNCTION nPntLAlbCli( dbfLin, nDec, nVdv )

   local nPntVer

   IIF( dbfLin == nil, dbfLin := dbfAlbCliL, ) ;
   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;





   nPntVer           := ( dbfLin )->nPntVer * nTotNAlbCli( dbfLin )

RETURN ( Round( nPntVer, nDec ) )







FUNCTION nTotUAlbCli( uTmpLin, nDec, nVdv )

   local nCalculo    := 0

   IIF( uTmpLin == nil, uTmpLin := dbfAlbCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   do case
      case IsChar( uTmpLin )

         if ( uTmpLin )->lAlquiler
            nCalculo    := ( uTmpLin )->nPreAlq
         else
            nCalculo    := ( uTmpLin )->nPreUnit
         end

      case IsObject( uTmpLin )

         if uTmpLin:lAlquiler
            nCalculo    := uTmpLin:nPreAlq
         else
            nCalculo    := uTmpLin:nPreUnit
         end

      case IsArray( uTmpLin )

         if uTmpLin[ 71 ]
            nCalculo    := uTmpLin[ 70 ]
         else
            nCalculo    := uTmpLin[ 6 ]
         end

   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )






Function nPntUAlbCli( dbfTmpLin, nDec, nVdv )

   local nCalculo := ( dbfTmpLin )->nPntVer

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

    IF nVdv <> 0
      nCalculo    := ( dbfTmpLin )->nPntVer / nVdv
    end

Return ( Round( nCalculo, nDec ) )



FUNCTION IsAlbCli( cPath )

   IIF( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "AlbCliT.Dbf" )
      dbCreate( cPath + "AlbCliT.Dbf", aSqlStruct( aItmAlbCli() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbCliL.Dbf" )
      dbCreate( cPath + "AlbCliL.Dbf", aSqlStruct( aColAlbCli() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbCliP.Dbf" )
      dbCreate( cPath + "AlbCliP.Dbf", aSqlStruct( aItmAlbPgo() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbCliI.Dbf" )
      dbCreate( cPath + "AlbCliI.Dbf", aSqlStruct( aIncAlbCli() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbCliD.Dbf" )
      dbCreate( cPath + "AlbCliD.Dbf", aSqlStruct( aAlbCliDoc() ), cDriver() )
   end





   if !lExistIndex( cPath + "AlbCliT.Cdx" ) .OR.  !lExistIndex( cPath + "AlbCliL.Cdx" ) .OR.  !lExistIndex( cPath + "AlbCliP.Cdx" ) .OR.  !lExistIndex( cPath + "AlbCliI.Cdx" ) .OR.  !lExistTable( cPath + "AlbCliD.Cdx" )

      rxAlbCli( cPath )

   end

Return ( .T. )



FUNCTION mkAlbCli( cPath, lAppend, cPathOld, oMeter, bFor )

   local oBlock
   local oError
    local dbfAlbCliT
   local dbfAlbCliL
   local dbfAlbCliI
   local dbfAlbCliD
   local dbfAlbCliP
   local oldAlbCliT
   local oldAlbCliL
   local oldAlbCliI
   local oldAlbCliD
   local oldAlbCliP

   IIF( bFor == nil, bFor := {|| .T. }, ) ;

   if oMeter <> nil
        oMeter:cText    := "Generando Bases"
        sysrefresh()
   end

   CreateFiles( cPath )

   rxAlbCli( cPath, oMeter )

   if lAppend .AND. lIsDir( cPathOld )

      oBlock         := ErrorBlock( { | oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

      dbUseArea( .T., cDriver(), cPath + "ALBCLIT.DBF", cCheckArea( "ALBCLIT", @dbfAlbCliT ), .F. )
      ( dbfAlbCliT )->( ordListAdd( cPath + "ALBCLIT.CDX" ) )

      dbUseArea( .T., cDriver(), cPath + "ALBCLIL.DBF", cCheckArea( "ALBCLIL", @dbfAlbCliL ), .F. )
      ( dbfAlbCliL )->( ordListAdd( cPath + "ALBCLIL.CDX" ) )

      dbUseArea( .T., cDriver(), cPath + "AlbCliI.Dbf", cCheckArea( "AlbCliI", @dbfAlbCliI ), .F. )
      ( dbfAlbCliI )->( ordListAdd( cPath + "AlbCliI.Cdx"  ) )

      dbUseArea( .T., cDriver(), cPath + "AlbCliD.Dbf", cCheckArea( "AlbCliD", @dbfAlbCliD ), .F. )
      ( dbfAlbCliD )->( ordListAdd( cPath + "AlbCliD.Cdx"  ) )

      dbUseArea( .T., cDriver(), cPath + "AlbCliP.Dbf", cCheckArea( "AlbCliP", @dbfAlbCliP ), .F. )
      ( dbfAlbCliP )->( ordListAdd( cPath + "AlbCliP.Cdx"  ) )

      dbUseArea( .T., cDriver(), cPathOld + "AlbCLIT.DBF", cCheckArea( "AlbCLIT", @oldAlbCliT ), .F. )
      ( oldAlbCliT )->( ordListAdd( cPathOld + "AlbCLIT.CDX"  ) )

      dbUseArea( .T., cDriver(), cPathOld + "AlbCLIL.DBF", cCheckArea( "AlbCLIL", @oldAlbCliL ), .F. )
      ( oldAlbCliL )->( ordListAdd( cPathOld + "AlbCLIL.CDX"  ) )

      dbUseArea( .T., cDriver(), cPathOld + "AlbCliI.Dbf", cCheckArea( "AlbCliI", @oldAlbCliI ), .F. )
      ( oldAlbCliI )->( ordListAdd( cPathOld + "AlbCliI.Cdx"  ) )

      dbUseArea( .T., cDriver(), cPathOld + "AlbCliD.Dbf", cCheckArea( "AlbCliD", @oldAlbCliD ), .F. )
      ( oldAlbCliD )->( ordListAdd( cPathOld + "AlbCliD.Cdx"  ) )

      dbUseArea( .T., cDriver(), cPathOld + "AlbCliP.Dbf", cCheckArea( "AlbCliP", @oldAlbCliP ), .F. )
      ( oldAlbCliP )->( ordListAdd( cPathOld + "AlbCliP.Cdx"  ) )

      while !( oldAlbCliT )->( eof() )

         if eval( bFor, oldAlbCliT )
            dbCopy( oldAlbCliT, dbfAlbCliT, .T. )

            if ( oldAlbCliL )->( dbSeek( (oldAlbCliT)->CSERALB + Str( (oldAlbCliT)->NNUMALB ) + (oldAlbCliT)->CSUFALB ) )
               while ( oldAlbCliL )->CSERALB + Str( ( oldAlbCliL )->NNUMALB ) + ( oldAlbCliL )->CSUFALB == (oldAlbCliT)->CSERALB + Str( (dbfAlbCliT)->NNUMALB ) + (dbfAlbCliT)->CSUFALB .AND. !(oldAlbCliL)->( eof() )
                  dbCopy( oldAlbCliL, dbfAlbCliL, .T. )
                  ( oldAlbCliL )->( dbSkip() )
               end
            end

            if ( oldAlbCliI )->( dbSeek( (oldAlbCliT)->CSERALB + Str( (oldAlbCliT)->NNUMALB ) + (oldAlbCliT)->CSUFALB ) )
               while ( oldAlbCliI )->CSERALB + Str( ( oldAlbCliI )->NNUMALB ) + ( oldAlbCliI )->CSUFALB == ( oldAlbCliT )->CSERALB + Str( ( dbfAlbCliT )->NNUMALB ) + ( dbfAlbCliT )->CSUFALB .AND. !( oldAlbCliI )->( eof() )
                  dbCopy( oldAlbCliI, dbfAlbCliI, .T. )
                  ( oldAlbCliI )->( dbSkip() )
               end
            end

            if ( oldAlbCliD )->( dbSeek( (oldAlbCliT)->CSERALB + Str( (oldAlbCliT)->NNUMALB ) + (oldAlbCliT)->CSUFALB ) )
               while ( oldAlbCliD )->CSERALB + Str( ( oldAlbCliD )->NNUMALB ) + ( oldAlbCliD )->CSUFALB == ( oldAlbCliT )->CSERALB + Str( ( dbfAlbCliT )->NNUMALB ) + ( dbfAlbCliT )->CSUFALB .AND. !( oldAlbCliI )->( eof() )
                  dbCopy( oldAlbCliD, dbfAlbCliD, .T. )
                  ( oldAlbCliD )->( dbSkip() )
               end
            end

            if ( oldAlbCliP )->( dbSeek( ( oldAlbCliT )->CSERALB + Str( ( oldAlbCliT )->NNUMALB ) + ( oldAlbCliT )->CSUFALB ) )
               while ( oldAlbCliP )->CSERALB + Str( ( oldAlbCliP )->NNUMALB ) + ( oldAlbCliP )->CSUFALB == ( oldAlbCliT )->CSERALB + Str( ( dbfAlbCliT )->NNUMALB ) + ( dbfAlbCliT )->CSUFALB .AND. !( oldAlbCliI )->( eof() )
                  dbCopy( oldAlbCliP, dbfAlbCliP, .T. )
                  ( oldAlbCliP )->( dbSkip() )
               end
            end

         end

         ( oldAlbCliT )->( dbSkip() )

      end





      ( dbfAlbCliT )->( dbEval( {|| ( dbfAlbCliT )->cTurAlb := Space( 6 ) },,,,, .F. ) )


      ( dbfAlbCliT )->( dbCloseArea() )
      ( dbfAlbCliL )->( dbCloseArea() )
      ( dbfAlbCliI )->( dbCloseArea() )
      ( dbfAlbCliD )->( dbCloseArea() )
      ( dbfAlbCliP )->( dbCloseArea() )

      ( oldAlbCliT )->( dbCloseArea() )
      ( oldAlbCliL )->( dbCloseArea() )
      ( oldAlbCliI )->( dbCloseArea() )
      ( oldAlbCliD )->( dbCloseArea() )
      ( oldAlbCliP )->( dbCloseArea() )

      RECOVER USING oError

         msgStop( "Imposible abrir todas las bases de datos de albaranes de clientes" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      end
      ErrorBlock( oBlock )

   end

RETURN .T.



FUNCTION rxAlbCli( cPath, oMeter )

    local dbfAlbCliT

   IIF( cPath == nil, cPath := cPatEmp(), ) ;






   if !lExistTable( cPath + "ALBCLIT.DBF" )   .OR.  !lExistTable( cPath + "ALBCLIL.DBF" )   .OR.  !lExistTable( cPath + "ALBCLII.DBF" )   .OR.  !lExistTable( cPath + "ALBCLID.DBF" )   .OR.  !lExistTable( cPath + "ALBCLIP.DBF" )   .OR.  !lExistTable( cPath + "ALBCLIS.DBF" )

      CreateFiles( cPath )

   end

   fEraseIndex( cPath + "ALBCLIT.CDX" )
   fEraseIndex( cPath + "ALBCLIL.CDX" )
   fEraseIndex( cPath + "ALBCLII.CDX" )
   fEraseIndex( cPath + "ALBCLID.CDX" )
   fEraseIndex( cPath + "ALBCLIP.CDX" )
   fEraseIndex( cPath + "ALBCLIS.CDX" )

   dbUseArea( .T., cDriver(), cPath + "ALBCLIT.DBF", cCheckArea( "ALBCLIT", @dbfAlbCliT ), .F. )

   if !( dbfAlbCliT )->( neterr() )
      ( dbfAlbCliT )->( __dbPack() )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "NNUMALB", "CSERALB + Str(NNUMALB) + CSUFALB", {|| Field->CSERALB + Str( Field->NNUMALB ) + Field->CSUFALB } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "DFECALB", "DFECALB", {|| Field->DFECALB } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "CCODCLI", "CCODCLI", {|| Field->CCODCLI } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "CNOMCLI", "Upper( CNOMCLI )", {|| Upper( Field->CNOMCLI ) } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "cObra", "cCodObr + Dtos( dFecAlb )", {|| Field->cCodObr + Dtos( Field->dFecAlb ) } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "cCodAge", "cCodAge + Dtos( dFecAlb )", {|| Field->cCodAge + Dtos( Field->dFecAlb ) } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "CCODSUALB", "CCODSUALB", {|| Field->CCODSUALB } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "LFACTURADO", "LFACTURADO", {|| Field->LFACTURADO } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "cNumFac", "CNUMFAC", {|| Field->CNUMFAC }, ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "CTURALB", "CTURALB + CSUFALB + CCODCAJ", {|| Field->CTURALB + Field->CSUFALB + Field->CCODCAJ } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "NNUMORD", "Str( nNumOrd ) + cSufOrd", {|| Str( Field->nNumOrd ) + Field->cSufOrd } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "CCODTRN", "CCODTRN", {|| Field->CCODTRN } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "CCODOBR", "CCODCLI + CCODOBR", {|| Field->CCODCLI + Field->CCODOBR } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "CNUMPED", "CNUMPED", {|| Field->CNUMPED } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ))
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIT.CDX", "lSndDoc", "lSndDoc", {|| Field->lSndDoc } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliT.Cdx", "cCodUsr", "Field->cCodUsr + Dtos( Field->dFecCre ) + Field->cTimCre", {|| Field->cCodUsr + Dtos( Field->dFecCre ) + Field->cTimCre } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted() .and. !lFacturado", {|| !Deleted() .AND. !Field->lFacturado }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliT.Cdx", "lCodCli", "Field->cCodCli", {|| Field->cCodCli } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliT.Cdx", "iNumAlb", "'ALBARAN CLIENTES              ' + cSerAlb + Str( nNumAlb ) + cSufAlb", {|| "ALBARAN CLIENTES              " + Field->cSerAlb + Str( Field->nNumAlb ) + Field->cSufAlb } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliT.CDX", "cSuPed", "cSuPed", {|| Field->cSuPed } ) )

      ( dbfAlbCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de albaranes de clientes" )
   end

   dbUseArea( .T., cDriver(), cPath + "ALBCLIL.DBF", cCheckArea( "ALBCLIL", @dbfAlbCliT ), .F. )

   if !( dbfAlbCliT )->( neterr() )
      ( dbfAlbCliT )->( __dbPack() )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIL.CDX", "NNUMALB", "CSERALB + STR( NNUMALB ) + CSUFALB", {|| Field->CSERALB + STR( Field->NNUMALB ) + Field->CSUFALB } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIL.CDX", "cRef", "cRef + cCodPr1 + cCodPr2 + cSerAlb + Str( nNumAlb ) + cSufAlb", {|| Field->cRef + Field->cCodPr1 + Field->cCodPr2 + Field->cSerAlb + Str( Field->nNumAlb ) + Field->cSufAlb } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIL.CDX", "Lote", "cLote" , {|| Field->cLote } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIL.CDX", "cNumPed", "cNumPed", {|| Field->cNumPed } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIL.CDX", "cNumPedRef", "cNumPed + cRef + cCodPr1 + cCodPr2", {|| Field->cNumPed + Field->cRef + Field->cCodPr1 + Field->cCodPr2 } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIL.CDX", "cNumPedDet", "cNumPed + cRef + cCodPr1 + cCodPr2 + cRefPrv", {|| Field->cNumPed + Field->cRef + Field->cCodPr1 + Field->cCodPr2 + Field->cRefPrv } ) )

      ( dbfAlbCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIL.CDX", "cNumRef", "cSerAlb + Str( nNumAlb ) + cSufAlb + cRef", {|| Field->cSerAlb + Str( Field->nNumAlb ) + Field->cSufAlb + Field->cRef } ) )

      ( dbfAlbCliT )->( ordCondSet("!lFacturado .and. !Deleted()", {|| !Field->lFacturado .AND. !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIL.CDX", "cStkFast", "cRef", {|| Field->cRef } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIL.CDX", "cPedRef", "cNumPed + cRef", {|| Field->cNumPed + Field->cRef } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliL.Cdx", "iNumAlb", "'ALBARAN CLIENTES              ' + cSerAlb + Str( nNumAlb ) + cSufAlb", {|| "ALBARAN CLIENTES              " + Field->cSerAlb + Str( Field->nNumAlb ) + Field->cSufAlb } ) )

      ( dbfAlbCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de albaranes de clientes" )
   end



   dbUseArea( .T., cDriver(), cPath + "ALBCLIP.DBF", cCheckArea( "ALBCLIP", @dbfAlbCliT ), .F. )

   if !( dbfAlbCliT )->( neterr() )
      ( dbfAlbCliT )->( __dbPack() )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIP.CDX", "NNUMALB", "CSERALB + STR( NNUMALB ) + CSUFALB + STR( NNUMREC )", {|| Field->CSERALB + STR( Field->NNUMALB ) + Field->CSUFALB + STR( Field->NNUMREC ) } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIP.CDX", "CTURREC", "cTurRec + cSufAlb + cCodCaj", {|| Field->cTurRec + Field->cSufAlb + Field->cCodCaj } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "ALBCLIP.CDX", "CCODCLI", "cCodCli", {|| Field->cCodCli } ) )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliP.CDX", "DENTREGA", "dEntrega", {|| Field->dEntrega } ) )

      ( dbfAlbCliT )->( ordCondSet("!Deleted() .and. !Field->lPasado", {|| !Deleted() .AND. !Field->lPasado } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliP.Cdx", "lCtaBnc", "Field->cEntEmp + Field->cSucEmp + Field->cDigEmp + Field->cCtaEmp", {|| Field->cEntEmp + Field->cSucEmp + Field->cDigEmp + Field->cCtaEmp } ) )

      ( dbfAlbCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de albaranes de clientes" )
   end

   dbUseArea( .T., cDriver(), cPath + "AlbCliI.DBF", cCheckArea( "AlbCliI", @dbfAlbCliT ), .F. )

   if !( dbfAlbCliT )->( neterr() )
      ( dbfAlbCliT )->( __dbPack() )

      ( dbfAlbCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliI.CDX", "NNUMALB", "CSERALB + STR( NNUMALB ) + CSUFALB", {|| Field->CSERALB + STR( Field->NNUMALB ) + Field->CSUFALB } ) )

      ( dbfAlbCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de albaranes de clientes" )
   end

   dbUseArea( .T., cDriver(), cPath + "AlbCliD.DBF", cCheckArea( "AlbCliD", @dbfAlbCliT ), .F. )

   if !( dbfAlbCliT )->( neterr() )
      ( dbfAlbCliT )->( __dbPack() )

      ( dbfAlbCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliD.CDX", "NNUMALB", "CSERALB + STR( NNUMALB ) + CSUFALB", {|| Field->CSERALB + STR( Field->NNUMALB ) + Field->CSUFALB } ) )

      ( dbfAlbCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de albaranes de clientes" )
   end

   dbUseArea( .T., cDriver(), cPath + "AlbCliS.Dbf", cCheckArea( "AlbCliS", @dbfAlbCliT ), .F. )

   if !( dbfAlbCliT )->( neterr() )
      ( dbfAlbCliT )->( __dbPack() )

      ( dbfAlbCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliS.CDX", "nNumAlb", "cSerAlb + Str( nNumAlb ) + cSufAlb + Str( nNumLin )", {|| Field->cSerAlb + Str( Field->nNumAlb ) + Field->cSufAlb + Str( Field->nNumLin ) } ) )

      ( dbfAlbCliT )->( ordCondSet( "!lFacturado .and. !Deleted()", {|| !Field->lFacturado .AND. !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliS.CDX", "cRefSer", "cRef + cAlmLin + cNumSer", {|| Field->cRef + Field->cAlmLin + Field->cNumSer } ) )

      ( dbfAlbCliT )->( ordCondSet( "!lFacturado .and. !Deleted()", {|| !Field->lFacturado .AND. !Deleted() } ) )
      ( dbfAlbCliT )->( ordCreate( cPath + "AlbCliS.CDX", "cNumSer", "cNumSer", {|| Field->cNumSer } ) )

      ( dbfAlbCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de numeros de series de albaranes de clientes" )
   end

RETURN NIL



STATIC FUNCTION CreateFiles( cPath )

   if !lExistTable( cPath + "AlbCliT.Dbf" )
      dbCreate( cPath + "AlbCliT.Dbf", aSqlStruct( aItmAlbCli() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbCliL.Dbf" )
      dbCreate( cPath + "AlbCliL.Dbf", aSqlStruct( aColAlbCli() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbCliP.Dbf" )
      dbCreate( cPath + "AlbCliP.Dbf", aSqlStruct( aItmAlbPgo() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbCliI.Dbf" )
      dbCreate( cPath + "AlbCliI.Dbf", aSqlStruct( aIncAlbCli() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbCliD.Dbf" )
      dbCreate( cPath + "AlbCliD.Dbf", aSqlStruct( aAlbCliDoc() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbCliS.Dbf" )
      dbCreate( cPath + "AlbCliS.Dbf", aSqlStruct( aSerAlbCli() ), cDriver() )
   end

RETURN NIL



function aAlbCliDoc()

   local aAlbCliDoc  := {}

   aAdd( aAlbCliDoc, { "cSerAlb", "C",    1,  0, "Serie de albarán" ,                "",                   "", "( cDbfCol )" } )
   aAdd( aAlbCliDoc, { "nNumAlb", "N",    9,  0, "Número de albarán" ,               "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aAlbCliDoc, { "cSufAlb", "C",    2,  0, "Sufijo de albarán" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aAlbCliDoc, { "cNombre", "C",  250,  0, "Nombre del documento" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aAlbCliDoc, { "cRuta",   "C",  250,  0, "Ruta del documento" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aAlbCliDoc, { "mObsDoc", "M",   10,  0, "Observaciones del documento" ,     "",                   "", "( cDbfCol )" } )

return ( aAlbCliDoc )



function aIncAlbCli()

   local aIncAlbCli  := {}

   aAdd( aIncAlbCli, { "cSerAlb", "C",    1,  0, "Serie de albarán" ,                "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbCli, { "nNumAlb", "N",    9,  0, "Número de albarán" ,               "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aIncAlbCli, { "cSufAlb", "C",    2,  0, "Sufijo de albarán" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbCli, { "cCodTip", "C",    3,  0, "Tipo de incidencia" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbCli, { "dFecInc", "D",    8,  0, "Fecha de la incidencia" ,          "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbCli, { "mDesInc", "M",   10,  0, "Descripción de la incidencia" ,    "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbCli, { "lListo",  "L",    1,  0, "Lógico de listo" ,                 "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbCli, { "lAviso",  "L",    1,  0, "Lógico de aviso" ,                 "",                   "", "( cDbfCol )" } )

return ( aIncAlbCli )



function aItmAlbPgo()

   local aBasRecCli  := {}

   aAdd( aBasRecCli, {"cSerAlb"     ,"C",  1, 0, "Serie de albarán" ,                  "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"nNumAlb"     ,"N",  9, 0, "Número de albarán" ,                 "'999999999'",       "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cSufAlb"     ,"C",  2, 0, "Sufijo de albarán" ,                 "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"nNumRec"     ,"N",  2, 0, "Número del recibo",                  "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cCodCaj"     ,"C",  3, 0, "Código de caja",                     "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cTurRec"     ,"C",  6, 0, "Sesión del recibo",                  "######",            "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cCodCli"     ,"C", 12, 0, "Código de cliente",                  "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"dEntrega"    ,"D",  8, 0, "Fecha de cobro",                     "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"nImporte"    ,"N", 16, 6, "Importe",                            "cPorDivEnt",        "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cDescrip"    ,"C",100, 0, "Concepto del pago",                  "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cPgdoPor"    ,"C", 50, 0, "Pagado por",                         "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cDocPgo"     ,"C", 50, 0, "Documento de pago",                  "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cDivPgo"     ,"C",  3, 0, "Código de la divisa",                "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"nVdvPgo"     ,"N", 10, 6, "Cambio de la divisa",                "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cCodAge"     ,"C",  3, 0, "Código del agente",                  "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cCodPgo"     ,"C",  2, 0, "Código de la forma de pago",         "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"lCloPgo"     ,"L",  1, 0, "Logico de turno cerrado",            "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cNumAnt"     ,"C", 14, 0, "Número del anticipo en el pedido",   "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cNumRec"     ,"C", 14, 0, "Número del pedido al que pertenece", "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"lPasado"     ,"L",  1, 0, "Lógico de pasado",                   "",                  "", "( cDbfEnt )" } )
   aAdd( aBasRecCli, {"cBncEmp"     ,"C", 50, 0, "Banco de la empresa para el recibo" ,"",                  "", "( cDbfEnt )", nil } )
   aAdd( aBasRecCli, {"cBncCli"     ,"C", 50, 0, "Banco del cliente para el recibo" ,"",                    "", "( cDbfEnt )", nil } )
   aAdd( aBasRecCli, {"cEntEmp"     ,"C",  4, 0, "Entidad de la cuenta de la empresa",  "",                 "", "( cDbfEnt )", nil } )
   aAdd( aBasRecCli, {"cSucEmp"     ,"C",  4, 0, "Sucursal de la cuenta de la empresa",  "",                "", "( cDbfEnt )", nil } )
   aAdd( aBasRecCli, {"cDigEmp"     ,"C",  2, 0, "Dígito de control de la cuenta de la empresa", "",        "", "( cDbfEnt )", nil } )
   aAdd( aBasRecCli, {"cCtaEmp"     ,"C", 10, 0, "Cuenta bancaria de la empresa",  "",                      "", "( cDbfEnt )", nil } )
   aAdd( aBasRecCli, {"cEntCli"     ,"C",  4, 0, "Entidad de la cuenta del cliente",  "",                   "", "( cDbfEnt )", nil } )
   aAdd( aBasRecCli, {"cSucCli"     ,"C",  4, 0, "Sucursal de la cuenta del cliente",  "",                  "", "( cDbfEnt )", nil } )
   aAdd( aBasRecCli, {"cDigCli"     ,"C",  2, 0, "Dígito de control de la cuenta del cliente", "",          "", "( cDbfEnt )", nil } )
   aAdd( aBasRecCli, {"cCtaCli"     ,"C", 10, 0, "Cuenta bancaria del cliente",  "",                        "", "( cDbfEnt )", nil } )


return ( aBasRecCli )



Function aColAlbCli()

   local aColAlbCli  := {}

   aAdd( aColAlbCli, { "cSerAlb",   "C",  1, 0, "Serie del albarán" ,            "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nNumAlb",   "N",  9, 0, "Número del albarán" ,           "'999999999'",       "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cSufAlb",   "C",  2, 0, "Sufijo del albarán" ,           "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cRef",      "C", 18, 0, "Referencia de artículo" ,       "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cDetalle",  "C",250, 0, "Detalle de artículo" ,          "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nPreUnit",  "N", 16, 6, "Precio artículo" ,              "cPouDivAlb",        "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nPntVer",   "N", 16, 6, "Importe punto verde" ,          "cPpvDivAlb",        "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nImpTrn",   "N", 16, 6, "Importe del porte" ,            "cPouDivAlb",        "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nDto",      "N",  6, 2, "Descuento de artículo" ,        "'@E 999.9'",        "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nDtoPrm",   "N",  6, 2, "Descuento de promoción" ,       "'@E 999.9'",        "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nIva",      "N",  4, 1, cImp() + " del artículo" ,             "'@E 99'",           "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nCanEnt",   "N", 16, 6, cNombreCajas(),                  "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nCanFac",   "N", 16, 6, "Cantidad facturada" ,           "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lControl",  "L",  1, 0, "Control reservado" ,            "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nPesoKg",   "N", 16, 6, "Peso del producto" ,            "'@E 9,999.99'",     "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cPesoKg",   "C",  2, 0, "Unidad de peso del producto" ,  "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cUnidad",   "C",  2, 0, "Unidad de venta" ,              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nComAge",   "N",  6, 2, "Comisión del agente" ,          "'@E 999.9'",        "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nUniCaja",  "N", 16, 6, cNombreUnidades(),               "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nUndKit",   "N", 16, 6, "Unidades del producto kit",     "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "dFecha",    "D",  8, 0, "Fecha de linea" ,               "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cTipMov",   "C",  2, 0, "Tipo de movimiento" ,           "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "mLngDes",   "M", 10, 0, "Descripción larga" ,            "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lTotLin",   "L",  1, 0, "Línea de total" ,               "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lImpLin",   "L",  1, 0, "Línea no imprimible" ,          "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lNewLin",   "L",  1, 0, "" ,                             "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cNumPed"   ,"C", 12, 0, "Número del pedido" ,            "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cCodPr1",   "C", 10, 0, "Código de primera propiedad",   "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cCodPr2",   "C", 10, 0, "Código de segunda propiedad",   "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cValPr1",   "C", 10, 0, "Valor de primera propiedad",    "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cValPr2",   "C", 10, 0, "Valor de segunda propiedad",    "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nFacCnv",   "N", 16, 6, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nDtoDiv",   "N", 16, 6, "Descuento en línea",            "cPouDivAlb",        "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nNumLin",   "N",  4, 0, "Número de la línea",            "'9999'",            "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nCtlStk",   "N",  1, 0, "Tipo de stock de la linea",     "9",                 "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nCosDiv",   "N", 16, 6, "Precio de costo",               "cPouDivAlb",        "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nPvpRec",   "N", 16, 6, "Precio de venta recomendado",   "cPouDivAlb",        "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cAlmLin",   "C",  3, 0, "Código del almacen",            "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lIvaLin",   "L",  1, 0, cImp() + " incluido",                  "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nValImp",   "N", 16, 6, "Importe de impuesto",           "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cCodImp",   "C",  3, 0, "Código del IVMH",               "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lLote",     "L",  1, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nLote",     "N",  9, 0, "",                              "'999999999'",       "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cLote",     "C", 12, 0, "Número de lote",                "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "dFecCad",   "D",  8, 0, "Fecha de caducidad",            "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lKitArt",   "L",  1, 0, "Línea con escandallo",          "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lKitChl",   "L",  1, 0, "Línea pertenciente a escandallo", "",                "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lKitPrc",   "L",  1, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nMesGrt",   "N",  2, 0, "Meses de garantía",             "'99'",              "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lMsgVta",   "L",  1, 0, "Avisar venta sin stocks",       "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lNotVta",   "L",  1, 0, "No permitir venta sin stocks",  "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "mNumSer",   "M", 10, 0, "" ,                             "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cCodTip",   "C",  3, 0, "Código del tipo de artículo",   "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cCodFam",   "C", 16, 0, "Código de familia",             "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cGrpFam",   "C",  3, 0, "Código del grupo de familia",   "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nReq",      "N", 16, 6, "Recargo de equivalencia",       "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "mObsLin",   "M", 10, 0, "Observación de línea",          "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cCodPrv",   "C", 12, 0, "Código del proveedor",          "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cNomPrv",   "C", 30, 0, "Nombre del proveedor",          "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cImagen",   "C",250, 0, "Fichero de imagen" ,            "",                  "", "( cDbfCol )", .T. } )
   aAdd( aColAlbCli, { "nPuntos",   "N", 15, 6, "Puntos del artículo",           "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nValPnt",   "N", 16, 6, "Valor del punto",               "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nDtoPnt",   "N",  5, 2, "Descuento puntos",              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nIncPnt",   "N",  5, 2, "Incremento porcentual",         "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cRefPrv",   "C", 18, 0, "Referencia proveedor",          "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nVolumen",  "N", 16, 6, "Volumen del producto" ,         "'@E 9,999.99'",     "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cVolumen",  "C",  2, 0, "Unidad del volumen" ,           "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "dFecEnt" ,  "D",  8, 0, "Fecha de entrada del alquiler", "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "dFecSal" ,  "D",  8, 0, "Fecha de salida del alquiler",  "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nPreAlq" ,  "N", 16, 6, "Precio de alquiler",            "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lAlquiler", "L",  1, 0, "Lógico de alquiler",            "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nNumMed",   "N",  1, 0, "Número de mediciones",          "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nMedUno",   "N", 16, 6, "Primera unidad de medición",    "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nMedDos",   "N", 16, 6, "Segunda unidad de medición",    "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nMedTre",   "N", 16, 6, "Tercera unidad de medición",    "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "nTarLin",   "N", 16, 6, "Tarifa de precio aplicada",     "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cCodUbi1",  "C",  5, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cCodUbi2",  "C",  5, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cCodUbi3",  "C",  5, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cValUbi1",  "C",  5, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cValUbi2",  "C",  5, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cValUbi3",  "C",  5, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cNomUbi1",  "C", 30, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cNomUbi2",  "C", 30, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cNomUbi3",  "C", 30, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lImpFra",   "L",  1, 0, "Lógico de imprimir frase publicitaria", "",          "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cCodFra",   "C",  3, 0, "Código de frase publicitaria",  "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "cTxtFra",   "C",250, 0, "",                              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "Descrip",   "M", 10, 0, "Observación de línea",          "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lFacturado","L",  1, 0, "Lógico de facturado",           "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lLinOfe"  , "L",  1, 0, "Línea con oferta",              "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "lVolImp",   "L",  1, 0, "Lógico aplicar volumen con IpusEsp",  "",            "", "( cDbfCol )" } )
   aAdd( aColAlbCli, { "dFecAlb",   "D",  8, 0, "Fecha de albaran",              "",                  "", "( cDbfCol )" } )

Return ( aColAlbCli )



Function aItmAlbCli()

   local aItmAlbCli := {}

   aAdd( aItmAlbCli, { "CSERALB"   ,"C",  1, 0, "Serie del albarán" ,                                    "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NNUMALB"   ,"N",  9, 0, "Número del albarán" ,                                   "'999999999'",        "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CSUFALB"   ,"C",  2, 0, "Sufijo del albarán" ,                                   "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CTURALB"   ,"C",  6, 0, "Sesión del albarán",                                    "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "DFECALB"   ,"D",  8, 0, "Fecha del albarán" ,                                    "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CCODCLI"   ,"C", 12, 0, "Código del cliente" ,                                   "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CCODALM"   ,"C",  3, 0, "Código de almacén" ,                                    "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CCODCAJ"   ,"C",  3, 0, "Código de caja" ,                                       "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CNOMCLI"   ,"C", 80, 0, "Nombre del cliente" ,                                   "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CDIRCLI"   ,"C",100, 0, "Domicilio del cliente" ,                                "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CPOBCLI"   ,"C", 35, 0, "Población del cliente" ,                                "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CPRVCLI"   ,"C", 20, 0, "Provincia del cliente" ,                                "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CPOSCLI"   ,"C", 15, 0, "Código postal del cliente" ,                            "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CDNICLI"   ,"C", 30, 0, "DNI/CIF del cliente" ,                                  "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "LMODCLI"   ,"L",  1, 0, "Lógico de modificar datos del cliente" ,                "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "LFACTURADO","L",  1, 0, "Lógico de facturado" ,                                  "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "lEntregado","L",  1, 0, "Lógico albarán enviado" ,                               "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "DFECENT"   ,"D",  8, 0, "Fecha de entrada del albarán" ,                         "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CCODSUALB" ,"C", 25, 0, "Referencia a su albarán" ,                              "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CCONDENT"  ,"C",100, 0, "Condición de entrada" ,                                 "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "MCOMENT"   ,"M", 10, 0, "Cometarios del albarán" ,                               "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "MOBSERV"   ,"M", 10, 0, "Observaciones" ,                                        "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CCODPAGO"  ,"C",  2, 0, "Código de la forma de pago" ,                           "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NBULTOS"   ,"N",  3, 0, "Número de bultos" ,                                     "'999'",              "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NPORTES"   ,"N", 16, 6, "Importe de los portes" ,                                "cPouDivAlb",         "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CCODAGE"   ,"C",  3, 0, "Código del agente" ,                                    "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CCODOBR"   ,"C", 10, 0, "Código de obra" ,                                       "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CCODTAR"   ,"C",  5, 0, "Código de tarifa" ,                                     "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CCODRUT"   ,"C",  4, 0, "Código de ruta" ,                                       "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CNUMPED"   ,"C", 12, 0, "Número del pedido" ,                                    "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NTIPOALB"  ,"N",  1, 0, "Tipo de albarán" ,                                      "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CNUMFAC"   ,"C", 12, 0, "Número del documento facturado" ,                       "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "LMAYOR"    ,"L",  1, 0, "" ,                                                     "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NTARIFA"   ,"N",  1, 0, "Tarifa de precio aplicada" ,                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CDTOESP"   ,"C", 50, 0, "Descripción porcentaje de descuento",                   "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NDTOESP"   ,"N",  6, 2, "Porcentaje de descuento",                               "'@EZ 999.99'",       "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CDPP"      ,"C", 50, 0, "Descripción pct. de dto. por pronto pago",              "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NDPP"      ,"N",  6, 2, "Porcentaje de dto. por pronto pago",                    "'@EZ 999.99'",       "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CDTOUNO"   ,"C", 25, 0, "Descripción del primer descuento personalizado",        "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NDTOUNO"   ,"N",  4, 1, "Porcentaje del primer descuento pers.",                 "'@EZ 999.99'",       "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CDTODOS"   ,"C", 25, 0, "Descripción del segundo descuento pers.",               "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NDTODOS"   ,"N",  4, 1, "Descripción del segundo descuento pers.",               "'@EZ 999.99'",       "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NDTOCNT"   ,"N",  6, 2, "Pct. de dto. por pago contado",                         "'@EZ 999.99'",       "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NDTORAP"   ,"N",  6, 2, "Pct. de dto. por rappel",                               "'@EZ 999.99'",       "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NDTOPUB"   ,"N",  6, 2, "Pct. de dto. por publicidad",                           "'@EZ 999.99'",       "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NDTOPGO"   ,"N",  6, 2, "Pct. de dto. por pago centralizado",                    "'@EZ 999.99'",       "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NDTOPTF"   ,"N",  7, 2, ""                                 ,                     "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "LRECARGO"  ,"L",  1, 0, "Lógico recargo de equivalencia",                        "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NPCTCOMAGE","N",  6, 2, "Pct. de comisión del agente",                           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "LSNDDOC"   ,"L",  1, 0, "Lógico de documento a enviar",                          "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CDIVALB"   ,"C",  3, 0, "Código de divisa",                                      "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NVDVALB"   ,"N", 10, 4, "Valor del cambio de la divisa",                         "'@EZ 999,999.9999'", "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CRETPOR"   ,"C",100, 0, "Retirado por" ,                                         "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CRETMAT"   ,"C", 20, 0, "Matrícula" ,                                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CNUMDOC"   ,"C", 12, 0, "",                                                      "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CSUPED"    ,"C", 50, 0, "Su pedido",                                             "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "LIVAINC"   ,"L",  1, 0, cImp() + " incluido",                                          "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NREGIVA"   ,"N",  1, 0, "Regimen de " + cImp(),                                     "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "LGENLQD"   ,"L",  1, 0, "Generado por liquidación",                              "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NNUMORD"   ,"N",  9, 0, "Número de la orden de carga" ,                          "'999999999'",        "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CSUFORD"   ,"C",  2, 0, "Sufijo de la orden de carga" ,                          "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "DFECORD"   ,"D",  8, 0, "Fecha de la orden de carga" ,                           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NIVAMAN"   ,"N",  6, 2, "Porcentaje de " + cImp() + " del gasto" ,                       "'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "NMANOBR"   ,"N", 16, 6, "Gastos" ,                                               "cPorDivAlb",         "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "cCodTrn"   ,"C",  9, 0, "Código del transportista" ,                             "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "nKgsTrn"   ,"N", 16, 6, "TARA del transportista" ,                               "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "lCloAlb"   ,"L",  1, 0, "" ,                                                     "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "cCodUsr"   ,"C",  3, 0, "Código de usuario",                                     "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "dFecCre"   ,"D",  8, 0, "Fecha de creación/modificación del documento",          "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "cTimCre"   ,"C",  5, 0, "Hora de creación/modificación del documento",           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "dFecEnv"   ,"D",  8, 0, "Fecha de envio",                                        "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "cCodGrp"   ,"C",  4, 0, "Código de grupo de cliente" ,                           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "lImprimido","L",  1, 0, "Lógico de imprimido" ,                                  "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "dFecImp"   ,"D",  8, 0, "Última fecha de impresión" ,                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "cHorImp"   ,"C",  5, 0, "Hora de la última impresión" ,                          "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "cCodDlg"   ,"C",  2, 0, "Código delegación" ,                                    "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "nDtoAtp"   ,"N",  6, 2, "Porcentaje de descuento atípico",                       "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "nSbrAtp"   ,"N",  1, 0, "Lugar donde aplicar dto atípico",                       "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "nMontaje"  ,"N",  6, 2, "Horas de montaje",                                      "'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "dFecEntr",  "D",  8, 0, "Fecha de entrada de alquiler",                          "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "dFecSal",   "D",  8, 0, "Fecha de salida de alquiler",                           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "lAlquiler", "L",  1, 0, "Lógico de alquiler",                                    "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "cManObr",   "C",250, 0, "" ,                                                     "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "lOrdCar",   "L",  1, 0, "Lógico de pertenecer a un orden de carga" ,             "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CNUMTIK",   "C", 13, 0, "Número del ticket" ,                                    "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "CTLFCLI",   "C", 20, 0, "Teléfono del cliente" ,                                 "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "nTotNet",   "N", 16, 6, "Total neto" ,                                           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "nTotIva",   "N", 16, 6, "Total " + cImp() ,                                      "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "nTotReq",   "N", 16, 6, "Total recargo" ,                                        "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "nTotAlb",   "N", 16, 6, "Total albarán" ,                                        "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "nTotPag",   "N", 16, 6, "Total anticipado" ,                                     "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "lOperPV",   "L",  1, 0, "Lógico para operar con punto verde" ,                   "",                   "", "( cDbf )"} )
   aAdd( aItmAlbCli, { "cBanco"   , "C", 50, 0, "Nombre del banco del cliente",                          "",                   "", "( cDbf )", nil } )
   aAdd( aItmAlbCli, { "cEntBnc"  , "C",  4, 0, "Entidad de la cuenta bancaria del cliente",             "",                   "", "( cDbf )", nil } )
   aAdd( aItmAlbCli, { "cSucBnc"  , "C",  4, 0, "Sucursal de la cuenta bancaria del cliente",            "",                   "", "( cDbf )", nil } )
   aAdd( aItmAlbCli, { "cDigBnc"  , "C",  2, 0, "Dígito de control de la cuenta bancaria del cliente",   "",                   "", "( cDbf )", nil } )
   aAdd( aItmAlbCli, { "cCtaBnc"  , "C", 10, 0, "Cuenta bancaria del cliente",                           "",                   "", "( cDbf )", nil } )

Return ( aItmAlbCli )



FUNCTION nTotAlbCli( cAlbaran, cAlbCliT, cAlbCliL, cIva, cDiv, aTmp, cDivRet, lPic, lExcCnt, lNeto )

   local nRecno
    local bCondition
   local dFecAlb
   local lRecargo
   local nDtoUno
   local nDtoDos
   local nDtoEsp
    local nDtoPP
    local nDtoCnt
    local nDtoRap
    local nDtoPub
    local nDtoPgo
    local nDtoPtf
    local cCodDiv
    local cCodPgo
   local lIvaInc
   local nDtoAtp
   local nSbrAtp
   local nKgsTrn
   local nIvaMan
   local nManObr           := 0
   local nTotalArt         := 0
   local nTotalUnd         := 0
   local nTotalLin         := 0
   local nTotalTrn         := 0
   local nTotalPnt         := 0
   local nTotalIvm         := 0
   local nImpIva           := { 0, 0, 0 }
   local nImpReq           := { 0, 0, 0 }
   local aTotalDto         := { 0, 0, 0 }
   local aTotalDPP         := { 0, 0, 0 }
   local aTotalUno         := { 0, 0, 0 }
   local aTotalDos         := { 0, 0, 0 }
   local aTotalAtp         := { 0, 0, 0 }
   local nDescuentosLineas := 0
   local lOperarPntVer     := .F.

   IIF( cAlbCliT == nil, cAlbCliT := dbfAlbCliT, ) ;
   IIF( cAlbCliL == nil, cAlbCliL := dbfAlbCliL, ) ;
   IIF( cAlbaran == nil, cAlbaran := ( cAlbCliT )->cSerAlb + Str( ( cAlbCliT )->nNumAlb ) + ( cAlbCliT )->cSufAlb, ) ;
   IIF( cIva == nil, cIva := dbfIva, ) ;
   IIF( cDiv == nil, cDiv := dbfDiv, ) ;
   IIF( lPic == nil, lPic := .F., ) ;
   IIF( lNeto == nil, lNeto := .F., ) ;

   if Empty( Select( cAlbCliT ) )
      Return ( 0 )
   end

   if Empty( Select( cAlbCliL ) )
      Return ( 0 )
   end

   if Empty( Select( cIva ) )
      Return ( 0 )
   end

   if Empty( Select( cDiv ) )
      Return ( 0 )
   end

   public nTotBrt    := 0
   public nTotAlb    := 0
   public nTotDto    := 0
   public nTotDPP    := 0
   public nTotNet    := 0
   public nTotIva    := 0
   public nTotIvm    := 0
   public nTotAge    := 0
   public nTotReq    := 0
   public nTotPnt    := 0
   public nTotUno    := 0
   public nTotDos    := 0
   public nTotCos    := 0
   public nTotPes    := 0
   public nTotDif    := 0
   public nTotAtp    := 0
   public nTotTrn    := 0
   public nPctRnt    := 0
   public nTotRnt    := 0
   public cCtaCli    := cClientCuenta( ( cAlbCliT )->cCodCli )

   public aTotIva    := { { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 } }
   public aIvaUno    := aTotIva[ 1 ]
   public aIvaDos    := aTotIva[ 2 ]
   public aIvaTre    := aTotIva[ 3 ]

   public aTotIvm    := { { 0,nil,0 }, { 0,nil,0 }, { 0,nil,0 }, }
   public aIvmUno    := aTotIvm[ 1 ]
   public aIvmDos    := aTotIvm[ 2 ]
   public aIvmTre    := aTotIvm[ 3 ]


   public nTotalDto  := 0

   public nTotArt    := 0
   public nTotCaj    := 0

   nImpIva           := { 0,0,0 }
   nImpReq           := { 0,0,0 }

   nRecno            := ( cAlbCliL )->( recno() )

   if aTmp <> nil
      nDtoUno        := aTmp[ 40 ]
      nDtoDos        := aTmp[ 42 ]
      dFecAlb        := aTmp[ 5 ]
        nDtoEsp            := aTmp[ 36 ]
      nDtoPP         := aTmp[ 38    ]
        nDtoCnt            := aTmp[ 43 ]
        nDtoRap         := aTmp[ 44 ]
        nDtoPub         := aTmp[ 45 ]
        nDtoPgo         := aTmp[ 46 ]
        nDtoPtf            := aTmp[ 47 ]
      lRecargo       := aTmp[ 48]
      nIvaMan        := aTmp[ 63 ]
      nManObr        := aTmp[ 64 ]
      cCodDiv        := aTmp[ 51 ]
      nVdvDiv        := aTmp[ 52 ]
        cCodPgo            := aTmp[ 23]
      lIvaInc        := aTmp[ 57 ]
      nDtoAtp        := aTmp[ 77 ]
      nSbrAtp        := aTmp[ 78 ]
      nKgsTrn        := aTmp[ 66 ]
      lOperarPntVer  := aTmp[ 92 ]
      bCondition     := {|| ( cAlbCliL )->( !eof() ) }
      ( cAlbCliL )->( dbGoTop() )
   else
      nDtoUno        := ( cAlbCliT )->nDtoUno
      nDtoDos        := ( cAlbCliT )->nDtoDos
      dFecAlb        := ( cAlbCliT )->dFecAlb
      nDtoEsp        := ( cAlbCliT )->nDtoEsp
      nDtoPP         := ( cAlbCliT )->nDpp
      nDtoCnt        := ( cAlbCliT )->nDtoCnt
      nDtoRap        := ( cAlbCliT )->nDtoRap
      nDtoPub        := ( cAlbCliT )->nDtoPub
      nDtoPgo        := ( cAlbCliT )->nDtoPgo
      nDtoPtf        := ( cAlbCliT )->nDtoPtf
      lRecargo       := ( cAlbCliT )->lRecargo
      nIvaMan        := ( cAlbCliT )->nIvaMan
      nManObr        := ( cAlbCliT )->nManObr
      cCodDiv        := ( cAlbCliT )->cDivAlb
      nVdvDiv        := ( cAlbCliT )->nVdvAlb
      cCodPgo        := ( cAlbCliT )->cCodPago
      lIvaInc        := ( cAlbCliT )->lIvaInc
      nDtoAtp        := ( cAlbCliT )->nDtoAtp
      nSbrAtp        := ( cAlbCliT )->nSbrAtp
      nKgsTrn        := ( cAlbCliT )->nKgsTrn
      lOperarPntVer  := ( cAlbCliT )->lOperPV
      bCondition     := {|| ( cAlbCliL )->cSerAlb + Str( ( cAlbCliL )->nNumAlb ) + ( cAlbCliL )->cSufAlb == cAlbaran .AND. ( cAlbCliL )->( !eof() ) }
      ( cAlbCliL )->( dbSeek( cAlbaran ) )
   endif





   cPorDiv           := cPorDiv( cCodDiv, cDiv )
   cPouDiv           := cPouDiv( cCodDiv, cDiv )
   nDouDiv           := nDouDiv( cCodDiv, cDiv )
   nRouDiv           := nRouDiv( cCodDiv, cDiv )
   nDpvDiv           := nDpvDiv( cCodDiv, cDiv )

   while Eval( bCondition )

      if lValLine( cAlbCliL )



         if ( lExcCnt == nil                                .OR. ( lExcCnt .AND. ( cAlbCliL )->nCtlStk <> 2 )    .OR. ( !lExcCnt .AND. ( cAlbCliL )->nCtlStk == 2 ) )

            if ( cAlbCliL )->lTotLin



               if ( cAlbCliL )->nPreUnit <> nTotalLin .OR. ( cAlbCliL )->nUniCaja <> nTotalUnd

                  if dbLock( cAlbCliL )
                     ( cAlbCliL )->nPreUnit := nTotalLin
                     ( cAlbCliL )->nUniCaja := nTotalUnd
                     ( cAlbCliL )->( dbUnLock() )
                  end

               end



               nTotalLin         := 0
               nTotalUnd         := 0

            else

               nTotalArt         := nTotLAlbCli( cAlbCliL, nDouDiv, nRouDiv, nil, .T., .F., .F. )
               nTotalTrn         := nTrnLAlbCli( cAlbCliL, nDouDiv )
               nTotalPnt         := if( lOperarPntVer, nPntLAlbCli( cAlbCliL, nDpvDiv ), 0 )
               nTotalIvm         := nTotIAlbCli( cAlbCliL, nDouDiv, nRouDiv )
               nTotCos           += nCosLAlbCli( cAlbCliL, nDouDiv, nDorDiv )
               nTotPes           += nPesLAlbCli( cAlbCliL )
               nDescuentosLineas += nTotDtoLAlbCli( cAlbCliL, nDouDiv )

               if aTmp <> nil
                  nTotAge        += nComLAlbCli( aTmp, cAlbCliL, nDouDiv, nRouDiv )
               else
                  nTotAge        += nComLAlbCli( cAlbCliT, cAlbCliL, nDouDiv, nRouDiv )
               end



               nTotalLin         += nTotalArt
               nTotalUnd         += nTotNAlbCli( cAlbCliL )

               nTotArt           += nTotNAlbCli( cAlbCliL )
               nTotCaj           += ( cAlbCliL )->nCanEnt



               if nTotalArt + nTotalIvm + nTotalTrn + nTotalPnt <> 0

                  do case
                     case aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 1, 3 ] == ( cAlbCliL )->nIva

                        aTotIva[ 1, 3 ]   := ( cAlbCliL )->nIva
                        aTotIva[ 1, 4 ]   := ( cAlbCliL )->nReq
                        aTotIva[ 1, 1 ]   += nTotalArt
                        aTotIva[ 1, 6 ]   += nTotalIvm
                        aTotIva[ 1, 7 ]   += nTotalTrn
                        aTotIva[ 1, 5 ]   += nTotalPnt

                     case aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 2, 3 ] == ( cAlbCliL )->nIva

                        aTotIva[ 2, 3 ]   := (cAlbCliL)->nIva
                        aTotIva[ 2, 4 ]   := (cAlbCliL)->nReq
                        aTotIva[ 2, 1 ]   += nTotalArt
                        aTotIva[ 2, 6 ]   += nTotalIvm
                        aTotIva[ 2, 7 ]   += nTotalTrn
                        aTotIva[ 3, 5 ]   += nTotalPnt

                     case aTotIva[ 3, 3 ] == nil .OR. aTotIva[ 3, 3 ] == ( cAlbCliL )->nIva

                        aTotIva[ 3, 3 ]   := ( cAlbCliL )->nIva
                        aTotIva[ 3, 4 ]   := ( cAlbCliL )->nReq
                        aTotIva[ 3, 1 ]   += nTotalArt
                        aTotIva[ 3, 6 ]   += nTotalIvm
                        aTotIva[ 3, 7 ]   += nTotalTrn
                        aTotIva[ 3, 5 ]   += nTotalPnt

                  end



                  if ( cAlbCliL )->nValImp <> 0

                     do case
                        case aTotIvm[ 1, 2 ] == nil .OR. aTotIvm[ 1, 2 ] == ( cAlbCliL )->nValImp
                           aTotIvm[ 1, 1 ]      += nTotNAlbCli( cAlbCliL ) * if( ( cAlbCliL )->lVolImp, NotCero( ( cAlbCliL )->nVolumen ), 1 )
                           aTotIvm[ 1, 2 ]      := ( cAlbCliL )->nValImp
                           aTotIvm[ 1, 3 ]      := aTotIvm[ 1, 1 ] * aTotIvm[ 1, 2 ]

                        case aTotIvm[ 2, 2 ] == nil .OR. aTotIvm[ 2, 2 ] == ( cAlbCliL )->nValImp
                           aTotIvm[ 2, 1 ]      += nTotNAlbCli( cAlbCliL ) * if( ( cAlbCliL )->lVolImp, NotCero( ( cAlbCliL )->nVolumen ), 1 )
                           aTotIvm[ 2, 2 ]      := ( cAlbCliL )->nValImp
                           aTotIvm[ 2, 3 ]      := aTotIvm[ 2, 1 ] * aTotIvm[ 2, 2 ]

                        case aTotIvm[ 3, 2 ] == nil .OR. aTotIvm[ 3, 2 ] == ( cAlbCliL )->nValImp
                           aTotIvm[ 3, 1 ]      += nTotNAlbCli( cAlbCliL ) * if( ( cAlbCliL )->lVolImp, NotCero( ( cAlbCliL )->nVolumen ), 1 )
                           aTotIvm[ 3, 2 ]      := ( cAlbCliL )->nValImp
                           aTotIvm[ 3, 3 ]      := aTotIvm[ 3, 1 ] * aTotIvm[ 3, 2 ]

                     end

                  end

               end

            end

         else



            nTotalLin   := 0
            nTotalUnd   := 0

         end

      end

      ( cAlbCliL )->( dbSkip() )

   end

   ( cAlbCliL )->( dbGoto( nRecno ) )



   aTotIva           := aSort( aTotIva,,, {|x,y| if( x[3] <> nil, x[3], -1 ) > if( y[3] <> nil, y[3], -1 )  } )

   aTotIva[ 1, 2 ]         := Round( aTotIva[ 1, 1 ], nRouDiv )
   aTotIva[ 2, 2 ]         := Round( aTotIva[ 2, 1 ], nRouDiv )
   aTotIva[ 3, 2 ]         := Round( aTotIva[ 3, 1 ], nRouDiv )

   nTotBrt           := aTotIva[ 1, 1 ] + aTotIva[ 2, 1 ] + aTotIva[ 3, 1 ]



   if nSbrAtp <= 1 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end



   if nDtoEsp  <> 0

      aTotalDto[1]   := Round( aTotIva[ 1, 2 ] * nDtoEsp / 100, nRouDiv )
      aTotalDto[2]   := Round( aTotIva[ 2, 2 ] * nDtoEsp / 100, nRouDiv )
      aTotalDto[3]   := Round( aTotIva[ 3, 2 ] * nDtoEsp / 100, nRouDiv )

      nTotDto        := aTotalDto[1] + aTotalDto[2] + aTotalDto[3]

        aTotIva[ 1, 2 ]        -= aTotalDto[1]
        aTotIva[ 2, 2 ]        -= aTotalDto[2]
        aTotIva[ 3, 2 ]        -= aTotalDto[3]

   end




   if nSbrAtp == 2 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end



    IF nDtoPP    <> 0

      aTotalDPP[1]   := Round( aTotIva[ 1, 2 ] * nDtoPP / 100, nRouDiv )
      aTotalDPP[2]   := Round( aTotIva[ 2, 2 ] * nDtoPP / 100, nRouDiv )
      aTotalDPP[3]   := Round( aTotIva[ 3, 2 ] * nDtoPP / 100, nRouDiv )

      nTotDPP        := aTotalDPP[1] + aTotalDPP[2] + aTotalDPP[3]

        aTotIva[ 1, 2 ]        -= aTotalDPP[1]
        aTotIva[ 2, 2 ]        -= aTotalDPP[2]
        aTotIva[ 3, 2 ]        -= aTotalDPP[3]

    end



   if nSbrAtp == 3 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end

    IF nDtoUno <> 0

      aTotalUno[1]   := Round( aTotIva[ 1, 2 ] * nDtoUno / 100, nRouDiv )
      aTotalUno[2]   := Round( aTotIva[ 2, 2 ] * nDtoUno / 100, nRouDiv )
      aTotalUno[3]   := Round( aTotIva[ 3, 2 ] * nDtoUno / 100, nRouDiv )

      nTotUno        := aTotalUno[1] + aTotalUno[2] + aTotalUno[3]

        aTotIva[ 1, 2 ]        -= aTotalUno[1]
        aTotIva[ 2, 2 ]        -= aTotalUno[2]
        aTotIva[ 3, 2 ]        -= aTotalUno[3]

    end



   if nSbrAtp == 4 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end

    IF nDtoDos <> 0

      aTotalDos[1]   := Round( aTotIva[ 1, 2 ] * nDtoDos / 100, nRouDiv )
      aTotalDos[2]   := Round( aTotIva[ 2, 2 ] * nDtoDos / 100, nRouDiv )
      aTotalDos[3]   := Round( aTotIva[ 3, 2 ] * nDtoDos / 100, nRouDiv )

      nTotDos        := aTotalDos[1] + aTotalDos[2] + aTotalDos[3]

        aTotIva[ 1, 2 ]        -= aTotalDos[1]
        aTotIva[ 2, 2 ]        -= aTotalDos[2]
        aTotIva[ 3, 2 ]        -= aTotalDos[3]

    end



   if nSbrAtp == 5 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end





   if nManObr <> 0

      do case
      case aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 1, 3 ] == nIvaMan

         aTotIva[ 1, 3 ]   := nIvaMan
         aTotIva[ 1, 2 ]   += nManObr

      case aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 2, 3 ] == nIvaMan

         aTotIva[ 2, 3 ]   := nIvaMan
         aTotIva[ 2, 2 ]   += nManObr

      case aTotIva[ 3, 3 ] == nil .OR. aTotIva[ 3, 3 ] == nIvaMan

         aTotIva[ 3, 3 ]   := nIvaMan
         aTotIva[ 3, 2 ]   += nManObr

      end

   end



   aTotIva[ 1, 2 ]         += aTotIva[ 1, 7 ]
   aTotIva[ 2, 2 ]         += aTotIva[ 2, 7 ]
   aTotIva[ 3, 2 ]         += aTotIva[ 3, 7 ]



   aTotIva[ 1, 2 ]         += aTotIva[ 1, 5 ]
   aTotIva[ 2, 2 ]         += aTotIva[ 2, 5 ]
   aTotIva[ 3, 2 ]         += aTotIva[ 3, 5 ]





   if uFieldEmpresa( "lIvaImpEsp" )
      aTotIva[ 1, 2 ]      += aTotIva[ 1, 6 ]
      aTotIva[ 2, 2 ]      += aTotIva[ 2, 6 ]
      aTotIva[ 3, 2 ]      += aTotIva[ 3, 6 ]
   end



   if !lIvaInc



      aTotIva[ 1, 8 ]      := if ( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 3 ] / 100, nRouDiv ), 0 )
      aTotIva[ 2, 8 ]      := if ( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 3 ] / 100, nRouDiv ), 0 )
      aTotIva[ 3, 8 ]      := if ( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 3 ] / 100, nRouDiv ), 0 )



      if lRecargo
         aTotIva[ 1, 9 ]   := if ( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 4 ] / 100, nRouDiv ), 0 )
         aTotIva[ 2, 9 ]   := if ( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 4 ] / 100, nRouDiv ), 0 )
         aTotIva[ 3, 9 ]   := if ( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 4 ] / 100, nRouDiv ), 0 )
      end

   else

      if aTotIva[ 1, 3 ] <> 0
         aTotIva[ 1, 8 ]   := if( aTotIva[ 1, 3 ] <> nil, Round( aTotIva[ 1, 2 ] / ( 100 / aTotIva[ 1, 3 ] + 1 ), nRouDiv ), 0 )
      end

      if aTotIva[ 2, 3 ] <> 0
         aTotIva[ 2, 8 ]   := if( aTotIva[ 2, 3 ] <> nil, Round( aTotIva[ 2, 2 ] / ( 100 / aTotIva[ 2, 3 ] + 1 ), nRouDiv ), 0 )
      end

      if aTotIva[ 3, 3 ] <> 0
         aTotIva[ 3, 8 ]   := if( aTotIva[ 3, 3 ] <> nil, Round( aTotIva[ 3, 2 ] / ( 100 / aTotIva[ 3, 3 ] + 1 ), nRouDiv ), 0 )
      end

      if lRecargo
         if aTotIva[ 1, 4 ] <> 0
            aTotIva[ 1, 9 ]   := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] / ( 100 / aTotIva[ 1, 4 ] + 1 ), nRouDiv ), 0 )
         end
         if aTotIva[ 2, 4 ] <> 0
            aTotIva[ 2, 9 ]   := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] / ( 100 / aTotIva[ 2, 4 ] + 1 ), nRouDiv ), 0 )
         end
         if aTotIva[ 3, 4 ] <> 0
            aTotIva[ 3, 9 ]   := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] / ( 100 / aTotIva[ 3, 4 ] + 1 ), nRouDiv ), 0 )
         end
      end

      aTotIva[ 1, 2 ]      -= aTotIva[ 1, 8 ]
      aTotIva[ 2, 2 ]      -= aTotIva[ 2, 8 ]
      aTotIva[ 3, 2 ]      -= aTotIva[ 3, 8 ]

      aTotIva[ 1, 2 ]      -= aTotIva[ 1, 9 ]
      aTotIva[ 2, 2 ]      -= aTotIva[ 2, 9 ]
      aTotIva[ 3, 2 ]      -= aTotIva[ 3, 9 ]

   end



   nTotNet           := Round( aTotIva[ 1, 2 ] + aTotIva[ 2, 2 ] + aTotIva[ 3, 2 ], nRouDiv )



   nTotIvm           := Round( aTotIvm[ 1, 3 ] + aTotIvm[ 2, 3 ] + aTotIvm[ 3, 3 ], nRouDiv )



   nTotTrn           := Round( aTotIva[ 1, 7 ] + aTotIva[ 2, 7 ] + aTotIva[ 3, 7 ], nRouDiv )



   nTotPnt           := Round( aTotIva[ 1, 5 ] + aTotIva[ 2, 5 ] + aTotIva[ 3, 5 ], nRouDiv )



   nTotIva           := Round( aTotIva[ 1, 8 ] + aTotIva[ 2, 8 ] + aTotIva[ 3, 8 ], nRouDiv )



   nTotReq           := Round( aTotIva[ 1, 9 ] + aTotIva[ 2, 9 ] + aTotIva[ 3, 9 ], nRouDiv )



   nTotImp           := nTotIva + nTotReq





   nTotRnt           := Round(         nTotNet - nManObr - nTotAge - nTotPnt - nTotAtp - nTotCos, nRouDiv )

   nPctRnt           := nRentabilidad( nTotNet - nManObr - nTotAge - nTotPnt,  nTotAtp,  nTotCos )



   if nKgsTrn <> 0
      nTotDif        := nKgsTrn - nTotPes
   else
      nTotDif        := 0
   end



   nTotAlb           := nTotNet + nTotImp

   if nTotNet == 0
      nPctRnt        := 0
   end





   nTotalDto         := nDescuentosLineas + nTotDto + nTotDpp + nTotUno + nTotDos + nTotAtp



   if cDivRet <> nil .AND. cDivRet <> cCodDiv
      nTotNet        := nCnv2Div( nTotNet, cCodDiv, cDivRet, cDiv )
      nTotIvm        := nCnv2Div( nTotIvm, cCodDiv, cDivRet, cDiv )
      nTotIva        := nCnv2Div( nTotIva, cCodDiv, cDivRet, cDiv )
      nTotReq        := nCnv2Div( nTotReq, cCodDiv, cDivRet, cDiv )
      nTotAlb        := nCnv2Div( nTotAlb, cCodDiv, cDivRet, cDiv )
      nTotPnt        := nCnv2Div( nTotPnt, cCodDiv, cDivRet, cDiv )
      nTotTrn        := nCnv2Div( nTotTrn, cCodDiv, cDivRet, cDiv )
      cPorDiv        := cPorDiv( cDivRet, cDiv )
   end

RETURN ( if( lPic, Trans( if( lNeto, nTotNet, nTotAlb ), cPorDiv ), if( lNeto, nTotNet, nTotAlb ) ) )







FUNCTION nComLAlbCli( dbfAlbCliT, dbfAlbCliL, nDecOut, nDerOut )

   local nImp  := nImpLAlbCli( dbfAlbCliT, dbfAlbCliL, nDecOut, nDerOut, , .F., .T., .F., .F. )

RETURN ( Round( ( nImp * ( dbfAlbCliL )->nComAge / 100 ), nDerOut ) )



FUNCTION nImpUAlbCli( uAlbCliT, uAlbCliL, nDec, nVdv, lIva, cPouDiv )

   local nIva
   local lIvaInc
   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lIva == nil, lIva := .F., ) ;

   nCalculo          := nTotUAlbCli( uAlbCliL, nDec, nVdv )

   do case
   case ValType( uAlbCliT ) == "A"
      nCalculo       -= Round( nCalculo * uAlbCliT[ 36 ]  / 100, nDec )
      nCalculo       -= Round( nCalculo * uAlbCliT[ 38    ]  / 100, nDec )
      nCalculo       -= Round( nCalculo * uAlbCliT[ 40 ]  / 100, nDec )
      nCalculo       -= Round( nCalculo * uAlbCliT[ 42 ]  / 100, nDec )

      lIvaInc        := uAlbCliT[ 57 ]

   case ValType( uAlbCliT ) == "C"
      nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDtoEsp / 100, nDec )
      nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDpp    / 100, nDec )
      nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDtoUno / 100, nDec )
      nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDtoDos / 100, nDec )

      lIvaInc        := ( uAlbCliT )->lIvaInc

   case ValType( uAlbCliT ) == "O"
      nCalculo       -= Round( nCalculo * uAlbCliT:nDtoEsp / 100, nDec )
      nCalculo       -= Round( nCalculo * uAlbCliT:nDpp    / 100, nDec )
      nCalculo       -= Round( nCalculo * uAlbCliT:nDtoUno / 100, nDec )
      nCalculo       -= Round( nCalculo * uAlbCliT:nDtoDos / 100, nDec )

      lIvaInc        := uAlbCliT:lIvaInc

   end

   do case
   case IsArray( uAlbCliL )
      nIva           := uAlbCliL[ 11    ]

   case IsChar( uAlbCliL )
      nIva           := ( uAlbCliL )->nIva

   case IsObject( uAlbCliL )
      nIva           := uAlbCliL:nIva

   end

   if nIva <> 0
      if lIva
         if !lIvaInc
            nCalculo += Round( nCalculo * nIva / 100, nDec )
         end
      else
         if lIvaInc
            nCalculo -= Round( nCalculo / ( 100 / nIva  + 1 ), nDec )
         end
      end
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nImpLAlbCli( uAlbCliT, dbfAlbCliL, nDec, nRou, nVdv, lIva, lDto, lImpTrn, lPntVer, cPouDiv )

   local lIvaInc
   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRou == nil, nRou := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lIva == nil, lIva := .F., ) ;
   IIF( lDto == nil, lDto := .T., ) ;
   IIF( lPntVer == nil, lPntVer := .F., ) ;
   IIF( lImpTrn == nil, lImpTrn := .F., ) ;

   nCalculo          := nTotLAlbCli( dbfAlbCliL, nDec, nRou, nVdv, .T., lImpTrn, lPntVer )

   do case
   case ValType( uAlbCliT ) == "A"
      nCalculo       -= Round( nCalculo * uAlbCliT[ 36 ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uAlbCliT[ 38    ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uAlbCliT[ 40 ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uAlbCliT[ 42 ]  / 100, nRou )

      lIvaInc        := uAlbCliT[ 57 ]

   case ValType( uAlbCliT ) == "C"
      nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDtoEsp / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDpp    / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDtoUno / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uAlbCliT )->nDtoDos / 100, nRou )

      lIvaInc        := ( uAlbCliT )->lIvaInc

   case ValType( uAlbCliT ) == "O"
      nCalculo       -= Round( nCalculo * uAlbCliT:nDtoEsp / 100, nRou )
      nCalculo       -= Round( nCalculo * uAlbCliT:nDpp    / 100, nRou )
      nCalculo       -= Round( nCalculo * uAlbCliT:nDtoUno / 100, nRou )
      nCalculo       -= Round( nCalculo * uAlbCliT:nDtoDos / 100, nRou )

      lIvaInc        := uAlbCliT:lIvaInc

   end

   if ( dbfAlbCliL )->nIva <> 0
      if lIva
         if !lIvaInc
            nCalculo += Round( nCalculo * ( dbfAlbCliL )->nIva / 100, nRou )
         end
      else
         if lIvaInc
            nCalculo -= Round( nCalculo / ( 100 / ( dbfAlbCliL )->nIva  + 1 ), nRou )
         end
      end
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nPesLAlbCli( cAlbCliL )

    local nCalculo

   IIF( cAlbCliL == nil, cAlbCliL := dbfAlbCliL, ) ;

   if !( cAlbCliL )->lTotLin
      nCalculo       := Abs( nTotNAlbCli( cAlbCliL ) ) * ( cAlbCliL )->nPesoKg
   end

RETURN ( nCalculo )



FUNCTION nCosLAlbCli( dbfLine, nDec, nRec, nVdv, cPouDiv )

   local nCalculo       := 0

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRec == nil, nRec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   if !( dbfLine )->lKitChl
      nCalculo          := nTotNAlbCli( dbfLine )
      nCalculo          *= ( dbfLine )->nCosDiv
   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

   nCalculo             := Round( nCalculo, nRec )

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )







FUNCTION nTotIAlbCli( dbfLin, nDec, nRouDec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( dbfLin == nil, dbfLin := dbfAlbCliL, ) ;
   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRouDec == nil, nRouDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   if !( dbfLin )->lTotLin





      nCalculo       := Round( ( dbfLin )->nValImp, nDec )





      nCalculo       *= nTotNAlbCli( dbfLin )

         if ( dbfLin )->LVOLIMP
            nCalculo *= NotCero( ( dbfLin )->nVolumen )
         end

      nCalculo       := Round( nCalculo / nVdv, nRouDec )

   end

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nTrnLAlbCli( dbfLin, nDec, nRou, nVdv )

   local nImpTrn

   IIF( dbfLin == nil, dbfLin := dbfAlbCliL, ) ;
   IIF( nDec == nil, nDec := 2, ) ;
   IIF( nRou == nil, nRou := 2, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;





   nImpTrn           := nTrnUAlbCli( dbfLin, nDec ) * nTotNAlbCli( dbfLin )

   IF nVdv <> 0
      nImpTrn        := nImpTrn / nVdv
    end

RETURN ( Round( nImpTrn, nRou ) )



FUNCTION nTrnUAlbCli( dbfTmpLin, nDec, nVdv )

    local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := ( dbfTmpLin )->nImpTrn

    IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
    end

RETURN ( Round( nCalculo, nDec ) )



STATIC FUNCTION KillTrans()





   if !Empty( dbfTmpLin ) .AND. ( dbfTmpLin )->( Used() )
      ( dbfTmpLin )->( dbCloseArea() )
   end

   if !Empty( dbfTmpPgo ) .AND. ( dbfTmpPgo )->( Used() )
      ( dbfTmpPgo )->( dbCloseArea() )
   end

   if !Empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )
      ( dbfTmpInc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpDoc ) .AND. ( dbfTmpDoc )->( Used() )
      ( dbfTmpDoc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpSer ) .AND. ( dbfTmpSer )->( Used() )
      ( dbfTmpSer )->( dbCloseArea() )
   end

   dbfTmpLin      := nil
   dbfTmpInc      := nil
   dbfTmpDoc      := nil
   dbfTmpPgo      := nil
   dbfTmpSer      := nil

   dbfErase( cTmpLin )
   dbfErase( cTmpPgo )
   dbfErase( cTmpInc )
   dbfErase( cTmpDoc )
   dbfErase( cTmpSer )

   oStock:SetTmpAlbCliL()
   oStock:SetTmpAlbCliS()

RETURN NIL



STATIC FUNCTION BeginTrans( aTmp, nMode )

   local oError
   local oBlock
   local lErrors     := .F.
   local cDbfLin     := "ACliL"
   local cDbfInc     := "ACliI"
   local cDbfDoc     := "ACliD"
   local cDbfPgo     := "ACliP"
   local cDbfSer     := "ACliS"
   local cAlbaran

   CursorWait()

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      aNumPed        := {}
      cAlbaran       := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]

      cTmpLin        := cGetNewFileName( cPatTmp() + cDbfLin )
      cTmpInc        := cGetNewFileName( cPatTmp() + cDbfInc )
      cTmpDoc        := cGetNewFileName( cPatTmp() + cDbfDoc )
      cTmpPgo        := cGetNewFileName( cPatTmp() + cDbfPgo )
      cTmpSer        := cGetNewFileName( cPatTmp() + cDbfSer )

      do case
         case nMode == 1 .OR. nMode == 4

            nTotOld  := 0

         case nMode == 2

            nTotOld  := nTotAlb

      end





      dbCreate( cTmpLin, aSqlStruct( aColAlbCli() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpLin, cCheckArea( cDbfLin, @dbfTmpLin ), .F. )

      if !NetErr() .AND. ( dbfTmpLin )->( Used() )

         ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {|| !Deleted() } ) )
         ( dbfTmpLin )->( OrdCreate( cTmpLin, "nNumLin", "Str( nNumLin, 4 )", {|| Str( Field->nNumLin ) } ) )

         ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {|| !Deleted() } ) )
         ( dbfTmpLin )->( OrdCreate( cTmpLin, "nNumAlb", "Str( Recno() )", {|| Str( Recno() ) } ) )

         if ( dbfAlbCliL )->( dbSeek( cAlbaran ) )
            while ( ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb ) == cAlbaran .AND. !( dbfAlbCliL )->( eof() )
               dbPass( dbfAlbCliL, dbfTmpLin, .T. )
               ( dbfAlbCliL )->( dbSkip() )
            end
         end

         ( dbfTmpLin )->( dbGoTop() )

         oStock:SetTmpAlbCliL( dbfTmpLin )

      else

         lErrors           := .T.

      end





      dbCreate( cTmpPgo, aSqlStruct( aItmAlbPgo() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpPgo, cCheckArea( cDbfPgo, @dbfTmpPgo ), .F. )

      if !NetErr()

         ( dbfTmpPgo )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpPgo )->( OrdCreate( cTmpPgo, "nNumAlb", "Str( Recno() )", {|| Str( Recno() ) } ) )

         if ( dbfAlbCliP )->( dbSeek( cAlbaran ) )
            while ( ( dbfAlbCliP )->cSerAlb + Str( ( dbfAlbCliP )->nNumAlb ) + ( dbfAlbCliP )->cSufAlb ) == cAlbaran .AND. !( dbfAlbCliP )->( eof() )
               dbPass( dbfAlbCliP, dbfTmpPgo, .T. )
               ( dbfAlbCliP )->( dbSkip() )
            end
         end

         ( dbfTmpPgo )->( dbGoTop() )

      else

         lErrors     := .T.

      end





      dbCreate( cTmpInc, aSqlStruct( aIncAlbCli() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpInc, cCheckArea( cDbfInc, @dbfTmpInc ), .F. )

      if !NetErr()
         ( dbfTmpInc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpInc )->( ordCreate( cTmpInc, "nNumAlb", "Recno()", {|| Recno() } ) )

         if ( dbfAlbCliI )->( dbSeek( cAlbaran ) )
            while ( ( dbfAlbCliI )->cSerAlb + Str( ( dbfAlbCliI )->nNumAlb ) + ( dbfAlbCliI )->cSufAlb == cAlbaran ) .AND. ( dbfAlbCliI )->( !eof() )
               dbPass( dbfAlbCliI, dbfTmpInc, .T. )
               ( dbfAlbCliI )->( dbSkip() )
            end
         end

         ( dbfTmpInc )->( dbGoTop() )

      else

         lErrors     := .T.

      end





      dbCreate( cTmpDoc, aSqlStruct( aAlbCliDoc() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpDoc, cCheckArea( cDbfDoc, @dbfTmpDoc ), .F. )

      if !NetErr()

         ( dbfTmpDoc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpDoc )->( ordCreate( cTmpDoc, "nNumAlb", "Recno()", {|| Recno() } ) )

         if ( dbfAlbCliD )->( dbSeek( cAlbaran ) )
            while ( ( dbfAlbCliD )->cSerAlb + Str( ( dbfAlbCliD )->nNumAlb ) + ( dbfAlbCliD )->cSufAlb == cAlbaran ) .AND. ( dbfAlbCliD )->( !eof() )
               dbPass( dbfAlbCliD, dbfTmpDoc, .T. )
               ( dbfAlbCliD )->( dbSkip() )
            end
         end

         ( dbfTmpDoc )->( dbGoTop() )

      else

         lErrors     := .T.

      end





      dbCreate( cTmpSer, aSqlStruct( aSerAlbCli() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpSer, cCheckArea( cDbfSer, @dbfTmpSer ), .F. )

      if !( dbfTmpSer )->( NetErr() )

         ( dbfTmpSer )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpSer )->( OrdCreate( cTmpSer, "nNumLin", "Str( nNumLin, 4 ) + cRef", {|| Str( Field->nNumLin, 4 ) + Field->cRef } ) )

         if ( dbfAlbCliS )->( dbSeek( cAlbaran ) )
            while ( ( dbfAlbCliS )->cSerAlb + Str( ( dbfAlbCliS )->nNumAlb ) + ( dbfAlbCliS )->cSufAlb == cAlbaran ) .AND. !( dbfAlbCliS )->( eof() )
               dbPass( dbfAlbCliS, dbfTmpSer, .T. )
               ( dbfAlbCliS )->( dbSkip() )
            end
         end

         ( dbfTmpSer )->( dbGoTop() )

         oStock:SetTmpAlbCliS( dbfTmpSer )

      else

         lErrors     := .T.

      end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible crear tablas temporales." )

      KillTrans()

      lErrors        := .T.

   end

   ErrorBlock( oBlock )

   CursorWE()

Return ( lErrors )







Static Function RecalculaTotal( aTmpAlb )

   local nTotAlbCli     := nTotAlbCli( nil, dbfAlbCliT, dbfTmpLin, dbfIva, dbfDiv, aTmpAlb )
   local nEntAlbCli     := nPagAlbCli( nil, dbfTmpPgo, dbfDiv )

   if oBrwIva <> nil
      oBrwIva:Refresh()
   end

   if oGetNet <> nil
      oGetNet:SetText( Trans( nTotNet, cPorDiv ) )
   end

   if oGetIva <> NIL
      oGetIva:SetText( Trans( nTotIva, cPorDiv ) )
   end

   if oGetReq <> NIL
      oGetReq:SetText( Trans( nTotReq, cPorDiv ) )
   end

   if oGetIvm <> nil
      oGetIvm:SetText( Trans( nTotIvm, cPorDiv ) )
   end

   if oGetRnt <> nil
      oGetRnt:SetText( AllTrim( Trans( nTotRnt, cPorDiv ) + Space( 1 ) + AllTrim( cSimDiv( aTmpAlb[ 51 ], dbfDiv ) ) + " : " + AllTrim( Trans( nPctRnt, "999.99" ) ) + "%" ) )
   end

   if oGetPnt <> nil
      oGetPnt:SetText( Trans( nTotPnt, cPorDiv ) )
   end

   if oGetTrn <> nil
      oGetTrn:SetText( Trans( nTotTrn, cPorDiv ) )
   end

   if oGetTotal <> NIL
      oGetTotal:SetText( Trans( nTotAlb, cPorDiv ) )
   end

   if oTotAlbLin <> NIL
      oTotAlbLin:SetText( Trans( nTotAlb, cPorDiv ) )
   end

   if oGetAlb <> nil
      oGetAlb:SetText( Trans( nTotAlb, cPorDiv ) )
   end

   if oGetEnt <> nil
      oGetEnt:SetText( Trans( nTotPag, cPorDiv ) )
   end

   if oGetPdt <> nil
      oGetPdt:SetText( Trans( nTotAlb - nTotPag, cPorDiv ) )
   end

   if oGetAge <> nil
      oGetAge:SetText( Trans( nTotAge, cPorDiv ) )
   end

   if oGetPes <> nil
      oGetPes:cText( nTotPes )
   end

   if oGetDif <> nil
      oGetDif:cText( nTotDif )
   end

Return .T.







FUNCTION nPagAlbCli( cNumAlb, cAlbCliP, cDiv, cDivRet, lPic )

   local nRec
   local nOrd
   local cCodDiv
   local cPorDiv
   local nRouDiv

   public nTotPag       := 0

   IIF( cAlbCliP == nil, cAlbCliP := dbfAlbCliP, ) ;
   IIF( cDiv == nil, cDiv := dbfDiv, ) ;
   IIF( lPic == nil, lPic := .F., ) ;

   nRec                 := ( cAlbCliP )->( Recno() )
   nOrd                 := ( cAlbCliP )->( OrdSetFocus( "nNumAlb" ) )
   cCodDiv              := cDivEmp()
   cPorDiv              := cPorDiv( cCodDiv, cDiv )
   nRouDiv              := nRouDiv( cCodDiv, cDiv )

   if IsNil( cNumAlb )

      ( cAlbCliP )->( dbGoTop() )
      while !( cAlbCliP )->( Eof() )
         nTotPag        += nEntAlbCli( cAlbCliP, cDiv, cDivRet )
         ( cAlbCliP )->( dbSkip() )
      end

   else

      if ( cAlbCliP )->( dbSeek( cNumAlb ) )
         while ( cAlbCliP )->cSerAlb + Str( ( cAlbCliP )->nNumAlb ) + ( cAlbCliP )->cSufAlb == cNumAlb .AND. !( cAlbCliP )->( eof() )
            nTotPag     += nEntAlbCli( cAlbCliP, cDiv, cDivRet )
            ( cAlbCliP )->( dbSkip() )
         end
      end

   end

   ( cAlbCliP )->( OrdSetFocus( nOrd ) )
   ( cAlbCliP )->( dbGoTo( nRec ) )

   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      nTotPag           := nCnv2Div( nTotPag, cCodDiv, cDivRet, cDiv )
      cPorDiv           := cPorDiv( cDivRet, cDiv )
      nRouDiv           := nRouDiv( cDivRet, cDiv )
   end

   nTotPag              := Round( nTotPag, nRouDiv )

   if lPic
      nTotPag           := Trans( nTotPag, cPorDiv )
   end

RETURN ( nTotPag )



function nEntAlbCli( uAlbCliP, cDbfDiv, cDivRet, lPic )

   local cDivPgo
   local nRouDiv
   local cPorDiv
   local nTotRec

   IIF( uAlbCliP == nil, uAlbCliP := dbfAlbCliP, ) ;
   IIF( cDbfDiv == nil, cDbfDiv := dbfDiv, ) ;
   IIF( cDivRet == nil, cDivRet := cDivEmp(), ) ;
   IIF( lPic == nil, lPic := .F., ) ;

   if ValType( uAlbCliP ) == "O"
      cDivPgo        := uAlbCliP:cDivPgo
      nTotRec        := uAlbCliP:nImporte
   else
      cDivPgo        := ( uAlbCliP )->cDivPgo
      nTotRec        := ( uAlbCliP )->nImporte
   end

   nRouDiv           := nRouDiv( cDivPgo, cDbfDiv )
   cPorDiv           := cPorDiv( cDivPgo, cDbfDiv )

   nTotRec           := Round( nTotRec, nRouDiv )

   if cDivRet <> cDivPgo
      nRouDiv        := nRouDiv( cDivRet, cDbfDiv )
      cPorDiv        := cPorDiv( cDivRet, cDbfDiv )
      nTotRec        := nCnv2Div( nTotRec, cDivPgo, cDivRet, cDbfDiv )
   end

RETURN if( lPic, Trans( nTotRec, cPorDiv ), nTotRec )



STATIC FUNCTION LoaCli( aGet, aTmp, nMode, oRieCli, oTlfCli )

   local lValid      := .T.
   local cNewCodCli  := aGet[ 6 ]:varGet()
   local lChgCodCli  := ( Empty( cOldCodCli ) .OR. cOldCodCli <> cNewCodCli )

    IF Empty( cNewCodCli )
      Return .T.
    ELSEIF At( ".", cNewCodCli ) <> 0
      cNewCodCli     := PntReplace( aGet[6], "0", RetNumCodCliEmp() )
    ELSE
      cNewCodCli     := Rjust( cNewCodCli, "0", RetNumCodCliEmp() )
    end





   if ( dbfClient )->( dbSeek( cNewCodCli ) )





      aGet[ 6 ]:cText( ( dbfClient )->Cod )

      if oTlfCli <> nil
         oTlfCli:SetText( ( dbfClient )->Telefono )
      end





      if ( dbfClient )->nColor <> 0
         aGet[9]:SetColor( , ( dbfClient )->nColor )
      end

      if Empty( aGet[9]:varGet() ) .OR. lChgCodCli
         aGet[9]:cText( ( dbfClient )->Titulo )
      end

      if Empty( aGet[10]:varGet() ) .OR. lChgCodCli
         aGet[10]:cText( ( dbfClient )->Domicilio )
      end

      if Empty( aGet[ 86 ]:varGet() ) .OR. lChgCodCli
         aGet[ 86 ]:cText( ( dbfClient )->Telefono )
      end

      if Empty( aGet[11]:varGet() ) .OR. lChgCodCli
         aGet[11]:cText( ( dbfClient )->Poblacion )
      end

      if !Empty( aGet[12] )
         if Empty( aGet[12]:varGet() ) .OR. lChgCodCli
            aGet[12]:cText( ( dbfClient )->Provincia )
         end
      end

      if !Empty( aGet[13] )
         if Empty( aGet[13]:varGet() ) .OR. lChgCodCli
            aGet[13]:cText( ( dbfClient )->CodPostal )
         end
      end

      if !Empty( aGet[14] )
         if Empty( aGet[14]:varGet() ) .OR. lChgCodCli
            aGet[14]:cText( ( dbfClient )->Nif )
         end
      end

      if Empty( aTmp[72] ) .OR. lChgCodCli
         aTmp[72]    := ( dbfClient )->cCodGrp
      end

      if ( lChgCodCli )





         if oRieCli <> nil
            oStock:SetRiesgo( cNewCodCli, oRieCli, ( dbfClient )->Riesgo )
         end

         aTmp[ 15 ]  := ( dbfClient )->lModDat

      end

      if ( lChgCodCli )
         aTmp[ 92 ]  := ( dbfClient )->lPntVer
      end

      if nMode == 1

         aTmp[ 58 ]  := ( dbfClient )->nRegIva





         if Empty( aTmp[ 1 ] )

            if !Empty( ( dbfClient )->Serie )
               aGet[ 1 ]:cText( ( dbfClient )->Serie )
            end

         else



            if !Empty( ( dbfClient )->Serie )                .AND. aTmp[ 1 ] <> ( dbfClient )->Serie      .AND. ApoloMsgNoYes( "La serie del cliente seleccionado es distinta a la anterior.", "¿Desea cambiar la serie?" )
               aGet[ 1 ]:cText( ( dbfClient )->Serie )
            end

         end

         if !Empty( aGet[7] )
            if ( Empty( aGet[7]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodAlm )
                aGet[7]:cText( ( dbfClient )->cCodAlm )
                aGet[7]:lValid()
            end
         end

         if !Empty( aGet[28] )
            if ( Empty( aGet[28]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodTar )
               aGet[28]:cText( ( dbfClient )->CCODTAR )
               aGet[28]:lValid()
            end
         end

         if ( Empty( aGet[23]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->CodPago )
            aGet[23]:cText( (dbfClient)->CODPAGO )
            aGet[23]:lValid()
         end





         if ( lChgCodCli .AND. lBancoDefecto( ( dbfClient )->Cod, dbfCliBnc ) )

            if !Empty( aGet[ 93 ] )
               aGet[ 93 ]:cText( ( dbfCliBnc )->cCodBnc )
               aGet[ 93 ]:lValid()
            end

            if !Empty( aGet[ 94 ] )
               aGet[ 94 ]:cText( ( dbfCliBnc )->cEntBnc )
               aGet[ 94 ]:lValid()
            end

            if !Empty( aGet[ 95 ] )
               aGet[ 95 ]:cText( ( dbfCliBnc )->cSucBnc )
               aGet[ 95 ]:lValid()
            end

            if !Empty( aGet[ 96 ] )
               aGet[ 96 ]:cText( ( dbfCliBnc )->cDigBnc )
               aGet[ 96 ]:lValid()
            end

            if !Empty( aGet[ 97 ] )
               aGet[ 97 ]:cText( ( dbfCliBnc )->cCtaBnc )
               aGet[ 97 ]:lValid()
            end

         end

         if !Empty( aGet[26] )
            if ( Empty( aGet[26]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cAgente )
                aGet[26]:cText( (dbfClient)->CAGENTE )
                aGet[26]:lValid()
            end
         end

         if ( Empty( aGet[29]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodRut )
            aGet[29]:cText( ( dbfClient)->CCODRUT )
            aGet[29]:lValid()
         end

         if ( Empty( aGet[ 34 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->nTarifa )
             aGet[ 34 ]:cText( ( dbfClient )->nTarifa )
         end

         if !Empty( aGet[ 65 ] ) .AND. ( Empty( aGet[ 65 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodTrn )
            aGet[ 65 ]:cText( ( dbfClient )->cCodTrn )
            aGet[ 65 ]:lValid()
         end


         if lChgCodCli

            aGet[ 48 ]:Click( ( dbfClient )->lReq ):Refresh()

            aGet[ 92  ]:Click( ( dbfClient )->lPntVer ):Refresh()





















            if !Empty( aGet[ 35 ] )
               aGet[ 35 ]:cText( ( dbfClient )->cDtoEsp )
            else
               aTmp[ 35 ]  := ( dbfClient )->cDtoEsp
            end

            if !Empty( aGet[ 36 ] )
               aGet[ 36 ]:cText( ( dbfClient )->nDtoEsp )
            else
               aTmp[ 36 ]  := ( dbfClient )->nDtoEsp
            end

            if !Empty( aGet[ 37    ] )
               aGet[ 37    ]:cText( ( dbfClient )->cDpp )
            else
               aTmp[ 37    ]  := ( dbfClient )->cDpp
            end

            if !Empty( aGet[ 38    ] )
               aGet[ 38    ]:cText( ( dbfClient )->nDpp )
            else
               aTmp[ 38    ]  := ( dbfClient )->nDpp
            end

            if !Empty( aGet[ 39 ] )
               aGet[ 39 ]:cText( ( dbfClient )->cDtoUno )
            else
               aTmp[ 39 ]  := ( dbfClient )->cDtoUno
            end

            if !Empty( aGet[ 41 ] )
               aGet[ 41 ]:cText( ( dbfClient )->cDtoDos )
            else
               aTmp[ 41 ]  := ( dbfClient )->cDtoDos
            end

            if !Empty( aGet[ 40 ] )
               aGet[ 40 ]:cText( ( dbfClient )->nDtoCnt )
            else
               aTmp[ 40 ]  := ( dbfClient )->nDtoCnt
            end

            if !Empty( aGet[ 42 ] )
               aGet[ 42 ]:cText( ( dbfClient )->nDtoRap )
            else
               aTmp[ 42 ]  := ( dbfClient )->nDtoRap
            end

            aTmp[ 78 ]  := ( dbfClient )->nSbrAtp

            aTmp[ 77 ]  := ( dbfClient )->nDtoAtp

         end

      end

      if lChgCodCli

         if ( dbfClient )->lMosCom .AND. !Empty( ( dbfClient )->mComent )
            MsgStop( Trim( ( dbfClient )->mComent ) )
         end


         ShowInciCliente( ( dbfClient )->Cod, dbfCliInc )


         if ( dbfClient )->lBlqCli
            msgStop( "Cliente bloqueado, no se pueden realizar operaciones de venta" , "Imposible archivar como albarán" )
         end

         if !( dbfClient )->lChgPre
            msgStop( "Este cliente no tiene autorización para venta a credito", "Imposible archivar como albarán" )
         end



      end

      cOldCodCli  := ( dbfClient )->Cod

      lValid      := .T.

    ELSE

        msgStop( "Cliente no encontrado" )

      lValid      := .F.

    end

RETURN lValid







STATIC FUNCTION SetDlgMode( aTmp, aGet, oFld, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oStkAct, oGet2, oTotal, aTmpAlb, oRentLin )

   if !lUseCaj()
      aGet[ 12 ]:Hide()
   else
      if !Empty( aGet[ 12 ] )
         aGet[ 12 ]:SetText( cNombreCajas() )
      end
   end

   aGet[ 19 ]:SetText( cNombreUnidades() )

   if aGet[ 40 ] <> nil

      if !uFieldEmpresa( "lUseImp" )
         aGet[ 40 ]:Hide()
      else
         if !uFieldEmpresa( "lModImp" )
            aGet[ 40 ]:Disable()
         end
      end

   end

   if !lTipMov()

      if !Empty( aGet[ 22 ] )
         aGet[ 22 ]:hide()
      end

      if !Empty( oGet2 )
         oGet2:hide()
      end

   end

   if aGet[ 8 ] <> nil
      if !uFieldEmpresa( "lUsePor", .F. )
         aGet[ 8 ]:Hide()
      end
   end

   if aGet[ 7 ] <> nil
      if !uFieldEmpresa( "lUsePnt", .F. ) .OR. !aTmpAlb[ 92 ]
         aGet[ 7 ]:Hide()
      end
   end

   if aGet[ 33 ] <> nil
      if !uFieldEmpresa( "lDtoLin", .F. )
         aGet[ 33 ]:Hide()
      end
   end


   if oRentLin <> nil .AND. oUser():lNotRentabilidad()
      oRentLin:Hide()
   end

   if aTmp[ 71 ]
      aGet[ 6 ]:Hide()
      aGet[ 70  ]:Show()
   end

   do case
   case nMode == 1

      aTmp[ 4    ]  := Space( 32 )
      aTmp[ 39 ]  := aTmpAlb[ 57 ]

      aGet[ 12 ]:cText( 1 )
      aGet[ 19]:cText( 1 )

      if !Empty( aGet[ 34 ] )
         aGet[ 34 ]:cText( nLastNum( dbfTmpLin )  )
      end

      aGet[ 38 ]:cText( aTmpAlb[ 7 ] )

      if lTipMov() .AND. aGet[ 22 ] <> nil
         aGet[ 22 ]:cText( cDefVta() )
      end

      if !Empty( aGet[ 14] )
         aGet[ 14]:Click( .F. )
      end

      if !Empty( oStkAct )

         if !uFieldEmpresa( "lNStkAct" )
            oStkAct:Show()
            oStkAct:cText( 0 )
         else
            oStkAct:Hide()
         end

      end

      aGet[ 5]:Show()
      aGet[ 23 ]:Hide()

      if !Empty( aGet[ 44 ] )
         aGet[ 44 ]:Hide()
      end

      if !Empty( aGet[ 45 ] )
         aGet[ 45 ]:Hide()
      end

      if aTmpAlb[ 58 ] <= 1
         aGet[ 11 ]:cText( nIva( dbfIva, cDefIva() ) )
      end

   case ( nMode == 4 .OR. nMode == 2 .OR. nMode == 3 )

      if aTmp[ 42 ]

         if !Empty( aGet[ 44 ] )
            aGet[ 44 ]:Show()
         end

         if !Empty( aGet[ 45 ] )
            aGet[ 45 ]:Show()
         end

      else

         if !Empty( aGet[ 44 ] )
             aGet[ 44 ]:Hide()
         end

         if !Empty( aGet[ 45 ] )
            aGet[ 45 ]:Hide()
         end

      end

      if !Empty( aTmp[4] )
         aGet[ 5 ]:show()
         aGet[ 23  ]:hide()
      else
         aGet[ 5 ]:hide()
         aGet[ 23  ]:show()
      end

   if !Empty( oStock )

      oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 38 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 44 ], aTmp[ 46 ], aTmp[ 35 ], oStkAct )

      if uFieldEmpresa( "lNStkAct" )
         oStkAct:Hide()
      end

   end

   end

   if !Empty( aTmp[28 ] )

      if !Empty( aGet[ 30 ] )
         aGet[ 30 ]:Show()
         aGet[ 30 ]:lValid()
      end
      if !Empty( oSayPr1 )
         oSayPr1:Show()
         oSayPr1:SetText( retProp( aTmp[28], dbfPro ) )
      end
      if !Empty( oSayVp1 )
         oSayVp1:Show()
      end

   else

      if !Empty( aGet[ 30 ] )
         aGet[30 ]:hide()
      end
      if !Empty( oSayPr1 )
         oSayPr1:hide()
      end
      if !Empty( oSayVp1 )
         oSayVp1:hide()
      end

   end

   if !Empty( aTmp[29 ] )

      if !Empty( aGet[ 31 ] )
         aGet[ 31 ]:Show()
         aGet[ 31 ]:lValid()
      end
      if !Empty( oSayPr2 )
         oSayPr2:Show()
         oSayPr2:SetText( retProp( aTmp[ 29 ], dbfPro ) )
      end
      if !Empty( oSayVp2 )
         oSayVp2:Show()
      end

   else

      if !Empty( aGet[ 31 ] )
         aGet[31 ]:hide()
      end
      if !Empty( oSayPr2 )
         oSayPr2:hide()
      end
      if !Empty( oSayVp2 )
         oSayVp2:hide()
      end

   end





   if !lAccArticulo() .OR. oUser():lNotCostos()

      if !Empty( aGet[ 36 ] )
         aGet[ 36 ]:Hide()
      end

   end





   if ( Empty( aTmp[ 6 ] ) .OR. lUsrMaster() .OR. oUser():lCambiarPrecio() ) .AND. nMode <> 3

      if !Empty( aGet[ 6 ] )
         aGet[ 6 ]:HardEnable()
      end

      aGet[ 8 ]:HardEnable()

      if !Empty( aGet[ 7 ] )
         aGet[ 7 ]:HardEnable()
      end

      aGet[ 9     ]:HardEnable()
      aGet[ 10  ]:HardEnable()

      if !Empty( aGet[ 33 ] )
         aGet[ 33  ]:HardEnable()
      end

   else

      aGet[ 6 ]:HardDisable()
      aGet[ 8  ]:HardDisable()

      if !Empty( aGet[ 7 ] )
         aGet[ 7  ]:HardDisable()
      end

      aGet[ 9     ]:HardDisable()
      aGet[ 10  ]:HardDisable()

      if !Empty( aGet[ 33  ] )
          aGet[ 33 ]:HardDisable()
      end

   end





   if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ] )
      aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:Hide()
   end

   if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ] )
      aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:Hide()
   end

   if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ] )
      aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:Hide()
   end

   if oUndMedicion:oDbf:Seek( aTmp[ 17 ] )

      if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( dbfAlbCliL )->( fieldpos( "nMedUno" ) ) ]:Show()
      end

      if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( dbfAlbCliL )->( fieldpos( "nMedDos" ) ) ]:Show()
      end

      if !Empty( aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( dbfAlbCliL )->( fieldpos( "nMedTre" ) ) ]:Show()
      end

   end





   if Empty( aTmp[ 76 ] )
      if !Empty( aGet[ 76 ] )
         aGet[ 76 ]:cText( aTmpAlb[ 34 ] )
      else
         aTmp[ 76 ]     := aTmpAlb[ 34 ]
      end
   end

   if !Empty( aGet[ 76 ] )
      if !uFieldEmpresa( "lPreLin" )
         aGet[ 76 ]:Hide()
      else
         aGet[ 76 ]:Show()
      end
   end





   if !Empty( oFld )
      oFld:SetOption( 1 )
   end

   if !Empty( oTotal )
      oTotal:cText( 0 )
   end

   if !Empty( aGet[ 22 ] )
      aGet[ 22 ]:lValid()
   end

   if !Empty( aGet[ 38 ] )
      aGet[ 38 ]:lValid()
   end

Return nil







STATIC FUNCTION lCalcDeta( aTmp, aTmpAlb, nDouDiv, oTotal, oMargen, cCodDiv, lTotal )

   local nCalculo
   local nUnidades
   local nCosto
   local nMargen
   local nRentabilidad
   local nBase    := 0

   IIF( lTotal == nil, lTotal := .F., ) ;

   if aTmp[ 71 ]
      nCalculo    := aTmp[ 70  ]
   else
      nCalculo    := aTmp[ 6  ]
   end

   nCalculo       -= aTmp[ 33  ]





   nUnidades      := nTotNAlbCli( aTmp )





   if !aTmp[ 39 ]
      if aTmp[ 92 ]
         nCalculo += aTmp[ 40 ] * NotCero( aTmp[ 66 ] )
      else
         nCalculo += aTmp[ 40 ]
      end
   end

   nCalculo       *= nUnidades





   if aTmp[ 8 ] <> 0
      nCalculo     += aTmp[ 8 ] * nUnidades
   end





   if aTmp[ 9    ] <> 0
      nCalculo    -= nCalculo * aTmp[ 9    ] / 100
   end

   if aTmp[ 10 ] <> 0
      nCalculo    -= nCalculo * aTmp[ 10 ] / 100
   end





   nCosto            := nUnidades * aTmp[ 36 ]

   if aTmp[ 39 ] .AND. aTmp[ 11 ] <> 0
      nMargen        := nCalculo - Round( nCalculo / ( 100 / aTmp[ 11 ] + 1 ), nRouDiv )
   else
      nMargen        := nCalculo
   end

   nBase             := nMargen

   nMargen           -= nCosto

   if nCalculo == 0
      nRentabilidad  := 0
   else
      nRentabilidad  := nRentabilidad( nCalculo, 0, nCosto )
   end





   if aTmpAlb[ 92 ]
      nCalculo       += nUnidades * aTmp[ 7 ]
   end

   if !Empty( oTotal )
      oTotal:cText( Round( nCalculo, nDouDiv ) )
   end

   if oMargen <> nil
      oMargen:cText( AllTrim( Trans( nMargen, cPorDiv ) + AllTrim( cSimDiv( cCodDiv, dbfDiv ) ) + " : " + AllTrim( Trans( nRentabilidad, "999.99" ) ) + "%" ) )
   end

   if !Empty( oComisionLinea )
      oComisionLinea:cText( Round( ( nBase * aTmp[ 18 ] / 100 ), nRouDiv ) )
   end

RETURN ( if( !lTotal, .T., nCalculo ) )



FUNCTION nDtoUAlbCli( dbfTmpLin, nDec, nVdv )

   local nCalculo := ( dbfTmpLin )->nDtoDiv

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

    IF nVdv <> 0
      nCalculo    := ( dbfTmpLin )->nDtoDiv / nVdv
    end

RETURN ( round( nCalculo, nDec ) )







STATIC FUNCTION AppDeta( oBrwLin, bEdtDet, aTmpAlb, lTot, nMode, cCodArt )

   IIF( lTot == nil, lTot := .F., ) ;

   WinAppRec( oBrwLin, bEdtDet, dbfTmpLin, lTot, cCodArt, aTmpAlb )

RETURN ( RecalculaTotal( aTmpAlb ) )



function nTotFAlbCli( cCodArt, dbfAlbCliT, dbfAlbCliL )

   local nTotVta        := 0
   local nRecno         := ( dbfAlbCliL )->( Recno() )

   if ( dbfAlbCliL )->( dbSeek( cCodArt ) )

      while ( dbfAlbCliL )->cRef == cCodArt .AND. !( dbfAlbCliL )->( eof() )

         If !( dbfAlbCliL )->lTotLin .AND. !lFacAlbCli( ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumFac ) + ( dbfAlbCliL )->cSufAlb, dbfAlbCliT )
            nTotVta     += nTotNAlbCli( dbfAlbCliL )
         end

         ( dbfAlbCliL )->( dbSkip() )

      end

   end

   ( dbfAlbCliL )->( dbGoTo( nRecno ) )

return ( nTotVta )



FUNCTION lFacAlbCli( cAlbCli, uAlbCliT )

   local lFacAlb  := .F.

   if ValType( uAlbCliT ) == "C"

      if ( uAlbCliT )->( dbSeek( cAlbCli ) )
         lFacAlb  := ( uAlbCliT )->lFacturado
      end

   else

      if uAlbCliT:Seek( cAlbCli )
         lFacAlb  := uAlbCliT:lFacturado
      end

   end

RETURN ( lFacAlb )



STATIC FUNCTION LoaArt( cCodArt, aTmp, aGet, aTmpAlb, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, lFocused )

   local nDtoAge
   local cCodFam
   local cPrpArt
   local nCosPro
   local nPrePro     := 0
   local nImpAtp     := 0
   local nImpOfe     := 0
   local lChgCodArt  := ( Empty( cOldCodArt ) .OR. Rtrim( cOldCodArt ) <> Rtrim( cCodArt ) )
   local nPosComa
   local cProveedor
   local nTarOld     := aTmp[ 76 ]
   local nNumDto     := 0

   IIF( lFocused == nil, lFocused := .T., ) ;

   if Empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir líneas sin codificar" )
         return .F.
      end

      if Empty( aTmp[ 11 ] )
         aGet[ 11 ]:bWhen      := {|| .T. }
      end

      if !Empty( aGet[ 5 ] )
          aGet[ 5 ]:cText( Space( 50 ) )
      end

      aGet[5]:bWhen      := {|| .T. }
      aGet[5]:Hide()

      if !Empty( aGet[ 23 ] )
          aGet[ 23 ]:Show()
      end

      if lFocused .AND. !Empty( aGet[ 23 ] )
        aGet[ 23 ]:SetFocus()
      end

   else

      if lModIva()
         aGet[ 11 ]:bWhen      := {|| .T. }
      else
         aGet[ 11 ]:bWhen      := {|| .F. }
      end





      if "," $ cCodArt
         nPosComa                := At( ",", cCodArt )
         cProveedor              := RJust( Left( cCodArt, nPosComa - 1 ), "0", RetNumCodPrvEmp() )
         cCodArt                 := cSeekProveedor( cCodArt, dbfArtPrv )
      else
         cCodArt                 := cSeekCodebar( cCodArt, dbfCodebar, dbfArticulo )
      end





      if ( dbfArticulo )->( dbSeek( cCodArt ) ) .OR. ( dbfArticulo )->( dbSeek( Upper( cCodArt ) ) )

         if ( dbfArticulo )->lObs
            MsgStop( "Artículo catalogado como obsoleto" )
            return .F.
         end

         if ( lChgCodArt )

            cCodArt              := ( dbfArticulo )->Codigo
            aTmp[ 4   ]      := cCodArt
            aGet[ 4   ]:cText( cCodArt )

            if ( dbfArticulo )->lMosCom .AND. !Empty( ( dbfArticulo )->mComent )
               MsgStop( Trim( ( dbfArticulo )->mComent ) )
            end

            if !Empty( cProveedor )
               aTmp[ 58 ]  := cProveedor
               aTmp[ 59 ]  := AllTrim( RetProvee( cProveedor ) )
               aTmp[ 65 ]  := Padr( cRefPrvArt( cCodArt, Padr( cProveedor, 12 ) , dbfArtPrv ), 18 )
            else
               aTmp[ 58 ]  := ( dbfArticulo )->cPrvHab
               aTmp[ 59 ]  := AllTrim( RetProvee( ( dbfArticulo )->cPrvHab ) )
               aTmp[ 65 ]  := Padr( cRefPrvArt( cCodArt, ( dbfArticulo )->cPrvHab , dbfArtPrv ), 18 )
            end

            aGet[5 ]:show()
            aGet[23  ]:hide()

            aGet[5 ]:cText( ( dbfArticulo )->Nombre )





            if aGet[ 23 ] <> nil
               aGet[ 23 ]:cText( ( dbfArticulo )->Descrip )
            else
               aTmp[ 23 ] := ( dbfArticulo )->Descrip
            end

            if !Empty( aGet[ 89 ] )
               aGet[ 89 ]:cText( ( dbfArticulo )->Descrip )
            else
               aTmp[ 89 ]     := ( dbfArticulo )->Descrip
            end






            if !Empty( aGet[ 15 ] )
               aGet[ 15  ]:cText( ( dbfArticulo )->nPesoKg )
            else
               aGet[ 15  ] := ( dbfArticulo )->nPesoKg
            end

            if !Empty( aGet[ 16 ] )
                aGet[ 16 ]:cText( ( dbfArticulo )->cUndDim )
            else
                aGet[ 16 ] := ( dbfArticulo )->cUndDim
            end

            if !Empty( aGet[ 66 ] )
               aGet[ 66 ]:cText( ( dbfArticulo )->nVolumen )
            else
               aGet[ 66 ] := ( dbfArticulo )->nVolumen
            end

            if !Empty( aGet[ 17 ] )
                aGet[ 17 ]:cText( ( dbfArticulo )->cUnidad )
                aGet[ 17 ]:lValid()
            else
                aTmp[ 17 ] := ( dbfArticulo )->cUnidad
            end

            if !Empty( aGet[ 67 ] )
                aGet[ 67 ]:cText( ( dbfArticulo )->cVolumen )
            else
                aTmp[ 67 ]:= ( dbfArticulo )->cVolumen
            end






            if ( dbfArticulo )->lLote

               if !Empty( aGet[ 44 ] )

                  aGet[ 44 ]:Show()

                  if Empty( aGet[ 44 ]:VarGet() )
                     aGet[ 44 ]:cText( ( dbfArticulo )->cLote )
                     aGet[ 44 ]:lValid()
                  end

               else

                  if Empty( aTmp[ 44 ] )
                     aTmp[ 44 ] := ( dbfArticulo )->cLote
                  end

               end

               aTmp[ 42 ] := ( dbfArticulo )->lLote

               if !Empty( aGet[ 45 ] )

                  aGet[ 45 ]:Show()

                  if Empty( aGet[ 45 ]:VarGet() )
                     aGet[ 45 ]:cText( dFechaCaducidadLote( aTmp[ 4 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 44 ], dbfAlbPrvL, dbfFacPrvL ) )
                  end

               end

            else

               if !Empty( aGet[ 44 ] )
                  aGet[ 44 ]:Hide()
               end

               if !Empty( aGet[ 45 ] )
                  aGet[ 45 ]:Hide()
               end

            end





            cCodFam              := ( dbfArticulo )->Familia

            if !Empty( cCodFam )

               if aGet[ 54 ] <> nil
                  aGet[ 54 ]:cText( cCodFam )
                  aGet[ 54 ]:lValid()
               else
                  aTmp[ 54 ]  := cCodFam
               end

               if aGet[ 55 ] <> nil
                  aGet[ 55 ]:cText( cGruFam( cCodFam, dbfFamilia ) )
                  aGet[ 55 ]:lValid()
               else
                  aTmp[ 55 ]  := cGruFam( cCodFam, dbfFamilia )
               end

               if aGet[ 87 ] <> nil
                  aGet[ 87 ]:cText( cCodFra( cCodFam, dbfFamilia ) )
                  aGet[ 87 ]:lValid()
               else
                  aTmp[ 87 ]  := cCodFra( cCodFam, dbfFamilia )
               end

            else

               if aGet[ 54 ] <> nil
                  aGet[ 54 ]:cText( Space( 8 ) )
                  aGet[ 54 ]:lValid()
               end

               if aGet[ 55 ] <> nil
                  aGet[ 55 ]:cText( Space( 3 ) )
                  aGet[ 55 ]:lValid()
               end

               if aGet[ 87 ] <> nil
                  aGet[ 87 ]:cText( Space( 3 ) )
                  aGet[ 87 ]:lValid()
               end

            end





            if ( dbfArticulo )->lKitArt

               aTmp[ 46 ]     := ( dbfArticulo )->lKitArt
               aTmp[ 25 ]     := lImprimirCompuesto( ( dbfArticulo )->Codigo, dbfArticulo )
               aTmp[ 48 ]     := lPreciosCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )

               if lStockCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )

                  if aGet[ 35 ] <> nil
                     aGet[ 35 ]:SetOption( ( dbfArticulo )->nCtlStock )
                  else
                     aTmp[ 35 ]  := ( dbfArticulo )->nCtlStock
                  end

               else

                  if aGet[ 35 ] <> nil
                     aGet[ 35 ]:SetOption( 3 )
                  else
                     aTmp[ 35 ]  := 3
                  end

               end

            else

               aTmp[ 25 ]     := .F.

               if aGet[ 35 ] <> nil
                  aGet[ 35 ]:SetOption( ( dbfArticulo )->nCtlStock )
               else
                  aTmp[ 35 ]  := ( dbfArticulo )->nCtlStock
               end

            end





            if aTmpAlb[ 58 ] <= 1
               aGet[ 11 ]:cText( nIva( dbfIva, ( dbfArticulo )->TipoIva ) )
               aTmp[ 56 ]        := nReq( dbfIva, ( dbfArticulo )->TipoIva )
            end





            if !Empty( ( dbfArticulo )->cCodImp )
               aTmp[ 41 ]     := ( dbfArticulo )->cCodImp
               aGet[ 40 ]:cText( oNewImp:nValImp( ( dbfArticulo )->cCodImp ) )

               aTmp[ 92 ]     := RetFld( ( dbfArticulo )->cCodImp, oNewImp:oDbf:cAlias, "lIvaVol" )

            end

            if ( dbfArticulo )->nCajEnt <> 0
               aGet[12 ]:cText( ( dbfArticulo )->nCajEnt )
            end

            if ( dbfArticulo )->nUniCaja <> 0
               aGet[19]:cText( ( dbfArticulo )->nUniCaja )
            end




            if !Empty( aGet[ 49 ] )
               aGet[ 49 ]:cText( ( dbfArticulo )->nMesGrt )
            end





            aGet[ 18 ]:cText( aTmpAlb[ 49 ] )





            if oStkAct <> nil .AND. aTmp[ 35 ] <= 1
               oStock:nPutStockActual( cCodArt, aTmp[ 38 ], , , , aTmp[ 46 ], aTmp[ 35 ], oStkAct )
            end





            aTmp[ 50 ]     := ( dbfArticulo )->lMsgVta
            aTmp[ 51 ]     := ( dbfArticulo )->lNotVta

            if ( dbfArticulo )->lFacCnv
               aTmp[ 32 ]  := ( dbfArticulo )->nFacCnv
            end





            if !Empty( aGet[53 ] )
               aGet[53 ]:cText( ( dbfArticulo )->cCodTip )
            end





            if !Empty( aGet[ 60 ] )
               aGet[ 60 ]:cText( ( dbfArticulo )->cImagen )
            else
               aTmp[ 60 ]     := ( dbfArticulo )->cImagen
            end

            if !Empty( bmpImage )
               if !Empty( aTmp[ 60 ] )
                  bmpImage:Show()
                  bmpImage:LoadBmp( cFileBitmap( cPatImg(), aTmp[ 60 ] ) )
               else
                  bmpImage:Hide()
               end
            end





            if !Empty( ( dbfArticulo )->cCodFra )

               if aGet[ 87 ] <> nil
                  aGet[ 87 ]:cText( ( dbfArticulo )->cCodFra )
                  aGet[ 87 ]:lValid()
               else
                  aTmp[ 87 ]  := ( dbfArticulo )->cCodFra
               end

            end





            aTmp[28 ]   := ( dbfArticulo )->cCodPrp1
            aTmp[29 ]   := ( dbfArticulo )->cCodPrp2

            if !Empty( aTmp[ 28 ] )

               if aGet[ 30 ] <> nil
                  aGet[ 30 ]:Show()
                  if lFocused
                     aGet[ 30 ]:SetFocus()
                  end
               end

               if oSayPr1 <> nil
                  oSayPr1:SetText( retProp( ( dbfArticulo )->cCodPrp1, dbfPro ) )
                  oSayPr1:show()
               end

               if oSayVp1 <> nil
                  oSayVp1:SetText( "" )
                  oSayVp1:Show()
               end

            else

               if !Empty( aGet[ 30 ] )
                  aGet[ 30 ]:hide()
               end

               if !Empty( oSayPr1 )
                  oSayPr1:hide()
               end

               if !Empty( oSayVp1 )
                  oSayVp1:hide()
               end

            end

            if !empty( aTmp[ 29 ] )

               if aGet[ 31 ] <> nil
                  aGet[ 31 ]:show()
               end

               if oSayPr2 <> nil
                  oSayPr2:SetText( retProp( ( dbfArticulo )->cCodPrp2, dbfPro ) )
                  oSayPr2:show()
               end

               if oSayVp2 <> nil
                  oSayVp2:SetText( "" )
                  oSayVp2:Show()
               end

            else

               if !Empty( aGet[ 31 ] )
                  aGet[ 31 ]:hide()
               end

               if !Empty( oSayPr2 )
                  oSayPr2:hide()
               end

               if !Empty( oSayVp2 )
                  oSayVp2:hide()
               end

            end

         end






         cPrpArt              := aTmp[ 28 ] + aTmp[ 29 ] + aTmp[ 30 ] + aTmp[ 31 ]

         if ( lChgCodArt ) .OR. ( cPrpArt <> cOldPrpArt )



            if nMode == 1
               cCodFam        := RetFamArt( cCodArt, dbfArticulo )
            else
               cCodFam        := aTmp[54]
            end



            aTmp[37 ]      := ( dbfArticulo )->PvpRec

            if !Empty( aGet[7 ] )
                  aGet[7 ]:cText( ( dbfArticulo )->nPntVer1 )
            end





            if !uFieldEmpresa( "lCosAct" )
               nCosPro           := oStock:nCostoMedio( aTmp[ 4 ], aTmp[ 38 ], aTmp[ 28 ], aTmp[ 30 ], aTmp[ 29 ], aTmp[ 31 ] )
               if nCosPro == 0
                  nCosPro        := nCosto( aTmp[ 4 ], dbfArticulo, dbfKit, .F., , dbfDiv )
               end
            else
               nCosPro           := nCosto( aTmp[ 4 ], dbfArticulo, dbfKit, .F., , dbfDiv )
            end

            if aGet[ 36 ] <> nil
               aGet[ 36 ]:cText( nCosPro )
            else
               aTmp[ 36 ]  := nCosPro
            end





            nNumDto              := RetFld( aTmpAlb[ 6 ], dbfClient, "nDtoArt" )

            if nNumDto <> 0

               do case
                  case nNumDto == 1

                     if !Empty( aGet[ 9 ] )
                        aGet[ 9 ]:cText( ( dbfArticulo )->nDtoArt1 )
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt1
                     else
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt1
                     end

                  case nNumDto == 2

                     if !Empty( aGet[ 9 ] )
                        aGet[ 9 ]:cText( ( dbfArticulo )->nDtoArt2 )
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt2
                     else
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt2
                     end

                  case nNumDto == 3

                     if !Empty( aGet[ 9 ] )
                        aGet[ 9]:cText( ( dbfArticulo )->nDtoArt3 )
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt3
                     else
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt3
                     end

                  case nNumDto == 4

                     if !Empty( aGet[ 9 ] )
                        aGet[ 9 ]:cText( ( dbfArticulo )->nDtoArt4 )
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt4
                     else
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt4
                     end

                  case nNumDto == 5

                     if !Empty( aGet[ 9 ] )
                        aGet[ 9 ]:cText( ( dbfArticulo )->nDtoArt5 )
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt5
                     else
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt5
                     end

                  case nNumDto == 6

                     if !Empty( aGet[ 9 ] )
                        aGet[ 9]:cText( ( dbfArticulo )->nDtoArt6 )
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt6
                     else
                        aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt6
                     end

               end

            end





            if aTmp[ 9 ] == 0

               if !Empty( aGet[ 9 ] )
                  aGet[ 9 ]:cText( nDescuentoFamilia( cCodFam, dbfFamilia ) )
               else
                  aTmp[ 9 ]     := nDescuentoFamilia( cCodFam, dbfFamilia )
               end

            end





            if !Empty( aGet[ 17 ] )
               aGet[ 17 ]:cText( ( dbfArticulo )->cUnidad )
            else
               aTmp[ 17 ]  := ( dbfArticulo )->cUnidad
            end



            nPrePro           := nPrePro( aTmp[ 4 ], aTmp[ 28 ], aTmp[ 30 ], aTmp[ 29 ], aTmp[ 31 ], aTmp[ 76 ], aTmpAlb[ 57 ], dbfArtDiv, dbfTarPreL, aTmpAlb[28] )
            if nPrePro == 0
               if !Empty( aGet[ 6 ] )
                  aGet[ 6 ]:cText( nRetPreArt( aTmp[ 76 ], aTmpAlb[ 51 ], aTmpAlb[57], dbfArticulo, dbfDiv, dbfKit, dbfIva, , aGet[ 76 ] ) )
               end
            else
               aGet[ 6 ]:cText( nPrePro )
            end

            if aTmp[ 71 ]
               aGet[ 6 ]:cText( 0 )
               aGet[ 70 ]:cText( nPreAlq( aTmp[ 4 ], aTmp[ 76 ], aTmpAlb[57], dbfArticulo ) )
            end





            if !Empty( aTmpAlb[ 28 ] )





               nImpOfe     := RetPrcTar( cCodArt, aTmpAlb[ 28 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 31 ], dbfTarPreL, aTmp[ 76 ] )
               if nImpOfe  <> 0
                  aGet[ 6 ]:cText( nImpOfe )
               end



               nImpOfe     := RetPctTar( cCodArt, cCodFam, aTmpAlb[ 28 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 31 ], dbfTarPreL )
               if nImpOfe  <> 0
                  aGet[9    ]:cText( nImpOfe )
               end


               nImpOfe     := RetLinTar( cCodArt, cCodFam, aTmpAlb[28], aTmp[28], aTmp[29], aTmp[30], aTmp[31], dbfTarPreL )
               if nImpOfe  <> 0
                  aGet[33 ]:cText( nImpOfe )
               end



               nImpOfe     := RetComTar( cCodArt, cCodFam, aTmpAlb[28], aTmp[28], aTmp[29], aTmp[30], aTmp[31], aTmpAlb[26], dbfTarPreL, dbfTarPreS )

               if nImpOfe  <> 0
                  aGet[18 ]:cText( nImpOfe )
               end



               nImpOfe     := RetDtoPrm( cCodArt, cCodFam, aTmpAlb[28], aTmp[28], aTmp[29], aTmp[30], aTmp[31], aTmpAlb[5], dbfTarPreL )
               if nImpOfe  <> 0
                  aGet[10]:cText( nImpOfe )
               end



               nDtoAge     := RetDtoAge( cCodArt, cCodFam, aTmpAlb[28], aTmp[28], aTmp[29], aTmp[30], aTmp[31], aTmpAlb[5], aTmpAlb[26], dbfTarPreL, dbfTarPreS )
               if nDtoAge  <> 0
                  aGet[ 18 ]:cText( nDtoAge )
               end

            end





            do case

               case  lSeekAtpArt( aTmpAlb[ 6 ] + cCodArt, aTmp[ 28 ] + aTmp[ 29 ], aTmp[ 30 ] + aTmp[ 31 ], aTmpAlb[ 5 ], dbfCliAtp ) .AND. ( dbfCliAtp )->lAplAlb

                  nImpAtp     := nImpAtp( nTarOld, dbfCliAtp, , , aGet[ 76 ] )
                  if nImpAtp  <> 0
                     aGet[ 6 ]:cText( nImpAtp )
                  end





                  nImpAtp     := nDtoAtp( nTarOld, dbfCliAtp )
                  if nImpAtp  <> 0
                     aGet[ 9 ]:cText( nImpAtp )
                  end





                  if ( dbfCliAtp )->nDprArt <> 0
                     aGet[ 10 ]:cText( ( dbfCliAtp )->nDprArt )
                  end

                  if ( dbfCliAtp )->NCOMAGE <> 0
                     aGet[ 18 ]:cText( ( dbfCliAtp )->nComAge )
                  end

                  if ( dbfCliAtp )->nDtoDiv <> 0
                     aGet[ 33 ]:cText( ( dbfCliAtp )->nDtoDiv )
                  end




            case  lSeekAtpFam( aTmpAlb[ 6 ] + aTmp[ 54 ], aTmpAlb[ 5 ], dbfCliAtp ) .AND.  ( dbfCliAtp )->lAplAlb

                  if ( dbfCliAtp )->nDtoArt <> 0
                     aGet[9    ]:cText( ( dbfCliAtp )->nDtoArt )
                  end

                  if ( dbfCliAtp )->nDprArt <> 0
                     aGet[10 ]:cText( ( dbfCliAtp )->nDprArt )
                  end

                  if ( dbfCliAtp )->nComAge <> 0
                     aGet[18 ]:cText( ( dbfCliAtp )->nComAge )
                  end

                  if ( dbfCliAtp )->nDtoDiv <> 0
                     aGet[33]:cText( ( dbfCliAtp )->nDtoDiv )
                  end

            end























            if !IsPda()
               ValidaMedicion( aTmp, aGet )
            end


         end





         lBuscaOferta( cCodArt, aGet, aTmp, aTmpAlb, dbfOferta, dbfArticulo, dbfDiv, dbfKit, dbfIva  )





         cOldPrpArt     := cPrpArt
         cOldCodArt     := cCodArt





         if Empty( aTmp[ 6 ] ) .OR. lUsrMaster() .OR. oUser():lCambiarPrecio()
            if !Empty( aGet[ 6 ] )
                aGet[ 6 ]:HardEnable()
            end

             aGet[ 8  ]:HardEnable()

            if !Empty( aGet[ 7 ] )
               aGet[ 7  ]:HardEnable()
            end

            aGet[ 9     ]:HardEnable()
            aGet[ 10  ]:HardEnable()

            if !Empty( aGet[ 33 ] )
               aGet[ 33  ]:HardEnable()
            end

         else
            aGet[ 6 ]:HardDisable()
            aGet[ 8  ]:HardDisable()
            aGet[ 7  ]:HardDisable()
            aGet[ 9     ]:HardDisable()
            aGet[ 10  ]:HardDisable()
            aGet[ 33  ]:HardDisable()
         end

      else

         MsgStop( "Artículo no encontrado" )
         Return ( .F. )

      end

   end

RETURN ( .T. )



STATIC FUNCTION SaveDeta( aTmp, aTmpAlb, oFld, aGet, oBrw, bmpImage, oDlg, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGet2, oStkAct, nStkAct, oTotal, cCodArt, oBtn, oBtnSer )

   local aXbyStr
   local nTotUnd  := 0
   local aClo     := aClone( aTmp )

   oBtn:SetFocus()

   if !aGet[ 4 ]:lValid()
      return nil
   end

   if !lMoreIva( aTmp[11] )
      return nil
   end

   if Empty( aTmp[ 38 ] )
      MsgStop( "Código de almacen no puede estar vacio" )
      aGet[ 38 ]:SetFocus()
      Return nil
   end

   if !cAlmacen( aGet[ 38 ], dbfAlm )
      Return nil
   end





   if ( nMode == 1 ) .AND. RetFld( aTmp[ 4 ], dbfArticulo, "lNumSer" ) .AND. !( dbfTmpSer )->( dbSeek( Str( aTmp[ 34 ], 4 ) + aTmp[ 4 ] ) )
      MsgStop( "Tiene que introducir números de serie para este artículo." )
      oBtnSer:Click()
      Return .F.
   end

   if !Empty( aTmp[ 4 ] ) .AND. ( aTmp[ 51 ] .OR. aTmp[ 50 ] )

      nTotUnd     := nTotNAlbCli( aTmp )

      if nMode == 2
         nTotUnd  -= nTotNAlbCli( dbfTmpLin )
      end

      if nTotUnd  <> 0

         do case
            case ( nStkAct - nTotUnd ) < 0

               if aTmp[ 51 ]
                  MsgStop( "No hay stock suficiente, tenemos " + Alltrim( Trans( nStkAct, MasUnd() ) ) + " unidad(es) disponible(s)," + Chr(13)+Chr(10) + "en almacén " + aTmp[ 38 ] + "." )
                  return nil
               end

               if aTmp[ 50 ]
                  if !ApoloMsgNoYes( "No hay stock suficiente, tenemos " + Alltrim( Trans( nStkAct, MasUnd() ) ) + " unidad(es) disponible(s)," + Chr(13)+Chr(10) + " en almacén " + aTmp[ 38 ] + ".", "¿Desea continuar?" )
                     return nil
                  end
               end

            case ( nStkAct - nTotUnd ) < RetFld( aTmp[ 4 ], dbfArticulo, "nMinimo"  )

               if aTmp[ 50 ]
                  if !ApoloMsgNoYes( "El stock está por debajo del minimo.", "¿Desea continuar?" )
                     return nil
                  end
               end

         end

      end

   end

   aTmp[ 56 ]  := nPReq( dbfIva, aTmp[ 11 ] )

   if nMode == 1

      aTmp[ 4 ]  := cCodArt

      if aTmp[ 42 ]
         GraLotArt( aTmp[ 4 ], dbfArticulo, aTmp[ 44 ] )
      end





      aXbYStr        := nXbYAtipica( aTmp[ 4 ], aTmpAlb[ 6 ], aTmp[ 12 ], aTmp[ 19 ], aTmpAlb[ 5 ], dbfCliAtp )

      if aXbYStr[ 1 ] == 0





         if !aTmp[ 91 ]

            aXbyStr              := nXbYOferta( aTmp[ 4 ], aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmp[ 12 ], aTmp[ 19 ], aTmpAlb[ 5 ], dbfOferta, 1 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 91 ]  := .T.
            end

         end





         if !aTmp[ 91 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "FAMILIA", "CODIGO" ), aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmp[ 12 ], aTmp[ 19 ], aTmpAlb[ 5 ], dbfOferta, 2 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 91 ]  := .T.
            end

         end





         if !aTmp[ 91 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODTIP", "CODIGO" ), aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmp[ 12 ], aTmp[ 19 ], aTmpAlb[ 5 ], dbfOferta, 3 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 91 ]  := .T.
            end

         end





         if !aTmp[ 91 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODCATE", "CODIGO" ), aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmp[ 12 ], aTmp[ 19 ], aTmpAlb[ 5 ], dbfOferta, 4 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 91 ]  := .T.
            end

         end





         if !aTmp[ 91 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODTEMP", "CODIGO" ), aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmp[ 12 ], aTmp[ 19 ], aTmpAlb[ 5 ], dbfOferta, 5 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 91 ]  := .T.
            end

         end





         if !aTmp[ 91 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODFAB", "CODIGO" ), aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmp[ 12 ], aTmp[ 19 ], aTmpAlb[ 5 ], dbfOferta, 6 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 91 ]  := .T.
            end

         end

      end





      if aXbYStr[ 1 ] <> 0 .AND. aXbYStr[ 2 ] <> 0





         if aXbYStr[ 1 ] == 1





            aTmp[ 12  ] -= aXbYStr[ 2 ]
            aClo              := aClone( aTmp )

            WinGather( aTmp, , dbfTmpLin, oBrw, nMode, nil, .F. )

            if aClo[ 46 ]
               AppendKit( aClo, aTmpAlb )
            end





            aTmp[ 12  ] := aXbYStr[ 2 ]
            aTmp[ 6 ] := 0

            WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )

            if aClo[ 46 ]
               AppendKit( aClo, aTmpAlb )
            end

         else





            if aTmp[ 19 ] < 0
               aTmp[ 19 ] += aXbYStr[ 2 ]
            else
               aTmp[ 19 ] -= aXbYStr[ 2 ]
            end

            WinGather( aTmp, , dbfTmpLin, oBrw, nMode, nil, .F. )

            if aClo[ 46 ]
               AppendKit( aClo, aTmpAlb )
            end





            if aTmp[ 19 ] < 0
               aTmp[ 19 ] := -( aXbYStr[ 2 ] )
            else
               aTmp[ 19 ] := aXbYStr[ 2 ]
            end

            aTmp[ 6 ] := 0

            WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )

            if aClo[ 46 ]
               AppendKit( aClo, aTmpAlb )
            end

         end

      else





         WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )





         if aClo[ 46 ]
            AppendKit( aClo, aTmpAlb )
         end

      end

   else





      WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )

   end





   if !Empty( bmpImage )
       bmpImage:Hide()
   end

   if !Empty( bmpImage )
      PalBmpFree( bmpImage:hBitmap, bmpImage:hPalette )
   end

   cOldCodArt     := ""
   cOldUndMed     := ""

   if !Empty( aGet[ 17 ] )
      aGet[ 17 ]:lValid()
   end

   if nMode == 1 .AND. lEntCon()

      RecalculaTotal( aTmpAlb )

      SetDlgMode( aTmp, aGet, oFld, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oStkAct, oGet2, oTotal, aTmpAlb )

      SysRefresh()

      if !Empty( aGet[ 4 ] )
         aGet[ 4 ]:SetFocus()
      end

   else

      oDlg:End( 1 )

   end

RETURN NIL



STATIC FUNCTION AppendKit( uTmpLin, aTmpAlb )

   local cCodArt
   local cSerAlb
   local nNumAlb
   local cSufAlb
   local nCanEnt
   local dFecAlb
   local cTipMov
   local cAlmLin
   local nIvaLin
   local lIvaLin
   local nComAge
   local nUniCaj
   local nDtoGrl
   local nDtoPrm
   local nDtoDiv
   local cNumPed
   local nTarLin
   local nNumLin                       := ( dbfTmpLin )->nNumLin
   local nRecAct                       := ( dbfKit    )->( RecNo() )
   local nRecLin                       := ( dbfTmpLin )->( RecNo() )
   local nUnidades                     := 0
   local nStkActual                    := 0

   if ValType( uTmpLin ) == "A"
      cCodArt                          := uTmpLin[ 4    ]
      cSerAlb                          := uTmpLin[ 1 ]
      nNumAlb                          := uTmpLin[ 2 ]
      cSufAlb                          := uTmpLin[ 3 ]
      nCanEnt                          := uTmpLin[ 12 ]
      dFecAlb                          := uTmpLin[ 21  ]
      cTipMov                          := uTmpLin[ 22 ]
      cAlmLin                          := uTmpLin[ 38 ]
      nIvaLin                          := uTmpLin[ 11    ]
      lIvaLin                          := uTmpLin[ 39 ]
      nComAge                          := uTmpLin[ 18 ]
      nUniCaj                          := uTmpLin[ 19]
      nDtoGrl                          := uTmpLin[ 9    ]
      nDtoPrm                          := uTmpLin[ 10 ]
      nDtoDiv                          := uTmpLin[ 33 ]
      nNumLin                          := uTmpLin[ 34 ]
      cNumPed                          := uTmpLin[ 27]
      nTarLin                          := uTmpLin[ 76 ]
   else
      cCodArt                          := ( uTmpLin )->cRef
      cSerAlb                          := ( uTmpLin )->cSerAlb
      nNumAlb                          := ( uTmpLin )->nNumAlb
      cSufAlb                          := ( uTmpLin )->cSufAlb
      nCanEnt                          := ( uTmpLin )->nCanEnt
      dFecAlb                          := ( uTmpLin )->dFecha
      cTipMov                          := ( uTmpLin )->cTipMov
      cAlmLin                          := ( uTmpLin )->cAlmLin
      nIvaLin                          := ( uTmpLin )->nIva
      lIvaLin                          := ( uTmpLin )->lIvaLin
      nComAge                          := ( uTmpLin )->nComAge
      nUniCaj                          := ( uTmpLin )->nUniCaja
      nDtoGrl                          := ( uTmpLin )->nDto
      nDtoPrm                          := ( uTmpLin )->nDtoPrm
      nDtoDiv                          := ( uTmpLin )->nDtoDiv
      nNumLin                          := ( uTmpLin )->nNumLin
      cNumPed                          := ( uTmpLin )->cNumPed
      nTarLin                          := ( uTmpLin )->nTarLin
   end





   if ( dbfKit )->( dbSeek( cCodArt ) )

      while ( dbfKit )->cCodKit == cCodArt .AND. !( dbfKit )->( eof() )

         if ( dbfArticulo )->( dbSeek( ( dbfKit )->cRefKit ) )

            ( dbfTmpLin )->( dbAppend() )

            if lKitAsociado( cCodArt, dbfArticulo )
               ( dbfTmpLin )->nNumLin  := nLastNum( dbfTmpLin )
               ( dbfTmpLin )->lKitChl  := .F.
            else
               ( dbfTmpLin )->nNumLin  := nNumLin
               ( dbfTmpLin )->lKitChl  := .T.
            end

            ( dbfTmpLin )->cRef        := ( dbfKit      )->cRefKit
            ( dbfTmpLin )->cDetalle    := ( dbfArticulo )->Nombre
            ( dbfTmpLin )->nPntVer     := ( dbfArticulo )->nPntVer1
            ( dbfTmpLin )->nPesokg     := ( dbfArticulo )->nPesoKg
            ( dbfTmpLin )->cPesokg     := ( dbfArticulo )->cUndDim
            ( dbfTmpLin )->cUnidad     := ( dbfArticulo )->cUnidad
            ( dbfTmpLin )->nVolumen    := ( dbfArticulo )->nVolumen
            ( dbfTmpLin )->cVolumen    := ( dbfArticulo )->cVolumen
            ( dbfTmpLin )->nCtlStk     := ( dbfArticulo )->nCtlStock
            ( dbfTmpLin )->nPvpRec     := ( dbfArticulo )->PvpRec
            ( dbfTmpLin )->cCodImp     := ( dbfArticulo )->cCodImp
            ( dbfTmpLin )->lLote       := ( dbfArticulo )->lLote
            ( dbfTmpLin )->cLote       := ( dbfArticulo )->cLote

            ( dbfTmpLin )->nCosDiv     := nCosto( nil, dbfArticulo, dbfKit )
            ( dbfTmpLin )->nValImp     := oNewImp:nValImp( ( dbfArticulo )->cCodImp )

            if ( dbfArticulo )->lFacCnv
               ( dbfTmpLin )->nFacCnv  := ( dbfArticulo )->nFacCnv
            end

            ( dbfTmpLin )->cSerAlb     := cSerAlb
            ( dbfTmpLin )->nNumAlb     := nNumAlb
            ( dbfTmpLin )->cSufAlb     := cSufAlb
            ( dbfTmpLin )->nCanEnt     := nCanEnt
            ( dbfTmpLin )->dFecha      := dFecAlb
            ( dbfTmpLin )->cTipMov     := cTipMov
            ( dbfTmpLin )->cNumPed     := cNumPed
            ( dbfTmpLin )->nNumLin     := nNumLin
            ( dbfTmpLin )->cAlmLin     := cAlmLin
            ( dbfTmpLin )->lIvaLin     := lIvaLin





            ( dbfTmpLin )->lImpLin     := lImprimirComponente( cCodArt, dbfArticulo )
            ( dbfTmpLin )->lKitPrc     := lPreciosComponentes( cCodArt, dbfArticulo )

            ( dbfTmpLin )->nComAge     := nComAge
            ( dbfTmpLin )->nUniCaja    := nUniCaj * ( dbfKit )->nUndKit





            if !Empty( nIvaLin )
               ( dbfTmpLin )->nIva     := nIva( dbfIva, ( dbfArticulo )->TipoIva )
               ( dbfTmpLin )->nReq     := nReq( dbfIva, ( dbfArticulo )->TipoIva )
            else
               ( dbfTmpLin )->nIva     := 0
               ( dbfTmpLin )->nReq     := 0
            end





            if ( dbfTmpLin )->lKitPrc
               ( dbfTmpLin )->nPreUnit := nRetPreArt( nTarLin, aTmpAlb[ 51 ], aTmpAlb[ 57 ], dbfArticulo, dbfDiv, dbfKit, dbfIva )
            end





            if lStockComponentes( cCodArt, dbfArticulo )
               ( dbfTmpLin )->nCtlStk  := ( dbfArticulo )->nCtlStock
            else
               ( dbfTmpLin )->nCtlstk  := 3
            end





            if ( dbfKit )->lAplDto
               ( dbfTmpLin )->nDto     := nDtoGrl
               ( dbfTmpLin )->nDtoPrm  := nDtoPrm
               ( dbfTmpLin )->nDtoDiv  := nDtoDiv
            end

            if ( dbfArticulo )->lKitArt
               AppendKit( dbfTmpLin, aTmpAlb )
            end





            if ( dbfArticulo )->lMsgVta .AND. !uFieldEmpresa( "lNStkAct" )

               nStkActual     := oStock:nStockAlmacen( ( dbfKit )->cRefKit, cAlmLin )
               nUnidades      := nUniCaj * ( dbfKit )->nUndKit

               do case
                  case nStkActual - nUnidades < 0



                        MsgStop( "No hay stock suficiente para realizar la venta" + Chr(13)+Chr(10) +  "del componente " + AllTrim( ( dbfKit )->cRefKit ) + " - " + AllTrim( ( dbfArticulo )->Nombre ), "¡Atención!" )

                  case nStkActual - nUnidades < ( dbfArticulo)->nMinimo






                        MsgStop( "El stock del componente " + AllTrim( ( dbfKit )->cRefKit ) + " - " + AllTrim( ( dbfArticulo )->Nombre ) + Chr(13)+Chr(10) +  "está bajo minimo."                                                                                      + Chr(13)+Chr(10) +  "Unidades a vender : " + AllTrim( Trans( nUnidades, MasUnd() ) )                                         + Chr(13)+Chr(10) +  "Stock minimo : " + AllTrim( Trans( ( dbfArticulo)->nMinimo, MasUnd() ) )                                + Chr(13)+Chr(10) +  "Stock actual : " + AllTrim( Trans( nStkActual, MasUnd() ) ), "¡Atención!" )
               end

            end

         end

         ( dbfKit )->( dbSkip() )

      end

   end

   ( dbfKit    )->( dbGoTo( nRecAct ) )
   ( dbfTmpLin )->( dbGoTo( nRecLin ) )

RETURN NIL



STATIC FUNCTION lMoreIva( nCodIva )





   IF aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 3, 3 ] == nil
        RETURN .T.
    end

    IF aTotIva[ 1, 3 ] == nCodIva .OR. aTotIva[ 2, 3 ] == nCodIva .OR. aTotIva[ 3, 3 ] == nCodIva
        RETURN .T.
    end

   MsgStop( "Documento con mas de 3 Tipos de " + cImp() )

RETURN .F.







STATIC FUNCTION EdtDeta( oBrwLin, bEdtDet, aTmpAlb, lTot, nMode )

   WinEdtRec( oBrwLin, bEdtDet, dbfTmpLin, lTot, nMode, aTmpAlb )

RETURN ( RecalculaTotal( aTmpAlb ) )







STATIC FUNCTION DelDeta( oBrwLin )

   CursorWait()

   while ( dbfTmpSer )->( dbSeek( Str( ( dbfTmpLin )->nNumLin, 4 ) ) )
      ( dbfTmpSer )->( dbDelete() )
   end

   if ( dbfTmpLin )->lKitArt
      dbDelKit( oBrwLin, dbfTmpLin, ( dbfTmpLin )->nNumLin )
   end

   CursorWE()

RETURN ( .T. )



STATIC FUNCTION EndTrans( aTmp, aGet, oBrw, oBrwInc, nMode, oDlg )

   local aTabla
   local oError
   local oBlock
   local cSerAlb
   local nNumAlb
   local cSufAlb
   local cNumPed
   local aNumPed
   local dFecAlb

   if Empty( aTmp[ 1 ] )
      aTmp[ 1 ]  := "A"
   end

   cSerAlb              := aTmp[ 1 ]
   nNumAlb              := aTmp[ 2 ]
   cSufAlb              := aTmp[ 3 ]
   cNumPed              := aTmp[ 30 ]
   dFecAlb              := aTmp[ 5 ]






   if !lValidaOperacion( aTmp[ 5 ] )
      Return .F.
   end






   if Empty( aTmp[ 6 ] )
      msgStop( "Código de cliente no puede estar vacío." )
      aGet[ 6 ]:SetFocus()
      return .F.
   end

   if lCliBlq( aTmp[ 6 ], dbfClient )
      msgStop( "Cliente bloqueado, no se pueden realizar operaciones de venta" , "Imposible archivar como albarán" )
      aGet[ 6 ]:SetFocus()
      return .F.
   end

   if !lCliChg( aTmp[ 6 ], dbfClient )
      msgStop( "Este cliente no tiene autorización para venta a credito.", "Imposible archivar como albarán" )
      aGet[ 6 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 7 ] )
      msgStop( "Almacén no puede estar vacío." )
      aGet[ 7 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 8 ] )
      msgStop( "Caja no puede estar vacía." )
      aGet[ 8 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 23 ] )
      msgStop( "Forma de pago no puede estar vacía." )
      aGet[ 23 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 51 ] )
      MsgStop( "No puede almacenar documento sin código de divisa." )
      aGet[ 51 ]:SetFocus()
      return .F.
   end



   if Empty( aTmp[ 26 ] ) .AND. lRecogerAgentes()
      msgStop( "Agente no puede estar vacío." )
      aGet[ 26 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 27 ] ) .AND. lObras()
      MsgStop( "Debe de introducir una obra." )
      aGet[ 27 ]:SetFocus()
      return .F.
   end



   if ( dbfTmpLin )->( eof() )
      MsgStop( "No puede almacenar un documento sin líneas." )
      return .F.
   end

   if nTotDif < 0
      MsgStop( "La carga excede la capacidad del medio de transporte." )
   end

   CursorWait()

   oDlg:Disable()


   oMsgText( "Archivando" )


   oBlock      := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   BeginTransaction()





   ( dbfTmpLin )->( dbClearFilter() )


   if !( "PDA" $ cParamsMain() )
      oMsgProgress()
      oMsgProgress():SetRange( 0, ( dbfTmpLin )->( LastRec() ) )
   end






   aTmp[ 69 ]        := Date()
   aTmp[ 70 ]        := Time()





   if !Empty( oTipAlb ) .AND. oTipAlb:nAt == 2
      aTmp[ 82 ]   := .T.
   else
      aTmp[ 82 ]   := .F.
   end

   do case
   case nMode == 1 .OR. nMode == 4

      nNumAlb              := nNewDoc( aTmp[ 1 ], dbfAlbCliT, "NALBCLI", , dbfCount )
      aTmp[ 2 ]     := nNumAlb
      nTotOld              := 0

   case nMode == 2

      while ( dbfAlbCliL )->( dbSeek( cSerAlb + str( nNumAlb ) + cSufAlb ) ) .AND. !( dbfAlbCliL )->( eof() )
         if dbLock( dbfAlbCliL )
            ( dbfAlbCliL )->( dbDelete() )
            ( dbfAlbCliL )->( dbUnLock() )
         end
      end

      while ( dbfAlbCliP )->( dbSeek( cSerAlb + str( nNumAlb ) + cSufAlb ) ) .AND. !( dbfAlbCliP )->( eof() )
         if dbLock( dbfAlbCliP )
            ( dbfAlbCliP )->( dbDelete() )
            ( dbfAlbCliP )->( dbUnLock() )
         end
      end

      while ( dbfAlbCliI )->( dbSeek( cSerAlb + str( nNumAlb ) + cSufAlb ) ) .AND. !( dbfAlbCliI )->( eof() )
         if dbLock( dbfAlbCliI )
            ( dbfAlbCliI )->( dbDelete() )
            ( dbfAlbCliI )->( dbUnLock() )
         end
      end

      while ( dbfAlbCliD )->( dbSeek( cSerAlb + str( nNumAlb ) + cSufAlb ) ) .AND. !( dbfAlbCliD )->( eof() )
         if dbLock( dbfAlbCliD )
            ( dbfAlbCliD )->( dbDelete() )
            ( dbfAlbCliD )->( dbUnLock() )
         end
      end

      while ( dbfAlbCliS )->( dbSeek( cSerAlb + Str( nNumAlb ) + cSufAlb ) ) .AND. !( dbfAlbCliS )->( eof() )
         if dbLock( dbfAlbCliS )
            ( dbfAlbCliS )->( dbDelete() )
            ( dbfAlbCliS )->( dbUnLock() )
         end
      end

   end





   ( dbfTmpLin )->( dbGoTop() )
   while !( dbfTmpLin )->( eof() )

      ( dbfTmpLin )->dFecAlb  := aTmp[ 5 ]

      dbPass( dbfTmpLin, dbfAlbCliL, .T., cSerAlb, nNumAlb, cSufAlb )

      ( dbfTmpLin )->( dbSkip() )


      if !( "PDA" $ cParamsMain() )
         oMsgProgress():Deltapos(1)
      end


   end





   aTmp[ 87 ]     := nTotNet
   aTmp[ 88 ]     := nTotIva
   aTmp[ 89 ]     := nTotReq
   aTmp[ 90 ]     := nTotAlb
   aTmp[ 91 ]     := nTotPag

   WinGather( aTmp, , dbfAlbCliT, , nMode )











   ( dbfTmpPgo )->( dbGoTop() )
   while ( dbfTmpPgo )->( !eof() )
      dbPass( dbfTmpPgo, dbfAlbCliP, .T., cSerAlb, nNumAlb, cSufAlb )
      ( dbfTmpPgo )->( dbSkip() )
   end





   ( dbfTmpInc )->( dbGoTop() )
   while ( dbfTmpInc )->( !eof() )
      dbPass( dbfTmpInc, dbfAlbCliI, .T., cSerAlb, nNumAlb, cSufAlb )
      ( dbfTmpInc )->( dbSkip() )
   end





   ( dbfTmpDoc )->( dbGoTop() )
   while ( dbfTmpDoc )->( !eof() )
      dbPass( dbfTmpDoc, dbfAlbCliD, .T., cSerAlb, nNumAlb, cSufAlb )
      ( dbfTmpDoc )->( dbSkip() )
   end





   ( dbfTmpSer )->( dbGoTop() )
   while ( dbfTmpSer )->( !eof() )
      dbPass( dbfTmpSer, dbfAlbCliS, .T., cSerAlb, nNumAlb, cSufAlb, dFecAlb )
      ( dbfTmpSer )->( dbSkip() )
   end





   if !Empty( cNumPed )





      oStock:SetEstadoPedCli( cNumPed, .T., cSerAlb + Str( nNumAlb ) + cSufAlb )

      if ( dbfPedCliP )->( dbSeek( cNumPed ) )

         while ( dbfPedCliP )->cSerPed + Str( ( dbfPedCliP )->nNumPed ) + ( dbfPedCliP )->cSufPed == cNumPed .AND. !( dbfPedCliP )->( Eof() )

            if !( dbfPedCliP )->lPasado

               if dbLock( dbfPedCliP )
                  ( dbfPedCliP )->lPasado := .T.
                  ( dbfPedCliP )->( dbUnLock() )
               end

            end

            ( dbfPedCliP )->( dbSkip() )

         end

      end

   end





   if Len( aAlbaranes ) <> 0

      for each aNumPed in aAlbaranes

         oStock:SetEstadoPedCli( aNumPed[ 3 ], .T., cSerAlb + Str( nNumAlb ) + cSufAlb )

         if dbSeekInOrd( aNumPed[ 3 ], "nNumPed", dbfPedCliT )

            if dbLock( dbfPedCliT )
               ( dbfPedCliT )->cNumAlb    := cSerAlb + Str( nNumAlb ) + cSufAlb
               ( dbfPedCliT )->( dbUnLock() )
            end

         end

      next

   end





   dbCommitAll()

   CommitTransaction()

   RECOVER USING oError

      RollBackTransaction()


      msgStop( "Imposible almacenar documento" + Chr(13)+Chr(10) + ErrorMessage( oError ) )


   end
   ErrorBlock( oBlock )


   oMsgText()

   if !( "PDA" $ cParamsMain() )
      EndProgress()
   end


   oDlg:Enable()
   oDlg:End( 1 )

   CursorWE()

RETURN .T.



FUNCTION SetFacturadoAlbaranCliente( lFacturado, oBrw, cAlbCliT, cAlbCliL, cAlbCliS, cNumFac )

   local nOrd
   local nRec
   local nRecHead             := ( cAlbCliT )->( Recno() )

   IIF( lFacturado == nil, lFacturado := .F., ) ;
   IIF( cNumFac == nil, cNumFac := Space( 12 ), ) ;
   IIF( cAlbCliT == nil, cAlbCliT := dbfAlbCliT, ) ;
   IIF( cAlbCliL == nil, cAlbCliL := dbfAlbCliL, ) ;
   IIF( cAlbCliS == nil, cAlbCliS := dbfAlbCliS, ) ;

   if oBrw <> nil

      for each nRec in ( oBrw:aSelected )

         nRecHead             := nRec

         ( cAlbCliT )->( dbGoTo( nRec ) )





         if dbLock( cAlbCliT )
            ( cAlbCliT )->lFacturado := lFacturado
            ( cAlbCliT )->cNumFac    := cNumFac
            ( cAlbCliT )->( dbUnLock() )
         end





         nOrd                 := ( cAlbCliL )->( OrdSetFocus( "nNumAlb" ) )

         if ( cAlbCliL )->( dbSeek( ( cAlbCliT )->cSerAlb + Str( ( cAlbCliT )->nNumAlb ) + ( cAlbCliT )->cSufAlb ) )

            while ( cAlbCliT )->cSerAlb + Str( ( cAlbCliT )->nNumAlb ) + ( cAlbCliT )->cSufAlb == ( cAlbCliL )->cSerAlb + Str( ( cAlbCliL )->nNumAlb ) + ( cAlbCliL )->cSufAlb .AND. !( cAlbCliL )->( Eof() )

               if dbLock( cAlbCliL )
                  ( cAlbCliL )->lFacturado := lFacturado
                  ( cAlbCliL )->( dbUnlock() )
                end

               ( cAlbCliL )->( dbSkip() )

            end

         end

         ( cAlbCliL )->( OrdSetFocus( nOrd ) )





         nOrd                 := ( cAlbCliS )->( OrdSetFocus( "nNumAlb" ) )

         if ( cAlbCliS )->( dbSeek( ( cAlbCliT )->cSerAlb + Str( ( cAlbCliT )->nNumAlb ) + ( cAlbCliT )->cSufAlb ) )

            while ( cAlbCliT )->cSerAlb + Str( ( cAlbCliT )->nNumAlb ) + ( cAlbCliT )->cSufAlb == ( cAlbCliS )->cSerAlb + Str( ( cAlbCliS )->nNumAlb ) + ( cAlbCliS )->cSufAlb .AND. !( cAlbCliS )->( Eof() )

               if dbLock( cAlbCliS )
                  ( cAlbCliS )->lFacturado := lFacturado
                  ( cAlbCliS )->( dbUnlock() )
                end

               ( cAlbCliS )->( dbSkip() )

            end

         end

         ( cAlbCliS )->( OrdSetFocus( nOrd ) )

      next

   else





      if dbLock( cAlbCliT )
         ( cAlbCliT )->lFacturado := lFacturado
         ( cAlbCliT )->cNumFac    := cNumFac
         ( cAlbCliT )->( dbUnLock() )
      end





      nOrd                    := ( cAlbCliL )->( OrdSetFocus( "nNumAlb" ) )

      if ( cAlbCliL )->( dbSeek( ( cAlbCliT )->cSerAlb + Str( ( cAlbCliT )->nNumAlb ) + ( cAlbCliT )->cSufAlb ) )

         while ( cAlbCliT )->cSerAlb + Str( ( cAlbCliT )->nNumAlb ) + ( cAlbCliT )->cSufAlb == ( cAlbCliL )->cSerAlb + Str( ( cAlbCliL )->nNumAlb ) + ( cAlbCliL )->cSufAlb .AND. !( cAlbCliL )->( Eof() )

            if dbLock( cAlbCliL )
               ( cAlbCliL )->lFacturado := lFacturado
               ( cAlbCliL )->( dbUnlock() )
             end

            ( cAlbCliL )->( dbSkip() )

         end

      end

      ( cAlbCliL )->( OrdSetFocus( nOrd ) )





      nOrd                   := ( cAlbCliS )->( OrdSetFocus( "nNumAlb" ) )

      if ( cAlbCliS )->( dbSeek( ( cAlbCliT )->cSerAlb + Str( ( cAlbCliT )->nNumAlb ) + ( cAlbCliT )->cSufAlb ) )

         while ( cAlbCliT )->cSerAlb + Str( ( cAlbCliT )->nNumAlb ) + ( cAlbCliT )->cSufAlb == ( cAlbCliS )->cSerAlb + Str( ( cAlbCliS )->nNumAlb ) + ( cAlbCliS )->cSufAlb .AND. !( cAlbCliS )->( Eof() )

            if dbLock( cAlbCliS )
               ( cAlbCliS )->lFacturado := lFacturado
               ( cAlbCliS )->( dbUnlock() )
             end

            ( cAlbCliS )->( dbSkip() )

         end

      end

      ( cAlbCliS )->( OrdSetFocus( nOrd ) )

   end





   ( cAlbCliT )->( dbGoTo( nRecHead ) )

   if oBrw <> nil
      oBrw:Refresh()
      oBrw:SetFocus()
   end

RETURN NIL






FUNCTION nDtoLAlbCli( dbfLin, nDec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( dbfLin == nil, dbfLin := dbfAlbCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   if ( dbfLin )->nDto <> 0
      nCalculo       := nTotUAlbCli( dbfLin, nDec ) * ( dbfLin )->nDto / 100
      nCalculo       := Round( nCalculo / nVdv, nDec )
   end

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



Function nTotDtoLAlbCli( dbfLin, nDec, nVdv, cPorDiv )

   local nCalculo

   IIF( dbfLin == nil, dbfLin := dbfAlbCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nDtoLAlbCli( dbfLin, nDec, nVdv ) * nTotNAlbCli( dbfLin )

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

   nCalculo          := Round( nCalculo, nDec )

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )





Function dJulianoAlbCli( cAlbCliL )

   local cPrefijo
   local cLote

   IIF( cAlbCliL == nil, cAlbCliL := dbfAlbCliL, ) ;

   cLote             := ( cAlbCliL )->cLote

   cPrefijo          := Substr( ( cAlbCliL )->cLote, 1, 1 )

   if Val( cPrefijo ) == 0
      cLote          := Substr( ( cAlbCliL )->cLote, 2 )
   end

RETURN ( AddMonth( JulianoToDate( , Val( cLote ) ), 6 ) )



Function dJulianoAlbAnio( cAlbCliL )

   local cPrefijo
   local cLote

   IIF( cAlbCliL == nil, cAlbCliL := dbfAlbCliL, ) ;

   cLote             := ( cAlbCliL )->cLote

   cPrefijo          := Substr( ( cAlbCliL )->cLote, 1, 1 )

   if Val( cPrefijo ) == 0
      cLote          := Substr( ( cAlbCliL )->cLote, 2 )
   end

RETURN ( AddMonth( JulianoToDate( , Val( cLote ) ), 8 ) )




Static Function YearComboBoxChange()

   if oWndBrw:oWndBar:lAllYearComboBox()
      DestroyFastFilter( dbfAlbCliT )
      CreateUserFilter( "", dbfAlbCliT, .F., , , "all" )
   else
      DestroyFastFilter( dbfAlbCliT )
      CreateUserFilter( "Year( Field->dFecAlb ) == " + oWndBrw:oWndBar:cYearComboBox(), dbfAlbCliT, .F., , , "Year( Field->dFecAlb ) == " + oWndBrw:oWndBar:cYearComboBox() )
   end

   ( dbfAlbCliT )->( dbGoTop() )

   oWndBrw:Refresh()

Return nil






































































































static function lBuscaOferta( cCodArt, aGet, aTmp, aTmpAlb, dbfOferta, dbfArticulo, dbfDiv, dbfKit, dbfIva  )

   local sOfeArt
   local nTotalLinea    := 0


   if ( dbfArticulo )->Codigo == cCodArt .OR. ( dbfArticulo )->( dbSeek( cCodArt ) )





      nTotalLinea := lCalcDeta( aTmp, aTmpAlb, nDouDiv, , , aTmpAlb[ 51 ], .T. )

      sOfeArt     := sOfertaArticulo( cCodArt, aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmp[ 19 ], aTmpAlb[ 5 ], dbfOferta, aTmp[ 76 ], , aTmp[28], aTmp[29], aTmp[30], aTmp[31], aTmp[ 51 ], dbfArticulo, dbfDiv, dbfKit, dbfIva, aTmp[ 12 ], nTotalLinea )

      if !Empty( sOfeArt ) .AND. sOfeArt:nPrecio <> 0
         aGet[ 6 ]:cText( sOfeArt:nPrecio )
         aGet[ 9     ]:cText( sOfeArt:nDtoPorcentual )
         aGet[ 33  ]:cText( sOfeArt:nDtoLineal )
         aTmp[ 91  ] := .T.
      end

      if !aTmp[ 91 ]





         sOfeArt     := sOfertaFamilia( ( dbfArticulo )->Familia, aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmpAlb[ 5 ], dbfOferta, aTmp[ 76 ], dbfArticulo, aTmp[ 19 ], aTmp[ 12 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 9 ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 33 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 91 ]  := .T.
         end

      end

      if !aTmp[ 91 ]





         sOfeArt     := sOfertaTipoArticulo( ( dbfArticulo )->cCodTip, aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmpAlb[ 5 ], dbfOferta, aTmp[ 76 ], dbfArticulo, aTmp[ 19 ], aTmp[ 12 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 33 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 91 ]  := .T.
         end

      end

      if !aTmp[ 91 ]





         sOfeArt     := sOfertaCategoria( ( dbfArticulo )->cCodCate, aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmpAlb[ 5 ], dbfOferta, aTmp[ 76 ], dbfArticulo, aTmp[ 19 ], aTmp[ 12 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 33 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 91 ]  := .T.
         end

      end

      if !aTmp[ 91 ]





         sOfeArt     := sOfertaTemporada( ( dbfArticulo )->cCodTemp, aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmpAlb[ 5 ], dbfOferta, aTmp[ 76 ], dbfArticulo, aTmp[ 19 ], aTmp[ 12 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 33 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 91 ]  := .T.
         end

      end

      if !aTmp[ 91 ]





         sOfeArt     := sOfertaFabricante( ( dbfArticulo )->cCodFab, aTmpAlb[ 6 ], aTmpAlb[ 72 ], aTmpAlb[ 5 ], dbfOferta, aTmp[ 76 ], dbfArticulo, aTmp[ 19 ], aTmp[ 12 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 33 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 91 ]  := .T.
         end

      end

   end

return .T.



Static Function lValidLote( aTmp, aGet, oStkAct )

   if !uFieldEmpresa( "lNStkAct" )
      oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 38 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 44 ], aTmp[ 46 ], aTmp[ 35 ], oStkAct )
   end

Return ( .T. )



Static Function EditarNumeroSerie( aTmp, oStock, nMode )

   with object ( TNumerosSerie() )

      :nMode            := nMode

      :cCodArt          := aTmp[ 4    ]
      :cCodAlm          := aTmp[ 38 ]
      :nNumLin          := aTmp[ 34 ]

      :nTotalUnidades   := nTotNAlbCli( aTmp )

      :oStock           := oStock

      :uTmpSer          := dbfTmpSer

      :Resource()

   end

Return ( nil )



Static Function OldEditarNumeroSerie( aTmp, oStock, nMode )

   local n
   local oDlg
   local nTotUnd
   local cCodArt
   local cCodAlm
   local oBrwSer
   local aNumSer
   local aValSer
   local cPreFix  := Space( 18 )
   local oSerIni
   local nSerIni  := 0
   local oSerFin
   local nSerFin  := 0
   local oNumGen
   local nNumGen  := 0
   local oSaySer
   local cSaySer  := ""
   local oProSer
   local nProSer

   IIF( nMode == nil, nMode := 1, ) ;

   nTotUnd        := Abs( nTotNAlbCli( aTmp ) )

   if nTotUnd == 0
      MsgStop( "No hay unidades para asignar números de serie." )
      Return ( nil )
   end

   n              := 1

   cCodArt        := aTmp[ 4    ]
   cCodAlm        := aTmp[ 38 ]

   aNumSer        := Afill( Array( nTotUnd ), Space( 30 ) )
   aValSer        := Afill( Array( nTotUnd ), .F. )

   if ( dbfTmpSer )->( dbSeek( Str( aTmp[ 34 ], 4 ) + aTmp[ 4 ] ) )
      while ( Str( ( dbfTmpSer )->nNumLin, 4 ) + ( dbfTmpSer )->cRef == Str( aTmp[ 34 ], 4 ) + aTmp[ 4 ] ) .AND. !( dbfTmpSer )->( Eof() )
         if ( n <= nTotUnd )
            aNumSer[ n ]   := ( dbfTmpSer )->cNumSer
         end
         ( dbfTmpSer )->( dbSkip() )
         n++
      end
   end

   oDlg = TDialog():New(,,,,, "VTANUMSER",, .F.,,,,,, .F.,,,,,, .F., )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, nTotUnd, nTotUnd:= u ) }, oDlg,, MasUnd(),,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cPreFix, cPreFix:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      oSerIni := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nSerIni, nSerIni:= u ) }, oDlg,, "99999999999999999999", {||    ( oSerFin:cText( nSerIni + nTotUnd ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      oSerFin := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nSerFin, nSerFin:= u ) }, oDlg,, "99999999999999999999",,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






      oNumGen := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, nNumGen, nNumGen:= u ) }, oDlg,, "99999999999999999999",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TButton():ReDefine( 500, {||( oDlg:Disable(), GenNumSer( cPreFix, aNumSer, nSerIni, nNumGen, oBrwSer, oProSer ), lValSer( cCodArt, cCodAlm, aNumSer, aValSer, nTotUnd, oStock, oBrwSer, oProSer, oSaySer ), oDlg:Enable() )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )

      oBrwSer                 := TXBrowse():New( oDlg )

      oBrwSer:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwSer:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwSer:lHScroll        := .F.
      oBrwSer:lRecordSelector := .T.
      oBrwSer:lFastEdit       := .T.

      oBrwSer:nMarqueeStyle   := 3

      oBrwSer:SetArray( aNumSer, , , .F. )

      oBrwSer:nColSel         := 2

      with object ( oBrwSer:addCol() )
         :cHeader             := "N."
         :bStrData            := {|| Trans( oBrwSer:nArrayAt, "999999" ) }
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwSer:addCol() )
         :cHeader             := "Serie"
         :bEditValue          := {|| aNumSer[ oBrwSer:nArrayAt ] }
         :nWidth              := 220
         if nMode <> 3
            :nEditType        := 1
         end
         :bOnPostEdit         := {|o,x| aNumSer[ oBrwSer:nArrayAt ] := x, aValSer[ oBrwSer:nArrayAt ] := oStock:lValidNumeroSerie( cCodArt, cCodAlm, x ) }
      end

      with object ( oBrwSer:addCol() )
         :cHeader             := "Es."
         :nHeadBmpNo          := 4
         :bStrData            := {|| "" }
         :bBmpData            := {|| if( aValSer[ oBrwSer:nArrayAt ], 3, 1 ) }
         :nWidth              := 20
         :AddResource( "Bullet_Square_Red_16" )
         :AddResource( "Bullet_Square_Yellow_16" )
         :AddResource( "Bullet_Square_Green_16" )
         :AddResource( "Informacion_16" )
      end

      oBrwSer:CreateFromResource( 150 )



      oSaySer := TSay():ReDefine( 230, {|| cSaySer}, oDlg,,,, .F.,, .F., .F. )

      oProSer     := TMeter():ReDefine( 240, { | u | if( pCount() == 0, nProSer, nProSer := u ) }, 10, oDlg, .F., , , .T., ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ), , ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) ) )





      TButton():ReDefine( 510, {||( if( lChkSer( aValSer, nTotUnd, oProSer, oBrwSer ), SalvarNumeroSerie( aNumSer, aTmp, oProSer, oDlg ), ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 520, {||( oDlg:End() )}, oDlg,,, .F.,,,, .F. )

      oDlg:bStart := {|| oDlg:Disable(), lValSer( cCodArt, cCodAlm, aNumSer, aValSer, nTotUnd, oStock, oBrwSer, oProSer, oSaySer ), oDlg:Enable() }

      oDlg:AddFastKey( 116, {|| if( lChkSer( aValSer, nTotUnd, oProSer, oBrwSer ), SalvarNumeroSerie( aNumSer, aTmp, oProSer, oDlg ), ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( nil )



Static Function lValSer( cCodArt, cCodAlm, aNumSer, aValSer, nTotUnd, oStock, oBrwSer, oProSer, oSaySer )

   local n
   local lValid         := .T.

   CursorWait()

   if !Empty( oProSer )
      oProSer:Show()
      oProSer:SetTotal( nTotUnd )
   end

   if !Empty( oSaySer )
      oSaySer:SetText( "Calculando disponibilidad del stock..." )
   end

   for n := 1 to nTotUnd

      if !Empty( aNumSer[ n ] )

         aValSer[ n ]   := oStock:lValidNumeroSerie( cCodArt, cCodAlm, aNumSer[ n ] )

         if !aValSer[ n ]
            lValid      := .F.
         end

      else

         lValid         := .F.

      end

      if !Empty( oProSer ) .AND. ( Mod( n, int( nTotUnd / 100 ) ) == 0 )
         oProSer:Set( n )
      end

   next

   if !Empty( oBrwSer )
      oBrwSer:Refresh()
   end

   if !Empty( oProSer )
      oProSer:Set( 0 )
      oProSer:Hide()
   end

   if !Empty( oSaySer )
      oSaySer:SetText( "" )
   end

   CursorWE()

Return ( lValid )



Static Function lChkSer( aValSer, nTotUnd, oProSer, oBrwSer )

   local l
   local n
   local lValid            := .T.

   CursorWait()

   if !Empty( oProSer )
      oProSer:Show()
      oProSer:SetTotal( nTotUnd )
   end

   for each l in aValSer

      if IsFalse( l )

         lValid            := .F.
         n                 := hb_EnumIndex()
         exit

      else

         if !Empty( oProSer )
            oProSer:Set( hb_EnumIndex() )
         end

      end

   next

   if !lValid

      if uFieldEmpresa( "lSerNoCom" )
         msgStop( "Hay números de serie sin stock para su venta." )
      else
         lValid            := ApoloMsgNoYes( "Hay números de serie sin stock para su venta.", "¿Desea continuar con la venta?" )
      end

      if !Empty( oBrwSer ) .AND. IsNum( n )
         oBrwSer:nArrayAt  := n
         oBrwSer:Refresh()
      end

   end

   if !Empty( oProSer )
      oProSer:Hide()
   end

   CursorWE()

Return ( lValid )



Static Function SalvarNumeroSerie( aNumSer, aTmp, oProSer, oDlg )

   local cNumSer
   local nTotUnd              := len( aNumSer )

   oDlg:Disable()

   EliminarNumeroSerie( aTmp )

   if !Empty( oProSer )
      oProSer:SetTotal( nTotUnd )
   end

   for each cNumSer in aNumSer

      ( dbfTmpSer )->( dbAppend() )
      ( dbfTmpSer )->cRef        := aTmp[ 4        ]
      ( dbfTmpSer )->cAlmLin     := aTmp[ 38     ]
      ( dbfTmpSer )->nNumLin     := aTmp[ 34     ]
      ( dbfTmpSer )->lFacturado  := aTmp[ 90 ]
      ( dbfTmpSer )->cNumSer     := cNumSer

      if !Empty( oProSer ) .AND. ( Mod( hb_enumindex(), int( nTotUnd / 100 ) ) == 0 )
         oProSer:Set( hb_enumindex() )
      end

   next

   oDlg:Enable()
   oDlg:End()

Return ( nil )



Static Function EliminarNumeroSerie( aTmp )

   while ( ( dbfTmpSer )->( dbSeek( Str( aTmp[ 34 ], 4 ) + aTmp[ 4 ] ) ) ) .AND. !( dbfTmpSer )->( Eof() )
      ( dbfTmpSer )->( dbDelete() )
   end

Return ( nil )
