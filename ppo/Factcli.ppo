#line 112 "hbclass.ch"
   DYNAMIC DivertConstructorCall
















DECLARE HBClass  New( cName AS String, OPTIONAL SuperParams ) AS CLASS HBClass  Create() AS Object  Instance() AS Object  AddClsMethod( cName AS String, @MethodName(), nScope AS Numeric, n2 AS Numeric, n3 AS Numeric )  AddDelegate( cName AS String, cDelegate AS String, cObject AS String, nScope AS Numeric, lPersistent AS LOGICAL )  AddMultiClsData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String )  AddMultiData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String, x AS LOGICAL, lPer AS LOGICAL )  AddMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  AddInLine( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  AddVirtual( cName AS String )  ModMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  ModClsMethod( cName AS String, @MethodName(), nScope AS Numeric )  ModInline( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  SetOnError( @MethodName() )
#line 85 "\Fwh1204\Include\FiveWin.Ch"
   EXTERNAL GetProcAdd
   EXTERNAL TActiveX




extern errorsys
#line 270 ".\Prg\Factcli.prg"
memvar cDbf
memvar cDbfCol
memvar cDbfCob
memvar cCliente
memvar cDbfCli
memvar cDivisa
memvar cDbfDiv
memvar cFPago
memvar cDbfPgo
memvar cIva
memvar cDbfIva
memvar cAgente
memvar cDbfAge
memvar cTvta
memvar cDbfTvt
memvar cObras
memvar cDbfUsr
memvar cDbfObr
memvar cDbfPedT
memvar cDbfPedL
memvar cDbfAlbT
memvar cDbfAlbL
memvar cDbfAntT
memvar cDbfAlbP
memvar cDbfTrn
memvar cDbfRut
memvar cDbfCajT
memvar aImpVto
memvar aDatVto
memvar aIvaUno
memvar aIvaDos
memvar aIvaTre
memvar aIvmUno
memvar aIvmDos
memvar aIvmTre
memvar aTotTip
memvar cCtaCli
memvar nTotBrt
memvar nTotDto
memvar nTotDpp
memvar nTotUno
memvar nTotDos
memvar nTotNet
memvar nTotSup
memvar nTotIva
memvar nTotReq
memvar nTotFac
memvar nTotPag
memvar nTotImp
memvar nTotPnt
memvar nTotRet
memvar nTotCob
memvar nTotCos
memvar nTotIvm
memvar aTotIvm
memvar nTotPes
memvar nTotAge
memvar nTotTrn
memvar nTotAtp
memvar nTotAnt
memvar nTotRnt
memvar nTotEnt
memvar nTotDtoEnt
memvar nTotPctRnt
memvar nVdv
memvar nVdvDivFac
memvar cPicUndFac
memvar cPouDivFac
memvar cPorDivFac
memvar cPpvDivFac
memvar nDouDivFac
memvar nRouDivFac
memvar nDpvDivFac
memvar cCodPgo
memvar nTotArt
memvar nTotCaj
memvar lFacCli
memvar lAntCli
memvar oStk
memvar nTotalDto

memvar lEnd
memvar nRow
memvar oInf
memvar nPagina
memvar oReport

memvar aTotIva





static oWndBrw
static oBrwIva
static dbfRuta
static dbfTikT
static dbfTikL
static dbfTikS
static dbfInci
static dbfCliAtp
static dbfFacCliT
static dbfFacCliL
static dbfFacCliP
static dbfFacCliI
static dbfFacCliD
static dbfFacCliS
static dbfFacRecT
static dbfFacRecL
static dbfFacRecS
static dbfAlbCliL
static dbfAlbCliT
static dbfAlbCliS
static dbfAlbCliP
static dbfAlbCliI
static dbfAlbCliD
static dbfPedCliT
static dbfPedCliL
static dbfPedCliI
static dbfPedCliD
static dbfPedCliP
static dbfPreCliT
static dbfPreCliL
static dbfPreCliI
static dbfPreCliD
static dbfAntCliT
static dbfAlbPrvL
static dbfAlbPrvS
static dbfPedCliR
static dbfProSer
static dbfMatSer
static dbfTmpLin
static dbfTmpInc
static dbfTmpDoc
static dbfTmpAnt
static dbfTmpPgo
static dbfTmpSer
static dbfIva
static dbfCount
static dbfClient
static dbfCliInc
static dbfCliBnc
static dbfArtPrv
static dbfFPago
static dbfAgent
static dbfTVta
static dbfPromoT
static dbfPromoL
static dbfPromoC
static dbfAlm
static dbfPro
static dbfTblPro
static dbfArticulo
static dbfCodebar
static dbfTarPreT
static dbfTarPreL
static dbfTarPreS
static dbfClientAtp
static dbfOferta
static dbfDiv
static dbfObrasT
static dbfFamilia
static dbfKit
static dbfDoc
static dbfFlt
static dbfArtDiv
static dbfCajT
static dbfUsr
static dbfDelega
static dbfAgeCom
static dbfEmp
static dbfTblCnv
static dbfFacPrvT
static dbfFacPrvL
static dbfFacPrvS
static dbfRctPrvL
static dbfRctPrvS
static dbfProLin
static dbfProMat
static dbfHisMov
static dbfHisMovS
static dbfPedPrvL
static oStock
static oCtaRem
static oBandera
static oTrans
static oUndMedicion
static cTmpLin
static cTmpInc
static cTmpDoc
static cTmpAnt
static cTmpPgo
static cTmpSer
static oGetTotal
static oTotFacLin
static oGetNet
static oGetTotPnt
static oGetTotIvm
static oGetPctRet
static oGetIva
static oGetReq
static oGetAge
static oGetTotPg
static oGetPag
static oGetPdt
static oGetAnt
static oGetPes
static oGetDif
static cPouDiv
static oFont
static oMenu
static cPinDiv
static cPorDiv
static cPpvDiv
static cPicUnd
static nVdvDiv
static nDouDiv
static nRouDiv
static nDpvDiv
static aDbfBmp
static oNewImp
static oTipArt
static oGrpFam
static oFraPub
static oBanco
static oPais

static oTotalLinea
static nTotalLinea         := 0
static oRentabilidadLinea
static cRentabilidadLinea  := ""
static oComisionLinea
static nComisionLinea      := 0

static aFastReportVariable

static aNumAlb             := {}

static oGetRnt
static oGetEnt
static oGetTrn
static cCodDiv
static oGetDtoEnt

static nTotal              := 0
static nTotalOld           := 0
static nTotalDif           := 0
static oBtnPre
static oBtnPed
static oBtnAlb
static oBtnGrp
static cOldCodCli          := ""
static cOldCodArt          := ""
static cOldPrpArt          := ""
static cOldUndMed          := ""
static lOpenFiles          := .F.
static lExternal           := .F.
static aTipFac             := { "Venta", "Alquiler" }
static oTipFac

static hCabeceraFactura    := 0
static hLineaFactura       := 0
static hVencimientoFactura := 0
static hDescuentoFactura   := 0
static hImpuestosFactura   := 0

static aImportacion        := {}
static lCancelImportacion  := .F.

static cFiltroCajero       := ""

static oMeter
static nMeter              := 1

static bEdtRec             := { |aTmp, aGet, dbfFacCliT, oBrw, bWhen, bValid, nMode, aNumDoc| EdtRec( aTmp, aGet, dbfFacCliT, oBrw, bWhen, bValid, nMode, aNumDoc ) }
static bEdtDet             := { |aTmp, aGet, dbfFacCliL, oBrw, bWhen, bValid, nMode, aTmpFac| EdtDet( aTmp, aGet, dbfFacCliL, oBrw, bWhen, bValid, nMode, aTmpFac ) }
static bEdtInc             := { |aTmp, aGet, dbfFacCliI, oBrw, bWhen, bValid, nMode, aTmpLin| EdtInc( aTmp, aGet, dbfFacCliI, oBrw, bWhen, bValid, nMode, aTmpLin ) }
static bEdtDoc             := { |aTmp, aGet, dbfFacCliD, oBrw, bWhen, bValid, nMode, aTmpLin| EdtDoc( aTmp, aGet, dbfFacCliD, oBrw, bWhen, bValid, nMode, aTmpLin ) }








STATIC FUNCTION GenFacCli( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local nOrd
   local oDevice
   local cNumFac

   public aImpVto       := {}
   public aDatVto       := {}

   if ( dbfFacCliT )->( Lastrec() ) == 0
      return nil
   end

   cNumFac              := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac

   IIF( nDevice == nil, nDevice := 1, ) ;
   IIF( cCaption == nil, cCaption := "Imprimiendo facturas a clientes", ) ;
   IIF( cCodDoc == nil, cCodDoc := cFormatoDocumento( ( dbfFacCliT )->cSerie, "nFacCli", dbfCount ), ) ;
   IIF( nCopies == nil, nCopies := if( nCopiasDocumento( ( dbfFacCliT )->cSerie, "nFacCli", dbfCount ) == 0, Max( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( ( dbfFacCliT )->cSerie, "nFacCli", dbfCount ) ), ) ;





   if Empty( cCodDoc )
      cCodDoc           := cFirstDoc( "FC", dbfDoc )
   end

   if !lExisteDocumento( cCodDoc, dbfDoc )
      return nil
   end





   if !Empty( oAuditor() )
      if nDevice == 1
         oAuditor():AddEvent( "Impresa factura de clientes",    cNumFac, "11" )
      else
         oAuditor():AddEvent( "Previsualizada factura de clientes",  cNumFac, "11" )
      end
   end





   if lVisualDocumento( cCodDoc, dbfDoc )

      PrintReportFacCli( nDevice, nCopies, cPrinter, dbfDoc )

   else





      nTotFacCli( cNumFac, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT, nil, nil, .T. )





      private oInf
      private cDbf         := dbfFacCliT
      private cDbfCol      := dbfFacCliL
      private cDbfCob      := dbfFacCliP
      private cCliente     := dbfClient
      private cDbfCli      := dbfClient
      private cDivisa      := dbfDiv
      private cDbfDiv      := dbfDiv
      private cFPago       := dbfFPago
      private cDbfPgo      := dbfFPago
      private cIva         := dbfIva
      private cDbfIva      := dbfIva
      private cAgente      := dbfAgent
      private cDbfAge      := dbfAgent
      private cTvta        := dbfTVta
      private cDbfTvt      := dbfTVta
      private cObras       := dbfObrasT
      private cDbfUsr      := dbfUsr
      private cDbfObr      := dbfObrasT
      private cDbfPedT     := dbfPedCliT
      private cDbfPedL     := dbfPedCliL
      private cDbfAlbT     := dbfAlbCliT
      private cDbfAlbL     := dbfAlbCliL
      private cDbfAlbP     := dbfAlbCliP
      private cDbfAntT     := dbfAntCliT
      private cDbfTrn      := oTrans:GetAlias()
      private cDbfRut      := dbfRuta
      private cDbfCajT     := dbfCajT
      private nTotPag      := 0
      private nVdv         := nVdvDiv
      private nVdvDivFac   := nVdvDiv
      private cPicUndFac   := cPicUnd
      private cPouDivFac   := cPouDiv
      private cPorDivFac   := cPorDiv
      private cPpvDivFac   := cPpvDiv
      private nDouDivFac   := nDouDiv
      private nRouDivFac   := nRouDiv
      private nDpvDivFac   := nDpvDiv
      private cCodPgo      := ( dbfFacCliT )->cCodPago
      private nTotCob      := nPagFacCli( cNumFac, dbfFacCliT, dbfFacCliP, dbfIva, dbfDiv, nil, .T. )

      private lFacCli      := .T.
      private lAntCli      := .F.

      private oStk         := oStock





      ( dbfClient )->( dbSeek( ( dbfFacCliT )->cCodCli ) )
      ( dbfAgent  )->( dbSeek( ( dbfFacCliT )->cCodAge ) )
      ( dbfFPago  )->( dbSeek( ( dbfFacCliT )->cCodPago) )
      ( dbfDiv    )->( dbSeek( ( dbfFacCliT )->cDivFac ) )
      ( dbfUsr    )->( dbSeek( ( dbfFacCliT )->cCodUsr ) )
      ( dbfRuta   )->( dbSeek( ( dbfFacCliT )->cCodRut ) )
      ( dbfCajT   )->( dbSeek( ( dbfFacCliT )->cCodCaj ) )
      ( dbfObrasT )->( dbSeek( ( dbfFacCliT )->cCodCli + ( dbfFacCliT )->cCodObr ) )

      oTrans:oDbf:Seek( ( dbfFacCliT )->cCodTrn )

      if ( dbfAlbCliT )->( dbSeek( ( dbfFacCliT )->cNumAlb ) )
         ( dbfPedCliT )->( dbSeek( ( dbfAlbCliT )->cNumPed ) )
      end

      nOrd                    := ( dbfAntCliT )->( OrdSetFocus( "cNumDoc" ) )
      ( dbfAntCliT )->( dbSeek( cNumFac ) )





      if ( dbfFacCliL )->( dbSeek( cNumFac ) )





         if !Empty( cPrinter )
            oDevice           := TPrinter():New( cCaption, .F., .T., cPrinter )
            oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .F.,, oDevice, cCaption,,, )
         else
            oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .T.,,, cCaption,,, )
         end





         if !Empty( oInf ) .AND. oInf:lCreated

            oInf:lAutoland          := .F.
            oInf:lFinish            := .F.
            oInf:lNoCancel          := .T.
            oInf:bSkip              := {|| FacCliReportSkipper( cNumFac, dbfFacCliL, dbfAntCliT ) }

            oInf:oDevice:lPrvModal  := .T.

            do case
               case nDevice == 1

                  oInf:oDevice:SetCopies( nCopies )

                  oInf:bPreview        := {| o | PrintPreview( o ) }

               case nDevice == 3

                  oInf:bPreview        := {| o | PrintPdf( o ) }

            end

            SetMargin( cCodDoc, oInf )
            PrintColum( cCodDoc, oInf )

         end

         RptEnd()

         if !Empty( oInf )

            private oReport   := oInf

            if nDevice == 1
            end




            oInf:Activate({||         ( !( dbfFacCliL )->lImpLin )}, {||       ( ( ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac = cNumFac .AND. !( dbfFacCliL )->( eof() ) ) .OR. ( ( dbfAntCliT )->cNumDoc = cNumFac .AND. !( dbfAntCliT )->( eof() ) ) )},,,, {||  ( ePage( oInf, cCodDoc ) )},,,,,,,, )

            if nDevice == 1
               oInf:oDevice:end()
            end

         end

         oInf                 := nil

      end

      ( dbfAntCliT )->( OrdSetFocus( nOrd ) )

   end





   lChgImpDoc( dbfFacCliT )

Return ( nil )



Static Function FacCliReportSkipper( cNumFac, dbfFacCliL, dbfAntCliT )

   if ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac = cNumFac .AND. !( dbfFacCliL )->( eof() )

      nTotPag              += nTotLFacCli( dbfFacCliL )

      ( dbfFacCliL )->( dbSkip() )

      if ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac <> cNumFac .OR. ( dbfFacCliL )->( eof() )
         lFacCli           := .F.
         lAntCli           := .T.
      end

   elseif ( dbfAntCliT )->cNumDoc = cNumFac .AND. !( dbfAntCliT )->( eof() )

      ( dbfAntCliT )->( dbSkip() )

   end

Return nil



Static Function EPage( oInf, cCodDoc )

   private nPagina      := oInf:nPage
   private lEnd         := oInf:lFinish
   private nRow         := oInf:nRow





   PrintItems( cCodDoc, oInf )

RETURN NIL



STATIC FUNCTION OpenFiles( lExt )

   local oBlock
   local oError

   if lOpenFiles
      MsgStop( "Imposible abrir ficheros de facturas de clientes" )
      Return ( .F. )
   end

   IIF( lExt == nil, lExt := .F., ) ;

   lExternal            := lExt

   oBlock               := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      DisableAcceso()

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIT.DBF" ), ( cCheckArea( "FACCLIT", @dbfFacCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIL.DBF" ), ( cCheckArea( "FACCLIL", @dbfFacCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIP.DBF" ), ( cCheckArea( "FACCLIP", @dbfFacCliP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLII.DBF" ), ( cCheckArea( "FACCLII", @dbfFacCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLID.DBF" ), ( cCheckArea( "FACCLID", @dbfFacCliD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLID.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIS.DBF" ), ( cCheckArea( "FACCLIS", @dbfFacCliS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACRECT.DBF" ), ( cCheckArea( "FACRECT", @dbfFacRecT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACRECT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACRECL.DBF" ), ( cCheckArea( "FACRECL", @dbfFacRecL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACRECL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACRECS.DBF" ), ( cCheckArea( "FACRECS", @dbfFacRecS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACRECS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIT.DBF" ), ( cCheckArea( "ALBCLIT", @dbfAlbCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIL.DBF" ), ( cCheckArea( "ALBCLIL", @dbfAlbCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIP.DBF" ), ( cCheckArea( "ALBCLIP", @dbfAlbCliP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLII.DBF" ), ( cCheckArea( "ALBCLII", @dbfAlbCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLID.DBF" ), ( cCheckArea( "ALBCLID", @dbfAlbCliD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLID.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIS.DBF" ), ( cCheckArea( "ALBCLIS", @dbfAlbCliS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROSER.DBF" ), ( cCheckArea( "PROSER", @dbfProSer ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROSER.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "MatSer.Dbf" ), ( cCheckArea( "MatSer", @dbfMatSer ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "MatSer.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIT.DBF" ), ( cCheckArea( "PEDCLIT", @dbfPedCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIL.DBF" ), ( cCheckArea( "PEDCLIT", @dbfPedCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIP.DBF" ), ( cCheckArea( "PEDCLIP", @dbfPedCliP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLII.DBF" ), ( cCheckArea( "PEDCLII", @dbfPedCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLID.DBF" ), ( cCheckArea( "PEDCLID", @dbfPedCliD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLID.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLIT.DBF" ), ( cCheckArea( "PRECLIT", @dbfPreCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLIL.DBF" ), ( cCheckArea( "PRECLIT", @dbfPreCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLII.DBF" ), ( cCheckArea( "PRECLII", @dbfPreCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLID.DBF" ), ( cCheckArea( "PRECLID", @dbfPreCliD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLID.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKET.DBF" ), ( cCheckArea( "TIKET", @dbfTikT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKET.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKEL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKES.DBF" ), ( cCheckArea( "TIKES", @dbfTikS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfClient ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CliInc.Dbf" ), ( cCheckArea( "CliInc", @dbfCliInc ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "CliInc.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CliBnc.Dbf" ), ( cCheckArea( "CLIBNC", @dbfCliBnc ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "CliBnc.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROVART.DBF" ), ( cCheckArea( "PROVART", @dbfArtPrv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROVART.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CliAtp.Dbf" ), ( cCheckArea( "CLIATP", @dbfClientAtp ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "CliAtp.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "AGENTES.DBF" ), ( cCheckArea( "AGENTES", @dbfAgent ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "AGENTES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ArtCodebar.Dbf" ), ( cCheckArea( "CODEBAR", @dbfCodebar ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ArtCodebar.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTKIT.DBF" ), ( cCheckArea( "ARTTIK", @dbfKit ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTKIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TARPRET.DBF" ), ( cCheckArea( "TARPRET", @dbfTarPreT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TARPRET.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TARPREL.DBF" ), ( cCheckArea( "TARPREL", @dbfTarPreL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TARPREL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TARPRES.DBF" ), ( cCheckArea( "TARPRES", @dbfTarPreS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TARPRES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROMOT.DBF" ), ( cCheckArea( "PROMOL", @dbfPromoT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROMOT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROMOL.DBF" ), ( cCheckArea( "PROMOL", @dbfPromoL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROMOL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROMOC.DBF" ), ( cCheckArea( "PROMOC", @dbfPromoC ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROMOC.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatGrp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatGrp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TVTA.DBF" ), ( cCheckArea( "TVTA", @dbfTVta ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TVTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "CNFFLT.DBF" ), ( cCheckArea( "CNFFLT", @dbfFlt ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "CNFFLT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "ObrasT.Dbf" ), ( cCheckArea( "OBRAST", @dbfObrasT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "ObrasT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "OFERTA.DBF" ), ( cCheckArea( "OFERTA", @dbfOferta ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "OFERTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RDOCUMEN.DBF" ), ( cCheckArea( "RDOCUMEN", @dbfDoc ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RDOCUMEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CTIPO" )

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PRO.DBF" ), ( cCheckArea( "PRO", @dbfPro ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TBLPRO.DBF" ), ( cCheckArea( "TBLPRO", @dbfTblPro ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TBLPRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "RUTA.DBF" ), ( cCheckArea( "RUTA", @dbfRuta ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "RUTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTDIV.DBF" ), ( cCheckArea( "ARTDIV", @dbfArtDiv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTDIV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "Cajas.Dbf" ), ( cCheckArea( "CAJAS", @dbfCajT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "Cajas.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatAlm() + "Almacen.DBF" ), ( cCheckArea( "Almacen", @dbfAlm ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatAlm() + "Almacen.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "USERS.DBF" ), ( cCheckArea( "USERS", @dbfUsr ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "USERS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "NCOUNT.DBF" ), ( cCheckArea( "NCOUNT", @dbfCount ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "NCOUNT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIPINCI.DBF" ), ( cCheckArea( "TIPINCI", @dbfInci ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIPINCI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DELEGA.DBF" ), ( cCheckArea( "DELEGA", @dbfDelega ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DELEGA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatGrp() + "AGECOM.DBF" ), ( cCheckArea( "AGECOM", @dbfAgeCom ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatGrp() + "AGECOM.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVL.DBF" ), ( cCheckArea( "ALBPROVL", @dbfAlbPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPRVS.DBF" ), ( cCheckArea( "ALBPRVS", @dbfAlbPrvS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPRVS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIR.DBF" ), ( cCheckArea( "PEDCLIR", @dbfPedCliR ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIR.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "EMPRESA.DBF" ), ( cCheckArea( "EMPRESA", @dbfEmp ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "EMPRESA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TBLCNV.DBF" ), ( cCheckArea( "TBLCNV", @dbfTblCnv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TBLCNV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVT.DBF" ), ( cCheckArea( "FACPRVT", @dbfFacPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVS.DBF" ), ( cCheckArea( "FACPRVS", @dbfFacPrvS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @dbfFacPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "RctPrvL", @dbfRctPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvS.DBF" ), ( cCheckArea( "RctPrvS", @dbfRctPrvS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROLIN.DBF" ), ( cCheckArea( "PROLIN", @dbfProLin ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROLIN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMAT.DBF" ), ( cCheckArea( "PROMAT", @dbfProMat ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMAT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "HISMOV.DBF" ), ( cCheckArea( "HISMOV", @dbfHisMov ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "HISMOV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRefMov" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "MOVSER.DBF" ), ( cCheckArea( "MOVSER", @dbfHisMovS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "MOVSER.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDPROVL.DBF" ), ( cCheckArea( "PedPrvL", @dbfPedPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      oBandera          := TBandera():New()

      oStock            := TStock():Create( cPatGrp() )
      if !oStock:lOpenFiles()
         lOpenFiles     := .F.
      else

      oStock:cPedCliT   := dbfPedCliT
      oStock:cPedCliL   := dbfPedCliL
      oStock:cPedCliR   := dbfPedCliR

      oStock:cAlbCliT   := dbfAlbCliT
      oStock:cAlbCliL   := dbfAlbCliL
      oStock:cAlbCliS   := dbfAlbCliS

      oStock:cFacCliT   := dbfFacCliT
      oStock:cFacCliL   := dbfFacCliL
      oStock:cFacCliP   := dbfFacCliP
      oStock:cFacCliS   := dbfFacCliS

      oStock:cAntCliT   := dbfAntCliT

      oStock:cFacRecT   := dbfFacRecT
      oStock:cFacRecL   := dbfFacRecL
      oStock:cFacRecS   := dbfFacRecS

      oStock:cTikT      := dbfTikT
      oStock:cTikL      := dbfTikL
      oStock:cTikS      := dbfTikS

      oStock:cKit       := dbfKit

      oStock:cPedPrvL   := dbfPedPrvL
      oStock:cAlbPrvL   := dbfAlbPrvL
      oStock:cAlbPrvS   := dbfAlbPrvS

      oStock:cFacPrvL   := dbfFacPrvL
      oStock:cFacPrvS   := dbfFacPrvS

      oStock:cRctPrvL   := dbfRctPrvL
      oStock:cRctPrvS   := dbfRctPrvS

      oStock:cProducL   := dbfProLin
      oStock:cProducM   := dbfProMat
      oStock:cProducS   := dbfProSer
      oStock:cProducP   := dbfMatSer

      oStock:cHisMov    := dbfHisMov
      oStock:cHisMovS   := dbfHisMovS

      end

      oCtaRem           := TCtaRem():Create( cPatCli() )
      if !oCtaRem:OpenFiles()
         lOpenFiles     := .F.
      end

      oNewImp           := TNewImp():Create( cPatEmp() )
      if !oNewImp:OpenFiles()
         lOpenFiles     := .F.
      end

      oTrans            := TTrans():Create( cPatCli() )
      if !oTrans:OpenFiles()
         lOpenFiles     := .F.
      end

      oTipArt           := TTipArt():Create( cPatArt() )
      if !oTipArt:OpenFiles()
         lOpenFiles     := .F.
      end

      oGrpFam           := TGrpFam():Create( cPatArt() )
      if !oGrpFam:OpenFiles()
         lOpenFiles     := .F.
      end

      oUndMedicion      := UniMedicion():Create( cPatGrp() )
      if !oUndMedicion:OpenFiles()
         lOpenFiles     := .F.
      end

      oFraPub           := TFrasesPublicitarias():Create( cPatArt() )
      if !oFraPub:OpenFiles()
         lOpenFiles     := .F.
      end

      oBanco            := TBancos():Create()
      if !oBanco:OpenFiles()
         lOpenFiles     := .F.
      end

      oPais             := TPais():Create( cPatDat() )
      if !oPais:OpenFiles()
         lOpenFiles     := .F.
      end

      oFont             := TFont():New( "Arial", 8, 26, .F., .T. )





      if oUser():lFiltroVentas()
         cFiltroCajero    := "Field->cCodUsr == '" + oUser():cCodigo() + "' .and. Field->cCodCaj == '" + oUser():cCaja() + "'"
      end





      public nTotFac    := 0
      public nTotBrt    := 0
      public nTotDto    := 0
      public nTotDPP    := 0
      public nTotNet    := 0
      public nTotSup    := 0
      public nTotIva    := 0
      public nTotIvm    := 0
      public nTotAge    := 0
      public nTotReq    := 0
      public nTotPnt    := 0
      public nTotUno    := 0
      public nTotDos    := 0
      public nTotRet    := 0
      public nTotTrn    := 0
      public nTotAnt    := 0
      public nTotEnt    := 0
      public nTotDtoEnt := 0
      public nTotCos    := 0
      public nTotCob    := 0
      public nTotPes    := 0
      public nTotRnt    := 0
      public nTotAtp    := 0
      public nTotArt    := 0
      public nTotCaj    := 0
      public nTotPctRnt := 0

      public aTotIva    := { { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 } }
      public aIvaUno    := aTotIva[ 1 ]
      public aIvaDos    := aTotIva[ 2 ]
      public aIvaTre    := aTotIva[ 3 ]

      public aTotIvm    := { { 0,0,0 }, { 0,0,0 }, { 0,0,0 }, }
      public aIvmUno    := aTotIvm[ 1 ]
      public aIvmDos    := aTotIvm[ 2 ]
      public aIvmTre    := aTotIvm[ 3 ]

      public aImpVto    := {}
      public aDatVto    := {}

      lOpenFiles        := .T.

      EnableAcceso()

   RECOVER USING oError

      lOpenFiles        := .F.

      msgStop( "Imposible abrir todas las bases de datos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      EnableAcceso()

   end

   ErrorBlock( oBlock )

   if !lOpenFiles
      CloseFiles()
   end

RETURN ( lOpenFiles )



STATIC FUNCTION CloseFiles()

   DisableAcceso()

   DestroyFastFilter( dbfFacCliT, .T., .T. )

   if !Empty( oFont )
      oFont:end()
   end

   if !Empty( dbfFacCliT )
      ( dbfFacCliT )->( dbCloseArea() )
   end

   if !Empty( dbfIva )
      ( dbfIva     )->( dbCloseArea() )
   end

   if !Empty( dbfFPago )
      ( dbfFPago   )->( dbCloseArea() )
   end

   if !Empty( dbfAgent )
      ( dbfAgent   )->( dbCloseArea() )
   end

   if !Empty( dbfClient )
      ( dbfClient     )->( dbCloseArea() )
   end

   if !Empty( dbfFacCliP )
      ( dbfFacCliP )->( dbCloseArea() )
   end

   if !Empty( dbfFacCliL )
      ( dbfFacCliL )->( dbCloseArea() )
   end

   if !Empty( dbfFacCliI )
      ( dbfFacCliI )->( dbCloseArea() )
   end

   if !Empty( dbfFacCliD )
      ( dbfFacCliD )->( dbCloseArea() )
   end

   if !Empty( dbfFacCliS )
      ( dbfFacCliS )->( dbCloseArea() )
   end

   if !Empty( dbfFacRecT )
      ( dbfFacRecT )->( dbCloseArea() )
   end

   if !Empty( dbfFacRecL )
      ( dbfFacRecL )->( dbCloseArea() )
   end

   if !Empty( dbfFacRecS )
      ( dbfFacRecS )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliT )
      ( dbfAlbCliT )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliL )
      ( dbfAlbCliL )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliP )
      ( dbfAlbCliP )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliI )
      ( dbfAlbCliI )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliD )
      ( dbfAlbCliD )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliS )
      ( dbfAlbCliS )->( dbCloseArea() )
   end

   if !Empty( dbfPedCliT )
      ( dbfPedCliT )->( dbCloseArea() )
   end

   if !Empty( dbfPedCliL )
      ( dbfPedCliL )->( dbCloseArea() )
   end

   if !Empty( dbfPedCliP )
      ( dbfPedCliP )->( dbCloseArea() )
   end

   if !Empty( dbfPedCliI )
      ( dbfPedCliI )->( dbCloseArea() )
   end

   if !Empty( dbfPedCliD )
      ( dbfPedCliD )->( dbCloseArea() )
   end

   if !Empty( dbfPreCliT )
      ( dbfPreCliT )->( dbCloseArea() )
   end

   if !Empty( dbfPreCliL )
      ( dbfPreCliL )->( dbCloseArea() )
   end

   if !Empty( dbfPreCliI )
      ( dbfPreCliI )->( dbCloseArea() )
   end

   if !Empty( dbfPreCliD )
      ( dbfPreCliD )->( dbCloseArea() )
   end

   if !Empty( dbfTikT )
      ( dbfTikT )->( dbCloseArea() )
   end

   if !Empty( dbfTikL )
      ( dbfTikL )->( dbCloseArea() )
   end

   if !Empty( dbfTikS )
      ( dbfTikS )->( dbCloseArea() )
   end

   if !Empty( dbfArticulo )
      ( dbfArticulo )->( dbCloseArea() )
   end

   if dbfCodebar <> nil
      ( dbfCodebar )->( dbCloseArea() )
   end

   if !Empty( dbfFamilia )
      ( dbfFamilia )->( dbCloseArea() )
   end

   if !Empty( dbfKit )
      ( dbfKit     )->( dbCloseArea() )
   end

   if !Empty( dbfTarPreT )
      ( dbfTarPreT )->( dbCloseArea() )
   end

   if !Empty( dbfTarPreL )
      ( dbfTarPreL )->( dbCloseArea() )
   end

   if !Empty( dbfTarPreS )
      ( dbfTarPreS )->( dbCloseArea() )
   end

   if !Empty( dbfPromoT )
      ( dbfPromoT  )->( dbCloseArea() )
   end

   if !Empty( dbfPromoL )
      ( dbfPromoL  )->( dbCloseArea() )
   end

   if !Empty( dbfPromoC )
      ( dbfPromoC  )->( dbCloseArea() )
   end

   if !Empty( dbfClientAtp )
      ( dbfClientAtp  )->( dbCloseArea() )
   end

   if !Empty( dbfTVta )
      ( dbfTVta    )->( dbCloseArea() )
   end

   if !Empty( dbfAlm )
      ( dbfAlm    )->( dbCloseArea() )
   end

   if !Empty( dbfDiv )
      ( dbfDiv     )->( dbCloseArea() )
   end

   if !Empty( dbfObrasT )
      ( dbfObrasT  )->( dbCloseArea() )
   end

   if !Empty( dbfOferta )
      ( dbfOferta  )->( dbCloseArea() )
   end

   if !Empty( dbfDoc )
      ( dbfDoc     )->( dbCloseArea() )
   end

   if !Empty( dbfFlt )
      ( dbfFlt     )->( dbCloseArea() )
   end

   if !Empty( dbfPro )
      ( dbfPro     )->( dbCloseArea() )
   end

   if !Empty( dbfTblPro )
      ( dbfTblPro  )->( dbCloseArea() )
   end

   if !Empty( dbfRuta )
      ( dbfRuta    )->( dbCloseArea() )
   end

   if !Empty( dbfArtDiv )
      ( dbfArtDiv  )->( dbCloseArea() )
   end

   if !Empty( dbfCajT )
      ( dbfCajT    )->( dbCloseArea() )
   end

   if !Empty( dbfAntCliT )
      ( dbfAntCliT )->( dbCloseArea() )
   end

   if !Empty( dbfUsr )
      ( dbfUsr     )->( dbCloseArea() )
   end

   if !Empty( dbfCount )
      ( dbfCount   )->( dbCloseArea() )
   end

   if dbfInci <> nil
      ( dbfInci )->( dbCloseArea() )
   end

   if dbfArtPrv <> nil
      ( dbfArtPrv )->( dbCloseArea() )
   end

   if !Empty( dbfDelega )
      ( dbfDelega )->( dbCloseArea() )
   end

   if !Empty( dbfAgeCom )
      ( dbfAgeCom )->( dbCloseArea() )
   end

   if !Empty( dbfAlbPrvL )
      ( dbfAlbPrvL )->( dbCloseArea() )
   end

   if !Empty( dbfAlbPrvS )
      ( dbfAlbPrvS )->( dbCloseArea() )
   end

   if !Empty( dbfPedCliR )
      ( dbfPedCliR )->( dbCloseArea() )
   end

   if !Empty( dbfEmp )
      ( dbfEmp )->( dbCloseArea() )
   end

   if !Empty( dbfTblCnv)
      ( dbfTblCnv )->( dbCloseArea() )
   end

   if !Empty( dbfFacPrvT )
      ( dbfFacPrvT )->( dbCloseArea() )
   end

   if !Empty( dbfFacPrvL )
      ( dbfFacPrvL )->( dbCloseArea() )
   end

   if !Empty( dbfFacPrvS )
      ( dbfFacPrvS )->( dbCloseArea() )
   end

   if !Empty( dbfRctPrvL )
      ( dbfRctPrvL )->( dbCloseArea() )
   end

   if !Empty( dbfRctPrvS )
      ( dbfRctPrvS )->( dbCloseArea() )
   end

   if !Empty( dbfProLin )
      ( dbfProLin )->( dbCloseArea() )
   end

   if !Empty( dbfProMat )
      ( dbfProMat )->( dbCloseArea() )
   end

   if !Empty( dbfProSer )
      ( dbfProSer )->( dbCloseArea() )
   end

   if !Empty( dbfMatSer )
      ( dbfMatSer )->( dbCloseArea() )
   end

   if !Empty( dbfHisMov )
      ( dbfHisMov )->( dbCloseArea() )
   end

   if dbfHisMovS <> nil
      ( dbfHisMovS )->( dbCloseArea() )
   end

   if dbfCliInc <> nil
      ( dbfCliInc )->( dbCloseArea() )
   end

   if dbfCliBnc <> nil
      ( dbfCliBnc )->( dbCloseArea() )
   end

   if dbfPedPrvL <> nil
      ( dbfPedPrvL )->( dbCloseArea() )
   end

   if dbfProMat <> nil
      ( dbfProMat )->( dbCloseArea() )
   end

   if !Empty( oStock )
      oStock:end()
   end

   if !Empty( oCtaRem )
      oCtaRem:end()
   end

   if !Empty( oNewImp )
      oNewImp:end()
   end

   if !Empty( oTipArt )
      oTipArt:end()
   end

   if !Empty( oGrpFam )
      oGrpFam:end()
   end

   if !Empty( oTrans )
      oTrans:End()
   end

   if !Empty( oUndMedicion )
      oUndMedicion:End()
   end

   if !Empty( oFraPub )
      oFraPub:end()
   end

   if !Empty( oBanco )
      oBanco:End()
   end

   if !Empty( oPais )
      oPais:End()
   end

   dbfIva      := nil
   dbfFPago    := nil
   dbfAgent    := nil
   dbfClient   := nil
   dbfFacCliP  := nil
   dbfFacCliL  := nil
   dbfFacCliT  := nil
   dbfFacCliD  := nil
   dbfFacCliS  := nil
   dbfAlbCliT  := nil
   dbfAlbCliL  := nil
   dbfAlbCliI  := nil
   dbfAlbCliD  := nil
   dbfAlbCliS  := nil
   dbfPedCliT  := nil
   dbfPedCliL  := nil
   dbfPedCliP  := nil
   dbfPedCliI  := nil
   dbfPedCliD  := nil
   dbfPreCliT  := nil
   dbfPreCliL  := nil
   dbfPreCliI  := nil
   dbfPreCliD  := nil
   dbfTikT     := nil
   dbfArticulo := nil
   dbfCodebar  := nil
   dbfFamilia  := nil
   dbfKit      := nil
   dbfTarPreT  := nil
   dbfTarPreL  := nil
   dbfTarPreS  := nil
   dbfPromoT   := nil
   dbfPromoL   := nil
   dbfPromoC   := nil
   dbfAlm      := nil
   dbfClientAtp:= nil
   dbfTVta     := nil
   dbfDiv      := nil
   oBandera    := nil
   dbfObrasT   := nil
   dbfDoc      := nil
   dbfFlt      := nil
   dbfOferta   := nil
   dbfPro      := nil
   dbfTblPro   := nil
   dbfRuta     := nil
   dbfArtDiv   := nil
   dbfCajT     := nil
   dbfAntCliT  := nil
   dbfUsr      := nil
   dbfInci     := nil
   dbfArtPrv   := nil
   dbfDelega   := nil
   dbfAgeCom   := nil
   dbfAlbPrvL  := nil
   dbfAlbPrvS  := nil
   dbfPedCliR  := nil
   dbfEmp      := nil
   dbfTblCnv   := nil
   dbfFacPrvT  := nil
   dbfFacPrvL  := nil
   dbfFacPrvS  := nil
   dbfRctPrvL  := nil
   dbfRctPrvS  := nil
   dbfProLin   := nil
   dbfProMat   := nil
   dbfHisMov   := nil
   dbfCliInc   := nil
   dbfPedPrvL  := nil
   dbfProMat   := nil

   oStock      := nil
   oNewImp     := nil
   oTrans      := nil
   oTipArt     := nil
   oGrpFam     := nil
   oUndMedicion:= nil
   oBanco      := nil
   oPais       := nil

   lOpenFiles  := .F.

   EnableAcceso()



Return ( !lOpenFiles )



FUNCTION FactCli( oMenuItem, oWnd, cCodCli, cCodArt, cCodPed, aNumDoc )

   local oRpl
   local oSnd
   local oImp
   local oPrv
   local oPdf
   local oMail
   local oLiq
   local oDel
   local oDup
   local oBtnEur
   local lEuro          := .F.
   local nLevel
   local oRotor

   IIF( oMenuItem == nil, oMenuItem := "01058", ) ;
   IIF( oWnd == nil, oWnd := oWnd(), ) ;
   IIF( aNumDoc == nil, aNumDoc := Array(5), ) ;
   IIF( cCodCli == nil, cCodCli := "", ) ;
   IIF( cCodArt == nil, cCodArt := "", ) ;
   IIF( cCodPed == nil, cCodPed := "", ) ;

   nLevel               := nLevelUsr( oMenuItem )
   if nAnd( nLevel, 1 ) <> 0
      msgStop( "Acceso no permitido." )
      Return .F.
   end





   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

   if !OpenFiles()
      Return .F.
   end

   DisableAcceso()



























   oWndBrw := TShell():New( 0, 0, 22, 80, "Facturas de clientes",, oWnd,,, .F.,,, ( dbfFacCliT ),,,,, {"Número", "Fecha", "Código", "Nombre", "Población", "Obra", "Agente", "Sesión", "NFC", "Pago"}, {||( WinAppRec( oWndBrw:oBrw, bEdtRec, dbfFacCliT, cCodCli, cCodArt, aNumDoc ) )}, {||( WinEdtRec( oWndBrw:oBrw, bEdtRec, dbfFacCliT, cCodCli, cCodArt, aNumDoc ) )}, {||( WinDelRec( oWndBrw:oBrw, dbfFacCliT, {|| QuiFacCli() } ) )}, {||( WinDupRec( oWndBrw:oBrw, bEdtRec, dbfFacCliT, cCodCli, cCodArt, aNumDoc ) )}, nil, nLevel, "Document_user1_16", ( 190 + ( 57 * 256 ) + ( 0 * 65536 ) ),, {||( WinZooRec( oWndBrw:oBrw, bEdtRec, dbfFacCliT ) )}, .T. )

      oWndBrw:lFechado     := .T.

      oWndBrw:bChgIndex    := {|| if( oUser():lFiltroVentas(), CreateFastFilter( cFiltroCajero, dbfFacCliT, .F., , cFiltroCajero ), CreateFastFilter( "", dbfFacCliT, .F. ) ) }

      oWndBrw:SetYearComboBoxChange( {|| YearComboBoxChange() } )

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión cerrada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| if( ( dbfFacCliT )->lCloFac, "Cerrada", "Abierta" ) }
         :bEditValue       := {|| ( dbfFacCliT )->lCloFac }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Zoom16" )
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Cobrado"
         :nHeadBmpNo       := 4
         :bStrData         := {|| cChkPagFacCli( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, dbfFacCliT, dbfFacCliP ) }
         :bBmpData         := {|| nChkPagFacCli( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, dbfFacCliT, dbfFacCliP ) }
         :nWidth           := 20
         :AddResource( "Bullet_Square_Green_16" )
         :AddResource( "Bullet_Square_Yellow_16" )
         :AddResource( "Bullet_Square_Red_16" )
         :AddResource( "ChgPre16" )
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Contabilizado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| if( ( dbfFacCliT )->lContab, "Contabilizado", "Pendiente" ) }
         :bEditValue       := {|| ( dbfFacCliT )->lContab }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "BmpConta16" )
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| if( ( dbfFacCliT )->lSndDoc, "Enviado", "No enviado" ) }
         :bEditValue       := {|| ( dbfFacCliT )->lSndDoc }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Lbl16" )
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Entregado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| !Empty( ( dbfFacCliT )->dFecEnt ) }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "hand_paper_16" )
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Exportado EDI"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfFacCliT )->lExpEdi }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Text_Code_16" )
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Exportado a Facturae 3.1 [Factura electrónica]"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfFacCliT )->lExpFac }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Document_plain_earth_16" )
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Incidencia"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nEstadoIncidencia( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) }
         :nWidth           := 20
         :lHide            := .T.
         :AddResource( "Bullet_Square_Red_16" )
         :AddResource( "Bullet_Square_Yellow_16" )
         :AddResource( "Bullet_Square_Green_16" )
         :AddResource( "informacion_16" )
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Rectificada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| lRectificadaCli( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, dbfFacCliT, dbfFacRecT ) }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Document_delete_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Impreso"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfFacCliT )->lImprimido }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "IMP16" )
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Tipo"
         :bEditValue       := {|| aTipFac[ if( ( dbfFacCliT )->lAlquiler, 2, 1 ) ] }
         :nWidth           := 50
         :lHide            := .T.
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( dbfFacCliT )->cSerie + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + ( dbfFacCliT )->cSufFac }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "NFC"
         :cSortOrder       := "cNfc"
         :bEditValue       := {|| ( dbfFacCliT )->cNFC }
         :nWidth           := 160
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :bEditValue       := {|| ( dbfFacCliT )->cCodDlg }
         :nWidth           := 20
         :lHide            := .T.
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión"
         :cSortOrder       := "cTurFac"
         :bEditValue       := {|| Trans( ( dbfFacCliT )->cTurFac, "######" ) }
         :nWidth           := 40
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecFac"
         :bEditValue       := {|| Dtoc( ( dbfFacCliT )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( dbfFacCliT )->cCodCaj }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Usuario"
         :bEditValue       := {|| ( dbfFacCliT )->cCodUsr }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| AllTrim( ( dbfFacCliT )->cCodCli ) }
         :nWidth           := 70
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| AllTrim( ( dbfFacCliT )->cNomCli ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Población"
         :cSortOrder       := "cPobCli"
         :bEditValue       := {|| AllTrim( ( dbfFacCliT )->cPobCli ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Agente"
         :cSortOrder       := "cCodAge"
         :bEditValue       := {|| ( dbfFacCliT )->cCodAge }
         :nWidth           := 50
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Pago"
         :cSortOrder       := "cCodPago"
         :bEditValue       := {|| ( dbfFacCliT )->cCodPago }
         :nWidth           := 40
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Ruta"
         :bEditValue       := {|| ( dbfFacCliT )->cCodRut }
         :nWidth           := 40
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Almacén"
         :bEditValue       := {|| ( dbfFacCliT )->cCodAlm }
         :nWidth           := 60
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Obra"
         :cSortOrder       := "cCodObr"
         :bEditValue       := {|| ( dbfFacCliT )->cCodObr }
         :nWidth           := 40
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( dbfFacCliT )->nTotNet }
         :cEditPicture     := cPorDiv( ( dbfFacCliT )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( dbfFacCliT )->nTotIva }
         :cEditPicture     := cPorDiv( ( dbfFacCliT )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "R.E."
         :bEditValue       := {|| ( dbfFacCliT )->nTotReq }
         :cEditPicture     := cPorDiv( ( dbfFacCliT )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( dbfFacCliT )->nTotFac }
         :cEditPicture     := cPorDiv( ( dbfFacCliT )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( if( lEuro, cDivChg(), ( dbfFacCliT )->cDivFac ), dbfDiv ) }
         :nWidth           := 30
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

   oWndBrw:CreateXFromCode()





   oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

   oWndBrw:AddSeaBar()








   oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )







   oDup := oWndBrw:NewAt( "DUP",,, {||( oWndBrw:RecDup() )}, "(D)uplicar", "D",, {|This|This:Toggle()}, 2,, .F. )









      oWndBrw:NewAt( "Dup",,, {||( DupSerie( oWndBrw ) )}, "Series",,,, 2, oDup, .F. )









   oWndBrw:NewAt( "EDIT",,, {||( oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )







   oWndBrw:NewAt( "ZOOM",,, {||( oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 8,, .F. )







   oDel := oWndBrw:NewAt( "DEL",,, {||( WinDelRec( oWndBrw:oBrw, dbfFacCliT, {|| QuiFacCli() } ) )}, "(E)liminar", "E",, {|This|This:Toggle()}, 16,, .F. )







      oWndBrw:NewAt( "DEL",,, {||( DelSerie( oWndBrw ) )}, "Series",,,, 16, oDel, .F. )







   oImp := oWndBrw:NewAt( "IMP",,, {||( GenFacCli( 1 ), oWndBrw:Refresh() )}, "(I)mprimir", "I",, {|This|This:Toggle()}, 32,, .F. )


      lGenFacCli( oWndBrw:oBrw, oImp, 1 )





   oWndBrw:NewAt( "SERIE1",,, {||( PrnSerie(), oWndBrw:Refresh() )}, "Imp(r)imir series", "R",,, 32,, .F. )







   oPrv := oWndBrw:NewAt( "PREV1",,, {||( GenFacCli( 2 ), oWndBrw:Refresh() )}, "(P)revisualizar", "P",, {|This|This:Toggle()}, 32,, .F. )


      lGenFacCli( oWndBrw:oBrw, oPrv, 2 )






   oPdf := oWndBrw:NewAt( "DOCLOCK",,, {||( GenFacCli( 3 ) )}, "Pd(f)", "F",, {|This|This:Toggle()}, 32,, .F. )


      lGenFacCli( oWndBrw:oBrw, oPdf, 3 )





   oMail := oWndBrw:NewAt( "Mail",,, {||( GenFacCli( 6 ) )}, "Correo electrónico",,, {|This|This:Toggle()}, 32,, .F. )


      lGenFacCli( oWndBrw:oBrw, oMail, 6 )




   oLiq := oWndBrw:NewAt( "Money2_",,, {||( lLiquida( oWndBrw:oBrw ) )}, "Cobrar",,,, 2,, .F. )







      oWndBrw:NewAt( "Money2_",,, {||( aGetSelRec( oWndBrw, {|| lLiquida( oWndBrw:oBrw, ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) }, "Liquidar series de facturas", .T., nil, .T., nil ) )}, "Cobrar series",,,, 4, oLiq, .F. )






   oWndBrw:NewAt( "BMPCONTA",,, {||( aGetSelRec( oWndBrw, {|lChk1, lChk2, oTree| CntFacCli( lChk1, lChk2, nil, .T., oTree, nil, nil, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfAntCliT, dbfAlbCliT, dbfClient, dbfDiv, dbfArticulo, dbfFPago, dbfIva, oNewImp ) }, "Contabilizar facturas", .F., "Simular resultados", .F., "Contabilizar recibos" ) )}, "(C)ontabilizar", "C",,, 4,, .F. )

   if oUser():lAdministrador()






      oWndBrw:NewAt( "CHGSTATE",,, {||( aGetSelRec( oWndBrw, {| lChk | lChgContabilizado( lChk ) }, "Cambiar estado", .F., "Contabilizado", .T. ) )}, "Cambiar es(t)ado", "T",,, 4,, .F. )

   end








   oSnd := oWndBrw:NewAt( "LBL",, "Seleccionar albaranes para ser enviados", {||lSnd( oWndBrw, dbfFacCliT )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, dbfFacCliT, "lSndDoc", .T., .T., .T. ) )}, "Todos",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, dbfFacCliT, "lSndDoc", .F., .T., .T. ) )}, "Ninguno",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, dbfFacCliT, "lSndDoc", .T., .F., .T. ) )}, "Abajo",,,, 4, oSnd, .F. )

if lBancas()





   oWndBrw:NewAt( "Dup",,, {||( FacCliExcelImport( oWndBrw ) )}, "Importar facturación diaria",,,, 2,, .F. )





   oWndBrw:NewAt( "Dup",,, {||( FacCliExcelNovotecno( oWndBrw ) )}, "Importar facturación de Novotecno",,,, 2,, .F. )

else





   oWndBrw:NewAt( "Document_plain_earth_",,, {||( aGetSelRec( oWndBrw, {|lChk1, lChk2, oTree| CreateFileFacturae( oTree, lChk1, lChk2 ) }, "Exportar facturas electrónicas a Facturae v 3.1", .F., "Firmar digitalmente", .F., "Enviar por correo electrónico" ) )}, "Exportar a Facturae",,,, 4,, .F. )





   oWndBrw:NewAt( "Text_Code_",,, {||( aGetSelRec( oWndBrw, {|lChk1, lChk2, oTree| ExportarEDI( lChk1, oTree ) }, "Exportar facturas a EDI", .F., "Solo las no exportadas", .T., "Segunda opcion", {|| CreateFileEDI() }, {|| CloseFileEDI() } ) )}, "Exportar a EDI",,,, 4,, .F. )

end






   oBtnEur := oWndBrw:NewAt( "BAL_EURO",,, {||( lEuro := !lEuro, oWndBrw:Refresh() )}, "M(o)neda", "O",,, 8,, .F. )

   if oUser():lAdministrador()






      oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( TDlgFlt():New( aItmFacCli(), dbfFacCliT ):ChgFields(), oWndBrw:Refresh() )}, "Cambiar campos",,, {|This|This:Toggle()}, 4,, .F. )







         oWndBrw:NewAt( "BMPCHG",,, {||( TDlgFlt():New( aColFacCli(), dbfFacCliL ):ChgFields(), oWndBrw:Refresh() )}, "Lineas",,,, 4, oRpl, .F. )

   end






   oWndBrw:NewAt( "INFO",,, {||( TTrazaDocumento():Activate( "11", ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) )}, "I(n)forme documento", "N",,, 4,, .F. )






   oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,, {|This|This:Toggle()},,, .F. )





      oWndBrw:NewAt( "USER1_",,, {||( EdtCli( ( dbfFacCliT )->cCodCli ) )}, "Modificar cliente",,,,, oRotor, .F. )





      oWndBrw:NewAt( "INFO",,, {||( InfCliente( ( dbfFacCliT )->cCodCli ) )}, "Informe de cliente",,,,, oRotor, .F. )





      oWndBrw:NewAt( "WORKER",,, {||( EdtObras( ( dbfFacCliT )->cCodCli, ( dbfFacCliT )->cCodObr, dbfObrasT ) )}, "Modificar obra",,,,, oRotor, .F. )





      oWndBrw:NewAt( "NOTEBOOK_USER1_",,, {||( if( !Empty( ( dbfFacCliT )->cNumPre ), ZooPreCli( ( dbfFacCliT )->cNumPre ), MsgStop( "No hay presupusto asociado" ) ) )}, "Visualizar presupuesto",,,,, oRotor, .F. )





      oWndBrw:NewAt( "CLIPBOARD_EMPTY_USER1_",,, {||( if( !Empty( ( dbfFacCliT )->cNumPed ), ZooPedCli( ( dbfFacCliT )->cNumPed ), MsgStop( "No hay pedido asociado" ) ) )}, "Visualizar pedido",,,,, oRotor, .F. )





      oWndBrw:NewAt( "DOCUMENT_PLAIN_USER1_",,, {||( if( !Empty( ( dbfFacCliT )->cNumAlb ), ZooAlbCli( ( dbfFacCliT )->cNumAlb ), MsgStop( "No hay albarán asociado" ) ) )}, "Visualizar albarán",,,,, oRotor, .F. )





      oWndBrw:NewAt( "Money2_businessman_",,, {||( RecCli( , , { ( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) } ) )}, "Modificar recibo",,,,, oRotor, .T. )





      oWndBrw:NewAt( "DOCUMENT_MONEY2_",,, {||( FacAntCli( nil, nil, ( dbfFacCliT )->cCodCli ) )}, "Generar anticipo",,,,, oRotor, .T. )





      oWndBrw:NewAt( "Note_",,, {||( FacCliNotas() )}, "Generar nota de agenda",,,,, oRotor, .T. )
   if ( "VI" $ cParamsMain() )






      oWndBrw:NewAt( "DOCUMENT_MONEY2_",,, {||( ExcelIsra() )}, "Excel israel",,,,, oRotor, .T. )
   end







   oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .T. )
   if !oUser():lFiltroVentas()
      oWndBrw:oActiveFilter:aTField       := aItmFacCli()
      oWndBrw:oActiveFilter:cDbfFilter    := dbfFlt
      oWndBrw:oActiveFilter:cTipFilter    := "11"
   end

   oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles() )},, oWndBrw:bLButtonUp )

   EnableAcceso()

   if !Empty( cCodCli ) .OR. !Empty( cCodArt ) .OR. !Empty( aNumDoc[ 1 ] ) .OR. !Empty( aNumDoc[ 2 ] ) .OR. !Empty( aNumDoc[ 3 ] ) .OR. !Empty( aNumDoc[ 4 ] ) .OR. !Empty( aNumDoc[ 5 ] )
      oWndBrw:RecAdd()
      cCodCli        := nil
      cCodArt        := nil
      aNumDoc        := Array( 5 )
   end

Return .T.



STATIC FUNCTION EdtRec( aTmp, aGet, dbfFacCliT, oBrw, cCodCli, cCodArt, nMode, aNumDoc )

   local n
   local oDlg
    local oFld
   local oBrwLin
   local oBrwInc
   local oBrwDoc
   local oBrwAnt
   local oBrwPgo
   local oSay              := Array( 12 )
   local cSay              := Array( 12 )
   local oSayLabels        := Array(  5 )
   local oBmpDiv
   local oBmpEmp
   local nOrd
   local oBtn
   local oBtnKit
   local oTlfCli
   local cTlfCli
   local oRieCli
   local nRieCli
   local oGetMasDiv
   local cGetMasDiv        := ""
   local cGetPctRet
   local cSerie            := cNewSer( "nFacCli", dbfCount )
   local lWhen             := if( oUser():lAdministrador(), nMode <> 3, if( nMode == 2, !aTmp[ 74 ], nMode <> 3 ) )
   local oSayGetRnt
   local cTipFac
   local oSayDias
   local oBmpGeneral

   do case
   case IsNil( aNumDoc )
      aNumDoc              := Array( 5 )
   case IsArray( aNumDoc )
      ASize( aNumDoc, 5 )
   end





   cOldCodCli              := aTmp[ 6 ]





   do case
   case nMode == 1

      if !lCurSesion()
         MsgStop( "No hay sesiones activas, imposible añadir documentos" )
         Return .F.
      end

      if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 4    ]  := cCurSesion()
      aTmp[ 26    ]  := Ctod("")
      aTmp[ 7    ]  := oUser():cAlmacen()
      aTmp[ 8    ]  := oUser():cCaja()
      aTmp[ 32   ]  := cDefFpg()
      aTmp[ 60    ]  := cDivEmp()
      aTmp[ 61    ]  := nChgDiv( aTmp[ 60 ], dbfDiv )
      aTmp[ 3    ]  := RetSufEmp()
      aTmp[ 24 ]  := .F.
      aTmp[ 59    ]  := .T.
      aTmp[ 66    ]  := cProCnt()
      aTmp[ 79    ]  := cCurUsr()
      aTmp[ 84    ]  := Ctod("")
      aTmp[ 86    ]  := oUser():cDelegacion()
      aTmp[ 58    ]  := uFieldEmpresa( "lIvaInc" )
      aTmp[ 94    ]  := Padr( "Gastos", 250 )
      aTmp[ 35    ]  := nIva( dbfIva, cDefIva() )
      aTmp[ 106    ]  := RetFld( aTmp[ 32 ], dbfFPago, "nEntIni" )
      aTmp[ 107    ]  := RetFld( aTmp[ 32 ], dbfFPago, "nPctDto" )

   case nMode == 4

      if !lCurSesion()
         MsgStop( "No hay sesiones activas, imposible añadir documentos" )
         Return .F.
      end

      if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada" )
         Return .F.
      end

      aTmp[ 5    ]  := GetSysDate()
      aTmp[ 4    ]  := cCurSesion()
      aTmp[ 37    ]  := ""
      aTmp[ 38    ]  := ""
      aTmp[ 39    ]  := ""
      aTmp[ 25    ]  := .F.
      aTmp[ 28    ]  := .F.
      aTmp[ 74    ]  := .F.
      aTmp[ 59    ]  := .T.
      aTmp[ 108       ]  := Space( 20 )
      aTmp[ 106    ]  := RetFld( aTmp[ 32 ], dbfFPago, "nEntIni" )
      aTmp[ 107    ]  := RetFld( aTmp[ 32 ], dbfFPago, "nPctDto" )

   case nMode == 2


      if aTmp[ 25 ] .AND. !ApoloMsgNoYes(  "La modificación de esta factura puede provocar descuadres contables." + Chr(13)+Chr(10) + "¿ Desea continuar ?", "Factura ya contabilizada" )
         return .F.
      end

   end





   cTipFac                 := aTipFac[ if( aTmp[ 91 ], 2, 1  ) ]





   if BeginTrans( aTmp, nMode )
      Return .F.
   end





   nOrd                    := ( dbfFacCliT )->( ordSetFocus( 1 ) )





   if Empty( Rtrim( aTmp[ 1 ] ) )
      aTmp[ 1 ]      := cSerie
   end

   if Empty( aTmp[ 18 ] )
      aTmp[ 18 ]     := Max( uFieldEmpresa( "nPreVta" ), 1 )
   end

   if Empty( aTmp[ 60 ] )
      aTmp[ 60 ]     := cDivEmp()
   end

   if Empty( aTmp[ 41 ] )
      aTmp[ 41 ]     := Padr( "General", 50 )
   end

   if Empty( aTmp[ 43 ] )
      aTmp[ 43 ]        := Padr( "Pronto pago", 50 )
   end





   nRieCli                 := oStock:nRiesgo( aTmp[ 6 ] )

   if Empty( aTmp[ 100 ] )
      aTmp[ 100 ]     := RetFld( aTmp[ 6 ], dbfClient, "Telefono" )
   end

   cPicUnd                 := MasUnd()
   cPouDiv                 := cPouDiv( aTmp[ 60 ], dbfDiv )
   cPorDiv                 := cPorDiv( aTmp[ 60 ], dbfDiv )
   cPinDiv                 := cPinDiv( aTmp[ 60 ], dbfDiv )
   nDouDiv                 := nDouDiv( aTmp[ 60 ], dbfDiv )
   nRouDiv                 := nRouDiv( aTmp[ 60 ], dbfDiv )
   cPpvDiv                 := cPpvDiv( aTmp[ 60 ], dbfDiv )
   nDpvDiv                 := nDpvDiv( aTmp[ 60 ], dbfDiv )





   cSay[ 2 ]               := RetFld( aTmp[ 7 ], dbfAlm )
   cSay[ 4 ]               := RetFld( aTmp[ 32], dbfFPago )
   cSay[ 8 ]               := RetFld( aTmp[ 20 ], dbfRuta )
   cSay[ 3 ]               := RetFld( aTmp[ 19 ], dbfAgent )
   cSay[ 5 ]               := RetFld( aTmp[ 21 ], dbfTarPreT )
   cSay[ 7 ]               := RetFld( aTmp[ 6 ] + aTmp[ 22 ], dbfObrasT, "cNomObr" )
   cSay[ 9 ]               := oTrans:cNombre( aTmp[ 72 ] )
   cSay[ 10]               := RetFld( aTmp[ 8 ], dbfCajT )
   cSay[ 11]               := RetFld( aTmp[ 79 ], dbfUsr, "cNbrUse" )
   cSay[ 12]               := RetFld( cCodEmp() + aTmp[ 86 ], dbfDelega, "cNomDlg" )





   InitTarifaCabecera( aTmp[ 18 ] )





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "facturas a clientes", "FACCLI",, .F.,,,,,, .F.,,,,,, .F., )
















      oFld := TFolder():ReDefine( 400, {"&Factura", "Da&tos", "&Incidencias", "D&ocumentos"}, { "FACCLI_1","FACCLI_2","PEDCLI_3","PEDCLI_4" }, oDlg,,,,, .F., )









      oBmpGeneral := TBitmap():ReDefine( 990, "Factura_cliente_48_alpha",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "Folder2_red_alpha_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "Information_48_alpha",, oFld:aDialogs[3],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "Address_book2_alpha_48",, oFld:aDialogs[4],,, .F., .F.,,, .F.,,, .T. )








      aGet[ 6 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],,, {||    ( loaCli( aGet, aTmp, nMode, oRieCli ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwClient( aGet[ 6 ], aGet[ 9 ] ), ::lValid() )}, nil, "Lupa",, )




      aGet[ 9 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 16 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )

      if uFieldEmpresa( "nCifRut" ) == 1





      aGet[ 15 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, aTmp[ 15 ], aTmp[ 15 ]:= u ) }, oFld:aDialogs[1],,, {||    ( CheckCif( aGet[ 15 ] ) )},,,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 16 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )

      else






      aGet[ 15 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, aTmp[ 15 ], aTmp[ 15 ]:= u ) }, oFld:aDialogs[1],, "@R 999999999-9", {||    ( CheckRut( aGet[ 15 ] ) )},,,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 16 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )

      end






      aGet[ 10 ] := TGetHlp():ReDefine( 183, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 16 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 10 ], Rtrim( aTmp[ 11 ] ) + Space( 1 ) + Rtrim( aTmp[ 12 ] ) )}, nil, "Environnment_View_16",, )




      aGet[ 14 ] := TGetHlp():ReDefine( 184, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 16 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[ 11 ] := TGetHlp():ReDefine( 185, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 16 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[ 12 ] := TGetHlp():ReDefine( 186, { | u | If( PCount()==0, aTmp[ 12 ], aTmp[ 12 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 16 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 100 ] := TGetHlp():ReDefine( 187, { | u | If( PCount()==0, aTmp[ 100 ], aTmp[ 100 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( lWhen .AND. ( !aTmp[ 16 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )





      oRieCli := TGetHlp():ReDefine( 182, { | u | If( PCount()==0, nRieCli, nRieCli:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 18 ] := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( ChangeTarifaCabecera( aTmp[ 18 ], dbfTmpLin, oBrwLin ) )},,,,,, .F., {||     ( nMode <> 3 .AND. ( lUsrMaster() .OR. oUser():lCambiarPrecio() ) )},, .F., .T.,,, {||      1}, {||      6},, nil,,, )













      aGet[ 60 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 60 ], aTmp[ 60 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cDivOut( aGet[ 60 ], oBmpDiv, aGet[ 61 ], @cPouDiv, @nDouDiv, @cPorDiv, @nRouDiv, @cPpvDiv, @nDpvDiv, oGetMasDiv, dbfDiv, oBandera ) )},,,,,, .F., {||     ( nMode == 1 .AND. ( dbfTmpLin )->( LastRec() ) == 0 )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ 60 ], oBmpDiv, aGet[ 61 ], dbfDiv, oBandera )}, nil, "LUPA",, )




      oBmpDiv := TBitmap():ReDefine( 191, ( cBmpDiv( aTmp[ 60 ], dbfDiv ) ),, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .F. )





        aGet[ 61 ] := TGetHlp():ReDefine( 192, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.9999",,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      aGet[ 79 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 79 ], aTmp[ 79 ]:= u ) }, oFld:aDialogs[2],,, {||    ( SetUsuario( aGet[ 79 ], oSay[ 11 ], nil, dbfUsr ) )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 11 ] := TGetHlp():ReDefine( 126, { | u | If( PCount()==0, cSay[ 11 ], cSay[ 11 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








      aGet[58] := TCheckBox():ReDefine( 200, { | u | If( PCount()==0, aTmp[58], aTmp[58]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( ( dbfTmpLin )->( LastRec() ) == 0 )}, .F. )











      aGet[21] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, aTmp[21], aTmp[21]:= u ) }, oFld:aDialogs[1],,, {||    ( cTarifa( aGet[21], oSay[ 5 ] ) )},,,,,, .F., {||     ( lWhen .AND. oUser():lAdministrador() )},, .F., .F.,,,,, {|Self|( BrwTarifa( aGet[21], oSay[ 5 ] ) )}, nil, "LUPA",, )




      oSay[ 5 ] := TGetHlp():ReDefine( 211, { | u | If( PCount()==0, cSay[ 5 ], cSay[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )












      aGet[ 22 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cObras( aGet[ 22 ], oSay[ 7 ], aTmp[ 6 ], dbfObrasT ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( brwObras( aGet[ 22 ], oSay[ 7 ], aTmp[ 6 ], dbfObrasT ) )}, nil, "LUPA",, )




      oSay[ 7 ] := TGetHlp():ReDefine( 221, { | u | If( PCount()==0, cSay[ 7 ], cSay[ 7 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )











      aGet[ 7 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[ 7 ], , oSay[ 2 ] ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 7 ], oSay[ 2 ] ) )}, nil, "LUPA",, )






      oSay[ 2 ] := TGetHlp():ReDefine( 231, { | u | If( PCount()==0, cSay[ 2 ], cSay[ 2 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( ExpAlmacen( aTmp[ 7 ], dbfTmpLin, oBrwLin ) )}, nil, "Bot",, )












      aGet[ 32 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cFPago( aGet[ 32 ], dbfFPago, oSay[ 4 ], aGet[ 106 ], aGet[ 107 ] ) )},,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,, {|Self|( BrwFPago( aGet[ 32 ], oSay[ 4 ] ) )}, nil, "LUPA",, )




      oSay[ 4 ] := TGetHlp():ReDefine( 241, { | u | If( PCount()==0, cSay[ 4 ], cSay[ 4 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ 110 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 110 ], aTmp[ 110 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,, {|Self|( BrwBncCli( aGet[ 110 ], aGet[ 111 ], aGet[ 112 ], aGet[ 113 ], aGet[ 114 ], aTmp[ 6 ] ) )}, nil, "LUPA",, )





      aGet[ 111 ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ 111 ], aTmp[ 111 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lCalcDC( aTmp[ 111 ], aTmp[ 112 ], aTmp[ 113 ], aTmp[ 114 ], aGet[ 113 ] ) )},,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 112 ] := TGetHlp():ReDefine( 421, { | u | If( PCount()==0, aTmp[ 112 ], aTmp[ 112 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lCalcDC( aTmp[ 111 ], aTmp[ 112 ], aTmp[ 113 ], aTmp[ 114], aGet[ 113 ] ) )},,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 113 ] := TGetHlp():ReDefine( 422, { | u | If( PCount()==0, aTmp[ 113 ], aTmp[ 113 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lCalcDC( aTmp[ 111 ], aTmp[ 112 ], aTmp[ 113 ], aTmp[ 114 ], aGet[ 113 ] ) )},,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 114 ] := TGetHlp():ReDefine( 423, { | u | If( PCount()==0, aTmp[ 114 ], aTmp[ 114 ]:= u ) }, oFld:aDialogs[1],, "9999999999", {||    ( lCalcDC( aTmp[ 111 ], aTmp[ 112 ], aTmp[ 113 ], aTmp[ 114 ], aGet[ 113 ] ) )},,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )











      aGet[ 19 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAgentes( aGet[ 19 ], dbfAgent, oSay[ 3 ], aGet[ 23 ], dbfAgeCom ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 19 ], oSay[ 3 ] ) )}, nil, "LUPA",, )






      oSay[ 3 ] := TGetHlp():ReDefine( 251, { | u | If( PCount()==0, cSay[ 3 ], cSay[ 3 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( !Empty( aTmp[ 19 ] ) .AND. lWhen )},, .F., .F.,,,,, {|Self|( ExpAgente( aTmp[ 19 ], aTmp[ 23 ], dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, nil, "Bot",, )






      aGet[ 23 ] := TGetHlp():ReDefine( 252, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( !Empty( aTmp[ 19 ] ) .AND. lWhen )},, .F., .T.,,,,,, nil,,, )




      oGetAge := TGetHlp():ReDefine( 253, { | u | If( PCount()==0, nTotAge, nTotAge:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )











        aGet[20] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[20], aTmp[20]:= u ) }, oFld:aDialogs[1],,, {||    ( cRuta( aGet[20], dbfRuta, oSay[ 8 ] ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwRuta( aGet[20 ], dbfRuta, oSay[ 8 ] ) )}, nil, "LUPA",, )




      oSay[ 8 ] := TGetHlp():ReDefine( 261, { | u | If( PCount()==0, cSay[ 8 ], cSay[ 8 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )









        TButton():ReDefine( 500, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .F. ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





        TButton():ReDefine( 501, {||( EdtDeta( oBrwLin, bEdtDet, aTmp, .F., nMode ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )






        TButton():ReDefine( 502, {||( WinDelRec( oBrwLin, dbfTmpLin, {|| DelDeta() }, {|| RecalculaTotal( aTmp ) } ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo )  )},,, .F. )



        TButton():ReDefine( 503, {||( WinZooRec( oBrwLin, bEdtDet, dbfTmpLin, .F., nMode, aTmp ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )





      TButton():ReDefine( 515, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .T. ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo )  )},,, .F. )





      TButton():ReDefine( 524, {||( DbSwapUp( dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen )},,, .F. )





        TButton():ReDefine( 525, {||( DbSwapDown( dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[1],,, .F., {||     ( lWhen )},,, .F. )




      oBtnKit := TButton():ReDefine( 526, {||( ShowKit( dbfFacCliT, dbfTmpLin, oBtnKit, oBrwLin, .T. ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )





      oBrwLin                 := IXBrowse():New( oFld:aDialogs[1] )

      oBrwLin:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
      oBrwLin:nClrText        := {|| if( ( dbfTmpLin )->lKitChl, 8421504, 0 ) }

      oBrwLin:cAlias          := dbfTmpLin

      oBrwLin:nMarqueeStyle   := 6
      oBrwLin:cName           := "Factura de cliente.Detalle"

      oBrwLin:CreateFromResource( 1 )

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Oferta"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfTmpLin )->lLinOfe }
         :nWidth              := 60
         :SetCheck( { "Star_Red_16", "Nil16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Número"
         :bEditValue          := {|| ( dbfTmpLin )->nNumLin }
         :cEditPicture        := "9999"
         :nWidth              := 55
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Código"
         :bEditValue          := {|| ( dbfTmpLin )->cRef }
         :nWidth              := 60
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "C. Barras"
         :bEditValue          := {|| cCodigoBarrasDefecto( ( dbfTmpLin )->cRef, dbfCodeBar ) }
         :nWidth              := 100
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Descripción"
         :bEditValue          := {|| Descrip( dbfTmpLin ) }
         :nWidth              := 240
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Código proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cCodPrv ) }
         :nWidth              := 50
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Nombre proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cNomPrv ) }
         :nWidth              := 150
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Referencia proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cRefPrv ) }
         :nWidth              := 50
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 1"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr1 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 2"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr2 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Lote"
         :bEditValue          := {|| ( dbfTmpLin )->cLote }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Caducidad"
         :bEditValue          := {|| Dtoc( ( dbfTmpLin )->dFecCad ) }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := cNombreUnidades()
         :bEditValue          := {|| nTotNFacCli( dbfTmpLin ) }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Unidad de medición"
         :bEditValue          := {|| ( dbfTmpLin )->cUnidad }
         :nWidth              := 105
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Alm."
         :bEditValue          := {|| ( dbfTmpLin )->cAlmLin }
         :nWidth              := 34
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Precio"
         :bEditValue          := {|| nTotUFacCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Dto."
         :bEditValue          := {|| ( dbfTmpLin )->nDto }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 55
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Dto. Lin."
         :bEditValue          := {|| nDtoUFacCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Prm."
         :bEditValue          := {|| ( dbfTmpLin )->nDtoPrm }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Age"
         :bEditValue          := {|| ( dbfTmpLin )->nComAge }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% " + cImp()
         :bEditValue          := {|| ( dbfTmpLin )->nIva }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 45
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Portes"
         :bEditValue          := {|| nTrnUFacCli( dbfTmpLin, nDpvDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Punto verde"
         :bEditValue          := {|| nPntUFacCli( dbfTmpLin, nDpvDiv ) }
         :cEditPicture        := cPpvDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Imp. especiales"
         :bEditValue          := {|| nTotIFacCli( dbfTmpLin, nDouDiv, nRouDiv ) }
         :cEditPicture        := cPorDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end


      with object ( oBrwLin:AddCol() )
         :cHeader             := "Total"
         :bEditValue          := {|| nTotLFacCli( dbfTmpLin, nDouDiv, nRouDiv, nil, .T., aTmp[ 117 ], .T. ) }
         :cEditPicture        := cPorDiv
         :nWidth              := 94
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Garantia"
         :bEditValue          := {|| ( dbfTmpLin )->nMesGrt }
         :cEditPicture        := "99"
         :nWidth              := 30
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Fecha"
         :bEditValue          := {|| Dtoc( ( dbfTmpLin )->dFecha ) }
         :nWidth              := 80
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Im. Imprimido"
         :bStrData            := {|| "" }
         :bEditValue          := {||( dbfTmpLin )->lImpLin }
         :nWidth              := 20
         :lHide               := .T.
         :SetCheck( { "Lbl16", "Nil16" } )
      end

      if nMode <> 3
         oBrwLin:bLDblClick   := {|| EdtDeta( oBrwLin, bEdtDet, aTmp, .F., nMode ) }
      end








      aGet[ 41 ] := TGetHlp():ReDefine( 299, { | u | If( PCount()==0, aTmp[ 41 ], aTmp[ 41 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







     aGet[42 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],, "@ER 999.99%", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .T.,,,,,, nil,,, )




      aGet[ 43 ] := TGetHlp():ReDefine( 309, { | u | If( PCount()==0, aTmp[ 43 ], aTmp[ 43 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







        aGet[ 44 ] := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[1],, "@ER 999.99%", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .T.,,,,,, nil,,, )








        aGet[ 45 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







        aGet[ 46 ] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[1],, "@ER 999.99%", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .T.,,,,,, nil,,, )




        aGet[ 47 ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







        aGet[ 48 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[1],, "@ER 999.99%", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .T.,,,,,, nil,,, )







      aGet[ 92 ] := TCheckBox():ReDefine( 361, { | u | If( PCount()==0, aTmp[ 92 ], aTmp[ 92 ]:= u ) }, oFld:aDialogs[ 1 ],,,,,,, .F.,, .F. )





      aGet[ 93 ] := TGetHlp():ReDefine( 360, { | u | If( PCount()==0, aTmp[ 93 ], aTmp[ 93 ]:= u ) }, oFld:aDialogs[ 1 ],, cPorDiv,,,,,,, .F., {||     aTmp[ 92 ]},, .F., .F.,,,,,, nil,,, )




      aGet[ 94 ] := TGetHlp():ReDefine( 411, { | u | If( PCount()==0, aTmp[ 94 ], aTmp[ 94 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







      aGet[ 36 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[1],, cPorDiv, {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )









      aGet[ 35 ] := TGetHlp():ReDefine( 412, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lTiva( dbfIva, aTmp[ 35 ] ) .AND. RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 35 ], dbfIva, , .T. ) )}, nil, "LUPA",, )





      oBrwIva                        := IXBrowse():New( oFld:aDialogs[ 1 ] )

      oBrwIva:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwIva:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwIva:SetArray( aTotIva, , , .F. )

      oBrwIva:nMarqueeStyle          := 6
      oBrwIva:lRecordSelector        := .F.
      oBrwIva:lHScroll               := .F.

      oBrwIva:CreateFromResource( 370 )

      with object ( oBrwIva:AddCol() )
         :cHeader          := "Base"
         if uFieldEmpresa( "lIvaImpEsp" )
            :bStrData      := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil, Trans( ( aTotIva[ oBrwIva:nArrayAt, 2 ] + aTotIva[ oBrwIva:nArrayAt, 6 ] ), cPorDiv ), "" ) }
         else
            :bStrData      := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil, Trans( aTotIva[ oBrwIva:nArrayAt, 2 ], cPorDiv ), "" ) }
         end
         :nWidth           := 95
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader       := "%" + cImp()
         :bStrData      := {|| if( !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ), aTotIva[ oBrwIva:nArrayAt, 3 ], "" ) }
         :bEditValue    := {|| aTotIva[ oBrwIva:nArrayAt, 3 ] }
         :nWidth        := 78
         :cEditPicture  := "@E 999.99"
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
         :nEditType     := 1
         :bEditWhen     := {|| !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ) }
         :bOnPostEdit   := {|o,x| EdtIva( o, x, aTotIva[ oBrwIva:nArrayAt, 3 ], dbfTmpLin, dbfIva, oBrwLin ), RecalculaTotal( aTmp ) }
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := cImp()
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil, Trans( aTotIva[ oBrwIva:nArrayAt, 8 ], cPorDiv ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "% R.E."
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil .AND. aTmp[ 56 ],  Trans( aTotIva[ oBrwIva:nArrayAt, 4 ], "@E 999.99"), "" ) }
         :nWidth           := 71
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "R.E."
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil .AND. aTmp[ 56 ],  Trans( aTotIva[ oBrwIva:nArrayAt, 9 ], cPorDiv ),    "" ) }
         :nWidth           := 71
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end








      oGetNet := TSay():ReDefine( 401, {|| nTotNet}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oGetIva := TSay():ReDefine( 405, {|| nTotIva}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[ 56 ] := TCheckBox():ReDefine( 406, { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ) )},,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, .F. )



      oGetReq := TSay():ReDefine( 407, {|| nTotReq}, oFld:aDialogs[1],,,, .F.,, .F., .F. )




      oGetTotal := TSay():ReDefine( 485, {|| nTotal}, oFld:aDialogs[1],,,, .F., oFont, .F., .F. )






      aGet[ 117 ] := TCheckBox():ReDefine( 409, { | u | If( PCount()==0, aTmp[ 117 ], aTmp[ 117 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ), oBrwLin:Refresh() )},,,,, .F., {||     ( lWhen .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, .F. )



      oGetTotPnt := TSay():ReDefine( 404, {|| nTotPnt}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oGetTrn := TSay():ReDefine( 402, {|| nTotTrn}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oGetTotIvm := TSay():ReDefine( 403, {|| nTotIvm}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oSayGetRnt := TSay():ReDefine( 800,, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oGetRnt := TGetHlp():ReDefine( 408, { | u | If( PCount()==0, nTotRnt, nTotRnt:= u ) }, oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




      oGetMasDiv := TSay():ReDefine( 488, {|| cGetMasDiv}, oFld:aDialogs[1],,,, .F., oFont, .F., .F. )







      aGet[ 77 ] := TComboBox():ReDefine( 440, { | u | If( PCount()==0, aTmp[ 77 ], aTmp[ 77 ]:= u ) }, { "Ret. S/Base", "Ret. S/Total" }, oFld:aDialogs[ 1 ],, {||    ( RecalculaTotal( aTmp ) )}, {|Self|( RecalculaTotal( aTmp ) )},,,, .F., {||     ( lWhen )},,,,, )







     aGet[ 78 ] := TGetHlp():ReDefine( 490, { | u | If( PCount()==0, aTmp[ 78 ], aTmp[ 78 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99",,,,,,, .F., {||     ( lWhen )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )



      oGetPctRet := TSay():ReDefine( 491, {|| cGetPctRet}, oFld:aDialogs[1],,,, .F.,, .F., .F. )









      aGet[1] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[1], aTmp[1]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( aTmp[1] >= "A" .AND. aTmp[1] <= "Z" )},,,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[1] ) )}, {||  ( DwSerie( aGet[1] ) )},,,, nil,,, )

         aGet[ 1 ]:bLostFocus := {|| aGet[ 66 ]:cText( cProCnt( aTmp[ 1 ] ) ) }





        aGet[2] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[2], aTmp[2]:= u ) }, oFld:aDialogs[1],, "999999999",,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





        aGet[3] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[3], aTmp[3]:= u ) }, oFld:aDialogs[1],, "@!",,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






      oTipFac := TComboBox():ReDefine( 217, { | u | If( PCount()==0, cTipFac, cTipFac:= u ) }, aTipFac, oFld:aDialogs[1],,, {|Self|( SetDialog( aGet, oSayDias, oSayGetRnt, oGetRnt ) )},,,, .F., {||     ( ( dbfTmpLin )->( LastRec() ) == 0 )},,,,, )






      aGet[ 5 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen )},, .F., .T.,,,,, {|Self|aGet[ 5 ]:cText( Calendario( aTmp[ 5 ] ) )}, nil,,, )




      aGet[ 108 ] := TGetHlp():ReDefine( 570, { | u | If( PCount()==0, aTmp[ 108 ], aTmp[ 108 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )







      aGet[ 90 ] := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 90 ], aTmp[ 90 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,, 112, )







      aGet[ 89 ] := TGetHlp():ReDefine( 113, { | u | If( PCount()==0, aTmp[ 89 ], aTmp[ 89 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,, 114, )





      oSayDias := TSay():ReDefine( 115, {||      ( aTmp[ 89 ] - aTmp[ 90 ] )}, oFld:aDialogs[1], "9999",,, .F.,, .F., .F. )







      oBtnPre := TBtnBmp():ReDefine( 601, "Notebook_user1_16",,,,, {|Self|( BrwPreCli( aGet[ 39 ], dbfPreCliT, dbfPreCliL, dbfIva, dbfDiv, dbfFPago, aGet[ 58 ] ) )}, oFld:aDialogs[1], .F.,, .F., "Importar presupuesto",,,,, !.T.,, .F.,,, .F., !.F. )







      oBtnPed := TBtnBmp():ReDefine( 602, "Clipboard_empty_user1_16",,,,, {|Self|( BrwPedCli( aGet[ 38 ], dbfPedCliT, dbfPedCliL, dbfIva, dbfDiv, dbfFPago, aGet[ 58 ] ) )}, oFld:aDialogs[1], .F.,, .F., "Importar pedido",,,,, !.T.,, .F.,,, .F., !.F. )







      oBtnAlb := TBtnBmp():ReDefine( 603, "Document_plain_user1_16",,,,, {|Self|( BrwAlbCli( aGet[ 37 ], aGet[ 58 ] ) )}, oFld:aDialogs[1], .F.,, .F., "Importar albaran",,,,, !.T.,, .F.,,, .F., !.F. )





      oBtnGrp := TButton():ReDefine( 512, {||( GrpAlb( aGet, aTmp, oBrwLin  ), oBrwPgo:Refresh() )}, oFld:aDialogs[1],,, .F., {||     ( lWhen .AND. Empty( aTmp[ 37 ] ) )},,, .F. )






      aGet[ 37 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 37 ], aTmp[ 37 ]:= u ) }, oFld:aDialogs[1],, "@R #/#########/##", {||    ( cAlbCli( aGet, aTmp, oBrwLin, oBrwPgo, nMode ), SetDialog( aGet, oSayDias, oSayGetRnt, oGetRnt ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )






      aGet[ 38 ] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[1],, "@R #/#########/##", {||    ( cPedCli( aGet, aTmp, oBrwLin, oBrwPgo, nMode ), SetDialog( aGet, oSayDias, oSayGetRnt, oGetRnt ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )






      aGet[ 39 ] := TGetHlp():ReDefine( 152, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[1],, "@R #/#########/##", {||    ( cPreCli( aGet, aTmp, oBrwLin, nMode ), SetDialog( aGet, oSayDias, oSayGetRnt, oGetRnt ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )









     aGet[ 106 ] := TGetHlp():ReDefine( 550, { | u | If( PCount()==0, aTmp[ 106 ], aTmp[ 106 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99",,,,,,, .F., {||     ( lWhen )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,, 552, )




      oGetEnt := TGetHlp():ReDefine( 551, { | u | If( PCount()==0, nTotEnt, nTotEnt:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









     aGet[ 107 ] := TGetHlp():ReDefine( 560, { | u | If( PCount()==0, aTmp[ 107 ], aTmp[ 107 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99",,,,,,, .F., {||     ( lWhen )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,, 562, )




      oGetDtoEnt := TGetHlp():ReDefine( 561, { | u | If( PCount()==0, nTotDtoEnt, nTotDtoEnt:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )








      aGet[ 86 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 86 ], aTmp[ 86 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 12 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSay[ 12 ], cSay[ 12 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )











      aGet[ 72 ] := TGetHlp():ReDefine( 235, { | u | If( PCount()==0, aTmp[ 72 ], aTmp[ 72 ]:= u ) }, oFld:aDialogs[2],,, {||    ( LoadTrans( aTmp, aGet[ 72 ], aGet[ 73 ], oSay[ 9 ] ) )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( oTrans:Buscar( aGet[ 72 ] ), .T. )}, nil, "LUPA",, )




      oSay[ 9 ] := TGetHlp():ReDefine( 236, { | u | If( PCount()==0, cSay[ 9 ], cSay[ 9 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )





      aGet[ 73 ] := TGetHlp():ReDefine( 237, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )











      aGet[ 8 ] := TGetHlp():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[2],,, {||    cCajas( aGet[ 8 ], dbfCajT, oSay[ 10 ] )},,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 8 ], oSay[ 10 ] ) )}, nil, "LUPA",, )




      oSay[ 10 ] := TGetHlp():ReDefine( 166, { | u | If( PCount()==0, cSay[ 10 ], cSay[ 10 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )








      aGet[66] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[66], aTmp[66]:= u ) }, oFld:aDialogs[2],, "@R ###.######", {||    ( ChkProyecto( aTmp[66], oSay[ 6 ] ), .T. )},,,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. lWhen )},, .F., .F.,,,,, {|Self|( BrwProyecto( aGet[66], oSay[ 6 ] ) )}, nil, "LUPA",, )




      oSay[ 6 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, cSay[ 6 ], cSay[ 6 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






      aGet[33] := TGetHlp():ReDefine( 128, { | u | If( PCount()==0, aTmp[33], aTmp[33]:= u ) }, oFld:aDialogs[2],, "999",,,,,,, .F., {||     ( lWhen )},, .F., .T.,,,,,, nil,,, )





      aGet[ 27 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, aTmp[ 27 ], aTmp[ 27 ]:= u ) }, oFld:aDialogs[2],, "@!",,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )










      aGet[ 26 ] := TGetHlp():ReDefine( 162, { | u | If( PCount()==0, aTmp[ 26 ], aTmp[ 26 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen )},, .F., .T.,,,,, {|Self|aGet[26]:cText( Calendario( aTmp[26] ) )}, nil,,, )




      aGet[ 98 ] := TGetHlp():ReDefine( 163, { | u | If( PCount()==0, aTmp[ 98 ], aTmp[ 98 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )




      aGet[62] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[62], aTmp[62]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )




      aGet[63] := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, aTmp[63], aTmp[63]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )




      aGet[29] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[29], aTmp[29]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )






      aGet[ 83 ] := TCheckBox():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 83 ], aTmp[ 83 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( lWhen .AND. lUsrMaster() )}, .F. )




      aGet[ 84 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 84 ], aTmp[ 84 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )




      aGet[ 85 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 85 ], aTmp[ 85 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )







      aGet[ 95 ] := TCheckBox():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 95 ], aTmp[ 95 ]:= u ) }, oFld:aDialogs[2],, {||( lChangeEDI( aGet, aTmp ) )},,,,, .F., {||     ( lWhen .AND. lUsrMaster() )}, .F. )




      aGet[ 96 ] := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, aTmp[ 96 ], aTmp[ 96 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )




      aGet[ 97 ] := TGetHlp():ReDefine( 132, { | u | If( PCount()==0, aTmp[ 97 ], aTmp[ 97 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( lWhen .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )





      aGet[ 31 ] := TMultiGet():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( lWhen )}, .F.,, )





      aGet[ 30 ] := TMultiGet():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( lWhen )}, .F.,, )






      oBrwPgo                 := IXBrowse():New( oFld:aDialogs[2] )

      oBrwPgo:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwPgo:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwPgo:cAlias          := dbfTmpPgo
      oBrwPgo:cName           := "Factura de cliente.Pagos"

      oBrwPgo:nMarqueeStyle   := 6

      oBrwPgo:CreateFromResource( 260 )

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Cr. Sesión cerrada"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfTmpPgo )->lCloPgo }
         :nWidth              := 20
         :lHide               := .T.
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Cobrado"
         :bStrData            := {|| "" }
         :bBmpData            := {|| nEstadoRecibo( dbfTmpPgo ) }
         :nWidth              := 46
         :AddResource( "Cnt16" )
         :AddResource( "Sel16" )
         :AddResource( "UndoRed16" )
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Cn. Contabilizado"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfTmpPgo )->lConPgo }
         :nWidth              := 20
         :lHide               := .T.
         :SetCheck( { "Cnt16", "Nil16" } )
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Sesión"
         :bEditValue          := {|| ( dbfTmpPgo )->cTurRec }
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Expedido"
         :bEditValue          := {|| DtoC( ( dbfTmpPgo )->dPreCob ) }
         :nWidth              := 82
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Vencimiento"
         :bEditValue          := {|| DtoC( ( dbfTmpPgo )->dFecVto ) }
         :nWidth              := 82
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Cobro"
         :bEditValue          := {|| DtoC( ( dbfTmpPgo )->dEntrada ) }
         :lHide               := .T.
         :nWidth              := 70
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Descripción"
         :bEditValue          := {|| ( dbfTmpPgo )->cDescrip }
         :nWidth              := 182
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Div."
         :bEditValue          := {|| cSimDiv( ( dbfTmpPgo )->cDivPgo, dbfDiv ) }
         :nWidth              := 30
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Importe"
         :bEditValue          := {|| ( dbfTmpPgo )->nImporte }
         :cEditPicture        := cPorDiv
         :nWidth              := 105
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      if nMode == 2
         oBrwPgo:bLDblClick   := {|| ExtEdtRecCli( dbfTmpPgo, dbfFacCliT, dbfFacCliL, dbfAntCliT, dbfFPago, dbfAgent, dbfCajT, dbfIva, dbfDiv, oCtaRem, oBanco ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) }
      end





      TButton():ReDefine( 501, {||( ExtEdtRecCli( dbfTmpPgo, dbfFacCliT, dbfFacCliL, dbfAntCliT, dbfFPago, dbfAgent, dbfCajT, dbfIva, dbfDiv, oCtaRem, oBanco ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 502, {||( ExtDelRecCli( dbfTmpPgo ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 506, {||( VisRecCli( ( dbfTmpPgo )->cSerie + Str( ( dbfTmpPgo )->nNumFac ) + ( dbfTmpPgo )->cSufFac + Str( ( dbfTmpPgo )->nNumRec ) + ( dbfTmpPgo )->cTipRec, .F. ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 505, {||( PrnRecCli( ( dbfTmpPgo )->cSerie + Str( ( dbfTmpPgo )->nNumFac ) + ( dbfTmpPgo )->cSufFac + Str( ( dbfTmpPgo )->nNumRec ) + ( dbfTmpPgo )->cTipRec, .F. ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )






      oBrwAnt                 := IXBrowse():New( oFld:aDialogs[2] )

      oBrwAnt:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwAnt:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwAnt:cAlias          := dbfTmpAnt
      oBrwAnt:cName           := "Factura de cliente.Anticipos"

      oBrwAnt:nMarqueeStyle   := 6

      oBrwAnt:CreateFromResource( 290 )

      with object ( oBrwAnt:AddCol() )
         :cHeader             := "Número"
         :bEditValue          := {|| ( dbfTmpAnt )->cSerAnt + "/" + AllTrim( Str( ( dbfTmpAnt )->nNumAnt ) ) + "/" + ( dbfTmpAnt )->cSufAnt }
         :nWidth              := 70
      end

      with object ( oBrwAnt:AddCol() )
         :cHeader             := "Fecha"
         :bEditValue          := {|| Dtoc( ( dbfTmpAnt )->dFecAnt ) }
         :nWidth              := 88
      end

      with object ( oBrwAnt:AddCol() )
         :cHeader             := "Cliente"
         :bEditValue          := {|| Rtrim( ( dbfTmpAnt )->cCodCli ) }
         :nWidth              := 70
      end

      with object ( oBrwAnt:AddCol() )
         :cHeader             := "Nombre"
         :bEditValue          := {|| AllTrim( ( dbfTmpAnt )->cNomCli ) }
         :nWidth              := 194
      end

      with object ( oBrwAnt:AddCol() )
         :cHeader             := "Div."
         :bEditValue          := {|| cSimDiv( ( dbfTmpAnt )->cDivAnt, dbfDiv ) }
         :nWidth              := 30
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwAnt:AddCol() )
         :cHeader             := "Importe"
         :bEditValue          := {|| nTotAntCli( dbfTmpAnt, dbfIva, dbfDiv ) }
         :cEditPicture        := cPorDiv
         :nWidth              := 124
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end





      TButton():ReDefine( 270, {||( BrwAntCli( , dbfAntCliT, dbfIva, dbfDiv, dbfTmpAnt, oBrwAnt ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[ 2 ],,, .F., {||     ( lWhen )},,, .F. )





      TButton():ReDefine( 400, {||( BrwAntCli( aTmp[ 6 ], dbfAntCliT, dbfIva, dbfDiv, dbfTmpAnt, oBrwAnt ) )}, oFld:aDialogs[ 2 ],,, .F., {||     ( lWhen )},,, .F. )





      TButton():ReDefine( 280, {||( delRecno( dbfTmpAnt, oBrwAnt ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[ 2 ],,, .F., {||     ( lWhen )},,, .F. )








      oGetTotPg := TSay():ReDefine( 455, {|| nTotal}, oFld:aDialogs[2],,,, .F.,, .F., .F. )



      oGetPag := TSay():ReDefine( 460, {|| 0}, oFld:aDialogs[2],,,, .F.,, .F., .F. )



      oGetAnt := TSay():ReDefine( 470, {|| 0}, oFld:aDialogs[2],,,, .F.,, .F., .F. )



      oGetPdt := TSay():ReDefine( 480, {|| 0}, oFld:aDialogs[2],,,, .F.,, .F., .F. )





      oGetPes := TGetHlp():ReDefine( 570, { | u | If( PCount()==0, nTotPes, nTotPes:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oGetDif := TGetHlp():ReDefine( 580, { | u | If( PCount()==0, nTotalDif, nTotalDif:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oBrwInc                 := IXBrowse():New( oFld:aDialogs[ 3 ] )

      oBrwInc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwInc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwInc:cAlias          := dbfTmpInc

      oBrwInc:nMarqueeStyle   := 6
      oBrwInc:cName           := "Factura de cliente.Incidencia"

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Re. Resuelta"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpInc )->lListo }
            :nWidth           := 90
            :SetCheck( { "Sel16", "Cnt16" } )
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Código"
            :bEditValue       := {|| ( dbfTmpInc )->cCodTip }
            :nWidth           := 75
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Incidencia"
            :bEditValue       := {|| cNomInci( ( dbfTmpInc )->cCodTip, dbfInci ) }
            :nWidth           := 270
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpInc )->dFecInc ) }
            :nWidth           := 100
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpInc )->mDesInc }
            :nWidth           := 380
         end

         if nMode <> 3
            oBrwInc:bLDblClick   := {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) }
         else
            oBrwInc:bLDblClick   := {|| WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) }
         end

         oBrwInc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( lWhen )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( lWhen )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( lWhen )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F.,,,, .F. )



      oBrwDoc                 := TXBrowse():New( oFld:aDialogs[ 4 ] )

      oBrwDoc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDoc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDoc:cAlias          := dbfTmpDoc

      oBrwDoc:nMarqueeStyle   := 6
      oBrwDoc:nRowHeight      := 40
      oBrwDoc:nDataLines      := 2

      with object ( oBrwDoc:AddCol() )
         :cHeader          := "Documento"
         :bEditValue       := {|| Rtrim( ( dbfTmpDoc )->cNombre ) + Chr(13)+Chr(10) + Space( 5 ) + Rtrim( ( dbfTmpDoc )->cRuta ) }
         :nWidth           := 940
      end

      if nMode <> 3
         oBrwDoc:bLDblClick   := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( ( dbfTmpDoc )->cRuta ) ) }
      end

      oBrwDoc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( lWhen )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( lWhen )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( lWhen )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwDoc, bEdtDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( ShellExecute( oDlg:hWnd, "open", rTrim( ( dbfTmpDoc )->cRuta ) ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )






      oMeter      := TMeter():ReDefine( 200, { | u | if( pCount() == 0, nMeter, nMeter := u ) }, 10, oDlg, .F., , , .T., ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ), , ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) ) )





      TButton():ReDefine( 3, {||( RecFacCli( aTmp ), oBrwLin:Refresh(), RecalculaTotal( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





      TButton():ReDefine( 4, {||( if( EndTrans( aTmp, aGet, oBrw, oBrwLin, oBrwPgo, aNumAlb, nMode, oDlg ), GenFacCli( 1 ), ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      oBtn := TButton():ReDefine( 1, {||( EndTrans( aTmp, aGet, oBrw, oBrwLin, oBrwPgo, aNumAlb, nMode, oDlg ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( If( ExitNoSave( nMode, dbfTmpLin ), oDlg:end(), ) )}, oDlg,,, .F.,,,, .T. )

      oSayLabels[ 1 ] := TGroup():ReDefine( 700,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 2 ] := TSay():ReDefine( 708,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 3 ] := TSay():ReDefine( 709,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 4 ] := TSay():ReDefine( 710,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 5 ] := TSay():ReDefine( 712,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )





      oBmpEmp := TBitmap():ReDefine( 500,, "Bmp\ImgFacCli.bmp", oDlg,,, .F., .F.,,, .F.,,, .F. )






   if nMode <> 3

      oFld:aDialogs[1]:AddFastKey( 113, {|| AppDeta( oBrwLin, bEdtDet, aTmp, .F. ) } )
      oFld:aDialogs[1]:AddFastKey( 114, {|| EdtDeta( oBrwLin, bEdtDet, aTmp, .F., nMode ) } )
      oFld:aDialogs[1]:AddFastKey( 115, {|| WinDelRec( oBrwLin, dbfTmpLin, {|| DelDeta() }, {|| RecalculaTotal( aTmp ) } ) } )

      oFld:aDialogs[3]:AddFastKey( 113, {|| WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 114, {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 115, {|| WinDelRec( oBrwInc, dbfTmpInc ) } )

      oFld:aDialogs[4]:AddFastKey( 113, {|| WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 114, {|| WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 115, {|| WinDelRec( oBrwDoc, dbfTmpDoc ) } )

      oDlg:AddFastKey( 117,             {|| if( EndTrans( aTmp, aGet, oBrw, oBrwLin, oBrwPgo, aNumAlb, nMode, oDlg ), GenFacCli( 1 ), ) } )
      oDlg:AddFastKey( 116,             {|| EndTrans( aTmp, aGet, oBrw, oBrwLin, oBrwPgo, aNumAlb, nMode, oDlg ) } )
      oDlg:AddFastKey( 65,                {|| if( GetKeyState( 17 ), CreateInfoArticulo(), ) } )

   end

   do case
      case nMode == 1 .AND. lRecogerUsuario() .AND. Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 79 ], dbfUsr ), , oDlg:End() ) }

      case nMode == 1 .AND. lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 79 ], dbfUsr ), AppDeta( oBrwLin, bEdtDet, aTmp, .F., cCodArt ), oDlg:End() ) }

      case nMode == 1 .AND. !lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| AppDeta( oBrwLin, bEdtDet, aTmp, .F., cCodArt ) }

      otherwise
         oDlg:bStart := {|| ShowKit( dbfFacCliT, dbfTmpLin, oBtnKit, oBrwLin, .F., dbfTmpInc, cCodCli, dbfClient, oRieCli, oGetRnt, aGet, oSayGetRnt ) }

   end





   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|(  RecalculaTotal( aTmp ) )}, .T.,,, {|Self|(  SetDialog( aGet, oSayDias, oSayGetRnt, oGetRnt ), InitDialog( aTmp, aGet, oDlg, oBtn, aNumDoc, nMode, oBrwLin, oBrwInc, oBrwPgo, oBrwAnt ) )}, oDlg:bRClicked,,, )





   DisableAcceso()

   if oDlg:nResult <> 1

      if len( aNumAlb ) > 0
         for n := 1 to len( aNumAlb )
            if ( dbfAlbCliT )->( dbSeek( aNumAlb[ n ] ) )
               SetFacturadoAlbaranCliente( .F., , dbfAlbCliT, dbfAlbCliL, dbfAlbCliS )
            end
         next
      end





      if !Empty( aTmp[ 39 ] )
         if ( dbfPreCliT )->( dbSeek( aTmp[ 39 ] ) ) .AND. dbLock( dbfPreCliT )
            ( dbfPreCliT )->lEstado       := .F.
            ( dbfPreCliL )->( dbUnlock() )
         end
      end





      if !Empty( aTmp[ 38 ] )
         if ( dbfPedCliT )->( dbSeek( aTmp[ 38 ] ) ) .AND. ( dbfPedCliT )->( dbRLock() )
            ( dbfPedCliT )->nEstado       := 1
            ( dbfPedCliL )->( dbUnlock() )
         end
      end

   end





   ( dbfFacCliT )->( ordSetFocus( nOrd ) )





   if !Empty( oBrwLin )
      oBrwLin:CloseData()
      oBrwLin:end()
   end

   if !Empty( oBrwInc )
      oBrwInc:CloseData()
      oBrwInc:end()
   end

   if !Empty( oBrwPgo )
      oBrwPgo:CloseData()
      oBrwPgo:end()
   end

   if !Empty( oBrwAnt )
      oBrwAnt:CloseData()
      oBrwAnt:end()
   end

   if !Empty( oBrwIva )
      oBrwIva:end()
   end

   if !Empty( oBrwDoc )
      oBrwDoc:end()
   end

   if !Empty( oBtnPre )
      oBtnPre:end()
   end

   if !Empty( oBtnPed )
      oBtnPed:end()
   end

   if !Empty( oBtnAlb )
      oBtnAlb:end()
   end

   if !Empty( oMenu )
      oMenu:end()
   end

   if !Empty( oBmpDiv )
      oBmpDiv:end()
   end

   if !Empty( oBmpEmp )
      oBmpEmp:end()
   end

   oBmpGeneral:End()





   KillTrans()

   SysRefresh()

   EnableAcceso()

RETURN ( oDlg:nResult == 1 )



Static Function InitDialog( aTmp, aGet, oDlg, oBtn, aNumDoc, nMode, oBrwLin, oBrwInc, oBrwPgo, oBrwAnt )

   local nNumLin                    := 0

   EdtRecMenu( aTmp, oDlg )

   oBrwLin:Load()
   oBrwInc:Load()
   oBrwPgo:Load()
   oBrwAnt:Load()

   oMeter:Set( 0 )

   if IsArray( aNumDoc ) .AND. !Empty( aNumDoc[ 1 ] )
      aGet[ 39 ]:cText( aNumDoc[ 1 ] )
      aGet[ 39 ]:lValid()
   end

   if IsArray( aNumDoc ) .AND. !Empty( aNumDoc[ 2 ] )
      aGet[ 38 ]:cText( aNumDoc[ 2 ] )
      aGet[ 38 ]:lValid()
   end

   if IsArray( aNumDoc ) .AND. !Empty( aNumDoc[ 3 ] )
      aGet[ 37 ]:cText( aNumDoc[ 3 ] )
      aGet[ 37 ]:lValid()
   end

   if IsArray( aNumDoc ) .AND. !Empty( aNumDoc[ 5 ] )
      cFacPrv( aNumDoc[ 5 ], aGet, aTmp, oBrwLin, nMode )
   end

   if IsObject( aNumDoc ) .AND. !Empty( aNumDoc )

      aGet[ 6 ]:cText( aNumDoc:cCodigoCliente )
      aGet[ 6 ]:lValid()

      if IsNum( aNumDoc:nVentaBruta ) .AND. ( aNumDoc:nVentaBruta <> 0 )
         ( dbfTmpLin )->( dbAppend() )
         ( dbfTmpLin )->nNumLin     := nNumLin++
         ( dbfTmpLin )->cRef        := "VENTAS"
         ( dbfTmpLin )->cDetalle    := "VENTAS"
         ( dbfTmpLin )->nPreUnit    := aNumDoc:nVentaBruta
         ( dbfTmpLin )->nCanEnt     := 1
         ( dbfTmpLin )->nUniCaja    := 1
         ( dbfTmpLin )->cCodAge     := aTmp[ 19    ]
         ( dbfTmpLin )->nComAge     := aTmp[ 23 ]
      end

      if IsNum( aNumDoc:nPremios ) .AND. ( aNumDoc:nPremios <> 0 )
         ( dbfTmpLin )->( dbAppend() )
         ( dbfTmpLin )->nNumLin     := nNumLin++
         ( dbfTmpLin )->cRef        := "PREMIOS"
         ( dbfTmpLin )->cDetalle    := "PREMIOS"
         ( dbfTmpLin )->nPreUnit    := - aNumDoc:nPremios
         ( dbfTmpLin )->nCanEnt     := 1
         ( dbfTmpLin )->nUniCaja    := 1
         ( dbfTmpLin )->cCodAge     := aTmp[ 19    ]
         ( dbfTmpLin )->nComAge     := aTmp[ 23 ]
      end

      if IsNum( aNumDoc:nPorcentaje ) .AND. ( aNumDoc:nPorcentaje <> 0 )
         ( dbfTmpLin )->( dbAppend() )
         ( dbfTmpLin )->nNumLin     := nNumLin++
         ( dbfTmpLin )->cRef        := "RETENC"
         ( dbfTmpLin )->cDetalle    := "RETENC"
         ( dbfTmpLin )->nPreUnit    := aNumDoc:nVentaBruta * aNumDoc:nPorcentaje / 100
         ( dbfTmpLin )->nCanEnt     := 1
         ( dbfTmpLin )->nUniCaja    := 1
         ( dbfTmpLin )->cCodAge     := aTmp[ 19    ]
         ( dbfTmpLin )->nComAge     := aTmp[ 23 ]
      end

      RecalculaTotal( aTmp )

      oBtn:Click()

   end

Return ( nil )



FUNCTION nBrtLFacCli( uTmpLin, nDec, nRec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( nDec == nil, nDec := 2, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nTotUFacCli( uTmpLin, nDec, nVdv, cPorDiv )
   nCalculo          *= nTotNFacCli( uTmpLin )

   nCalculo          := Round( nCalculo / nVdv, nRec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )






FUNCTION nIvaUFacCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacCli( dbfTmpLin, nDec, nVdv )

   if !( dbfTmpLin )->lIvaLin
      nCalculo    := nCalculo * ( dbfTmpLin )->nIva / 100
   else
      nCalculo    -= nCalculo / ( 1 + ( dbfTmpLin )->nIva / 100 )
   end

   if nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )






FUNCTION nReqUFacCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacCli( dbfTmpLin, nDec, nVdv )

   if !( dbfTmpLin )->lIvaLin
      nCalculo    := nCalculo * ( dbfTmpLin )->nReq / 100
   else
      nCalculo    -= nCalculo / ( 1 + ( dbfTmpLin )->nReq / 100 )
   end

   if nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )






FUNCTION nIncUFacCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacCli( dbfTmpLin, nDec, nVdv )

   if !( dbfTmpLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfTmpLin )->nIva / 100
   end

    IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
    end

RETURN ( Round( nCalculo, nDec ) )







STATIC FUNCTION EdtDet( aTmp, aGet, dbfFacCliL, oBrw, lTotLin, cCodArtEnt, nMode, aTmpFac )

    local oDlg
   local oFld
   local oBtn
    local oGet2
   local cGet2             := ""
   local oGet3
   local cGet3             := ""
   local oSayPr1
   local oSayPr2
   local cSayPr1           := ""
   local cSayPr2           := ""
   local oSayVp1
   local oSayVp2
   local cSayVp1           := ""
   local cSayVp2           := ""
   local oSayAlm
   local cSayAlm           := ""
   local bmpImage
   local oStkAct
   local nStkAct           := 0
   local oBtnSer
   local oSayGrp
   local cSayGrp           := ""
   local oSayFam
   local cSayFam           := ""
   local cCodArt           := Padr( aTmp[ 4 ], 32 )
   local oSayDias

   do case
   case nMode == 1

      aTmp[ 12  ]       := 1
      aTmp[ 21   ]       := aTmpFac[ 5 ]
      aTmp[ 26  ]       := lTotLin
      aTmp[ 39  ]       := aTmpFac[ 7 ]
      aTmp[ 40  ]       := aTmpFac[ 58 ]
      aTmp[ 22  ]       := cDefVta()
      aTmp[ 77  ]       := aTmpFac[ 18 ]
      aTmp[ 85 ]       := aTmpFac[ 38 ]

      if !Empty( cCodArtEnt )
         cCodArt              := Padr( cCodArtEnt, 32 )
      end

      aTmp[ 71 ]       := aTmpFac[ 90  ]
      aTmp[ 70 ]       := aTmpFac[ 89 ]

      if !Empty( oTipFac ) .AND. oTipFac:nAt == 2
         aTmp[ 69 ]  := .T.
      else
         aTmp[ 69 ]  := .F.
      end

   case nMode == 2

      aTmp[ 6 ] := Round( aTmp[ 6 ], nDouDiv )
      aTmp[ 7  ] := Round( aTmp[ 7  ], nDpvDiv )
      aTmp[ 33  ] := Round( aTmp[ 33  ], nDouDiv )
      lTotLin           := aTmp[ 26 ]

   case nMode == 5

      aTmp[ 33  ] := Round( aTmp[ 33  ], nDouDiv )
      lTotLin           := aTmp[ 26 ]

   end





   cOldCodArt           := aTmp[ 4    ]
   cOldPrpArt           := aTmp[ 28 ] + aTmp[ 29 ] + aTmp[ 30 ] + aTmp[ 31 ]
   cOldUndMed           := aTmp[ 16 ]



   cSayGrp              := RetFld( aTmp[ 56 ], oGrpFam:GetAlias() )
   cSayFam              := RetFld( aTmp[ 55 ], dbfFamilia )





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "líneas de facturas de clientes", "LFACCLI",, .F.,,,,,, .F.,,,,,, .F., )

      if aTmp[ 69 ]





         oFld := TFolder():ReDefine( 400, {"&General",    "Da&tos",    "&Observaciones"}, { "LFACCLI_4","LFACCLI_6","LFACCLI_3" }, oDlg,,,,, .F., )

      else





         oFld := TFolder():ReDefine( 400, {"&General",    "Da&tos",    "&Observaciones"}, { "LFACCLI_1","LFACCLI_6","LFACCLI_3" }, oDlg,,,,, .F., )

      end







      aGet[ 4 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cCodArt, cCodArt:= u ) }, oFld:aDialogs[1],,, {||    ( loaArt( aGet, bmpImage, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, nMode, .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwArticulo( aGet[ 4 ], aGet[ 5 ] , , , , aGet[ 45 ], aTmp[ 28 ], aTmp[ 29 ], aGet[ 30 ], aGet[ 31 ], aGet[ 46 ] ) )}, nil, "LUPA",, )




      aGet[ 5 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 5 ] ) ) .AND. nMode <> 3 .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )





        aGet[23] := TMultiGet():ReDefine( 111, { | u | If( PCount()==0, aTmp[23], aTmp[23]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 23 ] ) ) .AND. nMode <> 3 .AND. nMode <> 5 )}, .F.,, )











      aGet[ 45 ] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 113, )

      aGet[ 45 ]:bValid   := {|| lValidLote( aTmp, aGet, oStkAct ) }

      if !aTmp[ 69 ]






      aGet[ 46 ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 341, )

      end






   if !aTmp[ 69 ]









      aGet[ 30 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[ 30 ], oSayVp1, aTmp[ 28 ], dbfTblPro ), loaArt( aGet, bmpImage, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, nMode, .F. ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[ 30 ], oSayVp1, aTmp[ 28 ] ) )}, nil, "LUPA",, )

         aGet[ 30 ]:bChange   := {|| aGet[ 30 ]:Assign(), if( !uFieldEmpresa( "lNStkAct" ), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 39 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 45 ], aTmp[ 47 ], aTmp[ 36 ], oStkAct ), .T. ) }



      oSayPr1 := TSay():ReDefine( 271, {|| cSayPr1}, oFld:aDialogs[1],,,, .F.,, .F., .F. )




      oSayVp1 := TGetHlp():ReDefine( 272, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 31 ] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[ 31 ], oSayVp2, aTmp[ 29 ], dbfTblPro ), loaArt( aGet, bmpImage, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, nMode, .F. ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[ 31 ], oSayVp2, aTmp[ 29 ] ) )}, nil, "LUPA",, )

         aGet[ 31 ]:bChange   := {|| aGet[ 31 ]:Assign(), if( !uFieldEmpresa( "lNStkAct" ), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 39 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 45 ], aTmp[ 47 ], aTmp[ 36 ], oStkAct ), .T. ) }



      oSayPr2 := TSay():ReDefine( 281, {|| cSayPr2}, oFld:aDialogs[1],,,, .F.,, .F., .F. )




      oSayVp2 := TGetHlp():ReDefine( 282, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )

   end









      aGet[ 8 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( lCalcDeta( aTmp, aTmpFac ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,, 351, )














      aGet[ 11 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( lTiva( dbfIva, aTmp[ 11 ], @aTmp[ 57 ] ) )},,,,,, .F., {||     ( lModIva() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 11 ], dbfIva, , .T. ) )}, nil, "LUPA",, )

   if aTmp[ 69 ]






      aGet[ 71 ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ 71 ], aTmp[ 71 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 70 ] := TGetHlp():ReDefine( 430, { | u | If( PCount()==0, aTmp[ 70 ], aTmp[ 70 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,,, )







      oSayDias := TSay():ReDefine( 440, {||      ( aTmp[ 70 ] - aTmp[ 71 ] )}, oFld:aDialogs[1], "9999",,, .F.,, .F., .F. )

   else









      aGet[ 42 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],, cPouDiv,,,,,,, .F., {||     ( uFieldEmpresa( "lModImp" ) .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,, {|Self|( oNewImp:nBrwImp( aGet[42] ) )}, nil,, 126, )

   end









        aGet[12] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpFac ), loaArt( aGet, bmpImage, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, nMode, .F. ) )},,,,,, .F., {||     ( nMode <> 3 .AND. lUseCaj() .AND. !lTotLin .AND. nMode <> 5 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ), loaArt( aGet, bmpImage, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 131, )









        aGet[19] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[19], aTmp[19]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpFac ), loaArt( aGet, bmpImage, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, nMode, .F. ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ), loaArt( aGet, bmpImage, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 141, )








      aGet[ 16 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oUndMedicion:Existe( aGet[ 16 ], aGet[ 16 ]:oHelpText, "cNombre" ), ValidaMedicion( aTmp, aGet ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oUndMedicion:Buscar( aGet[ 16 ] ), ValidaMedicion( aTmp, aGet ) )}, nil, "LUPA",, 171 )













      aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ] := TGetHlp():ReDefine( 520, { | u | If( PCount()==0, aTmp[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ], aTmp[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,, 521, )

         aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ] := TGetHlp():ReDefine( 530, { | u | If( PCount()==0, aTmp[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ], aTmp[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,, 531, )

         aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ] := TGetHlp():ReDefine( 540, { | u | If( PCount()==0, aTmp[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ], aTmp[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,, 541, )

         aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetColor( 8388608 )








      aGet[ 6 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( lCalcDeta( aTmp, aTmpFac ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,,, )










      aGet[ 77 ] := TGetHlp():ReDefine( 156, { | u | If( PCount()==0, aTmp[ 77 ], aTmp[ 77 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( aTmp[ 77 ] >= 1 .AND. aTmp[ 77 ] <= 6 )},,,,,, .F., {||     ( nMode <> 3 .AND. ( lUsrMaster() .OR. oUser():lCambiarPrecio() ) )}, {|nKey,nFlags,Self| ( ChangeTarifa( aTmp, aGet, aTmpFac ), lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,, {||      1}, {||      6},, nil,,, )

      if aTmp[ 69 ]








         aGet[ 72 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 72 ], aTmp[ 72 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( lCalcDeta( aTmp, aTmpFac ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,,, )

      end










      aGet[ 7 ] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],, cPpvDiv, {||    ( lCalcDeta( aTmp, aTmpFac ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,, 152, )

      if !aTmp[ 69 ]





      aGet[ 32 ] := TGetHlp():ReDefine( 295, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )

      end





      aGet[ 14 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 15 ] := TGetHlp():ReDefine( 175, { | u | If( PCount()==0, aTmp[ 15 ], aTmp[ 15 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 67 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 67 ], aTmp[ 67 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 68 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 68 ], aTmp[ 68 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )

      if !aTmp[ 69 ]




      aGet[ 84 ] := TCheckBox():ReDefine( 440, { | u | If( PCount()==0, aTmp[ 84 ], aTmp[ 84 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )

      aGet[ 84 ]:bChange   := {|| if( aTmp[ 84 ], ( aGet[ 11 ]:cText( 0 ), aGet[ 11 ]:HardDisable() ), ( aGet[ 11 ]:HardEnable() ) ) }

      end




      aGet[ 83 ] := TCheckBox():ReDefine( 411, { | u | If( PCount()==0, aTmp[ 83 ], aTmp[ 83 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )











      aGet[ 33 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( aTmp[33] >= 0 )}, ( 255 + ( 0 * 256 ) + ( 0 * 65536 ) ),,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,, {||      0},,, nil,, 261, )








      aGet[ 9 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( lCalcDeta( aTmp, aTmpFac ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 10 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( lCalcDeta( aTmp, aTmpFac ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 18 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[ 1 ],, "@E 999.99", {||    ( lCalcDeta( aTmp, aTmpFac ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,,, )

      if !aTmp[ 69 ]





      oComisionLinea := TGetHlp():ReDefine( 201, { | u | If( PCount()==0, nComisionLinea, nComisionLinea:= u ) }, oFld:aDialogs[ 1 ],, cPorDiv,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

      end





      oTotalLinea := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nTotalLinea, nTotalLinea:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      aGet[ 53 ] := TGetHlp():ReDefine( 205, { | u | If( PCount()==0, aTmp[ 53 ], aTmp[ 53 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oTipArt:lValid( aGet[ 53 ], oGet3 ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( oTipArt:Buscar( aGet[ 53 ] ) )}, nil, "LUPA",, )




      oGet3 := TGetHlp():ReDefine( 206, { | u | If( PCount()==0, cGet3, cGet3:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )









      aGet[ 22 ] := TGetHlp():ReDefine( 290, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cTVta( aGet[22], dbfTVta, oGet2 ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( BrwTVta( aGet[22], dbfTVta, oGet2 ) )}, nil, "LUPA", 292, )



        oGet2 := TGetHlp():ReDefine( 291, { | u | If( PCount()==0, cGet2, cGet2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )







      aGet[ 39 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[ 39 ], , oSayAlm ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[39], oSayAlm ) )}, nil, "LUPA",, )

      aGet[ 39 ]:bLostFocus   := {|| if( !uFieldEmpresa( "lNStkAct" ), oStock:lPutStockActual( aTmp[ 4 ], aTmp[ 39 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 45 ], aTmp[ 47 ], aTmp[ 36 ], oStkAct ), .T. ) }




      oSayAlm := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSayAlm, cSayAlm:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )





      oStkAct := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, nStkAct, nStkAct:= u ) }, oFld:aDialogs[1],, cPicUnd,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      aGet[37] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[37], aTmp[37]:= u ) }, oFld:aDialogs[1],, cPouDiv,,,,,,, .F., {||     ( oUser():lAdministrador() .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,, 321, )





      aGet[50] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[50], aTmp[50]:= u ) }, oFld:aDialogs[1],, "99",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )










      aGet[35] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[35], aTmp[35]:= u ) }, oFld:aDialogs[2],, "9999",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[27] := TCheckBox():ReDefine( 110, { | u | If( PCount()==0, aTmp[27], aTmp[27]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )






      aGet[21] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[21], aTmp[21]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .T.,,,,, {|Self|aGet[21]:cText( Calendario( aTmp[21] ) )}, nil,,, )




      aGet[13] := TCheckBox():ReDefine( 130, { | u | If( PCount()==0, aTmp[13], aTmp[13]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      aGet[38] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[38], aTmp[38]:= u ) }, oFld:aDialogs[2],, cPouDiv,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








      aGet[ 61 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( ChgBmp( aGet[ 61 ], bmpImage ) ) }, .F., .F.,,,,, {|Self|( GetBmp( aGet[ 61 ], bmpImage ) )}, nil, "LUPA",, )











      aGet[ 56 ] := TGetHlp():ReDefine( ( 150 ), { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[ 2 ],,, {||    ( oSayGrp:cText( RetFld( aTmp[ 56  ], oGrpFam:GetAlias() ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oGrpFam:Buscar( aGet[ 56 ] ) )}, nil, "LUPA",, )




      oSayGrp := TGetHlp():ReDefine( ( 151 ), { | u | If( PCount()==0, cSayGrp, cSayGrp:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      aGet[ 55 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oSayFam:cText( RetFld( aTmp[ 55  ], dbfFamilia ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFamilia( aGet[ 55 ], oSayFam ) )}, nil, "LUPA",, )




      oSayFam := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cSayFam, cSayFam:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )




      aGet[ 78 ] := TCheckBox():ReDefine( 310, { | u | If( PCount()==0, aTmp[ 78 ], aTmp[ 78 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      aGet[ 79 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ 79 ], aTmp[ 79 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

         aGet[ 79 ]:bValid := {|| oFraPub:lValid( aGet[ 79 ], aGet[ 80 ] ) }
         aGet[ 79 ]:bHelp  := {|| oFraPub:Buscar( aGet[ 79 ] ) }




      aGet[ 80 ] := TGetHlp():ReDefine( 321, { | u | If( PCount()==0, aTmp[ 80 ], aTmp[ 80 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oRentabilidadLinea := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, cRentabilidadLinea, cRentabilidadLinea:= u ) }, oFld:aDialogs[2],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,, 301, )




      aGet[ 47 ] := TCheckBox():ReDefine( 331, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 48 ] := TCheckBox():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 49 ] := TCheckBox():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 49 ], aTmp[ 49 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 36 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[ 2 ],, { 350, 351, 352 },,,,, .F., {||     ( nMode <> 3 )}, )









      aGet[ 58 ] := TMultiGet():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 58 ], aTmp[ 58 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      aGet[ 81 ] := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 81 ], aTmp[ 81 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )

if ( IsMuebles() )




    aGet[ 59 ] := TGetHlp():ReDefine( 800, { | u | If( PCount()==0, aTmp[ 59 ], aTmp[ 59 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




    aGet[ 60 ] := TGetHlp():ReDefine( 801, { | u | If( PCount()==0, aTmp[ 60 ], aTmp[ 60 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

end





      bmpImage := TBitmap():ReDefine( 220,, ( cFileBitmap( cPatImg(), aTmp[ 61 ] ) ), oDlg,, { |nRow,nCol,nKeyFlags| ( bmpImage:lStretch := !bmpImage:lStretch, bmpImage:Refresh() ) }, .F., .F.,,, .F.,,, .F. )

         bmpImage:SetColor( , GetSysColor( 15 ) )





      oBtn := TButton():ReDefine( 1, {||SaveDeta( aTmp, aTmpFac, aGet, oGet2, oBrw, oDlg, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, oTotalLinea, oStkAct, nStkAct, cCodArt, oBtn, oBtnSer )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 9, {||( ChmHelp( "Añadir_v" ) )}, oDlg,,, .F.,,,, .F. )




      oBtnSer := TButton():ReDefine( 552, {||( EditarNumeroSerie( aTmp, oStock, nMode ) )}, oDlg,,, .F.,,,, .F. )

   if nMode <> 3
      oDlg:AddFastKey( 117, {|| oBtnSer:Click() } )
      oDlg:AddFastKey( 116, {|| SaveDeta( aTmp, aTmpFac, aGet, oGet2, oBrw, oDlg, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, oTotalLinea, oStkAct, nStkAct, cCodArt, oBtn, oBtnSer ) } )
   end



   oDlg:bStart    := {||   SetDlgMode( aTmp, aGet, oGet2, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oStkAct, nMode, oTotalLinea, aTmpFac, oRentabilidadLinea ), if( !Empty( cCodArtEnt ), aGet[ 4 ]:lValid(), ), lCalcDeta( aTmp, aTmpFac ) }



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( EdtDetMenu( aGet[ 4 ], oDlg ) )}, oDlg:bRClicked,,, )

   EndDetMenu()

   if !Empty( bmpImage )
      bmpImage:End()
   end

RETURN ( oDlg:nResult == 1 )



Static Function EdtInc( aTmp, aGet, dbfFacCliI, oBrw, bWhen, bValid, nMode, aTmpFac )

   local oDlg
   local oNomInci
   local cNomInci

   if !Empty( aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ] )
      cNomInci := cNomInci( aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], dbfInci )
   end

   if nMode == 1
      aTmp[ 1   ] := aTmpFac[ 1  ]
      aTmp[ 2  ] := aTmpFac[ 2 ]
      aTmp[ 3  ] := aTmpFac[ 3 ]
   end

   if ( "PDA" $ cParamsMain() )
      oDlg = TDialog():New(,,,,, "FACTCLI_INC_PDA",, .F.,,,,,, .F.,,,,,, .F., )
   else
      oDlg = TDialog():New(,,,, LblTitle( nMode ) + "incidencias de facturas a clientes", "INCIDENCIA",, .F.,,,,,, .F.,,,,,, .F., )
   end









      aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ]:= u ) }, oDlg,,, {||    ( cTipInci( aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], dbfInci, oNomInci ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwIncidencia( dbfInci, aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], oNomInci ) )}, nil, "LUPA",, )




      oNomInci := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, cNomInci, cNomInci:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      if nMode <> 3
         oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) } )
      end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



Static Function EdtDoc( aTmp, aGet, dbfFacCliD, oBrw, bWhen, bValid, nMode, aTmpLin )

   local oDlg
   local oRuta
   local oNombre
   local oObservacion

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "documento de pedidos a proveedor", "DOCUMENTOS",, .F.,,,,,, .F.,,,,,, .F., )




      oNombre := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      oRuta := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oRuta:cText( cGetFile( "Doc ( *.* ) | " + "*.*", "Seleccione el nombre del fichero" ) ) )}, nil, "FOLDER",, )





      oObservacion := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



STATIC FUNCTION PrnSerie()

    local oDlg
   local oFmtDoc
   local cFmtDoc     := cFormatoDocumento( ( dbfFacCliT )->cSerie, "nFacCli", dbfCount )
   local oSayFmt
   local cSayFmt
   local oSerIni
   local oSerFin
   local nRecno      := ( dbfFacCliT )->( recno() )
   local nOrdAnt     := ( dbfFacCliT )->( OrdSetFocus( "nNumFac" ) )
   local cSerIni     := ( dbfFacCliT )->cSerie
   local cSerFin     := ( dbfFacCliT )->cSerie
   local oDocIni
   local oDocFin
   local nDocIni     := ( dbfFacCliT )->nNumFac
   local nDocFin     := ( dbfFacCliT )->nNumFac
   local cSufIni     := ( dbfFacCliT )->cSufFac
   local cSufFin     := ( dbfFacCliT )->cSufFac
   local oPrinter
   local cPrinter    := PrnGetName()
   local lCopiasPre  := .T.
   local lInvOrden   := .F.
   local oNumCop
   local nNumCop     := if( nCopiasDocumento( (dbfFacCliT)->cSerie, "nFacCli", dbfCount ) == 0, Max( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( (dbfFacCliT)->cSerie, "nFacCli", dbfCount ) )

   if Empty( cFmtDoc )
      cFmtDoc        := cSelPrimerDoc( "FC" )
   end

   cSayFmt           := cNombreDoc( cFmtDoc )

   oDlg = TDialog():New(,,,, "Imprimir series de facturas", "IMPSERDOC",, .F.,,,,,, .F.,,,,,, .F., )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z"  )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )









   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z"  )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )





   oDocIni := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





   oDocFin := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )



   TCheckBox():ReDefine( 500, { | u | If( PCount()==0, lInvOrden, lInvOrden:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 170, { | u | If( PCount()==0, lCopiasPre, lCopiasPre:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oNumCop := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, nNumCop, nNumCop:= u ) }, oDlg,, "999999999", {||    nNumCop > 0},,,,,, .F., {||     !lCopiasPre},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )






   oFmtDoc := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cFmtDoc, cFmtDoc:= u ) }, oDlg,,, {||    ( cDocumento( oFmtDoc, oSayFmt, dbfDoc ) )},,,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oFmtDoc, oSayFmt, "FC" ) )}, nil, "LUPA",, )




   oSayFmt := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayFmt, cSayFmt:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 92, "Printer_pencil_16",,,,,{|| EdtDocumento( cFmtDoc ) }, oDlg, .F., , .F.,  )




   oPrinter := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cPrinter, cPrinter:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 161, "Printer_preferences_16",,,,,{|| PrinterPreferences( oPrinter ) }, oDlg, .F., , .F.,  )





   TButton():ReDefine( 1, {||(  StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, nil, lCopiasPre, nNumCop, lInvOrden ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, nil, lCopiasPre, nNumCop, lInvOrden ), oDlg:end( 1 ) } )

   oDlg:bStart := { || oSerIni:SetFocus() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   ( dbfFacCliT )->( dbGoTo( nRecNo ) )
   ( dbfFacCliT )->( ordSetFocus( nOrdAnt ) )

    oWndBrw:oBrw:refresh()

RETURN NIL



STATIC FUNCTION StartPrint( cFmtDoc, cDocIni, cDocFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden )

   local nCopyClient

   oDlg:Disable()

   if !lInvOrden

      ( dbfFacCliT )->( dbSeek( cDocIni, .T. ) )


      while ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac >= cDocIni .AND.  ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac <= cDocFin

            lChgImpDoc( dbfFacCliT )

         if lCopiasPre

            nCopyClient := if( nCopiasDocumento( ( dbfFacCliT )->cSerie, "nFacCli", dbfCount ) == 0, Max( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( ( dbfFacCliT )->cSerie, "nFacCli", dbfCount ) )

            GenFacCli( 1, "Imprimiendo documento : " + ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, cFmtDoc, cPrinter,  )

         else

            GenFacCli( 1, "Imprimiendo documento : " + ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, cFmtDoc, cPrinter, nNumCop )

         end

         ( dbfFacCliT )->( dbSkip() )

      end

   else

      ( dbfFacCliT )->( dbSeek( cDocFin, .T. ) )



      while ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac >= cDocIni .AND.  ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac <= cDocFin .AND.  !( dbfFacCliT )->( Bof() )

         lChgImpDoc( dbfFacCliT )

         if lCopiasPre

            nCopyClient := if( nCopiasDocumento( ( dbfFacCliT )->cSerie, "nFacCli", dbfCount ) == 0, Max( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( ( dbfFacCliT )->cSerie, "nFacCli", dbfCount ) )

            GenFacCli( 1, "Imprimiendo documento : " + ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, cFmtDoc, cPrinter, nCopyClient )

         else

            GenFacCli( 1, "Imprimiendo documento : " + ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, cFmtDoc, cPrinter, nNumCop )

         end

         ( dbfFacCliT )->( dbSkip( -1 ) )

      end

   end

   oDlg:Enable()

RETURN NIL



FUNCTION nIvaLFacCli( dbfFacT, dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo := nImpLFacCli( dbfFacT, dbfLin, nDec, nRou, nVdv )

   nCalculo       := Round( nCalculo * ( dbfLin )->nIva / 100, nRou )

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nIvaIFacCli( dbfLin, nDec, nRou, nVdv, cPouDiv )

   local nCalculo := nTotIFacCli( dbfLin, nDec, nRou, nVdv )

   nCalculo       := Round( nCalculo * ( dbfLin )->nIva / 100, nRou )

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nReqLFacCli( dbfFacT, dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo := nImpLFacCli( dbfFacT, dbfLin, nDec, nRou, nVdv )

   nCalculo       := Round( nCalculo * ( dbfLin )->nReq / 100, nRou )

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )







FUNCTION nIncLFacCli( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPorDiv )

   local nCalculo := nTotLFacCli( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn )

   if !( dbfLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfLin )->nIva / 100
   end

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )






FUNCTION nNoIncLFacCli( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPorDiv )

   local nCalculo

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;

   nCalculo       := nTotLFacCli( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn )

   if ( dbfLin )->lIvaLin
      nCalculo    -= nCalculo * ( dbfLin )->nIva / 100
   end

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )







FUNCTION nNoIncUFacCli( dbfLin, nDec, nVdv )

   local nCalculo

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;

   nCalculo       := nTotUFacCli( dbfLin, nDec, nVdv )

   if ( dbfLin )->lIvaLin
      nCalculo    -= nCalculo * ( dbfLin )->nIva / 100
   end

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION aTotFacCli( cFactura, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT, cDivRet )

   nTotFacCli( cFactura, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT, nil, cDivRet )

RETURN ( { nTotNet, nTotIva, nTotReq, nTotFac, nTotPnt, nTotTrn, nTotAge, aTotIva, nTotCos, nTotIvm, nTotRnt, nTotRet, nTotCob } )



FUNCTION sTotFacCli( cFactura, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT, cDivRet )

   local sTotal

   nTotFacCli( cFactura, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT, nil, cDivRet )

   sTotal                                 := sTotal()

   sTotal:nTotalBruto                     := nTotBrt
   sTotal:nTotalNeto                      := nTotNet
   sTotal:nTotalIva                       := nTotIva
   sTotal:nTotalRecargoEquivalencia       := nTotReq
   sTotal:nTotalRetencion                 := nTotRet
   sTotal:nTotalDocumento                 := nTotFac
   sTotal:nTotalPuntoVerde                := nTotPnt
   sTotal:nTotalTransporte                := nTotTrn
   sTotal:nTotalAgente                    := nTotAge
   sTotal:nTotalCosto                     := nTotCos
   sTotal:nTotalImpuestoHidrocarburos     := nTotIvm
   sTotal:nTotalRentabilidad              := nTotRnt

   sTotal:nTotalDescuentoGeneral          := nTotDto
   sTotal:nTotalDescuentoProntoPago       := nTotDpp
   sTotal:nTotalDescuentoUno              := nTotUno
   sTotal:nTotalDescuentoDos              := nTotDos

   sTotal:nTotalCobrado                   := nTotCob

   sTotal:aTotalIva                       := aTotIva

Return ( sTotal )






STATIC FUNCTION lLiquida( oBrw, cFactura )

   IIF( cFactura == nil, cFactura := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, ) ;

   if ( dbfFacCliT )->lLiquidada
      msgStop( "Factura ya cobrada", "Imposible añadir cobros" )
      return .F.
   end





   if ( dbfFacCliP )->( dbSeek( cFactura ) )

      while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cFactura .AND. !( dbfFacCliP )->( eof() )

         if Empty( ( dbfFacCliP )->cTipRec ) .AND. !( dbfFacCliP )->lCobrado

            EdtRecCli( ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac + Str( ( dbfFacCliP )->nNumRec ) + ( dbfFacCliP )->cTipRec, .F. )

            exit

         end

         ( dbfFacCliP )->( dbSkip() )

      end

   end





   ChkLqdFacCli( nil, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfAntCliT, dbfIva, dbfDiv, .F. )





   if !Empty( oAuditor() )
      oAuditor():AddEvent( "Liquidada factura de clientes", ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, "11" )
   end

   oBrw:Refresh()
   oBrw:SetFocus()

Return .T.



Static Function lChgContabilizado( lChk )

   if ( dbfFacCliT )->( dbRLock() )
      ( dbfFacCliT )->lContab    := lChk
      ( dbfFacCliT )->( dbUnlock() )
   end





   if lChk
      if !Empty( oAuditor() )
         oAuditor():AddEvent( "Marca como contabilizada factura de clientes",   ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, "11" )
      end
   else
      if !Empty( oAuditor() )
         oAuditor():AddEvent( "Marca como no contabilizada factura de clientes", ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, "11" )
      end
   end

Return .T.







STATIC FUNCTION cAlbCli( aGet, aTmp, oBrwLin, oBrwPgo, nMode )

   local cDesAlb
   local lValid      := .F.
   local cAlbaran    := aGet[ 37 ]:varGet()
   local aAlbCliT
   local aAlbCliL
   local nTotEntAlb  := 0
   local cSuPed      := ""

   if ( nMode <> 1 .OR. Empty( cAlbaran ) )
      return .T.
   end

   aAlbCliT          := aGetStatus( dbfAlbCliT, .T. )
   aAlbCliL          := aGetStatus( dbfAlbCliL, .T. )

   if ( dbfAlbCliT )->( dbSeek( cAlbaran ) )

      if ( dbfAlbCliT )->lFacturado

         MsgStop( "Albarán facturado" )

      else

         CursorWait()

         aGet[ 1  ]:cText( ( dbfAlbCliT )->cSerAlb )
         aGet[ 1  ]:bWhen    := {|| .F. }

         aGet[ 6 ]:cText( ( dbfAlbCliT )->cCodCli )
         aGet[ 6 ]:bWhen    := {|| .F. }
         aGet[ 6 ]:lValid()

         aGet[ 9 ]:cText( ( dbfAlbCliT )->cNomCli )
         aGet[ 10 ]:cText( ( dbfAlbCliT )->cDirCli )
         aGet[ 11 ]:cText( ( dbfAlbCliT )->cPobCli )
         aGet[ 12 ]:cText( ( dbfAlbCliT )->cPrvCli )
         aGet[ 14 ]:cText( ( dbfAlbCliT )->cPosCli )
         aGet[ 15 ]:cText( ( dbfAlbCliT )->cDniCli )
         aGet[ 100 ]:cText( ( dbfAlbCliT )->cTlfCli )

         aGet[ 7 ]:cText( ( dbfAlbCliT )->cCodAlm )
         aGet[ 7 ]:lValid()

         aGet[ 8 ]:cText( ( dbfAlbCliT )->cCodCaj )
         aGet[ 8 ]:lValid()

         aGet[ 32 ]:cText( ( dbfAlbCliT )->cCodPago )
         aGet[ 32 ]:lValid()

         aGet[ 19 ]:cText( ( dbfAlbCliT )->cCodAge )
         aGet[ 19 ]:lValid()

         aGet[ 23 ]:cText( ( dbfAlbCliT )->nPctComAge )

         aGet[ 21 ]:cText( ( dbfAlbCliT )->CCODTAR )
         aGet[ 21 ]:lValid()

         aGet[ 20 ]:cText( ( dbfClient )->CCODRUT )
         aGet[ 20 ]:lValid()

         aGet[ 22 ]:cText( ( dbfAlbCliT )->CCODOBR )
         aGet[ 22 ]:lValid()

         aGet[72 ]:cText( ( dbfAlbCliT )->cCodTrn )
         aGet[72 ]:lValid()

         aGet[ 58  ]:Click( ( dbfAlbCliT )->lIvaInc )
         aGet[ 56 ]:Click( ( dbfAlbCliT )->lRecargo )
         aGet[ 117  ]:Click( ( dbfAlbCliT )->lOperPv )





         aGet[ 29 ]:cText( ( dbfAlbCliT )->cCondEnt )
         aGet[ 30  ]:cText( ( dbfAlbCliT )->mComent )
         aGet[ 31  ]:cText( ( dbfAlbCliT )->mObserv )
         aGet[ 27   ]:cText( ( dbfAlbCliT )->cSuPed  )





         aGet[ 41  ]:cText( ( dbfAlbCliT )->cDtoEsp )
         aGet[ 43     ]:cText( ( dbfAlbCliT )->cDpp    )
         aGet[ 42  ]:cText( ( dbfAlbCliT )->nDtoEsp )
         aGet[ 44     ]:cText( ( dbfAlbCliT )->nDpp    )
         aGet[ 45  ]:cText( ( dbfAlbCliT )->cDtoUno )
         aGet[ 46  ]:cText( ( dbfAlbCliT )->nDtoUno )
         aGet[ 47  ]:cText( ( dbfAlbCliT )->cDtoDos )
         aGet[ 48  ]:cText( ( dbfAlbCliT )->nDtoDos )
         aGet[ 94  ]:cText( ( dbfAlbCliT )->cManObr )
         aGet[ 35  ]:cText( ( dbfAlbCliT )->nIvaMan )
         aGet[ 36  ]:cText( ( dbfAlbCliT )->nManObr )
         aGet[ 33  ]:cText( ( dbfAlbCliT )->nBultos )
         aGet[ 62  ]:cText( ( dbfAlbCliT )->cRetPor )

         aTmp[ 82 ]              := ( dbfAlbCliT )->cCodGrp
         aTmp[ 16 ]              := ( dbfAlbCliT )->lModCli
         aTmp[ 117 ]              := ( dbfAlbCliT )->lOperPv

         cSuPed                        := ( dbfAlbCliT )->cSuPed





         aTmp[ 91 ]            := ( dbfAlbCliT )->lAlquiler
         aTmp[ 89  ]            := ( dbfAlbCliT )->dFecEntr
         aTmp[ 90   ]            := ( dbfAlbCliT )->dFecSal

         if !Empty( oTipFac )
            if aTmp[ 91 ]
               oTipFac:Select( 2 )
            else
               oTipFac:Select( 1 )
            end
         end





         aTmp[ 98 ]               := ( dbfAlbCliT )->cCodSuAlb





         if ( dbfAlbCliL )->( dbSeek( cAlbaran ) )

            if lNumAlb() .OR. lSuAlb()
               ( dbfTmpLin )->( dbAppend() )
               cDesAlb                 := ""
               cDesAlb                 += If( lNumObr(), Rtrim( cNumObr() ) + " " + rtrim( (dbfAlbCliT)->CCODOBR ), "" )
               cDesAlb                 += If( lNumAlb(), Rtrim( cNumAlb() ) + " " + rtrim( (dbfAlbCliT)->CSERALB + "/" + AllTrim( Str( (dbfAlbCliT)->NNUMALB ) ) + "/" + (dbfAlbCliT)->CSUFALB ), "" )
               cDesAlb                 += If( lSuAlb(),  Rtrim( cSuAlb()  ) + " " + rtrim( (dbfAlbCliT)->CCODSUALB ), "" )
               cDesAlb                 += " - Fecha " + Dtoc( (dbfAlbCliT)->DFECALB )
               (dbfTmpLin)->cDetalle   := cDesAlb
               (dbfTmpLin)->lControl   := .T.
            end





            while ( ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb == cAlbaran .AND. !( dbfAlbCliL )->( eof() ) )

               (dbfTmpLin)->( dbAppend() )
               (dbfTmpLin)->CSERIE     := " "
               (dbfTmpLin)->NNUMFAC    := 0
               (dbfTmpLin)->nNumLin    := (dbfAlbCliL)->nNumLin
               (dbfTmpLin)->CREF       := (dbfAlbCliL)->cRef
               (dbfTmpLin)->CDETALLE   := (dbfAlbCliL)->cDetalle
               (dbfTmpLin)->MLNGDES    := (dbfAlbCliL)->mLngDes
               (dbfTmpLin)->mNumSer    := (dbfAlbCliL)->mNumSer
               (dbfTmpLin)->NPREUNIT   := (dbfAlbCliL)->nPreUnit
               (dbfTmpLin)->NPNTVER    := (dbfAlbCliL)->nPntVer
               (dbfTmpLin)->nImpTrn    := (dbfAlbCliL)->nImpTrn
               (dbfTmpLin)->NCANENT    := (dbfAlbCliL)->nCanEnt
               (dbfTmpLin)->CUNIDAD    := (dbfAlbCliL)->cUnidad
               (dbfTmpLin)->NUNICAJA   := (dbfAlbCliL)->nUniCaja
               (dbfTmpLin)->NDTO       := (dbfAlbCliL)->nDto
               (dbfTmpLin)->NDTOPRM    := (dbfAlbCliL)->nDtoPrm
               (dbfTmpLin)->NIVA       := (dbfAlbCliL)->NIVA
               (dbfTmpLin)->nReq       := (dbfAlbCliL)->nReq
               (dbfTmpLin)->NPESOKG    := (dbfAlbCliL)->NPESOKG
               (dbfTmpLin)->cPESOKG    := (dbfAlbCliL)->cPESOKG
               (dbfTmpLin)->NVOLUMEN   := (dbfAlbCliL)->NVOLUMEN
               (dbfTmpLin)->CVOLUMEN   := (dbfAlbCliL)->CVOLUMEN
               (dbfTmpLin)->NCOMAGE    := (dbfAlbCliL)->NCOMAGE
               (dbfTmpLin)->DFECHA     := (dbfAlbCliL)->DFECHA
               (dbfTmpLin)->CTIPMOV    := (dbfAlbCliL)->CTIPMOV
               (dbfTmpLin)->CCODALB    := (dbfAlbCliL)->CSERALB + Str( (dbfAlbCliL)->NNUMALB ) + (dbfAlbCliL)->CSUFALB
               (dbfTmpLin)->LTOTLIN    := (dbfAlbCliL)->LTOTLIN
               (dbfTmpLin)->nDtoDiv    := (dbfAlbCliL)->nDtoDiv
               (dbfTmpLin)->nCtlStk    := (dbfAlbCliL)->nCtlStk
               (dbfTmpLin)->cAlmLin    := (dbfAlbCliL)->cAlmLin
               (dbfTmpLin)->cTipMov    := (dbfAlbCliL)->cTipMov
               (dbfTmpLin)->lIvaLin    := (dbfAlbCliL)->lIvaLin
               (dbfTmpLin)->lImpLin    := (dbfAlbCliL)->lImpLin
               (dbfTmpLin)->nValImp    := (dbfAlbCliL)->nValImp
               (dbfTmpLin)->cCodImp    := (dbfAlbCliL)->cCodImp
               (dbfTmpLin)->CCODPR1    := (dbfAlbCliL)->CCODPR1
               (dbfTmpLin)->CCODPR2    := (dbfAlbCliL)->CCODPR2
               (dbfTmpLin)->CVALPR1    := (dbfAlbCliL)->CVALPR1
               (dbfTmpLin)->CVALPR2    := (dbfAlbCliL)->CVALPR2
               (dbfTmpLin)->nCosDiv    := (dbfAlbCliL)->nCosDiv
               (dbfTmpLin)->lKitArt    := (dbfAlbCliL)->lKitArt
               (dbfTmpLin)->lKitChl    := (dbfAlbCliL)->lKitChl
               (dbfTmpLin)->lKitPrc    := (dbfAlbCliL)->lKitPrc
               (dbfTmpLin)->nMesGrt    := (dbfAlbCliL)->nMesGrt
               (dbfTmpLin)->lLote      := (dbfAlbCliL)->lLote
               (dbfTmpLin)->nLote      := (dbfAlbCliL)->nLote
               (dbfTmpLin)->cLote      := (dbfAlbCliL)->cLote
               (dbfTmpLin)->lControl   := (dbfAlbCliL)->lControl
               (dbfTmpLin)->lMsgVta    := (dbfAlbCliL)->lMsgVta
               (dbfTmpLin)->lNotVta    := (dbfAlbCliL)->lNotVta
               (dbfTmpLin)->cCodTip    := (dbfAlbCliL)->cCodTip
               (dbfTmpLin)->mObsLin    := (dbfAlbCliL)->mObsLin
               (dbfTmpLin)->Descrip    := (dbfAlbCliL)->Descrip
               (dbfTmpLin)->cCodPrv    := (dbfAlbCliL)->cCodPrv
               (dbfTmpLin)->cNomPrv    := (dbfAlbCliL)->cNomPrv
               (dbfTmpLin)->cImagen    := (dbfAlbCliL)->cImagen
               (dbfTmpLin)->cCodFam    := (dbfAlbCliL)->cCodFam
               (dbfTmpLin)->cGrpFam    := (dbfAlbCliL)->cGrpFam
               (dbfTmpLin)->cRefPrv    := (dbfAlbCliL)->cRefPrv
               (dbfTmpLin)->dFecEnt    := (dbfAlbCliL)->dFecEnt
               (dbfTmpLin)->dFecSal    := (dbfAlbCliL)->dFecSal
               (dbfTmpLin)->nPreAlq    := (dbfAlbCliL)->nPreAlq
               (dbfTmpLin)->lAlquiler  := (dbfAlbCliL)->lAlquiler
               (dbfTmpLin)->nNumMed    := (dbfAlbCliL)->nNumMed
               (dbfTmpLin)->nMedUno    := (dbfAlbCliL)->nMedUno
               (dbfTmpLin)->nMedDos    := (dbfAlbCliL)->nMedDos
               (dbfTmpLin)->nMedTre    := (dbfAlbCliL)->nMedTre
               (dbfTmpLin)->nPuntos    := (dbfAlbCliL)->nPuntos
               (dbfTmpLin)->nValPnt    := (dbfAlbCliL)->nValPnt
               (dbfTmpLin)->nDtoPnt    := (dbfAlbCliL)->nDtoPnt
               (dbfTmpLin)->nIncPnt    := (dbfAlbCliL)->nIncPnt
               (dbfTmpLin)->nFacCnv    := (dbfAlbCliL)->nFacCnv
               (dbfTmpLin)->lLinOfe    := (dbfAlbCliL)->lLinOfe
               (dbfTmpLin)->dFecCad    := (dbfAlbCliL)->dFecCad
               (dbfTmpLin)->cSuPed     := cSuPed

               ( dbfAlbCliL )->( dbSkip() )

            end





            aGet[ 37 ]:Show()
            aGet[ 38 ]:Hide()
            aGet[ 39 ]:Hide()

            oBtnPre:Disable()
            oBtnPed:Disable()
            oBtnAlb:Disable()

            oBtnGrp:bWhen              := {|| .F. }





            if aScan( aNumAlb, cAlbaran ) == 0
               aAdd( aNumAlb, cAlbaran )
            end

         else

            MsgStop( "Albarán no contiene lineas de detalle." )

         end

         ( dbfTmpLin )->( dbGoTop() )





         if ( dbfAlbCliS )->( dbSeek( cAlbaran ) )

            while ( dbfAlbCliS )->cSerAlb + Str( ( dbfAlbCliS )->nNumAlb ) + ( dbfAlbCliS )->cSufAlb == cAlbaran .AND. !( dbfAlbCliS )->( Eof() )

               ( dbfTmpSer )->( dbAppend() )
               ( dbfTmpSer )->nNumLin  := ( dbfAlbCliS )->nNumLin
               ( dbfTmpSer )->cRef     := ( dbfAlbCliS )->cRef
               ( dbfTmpSer )->cAlmLin  := ( dbfAlbCliS )->cAlmLin
               ( dbfTmpSer )->cNumSer  := ( dbfAlbCliS )->cNumSer

               ( dbfAlbCliS )->( dbSkip() )

            end

         end

         if uFieldEmpresa( "lGrpEnt" )





            if ( dbfAlbCliP )->( dbSeek( cAlbaran ) )

               while ( dbfAlbCliP )->cSerAlb + Str( ( dbfAlbCliP )->nNumAlb ) + ( dbfAlbCliP )->cSufAlb == cAlbaran .AND. !( dbfAlbCliP )->( Eof() )

                  nTotEntAlb     += ( dbfAlbCliP )->nImporte

                  ( dbfAlbCliP )->( dbSkip() )

               end

            end

            ( dbfAlbCliP )->( dbGoTop() )





            if nTotEntAlb <> 0

               ( dbfTmpPgo )->( dbAppend() )

               ( dbfTmpPgo )->lCobrado := .T.
               ( dbfTmpPgo )->lConPgo  := .F.
               ( dbfTmpPgo )->lRecImp  := .F.
               ( dbfTmpPgo )->lRecDto  := .F.
               ( dbfTmpPgo )->nNumRec  := ( dbfTmpPgo )->( RecNo() )
               ( dbfTmpPgo )->cCodCaj  := ( dbfAlbCliT )->cCodCaj
               ( dbfTmpPgo )->cCodCli  := ( dbfAlbCliT )->cCodCli
               ( dbfTmpPgo )->cNomCli  := ( dbfAlbCliT )->cNomCli
               ( dbfTmpPgo )->dEntrada := ( dbfAlbCliT )->dFecAlb
               ( dbfTmpPgo )->dPreCob  := ( dbfAlbCliT )->dFecAlb
               ( dbfTmpPgo )->dFecVto  := ( dbfAlbCliT )->dFecAlb
               ( dbfTmpPgo )->nImporte := nTotEntAlb
               ( dbfTmpPgo )->nImpCob  := nTotEntAlb
               ( dbfTmpPgo )->cDivPgo  := ( dbfAlbCliT )->cDivAlb
               ( dbfTmpPgo )->nVdvPgo  := ( dbfAlbCliT )->nVdvAlb
               ( dbfTmpPgo )->cCodAge  := ( dbfAlbCliT )->cCodAge
               ( dbfTmpPgo )->cTurRec  := ( dbfAlbCliT )->cTurAlb
               ( dbfTmpPgo )->lCloPgo  := .T.
               ( dbfTmpPgo )->cCodPgo  := ( dbfAlbCliT )->cCodPago
               ( dbfTmpPgo )->cDescrip := "Suma entregas a cuenta albarán: " + ( dbfAlbCliT )->cSerAlb + "/" + AllTrim( Str( ( dbfAlbCliT )->nNumAlb ) ) + "/" + ( dbfAlbCliT )->cSufAlb
               ( dbfTmpPgo )->( dbUnLock() )

            end

         else


            if ( dbfAlbCliP )->( dbSeek( cAlbaran ) )

               while ( dbfAlbCliP )->cSerAlb + Str( ( dbfAlbCliP )->nNumAlb ) + ( dbfAlbCliP )->cSufAlb == cAlbaran .AND. !( dbfAlbCliP )->( Eof() )

                  ( dbfTmpPgo )->( dbAppend() )

                  ( dbfTmpPgo )->nNumRec  := ( dbfTmpPgo )->( RecNo() )
                  ( dbfTmpPgo )->cCodCaj  := ( dbfAlbCliP )->cCodCaj
                  ( dbfTmpPgo )->cTurRec  := ( dbfAlbCliP )->cTurRec
                  ( dbfTmpPgo )->cCodCli  := ( dbfAlbCliP )->cCodCli
                  ( dbfTmpPgo )->dEntrada := ( dbfAlbCliP )->dEntrega
                  ( dbfTmpPgo )->dPreCob  := ( dbfAlbCliP )->dEntrega
                  ( dbfTmpPgo )->dFecVto  := ( dbfAlbCliP )->dEntrega
                  ( dbfTmpPgo )->nImporte := ( dbfAlbCliP )->nImporte
                  ( dbfTmpPgo )->nImpCob  := ( dbfAlbCliP )->nImporte
                  if !Empty( ( dbfAlbCliP )->cDescrip )
                  ( dbfTmpPgo )->cDescrip := ( dbfAlbCliP )->cDescrip
                  else
                  ( dbfTmpPgo )->cDescrip := "Entrega nº " + AllTrim( Str( ( dbfTmpPgo )->( RecNo() ) ) ) + " albarán " + ( dbfAlbCliP )->cSerAlb + "/" + AllTrim( Str( ( dbfAlbCliP )->nNumAlb ) ) + "/" + ( dbfAlbCliP )->cSufAlb
                  end
                  ( dbfTmpPgo )->cPgdoPor := ( dbfAlbCliP )->cPgdoPor
                  ( dbfTmpPgo )->cDocPgo  := ( dbfAlbCliP )->cDocPgo
                  ( dbfTmpPgo )->cDivPgo  := ( dbfAlbCliP )->cDivPgo
                  ( dbfTmpPgo )->nVdvPgo  := ( dbfAlbCliP )->nVdvPgo
                  ( dbfTmpPgo )->cCodAge  := ( dbfAlbCliP )->cCodAge
                  ( dbfTmpPgo )->cBncEmp  := ( dbfAlbCliP )->cBncEmp
                  ( dbfTmpPgo )->cBncCli  := ( dbfAlbCliP )->cBncCli
                  ( dbfTmpPgo )->cEntEmp  := ( dbfAlbCliP )->cEntEmp
                  ( dbfTmpPgo )->cSucEmp  := ( dbfAlbCliP )->cSucEmp
                  ( dbfTmpPgo )->cDigEmp  := ( dbfAlbCliP )->cDigEmp
                  ( dbfTmpPgo )->cCtaEmp  := ( dbfAlbCliP )->cCtaEmp
                  ( dbfTmpPgo )->cEntCli  := ( dbfAlbCliP )->cEntCli
                  ( dbfTmpPgo )->cSucCli  := ( dbfAlbCliP )->cSucCli
                  ( dbfTmpPgo )->cDigCli  := ( dbfAlbCliP )->cDigCli
                  ( dbfTmpPgo )->cCtaCli  := ( dbfAlbCliP )->cCtaCli
                  ( dbfTmpPgo )->lCobrado := .T.
                  ( dbfTmpPgo )->lConPgo  := .F.
                  ( dbfTmpPgo )->lRecImp  := .F.
                  ( dbfTmpPgo )->lRecDto  := .F.

                  ( dbfAlbCliP )->( dbSkip() )

               end

            end

         end





         if ( dbfAlbCliI )->( dbSeek( cAlbaran ) )

            while ( dbfAlbCliI )->cSerAlb + Str( ( dbfAlbCliI )->nNumAlb ) + ( dbfAlbCliI )->cSufAlb == cAlbaran .AND. !( dbfAlbCliI )->( Eof() )
               dbPass( dbfAlbCliI, dbfTmpInc, .T. )
               ( dbfAlbCliI )->( dbSkip() )
            end

         end





         if ( dbfAlbCliD )->( dbSeek( cAlbaran ) )

            while ( dbfAlbCliD )->cSerAlb + Str( ( dbfAlbCliD )->nNumAlb ) + ( dbfAlbCliD )->cSufAlb == cAlbaran .AND. !( dbfAlbCliD )->( Eof() )
               dbPass( dbfAlbCliD, dbfTmpDoc, .T. )
               ( dbfAlbCliD )->( dbSkip() )
            end

         end

         ( dbfAlbCliD )->( dbGoTop() )

         oBrwLin:Refresh()
         oBrwPgo:Refresh()

         oBrwLin:SetFocus()

         CursorWE()

      end

   else

      MsgStop( "Albarán : " + cAlbaran + " no encontrado" )

   end

   SetStatus( dbfAlbCliT, aAlbCliT )
   SetStatus( dbfAlbCliL, aAlbCliL )

   if !Empty( oBrwPgo )
      oBrwPgo:Refresh()
   end

RETURN .T.






STATIC FUNCTION cFacPrv( cFacPrv, aGet, aTmp, oBrw, nMode )

   local aFacPrvT
   local aFacPrvL
   local aFacPrvS

   if nMode <> 1 .OR. Empty( cFacPrv )
      return .T.
   end

   aFacPrvT          := aGetStatus( dbfFacPrvT, .T. )
   aFacPrvL          := aGetStatus( dbfFacPrvL, .T. )
   aFacPrvS          := aGetStatus( dbfFacPrvS, .T. )

   if ( dbfFacPrvT )->( dbSeek( cFacPrv ) )





      aGet[ 7 ]:cText( ( dbfFacPrvT )->cCodAlm )
      aGet[ 7 ]:lValid()
      aGet[ 8 ]:cText( ( dbfFacPrvT )->cCodCaj )
      aGet[ 8 ]:lValid()
      aGet[ 33 ]:cText( ( dbfFacPrvT )->nBultos )
      aGet[ 29]:cText( ( dbfFacPrvT )->cCondEnt )
      aGet[ 30 ]:cText( ( dbfFacPrvT )->mComent )
      aGet[ 31 ]:cText( ( dbfFacPrvT )->cObserv )

      aTmp[ 109 ]                   := ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac





      if ( dbfFacPrvL )->( dbSeek( cFacPrv ) )

         while ( ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac == cFacPrv .AND. !( dbfFacPrvL )->( eof() ) )

            if !( dbfFacPrvL )->lControl

               ( dbfTmpLin )->( dbAppend() )
               ( dbfTmpLin )->nNumLin    := ( dbfFacPrvL )->nNumLin
               ( dbfTmpLin )->cRef       := ( dbfFacPrvL )->cRef
               ( dbfTmpLin )->cRefPrv    := ( dbfFacPrvL )->cRefPrv
               ( dbfTmpLin )->cDetalle   := ( dbfFacPrvL )->cDetalle
               ( dbfTmpLin )->mLngDes    := ( dbfFacPrvL )->mLngDes
               ( dbfTmpLin )->mNumSer    := ( dbfFacPrvL )->mNumSer
               ( dbfTmpLin )->nCanEnt    := ( dbfFacPrvL )->nCanEnt
               ( dbfTmpLin )->cUnidad    := ( dbfFacPrvL )->cUnidad
               ( dbfTmpLin )->nUniCaja   := ( dbfFacPrvL )->nUniCaja
               ( dbfTmpLin )->nIva       := ( dbfFacPrvL )->nIva
               ( dbfTmpLin )->nReq       := ( dbfFacPrvL )->nReq
               ( dbfTmpLin )->dFecha     := ( dbfFacPrvT )->dFecFac
               ( dbfTmpLin )->nCtlStk    := ( dbfFacPrvL )->nCtlStk
               ( dbfTmpLin )->cAlmLin    := ( dbfFacPrvL )->cAlmLin
               ( dbfTmpLin )->lIvaLin    := ( dbfFacPrvL )->lIvaLin
               ( dbfTmpLin )->cCodPr1    := ( dbfFacPrvL )->cCodPr1
               ( dbfTmpLin )->cCodPr2    := ( dbfFacPrvL )->cCodPr2
               ( dbfTmpLin )->cValPr1    := ( dbfFacPrvL )->cValPr1
               ( dbfTmpLin )->cValPr2    := ( dbfFacPrvL )->cValPr2
               ( dbfTmpLin )->nCosDiv    := ( dbfFacPrvL )->nPreUnit
               ( dbfTmpLin )->lKitArt    := ( dbfFacPrvL )->lKitArt
               ( dbfTmpLin )->lKitChl    := ( dbfFacPrvL )->lKitChl
               ( dbfTmpLin )->lKitPrc    := ( dbfFacPrvL )->lKitPrc
               ( dbfTmpLin )->lLote      := ( dbfFacPrvL )->lLote
               ( dbfTmpLin )->nLote      := ( dbfFacPrvL )->nLote
               ( dbfTmpLin )->cLote      := ( dbfFacPrvL )->cLote
               ( dbfTmpLin )->cCodFam    := ( dbfFacPrvL )->cCodFam
               ( dbfTmpLin )->cGrpFam    := ( dbfFacPrvL )->cGrpFam
               ( dbfTmpLin )->cCodPrv    := ( dbfFacPrvT )->cCodPrv
               ( dbfTmpLin )->cNomPrv    := ( dbfFacPrvT )->cNomPrv
               ( dbfTmpLin )->nNumMed    := ( dbfFacPrvL )->nNumMed
               ( dbfTmpLin )->nMedUno    := ( dbfFacPrvL )->nMedUno
               ( dbfTmpLin )->nMedDos    := ( dbfFacPrvL )->nMedDos
               ( dbfTmpLin )->nMedTre    := ( dbfFacPrvL )->nMedTre
               ( dbfTmpLin )->nFacCnv    := ( dbfFacPrvL )->nFacCnv
               ( dbfTmpLin )->mObsLin    := ( dbfFacPrvL )->mObsLin

            end

            ( dbfFacPrvL )->( dbSkip() )

         end

      else

         MsgStop( "La factura no contiene lineas de detalle." )

      end

      ( dbfTmpLin )->( dbGoTop() )





      if ( dbfFacPrvS )->( dbSeek( cFacPrv ) )

         while ( dbfFacPrvS )->cSerFac + Str( ( dbfFacPrvS )->nNumFac ) + ( dbfFacPrvS )->cSufFac == cFacPrv .AND. !( dbfFacPrvS )->( Eof() )

            ( dbfTmpSer )->( dbAppend() )
            ( dbfTmpSer )->nNumLin  := ( dbfFacPrvS )->nNumLin
            ( dbfTmpSer )->cRef     := ( dbfFacPrvS )->cRef
            ( dbfTmpSer )->cAlmLin  := ( dbfFacPrvS )->cAlmLin
            ( dbfTmpSer )->cNumSer  := ( dbfFacPrvS )->cNumSer

            ( dbfFacPrvS )->( dbSkip() )

         end

      end





      RecFacCli( aTmp, .F. )

      oBrw:SetFocus()
      oBrw:Refresh()

      RecalculaTotal( aTmp )

   else

      MsgStop( "Factura : " + cFacPrv + " no encontrada" )

   end

   SetStatus( dbfFacPrvT, aFacPrvT )
   SetStatus( dbfFacPrvL, aFacPrvL )
   SetStatus( dbfFacPrvS, aFacPrvS )

RETURN .T.







FUNCTION cCliFacCli( cFacCli, uFacCliT )

   local cCodCli  := ""

   do case
      case ValType( uFacCliT ) == "C"
         if (uFacCliT)->( dbSeek( cFacCli ) )
            cCodCli     := (uFacCliT)->CCODCLI
         end
      case ValType( uFacCliT ) == "O"
         if uFacCliT:Seek( cFacCli )
            cCodCli     := uFacCliT:cCodCli
         end
   end

RETURN ( cCodCli )







FUNCTION cNbrFacCli( cFacCli, uFacCliT )

   local cNomCli  := ""

   do case
      case ValType( uFacCliT ) == "C"
         if (uFacCliT)->( dbSeek( cFacCli ) )
            cNomCli     := (uFacCliT)->CNOMCLI
         end
      case ValType( uFacCliT ) == "O"
         if uFacCliT:Seek( cFacCli )
            cNomCli     := uFacCliT:cNomCli
         end
   end

RETURN ( cNomCli )







FUNCTION cPgoFacCli( cFacCli, dbfFacCliT )

   local cCodPgo  := ""

   if ValType( dbfFacCliT ) == "O"
      if dbfFacCliT:Seek( cFacCli )
         cCodPgo  := dbfFacCliT:cCodPago
      end
   else
      if ( dbfFacCliT )->( dbSeek( cFacCli ) )
         cCodPgo  := ( dbfFacCliT )->cCodPago
      end
   end

RETURN ( cCodPgo )



FUNCTION cProFacCli( cFacCli, dbfFacCliT )

   local cCodPro  := ""

   if ( dbfFacCliT )->( dbSeek( cFacCli ) )
      cCodPro     := ( dbfFacCliT )->CCODPRO
    end

RETURN ( cCodPro )






FUNCTION lConFacCli( cFacCli, dbfFacCliT )

   local lConFac  := .F.

   if ( dbfFacCliT )->( dbSeek( cFacCli ) )
      lConFac     := ( dbfFacCliT )->lContab
   end

RETURN ( lConFac )






FUNCTION cAgeFacCli( cFacCli, dbfFacCliT )

   local cCliFac  := ""

   if ValType( dbfFacCliT ) == "O"
      if dbfFacCliT:Seek( cFacCli )
         cCliFac  := dbfFacCliT:cCodAge
      end
   else
      if ( dbfFacCliT )->( dbSeek( cFacCli ) )
         cCliFac  := ( dbfFacCliT )->cCodAge
      end
   end

RETURN ( cCliFac )






FUNCTION cDesFacCli( cFacCliL, cFacCliS )

   IIF( cFacCliL == nil, cFacCliL := dbfFacCliL, ) ;
   IIF( cFacCliS == nil, cFacCliS := dbfFacCliS, ) ;

RETURN ( Descrip( cFacCliL, cFacCliS ) )



Function cCtaFacCli( cFacCliT, cFacCliP, cBncCli )

   local cCtaFacCli     := ""

   IIF( cFacCliT == nil, cFacCliT := dbfFacCliT, ) ;
   IIF( cFacCliP == nil, cFacCliP := dbfFacCliP, ) ;
   IIF( cBncCli == nil, cBncCli := dbfCliBnc, ) ;

   cCtaFacCli           := Rtrim( ( cFacCliT )->cEntBnc + ( cFacCliT )->cSucBnc + ( cFacCliT )->cDigBnc + ( cFacCliT )->cCtaBnc )

   if Empty( cCtaFacCli )
      if dbSeekInOrd( ( cFacCliT )->cSerie + Str( ( cFacCliT )->nNumFac ) + ( cFacCliT )->cSufFac, "nNumFac", cFacCliP )
         cCtaFacCli     := cClientCuenta( ( cFacCliP )->cCodCli, cBncCli )
      end
   end

Return ( cCtaFacCli )



FUNCTION nBas( aIva, nPctIva, nRet )

   local nPos := aScan( aIva, {| aIva | aIva[ 3 ] == nPctIva } )

RETURN ( if( nPos <> 0, aIva[ nPos, nRet ], 0 ) )



static function lGenFacCli( oBrw, oBtn, nDevice )

   local bAction

   IIF( nDevice == nil, nDevice := 1, ) ;

   if Empty( oBtn )
      return nil
   end

   if !( dbfDoc )->( dbSeek( "FC" ) )








      oWndBrw:NewAt( "DOCUMENT",,, {||( msgStop( "No hay facturas de clientes predefinidas" ) )}, "No hay documentos", "N",,, 4, oBtn, .F. )

   else

      while ( dbfDoc )->cTipo == "FC" .AND. !( dbfDoc )->( eof() )

         bAction  := bGenFacCli( nDevice, "Imprimiendo facturas de clientes", ( dbfDoc )->Codigo )

         oWndBrw:NewAt( "Document", , , bAction, Rtrim( ( dbfDoc )->cDescrip ) , , , , , oBtn )

         ( dbfDoc )->( dbSkip() )

      end

   end

   SysRefresh()

return nil



static function bGenFacCli( nDevice, cTitle, cCodDoc )

   local bGen
   local nDev  := by( nDevice )
   local cTit  := by( cTitle  )
   local cCod  := by( cCodDoc )

   if nDev == 1
      bGen     := {|| GenFacCli( nDevice, cTit, cCod ) }
   else
      bGen     := {|| GenFacCli( nDevice, cTit, cCod ) }
   end

return ( bGen )




































function nTotDFacCli( cCodArt, dbfFacCliL, cCodAlm )

   local nOrd     := ( dbfFacCliL )->( OrdSetFocus( "cRef" ) )
   local nRec     := ( dbfFacCliL )->( Recno() )
   local nTotVta  := 0

   if ( dbfFacCliL )->( dbSeek( cCodArt ) )

      while ( dbfFacCliL )->CREF == cCodArt .AND. !( dbfFacCliL )->( eof() )

         if !( dbfFacCliL )->LTOTLIN
            if cCodAlm <> nil
               if cCodAlm == ( dbfFacCliL )->cAlmLin
                  nTotVta  += nTotNFacCli( dbfFacCliL ) * NotCero( ( dbfFacCliL )->nFacCnv )
               end
            else
               nTotVta     += nTotNFacCli( dbfFacCliL ) * NotCero( ( dbfFacCliL )->nFacCnv )
            end
         end

         ( dbfFacCliL )->( dbSkip() )

      end

   end

   ( dbfFacCliL )->( OrdSetFocus( nOrd  ) )
   ( dbfFacCliL )->( dbGoTo( nRec ) )

return ( nTotVta )



FUNCTION nVolLFacCli( dbfLin )

   local nCalculo    := 0

   if !( dbfLin )->lTotLin
      nCalculo       := nTotNFacCli( dbfLin ) * ( dbfLin )->nVolumen
   end

RETURN ( nCalculo )



FUNCTION nTotPFacCli( dbfLin, nDec, nVdv, cPorDiv )

   local nCalculo
   local nDescuentoGeneral
   local nDescuentoPromocional

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   if ( dbfLin )->lTotLin

      nCalculo                   := nTotUFacCli( dbfLin, nDec )

   else





      nCalculo                   := nTotUFacCli( dbfLin, nDec )

      nCalculo                   -= Round( ( dbfLin )->nDtoDiv , nDec )

      if ( dbfLin )->nDto <> 0
         nCalculo                -= nCalculo * ( dbfLin )->nDto / 100
      end

      if ( dbfLin )->nDtoPrm <> 0
         nCalculo                -= nCalculo * ( dbfLin )->nDtoPrm / 100
      end






   end

   nCalculo                      := Round( nCalculo / nVdv, nDec )

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )






FUNCTION nDtoLFacCli( dbfLin, nDec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;





   if ( dbfLin )->nDto <> 0
      nCalculo       := nTotUFacCli( dbfLin, nDec )
      nCalculo       -= Round( Div( ( dbfLin )->nDtoDiv, nVdv ), nDec )
      nCalculo       := nCalculo * ( dbfLin )->nDto / 100
      nCalculo       := Round( nCalculo / nVdv, nDec )
   end

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nPrmLFacCli( dbfLin, nDec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;





   if ( dbfLin )->nDto <> 0
      nCalculo       := nTotUFacCli( dbfLin, nDec )
      nCalculo       -= Round( Div( ( dbfLin )->nDtoDiv, nVdv ), nDec )
      nCalculo       := nCalculo * ( dbfLin )->nDtoPrm / 100
      nCalculo       := Round( nCalculo / nVdv, nDec )
   end

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



Function nTotDtoLFacCli( dbfLin, nDec, nVdv, cPorDiv )

   local nCalculo

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nDtoLFacCli( dbfLin, nDec, nVdv ) * nTotNFacCli( dbfLin )

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

   nCalculo          := Round( nCalculo, nDec )

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION sTotLFacCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPorDiv )

   local uTotLFacCli
   local nTotLFacCli := nTotLFacCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn )

   if nTotLFacCli == 0 .AND. !( dbfLin )->lControl
      uTotLFacCli    := "S/C"
   else
      uTotLFacCli    := if( cPorDiv <> NIL, Trans( nTotLFacCli, cPorDiv ), nTotLFacCli )
   end

RETURN ( uTotLFacCli )



FUNCTION nDtoAtpFacCli( uFacCliT, dbfFacCliL, nDec, nRou, nVdv, lPntVer, lImpTrn )

   local nCalculo
   local nDtoAtp  := 0

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRou == nil, nRou := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lPntVer == nil, lPntVer := .F., ) ;
   IIF( lImpTrn == nil, lImpTrn := .F., ) ;

   nCalculo       := nTotLFacCli( dbfFacCliL, nDec, nRou, nVdv, .T., lPntVer, lImpTrn )

   if ( uFacCliT )->nSbrAtp <= 1 .AND. ( uFacCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uFacCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uFacCliT )->nDtoEsp / 100, nRou )

   if ( uFacCliT )->nSbrAtp == 2 .AND. ( uFacCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uFacCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uFacCliT )->nDpp    / 100, nRou )

   if ( uFacCliT )->nSbrAtp == 3 .AND. ( uFacCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uFacCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uFacCliT )->nDtoUno / 100, nRou )

   if ( uFacCliT )->nSbrAtp == 4 .AND. ( uFacCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uFacCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uFacCliT )->nDtoDos / 100, nRou )

   if ( uFacCliT )->nSbrAtp == 5 .AND. ( uFacCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uFacCliT )->nDtoAtp / 100, nRou )
   end

RETURN ( nDtoAtp )






FUNCTION nNetLFacCli( cFacCliL, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo

   IIF( cFacCliL == nil, cFacCliL := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := 2, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lDto == nil, lDto := .T., ) ;
   IIF( lPntVer == nil, lPntVer := .T., ) ;

   nCalculo          := nTotLFacCli( cFacCliL, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn )

   if ( cFacCliL )->nIva <> 0 .AND. ( cFacCliL )->lIvaLin
      if nRou <> nil
         nCalculo -= Round( nCalculo / ( 100 / ( cFacCliL )->nIva + 1 ), nRou )
      else
         nCalculo -= ( nCalculo / ( 100 / ( cFacCliL )->nIva + 1 ) )
      end
   end

RETURN ( if( cPouDiv <> NIL, Trans( nCalculo, cPouDiv ), nCalculo ) )






function nVtaFacCli( cCodCli, dDesde, dHasta, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, nYear )

   local nCon     := 0
   local nOrd     := ( dbfFacCliT )->( OrdSetFocus( "CCODCLI" ) )
   local nRec     := ( dbfFacCliT )->( Recno() )





   if ( dbfFacCliT )->( dbSeek( cCodCli ) )

      while ( dbfFacCliT )->cCodCli = cCodCli .AND. !( dbfFacCliT )->( Eof() )



         if ( dDesde == nil .OR. ( dbfFacCliT )->DFECFAC >= dDesde ) .AND. ( dHasta == nil .OR. ( dbfFacCliT )->DFECFAC <= dHasta ) .AND. ( nYear == nil .OR. Year( ( dbfFacCliT )->dFecFac ) == nYear )

            nCon  += nTotFacCli( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, nil, dbfAntCliT, nil, cDivEmp(), .F. )

         end

         ( dbfFacCliT )->( dbSkip() )

         SysRefresh()

      end

   end

   ( dbfFacCliT )->( OrdSetFocus( nOrd ) )
   ( dbfFacCliT )->( dbGoTo( nRec ) )

return nCon






function nCobFacCli( cCodCli, dDesde, dHasta, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, lOnlyCob, nYear )

   local nCon        := 0
   local nOrd        := ( dbfFacCliP )->( OrdSetFocus( "CCODCLI" ) )
   local nRec        := ( dbfFacCliP )->( Recno() )

   IIF( lOnlyCob == nil, lOnlyCob := .T., ) ;





   if ( dbfFacCliP )->( dbSeek( cCodCli ) )

      while ( dbfFacCliP )->cCodCli = cCodCli .AND. !( dbfFacCliP )->( Eof() )




         if ( ( dbfFacCliP )->lCobrado )                                   .AND. ( dDesde == nil .OR. ( dbfFacCliP )->dEntrada >= dDesde )      .AND. ( dHasta == nil .OR. ( dbfFacCliP )->dEntrada <= dHasta )      .AND. ( nYear == nil .OR. Year( ( dbfFacCliP )->dEntrada ) == nYear )

            nCon     += nTotCobCli( dbfFacCliP, dbfDiv, nil, .F. )

         end

         ( dbfFacCliP )->( dbSkip() )

         SysRefresh()

      end

   end

   ( dbfFacCliP )->( OrdSetFocus( nOrd ) )
   ( dbfFacCliP )->( dbGoTo( nRec ) )

return nCon



function nPdtFacCli( cCodCli, dDesde, dHasta, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, lOnlyCob, nYear )

   local nCon        := 0
   local nOrd        := ( dbfFacCliP )->( OrdSetFocus( "CCODCLI" ) )
   local nRec        := ( dbfFacCliP )->( Recno() )

   IIF( lOnlyCob == nil, lOnlyCob := .T., ) ;





   if ( dbfFacCliP )->( dbSeek( cCodCli ) )

      while ( dbfFacCliP )->cCodCli = cCodCli .AND. !( dbfFacCliP )->( Eof() )




         if (!( dbfFacCliP )->lCobrado )                                   .AND. ( dDesde == nil .OR. ( dbfFacCliP )->dEntrada >= dDesde )      .AND. ( dHasta == nil .OR. ( dbfFacCliP )->dEntrada <= dHasta )      .AND. ( nYear == nil .OR. Year( ( dbfFacCliP )->dEntrada ) == nYear )

            nCon     += nTotRecCli( dbfFacCliP, dbfDiv, nil, .F. )

         end

         ( dbfFacCliP )->( dbSkip() )

         SysRefresh()

      end

   end

   ( dbfFacCliP )->( OrdSetFocus( nOrd ) )
   ( dbfFacCliP )->( dbGoTo( nRec ) )

return nCon



static function QuiFacCli()

   local nOrdAnt
   local cSerDoc
   local nNumDoc
   local cSufDoc
   local cNumPed
   local cNumAlb
   local nRec

   if ( dbfFacCliT )->lCloFac .AND. !oUser():lAdministrador()
      msgStop( "Solo puede eliminar facturas cerradas los administradores." )
      return .F.
   end

   cSerDoc           := ( dbfFacCliT )->cSerie
   nNumDoc           := ( dbfFacCliT )->nNumFac
   cSufDoc           := ( dbfFacCliT )->cSufFac
   cNumPed           := ( dbfFacCliT )->cNumPed
   cNumAlb           := ( dbfFacCliT )->cNumAlb





   nOrdAnt     := ( dbfFacCliL )->( OrdSetFocus( "nNumFac" ) )

   while ( dbfFacCliL )->( dbSeek( cSerDoc + Str( nNumDoc ) + cSufDoc ) ) .AND. !( dbfFacCliL )->( eof() )
      if dbLock( dbfFacCliL )
         ( dbfFacCliL )->( dbDelete() )
         ( dbfFacCliL )->( dbUnLock() )
      end

      ( dbfFacCliL )->( dbSkip() )
   end

   ( dbfFacCliL )->( OrdSetFocus( nOrdAnt ) )





   nOrdAnt     := ( dbfFacCliP )->( OrdSetFocus( "nNumFac" ) )

   while ( dbfFacCliP )->( dbSeek( cSerDoc + Str( nNumDoc ) + cSufDoc ) ) .AND. !( dbfFacCliP )->( eof() )
      if dbLock( dbfFacCliP )
         ( dbfFacCliP )->( dbDelete() )
         ( dbfFacCliP )->( dbUnLock() )
      end

      ( dbfFacCliP )->( dbSkip() )
   end

   ( dbfFacCliP )->( OrdSetFocus( nOrdAnt ) )





   nOrdAnt     := ( dbfFacCliI )->( OrdSetFocus( "nNumFac" ) )

   while ( dbfFacCliI )->( dbSeek( cSerDoc + Str( nNumDoc ) + cSufDoc ) ) .AND. !( dbfFacCliI )->( eof() )
      if dbLock( dbfFacCliI )
         ( dbfFacCliI )->( dbDelete() )
         ( dbfFacCliI )->( dbUnLock() )
      end

      ( dbfFacCliI )->( dbSkip() )
   end

   ( dbfFacCliI )->( OrdSetFocus( nOrdAnt ) )





   nOrdAnt     := ( dbfFacCliD )->( OrdSetFocus( "nNumFac" ) )

   while ( dbfFacCliD )->( dbSeek( cSerDoc + Str( nNumDoc ) + cSufDoc ) ) .AND. !( dbfFacCliD )->( eof() )
      if dbLock( dbfFacCliD )
         ( dbfFacCliD )->( dbDelete() )
         ( dbfFacCliD )->( dbUnLock() )
      end

      ( dbfFacCliD )->( dbSkip() )
   end

   ( dbfFacCliD )->( OrdSetFocus( nOrdAnt ) )





   nOrdAnt     := ( dbfFacCliS )->( OrdSetFocus( "nNumFac" ) )

   while ( dbfFacCliS )->( dbSeek( cSerDoc + Str( nNumDoc ) + cSufDoc ) ) .AND. !( dbfFacCliS )->( eof() )
      if dbLock( dbfFacCliS )
         ( dbfFacCliS )->( dbDelete() )
         ( dbfFacCliS )->( dbUnLock() )
      end

      ( dbfFacCliS )->( dbSkip() )
   end

   ( dbfFacCliS )->( OrdSetFocus( nOrdAnt ) )





   if !Empty( cNumPed )

      if( dbfPedCliP )->( dbSeek( cNumPed ) )

         while ( dbfPedCliP )->cSerPed + Str( ( dbfPedCliP )->nNumPed ) + ( dbfPedCliP )->cSufPed == cNumPed .AND. !( dbfPedCliP )->( Eof() )

            if dbLock( dbfPedCliP )
               ( dbfPedCliP )->lPasado := .F.
               ( dbfPedCliP )->( dbUnLock() )
            end

         ( dbfPedCliP )->( dbSkip() )

         end

      end





      oStock:SetEstadoPedCli( cNumPed, .T., cSerDoc + Str( nNumDoc ) + cSufDoc )

   end



   if !Empty( cNumAlb )

      if( dbfAlbCliP )->( dbSeek( cNumAlb ) )

         while ( dbfAlbCliP )->cSerAlb + Str( ( dbfAlbCliP )->nNumAlb ) + ( dbfAlbCliP )->cSufAlb == cNumAlb .AND. !( dbfAlbCliP )->( Eof() )

            if dbLock( dbfAlbCliP )
               ( dbfAlbCliP )->lPasado := .F.
               ( dbfAlbCliP )->( dbUnLock() )
            end

         ( dbfAlbCliP )->( dbSkip() )

         end

      end

   end





   nOrdAnt  := ( dbfAlbCliT )->( OrdSetFocus( "cNumFac" ) )

   while ( dbfAlbCliT )->( dbSeek( cSerDoc + Str( nNumDoc, 9 ) + cSufDoc ) ) .AND. !( dbfAlbCliT )->( eof() )

      SetFacturadoAlbaranCliente( .F., , dbfAlbCliT, dbfAlbCliL, dbfAlbCliS )

   end

   ( dbfAlbCliT )->( OrdSetFocus( nOrdAnt ) )





   if !Empty( ( dbfFacCliT )->cNumPre )
      if ( dbfPreCliT )->( dbSeek( ( dbfFacCliT )->cNumPre ) )
         if ( dbfPreCliT )->( dbRLock() )
            ( dbfPreCliT )->lEstado := .F.
            ( dbfPreCliT )->( DbUnlock() )
         end
      end
   end





   nOrdAnt     := ( dbfAntCliT )->( OrdSetFocus( "cNumDoc" ) )

   if ( dbfAntCliT )->( dbSeek( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) )

      while ( dbfAntCliT )->cNumDoc == ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac .AND. !( dbfAntCliT )->( eof() )

         if dbLock( dbfAntCliT )
            ( dbfAntCliT )->lLiquidada := .F.
            ( dbfAntCliT )->( dbUnLock() )
         end

         ( dbfAntCliT )->( dbSkip() )

      end

   end

   ( dbfAntCliT )->( OrdSetFocus( nOrdAnt ) )





   if !Empty( ( dbfFacCliT )->cNumDoc ) .AND. ( dbfTikT )->( dbSeek( ( dbfFacCliT )->cNumDoc ) )
      DelRecno( dbfTikT, nil, .F. )
   end

   if !Empty( oAuditor() )
      oAuditor():AddEvent( "Eliminada factura de clientes", cSerDoc + Str( nNumDoc ) + cSufDoc, "11" )
   end





   nPutDoc( cSerDoc, nNumDoc, cSufDoc, dbfFacCliT, "nFacCli", , dbfCount )

return .T.



STATIC FUNCTION aGetSelRec( oBrw, bAction, cTitle, lHide1, cTitle1, lHide2, cTitle2, bPreAction, bPostAction )

   local oDlg
   local oBtnOk
   local oBtnCancel
   local oRad
   local nRad        := 1
   local aRet        := {}
   local oTree
   local oChk1
   local oChk2
   local lChk1       := .T.
   local lChk2       := .T.
   local nRecno      := ( dbfFacCliT )->( Recno() )
   local nOrdAnt     := ( dbfFacCliT )->( OrdSetFocus( 1 ) )
   local oSerIni
   local oSerFin
   local cSerIni     := ( dbfFacCliT )->cSerie
   local cSerFin     := ( dbfFacCliT )->cSerie
   local oDocIni
   local oDocFin
   local nDocIni     := ( dbfFacCliT )->nNumFac
   local nDocFin     := ( dbfFacCliT )->nNumFac
   local oSufIni
   local oSufFin
   local cSufIni     := ( dbfFacCliT )->cSufFac
   local cSufFin     := ( dbfFacCliT )->cSufFac
   local oMtrInf
   local nMtrInf
   local lFechas     := .T.
   local dDesde      := CtoD( "01/01/" + Str( Year( Date() ) ) )
   local dHasta      := Date()
   local oImageList

   IIF( cTitle == nil, cTitle := "", ) ;
   IIF( lHide1 == nil, lHide1 := .F., ) ;
   IIF( cTitle1 == nil, cTitle1 := "", ) ;
   IIF( lHide2 == nil, lHide2 := .F., ) ;
   IIF( cTitle2 == nil, cTitle2 := "", ) ;

   oImageList        := TImageList():New( 16, 16 )
   oImageList:AddMasked( TBitmap():Define( "Bullet_Square_Red_16" ),    ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   oImageList:AddMasked( TBitmap():Define( "Bullet_Square_Green_16" ),  ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )

   oDlg = TDialog():New(,,,, cTitle, "SelectRango",, .F.,,,,,, .F.,,,,,, .F., )



   oRad := TRadMenu():Redefine( { | u | If( PCount()==0, nRad, nRad:= u ) }, oDlg,, { 80, 81 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z" )},,,,,, .T., {||     ( oRad:nOption == 2 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )






   TBtnBmp():ReDefine( 101, "Up16",,,,, {|Self|( dbFirst( dbfFacCliT, "nNumFac", oDocIni, cSerIni, "nNumFac" ) )}, oDlg, .F.,, .F.,,,,,, !.T.,, .F.,,, .F., !.F. )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z" )},,,,,, .T., {||     ( oRad:nOption == 2 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TBtnBmp():ReDefine( 111, "Down16",,,,, {|Self|( dbLast( dbfFacCliT, "nNumFac", oDocFin, cSerFin, "nNumFac" ) )}, oDlg, .F.,, .F.,,,,,, !.T.,, .F.,,, .F., !.F. )






   oDocIni := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRad == 2 )},, .F., .T.,,,,,, nil,,, )






   oDocFin := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRad == 2 )},, .F., .T.,,,,,, nil,,, )





   oSufIni := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRad == 2 )},, .F., .F.,,,,,, nil,,, )





   oSufFin := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRad == 2 )},, .F., .F.,,,,,, nil,,, )



   oChk1 := TCheckBox():ReDefine( 160, { | u | If( PCount()==0, lChk1, lChk1:= u ) }, oDlg,,,,,,, .F.,, .F. )



   oChk2 := TCheckBox():ReDefine( 180, { | u | If( PCount()==0, lChk2, lChk2:= u ) }, oDlg,,,,,,, .F.,, .F. )







   TCheckBox():ReDefine( 300, { | u | If( PCount()==0, lFechas, lFechas:= u ) }, oDlg,,,,,,, .F.,, .F. )





   TGetHlp():ReDefine( 310, { | u | If( PCount()==0, dDesde, dDesde:= u ) }, oDlg,,,,,,,,, .F., {||     ( !lFechas )},, .F., .T.,,,,,, nil,,, )





    TGetHlp():ReDefine( 320, { | u | If( PCount()==0, dHasta, dHasta:= u ) }, oDlg,,,,,,,,, .F., {||     ( !lFechas )},, .F., .T.,,,,,, nil,,, )





   oTree             := TTreeView():Redefine( 170, oDlg )
   oTree:bLDblClick  := {|| TreeChanged( oTree ) }





   oMtrInf := TMeter():ReDefine( 200, { | u | If( PCount()==0, nMtrInf, nMtrInf:= u ) },, oDlg, .F.,,, .T.,,,, )

   oMtrInf:SetTotal( ( dbfFacCliT )->( OrdKeyCount() ) )




   oBtnOk := TButton():ReDefine( 1, {||( MakSelRec( bAction, bPreAction, bPostAction, cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oBtnCancel, dbfFacCliT, dbfFacCliL, oTree, oBrw, oMtrInf ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| oBtnOk:Click() } )

   oDlg:bStart := {|| StartGetSelRec( oBrw, oRad, oChk1, oChk2, oSerIni, oSerFin, oDocIni, oDocFin, oSufIni, oSufFin, lHide1, lHide2, cTitle1, cTitle2 ) }



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oTree:SetImageList( oImageList ) )}, oDlg:bRClicked,,, )

   ( dbfFacCliT )->( ordSetFocus( nOrdAnt ) )
   ( dbfFacCliT )->( dbGoTo( nRecNo ) )

   oImageList:End()

   oTree:Destroy()

   oBrw:SetFocus()
   oBrw:Refresh()

RETURN ( aRet )



Static Function StartGetSelRec( oBrw, oRad, oChk1, oChk2, oSerIni, oSerFin, oDocIni, oDocFin, oSufIni, oSufFin, lHide1, lHide2, cTitle1, cTitle2 )

   if !Empty( oBrw ) .AND. ( len( oBrw:oBrw:aSelected ) > 1 )

      oRad:SetOption( 1 )

   else

      oRad:SetOption( 2 )

      oSerIni:Enable()
      oSerFin:Enable()
      oDocIni:Enable()
      oDocFin:Enable()
      oSufIni:Enable()
      oSufFin:Enable()

   end

   if lHide1
      oChk1:Hide()
   else
      SetWindowText( oChk1:hWnd, cTitle1 )
      oChk1:Refresh()
   end

   if lHide2
      oChk2:Hide()
   else
      SetWindowText( oChk2:hWnd, cTitle2 )
      oChk2:Refresh()
   end

Return ( nil )



Static Function TreeChanged( oTree )

   local oItemTree   := oTree:GetItem()

   if !Empty( oItemTree ) .AND. !Empty( oItemTree:bAction )
      Eval( oItemTree:bAction )
   end

RETURN NIL



Static Function MakSelRec( bAction, bPreAction, bPostAction, cDocIni, cDocFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oBtnCancel, dbfFacCliT, dbfFacCliL, oTree, oBrw, oMtrInf )

   local n        := 0
   local nPos     := 0
   local nRec     := ( dbfFacCliT )->( Recno() )
   local aPos
   local lRet
   local lPre
   local lWhile   := .T.





   if lChk1
      aPos        := { 0, 0 }
      ClientToScreen( oDlg:hWnd, aPos )
      oDlg:Move( aPos[ 1 ] - 22, aPos[ 2 ] - 510 )
   end





   oBtnCancel:bAction   := {|| lWhile := .F. }

   oDlg:Disable()

   oTree:Enable()
   oTree:DeleteAll()

   oBtnCancel:Enable()

   if !Empty( bPreAction )
      lPre              := Eval( bPreAction )
   end

   if !IsLogic( lPre ) .OR. lPre

      if ( nRad == 1 )

         oMtrInf:SetTotal( len( oBrw:oBrw:aSelected ) )

         for each nPos in ( oBrw:oBrw:aSelected )

            ( dbfFacCliT )->( dbGoTo( nPos ) )

            if lFechas .OR.( ( dbfFacCliT )->dFecFac >= dDesde .AND. ( dbfFacCliT )->dFecFac <= dHasta )

               lRet  := Eval( bAction, lChk1, lChk2, oTree, dbfFacCliT, dbfFacCliL )

               if IsFalse( lRet )
                  exit
               end

            end

            oMtrInf:Set( ++n )

            SysRefresh()

            if !lWhile
               exit
            end

         next

      else

         oMtrInf:SetTotal( ( dbfFacCliT )->( OrdKeyCount() ) )

         ( dbfFacCliT )->( dbSeek( cDocIni, .T. ) )




         while ( lWhile )                                                                                      .AND.  ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac, 9 ) + ( dbfFacCliT )->cSufFac >= cDocIni .AND.  ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac, 9 ) + ( dbfFacCliT )->cSufFac <= cDocFin .AND.  !( dbfFacCliT )->( eof() )

            if lFechas .OR.( ( dbfFacCliT )->dFecFac >= dDesde .AND. ( dbfFacCliT )->dFecFac <= dHasta )

               lRet  := Eval( bAction, lChk1, lChk2, oTree, dbfFacCliT, dbfFacCliL )

               if IsFalse( lRet )
                  exit
               end

            end

            oMtrInf:Set( ( dbfFacCliT )->( OrdKeyNo() ) )

            ( dbfFacCliT )->( dbSkip() )

            SysRefresh()

         end

         oMtrInf:Set( ( dbfFacCliT )->( OrdKeyCount() ) )

      end


      if !Empty( bPostAction )
         Eval( bPostAction )
      end

   end

   ( dbfFacCliT )->( dbGoTo( nRec ) )

   if lChk1
      WndCenter( oDlg:hWnd )
   end

   oBtnCancel:bAction   := {|| oDlg:End() }

   oDlg:Enable()

   if oBrw <> nil
      oBrw:Refresh()
   end

RETURN ( nil )






STATIC FUNCTION cPedCli( aGet, aTmp, oBrwLin, oBrwPgo, nMode )

   local nDiv
   local cDesAlb
   local nTotRet
   local cPedido     := aGet[ 38 ]:VarGet()
   local lValid      := .F.
   local nTotEntPed  := 0

   if nMode <> 1 .OR. empty( cPedido )
      return .T.
   end

   if dbSeekInOrd( cPedido, "nNumPed", dbfPedCliT )

      if ( dbfPedCliT )->nEstado == 3

         MsgStop( "Pedido recibido" )
         lValid      := .F.

      else

         CursorWait()

         aGet[38 ]:bWhen := {|| .F. }

         aGet[6 ]:cText( ( dbfPedCliT )->CCODCLI )
         aGet[6 ]:lValid()
         aGet[6 ]:Disable()

         aGet[9 ]:cText( (dbfPedCliT)->CNOMCLI )
         aGet[10 ]:cText( (dbfPedCliT)->CDIRCLI )
         aGet[11 ]:cText( (dbfPedCliT)->CPOBCLI )
         aGet[12 ]:cText( (dbfPedCliT)->CPRVCLI )
         aGet[14 ]:cText( (dbfPedCliT)->CPOSCLI )
         aGet[15 ]:cText( (dbfPedCliT)->CDNICLI )
         aGet[7 ]:cText( (dbfPedCliT)->CCODALM )
         aGet[100 ]:cText( (dbfPedCliT)->CTLFCLI )
         aGet[7 ]:lValid()

         aGet[8 ]:cText( ( dbfPedCliT )->cCodCaj )
         aGet[8 ]:lValid()

         aGet[32]:cText( ( dbfPedCliT )->cCodPgo )
            aGet[32]:lValid()

         aGet[19 ]:cText( ( dbfPedCliT )->cCodAge )
         aGet[19 ]:lValid()

         aGet[23]:cText( ( dbfPedCliT )->nPctComAge )

         aGet[21 ]:cText( ( dbfPedCliT )->cCodTar )
         aGet[21 ]:lValid()

         aGet[22 ]:cText( ( dbfPedCliT )->cCodObr )
         aGet[22 ]:lValid()

         aGet[18 ]:cText( ( dbfPedCliT )->nTarifa )

         aGet[72 ]:cText( ( dbfPedCliT )->cCodTrn )
         aGet[72 ]:lValid()

         aGet[58 ]:Click( ( dbfPedCliT )->lIvaInc )
         aGet[56]:Click( ( dbfPedCliT )->lRecargo )
         aGet[117 ]:Click( ( dbfPedCliT )->lOperPv )

         aTmp[82]          := ( dbfPedCliT )->cCodGrp
         aTmp[16]          := ( dbfPedCliT )->lModCli





         aGet[ 29]:cText( ( dbfPedCliT )->cCondEnt )
         aGet[ 30 ]:cText( ( dbfPedCliT )->mComent  )
         aGet[ 31 ]:cText( ( dbfPedCliT )->mObserv  )





         aGet[41]:cText( ( dbfPedCliT )->cDtoEsp )
         aGet[43   ]:cText( ( dbfPedCliT )->cDpp    )
         aGet[42]:cText( ( dbfPedCliT )->nDtoEsp )
         aGet[44   ]:cText( ( dbfPedCliT )->nDpp    )
         aGet[45]:cText( ( dbfPedCliT )->cDtoUno )
         aGet[46]:cText( ( dbfPedCliT )->nDtoUno )
         aGet[47]:cText( ( dbfPedCliT )->cDtoDos )
         aGet[48]:cText( ( dbfPedCliT )->nDtoDos )
         aGet[94]:cText( ( dbfPedCliT )->cManObr )
         aGet[35]:cText( ( dbfPedCliT )->nIvaMan )
         aGet[36]:cText( ( dbfPedCliT )->nManObr )
         aGet[33]:cText( ( dbfPedCliT )->nBultos )





         aTmp[ 91 ]      := ( dbfPedCliT )->lAlquiler
         aTmp[ 89  ]      := ( dbfPedCliT )->dFecEntr
         aTmp[ 90   ]      := ( dbfPedCliT )->dFecSal

         if !Empty( oTipFac )
            if ( dbfPedCliT )->lAlquiler
               oTipFac:Select( 2 )
            else
               oTipFac:Select( 1 )
            end
         end





         if ( dbfPedCliL )->( dbSeek( cPedido ) )

            (dbfTmpLin)->( dbAppend() )
            cDesAlb                    := ""
            cDesAlb                    += "Pedido Nº " + ( dbfPedCliT )->cSerPed + "/" + AllTrim( Str( ( dbfPedCliT )->NNUMPED ) ) + "/" + ( dbfPedCliT )->CSUFPED
            cDesAlb                    += " - Fecha " + Dtoc( (dbfPedCliT)->DFECPED )
            (dbfTmpLin)->MLNGDES       := cDesAlb
            (dbfTmpLin)->LCONTROL      := .T.

            while ( ( dbfPedCliL )->cSerPed + Str( ( dbfPedCliL )->nNumPed ) + ( dbfPedCliL )->cSufPed == cPedido )

               nTotRet                 := ( dbfPedCliL )->nUniCaja
               nTotRet                 -= nUnidadesRecibidasAlbCli( cPedido, ( dbfPedCliL )->cRef, ( dbfPedCliL )->cCodPr1, ( dbfPedCliL )->cCodPr2, ( dbfPedCliL )->cRefPrv, ( dbfPedCliL )->cDetalle, dbfAlbCliL )
               nTotRet                 -= nUnidadesRecibidasFacCli( cPedido, ( dbfPedCliL )->cRef, ( dbfPedCliL )->cCodPr1, ( dbfPedCliL )->cCodPr2, dbfFacCliL )

               (dbfTmpLin)->( dbAppend() )

               (dbfTmpLin)->nNumLin    := (dbfPedCliL)->nNumLin
               (dbfTmpLin)->cRef       := (dbfPedCliL)->cRef
               (dbfTmpLin)->cDetalle   := (dbfPedCliL)->cDetalle
               (dbfTmpLin)->mLngDes    := (dbfPedCliL)->mLngDes
               (dbfTmpLin)->mNumSer    := (dbfPedCliL)->mNumSer
               (dbfTmpLin)->nPreUnit   := (dbfPedCliL)->nPreDiv
               (dbfTmpLin)->nPntVer    := (dbfPedCliL)->nPntVer
               (dbfTmpLin)->nImpTrn    := (dbfPedCliL)->nImpTrn
               (dbfTmpLin)->nPESOKG    := (dbfPedCliL)->nPesOkg
               (dbfTmpLin)->cPESOKG    := (dbfPedCliL)->cPesOkg
               (dbfTmpLin)->cUnidad    := (dbfPedCliL)->cUnidad
               (dbfTmpLin)->nVolumen   := (dbfPedCliL)->nVolumen
               (dbfTmpLin)->cVolumen   := (dbfPedCliL)->cVolumen
               (dbfTmpLin)->nIVA       := (dbfPedCliL)->nIva
               (dbfTmpLin)->nReq       := (dbfPedCliL)->nReq
               (dbfTmpLin)->cUNIDAD    := (dbfPedCliL)->cUnidad
               (dbfTmpLin)->nDTO       := (dbfPedCliL)->nDto
               (dbfTmpLin)->nDTOPRM    := (dbfPedCliL)->nDtoPrm
               (dbfTmpLin)->nCOMAGE    := (dbfPedCliL)->nComAge
               (dbfTmpLin)->lTOTLIN    := (dbfPedCliL)->lTotLin
               (dbfTmpLin)->nDtoDiv    := (dbfPedCliL)->nDtoDiv
               (dbfTmpLin)->nCtlStk    := (dbfPedCliL)->nCtlStk
               (dbfTmpLin)->nCosDiv    := (dbfPedCliL)->nCosDiv
               (dbfTmpLin)->nPvpRec    := (dbfPedCliL)->nPvpRec
               (dbfTmpLin)->cTipMov    := (dbfPedCliL)->cTipMov
               (dbfTmpLin)->cAlmLin    := (dbfPedCliL)->cAlmLin
               (dbfTmpLin)->cCodImp    := (dbfPedCLiL)->cCodImp
               (dbfTmpLin)->nValImp    := (dbfPedCliL)->nValImp
               (dbfTmpLin)->CCODPR1    := (dbfPedCliL)->cCodPr1
               (dbfTmpLin)->CCODPR2    := (dbfPedCliL)->cCodPr2
               (dbfTmpLin)->CVALPR1    := (dbfPedCliL)->cValPr1
               (dbfTmpLin)->CVALPR2    := (dbfPedCliL)->cValPr2
               (dbfTmpLin)->lKitArt    := (dbfAlbCliL)->lKitArt
               (dbfTmpLin)->lKitChl    := (dbfPedCliL)->lKitChl
               (dbfTmpLin)->lKitPrc    := (dbfPedCliL)->lKitPrc
               (dbfTmpLin)->nMesGrt    := (dbfPedCliL)->nMesGrt
               (dbfTmpLin)->lLote      := (dbfPedCliL)->lLote
               (dbfTmpLin)->nLote      := (dbfPedCliL)->nLote
               (dbfTmpLin)->cLote      := (dbfPedCliL)->cLote
               (dbfTmpLin)->lMsgVta    := (dbfPedCliL)->lMsgVta
               (dbfTmpLin)->lNotVta    := (dbfPedCliL)->lNotVta
               (dbfTmpLin)->lImpLin    := (dbfPedCliL)->lImpLin
               (dbfTmpLin)->cCodTip    := (dbfPedCliL)->cCodTip
               (dbfTmpLin)->mObsLin    := (dbfPedCliL)->mObsLin
               (dbfTmpLin)->Descrip    := (dbfPedCliL)->Descrip
               (dbfTmpLin)->cCodPrv    := (dbfPedCliL)->cCodPrv
               (dbfTmpLin)->cNomPrv    := (dbfPedCliL)->cNomPrv
               (dbfTmpLin)->cImagen    := (dbfPedCliL)->cImagen
               (dbfTmpLin)->cCodFam    := (dbfPedCliL)->cCodFam
               (dbfTmpLin)->cGrpFam    := (dbfPedCliL)->cGrpFam
               (dbfTmpLin)->cRefPrv    := (dbfPedCliL)->cRefPrv
               (dbfTmpLin)->dFecEnt    := (dbfPedCliL)->dFecEnt
               (dbfTmpLin)->dFecSal    := (dbfPedCliL)->dFecSal
               (dbfTmpLin)->nPreAlq    := (dbfPedCliL)->nPreAlq
               (dbfTmpLin)->lAlquiler  := (dbfPedCliL)->lAlquiler
               (dbfTmpLin)->nNumMed    := (dbfPedCliL)->nNumMed
               (dbfTmpLin)->nMedUno    := (dbfPedCliL)->nMedUno
               (dbfTmpLin)->nMedDos    := (dbfPedCliL)->nMedDos
               (dbfTmpLin)->nMedTre    := (dbfPedCliL)->nMedTre
               (dbfTmpLin)->nPuntos    := (dbfPedCliL)->nPuntos
               (dbfTmpLin)->nValPnt    := (dbfPedCliL)->nValPnt
               (dbfTmpLin)->nDtoPnt    := (dbfPedCliL)->nDtoPnt
               (dbfTmpLin)->nIncPnt    := (dbfPedCliL)->nIncPnt
               (dbfTmpLin)->lControl   := (dbfPedCliL)->lControl
               (dbfTmpLin)->cNumPed    := cPedido
               (dbfTmpLin)->lLinOfe    := (dbfPedCliL)->lLinOfe





               if nTotRet <> 0





                  if lCalCaj()

                     nDiv  := Mod( nTotRet, ( dbfPedCliL )->nUniCaja )
                     if nDiv == 0 .AND. ( dbfPedCliL )->nCanPed <> 0
                        ( dbfTmpLin )->nCanEnt  := ( dbfPedCliL )->nCanPed
                        ( dbfTmpLin )->nUniCaja := ( dbfPedCliL )->nUniCaja
                     else
                        ( dbfTmpLin )->nCanEnt  := 0
                        ( dbfTmpLin )->nUniCaja := nTotRet
                     end

                  else

                     ( dbfTmpLin )->nUniCaja    := nTotRet

                  end

               end

               (dbfPedCliL)->( dbSkip( 1 ) )

            end

            ( dbfTmpLin )->( dbGoTop() )


            if uFieldEmpresa( "lGrpEnt" )





                if ( dbfPedCliP )->( dbSeek( cPedido ) )

                  while ( dbfPedCliP )->cSerPed + Str( ( dbfPedCliP )->nNumPed ) + ( dbfPedCliP )->cSufPed == cPedido .AND. !( dbfPedCliP )->( Eof() )

                     nTotEntPed     += ( dbfPedCliP )->nImporte

                     ( dbfPedCliP )->( dbSkip() )

                  end

               end

               ( dbfPedCliP )->( dbGoTop() )





               if nTotEntPed <> 0

                  ( dbfTmpPgo )->( dbAppend() )

                  ( dbfTmpPgo )->lCobrado := .T.
                  ( dbfTmpPgo )->lConPgo  := .F.
                  ( dbfTmpPgo )->lRecImp  := .F.
                  ( dbfTmpPgo )->lRecDto  := .F.
                  ( dbfTmpPgo )->nNumRec  := ( dbfTmpPgo )->( RecNo() )
                  ( dbfTmpPgo )->cCodCaj  := ( dbfPedCliT )->cCodCaj
                  ( dbfTmpPgo )->cCodCli  := ( dbfPedCliT )->cCodCli
                  ( dbfTmpPgo )->cNomCli  := ( dbfPedCliT )->cNomCli
                  ( dbfTmpPgo )->dEntrada := ( dbfPedCliT )->dFecPed
                  ( dbfTmpPgo )->dPreCob  := ( dbfPedCliT )->dFecPed
                  ( dbfTmpPgo )->dFecVto  := ( dbfPedCliT )->dFecPed
                  ( dbfTmpPgo )->nImporte := nTotEntPed
                  ( dbfTmpPgo )->nImpCob  := nTotEntPed
                  ( dbfTmpPgo )->cDivPgo  := ( dbfPedCliT )->cDivPed
                  ( dbfTmpPgo )->nVdvPgo  := ( dbfPedCliT )->nVdvPed
                  ( dbfTmpPgo )->cCodAge  := ( dbfPedCliT )->cCodAge
                  ( dbfTmpPgo )->cTurRec  := ( dbfPedCliT )->cTurPed
                  ( dbfTmpPgo )->lCloPgo  := .T.
                  ( dbfTmpPgo )->cCodPgo  := ( dbfPedCliT )->cCodPgo
                  ( dbfTmpPgo )->cDescrip := "Suma entregas a cuenta pedido: " + ( dbfPedCliT )->cSerPed + "/" + AllTrim( Str( ( dbfPedCliT )->nNumPed ) ) + "/" + ( dbfPedCliT )->cSufPed
                  ( dbfTmpPgo )->( dbUnLock() )

               end

            else





               if ( dbfPedCliP )->( dbSeek( cPedido ) )

                  while ( dbfPedCliP )->cSerPed + Str( ( dbfPedCliP )->nNumPed ) + ( dbfPedCliP )->cSufPed == cPedido .AND. !( dbfPedCliP )->( Eof() )

                     ( dbfTmpPgo )->( dbAppend() )

                     ( dbfTmpPgo )->nNumRec  := ( dbfTmpPgo )->( RecNo() )
                     ( dbfTmpPgo )->cCodCaj  := ( dbfPedCliP )->cCodCaj
                     ( dbfTmpPgo )->cTurRec  := ( dbfPedCliP )->cTurRec
                     ( dbfTmpPgo )->cCodCli  := ( dbfPedCliP )->cCodCli
                     ( dbfTmpPgo )->dEntrada := ( dbfPedCliP )->dEntrega
                     ( dbfTmpPgo )->dPreCob  := ( dbfPedCliP )->dEntrega
                     ( dbfTmpPgo )->dFecVto  := ( dbfPedCliP )->dEntrega
                     ( dbfTmpPgo )->nImporte := ( dbfPedCliP )->nImporte
                     ( dbfTmpPgo )->nImpCob  := ( dbfPedCliP )->nImporte
                     if !Empty( ( dbfPedCliP )->cDescrip )
                     ( dbfTmpPgo )->cDescrip := ( dbfPedCliP )->cDescrip
                     else
                     ( dbfTmpPgo )->cDescrip := "Entrega nº " + AllTrim( Str( ( dbfTmpPgo )->( RecNo() ) ) ) + " pedido " + ( dbfPedCliP )->cSerPed + "/" + AllTrim( Str( ( dbfPedCliP )->nNumPed ) ) + "/" + ( dbfPedCliP )->cSufPed
                     end
                     ( dbfTmpPgo )->cPgdoPor := ( dbfPedCliP )->cPgdoPor
                     ( dbfTmpPgo )->cDocPgo  := ( dbfPedCliP )->cDocPgo
                     ( dbfTmpPgo )->cDivPgo  := ( dbfPedCliP )->cDivPgo
                     ( dbfTmpPgo )->nVdvPgo  := ( dbfPedCliP )->nVdvPgo
                     ( dbfTmpPgo )->cCodAge  := ( dbfPedCliP )->cCodAge
                     ( dbfTmpPgo )->cBncEmp  := ( dbfPedCliP )->cBncEmp
                     ( dbfTmpPgo )->cBncCli  := ( dbfPedCliP )->cBncCli
                     ( dbfTmpPgo )->cEntEmp  := ( dbfPedCliP )->cEntEmp
                     ( dbfTmpPgo )->cSucEmp  := ( dbfPedCliP )->cSucEmp
                     ( dbfTmpPgo )->cDigEmp  := ( dbfPedCliP )->cDigEmp
                     ( dbfTmpPgo )->cCtaEmp  := ( dbfPedCliP )->cCtaEmp
                     ( dbfTmpPgo )->cEntCli  := ( dbfPedCliP )->cEntCli
                     ( dbfTmpPgo )->cSucCli  := ( dbfPedCliP )->cSucCli
                     ( dbfTmpPgo )->cDigCli  := ( dbfPedCliP )->cDigCli
                     ( dbfTmpPgo )->cCtaCli  := ( dbfPedCliP )->cCtaCli
                     ( dbfTmpPgo )->lCobrado := .T.
                     ( dbfTmpPgo )->lConPgo  := .F.
                     ( dbfTmpPgo )->lRecImp  := .F.
                     ( dbfTmpPgo )->lRecDto  := .F.

                     ( dbfPedCliP )->( dbSkip() )

                  end

               end

            end





            if ( dbfPedCliI )->( dbSeek( cPedido ) )

               while ( dbfPedCliI )->cSerPed + Str( ( dbfPedCliI )->nNumPed ) + ( dbfPedCliI )->cSufPed == cPedido .AND. !( dbfPedCliI )->( Eof() )
                  dbPass( dbfPedCliI, dbfTmpInc, .T. )
                  ( dbfPedCliI )->( dbSkip() )
               end

            end

            ( dbfPedCliI )->( dbGoTop() )





            if ( dbfPedCliD )->( dbSeek( cPedido ) )

               while ( dbfPedCliD )->cSerPed + Str( ( dbfPedCliD )->nNumPed ) + ( dbfPedCliD )->cSufPed == cPedido .AND. !( dbfPedCliD )->( Eof() )
                  dbPass( dbfPedCliD, dbfTmpDoc, .T. )
                  ( dbfPedCliD )->( dbSkip() )
               end

            end

            ( dbfPedCliD )->( dbGoTop() )

            oBrwLin:Refresh()
            oBrwPgo:Refresh()

            oBrwLin:SetFocus()

         end

         lValid   := .T.

         CursorWE()

      end

      aGet[ 37 ]:Hide()
      aGet[ 38 ]:Show()
      aGet[ 39 ]:Hide()

      oBtnPre:Disable()
      oBtnPed:Disable()
      oBtnAlb:Disable()

      oBtnGrp:bWhen  := {|| .F. }

   else

        MsgStop( "Pedido no existe" )

   end

RETURN lValid






STATIC FUNCTION cPreCli( aGet, aTmp, oBrw, nMode )

   local cDesAlb
   local cPedido  := aGet[ 39 ]:VarGet()
   local lValid   := .F.

   if nMode <> 1 .OR. Empty( cPedido )
      return .T.
   end

   if dbSeekInOrd( cPedido, "nNumPre", dbfPreCliT )

      if ( dbfPreCliT )->lEstado

         MsgStop( "Presupuesto ya aprobado" )
         lValid   := .F.

      else

         aGet[6 ]:cText( ( dbfPreCliT )->CCODCLI )
         aGet[6 ]:lValid()
         aGet[6 ]:Disable()

         aGet[9 ]:cText( ( dbfPreCliT )->CNOMCLI )
         aGet[10 ]:cText( ( dbfPreCliT )->CDIRCLI )
         aGet[11 ]:cText( ( dbfPreCliT )->CPOBCLI )
         aGet[12 ]:cText( ( dbfPreCliT )->CPRVCLI )
         aGet[14 ]:cText( ( dbfPreCliT )->CPOSCLI )
         aGet[15 ]:cText( ( dbfPreCliT )->CDNICLI )
         aGet[100 ]:cText( ( dbfPreCliT )->CTLFCLI )

         aGet[7 ]:cText( ( dbfPreCliT )->CCODALM )
         aGet[7 ]:lValid()

         aGet[8 ]:cText( ( dbfPreCliT )->cCodCaj )
         aGet[8 ]:lValid()

         aGet[32]:cText( ( dbfPreCliT )->CCODPGO )
            aGet[32]:lValid()

         aGet[19 ]:cText( ( dbfPreCliT )->CCODAGE )
         aGet[19 ]:lValid()

         aGet[23]:cText( ( dbfPreCliT )->nPctComAge )

         aGet[21 ]:cText( ( dbfPreCliT )->CCODTAR )
         aGet[21 ]:lValid()

         aGet[22 ]:cText( ( dbfPreCliT )->CCODOBR )
         aGet[22 ]:lValid()

         aGet[18 ]:cText( ( dbfPreCliT )->nTarifa )

         aGet[72 ]:cText( ( dbfPreCliT )->cCodTrn )
         aGet[72 ]:lValid()

         aGet[58 ]:Click( ( dbfPreCliT )->lIvaInc )
         aGet[56]:Click( ( dbfPreCliT )->lRecargo )
         aGet[117 ]:Click( ( dbfPreCliT )->lOperPv )

         aGet[29]:cText( ( dbfPreCliT )->cCondEnt )
         aGet[30 ]:cText( ( dbfPreCliT )->mComent )
         aGet[31 ]:cText( ( dbfPreCliT )->mObserv )

         aGet[41 ]:cText( ( dbfPreCliT )->cDtoEsp )
         aGet[43    ]:cText( ( dbfPreCliT )->cDpp    )
         aGet[42 ]:cText( ( dbfPreCliT )->nDtoEsp )
         aGet[44    ]:cText( ( dbfPreCliT )->nDpp    )
         aGet[45 ]:cText( ( dbfPreCliT )->cDtoUno )
         aGet[46 ]:cText( ( dbfPreCliT )->nDtoUno )
         aGet[47 ]:cText( ( dbfPreCliT )->cDtoDos )
         aGet[48 ]:cText( ( dbfPreCliT )->nDtoDos )
         aGet[94 ]:cText( ( dbfPreCliT )->cManObr )
         aGet[35 ]:cText( ( dbfPreCliT )->nIvaMan )
         aGet[36 ]:cText( ( dbfPreCliT )->nManObr )
         aGet[33 ]:cText( ( dbfPreCliT )->nBultos )

         aTmp[82]          := ( dbfPreCliT )->cCodGrp
         aTmp[16]          := ( dbfPreCliT )->lModCli





         aTmp[ 91 ]      := ( dbfPreCliT )->lAlquiler
         aTmp[ 89  ]      := ( dbfPreCliT )->dFecEntr
         aTmp[ 90   ]      := ( dbfPreCliT )->dFecSal

         if !Empty( oTipFac )
            if aTmp[ 91 ]
               oTipFac:Select( 2 )
            else
               oTipFac:Select( 1 )
            end
         end

         if (dbfPreCliL)->( dbSeek( cPedido ) )

            (dbfTmpLin)->( dbAppend() )
            cDesAlb              := ""
            cDesAlb              += "Presupuesto Nº " + ( dbfPreCliT )->cSerPre + "/" + AllTrim( Str( ( dbfPreCliT )->nNumPre ) ) + "/" + ( dbfPreCliT )->cSufPre
            cDesAlb              += " - Fecha " + Dtoc( ( dbfPreCliT )->dFecPre )
            (dbfTmpLin)->MLNGDES    := cDesAlb
            (dbfTmpLin)->LCONTROL   := .T.

            while ( (dbfPreCliL)->cSerPre + Str( (dbfPreCliL)->nNumPre ) + (dbfPreCliL)->cSufPre == cPedido )

               (dbfTmpLin)->( dbAppend() )

               (dbfTmpLin)->nNumLin    := (dbfPreCliL)->nNumLin
               (dbfTmpLin)->cRef       := (dbfPreCliL)->cRef
               (dbfTmpLin)->cDetalle   := (dbfPreCliL)->cDetAlle
               (dbfTmpLin)->mLngDes    := (dbfPreCliL)->mLngDes
               (dbfTmpLin)->mNumSer    := (dbfPreCliL)->mNumSer
               (dbfTmpLin)->nPreUnit   := (dbfPreCliL)->nPreDiv
               (dbfTmpLin)->nPntVer    := (dbfPreCliL)->nPntVer
               (dbfTmpLin)->nImpTrn    := (dbfPreCliL)->nImpTrn
               (dbfTmpLin)->nPESOKG    := (dbfPreCliL)->nPesOkg
               (dbfTmpLin)->cPESOKG    := (dbfPreCliL)->cPesOkg
               (dbfTmpLin)->cUnidad    := (dbfPreCliL)->cUnidad
               (dbfTmpLin)->nVolumen   := (dbfPreCliL)->nVolumen
               (dbfTmpLin)->cVolumen   := (dbfPreCliL)->cVolumen
               (dbfTmpLin)->nIVA       := (dbfPreCliL)->nIva
               (dbfTmpLin)->nReq       := (dbfPreCliL)->nReq
               (dbfTmpLin)->cUNIDAD    := (dbfPreCliL)->cUnidad
               (dbfTmpLin)->nDTO       := (dbfPreCliL)->nDto
               (dbfTmpLin)->nDTOPRM    := (dbfPreCliL)->nDtoPrm
               (dbfTmpLin)->nCOMAGE    := (dbfPreCliL)->nComAge
               (dbfTmpLin)->lTOTLIN    := (dbfPreCliL)->lTotLin
               (dbfTmpLin)->nDtoDiv    := (dbfPreCliL)->nDtoDiv
               (dbfTmpLin)->nCtlStk    := (dbfPreCliL)->nCtlStk
               (dbfTmpLin)->nCosDiv    := (dbfPreCliL)->nCosDiv
               (dbfTmpLin)->nPvpRec    := (dbfPreCliL)->nPvpRec
               (dbfTmpLin)->cTipMov    := (dbfPreCliL)->cTipMov
               (dbfTmpLin)->cAlmLin    := (dbfPreCliL)->cAlmLin
               (dbfTmpLin)->cCodImp    := (dbfPedCLiL)->cCodImp
               (dbfTmpLin)->nValImp    := (dbfPreCliL)->nValImp
               (dbfTmpLin)->CCODPR1    := (dbfPreCliL)->cCodPr1
               (dbfTmpLin)->CCODPR2    := (dbfPreCliL)->cCodPr2
               (dbfTmpLin)->CVALPR1    := (dbfPreCliL)->cValPr1
               (dbfTmpLin)->CVALPR2    := (dbfPreCliL)->cValPr2
               (dbfTmpLin)->nCanEnt    := (dbfPreCLiL)->nCanPre
               (dbfTmpLin)->nUniCaja   := (dbfPreCLiL)->nUniCaja
               (dbfTmpLin)->nUndKit    := (dbfPreCLiL)->nUndKit
               (dbfTmpLin)->lKitArt    := (dbfPreCLiL)->lKitArt
               (dbfTmpLin)->lKitChl    := (dbfPreCLiL)->lKitChl
               (dbfTmpLin)->lKitPrc    := (dbfPreCliL)->lKitPrc
               (dbfTmpLin)->nMesGrt    := (dbfPreCLiL)->nMesGrt
               (dbfTmpLin)->lLote      := (dbfPreCliL)->lLote
               (dbfTmpLin)->nLote      := (dbfPreCliL)->nLote
               (dbfTmpLin)->cLote      := (dbfPreCliL)->cLote
               (dbfTmpLin)->lMsgVta    := (dbfPreCliL)->lMsgVta
               (dbfTmpLin)->lNotVta    := (dbfPreCliL)->lNotVta
               (dbfTmpLin)->lImpLin    := (dbfPreCliL)->lImpLin
               (dbfTmpLin)->cCodTip    := (dbfPreCliL)->cCodTip
               (dbfTmpLin)->mObsLin    := (dbfPreCliL)->mObsLin
               (dbfTmpLin)->Descrip    := (dbfPedCliL)->Descrip
               (dbfTmpLin)->cCodPrv    := (dbfPreCliL)->cCodPrv
               (dbfTmpLin)->cNomPrv    := (dbfPreCliL)->cNomPrv
               (dbfTmpLin)->cImagen    := (dbfPreCliL)->cImagen
               (dbfTmpLin)->cCodFam    := (dbfPreCliL)->cCodFam
               (dbfTmpLin)->cGrpFam    := (dbfPreCliL)->cGrpFam
               (dbfTmpLin)->cRefPrv    := (dbfPreCliL)->cRefPrv
               (dbfTmpLin)->dFecEnt    := (dbfPreCliL)->dFecEnt
               (dbfTmpLin)->dFecSal    := (dbfPreCliL)->dFecSal
               (dbfTmpLin)->nPreAlq    := (dbfPreCliL)->nPreAlq
               (dbfTmpLin)->lAlquiler  := (dbfPreCliL)->lAlquiler
               (dbfTmpLin)->nNumMed    := (dbfPreCliL)->nNumMed
               (dbfTmpLin)->nMedUno    := (dbfPreCliL)->nMedUno
               (dbfTmpLin)->nMedDos    := (dbfPreCliL)->nMedDos
               (dbfTmpLin)->nMedTre    := (dbfPreCliL)->nMedTre
               (dbfTmpLin)->nPuntos    := (dbfPreCliL)->nPuntos
               (dbfTmpLin)->nValPnt    := (dbfPreCliL)->nValPnt
               (dbfTmpLin)->nDtoPnt    := (dbfPreCliL)->nDtoPnt
               (dbfTmpLin)->nIncPnt    := (dbfPreCliL)->nIncPnt
               (dbfTmpLin)->lControl   := (dbfPreCliL)->lControl
               (dbfTmpLin)->lLinOfe   := (dbfPreCliL)->lLinOfe

               (dbfPreCliL)->( dbSkip() )

            end

            ( dbfTmpLin )->( dbGoTop() )



            if ( dbfPreCliI )->( dbSeek( cPedido ) )

               while ( dbfPreCliI )->cSerPre + Str( ( dbfPreCliI )->nNumPre ) + ( dbfPreCliI )->cSufPre == cPedido .AND. !( dbfPreCliI )->( Eof() )
                  dbPass( dbfPreCliI, dbfTmpInc, .T. )
                  ( dbfPreCliI )->( dbSkip() )
               end

            end

            ( dbfPreCliI )->( dbGoTop() )



            if ( dbfPreCliD )->( dbSeek( cPedido ) )

               while ( dbfPreCliD )->cSerPre + Str( ( dbfPreCliD )->nNumPre ) + ( dbfPreCliD )->cSufPre == cPedido .AND. !( dbfPreCliD )->( Eof() )
                  dbPass( dbfPreCliD, dbfTmpDoc, .T. )
                  ( dbfPreCliD )->( dbSkip() )
               end

            end

            ( dbfPreCliD )->( dbGoTop() )

            oBrw:refresh()
            oBrw:setFocus()

         end

            lValid    := .T.

         if ( dbfPreCliT )->( dbRLock() )
            ( dbfPreCliT )->lEstado := .T.
            ( dbfPreCliT )->( DbUnlock() )
         end

      end

      aGet[ 37 ]:Hide()
      aGet[ 38 ]:Hide()
      aGet[ 39 ]:Show()

      oBtnPre:Disable()
      oBtnPed:Disable()
      oBtnAlb:Disable()
      oBtnGrp:bWhen  := {|| .F. }

    ELSE

      MsgStop( "Presupuesto no existe" )

    end

RETURN lValid



STATIC FUNCTION DelSerie( oWndBrw )

    local oDlg
   local oSerIni
   local oSerFin
   local oTxtDel
   local nTxtDel     := 0
   local nRecno      := ( dbfFacCliT )->( Recno() )
   local nOrdAnt     := ( dbfFacCliT )->( OrdSetFocus( 1 ) )
   local oDesde      := TDesdeHasta():Init( ( dbfFacCliT )->cSerie, ( dbfFacCliT )->nNumFac, ( dbfFacCliT )->cSufFac, GetSysDate() )
   local lCancel     := .F.
   local oBtnAceptar
   local oBtnCancel




   oDlg = TDialog():New(,,,, "Eliminar series de facturas", "DELSERDOC",, .F.,,,,, oWndBrw, .F.,,,,,, .F., )



   TRadMenu():Redefine( { | u | If( PCount()==0, oDesde:nRadio, oDesde:nRadio:= u ) }, oDlg,, { 90, 91 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, oDesde:cSerieInicio, oDesde:cSerieInicio:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieInicio >= "A" .AND. oDesde:cSerieInicio <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, oDesde:cSerieFin, oDesde:cSerieFin:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieFin >= "A" .AND. oDesde:cSerieFin <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, oDesde:nNumeroInicio, oDesde:nNumeroInicio:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, oDesde:nNumeroFin, oDesde:nNumeroFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, oDesde:cSufijoInicio, oDesde:cSufijoInicio:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, oDesde:cSufijoFin, oDesde:cSufijoFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 170, { | u | If( PCount()==0, oDesde:dFechaInicio, oDesde:dFechaInicio:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 180, { | u | If( PCount()==0, oDesde:dFechaFin, oDesde:dFechaFin:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )




   oBtnAceptar := TButton():ReDefine( 1, {||( DelStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDel, @lCancel ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( lCancel := .T., oDlg:end() )}, oDlg,,, .F.,,,, .T. )





   oTxtDel := TMeter():ReDefine( 160, { | u | If( PCount()==0, nTxtDel, nTxtDel:= u ) }, ( dbfFacCliT )->( OrdKeyCount() ), oDlg, .F.,,, .T.,,,, )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T., {|Self|( lCancel )},,, oDlg:bRClicked,,, )

   ( dbfFacCliT )->( dbGoTo( nRecNo ) )
   ( dbfFacCliT )->( ordSetFocus( nOrdAnt ) )

   oWndBrw:SetFocus()
   oWndBrw:Refresh()

RETURN NIL



STATIC FUNCTION DelStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDel, lCancel )

   local nOrd
   local nDeleted       := 0
   local nProcesed      := 0

   oBtnAceptar:Hide()
   oBtnCancel:bAction   := {|| lCancel := .T. }

   if oDesde:nRadio == 1

      nOrd              := ( dbfFacCliT )->( OrdSetFocus( "nNumFac" ) )

      ( dbfFacCliT )->( dbSeek( oDesde:cNumeroInicio(), .T. ) )
      while !lCancel .AND. ( dbfFacCliT )->( !eof() )






         if ( dbfFacCliT )->cSerie  >= oDesde:cSerieInicio  .AND. ( dbfFacCliT )->cSerie  <= oDesde:cSerieFin     .AND. ( dbfFacCliT )->nNumFac >= oDesde:nNumeroInicio .AND. ( dbfFacCliT )->nNumFac <= oDesde:nNumeroFin    .AND. ( dbfFacCliT )->cSufFac >= oDesde:cSufijoInicio .AND. ( dbfFacCliT )->cSufFac <= oDesde:cSufijoFin

            ++nDeleted

            oTxtDel:cText  := "Eliminando : " + ( dbfFacCliT )->cSerie + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + ( dbfFacCliT )->cSufFac

            WinDelRec( nil, dbfFacCliT, {|| QuiFacCli() } )

         else

            ( dbfFacCliT )->( dbSkip() )

         end

         ++nProcesed

         oTxtDel:Set( nProcesed )

      end

      ( dbfFacCliT )->( OrdSetFocus( nOrd ) )

   else

      nOrd              := ( dbfFacCliT )->( OrdSetFocus( "dFecFac" ) )

      ( dbfFacCliT )->( dbSeek( oDesde:dFechaInicio, .T. ) )
      while !lCancel .AND. ( dbfFacCliT )->( !eof() )


         if ( dbfFacCliT )->dFecFac >= oDesde:dFechaInicio  .AND. ( dbfFacCliT )->dFecFac <= oDesde:dFechaFin

            ++nDeleted

            oTxtDel:cText  := "Eliminando : " + ( dbfFacCliT )->cSerie + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + ( dbfFacCliT )->cSufFac

            WinDelRec( nil, dbfFacCliT, {|| QuiFacCli() } )

         else

            ( dbfFacCliT )->( dbSkip() )

         end

         ++nProcesed

         oTxtDel:Set( nProcesed )

      end

      ( dbfFacCliT )->( OrdSetFocus( nOrd ) )

   end

   lCancel              := .T.

   oBtnAceptar:Show()

   if lCancel
      msgStop( "Total de registros borrados : " + Str( nDeleted ), "Proceso cancelado" )
   else
      msgInfo( "Total de registros borrados : " + Str( nDeleted ), "Proceso finalizado" )
   end

RETURN ( oDlg:End() )



static function RecFacCli( aTmpFac, lMessage )

   local nDtoAge     := 0
   local nImpAtp     := 0
   local nImpOfe     := 0
   local cCodFam
   local nRecno

   IIF( lMessage == nil, lMessage := .T., ) ;

   if lMessage




      if !ApoloMsgNoYes(  "¡Atención!,"                                      + Chr(13)+Chr(10) +  "todos los precios se recalcularán en función de"  + Chr(13)+Chr(10) +  "los valores en las bases de datos.", "¿ Desea proceder ?" )
         return nil

      end

   end

   nRecno         := ( dbfTmpLin )->( RecNo() )

   ( dbfTmpLin )->( dbGotop() )
   ( dbfArticulo )->( ordSetFocus( "Codigo" ) )

   while !( dbfTmpLin )->( eof() )





      if ( dbfArticulo )->( dbSeek( ( dbfTmpLin )->cRef ) )

         if aTmpFac[ 65 ] <= 1
            ( dbfTmpLin )->nIva     := nIva( dbfIva, ( dbfArticulo )->TipoIva )
            ( dbfTmpLin )->nReq     := nReq( dbfIva, ( dbfArticulo )->TipoIva )
         end





         if !Empty( ( dbfArticulo )->cCodImp )
            ( dbfTmpLin )->cCodImp  := ( dbfArticulo )->cCodImp
            ( dbfTmpLin )->nValImp  := oNewImp:nValImp( ( dbfArticulo )->cCodImp, aTmpFac[ 58 ], ( dbfTmpLin )->nIva )
         end





         ( dbfTmpLin )->nPreUnit := nRetPreArt( ( dbfTmpLin )->nTarLin, aTmpFac[ 60 ], aTmpFac[ 58 ], dbfArticulo, dbfDiv, dbfKit, dbfIva )





         ( dbfTmpLin )->nPntVer  := ( dbfArticulo )->nPntVer1





         ( dbfTmpLin )->nCtlStk  := (dbfArticulo)->nCtlStock
         ( dbfTmpLin )->nCosDiv  := nCosto( nil, dbfArticulo, dbfKit )
         ( dbfTmpLin )->nPvpRec  := (dbfArticulo)->PvpRec





         ( dbfTmpLin )->nComAge  := aTmpFac[ 23 ]





         cCodFam                 := ( dbfTmpLin )->cCodFam

         do case

         case lSeekAtpArt( aTmpFac[ 6 ] + ( dbfTmpLin )->cRef, ( dbfTmpLin )->cCodPr1 + ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1 + ( dbfTmpLin )->cValPr2, aTmpFac[ 5 ], dbfClientAtp ) .AND.  ( dbfClientAtp )->lAplFac

            nImpAtp  := nImpAtp( ( dbfTmpLin )->nTarLin, dbfClientAtp )
            if nImpAtp <> 0
               ( dbfTmpLin )->nPreUnit := nImpAtp
            end

            nImpAtp  := nDtoAtp( ( dbfTmpLin )->nTarLin, dbfClientAtp )
            if nImpAtp <> 0
               ( dbfTmpLin )->nDto     := nImpAtp
            end

            if ( dbfClientAtp )->nDprArt <> 0
               ( dbfTmpLin )->nDtoPrm  := ( dbfClientAtp )->nDprArt
            end

            if ( dbfClientAtp )->nComAge <> 0
               ( dbfTmpLin )->nComAge  := ( dbfClientAtp )->nComAge
            end

            if ( dbfClientAtp )->nDtoDiv <> 0
               ( dbfTmpLin )->nDtoDiv  := ( dbfClientAtp )->nDtoDiv
            end


         case lSeekAtpFam( aTmpFac[6] + cCodFam, aTmpFac[ 5 ], dbfClientAtp ) .AND.  ( dbfClientAtp )->lAplFac

            if ( dbfClientAtp )->nDtoArt <> 0
               ( dbfTmpLin )->nDto     := ( dbfClientAtp )->nDtoArt
            end

            if ( dbfClientAtp )->nDprArt <> 0
               ( dbfTmpLin )->nDtoPrm  := ( dbfClientAtp )->nDprArt
            end

            if ( dbfClientAtp )->nComAge <> 0
               ( dbfTmpLin )->nComAge  := ( dbfClientAtp )->nComAge
            end

            if ( dbfClientAtp )->nDtoDiv <> 0
               ( dbfTmpLin )->nDtoDiv  := ( dbfClientAtp )->nDtoDiv
            end





         case !Empty( aTmpFac[21] )

            nImpOfe     := RetPrcTar( ( dbfTmpLin )->cRef, aTmpFac[ 21 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL, ( dbfTmpLin )->nTarLin )
            if nImpOfe <> 0
               ( dbfTmpLin )->nPreUnit := nImpOfe
            end

            nImpOfe     := RetPctTar( ( dbfTmpLin )->cRef, cCodFam, aTmpFac[ 21 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL )
            if nImpOfe <> 0
               ( dbfTmpLin )->nDto     := nImpOfe
            end

            nImpOfe     := RetComTar( ( dbfTmpLin )->cRef, cCodFam, aTmpFac[ 21 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpFac[ 19 ], dbfTarPreL, dbfTarPreS )
            if nImpOfe  <> 0
               ( dbfTmpLin )->nComAge  := nImpOfe
            end






            nImpOfe     := RetDtoPrm( ( dbfTmpLin )->cRef, cCodFam, aTmpFac[ 21 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpFac[ 5 ], dbfTarPreL )
            if nImpOfe  <> 0
               ( dbfTmpLin )->nDtoPrm  := nImpOfe
            end





            nDtoAge     := RetDtoAge( ( dbfTmpLin )->cRef, cCodFam, aTmpFac[ 21 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpFac[ 5 ], aTmpFac[ 19 ], dbfTarPreL, dbfTarPreS )
            if nDtoAge  <> 0
               ( dbfTmpLin )->nComAge  := nDtoAge
            end

         end





         nImpOfe     := nImpOferta( ( dbfTmpLin )->cRef, aTmpFac[ 6 ], aTmpFac[ 82 ], ( dbfTmpLin )->nUniCaja, aTmpFac[ 5 ], dbfOferta, ( dbfTmpLin )->nTarLin, nil, ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2 )
         if nImpOfe  <> 0
            ( dbfTmpLin )->nPreUnit := nCnv2Div( nImpOfe, cDivEmp(), aTmpFac[ 60 ], dbfDiv )
         end





         nImpOfe     := nDtoOferta( ( dbfTmpLin )->cRef, aTmpFac[ 6 ], aTmpFac[ 82 ], ( dbfTmpLin )->nUniCaja, aTmpFac[ 5 ], dbfOferta, ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2 )
         if nImpOfe  <> 0
            ( dbfTmpLin )->nDtoPrm  := nImpOfe
         end

      end

      ( dbfTmpLin )->( dbSkip() )

   end

   ( dbfTmpLin )->( dbGoTo( nRecno ) )

return nil




















































FUNCTION EdmFacCli( cCodRut, cPathTo, oStru, aSucces )

   local n           := 0
   local cSerie
   local cFilEdm
   local oFilEdm
   local dFecFac
   local nDtoEsp     := 0
   local nDtoPp      := 0
   local nImpCob     := 0
   local cCodCli
   local cCodAge
   local cNumDoc
   local nNumDoc
   local nCanEnt     := 0
   local cTipDoc
   local aHeadLine   := {}
   local aLotes      := {}

   IIF( cCodRut == nil, cCodRut := "001", ) ;
   IIF( cPathTo == nil, cPathTo := "C:\INTERS~1\", ) ;





   cCodRut           := SubStr( cCodRut, -3 )

   cFilEdm           := cPathTo + "TALBA" + cCodRut + ".PSI"

   if !file( cFilEdm )
      msgWait( "No existe el fichero " + cFilEdm, "Atención", 1 )
      return nil
   end

   oFilEdm           := TTxtFile():New( cFilEdm )





   while ! oFilEdm:lEoF()

      cTipDoc        := SubStr( oFilEdm:cLine, 18,  1 )

      if ( cTipDoc == "1" .OR. cTipDoc == "2" )




         aAdd( aHeadLine, {   SubStr( oFilEdm:cLine, 8, 10 ), Ctod( SubStr( oFilEdm:cLine, 127, 10 ) ), Val( SubStr( oFilEdm:cLine, 93, 5 ) ), Val( SubStr( oFilEdm:cLine, 98, 5 ) ), Val( SubStr( oFilEdm:cLine,119, 8 ) ) } )
      end

      oFilEdm:Skip()

   end

   oFilEdm:Close()





   cFilEdm           := cPathTo + "LALBA" + cCodRut + ".PSI"

   if !file( cFilEdm )
      msgWait( "No existe el fichero " + cFilEdm, "Atención", 1 )
   else

      oFilEdm           := TTxtFile():New( cFilEdm )





      while ! oFilEdm:lEoF()

         cTipDoc        := SubStr( oFilEdm:cLine, 18,  1 )

         if ( cTipDoc == "1" .OR. cTipDoc == "2" )


            aAdd( aLotes, { SubStr( oFilEdm:cLine, 8, 10 ), LTrim( SubStr( oFilEdm:cLine, 19, 13 ) ), RTrim( SubStr( oFilEdm:cLine, 43, 21 ) ) } )
         end

         oFilEdm:Skip()

      end

      oFilEdm:Close()

   end






































   cFilEdm           := cPathTo + "EALBA" + cCodRut + ".PSI"





   if !file( cFilEdm )
      msgStop( cFilEdm, "No existe" )
      return nil
   end

   oFilEdm           := TTxtFile():New( cFilEdm )





   OpenFiles()

   oStru:oMetDos:cText   := "Fac. clientes"
   oStru:oMetDos:SetTotal( oFilEdm:nTLines )





   while !oFilEdm:lEoF()





      cCodCli        := SubStr( oFilEdm:cLine,  1,  7 )
      cCodAge        := SubStr( oFilEdm:cLine,  8,  3 )
      cNumDoc        := SubStr( oFilEdm:cLine,  8, 10 )
      nNumDoc        := Val( StrTran( cNumDoc, "/", "" ) )
      cTipDoc        := SubStr( oFilEdm:cLine, 18,  1 )

      if ( cTipDoc == "1" .OR. cTipDoc == "2" )

         if dbSeekInOrd( cCodCli, "Cod", dbfClient )

            if Empty( ( dbfClient )->Serie )
               cSerie                        := "A"
            else
               cSerie                        := ( dbfClient )->Serie
            end

            if !( dbfFacCliT )->( dbSeek( cSerie + Str( nNumDoc, 9 ) + RetSufEmp() ) )

               n     := aScan( aHeadLine, {|a| a[1] == cNumDoc } )
               if n  <> 0

                  dFecFac                    := aHeadLine[n,2]
                  nDtoEsp                    := aHeadLine[n,3]
                  nDtoPp                     := aHeadLine[n,4]
                  nImpCob                    := aHeadLine[n,5]

                  ( dbfFacCliT )->( dbAppend() )
                  ( dbfFacCliT )->cSerie     := cSerie
                  ( dbfFacCliT )->nNumFac    := nNumDoc
                  ( dbfFacCliT )->cSufFac    := RetSufEmp()
                  ( dbfFacCliT )->cDocOrg    := cNumDoc
                  ( dbfFacCliT )->dFecFac    := dFecFac
                  ( dbfFacCliT )->cCodAlm    := oUser():cAlmacen()
                  ( dbfFacCliT )->cCodCaj    := oUser():cCaja()
                  ( dbfFacCliT )->cDivFac    := cDivEmp()
                  ( dbfFacCliT )->nVdvFac    := nChgDiv( ( dbfFacCliT )->cDivFac, dbfDiv )
                  ( dbfFacCliT )->cCodCli    := ( dbfClient )->Cod
                  ( dbfFacCliT )->cNomCli    := ( dbfClient )->Titulo
                  ( dbfFacCliT )->cDirCli    := ( dbfClient )->Domicilio
                  ( dbfFacCliT )->cPobCli    := ( dbfClient )->Poblacion
                  ( dbfFacCliT )->cPrvCli    := ( dbfClient )->Provincia
                  ( dbfFacCliT )->cPosCli    := ( dbfClient )->CodPostal
                  ( dbfFacCliT )->cDniCli    := ( dbfClient )->Nif
                  ( dbfFacCliT )->cCodTar    := ( dbfClient )->cCodTar
                  ( dbfFacCliT )->cCodPago   := if( Empty( ( dbfClient )->CodPago ), oStru:cCodPgo, ( dbfClient )->CodPago )
                  ( dbfFacCliT )->cCodAge    := cCodAge
                  ( dbfFacCliT )->cCodRut    := ( dbfClient )->cCodRut
                  ( dbfFacCliT )->nTarifa    := ( dbfClient )->nTarifa
                  ( dbfFacCliT )->lRecargo   := ( dbfClient )->lReq
                  ( dbfFacCliT )->lOperPv    := ( dbfClient )->lPntVer
                  ( dbfFacCliT )->nDtoEsp    := nDtoEsp
                  ( dbfFacCliT )->nDpp       := nDtoPp
                  ( dbfFacCliT )->( dbUnLock() )

                  aAdd( aSucces, { .T., "Nueva factura de clientes " + ( dbfFacCliT )->cSerie + "/" + Str( ( dbfFacCliT )->nNumFac ) + "/" + ( dbfFacCliT )->cSufFac } )





                  if nImpCob <> 0

                     ( dbfFacCliP )->( dbAppend() )
                     ( dbfFacCliP )->cSerie     := cSerie
                     ( dbfFacCliP )->nNumFac    := nNumDoc
                     ( dbfFacCliP )->cSufFac    := RetSufEmp()
                     ( dbfFacCliP )->nNumRec    := 1
                     ( dbfFacCliP )->cCodCli    := cCodCli
                     ( dbfFacCliP )->cCodCaj    := oUser():cCaja()
                     ( dbfFacCliP )->nImporte   := nImpCob
                     ( dbfFacCliP )->cDescrip   := "Recibo nº1 de factura " + ( dbfFacCliP )->cSerie  + "/" + allTrim( Str( ( dbfFacCliP )->nNumFac ) ) + "/" + ( dbfFacCliP )->cSufFac
                     ( dbfFacCliP )->cDivPgo    := cDivEmp()
                     ( dbfFacCliP )->nVdvPgo    := nChgDiv( ( dbfFacCliT )->cDivFac, dbfDiv )
                     ( dbfFacCliP )->lCobrado   := .T.
                     ( dbfFacCliP )->cTurRec    := cCurSesion()
                     ( dbfFacCliP )->dPreCob    := dFecFac
                     ( dbfFacCliP )->dEntrada   := dFecFac
                     ( dbfFacCliP )->( dbUnLock() )

                  end





                  while cNumDoc == SubStr( oFilEdm:cLine,  8, 10 ) .AND. ! oFilEdm:lEoF()

                     if cTipDoc == "1" .OR. cTipDoc == "2"

                        if ( dbfFacCliT )->( dbSeek( cSerie + Str( nNumDoc, 9 ) + RetSufEmp() ) )





                           ( dbfFacCliL )->( dbAppend() )
                           ( dbfFacCliL )->cSerie     := ( dbfFacCliT )->cSerie
                           ( dbfFacCliL )->nNumFac    := ( dbfFacCliT )->nNumFac
                           ( dbfFacCliL )->cSufFac    := ( dbfFacCliT )->cSufFac
                           ( dbfFacCliL )->cRef       := Ltrim( SubStr( oFilEdm:cLine, 19, 13 ) )
                           ( dbfFacCliL )->cDetalle   := RetFld( ( dbfFacCliL )->cRef, dbfArticulo )
                           ( dbfFacCliL )->nPreUnit   := Val( SubStr( oFilEdm:cLine, 32,  7 ) )
                           ( dbfFacCliL )->nDtoDiv    := Val( SubStr( oFilEdm:cLine, 39,  5 ) )
                           ( dbfFacCliL )->nDto       := Val( SubStr( oFilEdm:cLine, 44,  5 ) )
                           ( dbfFacCliL )->nIva       := nIvaCodTer( SubStr( oFilEdm:cLine, 61, 1 ), dbfIva )
                           ( dbfFacCliL )->nReq       := nReqCodTer( SubStr( oFilEdm:cLine, 61, 1 ), dbfIva )
                           ( dbfFacCliL )->nPntVer    := Val( SubStr( oFilEdm:cLine, 63, 7 ) )
                           ( dbfFacCliL )->nCanEnt    := 1
                           ( dbfFacCliL )->nUniCaja   := Val( SubStr( oFilEdm:cLine, 53,  7 ) )





                           if ( n  := aScan( aLotes, {|a| a[1] == cNumDoc .AND. a[2] == Ltrim( SubStr( oFilEdm:cLine, 19, 13 ) ) } ) ) <> 0
                              ( dbfFacCliL )->lLote   := .T.
                              ( dbfFacCliL )->cLote   := aLotes[ n, 3 ]
                           end

                           ( dbfFacCliL )->( dbUnLock() )

                        end

                     end

                     oFilEdm:Skip()
                     oStru:oMetDos:SetTotal( oFilEdm:nLine )

                  end





                  ChkLqdFacCli( nil, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfAntCliT, dbfIva, dbfDiv )

               else

                  aAdd( aSucces, { .F., "Lineas de facturas huerfanas, cliente " + cCodCli + ", documento " + cNumDoc } )
                  oFilEdm:Skip()

               end

            else

               aAdd( aSucces, { .F., "Factura de clientes ya existe " + ( dbfFacCliT )->cSerie + "/" + Str( ( dbfFacCliT )->nNumFac ) + "/" + ( dbfFacCliT )->cSufFac } )
               oFilEdm:Skip()

            end

         else

            aAdd( aSucces, { .F., "No existe cliente " + cCodCli + " de factura " + cNumDoc } )
            oFilEdm:Skip()

         end

      else

         oFilEdm:Skip()

      end

   end

   oFilEdm:Close()

   CloseFiles()

RETURN ( aSucces )





FUNCTION aDocFacCli()

   local aDoc  := {}





   aAdd( aDoc, { "Empresa",         "EM" } )
   aAdd( aDoc, { "Factura",         "FC" } )
   aAdd( aDoc, { "Cliente",         "CL" } )
   aAdd( aDoc, { "Almacen",         "AL" } )
   aAdd( aDoc, { "Obras",           "OB" } )
   aAdd( aDoc, { "Rutas",           "RT" } )
   aAdd( aDoc, { "Agentes",         "AG" } )
   aAdd( aDoc, { "Divisas",         "DV" } )
   aAdd( aDoc, { "Formas de pago",  "PG" } )
   aAdd( aDoc, { "Transportistas",  "TR" } )
   aAdd( aDoc, { "Cajas",           "CA" } )

RETURN ( aDoc )



function ShowKit( dbfMaster, dbfTmpLin, oBtnKit, oBrw, lSet, dbfTmpInc, cCodCli, dbfClient, oRieCli, oGetRnt, aGet, oSayGetRnt )

   local lShwKit     := lShwKit()

   IIF( lSet == nil, lSet := .T., ) ;

   if !Empty( aGet ) .AND. !Empty( dbfMaster )

      if !Empty( cCodCli )
         aGet[ ( dbfMaster )->( FieldPos( "cCodCli" ) ) ]:cText( cCodCli )
         aGet[ ( dbfMaster )->( FieldPos( "cCodCli" ) ) ]:lValid()
      end











   end

   if lSet
      lShwKit        := !lShwKit
   end

   if lShwKit
      SetWindowText( oBtnKit:hWnd, "Ocultar Esc&ll." )
      if ( dbfTmpLin )->( Used() )
         ( dbfTmpLin )->( dbClearFilter() )
      end
   else
      SetWindowText( oBtnKit:hWnd, "Mostrar Esc&ll." )
      if ( dbfTmpLin )->( Used() )
         ( dbfTmpLin )->( dbSetFilter( {|| ! Field->lKitChl }, "!lKitChl" ) )
      end
   end

   if lSet
      lShwKit( lShwKit )
   end

   if oGetRnt <> nil .AND. oUser():lNotRentabilidad()
      oGetRnt:Hide()
   end

   if oSayGetRnt <> nil .AND. oUser():lNotRentabilidad()
      oSayGetRnt:Hide()
   end





   if !Empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )

      while !( dbfTmpInc )->( Eof() )
         if ( dbfTmpInc )->lAviso .AND. !( dbfTmpInc )->lListo
            MsgInfo( Trim( ( dbfTmpInc )->mDesInc ), "¡Incidencia!" )
         end
         ( dbfTmpInc )->( dbSkip() )
      end

      ( dbfTmpInc )->( dbGoTop() )

   end

   oBrw:Refresh()

return nil















FUNCTION lSndInt( oBrw, dbf )

   if ( dbf )->( dbRLock() )
      ( dbf )->lSndDoc  := !( dbf )->lSndDoc
      ( dbf )->( dbUnlock() )
   end

   oBrw:Refresh()
   oBrw:SetFocus()

RETURN NIL












STATIC FUNCTION GrpAlb( aGet, aTmp, oBrw )

   local oDlg
   local oBmp
   local oTitle1
   local oTitle2
   local oTitle3
   local oBrwDet
   local nOrd
   local nNumLin
   local nItem       := 1
   local nTotDoc     := 0
   local nDtoEsp     := 0
   local nDtoDpp     := 0
   local nDtoUno     := 0
   local nDtoDos     := 0
   local nOffSet     := 0
    local cDesAlb        := ""
   local cCodCli     := Rtrim( aGet[ 6 ]:VarGet() )
   local lIvaInc     := aTmp[ 58 ]
   local lAlquiler   := .F.
   local aAlbaranes  := {}
   local nTotEntAlb  := 0
   local cSuPed      := ""

   if empty( cCodCli )
      msgStop( "Es necesario codificar un cliente.", "Agrupar albaranes" )
      return .T.
   end

   nOrd              := ( dbfAlbCliT )->( ordSetFocus( "CCODCLI" ) )

   if !Empty( oTipFac ) .AND. oTipFac:nAt == 2
      lAlquiler      := .T.
   end






   if ( dbfAlbCliT )->( dbSeek( cCodCli ) )
      while Rtrim( ( dbfAlbCliT )->cCodCli ) == cCodCli .AND. !( dbfAlbCliT )->( eof() )




         if ( dbfAlbCliT )->lAlquiler  == lAlquiler                                          .AND. !( dbfAlbCliT )->lFacturado                                                      .AND. ( lIvaInc == ( dbfAlbCliT )->lIvaInc  )                                          .AND. ( Empty( aTmp[ 22 ] ) .OR. ( dbfAlbCliT )->cCodObr == aTmp[ 22 ] )












            aAdd( aAlbaranes, {  ( dbfAlbCliT )->lFacturado , ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb, ( dbfAlbCliT )->cCodSuAlb , ( dbfAlbCliT )->dFecAlb , ( dbfAlbCliT )->cCodCli , ( dbfAlbCliT )->cNomCli , ( dbfAlbCliT )->cRetMat , ( dbfAlbCliT )->cCodObr , sTotAlbCli( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb, dbfAlbCliT, dbfAlbCliL, dbfIva, dbfDiv, nil, nil, .T. ), ( dbfAlbCliT )->cSerAlb , ( dbfAlbCliT )->nNumAlb , ( dbfAlbCliT )->cSufAlb } )
         endif

         ( dbfAlbCliT )->( dbSkip() )

      end

   else

      msgStop( "No existen albaranes de este cliente." )
      ( dbfAlbCliT )->( ordSetFocus( nOrd ) )
      return .T.

   end






   ( dbfAlbCliT )->( ordSetFocus( nOrd ) )





   if Len( aAlbaranes ) == 0
        MsgStop( "No existen albaranes sin facturar" )
      return .T.
   end








   oDlg = TDialog():New(,,,, "Agrupando albaranes de clientes", "SET_ALBARAN",, .F.,,,,,, .F.,,,,,, .F., )





      oBmp := TBitmap():ReDefine( 500, "plantillas_automaticas_48_alpha",, oDlg,,, .F., .F.,,, .F.,,, .T. )



      oTitle1 := TSay():ReDefine( 501, {|| RTrim( aTmp[9] )}, oDlg,,,, .F.,, .F., .F. )



      oTitle2 := TSay():ReDefine( 502, {|| If( Empty( aTmp[22] ), "TODAS", aTmp[22] )}, oDlg,,,, .F.,, .F., .F. )



      oTitle3 := TSay():ReDefine( 503, {|| if( aTmp[ 58 ], "Incluido", "Desglosado" )}, oDlg,,,, .F.,, .F., .F. )



      oTitle3 := TSay():ReDefine( 504, {|| "Tipo de " + cImp() + ": "}, oDlg,,,, .F.,, .F., .F. )

      oBrwDet                        := IXBrowse():New( oDlg )

      oBrwDet:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDet:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDet:nMarqueeStyle          := 5
      oBrwDet:lRecordSelector        := .F.
      oBrwDet:lHscroll               := .F.
      oBrwDet:lFooter                := .T.
      oBrwDet:cName                  := "Agrupar albaranes clientes"

      oBrwDet:bLDblClick   := {|| aAlbaranes[ oBrwDet:nArrayAt, 1 ] := !aAlbaranes[ oBrwDet:nArrayAt, 1 ], oBrwDet:Refresh() }

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Seleccionado"
         :cSortOrder       := 1
         :bStrData         := {|| "" }
         :bEditValue       := {|| aAlbaranes[ oBrwDet:nArrayAt, 1 ] }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := 2
         :bEditValue       := {|| aAlbaranes[ oBrwDet:nArrayAt, 10 ] + "/" + AllTrim( Str( aAlbaranes[ oBrwDet:nArrayAt, 11 ] ) ) + "/" + aAlbaranes[ oBrwDet:nArrayAt, 12 ] }
         :nWidth           := 75
      end

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Su albarán"
         :cSortOrder       := 3
         :bEditValue       := {|| aAlbaranes[ oBrwDet:nArrayAt, 3 ] }
         :nWidth           := 75
      end

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := 4
         :bEditValue       := {|| Dtoc( aAlbaranes[ oBrwDet:nArrayAt, 4 ] ) }
         :nWidth           := 80
      end

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Cliente"
         :cSortOrder       := 5
         :bEditValue       := {|| Rtrim( aAlbaranes[ oBrwDet:nArrayAt, 5 ] ) + Space(1) + aAlbaranes[ oBrwDet:nArrayAt, 6 ] }
         :nWidth           := 225
      end

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Matrícula"
         :cSortOrder       := 7
         :bEditValue       := {|| Rtrim( aAlbaranes[ oBrwDet:nArrayAt, 7 ] ) }
         :nWidth           := 80
      end

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Dirección"
         :cSortOrder       := 8
         :bEditValue       := {|| Rtrim( aAlbaranes[ oBrwDet:nArrayAt, 8 ] ) + Space(1) + RetFld( aAlbaranes[ oBrwDet:nArrayAt, 5 ] + aAlbaranes[ oBrwDet:nArrayAt, 8 ], dbfObrasT, "cNomObr" ) }
         :nWidth           := 225
      end

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| aAlbaranes[ oBrwDet:nArrayAt, 9 ]:nTotalDocumento }
         :bFooter          := {|| nTotalAlbaranesAgrupar( aAlbaranes ) }
         :nWidth           := 70
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nFootStrAlign    := 1
      end

      oBrwDet:SetArray( aAlbaranes, .T., , .F. )

      oBrwDet:CreateFromResource( 130 )






      TButton():ReDefine( 514, {||(  aAlbaranes[ oBrwDet:nArrayAt, 1 ] := !aAlbaranes[ oBrwDet:nArrayAt, 1 ], oBrwDet:refresh(), oBrwDet:setFocus() )}, oDlg,,, .F.,,,, .F. )






        TButton():ReDefine( 516, {||(  aEval( aAlbaranes, { |aItem| aItem[1] := .T. } ), oBrwDet:refresh(), oBrwDet:setFocus() )}, oDlg,,, .F.,,,, .F. )






        TButton():ReDefine( 517, {||(  aEval( aAlbaranes, { |aItem| aItem[1] := .F. } ), oBrwDet:refresh(), oBrwDet:setFocus() )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 518, {||( ZooAlbCli( aAlbaranes[ oBrwDet:nArrayAt, 2 ] ) )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

      oDlg:bStart := {|| oBrwDet:Load() }

    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )





   if oDlg:nResult == 1 .AND. Len( aAlbaranes ) >= 1

      CursorWait()





      for nItem := 1 TO Len( aAlbaranes )
         if ( aAlbaranes[ nItem, 1 ] )
            if ( dbfAlbCliT )->( dbSeek( aAlbaranes[ nItem, 2] ) )
               SetFacturadoAlbaranCliente( .T., , dbfAlbCliT, dbfAlbCliL, dbfAlbCliS )
            end
                aAdd( aNumAlb, aAlbaranes[ nItem, 2 ] )
         end
      next

      for nItem := 1 to Len( aAlbaranes )





         if ( dbfAlbCliT )->( dbSeek( aAlbaranes[ nItem, 2] ) ) .AND. aAlbaranes[ nItem, 1 ]

            if !Empty( ( dbfAlbCliT )->cCodAge ) .AND. Empty( aTmp[ 19 ] )
               aGet[ 19  ]:cText( ( dbfAlbCliT )->cCodAge )
            end

            if !Empty( ( dbfAlbCliT )->cCodPago ) .AND. Empty( aTmp[ 32 ] )
               aGet[ 32 ]:cText( ( dbfAlbCliT )->cCodPago )
            end

            if ( dbfAlbCliT )->lRecargo
               aTmp[ 56 ] := .T.
               aGet[ 56 ]:Refresh()
            end

            if ( dbfAlbCliT )->lOperPv
               aTmp[ 117 ]  := .T.
               aGet[ 117 ]:Refresh()
            end

            cSuPed               := ( dbfAlbCliT )->cSuPed

         end





         if ( dbfAlbCliL )->( dbSeek( aAlbaranes[ nItem, 2 ] ) ) .AND. aAlbaranes[ nItem, 1 ]

            nNumLin                    := nil

            if lNumAlb() .OR. lNumObr() .OR. lSuAlb()

               ( dbfTmpLin )->( dbAppend() )

               cDesAlb                 := ""
               if lNumObr()
                  cDesAlb              += Alltrim( cNumObr() ) + " " + StrTran( aAlbaranes[ nItem, 8 ], " ", "" ) + Space( 1 )
               end
               if lNumAlb()
                  cDesAlb              += Alltrim( cNumAlb() ) + " " + Left( aAlbaranes[ nItem, 2 ], 1 ) + "/" + AllTrim( SubStr( aAlbaranes[ nItem, 2 ], 2, 9 ) ) + "/" + Right( aAlbaranes[ nItem, 2 ], 2 ) + Space( 1 )
               end
               if lSuAlb()
                  cDesAlb              += Alltrim( cSuAlb()  ) + " " + StrTran( aAlbaranes[ nItem, 3 ], " ", "" ) + Space( 1 )
               end
               cDesAlb                 += " - Fecha " + Dtoc( aAlbaranes[ nItem, 4] )

               ( dbfTmpLin )->cDetalle := cDesAlb
               ( dbfTmpLin )->lControl := .T.
               ( dbfTmpLin )->nNumLin  := ++nOffSet

            end

            while ( ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb == aAlbaranes[ nItem, 2] .AND. !( dbfAlbCliL )->( Eof() ) )

               if nNumLin <> ( dbfAlbCliL )->nNumLin .AND. !( dbfAlbCliL )->lControl
                  ++nOffSet
                  nNumLin              := ( dbfAlbCliL )->nNumLin
               end

               ( dbfTmpLin )->( dbAppend() )
               ( dbfTmpLin )->nNumLin  := nOffSet
               ( dbfTmpLin )->cRef     := ( dbfAlbCliL )->cRef
               ( dbfTmpLin )->cDetalle := ( dbfAlbCliL )->cDetalle
               ( dbfTmpLin )->mLngDes  := ( dbfAlbCliL )->mLngDes
               ( dbfTmpLin )->mNumSer  := ( dbfAlbCliL )->mNumSer
               ( dbfTmpLin )->nPreUnit := ( dbfAlbCliL )->nPreUnit
               ( dbfTmpLin )->NCANENT  := ( dbfAlbCliL )->nCanEnt
               ( dbfTmpLin )->CUNIDAD  := ( dbfAlbCliL )->cUnidad
               ( dbfTmpLin )->NUNICAJA := ( dbfAlbCliL )->nUniCaja
               ( dbfTmpLin )->nUndKit  := ( dbfAlbCliL )->nUndKit
               ( dbfTmpLin )->NPESOKG  := ( dbfAlbCliL )->nPesOkg
               ( dbfTmpLin )->NVOLUMEN := ( dbfAlbCliL )->nVolumen
               ( dbfTmpLin )->CVOLUMEN := ( dbfAlbCliL )->cVolumen
               ( dbfTmpLin )->NIVA     := ( dbfAlbCliL )->nIva
               ( dbfTmpLin )->nReq     := ( dbfAlbCliL )->nReq
               ( dbfTmpLin )->NDTO     := ( dbfAlbCliL )->nDto
               ( dbfTmpLin )->NDTODIV  := ( dbfAlbCliL )->nDtoDiv
               ( dbfTmpLin )->NPNTVER  := ( dbfAlbCliL )->nPntVer
               ( dbfTmpLin )->NDTOPRM  := ( dbfAlbCliL )->nDtoPrm
               ( dbfTmpLin )->NCOMAGE  := ( dbfAlbCliL )->nComAge
               ( dbfTmpLin )->DFECHA   := ( dbfAlbCliL )->dFecha
               ( dbfTmpLin )->CTIPMOV  := ( dbfAlbCliL )->cTipMov
               ( dbfTmpLin )->LTOTLIN  := ( dbfAlbCliL )->lTotLin
               ( dbfTmpLin )->cCodAlb  := ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb
               ( dbfTmpLin )->dFecAlb  := ( dbfAlbCliT )->dFecAlb
               ( dbfTmpLin )->cAlmLin  := ( dbfAlbCliL )->cAlmLin
               ( dbfTmpLin )->lIvaLin  := ( dbfAlbCliL )->lIvaLin
               ( dbfTmpLin )->nValImp  := ( dbfAlbCliL )->nValImp
               ( dbfTmpLin )->cCodPr1  := ( dbfAlbCliL )->cCodPr1
               ( dbfTmpLin )->cCodPr2  := ( dbfAlbCliL )->cCodPr2
               ( dbfTmpLin )->cValPr1  := ( dbfAlbCliL )->cValPr1
               ( dbfTmpLin )->cValPr2  := ( dbfAlbCliL )->cValPr2
               ( dbfTmpLin )->nCosDiv  := ( dbfAlbCliL )->nCosDiv
               ( dbfTmpLin )->lKitArt  := ( dbfAlbCliL )->lKitArt
               ( dbfTmpLin )->lKitChl  := ( dbfAlbCliL )->lKitChl
               ( dbfTmpLin )->lKitPrc  := ( dbfAlbCliL )->lKitPrc
               ( dbfTmpLin )->nUndKit  := ( dbfAlbCliL )->nUndKit
               ( dbfTmpLin )->nMesGrt  := ( dbfAlbCliL )->nMesGrt
               ( dbfTmpLin )->lLote    := ( dbfAlbCliL )->lLote
               ( dbfTmpLin )->nLote    := ( dbfAlbCliL )->nLote
               ( dbfTmpLin )->cLote    := ( dbfAlbCliL )->cLote
               ( dbfTmpLin )->lControl := ( dbfAlbCliL )->lControl
               ( dbfTmpLin )->lNotVta  := ( dbfAlbCliL )->lNotVta
               ( dbfTmpLin )->lImpLin  := ( dbfAlbCliL )->lImpLin
               ( dbfTmpLin )->mObsLin  := ( dbfAlbCliL )->mObsLin
               ( dbfTmpLin )->Descrip  := ( dbfAlbCliL )->Descrip
               ( dbfTmpLin )->cCodPrv  := ( dbfAlbCliL )->cCodPrv
               ( dbfTmpLin )->cNomPrv  := ( dbfAlbCliL )->cNomPrv
               ( dbfTmpLin )->cImagen  := ( dbfAlbCliL )->cImagen
               ( dbfTmpLin )->cCodFam  := ( dbfAlbCliL )->cCodFam
               ( dbfTmpLin )->cGrpFam  := ( dbfAlbCliL )->cGrpFam
               ( dbfTmpLin )->cRefPrv  := ( dbfAlbCliL )->cRefPrv
               ( dbfTmpLin )->dFecEnt  := ( dbfAlbCliL )->dFecEnt
               ( dbfTmpLin )->dFecSal  := ( dbfAlbCliL )->dFecSal
               ( dbfTmpLin )->lAlquiler:= ( dbfAlbCliL )->lAlquiler
               ( dbfTmpLin )->nPreAlq  := ( dbfAlbCliL )->nPreAlq
               ( dbfTmpLin )->cUnidad  := ( dbfAlbCliL )->cUnidad
               ( dbfTmpLin )->nNumMed  := ( dbfAlbCliL )->nNumMed
               ( dbfTmpLin )->nMedUno  := ( dbfAlbCliL )->nMedUno
               ( dbfTmpLin )->nMedDos  := ( dbfAlbCliL )->nMedDos
               ( dbfTmpLin )->nMedTre  := ( dbfAlbCliL )->nMedTre
               ( dbfTmpLin )->nPuntos  := ( dbfAlbCliL )->nPuntos
               ( dbfTmpLin )->nValPnt  := ( dbfAlbCliL )->nValPnt
               ( dbfTmpLin )->nDtoPnt  := ( dbfAlbCliL )->nDtoPnt
               ( dbfTmpLin )->nIncPnt  := ( dbfAlbCliL )->nIncPnt
               ( dbfTmpLin )->nFacCnv  := ( dbfAlbCliL )->nFacCnv
               ( dbfTmpLin )->lLinOfe  := ( dbfAlbCliL )->lLinOfe
               ( dbfTmpLin )->dFecCad  := ( dbfAlbCliL )->dFecCad
               ( dbfTmpLin )->cSuPed   := cSuPed






               if ( dbfAlbCliS )->( dbSeek( ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb + Str( ( dbfAlbCliL )->nNumLin ) ) )

                  while ( ( dbfAlbCliS )->cSerAlb + Str( ( dbfAlbCliS )->nNumAlb ) + ( dbfAlbCliS )->cSufAlb + Str( ( dbfAlbCliS )->nNumLin ) == ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb + Str( ( dbfAlbCliL )->nNumLin ) .AND. !( dbfAlbCliS )->( eof() ) )

                     ( dbfTmpSer )->( dbAppend() )

                     ( dbfTmpSer )->nNumLin     := nOffSet
                     ( dbfTmpSer )->cRef        := ( dbfAlbCliS )->cRef
                     ( dbfTmpSer )->cAlmLin     := ( dbfAlbCliS )->cAlmLin
                     ( dbfTmpSer )->lUndNeg     := ( dbfAlbCliS )->lUndNeg
                     ( dbfTmpSer )->cNumSer     := ( dbfAlbCliS )->cNumSer

                     ( dbfAlbCliS )->( dbSkip() )

                  end

               end

               ( dbfAlbCliL )->( dbSkip() )

            end

























            nTotDoc                    += aAlbaranes[ nItem, 9 ]:nTotalBruto
            nDtoEsp                    += aAlbaranes[ nItem, 9 ]:nTotalDescuentoGeneral
            nDtoDpp                    += aAlbaranes[ nItem, 9 ]:nTotalDescuentoProntoPago
            nDtoUno                    += aAlbaranes[ nItem, 9 ]:nTotalDescuentoUno
            nDtoDos                    += aAlbaranes[ nItem, 9 ]:nTotalDescuentoDos










































            if RetFld( cCodCli, dbfClient, "lTotAlb" )
               ( dbfTmpLin )->( dbAppend() )
               ( dbfTmpLin )->nNumLin  := ++nOffSet
               ( dbfTmpLin )->mLngDes  := "Total albarán..."
               ( dbfTmpLin )->lTotLin  := .T.
            end

            ( dbfTmpLin )->( dbGoTop() )





            if ( dbfAlbCliI )->( dbSeek( aAlbaranes[ nItem, 2 ] ) )

               while ( dbfAlbCliI )->cSerAlb + Str( ( dbfAlbCliI )->nNumAlb ) + ( dbfAlbCliI )->cSufAlb == aAlbaranes[ nItem, 2 ] .AND. !( dbfAlbCliI )->( Eof() )
                  dbPass( dbfAlbCliI, dbfTmpInc, .T. )
                  ( dbfAlbCliI )->( dbSkip() )
               end

            end

            ( dbfAlbCliI )->( dbGoTop() )





            if ( dbfAlbCliD )->( dbSeek( aAlbaranes[ nItem, 2 ] ) )

               while ( dbfAlbCliD )->cSerAlb + Str( ( dbfAlbCliD )->nNumAlb ) + ( dbfAlbCliD )->cSufAlb == aAlbaranes[ nItem, 2 ] .AND. !( dbfAlbCliD )->( Eof() )
                  dbPass( dbfAlbCliD, dbfTmpDoc, .T. )
                  ( dbfAlbCliD )->( dbSkip() )
               end

            end

            ( dbfAlbCliD )->( dbGoTop() )

            oBrw:Refresh()

         end

         ( dbfTmpLin )->( dbGoTop() )
         ( dbfTmpPgo )->( dbGoTop() )
         ( dbfTmpInc )->( dbGoTop() )
         ( dbfTmpDoc )->( dbGoTop() )

      next





      for nItem := 1 to Len( aAlbaranes )

         if aAlbaranes[ nItem, 1] .AND. ( dbfAlbCliP )->( dbSeek( aAlbaranes[ nItem, 2 ] ) )

            while ( dbfAlbCliP )->cSerAlb + Str( ( dbfAlbCliP )->nNumAlb ) + ( dbfAlbCliP )->cSufAlb == aAlbaranes[ nItem, 2] .AND. !( dbfAlbCliP )->( Eof() )

               nTotEntAlb     += ( dbfAlbCliP )->nImporte

               ( dbfAlbCliP )->( dbSkip() )

            end

         end

         ( dbfAlbCliP )->( dbGoTop() )

      next





      if nTotEntAlb <> 0

         ( dbfTmpPgo )->( dbAppend() )

         ( dbfTmpPgo )->lCobrado := .T.
         ( dbfTmpPgo )->lConPgo  := .F.
         ( dbfTmpPgo )->lRecImp  := .F.
         ( dbfTmpPgo )->lRecDto  := .F.
         ( dbfTmpPgo )->nNumRec  := ( dbfTmpPgo )->( RecNo() )
         ( dbfTmpPgo )->cCodCaj  := aTmp[ 8 ]
         ( dbfTmpPgo )->cCodCli  := aTmp[ 6 ]
         ( dbfTmpPgo )->cNomCli  := aTmp[ 9 ]
         ( dbfTmpPgo )->dEntrada := aTmp[ 5 ]
         ( dbfTmpPgo )->dPreCob  := aTmp[ 5 ]
         ( dbfTmpPgo )->dFecVto  := aTmp[ 5 ]
         ( dbfTmpPgo )->nImporte := nTotEntAlb
         ( dbfTmpPgo )->nImpCob  := nTotEntAlb
         ( dbfTmpPgo )->cDivPgo  := aTmp[ 60 ]
         ( dbfTmpPgo )->nVdvPgo  := aTmp[ 61 ]
         ( dbfTmpPgo )->cCodAge  := aTmp[ 19 ]
         ( dbfTmpPgo )->cTurRec  := ""
         ( dbfTmpPgo )->lCloPgo  := .T.
         ( dbfTmpPgo )->cCodPgo  := aTmp[ 32 ]
         ( dbfTmpPgo )->cDescrip := "Suma entregas a cuenta de albaranes"
         ( dbfTmpPgo )->( dbUnLock() )

      end





      aGet[ 37 ]:Hide()
      aGet[ 38 ]:Hide()
      aGet[ 39 ]:Hide()

      oBtnPre:Disable()
      oBtnPed:Disable()
      oBtnAlb:Disable()

      oBtnGrp:bWhen  := {|| .F. }





      if !Empty( nDtoEsp )
         aGet[ 42 ]:cText( nDtoEsp / nTotDoc * 100 )
         nTotDoc  -= nDtoEsp
      end

      if !Empty( nDtoDpp )
         aGet[ 44 ]:cText( nDtoDpp / nTotDoc * 100 )
         nTotDoc  -= nDtoDpp
      end

      if !Empty( nDtoUno )
         aGet[ 46 ]:cText( nDtoUno / nTotDoc * 100 )
         nTotDoc  -= nDtoUno
      end

      if !Empty( nDtoDos )
         aGet[ 48 ]:cText( nDtoDos / nTotDoc * 100 )
      end





      RecalculaTotal( aTmp )

      CursorWE()

   end





   oBrwDet:CloseData()

   oBmp:End()

RETURN .T.



static function nTotalAlbaranesAgrupar( aAlbaranes )

   local aAlbaran
   local nTotal   := 0

   for each aAlbaran in aAlbaranes

      if aAlbaran[1]
         nTotal      +=  aAlbaran[9]:nTotalDocumento
      end

   next

return Trans( nTotal, cPorDiv )



_HB_CLASS TFacturasClientesSenderReciver ; UTILITY FUNCTION TFacturasClientesSenderReciver(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TFacturasClientesSenderReciver" , {TSenderReciverItem():classh} ) ) ; ;

   _HB_MEMBER { lSuccesfullSendFacturas} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "lSuccesfullSendFacturas" }, .F., .F. ), )
   _HB_MEMBER { lSuccesfullSendAnticipos} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "lSuccesfullSendAnticipos" }, .F., .F. ), )

   _HB_MEMBER { nFacturaNumberSend} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nFacturaNumberSend" }, .F., .F. ), )
   _HB_MEMBER { nAnticipoNumberSend} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nAnticipoNumberSend" }, .F., .F. ), )

   _HB_MEMBER CreateData(); IIF( .F., s_oClass:ModMethod( "CreateData", @TFacturasClientesSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CreateData", @TFacturasClientesSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER RestoreData(); IIF( .F., s_oClass:ModMethod( "RestoreData", @TFacturasClientesSenderReciver_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "RestoreData", @TFacturasClientesSenderReciver_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER SendData(); IIF( .F., s_oClass:ModMethod( "SendData", @TFacturasClientesSenderReciver_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SendData", @TFacturasClientesSenderReciver_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER ReciveData(); IIF( .F., s_oClass:ModMethod( "ReciveData", @TFacturasClientesSenderReciver_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "ReciveData", @TFacturasClientesSenderReciver_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Process(); IIF( .F., s_oClass:ModMethod( "Process", @TFacturasClientesSenderReciver_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Process", @TFacturasClientesSenderReciver_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER nGetFacturaNumberToSend(); IIF( .F., s_oClass:ModInline( "nGetFacturaNumberToSend", {|Self | Self, ( ::nFacturaNumberSend     := GetPvProfInt( "Numero", "Facturas clientes", ::nFacturaNumberSend, ::cIniFile ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nGetFacturaNumberToSend", {|Self | Self, ( ::nFacturaNumberSend     := GetPvProfInt( "Numero", "Facturas clientes", ::nFacturaNumberSend, ::cIniFile ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER nGetAnticipoNumberToSend(); IIF( .F., s_oClass:ModInline( "nGetAnticipoNumberToSend", {|Self | Self, ( ::nAnticipoNumberSend    := GetPvProfInt( "Numero", "Anticipos clientes", ::nAnticipoNumberSend, ::cIniFile ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nGetAnticipoNumberToSend", {|Self | Self, ( ::nAnticipoNumberSend    := GetPvProfInt( "Numero", "Anticipos clientes", ::nAnticipoNumberSend, ::cIniFile ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER IncFacturaNumberToSend(); IIF( .F., s_oClass:ModInline( "IncFacturaNumberToSend", {|Self | Self, ( WritePProString( "Numero", "Facturas clientes",    cValToChar( ++::nFacturaNumberSend ),  ::cIniFile ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "IncFacturaNumberToSend", {|Self | Self, ( WritePProString( "Numero", "Facturas clientes",    cValToChar( ++::nFacturaNumberSend ),  ::cIniFile ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER IncAnticipoNumberToSend(); IIF( .F., s_oClass:ModInline( "IncAnticipoNumberToSend", {|Self | Self, ( WritePProString( "Numero", "Anticipos clientes",   cValToChar( ++::nAnticipoNumberSend ), ::cIniFile ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "IncAnticipoNumberToSend", {|Self | Self, ( WritePProString( "Numero", "Anticipos clientes",   cValToChar( ++::nAnticipoNumberSend ), ::cIniFile ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TFacturasClientesSenderReciver ;



UTILITY STATIC function TFacturasClientesSenderReciver_CreateData() ; local Self AS CLASS TFacturasClientesSenderReciver := QSelf() AS CLASS TFacturasClientesSenderReciver

   local oBlock
   local oError
   local nOrd
   local dbfFacCliT
   local dbfFacCliL
   local dbfFacCliI
   local dbfFacCliP
   local dbfAntCliT
   local tmpFacCliT
   local tmpFacCliL
   local tmpFacCliP
   local tmpFacCliI
   local tmpAntCliT
   local lSndFacCli           := .F.
   local lSndAntCli           := .F.
   local cFileNameFacturas
   local cFileNameAnticipos

   if ::oSender:lServer
      cFileNameFacturas       := "FacCli" + StrZero( ::nGetFacturaNumberToSend(), 6 ) + ".All"
      cFileNameAnticipos      := "AntCli" + StrZero( ::nGetAnticipoNumberToSend(), 6 ) + ".All"
   else
      cFileNameFacturas       := "FacCli" + StrZero( ::nGetFacturaNumberToSend(), 6 ) + "." + RetSufEmp()
      cFileNameAnticipos      := "AntCli" + StrZero( ::nGetAnticipoNumberToSend(), 6 ) + "." + RetSufEmp()
   end

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliT.DBF" ), ( cCheckArea( "FacCliT", @dbfFacCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliL.DBF" ), ( cCheckArea( "FacCliL", @dbfFacCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliP.DBF" ), ( cCheckArea( "FacCliP", @dbfFacCliP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliI.DBF" ), ( cCheckArea( "FacCliI", @dbfFacCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
   ( dbfAntCliT )->( OrdSetFocus( "cNumDoc" ) )





   mkFacCli( cPatSnd() )
   mkRecCli( cPatSnd() )

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacCliT.DBF" ), ( cCheckArea( "FacCliT", @tmpFacCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FacCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacCliL.DBF" ), ( cCheckArea( "FacCliL", @tmpFacCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FacCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacCliP.DBF" ), ( cCheckArea( "FacCliP", @tmpFacCliP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FacCliP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacCliI.DBF" ), ( cCheckArea( "FacCliI", @tmpFacCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FacCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   if !Empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( dbfFacCliT )->( LastRec() )
   end

   ::oSender:SetText( "Enviando facturas de clientes" )

   nOrd  := ( dbfFacCliT )->( OrdSetFocus( "lSndDoc" ) )

   if ( dbfFacCliT )->( dbSeek( .T. ) )
      while !( dbfFacCliT )->( eof() )

         if ( dbfFacCliT )->lSndDoc

            lSndFacCli  := .T.

            dbPass( dbfFacCliT, tmpFacCliT, .T. )
            ::oSender:SetText( ( dbfFacCliT )->cSerie + "/" + AllTrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + AllTrim( ( dbfFacCliT )->cSufFac ) + "; " + Dtoc( ( dbfFacCliT )->dFecFac ) + ";" + AllTrim( ( dbfFacCliT )->cCodCli ) + "; " + ( dbfFacCliT )->cNomCli )

            if ( dbfFacCliL )->( dbSeek( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) )
               while ( ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac ) == ( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) .AND. !( dbfFacCliL )->( eof() )
                  dbPass( dbfFacCliL, tmpFacCliL, .T. )
                  ( dbfFacCliL )->( dbSkip() )
               end
            end

            if ( dbfFacCliI )->( dbSeek( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) )
               while ( ( dbfFacCliI )->cSerie + Str( ( dbfFacCliI )->nNumFac ) + ( dbfFacCliI )->cSufFac ) == ( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) .AND. !( dbfFacCliI )->( eof() )
                  dbPass( dbfFacCliI, tmpFacCliI, .T. )
                  ( dbfFacCliI )->( dbSkip() )
               end
            end

            if ( dbfFacCliP )->( dbSeek( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) )
               while ( ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac ) == ( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) .AND. !( dbfFacCliP )->( eof() )
                  dbPass( dbfFacCliP, tmpFacCliP, .T. )
                  ( dbfFacCliP )->( dbSkip() )
               end
            end

            if ( dbfAntCliT )->( dbSeek( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) )
               while ( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac == ( dbfAntCliT )->cNumDoc .AND. !( dbfAntCliT )->( eof() ) )
                  if !( dbfAntCliT )->lSndDoc .AND. ( dbfAntCliT )->( dbRLock() )
                     ( dbfAntCliT )->lSndDoc := .T.
                     ( dbfAntCliT )->( dbUnlock() )
                  end
                  ( dbfAntCliT )->( dbSkip() )
               end
            end

         end

         ( dbfFacCliT )->( dbSkip() )

         if !Empty( ::oSender:oMtr )
            ::oSender:oMtr:Set( ( dbfFacCliT )->( OrdKeyNo() ) )
         end

      end
   end

   ( dbfFacCliT )->( OrdSetFocus( nOrd ) )

   ( dbfFacCliT )->( dbCloseArea() )
   ( dbfFacCliL )->( dbCloseArea() )
   ( dbfFacCliP )->( dbCloseArea() )
   ( dbfFacCliI )->( dbCloseArea() )
   ( dbfAntCliT )->( dbCloseArea() )
   ( tmpFacCliT )->( dbCloseArea() )
   ( tmpFacCliL )->( dbCloseArea() )
   ( tmpFacCliP )->( dbCloseArea() )
   ( tmpFacCliI )->( dbCloseArea() )

   if lSndFacCli





      ::oSender:SetText( "Comprimiendo facturas de clientes" )

      if ::oSender:lZipData( cFileNameFacturas )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end


   else

      ::oSender:SetText( "No hay facturas de clientes para enviar" )

   end





   ::oSender:SetText( "Enviando anticipos de clientes" )





   mkAntCli( cPatSnd() )





   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @tmpAntCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   if !Empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal  := ( dbfAntCliT )->( LastRec() )
   end

   while !( dbfAntCliT )->( eof() )

      if ( dbfAntCliT )->lSndDoc
         lSndAntCli        := .T.
         dbPass( dbfAntCliT, tmpAntCliT, .T. )
         ::oSender:SetText( ( dbfAntCliT )->cSerAnt + "/" + AllTRim( Str( ( dbfAntCliT )->nNumAnt ) ) + "/" + AllTrim( ( dbfAntCliT )->cSufAnt ) + "; " + Dtoc( ( dbfAntCliT )->dFecAnt ) + "; " + AllTrim( ( dbfAntCliT )->cCodCli ) + "; " + ( dbfAntCliT )->cNomCli )
      end

      ( dbfAntCliT )->( dbSkip() )

      if !Empty( ::oSender:oMtr )
         ::oSender:oMtr:Set( ( dbfAntCliT )->( OrdKeyNo() ) )
      end

   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfAntCliT )->( dbCloseArea() )
   ( tmpAntCliT )->( dbCloseArea() )

   if lSndAntCli





      ::oSender:SetText( "Comprimiendo anticipos de clientes" )

      if ::oSender:lZipData( cFileNameAnticipos )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay anticipos para enviar" )

   end

Return ( Self )



UTILITY STATIC function TFacturasClientesSenderReciver_RestoreData() ; local Self AS CLASS TFacturasClientesSenderReciver := QSelf() AS CLASS TFacturasClientesSenderReciver

   local oBlock
   local oError
   local dbfFacCliT
   local dbfAntCliT

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   if ::lSuccesfullSendFacturas

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliT.DBF" ), ( cCheckArea( "FacCliT", @dbfFacCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ( dbfFacCliT )->( OrdSetFocus( "lSndDoc" ) )

      while ( dbfFacCliT )->( dbSeek( .T. ) ) .AND. !( dbfFacCliT )->( eof() )
         if ( dbfFacCliT )->( dbRLock() )
            ( dbfFacCliT )->lSndDoc := .F.
            ( dbfFacCliT )->( dbRUnlock() )
         end
      end

      ( dbfFacCliT )->( dbCloseArea() )

   end

   if ::lSuccesfullSendAnticipos

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ( dbfAntCliT )->( OrdSetFocus( "lSndDoc" ) )

      while ( dbfAntCliT )->( dbSeek( .T. ) ) .AND. !( dbfAntCliT )->( eof() )
         if ( dbfAntCliT )->( dbRLock() )
            ( dbfAntCliT )->lSndDoc := .F.
            ( dbfAntCliT )->( dbRUnlock() )
         end
      end

      ( dbfAntCliT )->( dbCloseArea() )

   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

Return ( Self )



UTILITY STATIC function TFacturasClientesSenderReciver_SendData() ; local Self AS CLASS TFacturasClientesSenderReciver := QSelf() AS CLASS TFacturasClientesSenderReciver

   local cFileNameFacturas
   local cFileNameAnticipos

   if ::oSender:lServer
      cFileNameFacturas       := "FacCli" + StrZero( ::nGetFacturaNumberToSend(), 6 ) + ".All"
      cFileNameAnticipos      := "AntCli" + StrZero( ::nGetAnticipoNumberToSend(), 6 ) + ".All"
   else
      cFileNameFacturas       := "FacCli" + StrZero( ::nGetFacturaNumberToSend(), 6 ) + "." + RetSufEmp()
      cFileNameAnticipos      := "AntCli" + StrZero( ::nGetAnticipoNumberToSend(), 6 ) + "." + RetSufEmp()
   end

   ::lSuccesfullSendFacturas  := .F.
   ::lSuccesfullSendAnticipos := .F.





   if File( cPatOut() + cFileNameFacturas )

      if ftpSndFile( cPatOut() + cFileNameFacturas, cFileNameFacturas, 2000, ::oSender )
         ::lSuccesfullSendFacturas  := .T.
         ::oSender:SetText( "Fichero facturas de clientes enviados " + cFileNameFacturas )
      else
         ::oSender:SetText( "ERROR al enviar fichero de facturas de clientes" )
      end

   end





   if File( cPatOut() + cFileNameAnticipos )

      if ftpSndFile( cPatOut() + cFileNameAnticipos, cFileNameAnticipos, 2000, ::oSender )
         ::lSuccesfullSendAnticipos := .T.
         ::oSender:SetText( "Fichero anticipos de clientes enviados " + cFileNameAnticipos )
      else
         ::oSender:SetText( "ERROR al enviar fichero de anticipos de clientes" )
      end

   end

   if ::lSuccesfullSendFacturas
      ::IncFacturaNumberToSend()
   end

   if ::lSuccesfullSendAnticipos
      ::IncAnticipoNumberToSend()
   end

Return ( Self )



UTILITY STATIC function TFacturasClientesSenderReciver_ReciveData() ; local Self AS CLASS TFacturasClientesSenderReciver := QSelf() AS CLASS TFacturasClientesSenderReciver

   local n
   local aExt

   if ::oSender:lServer
      aExt  := aRetDlgEmp()
   else
      aExt  := { "All" }
   end





   ::oSender:SetText( "Recibiendo facturas y anticipos de clientes" )

   for n := 1 to len( aExt )
      ftpGetFiles( "FacCli*." + aExt[ n ], cPatIn(), 2000, ::oSender )
      ftpGetFiles( "AntCli*." + aExt[ n ], cPatIn(), 2000, ::oSender )
   next

   ::oSender:SetText( "Facturas y anticipos de clientes recibidos" )

Return Self



UTILITY STATIC function TFacturasClientesSenderReciver_Process() ; local Self AS CLASS TFacturasClientesSenderReciver := QSelf() AS CLASS TFacturasClientesSenderReciver

   local m
   local oStock
   local dbfFacCliT
   local dbfFacCliL
   local dbfFacCliP
   local dbfAntCliT
   local tmpFacCliT
   local tmpFacCliL
   local tmpFacCliP
   local tmpAntCliT
   local oBlock
   local oError
   local lClient     := ::oSender:lServer
   local aFiles      := Directory( cPatIn() + "FacCli*.*" )

   for m := 1 to len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      oBlock         := ErrorBlock( { | oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE





      if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )







         if file( cPatSnd() + "FacCliT.Dbf" ) .AND. file( cPatSnd() + "FacCliL.Dbf" ) .AND. file( cPatSnd() + "FacCliP.Dbf" )

            dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacCliT.DBF" ), ( cCheckArea( "FacCliT", @tmpFacCliT ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
            if !lAIS() ; ordListAdd( ( cPatSnd() + "FacCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacCliL.DBF" ), ( cCheckArea( "FacCliL", @tmpFacCliL ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
            if !lAIS() ; ordListAdd( ( cPatSnd() + "FacCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacCliP.DBF" ), ( cCheckArea( "FacCliP", @tmpFacCliP ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
            if !lAIS() ; ordListAdd( ( cPatSnd() + "FacCliP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliT.DBF" ), ( cCheckArea( "FacCliT", @dbfFacCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliL.DBF" ), ( cCheckArea( "FacCliL", @dbfFacCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliP.Dbf" ), ( cCheckArea( "FacCliP", @dbfFacCliP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfClient ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
            if !lAIS() ; ordListAdd( ( cPatCli() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            oStock            := TStock():New()
            oStock:cFacCliT   := dbfFacCliT
            oStock:cFacCliL   := dbfFacCliL

            while ( tmpFacCliT )->( !eof() )






               if lValidaOperacion( ( tmpFacCliT )->dFecFac, .F. ) .AND.  !( dbfFacCliT )->( dbSeek( ( tmpFacCliT )->cSerie + Str( ( tmpFacCliT )->nNumFac ) + ( tmpFacCliT )->cSufFac ) )

                  dbPass( tmpFacCliT, dbfFacCliT, .T. )

                  if lClient .AND. dbLock( dbfFacCliT )
                     ( dbfFacCliT )->lSndDoc := .F.
                     ( dbfFacCliT )->( dbUnLock() )
                  end

                  ::oSender:SetText( "Añadida factura     : " + ( tmpFacCliL )->cSerie + "/" + AllTrim( Str( ( tmpFacCliL )->nNumFac ) ) + "/" +  AllTrim( ( tmpFacCliL )->cSufFac ) + "; " + Dtoc( ( tmpFacCliT )->dFecFac ) + "; " + AllTrim( ( tmpFacCliT )->cCodCli ) + "; " + ( tmpFacCliT )->cNomCli )

                  if ( tmpFacCliL )->( dbSeek( ( tmpFacCliT )->cSerie + Str( ( tmpFacCliT )->nNumFac ) + ( tmpFacCliT )->cSufFac ) )
                     while ( tmpFacCliL )->cSerie + Str( ( tmpFacCliL )->nNumFac ) + ( tmpFacCliL )->cSufFac == ( tmpFacCliT )->cSerie + Str( ( tmpFacCliT )->nNumFac ) + ( tmpFacCliT )->cSufFac .AND. !( tmpFacCliL )->( eof() )
                        dbPass( tmpFacCliL, dbfFacCliL, .T. )
                        ( tmpFacCliL )->( dbSkip() )
                     end
                  end

               else

                  ::oSender:SetText( "Desestimada factura : " + ( tmpFacCliL )->cSerie + "/" + AllTrim( Str( ( tmpFacCliL )->nNumFac ) ) + "/" +  AllTrim( ( tmpFacCliL )->cSufFac ) + "; " + Dtoc( ( tmpFacCliT )->dFecFac ) + "; " + AllTrim( ( tmpFacCliT )->cCodCli ) + "; " + ( tmpFacCliT )->cNomCli )

               end

               ( tmpFacCliT )->( dbSkip() )

            end





            while ( tmpFacCliP )->( !eof() )

               if !( dbfFacCliP )->( dbSeek( ( tmpFacCliP )->cSerie + Str( ( tmpFacCliP )->nNumFac ) + ( tmpFacCliP )->cSufFac + Str( ( tmpFacCliP )->nNumRec ) ) )

                  dbPass( tmpFacCliP, dbfFacCliP, .T. )
                  ::oSender:SetText( "Añadido recibo     : " + ( tmpFacCliP )->cSerie + "/" + AllTrim( Str( ( tmpFacCliP )->nNumFac ) ) + "/" +  AllTrim( ( tmpFacCliP )->cSufFac ) + "-" + Str( ( tmpFacCliP )->nNumRec ) + "; " + Dtoc( ( tmpFacCliP )->dEntrada ) + "; " + AllTrim( ( tmpFacCliP )->cCodCli ) + "; " + RetClient( ( tmpFacCliP )->cCodCli, dbfClient ) )

               else

                  ::oSender:SetText( "Desestimado recibo : " + ( tmpFacCliP )->cSerie + "/" + AllTrim( Str( ( tmpFacCliP )->nNumFac ) ) + "/" +  AllTrim( ( tmpFacCliP )->cSufFac ) + "-" + Str( ( tmpFacCliP )->nNumRec ) + "; " + Dtoc( ( tmpFacCliP )->dEntrada ) + "; " + AllTrim( ( tmpFacCliP )->cCodCli ) + "; " + RetClient( ( tmpFacCliP )->cCodCli, dbfClient ) )

               end

               SysRefresh()

               ( tmpFacCliP )->( dbSkip() )

            end

            ( dbfFacCliT )->( dbCloseArea() )
            ( dbfFacCliL )->( dbCloseArea() )
            ( dbfFacCliP )->( dbCloseArea() )
            ( tmpFacCliT )->( dbCloseArea() )
            ( tmpFacCliL )->( dbCloseArea() )
            ( tmpFacCliP )->( dbCloseArea() )

            oStock:end()

            ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

         else

            ::oSender:SetText( "Faltan ficheros" )

            if !file( cPatSnd() + "FacCliT.Dbf" )
               ::oSender:SetText( "Falta" + cPatSnd() + "FacCliT.Dbf" )
            end

            if !file( cPatSnd() + "FacCliL.Dbf" )
               ::oSender:SetText( "Falta" + cPatSnd() + "FacCliL.Dbf" )
            end

            if !file( cPatSnd() + "FacCliP.Dbf" )
               ::oSender:SetText( "Falta" + cPatSnd() + "FacCliP.Dbf" )
            end

         end

      else

         ::oSender:SetText( "Error al descomprimir fichero " + cPatIn() + aFiles[ m, 1 ] )

      end

      RECOVER USING oError

         ( dbfFacCliT )->( dbCloseArea() )
         ( dbfFacCliL )->( dbCloseArea() )
         ( dbfFacCliP )->( dbCloseArea() )
         ( tmpFacCliT )->( dbCloseArea() )
         ( tmpFacCliL )->( dbCloseArea() )
         ( tmpFacCliP )->( dbCloseArea() )

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

   next





   ::oSender:SetText( "Recibiendo anticipos de clientes" )

   aFiles            := Directory( cPatIn() + "AntCli*.*" )

   for m := 1 to len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      oBlock         := ErrorBlock( { | oError | ApoloBreak( oError ) } )

      BEGIN SEQUENCE

         if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )





            if file( cPatSnd() + "AntCliT.DBF" )

               dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @tmpAntCliT ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
               if !lAIS() ; ordListAdd( ( cPatSnd() + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               while ( tmpAntCliT )->( !eof() )





                  if !( dbfAntCliT )->( dbSeek( ( tmpAntCliT )->CSERANT + Str( ( tmpAntCliT )->NNUMANT ) + ( tmpAntCliT )->CSUFANT ) )
                     dbPass( tmpAntCliT, dbfAntCliT, .T. )

                     if lClient .AND. dbLock( dbfAntCliT )
                        ( dbfAntCliT )->lSndDoc := .F.
                        ( dbfAntCliT )->( dbUnLock() )
                     end

                     ::oSender:SetText( "Añadido     : " + ( tmpAntCliT )->cSerAnt + "/" + AllTrim( Str( ( tmpAntCliT )->NNUMANT ) ) + "/" + AllTrim( ( tmpAntCliT )->CSUFANT ) + "; " + Dtoc( ( tmpAntCliT )->DFECANT ) + "; " + Alltrim( ( tmpAntCliT )->cCodCli ) + "; " + ( tmpAntCliT )->cNomCli )
                  else
                     if dbLock( dbfAntCliT )
                        ( dbfAntCliT )->lLiquidada := ( tmpAntCliT )->lLiquidada
                        ( dbfAntCliT )->dLiquidada := ( tmpAntCliT )->dLiquidada
                        ( dbfAntCliT )->cNumDoc    := ( tmpAntCliT )->cNumDoc
                        ( dbfAntCliT )->( dbUnLock() )
                     end

                     ::oSender:SetText( "Actualizado : " + ( tmpAntCliT )->cSerAnt + "/" + AllTrim( Str( ( tmpAntCliT )->NNUMANT ) ) + "/" + AllTrim( ( tmpAntCliT )->CSUFANT ) + "; " + Dtoc( ( tmpAntCliT )->DFECANT ) + "; " + Alltrim( ( tmpAntCliT )->cCodCli ) + "; " + ( tmpAntCliT )->cNomCli )
                  end

                  SysRefresh()

                  ( tmpAntCliT )->( dbSkip() )

               end

               ( dbfAntCliT )->( dbCloseArea() )
               ( tmpAntCliT )->( dbCloseArea() )

               ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

            else

               ::oSender:SetText( "Falta " + cPatSnd() + "AntCliT.Dbf" )

            end

         else

               ::oSender:SetText( "Error al descomprimir fichero " + cPatIn() + aFiles[ m, 1 ] )

         end

      RECOVER USING oError

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

   next

Return Self






function nTotRFacCli( cNumFac, dFecRes, cCodArt, cValPr1, cValPr2, cLote, dbfFacCliT, dbfFacCliL )

   local nTot        := 0
   local aStaFac     := aGetStatus( dbfFacCliT, .T. )
   local aStaLin     := aGetStatus( dbfFacCliL, .F. )

   IIF( cValPr1 == nil, cValPr1 := Space( 10 ), ) ;
   IIF( cValPr2 == nil, cValPr2 := Space( 10 ), ) ;

   ( dbfFacCliL )->( dbGoTop() )

   if ( dbfFacCliL )->( dbSeek( cNumFac ) )
      while ( dbfFacCliL )->cSerie + str( ( dbfFacCliL )->nNumFac, 9 ) + ( dbfFacCliL )->cSufFac == cNumFac .AND. !( dbfFacCliL )->( eof() )
         if ( dbfFacCliL )->cRef + ( dbfFacCliL )->cValPr1 + ( dbfFacCliL )->cValPr2 == cCodArt + cValPr1 + cValPr2
            if Empty( dFecRes ) .OR. dFecRes <= dFecFacCli( ( dbfFacCliL )->cSerFac + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac, dbfFacCliT )
               if ( dbfFacCliL )->cLote == cLote
                  nTot  += nTotNFacCli( dbfFacCliL )
               end
            end
         end
         ( dbfFacCliL )->( dbSkip() )
      end
   end

   SetStatus( dbfFacCliT, aStaFac )
   SetStatus( dbfFacCliL, aStaLin )

return ( nTot )



function nUnidadesRecibidasFacCli( cNumPed, cCodArt, cCodPr1, cCodPr2, dbfFacCliL )

   local nTot        := 0
   local aStaLin     := aGetStatus( dbfFacCliL, .F. )

   IIF( cCodPr1 == nil, cCodPr1 := Space( 10 ), ) ;
   IIF( cCodPr2 == nil, cCodPr2 := Space( 10 ), ) ;

   ( dbfFacCliL )->( OrdSetFocus( "cNumPedRef" ) )

   if ( dbfFacCliL )->( dbSeek( cNumPed + cCodArt ) )
      while ( dbfFacCliL )->cNumPed + ( dbfFacCliL )->cRef + ( dbfFacCliL )->cCodPr1 + ( dbfFacCliL )->cCodPr2 == cNumPed + cCodArt + cCodPr1 + cCodPr2 .AND. !( dbfFacCliL )->( eof() )
         nTot     += nTotNFacCli( dbfFacCliL )
         ( dbfFacCliL )->( dbSkip() )
      end
   end

   SetStatus( dbfFacCliL, aStaLin )

return ( nTot )



Static Function EdtRecMenu( aTmp, oDlg )

   oMenu := MenuBegin( .F.,,, .F., .F. )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F. )

         MenuBegin( .F.,,, .F., .F. )

            if !lExternal




            MenuAddItem( "&1. Visualizar presupuesto", "Visualiza el presupueso del que proviene", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 39 ] ), ZooPreCli( aTmp[ 39 ] ), MsgStop( "No hay presupusto asociado" ) ) )},, "Notebook_User1_16",,,,, .F.,,, .F. )

            MenuAddItem()





            MenuAddItem( "&2. Visualizar pedido", "Visualiza el pedido del que proviene", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 38 ] ), ZooPedCli( aTmp[ 38 ] ), MsgStop( "No hay pedido asociado" ) ) )},, "Clipboard_Empty_User1_16",,,,, .F.,,, .F. )
            MenuAddItem()





            MenuAddItem( "&3. Visualizar albarán", "Visualiza el albarán del que proviene", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 37 ] ), ZooAlbCli( aTmp[ 37 ] ), MsgStop( "No hay albarán asociado" ) ) )},, "Document_Plain_User1_16",,,,, .F.,,, .F. )
            MenuAddItem()




            MenuAddItem( "&4. Generar anticipo", "Genera factura de anticipo", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), CreateAntCli( aTmp[ 6 ] ), msgStop("Debe seleccionar un cliente para hacer una factura de anticipo" ) ) )},, "Document_Money2_16",,,,, .F.,,, .F. )




            MenuAddItem( "&5. Modificar cliente", "Modifica la ficha del cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), EdtCli( aTmp[ 6 ] ), MsgStop( "Código de cliente vacío" ) ) )},, "User1_16",,,,, .F.,,, .F. )





            MenuAddItem( "&6. Informe de cliente", "Informe de cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), InfCliente( aTmp[ 6 ] ), MsgStop( "Código de cliente vacío" ) ) )},, "Info16",,,,, .F.,,, .F. )




            MenuAddItem( "&7. Modificar obra", "Modifica ficha de la obra", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 22 ] ), EdtObras( aTmp[ 6 ], aTmp[ 22 ], dbfObrasT ), MsgStop( "Código de obra vacío" ) ) )},, "Worker16",,,,, .F.,,, .F. )
            MenuAddItem()

            end





            MenuAddItem( "&8. Informe del documento", "Informe del documento", .F.,, {|oMenuItem|( TTrazaDocumento():Activate( "11", aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ] ) )},, "Info16",,,,, .F.,,, .F. )
         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMenu )

RETURN ( oMenu )



Static Function nEstadoIncidencia( cNumFac )

   local nEstado  := 0
   local aBmp     := ""

   if ( dbfFacCliI )->( dbSeek( cNumFac ) )

      while ( dbfFacCliI )->cSerie + Str( ( dbfFacCliI )->nNumFac ) + ( dbfFacCliI )->cSufFac == cNumFac .AND. !( dbfFacCliI )->( Eof() )

         if ( dbfFacCliI )->lListo
            do case
               case nEstado == 0 .OR. nEstado == 3
                    nEstado := 3
               case nEstado == 1
                    nEstado := 2
            end
         else
            do case
               case nEstado == 0
                    nEstado := 1
               case nEstado == 3
                    nEstado := 2
            end
         end

         ( dbfFacCliI )->( dbSkip() )

      end

   end

Return ( nEstado )





FUNCTION BrwFacCli( oGet, oIva )

    local oDlg
    local oBrw
   local oGet1
   local cGet1
   local oCbxOrd
   local cCbxOrd
   local nOrd
   local aCbxOrd

   if !OpenFiles()
      Return .F.
   end

   aCbxOrd           := { "Número", "Fecha", "Cliente", "Nombre" }
   nOrd              := GetBrwOpt( "BrwFacCli" )
   nOrd              := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrd ]

   oDlg = TDialog():New(,,,, "Facturas de clientes", "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F., )






        oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, dbfFacCliT ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, dbfFacCliT, nil, nil, .F. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( dbfFacCliT )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:refresh(), oGet1:SetFocus() )},,,, .F.,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := dbfFacCliT
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Factura de cliente.Browse"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( dbfFacCliT )->cSerie + "/" + RTrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + ( dbfFacCliT )->cSufFac }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecFac"
         :bEditValue       := {|| Dtoc( ( dbfFacCliT )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Cliente"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| Rtrim( ( dbfFacCliT )->cCodCli ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| Rtrim( ( dbfFacCliT )->cNomCli ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotFacCli( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT, nil, cDivEmp(), .T. ) }
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end





        TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )





        TButton():ReDefine( 501, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )




        TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      oGet:cText( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac )

      oGet:bWhen   := {|| .F. }

      if !Empty( oIva )
         oIva:Click( ( dbfFacCliT )->lIvaInc ):Refresh()
      end

   end

   SetBrwOpt( "BrwFacCli", ( dbfFacCliT )->( OrdNumber() ) )

   ( dbfFacCliT )->( dbClearFilter() )

   CloseFiles()





   oBrw:CloseData()

RETURN ( oDlg:nResult == 1 )







Function AppFacCli( cCodCli, cCodArt, lOpenBrowse )

   local nLevel         := nLevelUsr( "01058" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 2 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FactCli( nil, nil, cCodCli, cCodArt )
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( .T. )
         nTotFacCli()
         WinAppRec( nil, bEdtRec, dbfFacCliT, cCodCli, cCodArt )
         CloseFiles()
      end

   end

RETURN .T.



Function EdtFacCli( cNumFac, lOpenBrowse )

   local nLevel         := nLevelUsr( "01058" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FactCli()
         if dbSeekInOrd( cNumFac, "nNumFac", dbfFacCliT )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumFac, "nNumFac", dbfFacCliT )
            nTotFacCli()
            WinEdtRec( nil, bEdtRec, dbfFacCliT )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION ZooFacCli( cNumFac, lOpenBrowse )

   local nLevel         := nLevelUsr( "01058" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FactCli()
         if dbSeekInOrd( cNumFac, "nNumFac", dbfFacCliT )
            oWndBrw:RecZoom()
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( cNumFac, "nNumFac", dbfFacCliT )
            nTotFacCli()
            WinZooRec( nil, bEdtRec, dbfFacCliT )
         end
         CloseFiles()
      end

   end

Return .T.



FUNCTION DelFacCli( cNumFac, lOpenBrowse )

   local nLevel         := nLevelUsr( "01058" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 16 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FactCli()
         if dbSeekInOrd( cNumFac, "nNumFac", dbfFacCliT )
            WinDelRec( nil, dbfFacCliT, {|| QuiFacCli() } )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumFac, "nNumFac", dbfFacCliT )
            nTotFacCli()
            WinDelRec( nil, dbfFacCliT, {|| QuiFacCli() } )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION PrnFacCli( cNumFac, lOpenBrowse, cCaption, cFormato, cPrinter )

   local nLevel         := nLevelUsr( "01058" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FactCli()
         if dbSeekInOrd( cNumFac, "nNumFac", dbfFacCliT )
            GenFacCli( 1, cCaption, cFormato, cPrinter )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumFac, "nNumFac", dbfFacCliT )
            GenFacCli( 1, cCaption, cFormato, cPrinter )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION VisFacCli( cNumFac, lOpenBrowse, cCaption, cFormato, cPrinter )

   local nLevel         := nLevelUsr( "01058" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FactCli()
         if dbSeekInOrd( cNumFac, "nNumFac", dbfFacCliT )
            GenFacCli( 2, cCaption, cFormato, cPrinter )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumFac, "nNumFac", dbfFacCliT )
            GenFacCli( 2, cCaption, cFormato, cPrinter )
         end

         CloseFiles()

      end

   end

Return .T.



Function ExcelIsra()

   local n
   local dFecFac     := ""
   local nNumFac     := ""
   local nImpFac     := 0
   local oOleExcel
   local cFileExcel  := cGetFile( "Excel ( *.Xls ) | " + "*.Xls", "Seleccione la hoja de calculo" )

   if File( cFileExcel )

      CreateWaitMeter( "Importando de Excel", "Hoja para Servital", 365 )

      oOleExcel      := CreateObject( "Excel.Application" )

      oOleExcel:Visible       := .F.
      oOleExcel:DisplayAlerts := .F.
      oOleExcel:WorkBooks:Open( cFileExcel )

      oOleExcel:WorkSheets( 1 ):Activate()

      for n := 1 to 365

         dFecFac  := oOleExcel:ActiveSheet:Range( "A" + lTrim( Str( n ) ) ):Text
         dFecFac  := Ctod( dFecFac )
         nNumFac  := oOleExcel:ActiveSheet:Range( "B" + lTrim( Str( n ) ) ):Text
         nNumFac  := Val( nNumFac )
         nImpFac  := oOleExcel:ActiveSheet:Range( "C" + lTrim( Str( n ) ) ):Value

         if !Empty( nNumFac )

            if dbAppe( dbfFacCliT )
               ( dbfFacCliT )->cSerie     := "A"
               ( dbfFacCliT )->nNumFac    := nNumFac
               ( dbfFacCliT )->cSufFac    := RetSufEmp()
               ( dbfFacCliT )->lLiquidada := .T.
               ( dbfFacCliT )->dFecFac    := dFecFac
               ( dbfFacCliT )->cCodAlm    := oUser():cAlmacen()
               ( dbfFacCliT )->cCodCaj    := oUser():cCaja()
               ( dbfFacCliT )->cCodPago   := cDefFpg()
               ( dbfFacCliT )->cDivFac    := cDivEmp()
               ( dbfFacCliT )->nVdvFac    := nChgDiv( cDivEmp(), dbfDiv )
               ( dbfFacCliT )->cCodUsr    := cCurUsr()
               ( dbfFacCliT )->cTurFac    := cCurSesion()
               ( dbfFacCliT )->( dbUnLock() )
            end

            if dbAppe( dbfFacCliL )
               ( dbfFacCliL )->cSerie     := "A"
               ( dbfFacCliL )->nNumFac    := nNumFac
               ( dbfFacCliL )->cSufFac    := RetSufEmp()
               ( dbfFacCliL )->nUniCaja   := 1
               ( dbfFacCliL )->nPreUnit   := nImpFac
               ( dbfFacCliL )->( dbUnLock() )
            end

            if dbAppe( dbfFacCliP )
               ( dbfFacCliP )->cSerie     := "A"
               ( dbfFacCliP )->nNumFac    := nNumFac
               ( dbfFacCliP )->cSufFac    := RetSufEmp()
               ( dbfFacCliP )->nNumRec    := 1
               ( dbfFacCliP )->lCobrado   := .T.
               ( dbfFacCliP )->nImporte   := nImpFac
               ( dbfFacCliP )->nImpCob    := nImpFac
               ( dbfFacCliP )->cDescrip   := "Recibo nº 1 de factura A/" + AllTrim( Str( nNumFac ) ) + "/" + RetSufEmp()
               ( dbfFacCliP )->cDivPgo    := cDivEmp()
               ( dbfFacCliP )->nVdvPgo    := nChgDiv( cDivEmp(), dbfDiv )
               ( dbfFacCliP )->dEntrada   := dFecFac
               ( dbfFacCliP )->dPreCob    := dFecFac
               ( dbfFacCliP )->( dbUnLock() )
            end

         end

         RefreshWaitMeter( n )

      next

      oOleExcel:DisplayAlerts := .T.
      oOleExcel:Quit()

      EndWaitMeter()

   end

Return nil



Static Function DesgPnt( cCodArt, aTmp, nTarifa, oPreDiv, oCosDiv, nMode )

   local oDlg
   local oPuntos
   local oValorPunto
   local oDtoPnt
   local oIncPnt
   local oImporte
   local nPuntos     := 0
   local nValorPunto := 0
   local nDtoPnt     := 0
   local nIncPnt     := 0



   if Empty( cCodArt )
      MsgInfo( "Debe seleccinar un artículo", "Código vacío" )
      return .F.
   end



   nPuntos           := aTmp[ 62 ]
   nValorPunto       := aTmp[ 63 ]
   nDtoPnt           := aTmp[ 64 ]
   nIncPnt           := aTmp[ 65 ]

   oDlg = TDialog():New(,,,, "Desglose de puntos", "DESGPUNTOS",, .F.,,,,,, .F.,,,,,, .F., )







   oPuntos := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, nPuntos, nPuntos:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,,,,, nil,,, )







   oValorPunto := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, nValorPunto, nValorPunto:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,,,,, nil,,, )









   oDtoPnt := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nDtoPnt, nDtoPnt:= u ) }, oDlg,, "999.99",,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,, {||      0}, {||      100},, nil,,, )









   oIncPnt := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, nIncPnt, nIncPnt:= u ) }, oDlg,, "999.99",,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,, {||      0}, {||      100},, nil,,, )




   oImporte := TSay():ReDefine( 240, {|| nCalculoPuntos( nPuntos, nValorPunto, nDtoPnt, nIncPnt )}, oDlg, cPouDiv,,, .F.,, .F., .F. )





   TButton():ReDefine( 500, {||( EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, dbfArticulo, nDouDiv ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




   TButton():ReDefine( 550, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, dbfArticulo, nDouDiv ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1
      aTmp[ 62 ]     := nPuntos
      aTmp[ 63 ]     := nValorPunto
      aTmp[ 64 ]     := nDtoPnt
      aTmp[ 65 ]     := nIncPnt
      oCosDiv:cText( oImporte:VarGet() )
      oCosDiv:Refresh()
   end

Return ( .T. )



Static Function FacCliNotas()

   local cObserv  := ""
   local aData    := {}

   aAdd( aData, "Factura " + ( dbfFacCliT )->cSerie + "/" + AllTrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + Alltrim( ( dbfFacCliT )->cSufFac ) + " de " + Rtrim( ( dbfFacCliT )->cNomCli ) )
   aAdd( aData, "11" )
   aAdd( aData, ( dbfFacCliT )->cCodCli )
   aAdd( aData, ( dbfFacCliT )->cNomCli )
   aAdd( aData, ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac )

   if ( dbfClient )->( dbSeek( ( dbfFacCliT )->cCodCli ) )

      if !Empty( ( dbfClient )->cPerCto )
         cObserv  += Rtrim( ( dbfClient )->cPerCto ) + Space( 1 )
      end

      if !Empty( ( dbfClient )->Telefono )
         cObserv  += "Télefono : " + Rtrim( ( dbfClient )->Telefono ) + Space( 1 )
      end

      if !Empty( ( dbfClient )->Movil )
         cObserv  += "Móvil : " + Rtrim( ( dbfClient )->Movil ) + Space( 1 )
      end

      if !Empty( ( dbfClient )->Fax )
         cObserv  += "Fax : " + Rtrim( ( dbfClient )->Fax ) + Space( 1 )
      end

   end

   aAdd( aData, cObserv )

   GenerarNotas( aData )

Return ( nil )
































































































































































STATIC FUNCTION DupSerie( oWndBrw )

   local oDlg
   local oSerIni
   local oSerFin
   local oTxtDup
   local nTxtDup     := 0
   local nRecno      := ( dbfFacCliT )->( Recno() )
   local nOrdAnt     := ( dbfFacCliT )->( OrdSetFocus( 1 ) )
   local oDesde      := TDesdeHasta():Init( ( dbfFacCliT )->cSerie, ( dbfFacCliT )->nNumFac, ( dbfFacCliT )->cSufFac, GetSysDate() )
   local lCancel     := .F.
   local oBtnAceptar
   local oBtnCancel
   local oFecDoc
   local cFecDoc     := GetSysDate()
   local oActual
   local lActual     := .F.




   oDlg = TDialog():New(,,,, "Duplicar series de facturas", "DUPSERDOC",, .F.,,,,, oWndBrw, .F.,,,,,, .F., )



   TRadMenu():Redefine( { | u | If( PCount()==0, oDesde:nRadio, oDesde:nRadio:= u ) }, oDlg,, { 90, 91 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, oDesde:cSerieInicio, oDesde:cSerieInicio:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieInicio >= "A" .AND. oDesde:cSerieInicio <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, oDesde:cSerieFin, oDesde:cSerieFin:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieFin >= "A" .AND. oDesde:cSerieFin <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, oDesde:nNumeroInicio, oDesde:nNumeroInicio:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, oDesde:nNumeroFin, oDesde:nNumeroFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, oDesde:cSufijoInicio, oDesde:cSufijoInicio:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, oDesde:cSufijoFin, oDesde:cSufijoFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 170, { | u | If( PCount()==0, oDesde:dFechaInicio, oDesde:dFechaInicio:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 180, { | u | If( PCount()==0, oDesde:dFechaFin, oDesde:dFechaFin:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )



   oActual := TCheckBox():ReDefine( 210, { | u | If( PCount()==0, lActual, lActual:= u ) }, oDlg,,,,,,, .F.,, .F. )




   oFecDoc := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, cFecDoc, cFecDoc:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   oBtnAceptar := TButton():ReDefine( 1, {||( DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, lActual, cFecDoc ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( lCancel := .T., oDlg:end() )}, oDlg,,, .F.,,,, .T. )





   oTxtDup := TMeter():ReDefine( 160, { | u | If( PCount()==0, nTxtDup, nTxtDup:= u ) }, ( dbfFacCliT )->( OrdKeyCount() ), oDlg, .F.,,, .T.,,,, )

      oDlg:AddFastKey( 116, {|| DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, lActual, cFecDoc ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T., {|Self|( lCancel )},,, oDlg:bRClicked,,, )

   ( dbfFacCliT )->( dbGoTo( nRecNo ) )
   ( dbfFacCliT )->( ordSetFocus( nOrdAnt ) )

   oWndBrw:SetFocus()
   oWndBrw:Refresh()

RETURN NIL



STATIC FUNCTION DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, lCancel, lActual, cFecDoc )

   local nOrd
   local nDuplicados    := 0
   local nProcesed      := 0

   oBtnAceptar:Hide()
   oBtnCancel:bAction   := {|| lCancel := .T. }

   if oDesde:nRadio == 1

      nOrd              := ( dbfFacCliT )->( OrdSetFocus( "nNumFac" ) )

      ( dbfFacCliT )->( dbSeek( oDesde:cNumeroInicio(), .T. ) )

      while !lCancel .AND. ( dbfFacCliT )->( !eof() )






         if ( dbfFacCliT )->cSerie  >= oDesde:cSerieInicio  .AND. ( dbfFacCliT )->cSerie  <= oDesde:cSerieFin     .AND. ( dbfFacCliT )->nNumFac >= oDesde:nNumeroInicio .AND. ( dbfFacCliT )->nNumFac <= oDesde:nNumeroFin    .AND. ( dbfFacCliT )->cSufFac >= oDesde:cSufijoInicio .AND. ( dbfFacCliT )->cSufFac <= oDesde:cSufijoFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( dbfFacCliT )->cSerie + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + ( dbfFacCliT )->cSufFac

            DupFactura( lActual, cFecDoc )

         end

         ( dbfFacCliT )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( dbfFacCliT )->( OrdSetFocus( nOrd ) )

   else

      nOrd              := ( dbfFacCliT )->( OrdSetFocus( "dFecFac" ) )

      ( dbfFacCliT )->( dbSeek( oDesde:dFechaInicio, .T. ) )

      while !lCancel .AND. ( dbfFacCliT )->( !eof() )


         if ( dbfFacCliT )->dFecFac >= oDesde:dFechaInicio  .AND. ( dbfFacCliT )->dFecFac <= oDesde:dFechaFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( dbfFacCliT )->cSerie + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + ( dbfFacCliT )->cSufFac

            DupFactura( lActual, cFecDoc )

         end

         ( dbfFacCliT )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( dbfFacCliT )->( OrdSetFocus( nOrd ) )

   end

   lCancel              := .T.

   oBtnAceptar:Show()

   if lCancel
      msgStop( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso cancelado" )
   else
      msgInfo( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso finalizado" )
   end

RETURN ( oDlg:End() )



STATIC FUNCTION FacRecDup( cDbf, xField1, xField2, xField3, lCab, lPag, lActual, cFecDoc )

   local nRec           := ( cDbf )->( Recno() )
   local aTabla         := {}
   local nOrdAnt

   IIF( lCab == nil, lCab := .F., ) ;
   IIF( lPag == nil, lPag := .F., ) ;
   IIF( lActual == nil, lActual := .F., ) ;

   aTabla               := DBScatter( cDbf )
   aTabla[ 1  ]   := xField1
   aTabla[ 2 ]   := xField2
   aTabla[ 3 ]   := xField3

   if lCab

      if !lActual
         aTabla[ 5  ]  := cFecDoc
      end

      aTabla[ 4     ]  := cCurSesion()
      aTabla[ 8     ]  := oUser():cCaja()
      aTabla[ 25     ]  := .F.
      aTabla[ 26     ]  := Ctod("")
      aTabla[ 28     ]  := .F.
      aTabla[ 37     ]  := Space( 12 )
      aTabla[ 38     ]  := Space( 12 )
      aTabla[ 39     ]  := Space( 12 )
      aTabla[ 75     ]  := Space( 12 )
      aTabla[ 76     ]  := Space( 12 )
      aTabla[ 59     ]  := .T.
      aTabla[ 67     ]  := Space( 10 )
      aTabla[ 74     ]  := .F.
      aTabla[ 79     ]  := cCurUsr()
      aTabla[ 80     ]  := GetSysDate()
      aTabla[ 81     ]  := Time()
      aTabla[ 83  ]  := .F.
      aTabla[ 84     ]  := Ctod("")
      aTabla[ 85     ]  := Space( 5 )
      aTabla[ 86     ]  := oUser():cDelegacion()

      nOrdAnt                 := ( cDbf )->( OrdSetFocus( "NNUMFAC" ) )

   end

   if lPag

      if !lActual
         aTabla[ ( dbfFacCliP )->( FieldPos( "dPreCob") )  ]      := cFecDoc
         if aTabla[ ( dbfFacCliP )->( FieldPos( "lCobrado" ) ) ]
            aTabla[ ( dbfFacCliP )->( FieldPos( "dEntrada" ) ) ]  := cFecDoc
         else
            aTabla[ ( dbfFacCliP )->( FieldPos( "dEntrada" ) ) ]  := Ctod("")
         end
      end

      aTabla[ ( dbfFacCliP )->( FieldPos( "cCodCaj" ) )  ]  := oUser():cCaja()
      aTabla[ ( dbfFacCliP )->( FieldPos( "cTurRec" ) )  ]  := cCurSesion()

      aTabla[ ( dbfFacCliP )->( FieldPos( "lConPgo" ) )  ]  := .F.
      aTabla[ ( dbfFacCliP )->( FieldPos( "lRecImp" ) )  ]  := .F.
      aTabla[ ( dbfFacCliP )->( FieldPos( "lRecDto" ) )  ]  := .F.
      aTabla[ ( dbfFacCliP )->( FieldPos( "dFecDto" ) )  ]  := Ctod("")
      aTabla[ ( dbfFacCliP )->( FieldPos( "lCloPgo" ) )  ]  := .F.
      aTabla[ ( dbfFacCliP )->( FieldPos( "dFecImp" ) )  ]  := Ctod("")
      aTabla[ ( dbfFacCliP )->( FieldPos( "cHorImp" ) )  ]  := Space( 5 )
      aTabla[ ( dbfFacCliP )->( FieldPos( "dFecVto" ) )  ]  := cFecDoc

   end

   if dbLock( cDbf, .T. )
      aEval( aTabla, { | uTmp, n | ( cDbf )->( fieldPut( n, uTmp ) ) } )
      ( cDbf )->( dbUnLock() )
   end

   if lCab
      ( cDbf )->( OrdSetFocus( nOrdAnt ) )
   end

   ( cDbf )->( dbGoTo( nRec ) )

RETURN ( .T. )



STATIC FUNCTION DupFactura( lActual, cFecDoc )

   local nNewNumFac  := 0



   nNewNumFac  := nNewDoc( ( dbfFacCliT )->cSerie, dbfFacCliT, "NFACCLI", , dbfCount )



   FacRecDup( dbfFacCliT, ( dbfFacCliT )->cSerie, nNewNumFac, ( dbfFacCliT )->cSufFac, .T., .F., lActual, cFecDoc )



   if ( dbfFacCliL )->( dbSeek( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) )


      while ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac == ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac .AND.  !( dbfFacCliL )->( Eof() )

            FacRecDup( dbfFacCliL, ( dbfFacCliT )->cSerie, nNewNumFac, ( dbfFacCliT )->cSufFac, .F., .F. )

         ( dbfFacCliL )->( dbSkip() )

      end

   end



   if ( dbfFacCliP )->( dbSeek( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) )


      while ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac == ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac .AND.  !( dbfFacCliP )->( Eof() )

            FacRecDup( dbfFacCliP, ( dbfFacCliT )->cSerie, nNewNumFac, ( dbfFacCliT )->cSufFac, .F., .T., lActual, cFecDoc )

         ( dbfFacCliP )->( dbSkip() )

      end

   end



   if ( dbfFacCliD )->( dbSeek( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) )


      while ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac == ( dbfFacCliD )->cSerie + Str( ( dbfFacCliD )->nNumFac ) + ( dbfFacCliD )->cSufFac .AND.  !( dbfFacCliD )->( Eof() )

            FacRecDup( dbfFacCliD, ( dbfFacCliT )->cSerie, nNewNumFac, ( dbfFacCliT )->cSufFac, .F., .T. )

         ( dbfFacCliD )->( dbSkip() )

      end

   end

RETURN ( .T. )





STATIC FUNCTION SetDialog( aGet, oSayDias, oSayGetRnt, oGetRnt )

   if !Empty( oTipFac )

      if oTipFac:nAt == 2
         aGet[ 89 ]:Show()
         aGet[ 90  ]:Show()
         oSayDias:Show()
      else
         aGet[ 89 ]:Hide()
         aGet[ 90  ]:Hide()
         oSayDias:Hide()
      end

      aGet[ 89 ]:Refresh()
      aGet[ 90  ]:Refresh()

      oSayDias:Refresh()

   end

   if !lAccArticulo() .OR. oUser():lNotRentabilidad()

      if !Empty( oSayGetRnt )
         oSayGetRnt:Hide()
      end

      if !Empty( oGetRnt )
         oGetRnt:Hide()
      end

   end

Return nil



STATIC FUNCTION ValidaMedicion( aTmp, aGet )

   local cNewUndMed  := aGet[ 16 ]:VarGet





   if ( Empty( cOldUndMed ) .OR. cOldUndMed <> cNewUndMed )

      if oUndMedicion:oDbf:Seek( aTmp[ 16 ] )

         if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
            if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:cText( ( dbfArticulo )->nLngArt )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:Show()
            else
               aTmp[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]  := ( dbfArticulo )->nLngArt
            end
         else
            if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:Hide()
            else
               aTmp[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
            if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:cText( ( dbfArticulo )->nAltArt )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:Show()
            else
               aTmp[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]  := ( dbfArticulo )->nAltArt
            end
         else
            if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:Hide()
            else
                 aTmp[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
            if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:cText( ( dbfArticulo )->nAncArt )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:Show()
            else
               aTmp[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]  := ( dbfArticulo )->nAncArt
            end
         else
            if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:Hide()
            else
               aTmp[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]  := 0
            end
         end

      else

         if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ] )
            aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:Hide()
            aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ] )
            aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:Hide()
            aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ] )
            aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:Hide()
            aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
         end

      end

      cOldUndMed := cNewUndMed

   end

RETURN .T.



Static Function ChangeTarifa( aTmp, aGet, aTmpFac )

    local nPrePro  := 0

   if !aTmp[ 69 ]

      nPrePro     := nPrePro( aTmp[ 4 ], aTmp[ 28 ], aTmp[ 30 ], aTmp[ 29 ], aTmp[ 31 ], aTmp[ 77 ], aTmpFac[ 58 ], dbfArtDiv, aTmpFac[ 21 ] )

      if nPrePro == 0
         nPrePro  := nRetPreArt( aTmp[ 77 ], aTmpFac[ 60 ], aTmpFac[ 58 ], dbfArticulo, dbfDiv, dbfKit, dbfIva )
      end

      if nPrePro <> 0
         aGet[ 6 ]:cText( nPrePro )
      end

   else

      aGet[ 6 ]:cText( 0 )
      aGet[ 72  ]:cText( nPreAlq( aTmp[ 4 ], aTmp[ 77 ], aTmpFac[ 58 ], dbfArticulo ) )

   end

return .T.



Function NewLineReport( oReport )

   oReport:NewLine()

Return ( "" )



Static Function LoadTrans( aTmp, oGetCod, oGetKgs, oSayTrn )

   local uValor   := oGetCod:VarGet()

   if Empty( uValor )

      oSayTrn:cText( "" )
      oGetKgs:cText( 0 )

   else

      if oTrans:oDbf:SeekInOrd( uValor, "cCodTrn" )
         oGetCod:cText( uValor )
         oSayTrn:cText( oTrans:oDbf:cNomTrn )
         oGetKgs:cText( oTrans:oDbf:nKgsTrn )
      else
         msgStop( "Código de transportista no encontrado." )
         Return .F.
      end

   end

   RecalculaTotal( aTmp )

Return .T.



function SynFacCli( cPath )

   local oBlock
   local oError
   local cCodFam
   local aTotFac
   local cCodTip
   local cCodImp
   local cNumSer
   local aNumSer

   IIF( cPath == nil, cPath := cPatEmp(), ) ;

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      dbUseArea( .T., ( cDriver() ), ( cPath + "PedCliT.DBF" ), ( cCheckArea( "PedCliT", @dbfPedCliT ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPath + "PedCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "PedCliL.DBF" ), ( cCheckArea( "PedCliL", @dbfPedCliL ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPath + "PedCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "AlbCliL.DBF" ), ( cCheckArea( "AlbCliL", @dbfAlbCliL ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPath + "AlbCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "FacCliT.DBF" ), ( cCheckArea( "FacCliT", @dbfFacCliT ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPath + "FacCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "FacCliL.DBF" ), ( cCheckArea( "FacCliL", @dbfFacCliL ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPath + "FacCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "FacCliS.Dbf" ), ( cCheckArea( "FacCliS", @dbfFacCliS ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPath + "FacCliS.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "FacCliI.DBF" ), ( cCheckArea( "FacCliI", @dbfFacCliI ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPath + "FacCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "FacCliP.DBF" ), ( cCheckArea( "FacCliP", @dbfFacCliP ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPath + "FacCliP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPath + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "Client.DBF" ), ( cCheckArea( "Client", @dbfClient ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "Client.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      oNewImp              := TNewImp():Create( cPath )
      if !oNewImp:OpenFiles()
         lOpenFiles        := .F.
      end

      oStock               := TStock():Create( cPath )
      if !oStock:lOpenFiles()
         lOpenFiles        := .F.
      else
         oStock:cPedCliT   := dbfPedCliT
         oStock:cPedCliL   := dbfPedCliL
         oStock:cAlbCliL   := dbfAlbCliL
         oStock:cFacCliL   := dbfFacCliL
      end

      while !( dbfFacCliT )->( eof() )

         if Empty( ( dbfFacCliT )->cCodCaj )
            ( dbfFacCliT )->cCodCaj := "000"
         end

         if Empty( ( dbfFacCliT )->cNomCli ) .AND. !Empty ( ( dbfFacCliT )->cCodCli )
            ( dbfFacCliT )->cNomCli := RetFld( ( dbfFacCliT )->cCodCli, dbfClient, "Titulo" )
         end





         aTotFac           := aTotFacCli( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT, ( dbfFacCliT )->cDivFac )

         if ( dbfFacCliT )->nTotFac == 0
            ( dbfFacCliT )->nTotNet := aTotFac[1]
            ( dbfFacCliT )->nTotIva := aTotFac[2]
            ( dbfFacCliT )->nTotReq := aTotFac[3]
            ( dbfFacCliT )->nTotFac := aTotFac[4]
         end

         if ( dbfFacCliT )->nTotLiq == 0
            ( dbfFacCliT )->nTotLiq := aTotFac[13]
            ( dbfFacCliT )->nTotPdt := aTotFac[4] - aTotFac[13]
         end

         if !Empty( ( dbfFacCliT )->cNumPed )
            oStock:SetEstadoPedCli( ( dbfFacCliT )->cNumPed )
         end

         ( dbfFacCliT )->( dbSkip() )

      end



      while !( dbfFacCliP )->( eof() )

         if Empty( ( dbfFacCliP )->cCodCaj )
            ( dbfFacCliP )->cCodCaj := "000"
         end

         ( dbfFacCliP )->( dbSkip() )

      end



      while !( dbfFacCliL )->( eof() )

         if !( dbfFacCliT )->( dbSeek( ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac ) )

            ( dbfFacCliL )->( dbDelete() )

         else

            if Empty( ( dbfFacCliL )->nValImp )
               cCodImp                    := RetFld( ( dbfFacCliL )->cRef, dbfArticulo, "cCodImp" )
               if !Empty( cCodImp )
                  ( dbfFacCliL )->nValImp := oNewImp:nValImp( cCodImp )
               end
            end

            if Empty( ( dbfFacCliL )->nVolumen )
               ( dbfFacCliL )->nVolumen   :=  RetFld( ( dbfFacCliL )->cRef, dbfArticulo, "nVolumen" )
            end

            if Empty( ( dbfFacCliL )->cLote ) .AND. !Empty( ( dbfFacCliL )->nLote )
               ( dbfFacCliL )->cLote      := AllTrim( Str( ( dbfFacCliL )->nLote ) )
            end

            if ( dbfFacCliL )->lIvaLin <> ( dbfFacCliT )->lIvaInc
               ( dbfFacCliL )->lIvaLin    := ( dbfFacCliT )->lIvaInc
            end

            if !Empty( ( dbfFacCliL )->cRef ) .AND. Empty( ( dbfFacCliL )->cCodFam )
               cCodFam                    := RetFamArt( ( dbfFacCliL )->cRef, dbfArticulo )
               if !Empty( cCodFam )
                  ( dbfFacCliL )->cCodFam := cCodFam
               end
            end

            if !Empty( ( dbfFacCliL )->cRef ) .AND. Empty( ( dbfFacCliL )->cCodTip )
               cCodTip                    := RetFld( ( dbfFacCliL )->cRef, dbfArticulo, "cCodTip" )
               if !Empty( cCodTip )
                  ( dbfFacCliL )->cCodTip := cCodTip
               end
            end

            if !Empty( ( dbfFacCliL )->cRef ) .AND. !Empty( ( dbfFacCliL )->cCodFam )
               cCodFam                    := cGruFam( ( dbfFacCliL )->cCodFam, dbfFamilia )
               if !Empty( cCodFam )
                  ( dbfFacCliL )->cGrpFam := cCodFam
               end
            end

            if Empty( ( dbfFacCliL )->nReq )
               ( dbfFacCliL )->nReq       := nPReq( dbfIva, ( dbfFacCliL )->nIva )
            end

            if Empty( ( dbfFacCliL )->cCodAge )
               ( dbfFacCliL )->cCodAge    := ( dbfFacCliT )->cCodAge
            end

            if ( dbfFacCliL )->dFecFac <> ( dbfFacCliT )->dFecFac
               ( dbfFacCliL )->dFecFac    := ( dbfFacCliT )->dFecFac
            end

            if !Empty( ( dbfFacCliL )->mNumSer )

               aNumSer                    := hb_aTokens( ( dbfFacCliL )->mNumSer, "," )

               for each cNumSer in aNumSer
                  ( dbfFacCliS )->( dbAppend() )
                  ( dbfFacCliS )->cSerFac := ( dbfFacCliL )->cSerie
                  ( dbfFacCliS )->nNumFac := ( dbfFacCliL )->nNumFac
                  ( dbfFacCliS )->cSufFac := ( dbfFacCliL )->cSufFac
                  ( dbfFacCliS )->cRef    := ( dbfFacCliL )->cRef
                  ( dbfFacCliS )->cAlmLin := ( dbfFacCliL )->cAlmLin
                  ( dbfFacCliS )->nNumLin := ( dbfFacCliL )->nNumLin
                  ( dbfFacCliS )->cNumSer := cNumSer
               next

               ( dbfFacCliL )->mNumSer    := ""
            end

         end

         ( dbfFacCliL )->( dbSkip() )

         SysRefresh()

      end



      while !( dbfFacCliI )->( eof() )

         if !( dbfFacCliT )->( dbSeek( ( dbfFacCliI )->cSerie + Str( ( dbfFacCliI )->nNumFac ) + ( dbfFacCliI )->cSufFac ) )
            ( dbfFacCliI )->( dbDelete() )
         end

         ( dbfFacCliI )->( dbSkip() )

         SysRefresh()

      end



      while !( dbfFacCliS )->( eof() )

         if !( dbfFacCliT )->( dbSeek( ( dbfFacCliS )->cSerFac + Str( ( dbfFacCliS )->nNumFac ) + ( dbfFacCliS )->cSufFac ) )
            ( dbfFacCliS )->( dbDelete() )
         else
            if ( dbfFacCliS )->dFecFac <> ( dbfFacCliT )->dFecFac
               ( dbfFacCliS )->dFecFac    := ( dbfFacCliT )->dFecFac
            end
         end

         ( dbfFacCliS )->( dbSkip() )

         SysRefresh()

      end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos de facturas de clientes." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfFacCliT  )->( dbCloseArea() )
   ( dbfFacCliL  )->( dbCloseArea() )
   ( dbfFacCliS  )->( dbCloseArea() )
   ( dbfFacCliI  )->( dbCloseArea() )
   ( dbfFacCliP  )->( dbCloseArea() )
   ( dbfFamilia  )->( dbCloseArea() )
   ( dbfIva      )->( dbCloseArea() )
   ( dbfArticulo )->( dbCloseArea() )
   ( dbfDiv      )->( dbCloseArea() )
   ( dbfAntCliT  )->( dbCloseArea() )
   ( dbfClient   )->( dbCloseArea() )
   ( dbfPedCliT  )->( dbCloseArea() )
   ( dbfPedCliL  )->( dbCloseArea() )
   ( dbfAlbCliL  )->( dbCloseArea() )

   if !Empty( oNewImp )
      oNewImp:end()
   end

   if !Empty( oStock )
      oStock:end()
   end

   oNewImp     := nil
   oStock      := nil

Return nil



Function mailing( cTo,cSubject )

   local lSend

   WITH OBJECT ( frReportManager():New() )
      lSend := :SendMail( "smtp.telefonica.net", 25, "watchdog$telefonica.net" , "watch01", "watchdog@telefonica.net", "manuel_calero_solis@hotmail.com", "Test mailing", "Company" )
      if lSend <> ""
         MsgStop( lSend )
      end
   end

Return ( nil )
#line 12349 ".\Prg\Factcli.prg"
Static Function DataReport( oFr )





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "Facturas", ( dbfFacCliT )->( Select() ), .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "Facturas", cItemsToReport( aItmFacCli() ) )

   oFr:SetWorkArea(     "Lineas de facturas", ( dbfFacCliL )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de facturas", cItemsToReport( aColFacCli() ) )

   oFr:SetWorkArea(     "Series de lineas de facturas", ( dbfFacCliS )->( Select() ) )
   oFr:SetFieldAliases( "Series de lineas de facturas", cItemsToReport( aSerFacCli() ) )

   oFr:SetWorkArea(     "Incidencias de facturas", ( dbfFacCliI )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de facturas", cItemsToReport( aIncFacCli() ) )

   oFr:SetWorkArea(     "Documentos de facturas", ( dbfFacCliD )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de facturas", cItemsToReport( aFacCliDoc() ) )

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Clientes", ( dbfClient )->( Select() ) )
   oFr:SetFieldAliases( "Clientes", cItemsToReport( aItmCli() ) )

   oFr:SetWorkArea(     "Obras", ( dbfObrasT )->( Select() ) )
   oFr:SetFieldAliases( "Obras",  cItemsToReport( aItmObr() ) )

   oFr:SetWorkArea(     "Almacenes", ( dbfAlm )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Rutas", ( dbfRuta )->( Select() ) )
   oFr:SetFieldAliases( "Rutas", cItemsToReport( aItmRut() ) )

   oFr:SetWorkArea(     "Agentes", ( dbfAgent )->( Select() ) )
   oFr:SetFieldAliases( "Agentes", cItemsToReport( aItmAge() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Transportistas", oTrans:Select() )
   oFr:SetFieldAliases( "Transportistas", cObjectsToReport( oTrans:oDbf ) )

   oFr:SetWorkArea(     "Artículos", ( dbfArticulo )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Familias", ( dbfFamilia )->( Select() ) )
   oFr:SetFieldAliases( "Familias", cItemsToReport( aItmFam() ) )

   oFr:SetWorkArea(     "Tipo artículo",  oTipArt:Select() )
   oFr:SetFieldAliases( "Tipo artículo",  cObjectsToReport( oTipArt:oDbf ) )

   oFr:SetWorkArea(     "Tipo de venta", ( dbfTVta )->( Select() ) )
   oFr:SetFieldAliases( "Tipo de venta", cItemsToReport( aItmTVta() ) )

   oFr:SetWorkArea(     "Recibos", ( dbfFacCliP )->( Select() ) )
   oFr:SetFieldAliases( "Recibos", cItemsToReport( aItmRecCli() ) )

   oFr:SetWorkArea(     "Anticipos", ( dbfAntCliT )->( Select() ) )
   oFr:SetFieldAliases( "Anticipos", cItemsToReport( aItmAntCli() ) )

   oFr:SetWorkArea(     "Usuarios", ( dbfUsr )->( Select() ) )
   oFr:SetFieldAliases( "Usuarios", cItemsToReport( aItmUsr() ) )

   oFr:SetWorkArea(     "Ofertas", ( dbfOferta )->( Select() ) )
   oFr:SetFieldAliases( "Ofertas", cItemsToReport( aItmOfe() ) )

   oFr:SetWorkArea(     "Bancos", ( dbfCliBnc )->( Select() ) )
   oFr:SetFieldAliases( "Bancos", cItemsToReport( aCliBnc() ) )

   oFr:SetWorkArea(     "Unidades de medición",  oUndMedicion:Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( oUndMedicion:oDbf ) )

   oFr:SetWorkArea(     "Clientes.Pais", oPais:Select() )
   oFr:SetFieldAliases( "Clientes.Pais", cObjectsToReport( oPais:oDbf ) )

   oFr:SetMasterDetail( "Facturas", "Lineas de facturas",               {|| ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Series de lineas de facturas",     {|| ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Incidencias de facturas",          {|| ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Documentos de facturas",           {|| ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Clientes",                         {|| ( dbfFacCliT )->cCodCli } )
   oFr:SetMasterDetail( "Facturas", "Obras",                            {|| ( dbfFacCliT )->cCodCli + ( dbfFacCliT )->cCodObr } )
   oFr:SetMasterDetail( "Facturas", "Almacenes",                        {|| ( dbfFacCliT )->cCodAlm } )
   oFr:SetMasterDetail( "Facturas", "Rutas",                            {|| ( dbfFacCliT )->cCodRut } )
   oFr:SetMasterDetail( "Facturas", "Agentes",                          {|| ( dbfFacCliT )->cCodAge } )
   oFr:SetMasterDetail( "Facturas", "Formas de pago",                   {|| ( dbfFacCliT )->cCodPago } )
   oFr:SetMasterDetail( "Facturas", "Transportistas",                   {|| ( dbfFacCliT )->cCodTrn } )
   oFr:SetMasterDetail( "Facturas", "Empresa",                          {|| cCodigoEmpresaEnUso() } )
   oFr:SetMasterDetail( "Facturas", "Recibos",                          {|| ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Anticipos",                        {|| ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Usuarios",                         {|| ( dbfFacCliT )->cCodUsr } )
   oFr:SetMasterDetail( "Facturas", "Bancos",                           {|| ( dbfFacCliT )->cCodCli } )

   oFr:SetMasterDetail( "Lineas de facturas", "Artículos",              {|| ( dbfFacCliL )->cRef } )
   oFr:SetMasterDetail( "Lineas de facturas", "Familia",                {|| ( dbfFacCliL )->cCodFam } )
   oFr:SetMasterDetail( "Lineas de facturas", "Tipo artículo",          {|| ( dbfFacCliL )->cCodTip } )
   oFr:SetMasterDetail( "Lineas de facturas", "Tipo de venta",          {|| ( dbfFacCliL )->cTipMov } )
   oFr:SetMasterDetail( "Lineas de facturas", "Ofertas",                {|| ( dbfFacCliL )->cRef } )
   oFr:SetMasterDetail( "Lineas de facturas", "Unidades de medición",   {|| ( dbfFacCliL )->cUnidad } )

   oFr:SetMasterDetail( "Clientes", "Clientes.Pais",                     {|| ( dbfClient )->cCodPai } )

   oFr:SetResyncPair(   "Facturas", "Lineas de facturas" )
   oFr:SetResyncPair(   "Facturas", "Series de lineas de facturas" )
   oFr:SetResyncPair(   "Facturas", "Incidencias de facturas" )
   oFr:SetResyncPair(   "Facturas", "Documentos de facturas" )
   oFr:SetResyncPair(   "Facturas", "Empresa" )
   oFr:SetResyncPair(   "Facturas", "Clientes" )
   oFr:SetResyncPair(   "Facturas", "Obras" )
   oFr:SetResyncPair(   "Facturas", "Almacenes" )
   oFr:SetResyncPair(   "Facturas", "Rutas" )
   oFr:SetResyncPair(   "Facturas", "Agentes" )
   oFr:SetResyncPair(   "Facturas", "Formas de pago" )
   oFr:SetResyncPair(   "Facturas", "Transportistas" )
   oFr:SetResyncPair(   "Facturas", "Recibos" )
   oFr:SetResyncPair(   "Facturas", "Anticipos" )
   oFr:SetResyncPair(   "Facturas", "Usuarios" )
   oFr:SetResyncPair(   "Facturas", "Bancos" )

   oFr:SetResyncPair(   "Lineas de facturas", "Artículos" )
   oFr:SetResyncPair(   "Lineas de facturas", "Familia" )
   oFr:SetResyncPair(   "Lineas de facturas", "Tipo artículo" )
   oFr:SetResyncPair(   "Lineas de facturas", "Tipo de venta" )
   oFr:SetResyncPair(   "Lineas de facturas", "Ofertas" )
   oFr:SetResyncPair(   "Lineas de facturas", "Unidades de medición" )

   oFr:SetResyncPair(   "Clientes", "Clientes.Pais" )

Return nil



Static Function VariableReport( oFr )

   oFr:DeleteCategory(  "Facturas" )
   oFr:DeleteCategory(  "Lineas de facturas" )





   oFr:AddVariable(     "Facturas",             "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Facturas",             "Total factura",                       "GetHbVar('nTotFac')" )
   oFr:AddVariable(     "Facturas",             "Total factura texto",                 "CallHbFunc('cTotFacCli')" )
   oFr:AddVariable(     "Facturas",             "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Facturas",             "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Facturas",             "Total descuentos",                    "GetHbVar('nTotalDto')" )
   oFr:AddVariable(     "Facturas",             "Total neto",                          "GetHbVar('nTotNet')" )
   oFr:AddVariable(     "Facturas",             "Total primer descuento definible",    "GetHbVar('nTotUno')" )
   oFr:AddVariable(     "Facturas",             "Total segundo descuento definible",   "GetHbVar('nTotDos')" )
   oFr:AddVariable(     "Facturas",             "Total " + cImp(),                    "GetHbVar('nTotIva')" )
   oFr:AddVariable(     "Facturas",             "Total RE",                            "GetHbVar('nTotReq')" )
   oFr:AddVariable(     "Facturas",             "Total página",                        "GetHbVar('nTotPag')" )
   oFr:AddVariable(     "Facturas",             "Total retención",                     "GetHbVar('nTotRet')" )
   oFr:AddVariable(     "Facturas",             "Total peso",                          "GetHbVar('nTotPes')" )
   oFr:AddVariable(     "Facturas",             "Total costo",                         "GetHbVar('nTotCos')" )
   oFr:AddVariable(     "Facturas",             "Total anticipado",                    "GetHbVar('nTotAnt')" )
   oFr:AddVariable(     "Facturas",             "Total cobrado",                       "GetHbVar('nTotCob')" )
   oFr:AddVariable(     "Facturas",             "Total artículos",                     "GetHbVar('nTotArt')" )
   oFr:AddVariable(     "Facturas",             "Total cajas",                         "GetHbVar('nTotCaj')" )
   oFr:AddVariable(     "Facturas",             "Total punto verde",                   "GetHbVar('nTotPnt')" )
   oFr:AddVariable(     "Facturas",             "Total entrega inicial",               "GetHbVar('nTotEnt')" )
   oFr:AddVariable(     "Facturas",             "Total descuento por entrega inicial", "GetHbVar('nTotDtoEnt')" )
   oFr:AddVariable(     "Facturas",             "Cuenta por defecto del cliente",      "GetHbVar('cCtaCli')" )

   oFr:AddVariable(     "Facturas",             "Bruto primer tipo de " + cImp(),     "GetHbArrayVar('aIvaUno',1)" )
   oFr:AddVariable(     "Facturas",             "Bruto segundo tipo de " + cImp(),    "GetHbArrayVar('aIvaDos',1)" )
   oFr:AddVariable(     "Facturas",             "Bruto tercer tipo de " + cImp(),     "GetHbArrayVar('aIvaTre',1)" )
   oFr:AddVariable(     "Facturas",             "Base primer tipo de " + cImp(),      "GetHbArrayVar('aIvaUno',2)" )
   oFr:AddVariable(     "Facturas",             "Base segundo tipo de " + cImp(),     "GetHbArrayVar('aIvaDos',2)" )
   oFr:AddVariable(     "Facturas",             "Base tercer tipo de " + cImp(),      "GetHbArrayVar('aIvaTre',2)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje primer tipo " + cImp(),   "GetHbArrayVar('aIvaUno',3)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje segundo tipo " + cImp(),  "GetHbArrayVar('aIvaDos',3)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje tercer tipo " + cImp(),   "GetHbArrayVar('aIvaTre',3)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje primer tipo RE",           "GetHbArrayVar('aIvaUno',4)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje segundo tipo RE",          "GetHbArrayVar('aIvaDos',4)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje tercer tipo RE",           "GetHbArrayVar('aIvaTre',4)" )
   oFr:AddVariable(     "Facturas",             "Importe primer tipo " + cImp(),      "GetHbArrayVar('aIvaUno',8)" )
   oFr:AddVariable(     "Facturas",             "Importe segundo tipo " + cImp(),     "GetHbArrayVar('aIvaDos',8)" )
   oFr:AddVariable(     "Facturas",             "Importe tercer tipo " + cImp(),      "GetHbArrayVar('aIvaTre',8)" )
   oFr:AddVariable(     "Facturas",             "Importe primer RE",                   "GetHbArrayVar('aIvaUno',9)" )
   oFr:AddVariable(     "Facturas",             "Importe segundo RE",                  "GetHbArrayVar('aIvaDos',9)" )
   oFr:AddVariable(     "Facturas",             "Importe tercer RE",                   "GetHbArrayVar('aIvaTre',9)" )

   oFr:AddVariable(     "Facturas",             "Total unidades primer tipo de impuestos especiales",            "GetHbArrayVar('aIvmUno',1 )" )
   oFr:AddVariable(     "Facturas",             "Total unidades segundo tipo de impuestos especiales",           "GetHbArrayVar('aIvmDos',1 )" )
   oFr:AddVariable(     "Facturas",             "Total unidades tercer tipo de impuestos especiales",            "GetHbArrayVar('aIvmTre',1 )" )
   oFr:AddVariable(     "Facturas",             "Importe del primer tipo de impuestos especiales",               "GetHbArrayVar('aIvmUno',2 )" )
   oFr:AddVariable(     "Facturas",             "Importe del segundo tipo de impuestos especiales",              "GetHbArrayVar('aIvmDos',2 )" )
   oFr:AddVariable(     "Facturas",             "Importe del tercer tipo de impuestos especiales",               "GetHbArrayVar('aIvmTre',2 )" )
   oFr:AddVariable(     "Facturas",             "Total importe primer tipo de impuestos especiales",             "GetHbArrayVar('aIvmUno',3 )" )
   oFr:AddVariable(     "Facturas",             "Total importe segundo tipo de impuestos especiales",            "GetHbArrayVar('aIvmDos',3 )" )
   oFr:AddVariable(     "Facturas",             "Total importe tercer tipo de impuestos especiales",             "GetHbArrayVar('aIvmTre',3 )" )

   oFr:AddVariable(     "Facturas",             "Fecha del primer vencimiento",        "GetHbArrayVar('aDatVto',1)" )
   oFr:AddVariable(     "Facturas",             "Fecha del segundo vencimiento",       "GetHbArrayVar('aDatVto',2)" )
   oFr:AddVariable(     "Facturas",             "Fecha del tercer vencimiento",        "GetHbArrayVar('aDatVto',3)" )
   oFr:AddVariable(     "Facturas",             "Fecha del cuarto vencimiento",        "GetHbArrayVar('aDatVto',4)" )
   oFr:AddVariable(     "Facturas",             "Fecha del quinto vencimiento",        "GetHbArrayVar('aDatVto',5)" )
   oFr:AddVariable(     "Facturas",             "Importe del primer vencimiento",      "GetHbArrayVar('aImpVto',1)" )
   oFr:AddVariable(     "Facturas",             "Importe del segundo vencimiento",     "GetHbArrayVar('aImpVto',2)" )
   oFr:AddVariable(     "Facturas",             "Importe del tercero vencimiento",     "GetHbArrayVar('aImpVto',3)" )
   oFr:AddVariable(     "Facturas",             "Importe del cuarto vencimiento",      "GetHbArrayVar('aImpVto',4)" )
   oFr:AddVariable(     "Facturas",             "Importe del quinto vencimiento",      "GetHbArrayVar('aImpVto',5)" )
   oFr:AddVariable(     "Facturas",             "Saldo envase 16%",                    "CallHbFunc('nTotalSaldo16')" )
   oFr:AddVariable(     "Facturas",             "Saldo envase 8%",                     "CallHbFunc('nTotalSaldo8')" )
   oFr:AddVariable(     "Facturas",             "Saldo envase 4%",                     "CallHbFunc('nTotalSaldo4')" )
   oFr:AddVariable(     "Facturas",             "Saldo actual envase 16%",             "CallHbFunc('nSaldoDoc16')" )
   oFr:AddVariable(     "Facturas",             "Saldo actual envase 8%",              "CallHbFunc('nSaldoDoc8')" )
   oFr:AddVariable(     "Facturas",             "Saldo actual envase 4%",              "CallHbFunc('nSaldoDoc4')" )
   oFr:AddVariable(     "Facturas",             "Saldo anterior envase 16%",           "CallHbFunc('nSaldoAnt16')" )
   oFr:AddVariable(     "Facturas",             "Saldo anterior envase 8%",            "CallHbFunc('nSaldoAnt8')" )
   oFr:AddVariable(     "Facturas",             "Saldo anterior envase 4%",            "CallHbFunc('nSaldoAnt4')" )

   oFr:AddVariable(     "Facturas",             "Cuenta bancaria cliente",                         "CallHbFunc('cCtaFacCli')" )

   oFr:AddVariable(     "Lineas de facturas",   "Detalle del artículo",                            "CallHbFunc('cDesFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Total unidades artículo",                         "CallHbFunc('nTotNFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Precio unitario del artículo",                    "CallHbFunc('nTotUFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Precio unitario con descuentos",                  "CallHbFunc('nTotPFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Punto verde del artículo",                        "CallHbFunc('nPntUFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Total línea de factura",                          "CallHbFunc('nTotLFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Total peso por línea",                            "CallHbFunc('nPesLFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Total final línea del factura",                   "CallHbFunc('nTotFFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Importe descuento línea del factura",             "CallHbFunc('nDtoLFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Importe impuestos especiales línea del factura",  "CallHbFunc('nTotIFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Total descuento línea del factura",               "CallHbFunc('nTotDtoLFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Fecha en juliano",                                "CallHbFunc('dJulianoFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",   "Precio unitario sin " + cImp(),                  "CallHbFunc('nNoIncUFacCli')"  )
   oFr:AddVariable(     "Lineas de facturas",   "Total linea sin " + cImp(),                      "CallHbFunc('nNoIncLFacCli')"  )

Return nil





Function DesignReportFacCli( oFr, dbfDoc )

   local lOpen    := .F.
   local lFlag    := .F.
   local nOrdAnt





   if lOpenFiles
      lFlag       := .T.
   else
      if Openfiles()
         lFlag    := .T.
         lOpen    := .T.
      else
         lFlag    := .F.
      end
   end

   nOrdAnt        := ( dbfAntCliT )->( OrdSetFocus( "cNumDoc" ) )

   if lFlag





      DataReport( oFr )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "CallHbFunc('nTotFacCli');"                                 + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "CabeceraColumnas",  "MainPage", 6 )
         oFr:SetProperty(     "CabeceraColumnas",  "Top", 200 )
         oFr:SetProperty(     "CabeceraColumnas",  "Height", 0 )
         oFr:SetProperty(     "CabeceraColumnas",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "CabeceraColumnas",  "DataSet", "Facturas" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de facturas" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      VariableReport( oFr )

      oFr:SetTabTreeExpanded( 16, .F. )





      oFr:DesignReport()





      oFr:DestroyFr()

      ( dbfAntCliT )->( OrdSetFocus( nOrdAnt ) )





      if lOpen
         CloseFiles()
      end

   else

      Return .F.

   end

Return .T.





Function PrintReportFacCli( nDevice, nCopies, cPrinter, dbfDoc )

   local oFr
   local nOrdAnt        := ( dbfAntCliT )->( OrdSetFocus( "cNumDoc" ) )
   local cFilePdf       := cPatTmp() + "FacturasCliente" + StrTran( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, " ", "" ) + ".Pdf"

   IIF( nDevice == nil, nDevice := 2, ) ;
   IIF( nCopies == nil, nCopies := 1, ) ;
   IIF( cPrinter == nil, cPrinter := PrnGetName(), ) ;

   SysRefresh()

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





   DataReport( oFr )





   if !Empty( ( dbfDoc )->mReport )

      oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





      VariableReport( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2

            oFr:ShowPreparedReport()

         case nDevice == 1

            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:Print()

         case nDevice == 3

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatTmp() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .T. )
            oFr:DoExport(     "PDFExport" )

         case nDevice == 6

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatTmp() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .F. )
            oFr:DoExport(     "PDFExport" )

            if file( cFilePdf )

               with object ( TGenMailing():New() )

                  :SetTypeDocument( "nFacCli" )
                  :SetDe(           uFieldEmpresa( "cNombre" ) )
                  :SetCopia(        uFieldEmpresa( "cCcpMai" ) )
                  :SetAdjunto(      cFilePdf )
                  :SetPara(         RetFld( ( dbfFacCliT )->cCodCli, dbfClient, "cMeiInt" ) )
                  :SetAsunto(       "Envio de factura de cliente número " + ( dbfFacCliT )->cSerie + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) )
                  :SetMensaje(      "Adjunto le remito nuestra factura de cliente " + ( dbfFacCliT )->cSerie + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) + Space( 1 ) )
                  :SetMensaje(      "de fecha " + Dtoc( ( dbfFacCliT )->dFecFac ) + Space( 1 ) )
                  :SetMensaje(      Chr(13)+Chr(10) )
                  :SetMensaje(      Chr(13)+Chr(10) )
                  :SetMensaje(      "Reciba un cordial saludo." )

                  :GeneralResource( dbfFacCliT, aItmFacCli() )

               end

            end

      end

   end





   oFr:DestroyFr()

   ( dbfAntCliT )->( OrdSetFocus( nOrdAnt ) )

Return .T.



Static Function YearComboBoxChange()

   if oWndBrw:oWndBar:lAllYearComboBox()
      DestroyFastFilter( dbfFacCliT )
      CreateUserFilter( "", dbfFacCliT, .F., , , "all" )
   else
      DestroyFastFilter( dbfFacCliT )
      CreateUserFilter( "Year( Field->dFecFac ) == " + oWndBrw:oWndBar:cYearComboBox(), dbfFacCliT, .F., , , "Year( Field->dFecFac ) == " + oWndBrw:oWndBar:cYearComboBox() )
   end

   ( dbfFacCliT )->( dbGoTop() )

   oWndBrw:Refresh()

Return nil
































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































_HB_CLASS pdaFacCliSenderReciver ; UTILITY FUNCTION pdaFacCliSenderReciver(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "pdaFacCliSenderReciver" , { HBObject():Classh } ) ) ;

   _HB_MEMBER CreateData(); IIF( .F., s_oClass:ModMethod( "CreateData", @pdaFacCliSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CreateData", @pdaFacCliSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS pdaFacCliSenderReciver ;



UTILITY STATIC function pdaFacCliSenderReciver_CreateData( oPgrActual, oSayStatus, cPatPreVenta) ; local Self AS CLASS pdaFacCliSenderReciver := QSelf() AS CLASS pdaFacCliSenderReciver

   local pdaFacCliT
   local pdaFacCliL
   local pdaFacCliI
   local pdaFacCliD
   local dbfFacCliT
   local dbfFacCliL
   local dbfFacCliI
   local dbfFacCliD
   local lExist         := .F.
   local cFileName
   local cNumFacCliT
   local cPatPc         := if( Empty( cPatPreVenta ), cPatPc(), cPatPreVenta )



   dbUseArea( .T., ( cDriver() ), ( cPatPc + "FacCliT.DBF" ), ( cCheckArea( "FacCliT", @dbfFacCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatPc + "FacCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
   ( dbfFacCliT )->( OrdSetFocus( "lSndDoc" ) )

   dbUseArea( .T., ( cDriver() ), ( cPatPc + "FacCliL.DBF" ), ( cCheckArea( "FacCliL", @dbfFacCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatPc + "FacCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatPc + "FacCliI.DBF" ), ( cCheckArea( "FacCliI", @dbfFacCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatPc + "FacCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatPc + "FacCliD.Dbf" ), ( cCheckArea( "FacCliD", @dbfFacCliD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatPc + "FacCliD.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., cDriver(), cPatEmp() + "FacCliT.Dbf", cCheckArea( "FacCliT", @pdaFacCliT ), .T. )
   ( pdaFacCliT )->( ordListAdd( cPatEmp() + "FacCliT.Cdx" ) )

   dbUseArea( .T., cDriver(), cPatEmp() + "FacCliL.Dbf", cCheckArea( "FacCliL", @pdaFacCliL ), .T. )
   ( pdaFacCliL )->( ordListAdd( cPatEmp() + "FacCliL.Cdx" ) )

   dbUseArea( .T., cDriver(), cPatEmp() + "FacCliI.Dbf", cCheckArea( "FacCliI", @pdaFacCliI ), .T. )
   ( pdaFacCliI )->( ordListAdd( cPatEmp() + "FacCliI.Cdx" ) )

   dbUseArea( .T., cDriver(), cPatEmp() + "FacCliD.Dbf", cCheckArea( "FacCliD", @pdaFacCliD ), .T. )
   ( pdaFacCliD )->( ordListAdd( cPatEmp() + "FacCliD.Cdx" ) )

   if !Empty( oPgrActual )
      oPgrActual:SetRange( 0, ( pdaFacCliT )->( OrdKeyCount() ) )
   end

   ( pdaFacCliT )->( dbGoTop() )
   while !( pdaFacCliT )->( eof() )

      if ( pdaFacCliT )->lSndDoc

         cNumFacCliT    := ( pdaFacCliT )->cSerie + Str( ( pdaFacCliT )->nNumFac ) + ( pdaFacCliT )->cSufFac

         if !( dbfFacCliT )->( dbSeek( cNumFacCliT ) )

            dbPass( pdaFacCliT, dbfFacCliT, .T. )





            if ( pdaFacCliL )->( dbSeek( cNumFacCliT ) )
               while ( pdaFacCliL )->cSerie + Str( ( pdaFacCliL )->nNumFac ) + ( pdaFacCliL )->cSufFac == cNumFacCliT .AND. !( pdaFacCliL )->( eof() )
                  dbPass( pdaFacCliL, dbfFacCliL, .T. )
                  ( pdaFacCliL )->( dbSkip() )
               end
            end





            if ( pdaFacCliI )->( dbSeek( cNumFacCliT ) )
               while ( pdaFacCliI )->cSerie + Str( ( pdaFacCliI )->nNumFac ) + ( pdaFacCliI )->cSufFac == cNumFacCliT .AND. !( pdaFacCliI )->( eof() )
                  dbPass( pdaFacCliI, dbfFacCliI, .T. )
                  ( pdaFacCliI )->( dbSkip() )
               end
            end





            if ( pdaFacCliD )->( dbSeek( cNumFacCliT ) )
               while ( pdaFacCliD )->cSerie + Str( ( pdaFacCliD )->nNumFac ) + ( pdaFacCliD )->cSufFac == cNumFacCliT .AND. !( pdaFacCliD )->( eof() )
                  dbPass( pdaFacCliD, dbfFacCliD, .T. )
                  ( pdaFacCliD )->( dbSkip() )
               end
            end

             if dbLock( pdaFacCliT )
               ( pdaFacCliT )->lSndDoc  := .F.
               ( pdaFacCliT )->( dbUnLock() )
            end

         end

      end

      ( pdaFacCliT )->( dbSkip() )

      if !Empty( oSayStatus )
         oSayStatus:SetText( "Sincronizando Facturas " + Alltrim( Str( ( pdaFacCliT )->( OrdKeyNo() ) ) ) + " de " + Alltrim( Str( ( pdaFacCliT )->( OrdKeyCount() ) ) ) )
      end

      SysRefresh()

      if !Empty( oPgrActual )
         oPgrActual:SetPos( ( pdaFacCliT )->( OrdKeyNo() ) )
      end

      SysRefresh()

   end

   ( pdaFacCliT )->( dbCloseArea() )
   ( pdaFacCliL )->( dbCloseArea() )
   ( pdaFacCliI )->( dbCloseArea() )
   ( pdaFacCliD )->( dbCloseArea() )
   ( dbfFacCliT )->( dbCloseArea() )
   ( dbfFacCliL )->( dbCloseArea() )
   ( dbfFacCliI )->( dbCloseArea() )
   ( dbfFacCliD )->( dbCloseArea() )

Return ( Self )











FUNCTION nTotLFacCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPorDiv )

   local nCalculo
   local nDtoGral    := 0
   local nDtoProm    := 0

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nRou == nil, nRou := nRouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lDto == nil, lDto := .T., ) ;
   IIF( lPntVer == nil, lPntVer := .T., ) ;
   IIF( lImpTrn == nil, lImpTrn := .T., ) ;

   if ( dbfLin )->lTotLin

      nCalculo       := nTotUFacCli( dbfLin, nDec, nVdv )

   else



      nCalculo       := nTotUFacCli( dbfLin, nDec )



      if lDto

         nCalculo    -= Round( Div( ( dbfLin )->nDtoDiv, nVdv ), nDec )

         if ( dbfLin )->nDto <> 0
            nCalculo -= nCalculo * ( dbfLin )->nDto / 100
         end

         if ( dbfLin )->nDtoPrm <> 0
            nCalculo -= nCalculo * ( dbfLin )->nDtoPrm / 100
         end






      end



      if lPntVer
         nCalculo    += Round( ( dbfLin )->nPntVer , nDec )
      end





      if lImpTrn .AND. ( dbfLin )->nImpTrn <> 0
         nCalculo    += ( dbfLin )->nImpTrn * nTotNFacCli( dbfLin )
      end



      nCalculo       *= nTotNFacCli( dbfLin )

   end

   if nRou <> nil
      nCalculo       := Round( Div( nCalculo, nVdv ), nRou )
   end

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )







FUNCTION nTotUFacCli( dbfLin, nDec, nVdv )

   local nCalculo    := 0

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   if ValType( dbfLin ) == "C"

      if ( dbfLin )->lAlquiler
         nCalculo    := ( dbfLin )->nPreAlq
      else
         nCalculo    := ( dbfLin )->nPreUnit
      end











   else

      if dbfLin:lAlquiler
         nCalculo    := dbfLin:nPreAlq
      else
         nCalculo    := dbfLin:nPreUnit
      end











   end

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )






FUNCTION nTotNFacCli( uDbf )

   local nTotUnd

   IIF( uDbf == nil, uDbf := dbfFacCliL, ) ;

   do case
      case ValType( uDbf ) == "A"

      if uDbf[ 69 ]
         nTotUnd  := NotCaja( uDbf[ 12 ] )
         nTotUnd  *= uDbf[ 19 ]
         nTotUnd  *= NotCero( uDbf[ 20 ] )
         nTotUnd  *= NotCero( uDbf[ 70 ] - uDbf[ 71 ] )
         nTotUnd  *= NotCero( uDbf[ 74 ] )
         nTotUnd  *= NotCero( uDbf[ 75 ] )
         nTotUnd  *= NotCero( uDbf[ 76 ] )
      else
         nTotUnd  := NotCaja( uDbf[ 12 ] )
         nTotUnd  *= uDbf[ 19 ]
         nTotUnd  *= NotCero( uDbf[ 20 ] )
         nTotUnd  *= NotCero( uDbf[ 74 ] )
         nTotUnd  *= NotCero( uDbf[ 75 ] )
         nTotUnd  *= NotCero( uDbf[ 76 ] )
      end

   case ValType( uDbf ) == "C"

      if ( uDbf )->lAlquiler
         nTotUnd  := NotCaja( ( uDbf )->nCanEnt )
         nTotUnd  *= ( uDbf )->nUniCaja
         nTotUnd  *= NotCero( ( uDbf )->nUndKit )
         nTotUnd  *= NotCero( ( uDbf )->dFecEnt - ( uDbf )->dFecSal )
         nTotUnd  *= NotCero( ( uDbf )->nMedUno )
         nTotUnd  *= NotCero( ( uDbf )->nMedDos )
         nTotUnd  *= NotCero( ( uDbf )->nMedTre )
      else
         nTotUnd  := NotCaja( ( uDbf )->nCanEnt )
         nTotUnd  *=( uDbf )->nUniCaja
         nTotUnd  *= NotCero( ( uDbf )->nUndKit )
         nTotUnd  *= NotCero( ( uDbf )->nMedUno )
         nTotUnd  *= NotCero( ( uDbf )->nMedDos )
         nTotUnd  *= NotCero( ( uDbf )->nMedTre )
      end

   otherwise

      if uDbf:lAlquiler
         nTotUnd  := NotCaja( uDbf:nCanEnt )
         nTotUnd  *= uDbf:nUniCaja
         nTotUnd  *= NotCero( uDbf:nUndKit )
         nTotUnd  *= NotCero( uDbf:dFecEnt - uDbf:dFecSal )
         nTotUnd  *= NotCero( uDbf:nMedUno )
         nTotUnd  *= NotCero( uDbf:nMedDos )
         nTotUnd  *= NotCero( uDbf:nMedTre )
      else
         nTotUnd  := NotCaja( uDbf:nCanEnt )
         nTotUnd  *= uDbf:nUniCaja
         nTotUnd  *= NotCero( uDbf:nUndKit )
         nTotUnd  *= NotCero( uDbf:nMedUno )
         nTotUnd  *= NotCero( uDbf:nMedDos )
         nTotUnd  *= NotCero( uDbf:nMedTre )
      end

   end

Return ( nTotUnd )



function nTotVFacCli( uDbf )

   local nTotUnd

   IIF( uDbf == nil, uDbf := dbfFacCliL, ) ;

   do case
      case ValType( uDbf ) == "A"

         nTotUnd  := nTotNFacCli( uDbf ) * NotCero( uDbf[ 32 ] )

      case ValType( uDbf ) == "C"

         nTotUnd  := nTotNFacCli( uDbf ) * NotCero( ( uDbf )->nFacCnv )

      otherwise

         nTotUnd  := nTotNFacCli( uDbf ) * NotCero( uDbf:nFacCnv )

   end

return ( nTotUnd )



FUNCTION IsFacCli( cPath )

   IIF( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "FacCliT.Dbf" )
      dbCreate( cPath + "FacCliT.Dbf", aSqlStruct( aItmFacCli() ), cDriver() )
   end

   if !lExistTable( cPath + "FacCliL.Dbf" )
      dbCreate( cPath + "FacCliL.Dbf", aSqlStruct( aColFacCli() ), cDriver() )
   end

   if !lExistTable( cPath + "FacCliI.Dbf" )
      dbCreate( cPath + "FacCliI.Dbf", aSqlStruct( aIncFacCli() ), cDriver() )
   end

   if !lExistTable( cPath + "FacCliD.Dbf" )
      dbCreate( cPath + "FacCliD.Dbf", aSqlStruct( aFacCliDoc() ), cDriver() )
   end




   if !lExistIndex( cPath + "FacCliT.Cdx" ) .OR.  !lExistIndex( cPath + "FacCliL.Cdx" ) .OR.  !lExistIndex( cPath + "FacCliI.Cdx" ) .OR.  !lExistTable( cPath + "FacCliD.Cdx" )

      rxFacCli( cPath )

   end

Return ( .T. )







FUNCTION mkFacCli( cPath, oMeter, lReindex )

   IIF( lReindex == nil, lReindex := .T., ) ;

   if oMeter <> nil
        oMeter:cText    := "Generando Bases"
        sysrefresh()
   end

   if !lExistTable( cPath + "FACCLIT.DBF" )
      dbCreate( cPath + "FACCLIT.DBF", aSqlStruct( aItmFacCli() ), cDriver() )
   end

   if !lExistTable( cPath + "FACCLIL.DBF" )
      dbCreate( cPath + "FACCLIL.DBF", aSqlStruct( aColFacCli() ), cDriver() )
   end

   if !lExistTable( cPath + "FACCLII.DBF" )
      dbCreate( cPath + "FACCLII.DBF", aSqlStruct( aIncFacCli() ), cDriver() )
   end

   if !lExistTable( cPath + "FACCLID.DBF" )
      dbCreate( cPath + "FACCLID.DBF", aSqlStruct( aFacCliDoc() ), cDriver() )
   end

   if !lExistTable( cPath + "FACCLIS.DBF" )
      dbCreate( cPath + "FACCLIS.DBF", aSqlStruct( aSerFacCli() ), cDriver() )
   end

   if lReindex
      rxFacCli( cPath )
   end

RETURN .T.






FUNCTION rxFacCli( cPath, oMeter )

    local dbfFacCliT
   local dbfFacCliL
   local dbfFacCliI
   local dbfFacCliD

   IIF( cPath == nil, cPath := cPatEmp(), ) ;









   if !lExistTable( cPath + "FacCliT.Dbf" )   .OR. !lExistTable( cPath + "FacCliL.Dbf" )   .OR. !lExistTable( cPath + "FacCliI.Dbf" )   .OR. !lExistTable( cPath + "FacCliD.Dbf" )   .OR. !lExistTable( cPath + "FacCliS.Dbf" )
      mkFacCli( cPath, nil, .F. )
   end

   fEraseIndex( cPath + "FacCliT.Cdx" )
   fEraseIndex( cPath + "FacCliL.Cdx" )
   fEraseIndex( cPath + "FacCliI.Cdx" )
   fEraseIndex( cPath + "FacCliD.Cdx" )
   fEraseIndex( cPath + "FacCliS.Cdx" )

   dbUseArea( .T., cDriver(), cPath + "FACCLIL.DBF", cCheckArea( "FACCLIL", @dbfFacCliL ), .F. )
   if !( dbfFacCliL )->( neterr() )
      ( dbfFacCliL )->( __dbPack() )

      ( dbfFacCliL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliL )->( ordCreate( cPath + "FACCLIL.CDX", "nNumFac", "cSerie + STR( nNumFac ) + cSufFac", {|| Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac } ) )

      ( dbfFacCliL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliL )->( ordCreate( cPath + "FACCLIL.CDX", "cRef", "cRef", {|| Field->cRef }, ) )

      ( dbfFacCliL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliL )->( ordCreate( cPath + "FACCLIL.CDX", "Lote", "cLote", {|| Field->cLote }, ) )

      ( dbfFacCliL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliL )->( ordCreate( cPath + "FACCLIL.CDX", "cCodAlb", "cCodAlb", {|| Field->cCodAlb }, ) )

      ( dbfFacCliL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliL )->( ordCreate( cPath + "FACCLIL.CDX", "cNumRef", "cSerie + STR( nNumFac ) + cSufFac + cRef", {|| Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac + Field->cRef } ) )

      ( dbfFacCliL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliL )->( ordCreate( cPath + "FACCLIL.CDX", "cNumPedRef", "cNumPed + cRef", {|| Field->cNumPed + Field->cRef } ) )

      ( dbfFacCliL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliL )->( ordCreate( cPath + "FACCLIL.CDX", "cNumPed", "cNumPed", {|| Field->cNumPed } ) )

      ( dbfFacCliL)->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfFacCliL )->( ordCreate( cPath + "FacCliL.Cdx", "iNumFac", "'FACTURA CLIENTES              ' + cSerie + Str( nNumFac ) + cSufFac", {|| "FACTURA CLIENTES              " + Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac } ) )

      ( dbfFacCliL )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de clientes" )
   end

   dbUseArea( .T., cDriver(), cPath + "FacCliI.DBF", cCheckArea( "FacCliI", @dbfFacCliI ), .F. )
   if !( dbfFacCliI )->( neterr() )
      ( dbfFacCliI )->( __dbPack() )

      ( dbfFacCliI )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacCliI )->( ordCreate( cPath + "FacCliI.Cdx", "nNumFac", "cSerie + STR( nNumFac ) + cSufFac", {|| Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac } ) )

      ( dbfFacCliI )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de clientes" )
   end

   dbUseArea( .T., cDriver(), cPath + "FacCliD.DBF", cCheckArea( "FacCliD", @dbfFacCliD ), .F. )
   if !( dbfFacCliD )->( neterr() )
      ( dbfFacCliD )->( __dbPack() )

      ( dbfFacCliD )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacCliD )->( ordCreate( cPath + "FacCliD.Cdx", "nNumFac", "cSerFac + STR( nNumFac ) + cSufFac", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac } ) )

      ( dbfFacCliD )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de clientes" )
   end

   dbUseArea( .T., cDriver(), cPath + "FACCLIT.DBF", cCheckArea( "FACCLIT", @dbfFacCliT ), .F. )

   if !( dbfFacCliT )->( neterr() )
      ( dbfFacCliT )->( __dbPack() )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "NNUMFAC", "CSERIE + Str(NNUMFAC) + CSUFFAC", {|| Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac }, ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "DFECFAC", "DFECFAC", {|| Field->DFECFAC } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "CCODCLI", "CCODCLI", {|| Field->CCODCLI } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "CNOMCLI", "Upper( CNOMCLI )", {|| Upper( Field->CNOMCLI ) } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "CPOBCLI", "CPOBCLI + CNOMCLI", {|| Field->CPOBCLI + Field->CNOMCLI } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "CCODOBR", "cCodObr + Dtos( dFecFac )", {|| Field->cCodObr + Dtos( Field->dFecFac ) } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "CCODAGE", "cCodAge + Dtos( dFecFac )", {|| Field->cCodAge + Dtos( Field->dFecFac ) } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "CTURFAC", "CTURFAC + CSUFFAC + CCODCAJ", {|| Field->CTURFAC + Field->CSUFFAC + Field->CCODCAJ } ) )

      ( dbfFacCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "cNfc", "Upper( cNfc )", {|| Upper( Field->cNfc ) } ) )

      ( dbfFacCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FacCliT.Cdx", "cCodPago", "cCodPago", {|| Field->cCodPago } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "CCODRUT", "CCODRUT", {|| Field->CCODRUT } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "CDOCORG", "CDOCORG", {|| Field->CDOCORG } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "CAGEFEC", "CCODAGE + DtoS( DFECFAC )", {|| Field->CCODAGE + DtoS( Field->DFECFAC ) } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "NNUMLIQ", "Str( NNUMLIQ ) + CSUFLIQ", {|| Str( Field->NNUMLIQ ) + Field->CSUFLIQ } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ))
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "CABNFAC", "CABNFAC", {|| Field->CABNFAC } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ))
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "lSndDoc", "lSndDoc", {|| Field->lSndDoc } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ))
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "cNumDoc", "cNumDoc", {|| Field->cNumDoc } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ))
      ( dbfFacCliT )->( ordCreate( cPath + "FacCliT.Cdx", "cNumPre", "cNumPre", {|| Field->cNumPre } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ))
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "cNumPed", "cNumPed", {|| Field->cNumPed } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ))
      ( dbfFacCliT )->( ordCreate( cPath + "FACCLIT.CDX", "cNumAlb", "cNumAlb", {|| Field->cNumAlb } ) )

      ( dbfFacCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FacCliT.Cdx", "cCodUsr", "Field->cCodUsr + Dtos( Field->dFecCre ) + Field->cTimCre", {|| Field->cCodUsr + Dtos( Field->dFecCre ) + Field->cTimCre } ) )

      ( dbfFacCliT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FacCliT.Cdx", "cNfc", "cNfc", {|| Field->cNfc } ) )

      ( dbfFacCliT)->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FacCliT.Cdx", "iNumFac", "'FACTURA CLIENTES              ' + cSerie + Str( nNumFac ) + cSufFac", {|| "FACTURA CLIENTES              " + Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac } ) )

      ( dbfFacCliT )->( dbCloseArea() )

   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de clientes" )
   end

   dbUseArea( .T., cDriver(), cPath + "FacCliS.Dbf", cCheckArea( "FacCliS", @dbfFacCliT ), .F. )

   if !( dbfFacCliT )->( neterr() )
      ( dbfFacCliT )->( __dbPack() )

      ( dbfFacCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FacCliS.Cdx", "nNumFac", "cSerFac + Str( nNumFac ) + cSufFac + Str( nNumLin )", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nNumLin ) } ) )

      ( dbfFacCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FacCliS.Cdx", "cRefSer", "cRef + cAlmLin + cNumSer", {|| Field->cRef + Field->cAlmLin +Field->cNumSer } ) )

      ( dbfFacCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfFacCliT )->( ordCreate( cPath + "FacCliS.CDX", "cNumSer", "cNumSer", {|| Field->cNumSer } ) )

      ( dbfFacCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de números de series de facturas de clientes" )
   end

Return nil



function aIncFacCli()

   local aIncFacCli  := {}

   aAdd( aIncFacCli, { "cSerie",  "C",    1,  0, "Serie de factura" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacCli, { "nNumFac", "N",    9,  0, "Número de factura" ,             "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aIncFacCli, { "cSufFac", "C",    2,  0, "Sufijo de factura" ,             "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacCli, { "cCodTip", "C",    3,  0, "Tipo de incidencia" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacCli, { "dFecInc", "D",    8,  0, "Fecha de la incidencia" ,        "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacCli, { "mDesInc", "M",   10,  0, "Descripción de la incidencia" ,  "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacCli, { "lListo",  "L",    1,  0, "Lógico de listo" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacCli, { "lAviso",  "L",    1,  0, "Lógico de Aviso" ,               "",                   "", "( cDbfCol )" } )

return ( aIncFacCli )



function aFacCliDoc()

   local aFacCliDoc  := {}

   aAdd( aFacCliDoc, { "cSerFac", "C",    1,  0, "Serie de factura" ,                "",                   "", "( cDbfCol )" } )
   aAdd( aFacCliDoc, { "nNumFac", "N",    9,  0, "Número de factura" ,               "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aFacCliDoc, { "cSufFac", "C",    2,  0, "Sufijo de factura" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aFacCliDoc, { "cNombre", "C",  250,  0, "Nombre del documento" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aFacCliDoc, { "cRuta",   "C",  250,  0, "Ruta del documento" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aFacCliDoc, { "mObsDoc", "M",   10,  0, "Observaciones del documento" ,     "",                   "", "( cDbfCol )" } )

return ( aFacCliDoc )



function aColFacCli()

   local aColFacCli  := {}

   aAdd( aColFacCli, {"CSERIE"      ,"C",  1, 0, ""                                      , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NNUMFAC"     ,"N",  9, 0, ""                                      , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CSUFFAC"     ,"C",  2, 0, ""                                      , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CREF"        ,"C", 18, 0, "Referencia del artículo"               , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CDETALLE"    ,"C",250, 0, "Detalle del artículo"                  , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NPREUNIT"    ,"N", 16, 6, "Precio unitario"                       , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NPNTVER"     ,"N", 16, 6, "Importe punto verde"                   , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"nImpTrn"     ,"N", 16, 6, "Importe de portes"                     , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NDTO"        ,"N",  6, 2, "Descuento"                             , "'@E 99,99'" ,   "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NDTOPRM"     ,"N",  6, 2, "Descuento promocional"                 , "'@E 99,99'" ,   "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NIVA"        ,"N",  6, 2, "Porcentaje de " + cImp()               , "'@E 99,99'" ,   "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NCANENT"     ,"N", 16, 6, cNombreCajas()                          , "cPicUndFac" ,   "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"LCONTROL"    ,"L",  1, 0, "Lógico linea de control"               , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NPESOKG"     ,"N", 16, 6, "Peso del producto"                     , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"cPesoKg"     ,"C",  2, 0, "Unidad de peso del producto"           , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CUNIDAD"     ,"C",  2, 0, "Unidades de venta"                     , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CCODAGE"     ,"C",  3, 0, "Código del agente"                     , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NCOMAGE"     ,"N",  6, 2, "Comisión del agente"                   , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NUNICAJA"    ,"N", 16, 6, cNombreUnidades()                       , "cPicUndFac" ,   "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NUNDKIT"     ,"N", 16, 6, "Unidades del producto kit"             , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"DFECHA"      ,"D",  8, 0, "Fecha de detalle"                      , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CTIPMOV"     ,"C",  2, 0, "Tipo de movimiento"                    , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"MLNGDES"     ,"M", 10, 0, "Descripción de artículo sin codificar" , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CCODALB"     ,"C", 12, 0, "Número del albarán de procedencia"     , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"DFECALB"     ,"D",  8, 0, "Fecha del albarán de procedencia"      , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"LTOTLIN"     ,"L",  1, 0, "Valor lógico para enviar el documento" , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"LIMPLIN"     ,"L",  1, 0, "Línea no imprimible"                   , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CCODPR1"     ,"C", 10, 0, "Código de primera propiedad"           , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CCODPR2"     ,"C", 10, 0, "Código de segunda propiedad"           , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CVALPR1"     ,"C", 10, 0, "Valor de primera propiedad"            , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CVALPR2"     ,"C", 10, 0, "Valor de segunda propiedad"            , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NFACCNV"     ,"N", 16, 6, "Factor de conversión de la compra"     , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NDTODIV"     ,"N", 16, 6, "Descuento lineal de la compra"         , "'@EZ 99,99'" ,  "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"LSEL"        ,"L",  1, 0, ""                                      , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NNUMLIN"     ,"N",  4, 0, "Número de la línea"                    , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NCTLSTK"     ,"N",  1, 0, "Tipo de stock de la linea"             , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NCOSDIV"     ,"N", 16, 6, "Costo del producto"                    , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NPVPREC"     ,"N", 16, 6, "Precio de venta recomendado"           , "cPorDivFac" ,   "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CALMLIN"     ,"C",  3, 0, "Código de almacén"                     , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"LIVALIN"     ,"L",  1, 0, cImp() + " incluido"                    , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CCODIMP"     ,"C",  3, 0, "Código del impuesto especial"          , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NVALIMP"     ,"N", 16, 6, "Importe del impuesto especial"         , "cPorDivFac" ,   "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"LLOTE"       ,"L",  1, 0, ""                                      , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NLOTE"       ,"N",  9, 0, ""                                      , "'999999999'" ,  "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CLOTE"       ,"C", 12, 0, "Número de lote"                        , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"dFecCad"     ,"D",  8, 0, "Fecha de caducidad"                    , "",              "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"LKITART"     ,"L",  1, 0, "Línea con escandallo"                  , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"LKITCHL"     ,"L",  1, 0, "Línea pertenciente a escandallo"       , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"LKITPRC"     ,"L",  1, 0, ""                                      , "" ,             "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NMESGRT"     ,"N",  2, 0, "Meses de garantía"                     , "'99'",          "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"LMSGVTA"     ,"L",  1, 0, "Avisar venta sin stocks"               , "",              "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"LNOTVTA"     ,"L",  1, 0, "No permitir venta sin stocks"          , "",              "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CCODTIP"     ,"C",  3, 0, "Código del tipo de artículo"           , "",              "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"MNUMSER"     ,"M", 10, 0, ""                                      , "",              "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CCODFAM"     ,"C", 16, 0, "Código de familia"                     , "",              "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CGRPFAM"     ,"C",  3, 0, "Código del grupo de familia"           , "",              "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"NREQ"        ,"N", 16, 6, "Recargo de equivalencia"               , "",              "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"MOBSLIN"     ,"M", 10, 0, "Observaciones de linea"                , "",              "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CCODPRV"     ,"C", 12, 0, "Código del proveedor"                  , "",              "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"CNOMPRV"     ,"C", 30, 0, "Nombre del proveedor"                  , "",              "", "( cDbfCol )"} )
   aAdd( aColFacCli, {"cImagen"     ,"C",128, 0, "Fichero de imagen"                     , "",              "", "( cDbfCol )", .T. } )
   aAdd( aColFacCli, {"NPUNTOS"     ,"N", 15, 6, "Puntos del artículo"                   , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, {"NVALPNT"     ,"N", 16, 6, "Valor del punto"                       , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, {"NDTOPNT"     ,"N",  5, 2, "Descuento puntos"                      , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, {"NINCPNT"     ,"N",  5, 2, "Incremento porcentual"                 , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, {"CREFPRV"     ,"C", 18, 0, "Referencia proveedor"                  , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, {"NVOLUMEN"    ,"N", 16, 6, "Volumen del producto"                  , "'@E 9,999.99'", "", "( cDbfCol )" } )
   aAdd( aColFacCli, {"CVOLUMEN"    ,"C",  2, 0, "Unidad del volumen"                    , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, {"LALQUILER"   ,"L",  1, 0, "Lógico de línea de alquiler"           , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, {"DFECENT"     ,"D",  8, 0, "Fecha de entrada del alquiler"         , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, {"DFECSAL"     ,"D",  8, 0, "Fecha de salida del alquiler"          , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, {"NPREALQ"     ,"N", 16, 6, "Precio de alquiler"                    , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "nNumMed"    ,"N",  1, 0, "Número de mediciones"                  , "MasUnd()",      "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "nMedUno"    ,"N", 16, 6, "Primera unidad de medición"            , "MasUnd()",      "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "nMedDos"    ,"N", 16, 6, "Segunda unidad de medición"            , "MasUnd()",      "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "nMedTre"    ,"N", 16, 6, "Tercera unidad de medición"            , "MasUnd()",      "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "nTarLin"    ,"N",  1, 0, "Tarifa de precio aplicada"             , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "lImpFra",   "L",   1, 0, "Lógico de imprimir frase publicitaria" , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "cCodFra",   "C",   3, 0, "Código de la frase publicitaria"       , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "cTxtFra",   "C", 250, 0, "Texto de la frase publicitaria"        , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "Descrip",   "M",  10, 0, "Descripción larga"                     , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "lLinOfe",   "L",   1, 0, "Linea con oferta"                      , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "lVolImp",   "L",   1, 0, "Aplicar volumen impuestos especiales"  , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "lGasSup",   "L",   1, 0, "Linea de gastos suplidos"              , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "cNumPed"   ,"C",  12, 0, "Número del pedido"                     , "",              "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "dFecFac"   ,"D",   8, 0, "Fecha de factura"                      , "" ,             "", "( cDbfCol )" } )
   aAdd( aColFacCli, { "cSuPed"    ,"C",  50, 0, "Su pedido (desde albarán)"             , "" ,             "", "( cDbfCol )" } )

return ( aColFacCli )



function aItmFacCli()

   local aItmFacCli  := {}

   aAdd( aItmFacCli, {"CSERIE"      ,"C",  1, 0, "Serie de la factura" ,                                 "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NNUMFAC"     ,"N",  9, 0, "Número de la factura" ,                                "'999999999'",        "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CSUFFAC"     ,"C",  2, 0, "Sufijo de la factura" ,                                "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CTURFAC"     ,"C",  6, 0, "Sesión de la factura" ,                                "######",             "", "( cDbf )"} )
   aAdd( aItmFacCli, {"DFECFAC"     ,"D",  8, 0, "Fecha de la factura" ,                                 "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CCODCLI"     ,"C", 12, 0, "Código del cliente" ,                                  "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CCODALM"     ,"C",  3, 0, "Código de almacén" ,                                   "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CCODCAJ"     ,"C",  3, 0, "Código de caja" ,                                      "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CNOMCLI"     ,"C", 80, 0, "Nombre del cliente" ,                                  "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CDIRCLI"     ,"C",100, 0, "Domicilio del cliente" ,                               "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CPOBCLI"     ,"C", 25, 0, "Población del cliente" ,                               "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CPRVCLI"     ,"C", 20, 0, "Provincia del cliente" ,                               "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NCODPROV"    ,"N",  2, 0, "Número de provincia cliente" ,                         "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CPOSCLI"     ,"C", 15, 0, "Código postal del cliente" ,                           "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CDNICLI"     ,"C", 30, 0, "NIF del cliente" ,                                     "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"LMODCLI"     ,"L",  1, 0, "Lógico de modificar datos del cliente" ,               "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"LMAYOR"      ,"L",  1, 0, "Lógico de mayorista" ,                                 "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NTARIFA"     ,"N",  1, 0, "Tarifa de precio aplicada" ,                           "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CCODAGE"     ,"C",  3, 0, "Código del agente" ,                                   "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CCODRUT"     ,"C",  4, 0, "Código de la ruta" ,                                   "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CCODTAR"     ,"C",  5, 0, "Código de la tarifa" ,                                 "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CCODOBR"     ,"C", 10, 0, "Código de la obra" ,                                   "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NPCTCOMAGE"  ,"N",  6, 2, "Porcentaje de comisión del agente" ,                   "'@E 999,99'",        "", "( cDbf )"} )
   aAdd( aItmFacCli, {"LLIQUIDADA"  ,"L",  1, 0, "Lógico de la liquidación" ,                            "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"LCONTAB"     ,"L",  1, 0, "Lógico de la contabilización" ,                        "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"DFECENT"     ,"D",  8, 0, "Fecha de entrega" ,                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CSUFAC"      ,"C", 50, 0, "Su factura" ,                                          "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"LIMPALB"     ,"L",  1, 0, "Lógico si la factura se importó de albaranes" ,        "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CCONDENT"    ,"C",100, 0, "Condición de entrada" ,                                "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"MCOMENT"     ,"M", 10, 0, "Comentarios" ,                                         "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"MOBSERV"     ,"M", 10, 0, "Observaciones" ,                                       "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CCODPAGO"    ,"C",  2, 0, "Código del tipo de pago" ,                             "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NBULTOS"     ,"N",  3, 0, "Número de bultos" ,                                    "999,999",            "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NPORTES"     ,"N",  6, 0, "Valor del porte" ,                                     "cPorDivFac",         "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NIVAMAN"     ,"N",  6, 2, "Porcentaje de " + cImp() + " del gasto" ,              "'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NMANOBR"     ,"N", 16, 6, "Gasto" ,                                               "cPorDivFac",         "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CNUMALB"     ,"C", 12, 0, "Número de albarán" ,                                   "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CNUMPED"     ,"C", 12, 0, "Número de pedido" ,                                    "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CNUMPRE"     ,"C", 12, 0, "Número de presupuesto" ,                               "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NTIPOFAC"    ,"N",  1, 0, "" ,                                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cDtoEsp"     ,"C", 50, 0, "Descripción de porcentaje de descuento especial" ,     "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nDtoEsp"     ,"N",  6, 2, "Porcentaje de descuento especial" ,                    "'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cDpp"        ,"C", 50, 0, "Descripción de porcentaje de descuento por pronto pago","",                  "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nDpp"        ,"N",  6, 2, "Porcentaje de descuento por pronto pago" ,             "'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CDTOUNO"     ,"C", 25, 0, "Descripción de porcentaje de descuento personalizado", "'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NDTOUNO"     ,"N",  6, 2, "Porcentaje de descuento por descuento personalizado" , "'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CDTODOS"     ,"C", 25, 0, "Descripción de porcentaje de descuento personalizado" ,"'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NDTODOS"     ,"N",  4, 1, "Porcentaje de descuento por descuento personalizado" , "'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NDTOCNT"     ,"N",  6, 2, "" ,                                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NDTORAP"     ,"N",  6, 2, "" ,                                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NDTOPUB"     ,"N",  6, 2, "" ,                                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NDTOPGO"     ,"N",  6, 2, "" ,                                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NDTOPTF"     ,"N",  7, 2, "" ,                                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NTIPOIVA"    ,"N",  1, 0, "" ,                                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NPORCIVA"    ,"N",  4, 1, "" ,                                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"LRECARGO"    ,"L",  1, 0, "Lógico para recargo" ,                                 "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CREMITIDO"   ,"C", 50, 0, "Campo de remitido" ,                                   "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"LIVAINC"     ,"L",  1, 0, "Lógico " + cImp() + " incluido" ,                      "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"LSNDDOC"     ,"L",  1, 0, "Lógico para documento enviado" ,                       "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CDIVFAC"     ,"C",  3, 0, "Código de la divisa" ,                                 "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NVDVFAC"     ,"N", 10, 4, "Cambio de la divisa" ,                                 "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CRETPOR"     ,"C",100, 0, "Retirado por" ,                                        "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CRETMAT"     ,"C", 20, 0, "Matrícula" ,                                           "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CNUMDOC"     ,"C", 13, 0, "" ,                                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NREGIVA"     ,"N",  1, 0, "Régimen de " + cImp() ,                                "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CCODPRO"     ,"C",  9, 0, "Código de proyecto en contabilidad" ,                  "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CDOCORG"     ,"C", 10, 0, "Número del documento origen" ,                         "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NNUMLIQ"     ,"N",  9, 0, "Número liquidación",                                   "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"CSUFLIQ"     ,"C",  2, 0, "Sufijo de la liquidación",                             "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"NIMPLIQ"     ,"N", 16, 6, "Importe liquidación",                                  "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"DFECLIQ"     ,"D",  8, 0, "Fecha liquidación",                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cCodTrn"     ,"C",  9, 0, "Código del transportista" ,                            "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nKgsTrn"     ,"N", 16, 6, "TARA del transportista" ,                              "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"lCloFac"     ,"L",  1, 0, "" ,                                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cAbnFac"     ,"C", 12, 0, "" ,                                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cAntFac"     ,"C", 12, 0, "Factura de anticipo" ,                                 "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nTipRet"     ,"N",  1, 0, "Tipo de retención ( 1. Base / 2. Base+IVA )",          "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nPctRet"     ,"N",  6, 2, "Porcentaje de retención",                              "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cCodUsr"     ,"C",  3, 0, "Código de usuario",                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"dFecCre"     ,"D",  8, 0, "Fecha de creación/modificación del documento",         "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cTimCre"     ,"C",  5, 0, "Hora de creación/modificación del documento",          "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cCodGrp"     ,"C",  4, 0, "Código de grupo de cliente" ,                          "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"lImprimido"  ,"L",  1, 0, "Lógico de imprimido" ,                                 "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"dFecImp"     ,"D",  8, 0, "Última fecha de impresión" ,                           "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cHorImp"     ,"C",  5, 0, "Hora de la última impresión" ,                         "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cCodDlg"     ,"C",  2, 0, "Código delegación" ,                                   "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nDtoAtp"     ,"N",  6, 2, "Porcentaje de descuento atípico",                      "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nSbrAtp"     ,"N",  1, 0, "Lugar donde aplicar dto atípico",                      "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"dFecEntr"    ,"D",  8,  0, "Fecha de entrada de alquiler",                        "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"dFecSal"     ,"D",  8,  0, "Fecha de salida de alquiler",                         "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"lAlquiler"   ,"L",  1,  0, "Lógico de alquiler",                                  "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"lPayCli"     ,"L",  1,  0, "Lógico a pagar por el cliente",                       "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nPayCli"     ,"N", 16,  6, "A pagar por el cliente",                              "cPorDivFac",         "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cManObr"     ,"C",250,  0, "Literal de gastos",                                   "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"lExpEdi"     ,"L",  1,  0, "Lógico de factura exportada a EDI",                   "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"dFecEdi"     ,"D",  8,  0, "Fecha exportación a EDI",                             "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cHorEdi"     ,"C",  5,  0, "Hora exportación a EDI",                              "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cSuAlb"      ,"C", 25,  0, "Referencia a su albarán",                             "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"lExpFac"     ,"L",  1,  0, "Lógico de factura exportada a Facturae 3.1 [Factura electrónica]", "",      "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cTlfCli"     ,"C", 20,  0, "Teléfono del cliente" ,                               "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nTotNet"     ,"N", 16,  6, "Total neto" ,                                         "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nTotSup"     ,"N", 16,  6, "Total gastos suplidos" ,                              "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nTotIva"     ,"N", 16,  6, "Total " + cImp() ,                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nTotReq"     ,"N", 16,  6, "Total recargo" ,                                      "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nTotFac"     ,"N", 16,  6, "Total factura" ,                                      "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nEntIni"     ,"N",  6,  2, "Porcentaje de entrega inicial" ,                      "'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nPctDto"     ,"N",  6,  2, "Porcentaje de descuento por entrega inicial" ,        "'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cNFC"        ,"C", 20,  0, "Código NFC" ,                                         "'@!",                "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cFacPrv"     ,"C", 12,  0, "Factura de proveedor" ,                               "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cBanco"      ,"C", 50,  0, "Nombre del banco del cliente" ,                       "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cEntBnc"     ,"C",  4,  0, "Entidad de la cuenta bancaria del cliente" ,          "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cSucBnc"     ,"C",  4,  0, "Sucursal de la cuenta bancaria del cliente" ,         "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cDigBnc"     ,"C",  2,  0, "Dígito de control de la cuenta bancaria del cliente" ,"",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"cCtaBnc"     ,"C", 10,  0, "Cuenta bancaria del cliente" ,                        "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nTotLiq"     ,"N", 16,  6, "Total liquidado" ,                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"nTotPdt"     ,"N", 16,  6, "Total pendiente" ,                                    "",                   "", "( cDbf )"} )
   aAdd( aItmFacCli, {"lOperPV"     ,"L", 1,   0, "Lógico para operar con punto verde" ,                 "",                   "", "( cDbf )"} )

RETURN ( aItmFacCli )



Function aSerFacCli()

   local aColFacCli  := {}

   aAdd( aColFacCli,  { "cSerFac",     "C",  1,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacCli,  { "nNumFac",     "N",  9,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacCli,  { "cSufFac",     "C",  2,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacCli,  { "dFecFac",     "D",  8,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacCli,  { "nNumLin",     "N",  4,   0, "Número de la línea",               "'9999'",            "", "( cDbfCol )" } )
   aAdd( aColFacCli,  { "cRef",        "C", 18,   0, "Referencia del artículo",          "",                  "", "( cDbfCol )" } )
   aAdd( aColFacCli,  { "cAlmLin",     "C",  3,   0, "Almacen del artículo",             "",                  "", "( cDbfCol )" } )
   aAdd( aColfacCli,  { "lUndNeg",     "L",  1,   0, "Lógico de unidades en negativo",   "",                  "", "( cDbfCol )" } )
   aAdd( aColFacCli,  { "cNumSer",     "C", 30,   0, "Número de serie",                  "",                  "", "( cDbfCol )" } )

Return ( aColFacCli )







FUNCTION nTotFacCli( cFactura, cFacCliT, cFacCliL, cIva, cDiv, cFacCliP, cAntCliT, aTmp, cDivRet, lPic, lExcCnt, lNeto )

   local nRec
   local nOrd
   local nTotalArt
    local bCondition
    local lRecargo
    local nDtoUno
    local nDtoDos
    local nDtoEsp
   local nTipRet
   local nPctRet
   local nEntIni
   local nDtoIni
   local nDtoPP
   local nPorte
   local nManObr
   local nIvaMan
   local lIvaInc
   local nSbrAtp
   local nDtoAtp
   local nKgsTrn
   local nTotalLin         := 0
   local nTotalUnd         := 0
   local aTotalDto         := { 0, 0, 0 }
   local aTotalDPP         := { 0, 0, 0 }
   local aTotalUno         := { 0, 0, 0 }
   local aTotalDos         := { 0, 0, 0 }
   local aTotalAtp         := { 0, 0, 0 }
   local aTotalEnt         := { 0, 0, 0 }
   local nDescuentosLineas := 0
   local lPntVer           := .F.

   IIF( cFacCliT == nil, cFacCliT := dbfFacCliT, ) ;
   IIF( cFacCliL == nil, cFacCliL := dbfFacCliL, ) ;
   IIF( cFacCliP == nil, cFacCliP := dbfFacCliP, ) ;
   IIF( cAntCliT == nil, cAntCliT := dbfAntCliT, ) ;
   IIF( cIva == nil, cIva := dbfIva, ) ;
   IIF( cDiv == nil, cDiv := dbfDiv, ) ;
   IIF( cFactura == nil, cFactura := ( cFacCliT )->cSerie + Str( ( cFacCliT )->nNumFac ) + ( cFacCliT )->cSufFac, ) ;
   IIF( lPic == nil, lPic := .F., ) ;
   IIF( lNeto == nil, lNeto := .F., ) ;

   if Empty( Select( cFacCliT ) )
      Return ( 0 )
   end

   if Empty( Select( cFacCliL ) )
      Return ( 0 )
   end

   if Empty( Select( cIva ) )
      Return ( 0 )
   end

   if Empty( Select( cDiv ) )
      Return ( 0 )
   end





   public nTotFac    := 0
   public nTotBrt    := 0
   public nTotDto    := 0
   public nTotDPP    := 0
   public nTotNet    := 0
   public nTotSup    := 0
   public nTotIva    := 0
   public nTotIvm    := 0
   public nTotAge    := 0
   public nTotReq    := 0
   public nTotPnt    := 0
   public nTotUno    := 0
   public nTotDos    := 0
   public nTotRet    := 0
   public nTotTrn    := 0
   public nTotAnt    := 0
   public nTotCos    := 0
   public nTotCob    := 0
   public nTotPes    := 0
   public nTotRnt    := 0
   public nTotAtp    := 0
   public nTotArt    := 0
   public nTotCaj    := 0
   public nTotImp    := 0
   public nTotPctRnt := 0
   public nTotalDto  := 0
   public cCtaCli    := cClientCuenta( ( cFacCliT )->cCodCli )

   public aTotIva    := { { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 } }
   public aIvaUno    := aTotIva[ 1 ]
   public aIvaDos    := aTotIva[ 2 ]
   public aIvaTre    := aTotIva[ 3 ]

   public aTotIvm    := { { 0,0,0 }, { 0,0,0 }, { 0,0,0 }, }
   public aIvmUno    := aTotIvm[ 1 ]
   public aIvmDos    := aTotIvm[ 2 ]
   public aIvmTre    := aTotIvm[ 3 ]

   public aImpVto    := {}
   public aDatVto    := {}

   nRec              := ( cFacCliL )->( Recno() )

   if aTmp <> nil
      nDtoUno        := aTmp[ 46 ]
      nDtoDos        := aTmp[ 48 ]
      lRecargo       := aTmp[ 56]
        nDtoEsp            := aTmp[ 42 ]
      nDtoPP         := aTmp[ 44    ]
      nPorte         := aTmp[ 34 ]
        nManObr            := aTmp[ 36 ]
      nIvaMan        := aTmp[ 35 ]
      lIvaInc        := aTmp[ 58 ]
      cCodDiv        := aTmp[ 60 ]
      nTipRet        := aTmp[ 77 ]
      nPctRet        := aTmp[ 78 ]
      nSbrAtp        := aTmp[ 88 ]
      nDtoAtp        := aTmp[ 87 ]
      nKgsTrn        := aTmp[ 73 ]
      nEntIni        := aTmp[ 106 ]
      nDtoIni        := aTmp[ 107 ]
      lPntVer        := aTmp[ 117 ]
      bCondition     := {|| ( cFacCliL )->( !eof() ) }
      ( cFacCliL )->( dbGoTop() )
   else
      nDtoUno        := ( cFacCliT )->nDtoUno
      nDtoDos        := ( cFacCliT )->nDtoDos
      nDtoEsp        := ( cFacCliT )->nDtoEsp
      nDtoPP         := ( cFacCliT )->nDpp
      lRecargo       := ( cFacCliT )->lRecargo
      nPorte         := ( cFacCliT )->nPortes
      nManObr        := ( cFacCliT )->nManObr
      nIvaMan        := ( cFacCliT )->nIvaMan
      lIvaInc        := ( cFacCliT )->lIvaInc
      cCodDiv        := ( cFacCliT )->cDivFac
      nTipRet        := ( cFacCliT )->nTipRet
      nPctRet        := ( cFacCliT )->nPctRet
      nSbrAtp        := ( cFacCliT )->nSbrAtp
      nDtoAtp        := ( cFacCliT )->nDtoAtp
      nKgsTrn        := ( cFacCliT )->nKgsTrn
      nEntIni        := ( cFacCliT )->nEntIni
      nDtoIni        := ( cFacCliT )->nPctDto
      lPntVer        := ( cFacCliT )->lOperPV
      bCondition     := {|| ( cFacCliL )->cSerie + Str( ( cFacCliL )->nNumFac ) + ( cFacCliL )->cSufFac == cFactura .AND. ( cFacCliL)->(!eof() ) }
      ( cFacCliL )->( dbSeek( cFactura ) )
   end





   cPouDiv           := cPouDiv( cCodDiv, cDiv )
   cPorDiv           := cPorDiv( cCodDiv, cDiv )
   cPpvDiv           := cPpvDiv( cCodDiv, cDiv )
   nDouDiv           := nDouDiv( cCodDiv, cDiv )
   nRouDiv           := nRouDiv( cCodDiv, cDiv )
   nDpvDiv           := nDpvDiv( cCodDiv, cDiv )

   while Eval( bCondition )

      if lValLine( cFacCliL )



         if ( lExcCnt == nil                                .OR. ( lExcCnt .AND. ( cFacCliL )->nCtlStk <> 2 )    .OR. ( !lExcCnt .AND. ( cFacCliL )->nCtlStk == 2 ) )

            if ( cFacCliL )->lTotLin





               if ( cFacCliL )->nPreUnit <> nTotalLin .OR. ( cFacCliL )->nUniCaja <> nTotalUnd

                  if ( cFacCliL )->( dbRLock() )
                     ( cFacCliL )->nPreUnit := nTotalLin
                     ( cFacCliL )->nUniCaja := nTotalUnd
                     ( cFacCliL )->( dbUnLock() )
                  end

               end





               nTotalLin         := 0
               nTotalUnd         := 0

            else

               nTotalArt         := nTotLFacCli( cFacCliL, nDouDiv, nRouDiv, , , .F., .F. )
               nTotTrn           := nTrnLFacCli( cFacCliL, nDouDiv )
               nTotIvm           := nTotIFacCli( cFacCliL, nDouDiv, nRouDiv )
               nTotPnt           := if( lPntVer, nPntLFacCli( cFacCliL, nDpvDiv ), 0 )
               nTotCos           += nCosLFacCli( cFacCliL, nDouDiv, nRouDiv )
               nTotPes           += nPesLFacCli( cFacCliL )


               nDescuentosLineas += nTotDtoLFacCli( cFacCliL, nDouDiv )


               if aTmp <> nil
                  nTotAge        += nComLFacCli( aTmp, cFacCliL, nDouDiv, nRouDiv )
               else
                  nTotAge        += nComLFacCli( cFacCliT, cFacCliL, nDouDiv, nRouDiv )
               end





               nTotalLin         += nTotalArt

               if ( cFacCliL )->lGasSup
                  nTotSup        += nTotalArt
               end

               nTotalUnd         += nTotNFacCli( cFacCliL )

               nTotArt           += nTotNFacCli( cFacCliL )
               nTotCaj           += ( cFacCliL )->nCanEnt





               do case
               case aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 1, 3 ] == ( cFacCliL )->nIva

                  aTotIva[ 1, 3 ]   := ( cFacCliL )->nIva
                  aTotIva[ 1, 4 ]   := ( cFacCliL )->nReq
                  aTotIva[ 1, 1 ]   += nTotalArt
                  aTotIva[ 1, 6 ]   += nTotIvm
                  aTotIva[ 1, 7 ]   += nTotTrn
                  aTotIva[ 1, 5 ]   += nTotPnt

               case aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 2, 3 ] == ( cFacCliL )->nIva

                  aTotIva[ 2, 3 ]   := ( cFacCliL )->nIva
                  aTotIva[ 2, 4 ]   := ( cFacCliL )->nReq
                  aTotIva[ 2, 1 ]   += nTotalArt
                  aTotIva[ 2, 6 ]   += nTotIvm
                  aTotIva[ 2, 7 ]   += nTotTrn
                  aTotIva[ 2, 5 ]   += nTotPnt

               case aTotIva[ 3, 3 ] == nil .OR. aTotIva[ 3, 3 ] == ( cFacCliL )->nIva

                  aTotIva[ 3, 3 ]   := ( cFacCliL )->nIva
                  aTotIva[ 3, 4 ]   := ( cFacCliL )->nReq
                  aTotIva[ 3, 1 ]   += nTotalArt
                  aTotIva[ 3, 6 ]   += nTotIvm
                  aTotIva[ 3, 7 ]   += nTotTrn
                  aTotIva[ 3, 5 ]   += nTotPnt

               end



               if ( cFacCliL )->nValImp <> 0

                  do case
                  case aTotIvm[ 1, 2 ] == 0 .OR. ( aTotIvm[ 1, 2 ] == Round( ( cFacCliL )->nValImp, nDouDiv ) )

                     aTotIvm[ 1, 1 ]   += nTotNFacCli( cFacCliL ) * if( ( cFacCliL )->lVolImp, NotCero( ( cFacCliL )->nVolumen ), 1 )
                     aTotIvm[ 1, 2 ]   := Round( ( cFacCliL )->nValImp, nDouDiv )
                     aTotIvm[ 1, 3 ]   := Round( aTotIvm[ 1, 1 ] * aTotIvm[ 1, 2 ], nRouDiv )

                  case aTotIvm[ 2, 2 ] == 0 .OR. ( aTotIvm[ 2, 2 ] == Round( ( cFacCliL )->nValImp, nDouDiv ) )

                     aTotIvm[ 2, 1 ]   += nTotNFacCli( cFacCliL ) * if( ( cFacCliL )->lVolImp, NotCero( ( cFacCliL )->nVolumen ), 1 )
                     aTotIvm[ 2, 2 ]   := Round( ( cFacCliL )->nValImp, nDouDiv )
                     aTotIvm[ 2, 3 ]   := Round( aTotIvm[ 2, 1 ] * aTotIvm[ 2, 2 ], nRouDiv )

                  case aTotIvm[ 3, 2 ] == 0 .OR. ( aTotIvm[ 3, 2 ] == Round( ( cFacCliL )->nValImp, nDouDiv ) )

                     aTotIvm[ 3, 1 ]   += nTotNFacCli( cFacCliL ) * if( ( cFacCliL )->lVolImp, NotCero( ( cFacCliL )->nVolumen ), 1 )
                     aTotIvm[ 3, 2 ]   := Round( ( cFacCliL )->nValImp, nDouDiv )
                     aTotIvm[ 3, 3 ]   := Round( aTotIvm[ 3, 1 ] * aTotIvm[ 3, 2 ], nRouDiv )

                  end

               end

            end

         else





            nTotalLin   := 0
            nTotalUnd   := 0

         end

      end

      ( cFacCliL )->( dbSkip() )

   end

   ( cFacCliL )->( dbGoTo( nRec ) )





   aTotIva           := aSort( aTotIva,,, {|x,y| if( x[3] <> nil, x[3], -1 ) > if( y[3] <> nil, y[3], -1 )  } )

   aTotIva[ 1, 2 ]         := Round( aTotIva[ 1, 1 ], nRouDiv )
   aTotIva[ 2, 2 ]         := Round( aTotIva[ 2, 1 ], nRouDiv )
   aTotIva[ 3, 2 ]         := Round( aTotIva[ 3, 1 ], nRouDiv )

   nTotBrt           := aTotIva[ 1, 1 ] + aTotIva[ 2, 1 ] + aTotIva[ 3, 1 ]





   if nSbrAtp <= 1 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end

    IF nDtoEsp     <> 0

      aTotalDto[1]   := Round( aTotIva[ 1, 2 ] * nDtoEsp / 100, nRouDiv )
      aTotalDto[2]   := Round( aTotIva[ 2, 2 ] * nDtoEsp / 100, nRouDiv )
      aTotalDto[3]   := Round( aTotIva[ 3, 2 ] * nDtoEsp / 100, nRouDiv )

      nTotDto        := aTotalDto[1] + aTotalDto[2] + aTotalDto[3]

        aTotIva[ 1, 2 ]        -= aTotalDto[1]
        aTotIva[ 2, 2 ]        -= aTotalDto[2]
        aTotIva[ 3, 2 ]        -= aTotalDto[3]

    end





   if nSbrAtp == 2 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp      := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end





   if nDtoPP <> 0

      aTotalDPP[1]   := Round( aTotIva[ 1, 2 ] * nDtoPP / 100, nRouDiv )
      aTotalDPP[2]   := Round( aTotIva[ 2, 2 ] * nDtoPP / 100, nRouDiv )
      aTotalDPP[3]   := Round( aTotIva[ 3, 2 ] * nDtoPP / 100, nRouDiv )

      nTotDPP        := aTotalDPP[ 1 ] + aTotalDPP[ 2 ] + aTotalDPP[ 3 ]

        aTotIva[ 1, 2 ]        -= aTotalDPP[1]
        aTotIva[ 2, 2 ]        -= aTotalDPP[2]
        aTotIva[ 3, 2 ]        -= aTotalDPP[3]

   end





   if nSbrAtp == 3 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp      := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end

   if nDtoUno <> 0

      aTotalUno[1]   := Round( aTotIva[ 1, 2 ] * nDtoUno / 100, nRouDiv )
      aTotalUno[2]   := Round( aTotIva[ 2, 2 ] * nDtoUno / 100, nRouDiv )
      aTotalUno[3]   := Round( aTotIva[ 3, 2 ] * nDtoUno / 100, nRouDiv )

      nTotUno        := aTotalUno[ 1 ] + aTotalUno[ 2 ] + aTotalUno[ 3 ]

      aTotIva[ 1, 2 ]      -= aTotalUno[ 1 ]
      aTotIva[ 2, 2 ]      -= aTotalUno[ 2 ]
      aTotIva[ 3, 2 ]      -= aTotalUno[ 3 ]

   end





   if nSbrAtp == 4 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp      := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end

   if nDtoDos <> 0

      aTotalDos[1]   := Round( aTotIva[ 1, 2 ] * nDtoDos / 100, nRouDiv )
      aTotalDos[2]   := Round( aTotIva[ 2, 2 ] * nDtoDos / 100, nRouDiv )
      aTotalDos[3]   := Round( aTotIva[ 3, 2 ] * nDtoDos / 100, nRouDiv )

      nTotDos        := aTotalDos[ 1 ] + aTotalDos[ 2 ] + aTotalDos[ 3 ]

      aTotIva[ 1, 2 ]      -= aTotalDos[ 1 ]
      aTotIva[ 2, 2 ]      -= aTotalDos[ 2 ]
      aTotIva[ 3, 2 ]      -= aTotalDos[ 3 ]

   end





   if nSbrAtp == 5 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end





   if nDtoIni <> 0

      aTotalEnt[1]   := Round( aTotIva[ 1, 2 ] * nDtoIni / 100, nRouDiv )
      aTotalEnt[2]   := Round( aTotIva[ 2, 2 ] * nDtoIni / 100, nRouDiv )
      aTotalEnt[3]   := Round( aTotIva[ 3, 2 ] * nDtoIni / 100, nRouDiv )

      nTotDtoEnt     := aTotalEnt[ 1 ] + aTotalEnt[ 2 ] + aTotalEnt[ 3 ]

      aTotIva[ 1, 2 ]      -= aTotalEnt[ 1 ]
      aTotIva[ 2, 2 ]      -= aTotalEnt[ 2 ]
      aTotIva[ 3, 2 ]      -= aTotalEnt[ 3 ]

   end










   if nManObr <> 0

      do case
      case aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 1, 3 ] == nIvaMan

         aTotIva[ 1, 3 ]   := nIvaMan
         aTotIva[ 1, 2 ]   += nManObr

      case aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 2, 3 ] == nIvaMan

         aTotIva[ 2, 3 ]   := nIvaMan
         aTotIva[ 2, 2 ]   += nManObr

      case aTotIva[ 3, 3 ] == nil .OR. aTotIva[ 3, 3 ] == nIvaMan

         aTotIva[ 3, 3 ]   := nIvaMan
         aTotIva[ 3, 2 ]   += nManObr

      end

   end





   aTotIva[ 1, 2 ]         += aTotIva[ 1, 7 ]
   aTotIva[ 2, 2 ]         += aTotIva[ 2, 7 ]
   aTotIva[ 3, 2 ]         += aTotIva[ 3, 7 ]





   aTotIva[ 1, 2 ]         += aTotIva[ 1, 5 ]
   aTotIva[ 2, 2 ]         += aTotIva[ 2, 5 ]
   aTotIva[ 3, 2 ]         += aTotIva[ 3, 5 ]





   if uFieldEmpresa( "lIvaImpEsp" )
      aTotIva[ 1, 2 ]      += aTotIva[ 1, 6 ]
      aTotIva[ 2, 2 ]      += aTotIva[ 2, 6 ]
      aTotIva[ 3, 2 ]      += aTotIva[ 3, 6 ]
   end





   if !Empty( cAntCliT )

      if aTmp <> nil

         nRec                 := ( cAntCliT )->( Recno() )

         ( cAntCliT )->( dbGoTop() )
         while !( cAntCliT )->( eof() )

            if lIvaInc
               nTotAnt        := nTotAntCli( cAntCliT, cIva, cDiv )
            else
               nTotAnt        := nNetAntCli( cAntCliT, cIva, cDiv )
            end

            if !IsNil( aTotIva[ 1, 3 ] )
               aTotIva[ 1, 2 ]      -= nTotAnt
            end





















            ( cAntCliT )->( dbSkip() )

         end

         ( cAntCliT )->( dbGoTo( nRec ) )

      else

         nRec                    := ( cAntCliT )->( Recno() )
         nOrd                    := ( cAntCliT )->( OrdSetFocus( "cNumDoc" ) )

         if ( cAntCliT )->( dbSeek( cFactura ) )

            while ( ( cAntCliT )->cNumDoc == cFactura .AND. !( cAntCliT )->( eof() ) )

               if lIvaInc
                  nTotAnt        := nTotAntCli( cAntCliT, cIva, cDiv )
               else
                  nTotAnt        := nNetAntCli( cAntCliT, cIva, cDiv )
               end

               if aTotIva[ 1, 2 ] <> 0
                  aTotIva[ 1, 2 ]      -= nTotAnt
               end




















               ( cAntCliT )->( dbSkip() )

            end

         end

         ( cAntCliT )->( OrdSetFocus( nOrd ) )
         ( cAntCliT )->( dbGoTo( nRec ) )

      end

   end

   nTotCob           := nPagFacCli( cFactura, cFacCliT, cFacCliP, cIva, cDiv, nil, .T. )





   if lIvaInc

      if aTotIva[ 1, 3 ] <> 0
         aTotIva[ 1, 8 ]   := if( aTotIva[ 1, 3 ] <> nil, Round( aTotIva[ 1, 2 ] / ( Div( 100, aTotIva[ 1, 3 ] ) + 1 ), nRouDiv ), 0 )
      end
      if aTotIva[ 2, 3 ] <> 0
         aTotIva[ 2, 8 ]   := if( aTotIva[ 2, 3 ] <> nil, Round( aTotIva[ 2, 2 ] / ( Div( 100, aTotIva[ 2, 3 ] ) + 1 ), nRouDiv ), 0 )
      end
      if aTotIva[ 3, 3 ] <> 0
         aTotIva[ 3, 8 ]   := if( aTotIva[ 3, 3 ] <> nil, Round( aTotIva[ 3, 2 ] / ( Div( 100, aTotIva[ 3, 3 ] ) + 1 ), nRouDiv ), 0 )
      end

      if lRecargo

         if aTotIva[ 1, 4 ] <> 0
            aTotIva[ 1, 9 ]   := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] / ( Div( 100, aTotIva[ 1, 4 ] ) + 1 ), nRouDiv ), 0 )
         end
         if aTotIva[ 2, 4 ] <> 0
            aTotIva[ 2, 9 ]   := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] / ( Div( 100, aTotIva[ 2, 4 ] ) + 1 ), nRouDiv ), 0 )
         end
         if aTotIva[ 3, 4 ] <> 0
            aTotIva[ 3, 9 ]   := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] / ( Div( 100, aTotIva[ 3, 4 ] ) + 1 ), nRouDiv ), 0 )
         end

      end

      aTotIva[ 1, 2 ]      -= aTotIva[ 1, 8 ]
      aTotIva[ 2, 2 ]      -= aTotIva[ 2, 8 ]
      aTotIva[ 3, 2 ]      -= aTotIva[ 3, 8 ]

      aTotIva[ 1, 2 ]      -= aTotIva[ 1, 9 ]
      aTotIva[ 2, 2 ]      -= aTotIva[ 2, 9 ]
      aTotIva[ 3, 2 ]      -= aTotIva[ 3, 9 ]

   else

      aTotIva[ 1, 8 ]      := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 3 ] / 100, nRouDiv ), 0 )
      aTotIva[ 2, 8 ]      := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 3 ] / 100, nRouDiv ), 0 )
      aTotIva[ 3, 8 ]      := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 3 ] / 100, nRouDiv ), 0 )





      if lRecargo
         aTotIva[ 1, 9 ]   := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 4 ] / 100, nRouDiv ), 0 )
         aTotIva[ 2, 9 ]   := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 4 ] / 100, nRouDiv ), 0 )
         aTotIva[ 3, 9 ]   := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 4 ] / 100, nRouDiv ), 0 )
      end

   end





   nTotNet           := Round( aTotIva[ 1, 2 ] + aTotIva[ 2, 2 ] + aTotIva[ 3, 2 ], nRouDiv )





   nTotEnt           := Round( nTotNet * nEntIni / 100, nRouDiv )





   nTotNet           += nPorte





   nTotIvm           := Round( aTotIva[ 1, 6 ] + aTotIva[ 2, 6 ] + aTotIva[ 3, 6 ], nRouDiv )





   nTotTrn           := Round( aTotIva[ 1, 7 ] + aTotIva[ 2, 7 ] + aTotIva[ 3, 7 ], nRouDiv )





   nTotPnt           := Round( aTotIva[ 1, 5 ] + aTotIva[ 2, 5 ] + aTotIva[ 3, 5 ], nRouDiv )





   nTotIva           := Round( aTotIva[ 1, 8 ] + aTotIva[ 2, 8 ] + aTotIva[ 3, 8 ], nRouDiv )





   nTotReq           := Round( aTotIva[ 1, 9 ] + aTotIva[ 2, 9 ] + aTotIva[ 3, 9 ], nRouDiv )





   nTotImp           := Round( nTotIva + nTotReq , nRouDiv )





   if nTipRet <= 1
      nTotRet        := Round( ( nTotNet - nTotSup ) * nPctRet / 100, nRouDiv )
   else
      nTotRet        := Round( ( nTotNet - nTotSup + nTotIva ) * nPctRet / 100, nRouDiv )
   end





   nTotRnt           := Round(         nTotNet - nManObr - nTotAge - nTotPnt - nTotAtp - nTotCos, nRouDiv )

   nTotPctRnt        := nRentabilidad( nTotNet - nManObr - nTotAge - nTotPnt, nTotAtp, nTotCos )





   nTotFac           := Round( nTotNet + nTotImp - nTotRet, nRouDiv )





   nTotAge           := Round( nTotAge, nRouDiv )





   if nKgsTrn <> 0
      nTotalDif      := nKgsTrn - nTotPes
   else
      nTotalDif      := 0
   end





   nTotalDto         := nDescuentosLineas + nTotDto + nTotDpp + nTotUno + nTotDos + nTotAtp





   if !Empty( dbfFacCliP ) .AND. ( dbfFacCliP )->( Used() )

      nOrd           := ( dbfFacCliP )->( OrdSetFocus( "nNumFac" ) )

      if ( dbfFacCliP )->( dbSeek( cFactura ) )

         while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cFactura .AND. !( dbfFacCliP )->( eof() )

            aAdd( aImpVto, ( dbfFacCliP )->nImporte )
            aAdd( aDatVto, if( Empty( ( dbfFacCliP )->dFecVto ), ( dbfFacCliP )->dPreCob,  ( dbfFacCliP )->dFecVto ) )

            ( dbfFacCliP )->( dbSkip() )

         end

      end

      ( dbfFacCliP )->( OrdSetFocus( nOrd ) )

   end





   if cDivRet <> nil .AND. cDivRet <> cCodDiv
      nTotNet        := nCnv2Div( nTotNet, cCodDiv, cDivRet, cDiv )
      nTotIva        := nCnv2Div( nTotIva, cCodDiv, cDivRet, cDiv )
      nTotReq        := nCnv2Div( nTotReq, cCodDiv, cDivRet, cDiv )
      nTotFac        := nCnv2Div( nTotFac, cCodDiv, cDivRet, cDiv )
      nTotRet        := nCnv2Div( nTotRet, cCodDiv, cDivRet, cDiv )
      nTotPnt        := nCnv2Div( nTotPnt, cCodDiv, cDivRet, cDiv )
      nTotTrn        := nCnv2Div( nTotTrn, cCodDiv, cDivRet, cDiv )
      nTotAnt        := nCnv2Div( nTotAnt, cCodDiv, cDivRet, cDiv )
      cPorDiv        := cPorDiv( cDivRet, cDiv )
   end

RETURN ( if( lPic, Trans( if( lNeto, nTotNet, nTotFac ), cPorDiv ), if( lNeto, nTotNet, nTotFac ) ) )



FUNCTION nComLFacCli( dbfFacCliT, dbfFacCliL, nDecOut, nDerOut )

   local nImpLFacCli  := nImpLFacCli( dbfFacCliT, dbfFacCliL, nDecOut, nDerOut, , .F., .T., .F., .F. )

RETURN ( Round( ( nImpLFacCli * ( dbfFacCliL )->nComAge / 100 ), nDerOut ) )



FUNCTION nPesLFacCli( dbfLin )

   local nCalculo

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;

   if !( dbfLin )->lTotLin
      nCalculo       := Abs( nTotNFacCli( dbfLin ) ) * ( dbfLin )->nPesoKg
   end

RETURN ( nCalculo )



FUNCTION nCosLFacCli( dbfLine, nDec, nRec, nVdv, cPouDiv )

   local nCalculo       := 0

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRec == nil, nRec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   if !( dbfLine )->lKitChl
      nCalculo          := nTotNFacCli( dbfLine )
      nCalculo          *= ( dbfLine )->nCosDiv
   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

   nCalculo             := Round( nCalculo, nRec )

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )







FUNCTION nPntLFacCli( dbfLin, nDec, nVdv )

   local nPntVer

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;





   nPntVer           := nPntUFacCli( dbfLin, nDec, nVdv ) * nTotNFacCli( dbfLin )

RETURN ( Round( nPntVer, nDec ) )



FUNCTION nTotIFacCli( dbfLin, nDec, nRouDec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRouDec == nil, nRouDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   if !( dbfLin )->lTotLin





      nCalculo       := Round( ( dbfLin )->nValImp, nDec )





      nCalculo       *= nTotNFacCli( dbfLin )

      if ( dbfLin )->lVolImp
         nCalculo    *= NotCero( ( dbfLin )->nVolumen )
      end

      nCalculo       := Round( nCalculo / nVdv, nRouDec )

   end

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nTrnLFacCli( dbfLin, nDec, nRou, nVdv )

   local nImpTrn

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := 2, ) ;
   IIF( nRou == nil, nRou := 2, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;





   nImpTrn           := nTrnUFacCli( dbfLin, nDec ) * nTotNFacCli( dbfLin )

   IF nVdv <> 0
      nImpTrn        := nImpTrn / nVdv
    end

RETURN ( Round( nImpTrn, nRou ) )







FUNCTION nImpUFacCli( uFacCliT, uFacCliL, nDec, nVdv, lIva )

   local lIvaInc
   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lIva == nil, lIva := .F., ) ;

   nCalculo       := nTotUFacCli( uFacCliL, nDec, nVdv )

   if IsArray( uFacCliT )

      nCalculo    -= Round( nCalculo * uFacCliT[ 42 ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacCliT[ 44    ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacCliT[ 46 ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacCliT[ 48 ]  / 100, nDec )
      lIvaInc     := uFacCliT[ 58 ]

   else

      nCalculo    -= Round( nCalculo * ( uFacCliT )->nDtoEsp / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacCliT )->nDpp    / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacCliT )->nDtoUno / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacCliT )->nDtoDos / 100, nDec )
      lIvaInc     := ( uFacCliT )->lIvaInc

   end

   if IsArray( uFacCliL )

      if lIva .AND. uFacCliL[ 11 ] <> 0
         if !lIvaInc
            nCalculo    += nCalculo * uFacCliL[ 11 ] / 100
         end
      else
         if lIvaInc .AND. uFacCliL[ 11 ] <> 0
            nCalculo    -= Round( nCalculo / ( 100 / uFacCliL[ 11 ] + 1 ), nDec )
         end
      end

   else

      if lIva .AND. ( uFacCliL )->nIva <> 0
         if !lIvaInc
            nCalculo    += nCalculo * ( uFacCliL )->nIva / 100
         end
      else
         if lIvaInc .AND. ( uFacCliL )->nIva <> 0
            nCalculo    -= Round( nCalculo / ( 100 / ( uFacCliL )->nIva + 1 ), nDec )
         end
      end

   end

RETURN ( Round( nCalculo, nDec ) )







FUNCTION nImpLFacCli( uFacCliT, uFacCliL, nDec, nRou, nVdv, lIva, lDto, lPntVer, lImpTrn, cPouDiv )

   local lIvaInc
   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRou == nil, nRou := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lIva == nil, lIva := .F., ) ;
   IIF( lDto == nil, lDto := .T., ) ;
   IIF( lPntVer == nil, lPntVer := .F., ) ;
   IIF( lImpTrn == nil, lImpTrn := .F., ) ;

   nCalculo       := nTotLFacCli( uFacCliL, nDec, nRou, nVdv, .T., lPntVer, lImpTrn )

   if IsArray( uFacCliT )

      nCalculo    -= Round( nCalculo * uFacCliT[ 42 ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacCliT[ 44    ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacCliT[ 46 ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacCliT[ 48 ]  / 100, nRou )
      lIvaInc     := uFacCliT[ 58 ]

   else

      nCalculo    -= Round( nCalculo * ( uFacCliT )->nDtoEsp / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacCliT )->nDpp    / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacCliT )->nDtoUno / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacCliT )->nDtoDos / 100, nRou )
      lIvaInc     := ( uFacCliT )->lIvaInc

   end

   if IsArray( uFacCliL )

      if lIva .AND. uFacCliL[ 11 ] <> 0
         if !lIvaInc
            nCalculo    += nCalculo * uFacCliL[ 11 ] / 100
         end
      else
         if lIvaInc .AND. uFacCliL[ 11 ] <> 0
            nCalculo    -= Round( nCalculo / ( 100 / uFacCliL[ 11 ] + 1 ), nRou )
         end
      end

   else

      if lIva .AND. ( uFacCliL )->nIva <> 0
         if !lIvaInc
            nCalculo    += nCalculo * ( uFacCliL )->nIva / 100
         end
      else
         if lIvaInc .AND. ( uFacCliL )->nIva <> 0
            nCalculo    -= Round( nCalculo / ( 100 / ( uFacCliL )->nIva + 1 ), nRou )
         end
      end

   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )







FUNCTION nPntUFacCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   IIF( dbfTmpLin == nil, dbfTmpLin := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := ( dbfTmpLin )->nPntVer

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nTrnUFacCli( dbfTmpLin, nDec, nVdv )

    local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := ( dbfTmpLin )->nImpTrn

    IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
    end

RETURN ( Round( nCalculo, nDec ) )



Static Function KillTrans()





   if !Empty( dbfTmpLin ) .AND. ( dbfTmpLin )->( Used() )
      ( dbfTmpLin )->( dbCloseArea() )
   end

   if !Empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )
      ( dbfTmpInc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpDoc ) .AND. ( dbfTmpDoc )->( Used() )
      ( dbfTmpDoc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpAnt ) .AND. ( dbfTmpAnt )->( Used() )
      ( dbfTmpAnt )->( dbCloseArea() )
   end

   if !Empty( dbfTmpPgo ) .AND. ( dbfTmpPgo )->( Used() )
      ( dbfTmpPgo )->( dbCloseArea() )
   end

   if !Empty( dbfTmpSer ) .AND. ( dbfTmpSer )->( Used() )
      ( dbfTmpSer )->( dbCloseArea() )
   end

   dbfTmpLin      := nil
   dbfTmpInc      := nil
   dbfTmpDoc      := nil
   dbfTmpAnt      := nil
   dbfTmpPgo      := nil
   dbfTmpSer      := nil

   dbfErase( cTmpLin )
   dbfErase( cTmpInc )
   dbfErase( cTmpDoc )
   dbfErase( cTmpAnt )
   dbfErase( cTmpPgo )
   dbfErase( cTmpSer )

   oStock:SetTmpFacCliL()

RETURN NIL







STATIC FUNCTION BeginTrans( aTmp, nMode )

   local nOrd
   local cFac
   local oError
   local oBlock
   local lErrors  := .F.
   local cDbfLin  := "FCliL"
   local cDbfInc  := "FCliI"
   local cDbfDoc  := "FCliD"
   local cDbfAnt  := "FCliA"
   local cDbfPgo  := "FCliP"
   local cDbfSer  := "FCliS"

   CursorWait()

   oBlock         := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE





   cFac           := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]
   aNumAlb        := {}

   do case
      case nMode == 1
         nTotalOld   := 0

      case nMode == 4
         nTotalOld   := 0

      case nMode == 2
         nTotalOld   := nTotFac

   end





   cTmpLin        := cGetNewFileName( cPatTmp() + cDbfLin )
   cTmpInc        := cGetNewFileName( cPatTmp() + cDbfInc )
   cTmpDoc        := cGetNewFileName( cPatTmp() + cDbfDoc )
   cTmpAnt        := cGetNewFileName( cPatTmp() + cDbfAnt )
   cTmpPgo        := cGetNewFileName( cPatTmp() + cDbfPgo )
   cTmpSer        := cGetNewFileName( cPatTmp() + cDbfSer )





   dbCreate( cTmpLin, aSqlStruct( aColFacCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpLin, cCheckArea( cDbfLin, @dbfTmpLin ), .F. )

   if !NetErr()

      ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpLin )->( OrdCreate( cTmpLin, "nNumLin", "Str( nNumLin, 4 )", {|| Str( Field->nNumLin ) } ) )

      ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpLin )->( OrdCreate( cTmpLin, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )

      if ( dbfFacCliL )->( dbSeek( cFac ) )
         while ( ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac ) == cFac .AND. !( dbfFacCliL )->( eof() )
            dbPass( dbfFacCliL, dbfTmpLin, .T. )
            ( dbfFacCliL )->( dbSkip() )
         end
      endif

      ( dbfTmpLin )->( dbGoTop() )

      oStock:SetTmpFacCliL( dbfTmpLin )

   else

      lErrors     := .T.

   end





   dbCreate( cTmpInc, aSqlStruct( aIncFacCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpInc, cCheckArea( cDbfInc, @dbfTmpInc ), .F. )
   if !NetErr()
      ( dbfTmpInc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpInc )->( ordCreate( cTmpInc, "Recno", "Recno()", {|| Recno() } ) )

      if ( dbfFacCliI )->( dbSeek( cFac ) )
         while ( ( dbfFacCliI )->cSerie + Str( ( dbfFacCliI )->nNumFac ) + ( dbfFacCliI )->cSufFac == cFac ) .AND. ( dbfFacCliI )->( !eof() )
            dbPass( dbfFacCliI, dbfTmpInc, .T. )
            ( dbfFacCliI )->( dbSkip() )
         end
      end

      ( dbfTmpInc )->( dbGoTop() )
   else
      lErrors     := .T.
   end





   dbCreate( cTmpDoc, aSqlStruct( aFacCliDoc() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpDoc, cCheckArea( cDbfDoc, @dbfTmpDoc ), .F. )
   if !NetErr()
      ( dbfTmpDoc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpDoc )->( ordCreate( cTmpDoc, "Recno", "Recno()", {|| Recno() } ) )

      if ( dbfFacCliD )->( dbSeek( cFac ) )
         while ( ( dbfFacCliD )->cSerFac + Str( ( dbfFacCliD )->nNumFac ) + ( dbfFacCliD )->cSufFac == cFac ) .AND. ( dbfFacCliD )->( !eof() )
            dbPass( dbfFacCliD, dbfTmpDoc, .T. )
            ( dbfFacCliD )->( dbSkip() )
         end
      end

      ( dbfTmpDoc )->( dbGoTop() )
   else
      lErrors     := .T.
   end





   dbCreate( cTmpAnt, aSqlStruct( aItmAntCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpAnt, cCheckArea( cDbfInc, @dbfTmpAnt ), .F. )
   if !NetErr()
      ( dbfTmpAnt )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpAnt )->( ordCreate( cTmpAnt, "Recno", "Recno()", {|| Recno() } ) )

      nOrd        := ( dbfAntCliT )->( OrdSetFocus( "cNumDoc" ) )

      if ( dbfAntCliT )->( dbSeek( cFac ) )
         while ( dbfAntCliT )->cNumDoc == cFac .AND. ( dbfAntCliT )->( !eof() )
            dbPass( dbfAntCliT, dbfTmpAnt, .T. )
            ( dbfAntCliT )->( dbSkip() )
         end
      end

      ( dbfTmpAnt )->( dbGoTop() )
      ( dbfAntCliT )->( OrdSetFocus( nOrd ) )
   else
      lErrors     := .T.
   end





   dbCreate( cTmpPgo, aSqlStruct( aItmRecCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpPgo, cCheckArea( cDbfPgo, @dbfTmpPgo ), .F. )

   if !NetErr()

      ( dbfTmpPgo )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfTmpPgo )->( ordCreate( cTmpPgo , "cRecDev", "CRECDEV", {|| Field->CRECDEV } ) )

      ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpPgo )->( ordCreate( cTmpPgo, "nNumFac", "cSerie + Str( nNumFac ) + cSufFac + Str( nNumRec ) + cTipRec", {|| Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nNumRec ) + Field->cTipRec } ) )

      nOrd        := ( dbfFacCliP )->( OrdSetFocus( "nNumFac" ) )

      if ( dbfFacCliP )->( dbSeek( cFac ) ) .AND. nMode <> 4
         while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cFac .AND. ( dbfFacCliP )->( !eof() )
            if Empty( ( dbfFacCliP )->cTipRec )
               dbPass( dbfFacCliP, dbfTmpPgo, .T. )
            end
            ( dbfFacCliP )->( dbSkip() )
         end
      end

      ( dbfTmpPgo  )->( dbGoTop() )
      ( dbfFacCliP )->( OrdSetFocus( nOrd ) )

   else

      lErrors     := .T.

   end





   dbCreate( cTmpSer, aSqlStruct( aSerFacCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpSer, cCheckArea( cDbfSer, @dbfTmpSer ), .F. )

   if !( dbfTmpSer )->( NetErr() )

      ( dbfTmpSer )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpSer )->( OrdCreate( cTmpSer, "nNumLin", "Str( nNumLin, 4 ) + cRef", {|| Str( Field->nNumLin, 4 ) + Field->cRef } ) )

      if ( dbfFacCliS )->( dbSeek( cFac ) )
         while ( ( dbfFacCliS )->cSerFac + Str( ( dbfFacCliS )->nNumFac ) + ( dbfFacCliS )->cSufFac == cFac ) .AND. !( dbfFacCliS )->( eof() )
            dbPass( dbfFacCliS, dbfTmpSer, .T. )
            ( dbfFacCliS )->( dbSkip() )
         end
      end

      ( dbfTmpSer )->( dbGoTop() )

      oStock:SetTmpFacCliS( dbfTmpSer )

   else

      lErrors     := .T.

   end

   RECOVER USING oError

      msgStop( "Imposible crear tablas temporales." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      KillTrans()

      lErrors     := .T.

   end

   ErrorBlock( oBlock )

   CursorWE()

Return ( lErrors )







STATIC FUNCTION loaCli( aGet, aTmp, nMode, oRieCli, oTlfCli )

   local lValid      := .T.
   local cNewCodCli  := aGet[ 6 ]:varGet()
   local lChgCodCli  := ( Empty( cOldCodCli ) .OR. cOldCodCli <> cNewCodCli )

   if Empty( cNewCodCli )
      Return .T.
   elseif At( ".", cNewCodCli ) <> 0
      cNewCodCli     := PntReplace( aGet[ 6 ], "0", RetNumCodCliEmp() )
   else
      cNewCodCli     := Rjust( cNewCodCli, "0", RetNumCodCliEmp() )
   end

   if ( dbfClient )->( dbSeek( cNewCodCli ) )





      aGet[ 6 ]:cText( ( dbfClient )->Cod )

      if oTlfCli <> nil
         oTlfCli:SetText( ( dbfClient )->Telefono )
      end

      if ( dbfClient )->nColor <> 0
         aGet[ 9 ]:SetColor( , ( dbfClient )->nColor )
      end

      if Empty( aGet[ 9 ]:varGet() ) .OR. lChgCodCli
         aGet[ 9 ]:cText( ( dbfClient )->Titulo )
      end

      if Empty( aGet[ 10 ]:varGet() ) .OR. lChgCodCli
         aGet[ 10 ]:cText( ( dbfClient )->Domicilio )
      end

      if Empty( aGet[ 100 ]:varGet() ) .OR. lChgCodCli
         aGet[ 100 ]:cText( ( dbfClient )->Telefono )
      end

      if Empty( aGet[11]:varGet() ) .OR. lChgCodCli
         aGet[11]:cText( ( dbfClient )->Poblacion )
      end

      if !Empty( aGet[12] )
         if Empty( aGet[ 12 ]:varGet() ) .OR. lChgCodCli
            aGet[ 12 ]:cText( ( dbfClient )->Provincia )
         end
      end

      if !Empty( aGet[14] )
         if Empty( aGet[ 14 ]:varGet() ) .OR. lChgCodCli
            aGet[ 14 ]:cText( ( dbfClient )->CodPostal )
         end
      end

      if !Empty( aGet[15] )
         if Empty( aGet[ 15 ]:varGet() ) .OR. lChgCodCli
            aGet[ 15 ]:cText( ( dbfClient )->Nif )
         end
      end

      if Empty( aTmp[ 82 ] ) .OR. lChgCodCli
         aTmp[ 82 ]  := ( dbfClient )->cCodGrp
      end

      if ( lChgCodCli )
         aTmp[ 16 ]  := ( dbfClient )->lModDat
      end

      if ( lChgCodCli )
         aTmp[ 117 ]  := ( dbfClient )->lPntVer
      end

      if nMode == 1

         aTmp[ 65 ]  := ( dbfClient )->nRegIva





         if Empty( aTmp[ 1 ] )

            if !Empty( ( dbfClient )->Serie )
               aGet[ 1 ]:cText( ( dbfClient )->Serie )
            end

         else



            if !Empty( ( dbfClient )->Serie )               .AND. aTmp[ 1 ] <> ( dbfClient )->Serie      .AND. ApoloMsgNoYes( "La serie del cliente seleccionado es distinta a la anterior.", "¿Desea cambiar la serie?" )
               aGet[ 1 ]:cText( ( dbfClient )->Serie )
            end

         end

         if aGet[ 7 ] <> nil

            if ( Empty( aGet[ 7 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodAlm )
               aGet[ 7 ]:cText( ( dbfClient )->cCodAlm )
               aGet[ 7 ]:lValid()
            end

         end

         if aGet[ 21 ] <> nil

            if ( Empty( aGet[ 21 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodTar )
               aGet[ 21 ]:cText( ( dbfClient )->cCodTar )
               aGet[ 21 ]:lValid()
            end

         end

         if ( Empty( aGet[ 32 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->CodPago )

            aGet[ 32 ]:cText( ( dbfClient )->CodPago )
            aGet[ 32 ]:lValid()





            if lBancoDefecto( ( dbfClient )->Cod, dbfCliBnc )

               if !Empty( aGet[ 110 ] )
                  aGet[ 110 ]:cText( ( dbfCliBnc )->cCodBnc )
                  aGet[ 110 ]:lValid()
               end

               if !Empty( aGet[ 111 ] )
                  aGet[ 111 ]:cText( ( dbfCliBnc )->cEntBnc )
                  aGet[ 111 ]:lValid()
               end

               if !Empty( aGet[ 112 ] )
                  aGet[ 112 ]:cText( ( dbfCliBnc )->cSucBnc )
                  aGet[ 112 ]:lValid()
               end

               if !Empty( aGet[ 113 ] )
                  aGet[ 113 ]:cText( ( dbfCliBnc )->cDigBnc )
                  aGet[ 113 ]:lValid()
               end

               if !Empty( aGet[ 114 ] )
                  aGet[ 114 ]:cText( ( dbfCliBnc )->cCtaBnc )
                  aGet[ 114 ]:lValid()
               end

            end

         end

         if aGet[19] <> nil
            if ( Empty( aGet[ 19 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cAgente )
               aGet[ 19 ]:cText( ( dbfClient )->cAgente )
               aGet[ 19 ]:lValid()
            end
         end

         if ( Empty( aGet[ 20 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodRut )
            aGet[ 20 ]:cText( ( dbfClient)->cCodRut )
            aGet[ 20 ]:lValid()
         end

         if ( Empty( aGet[ 18 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->nTarifa )
            aGet[ 18 ]:cText( ( dbfClient )->nTarifa )
         end

         if !Empty( aGet[ 72 ] ) .AND. ( Empty( aGet[ 72 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodTrn )
            aGet[ 72 ]:cText( ( dbfClient )->cCodTrn )
            aGet[ 72 ]:lValid()
         end

         if lChgCodCli

            aGet[ 56 ]:Click( ( dbfClient )->lReq ):Refresh()

            if !Empty( aGet[ 31 ] )
               aGet[ 31 ]:cText( ( dbfClient )->mComent )
            end





            if !Empty( aGet[ 77 ] )
               aGet[ 77  ]:Select( ( dbfClient )->nTipRet )
            else
               aTmp[ 77  ] := ( dbfClient )->nTipRet
            end

            if !Empty( aGet[ 78 ] )
               aGet[ 78  ]:cText( ( dbfClient )->nPctRet )
            else
               aTmp[ 78  ] := ( dbfClient )->nPctRet
            end





            if !Empty( aGet[ 41 ] )
               aGet[ 41 ]:cText( ( dbfClient )->cDtoEsp )
            else
               aTmp[ 41 ]  := ( dbfClient )->cDtoEsp
            end

            if !Empty( aGet[ 42 ] )
               aGet[ 42 ]:cText( ( dbfClient )->nDtoEsp )
            else
               aTmp[ 42 ]  := ( dbfClient )->nDtoEsp
            end

            if !Empty( aGet[ 43    ] )
               aGet[ 43    ]:cText( ( dbfClient )->cDpp )
            else
               aTmp[ 43    ]  := ( dbfClient )->cDpp
            end

            if !Empty( aGet[ 44    ] )
               aGet[ 44    ]:cText( ( dbfClient )->nDpp )
            else
               aTmp[ 44    ]  := ( dbfClient )->nDpp
            end

            if !Empty( aGet[ 45 ] )
               aGet[ 45 ]:cText( ( dbfClient )->cDtoUno )
            else
               aTmp[ 45 ]  := ( dbfClient )->cDtoUno
            end

            if !Empty( aGet[ 47 ] )
               aGet[ 47 ]:cText( ( dbfClient )->cDtoDos )
            else
               aTmp[ 47 ]  := ( dbfClient )->cDtoDos
            end

            if !Empty( aGet[ 46 ] )
               aGet[ 46 ]:cText( ( dbfClient )->nDtoCnt )
            else
               aTmp[ 46 ]  := ( dbfClient )->nDtoCnt
            end

            if !Empty( aGet[ 48 ] )
               aGet[ 48 ]:cText( ( dbfClient )->nDtoRap )
            else
               aTmp[ 48 ]  := ( dbfClient )->nDtoRap
            end

            aTmp[ 87 ] := ( dbfClient )->nDtoAtp

            aTmp[ 88 ] := ( dbfClient )->nSbrAtp

         end

      end

      if ( dbfClient )->lMosCom .AND. !Empty( ( dbfClient )->mComent ) .AND. lChgCodCli
         MsgStop( Trim( ( dbfClient )->mComent ) )
      end

      if !Empty( oRieCli ) .AND. lChgCodCli
         oStock:SetRiesgo( cNewCodCli, oRieCli, ( dbfClient )->Riesgo )
      end


      ShowInciCliente( ( dbfClient )->Cod, dbfCliInc )


      cOldCodCli  := ( dbfClient )->Cod

      lValid      := .T.

    ELSE

        msgStop( "Cliente no encontrado" )

      lValid      := .F.

    end

RETURN lValid



STATIC FUNCTION RecalculaTotal( aTmp )

   local nTotAntCli  := nTotAntFacCli( nil, dbfTmpAnt, dbfIva, dbfDiv )
   local nPagFacCli  := nPagFacCli( nil, dbfFacCliT, dbfTmpPgo, dbfIva, dbfDiv, nil, .T. )
   local nTotFacCli  := nTotFacCli( nil, dbfFacCliT, dbfTmpLin, dbfIva, dbfDiv, dbfFacCliP, dbfTmpAnt, aTmp, nil, .F. )





   if oBrwIva <> nil
      oBrwIva:Refresh()
   end

   if oGetAge <> nil
      oGetAge:SetText( Trans( nTotAge, cPorDiv ) )
   end

   if oGetNet <> nil
      oGetNet:SetText( Trans( nTotNet, cPorDiv ) )
   end

   if oGetIva <> nil
      oGetIva:SetText( Trans( nTotIva, cPorDiv ) )
   end

   if oGetRnt <> nil
      oGetRnt:SetText( AllTrim( Trans( nTotRnt, cPorDiv ) + Space( 1 ) + AllTrim( cSimDiv( cCodDiv, dbfDiv ) ) + " : " + AllTrim( Trans( nTotPctRnt, "999.99" ) ) + "%" ) )
   end

   if oGetEnt <> nil
      oGetEnt:SetText( Trans( nTotEnt, cPorDiv ) )
   end

   if oGetDtoEnt <> nil
      oGetDtoEnt:SetText( Trans( nTotDtoEnt, cPorDiv ) )
   end

   if oGetReq <> nil
      oGetReq:SetText( Trans( nTotReq, cPorDiv ) )
   end

   if oGetTotal <> nil
      oGetTotal:SetText( Trans( nTotFac, cPorDiv ) )
   end

   if oTotFacLin <> nil
      oTotFacLin:SetText( Trans( nTotFac, cPorDiv ) )
   end

   if oGetTotPg <> nil
      oGetTotPg:SetText( Trans( nTotFac, cPorDiv ) )
   end

   if oGetTotIvm <> nil
      oGetTotIvm:SetText( Trans( nTotIvm, cPorDiv ) )
   end

   if oGetTotPnt <> nil
      oGetTotPnt:SetText( Trans( nTotPnt, cPorDiv ) )
   end

   if oGetTrn <> nil
      oGetTrn:SetText( Trans( nTotTrn, cPorDiv ) )
   end

   if oGetPctRet <> nil
      oGetPctRet:SetText( Trans( nTotRet, cPorDiv ) )
   end

   if oGetAnt <> nil
      oGetAnt:SetText( Trans( nTotAntCli, cPorDiv ) )
   end





   if oGetPag <> nil
      oGetPag:SetText( Trans( nPagFacCli, cPorDiv ) )
   end

   if oGetPdt <> nil
      oGetPdt:SetText( Trans( nTotFacCli - nPagFacCli, cPorDiv ) )
   end

   if oGetPes <> nil
      oGetPes:cText( nTotPes )
   end

   if oGetDif <> nil
      oGetDif:cText( nTotalDif )
   end

Return .T.







FUNCTION nPagFacCli( cFactura, dbfFacCliT, dbfFacCliP, dbfIva, dbfDiv, cDivRet, lOnlyCob, lPic )

   local nOrd
   local nRec
   local cPorDiv
   local nRouDiv        := 2
   local nTotalPagado   := 0
   local cCodDiv        := cDivEmp()

   IIF( lOnlyCob == nil, lOnlyCob := .T., ) ;
   IIF( lPic == nil, lPic := .F., ) ;





   if Empty( Select( dbfFacCliT ) )
      Return ( 0 )
   end

   if Empty( Select( dbfFacCliP ) )
      Return ( 0 )
   end

   if Empty( Select( dbfIva ) )
      Return ( 0 )
   end

   if Empty( Select( dbfDiv ) )
      Return ( 0 )
   end





   cCodDiv              := ( dbfFacCliP )->cDivPgo
   cPorDiv              := cPorDiv( cCodDiv, dbfDiv )
   nRouDiv              := nRouDiv( cCodDiv, dbfDiv )

   if Empty( cFactura )

      nRec              := ( dbfFacCliP )->( Recno() )

      ( dbfFacCliP )->( dbGoTop() )
      while !( dbfFacCliP )->( Eof() )

         if ( lOnlyCob .AND. ( dbfFacCliP )->lCobrado .AND. !( dbfFacCliP )->lDevuelto ) .OR. !lOnlyCob .AND. !( dbfFacCliP )->lDevuelto
            nTotalPagado+= ( dbfFacCliP )->nImporte
         end

         ( dbfFacCliP )->( dbSkip() )

      end

      ( dbfFacCliP )->( dbGoTo( nRec ) )

   else

      nRec              := ( dbfFacCliP )->( Recno() )
      nOrd              := ( dbfFacCliP )->( OrdSetFocus( "NNUMFAC" ) )

      if ( dbfFacCliP )->( dbSeek( cFactura ) )
         while ( ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cFactura )

            if ( lOnlyCob .AND. ( dbfFacCliP )->lCobrado .AND. !( dbfFacCliP )->lDevuelto ) .OR. ( !lOnlyCob .AND. !( dbfFacCliP )->lDevuelto )
               nTotalPagado+= ( dbfFacCliP )->nImporte
            end

            ( dbfFacCliP )->( dbSkip() )

         end
      end

      ( dbfFacCliP )->( OrdSetFocus( nOrd ) )
      ( dbfFacCliP )->( dbGoTo( nRec ) )

   end

   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      nTotalPagado      := nCnv2Div( nTotalPagado, cCodDiv, cDivRet, dbfDiv )
      cPorDiv           := cPorDiv( cDivRet, dbfDiv )
      nRouDiv           := nRouDiv( cDivRet, dbfDiv )
   end

   nTotalPagado         := Round( nTotalPagado, nRouDiv )

   if lPic
      nTotalPagado      := Trans( nTotalPagado, cPorDiv )
   end

RETURN ( nTotalPagado )







STATIC FUNCTION AppDeta( oBrwDet, bEdtDet, aTmp, lTot, cCodArt, aNumDoc )

   IIF( lTot == nil, lTot := .F., ) ;

   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden añadir registros a una factura con recibos cobrados" )
      return .F.
   end

   if ( Empty( aNumDoc ) ) .OR. lTot

      WinAppRec( oBrwDet, bEdtDet, dbfTmpLin, lTot, cCodArt, aTmp )

   else


      MsgStop( "No se pueden añadir registros a una factura que" + Chr(13)+Chr(10) +  "proviene de albaranes." )

   end

RETURN RecalculaTotal( aTmp )







STATIC FUNCTION lCalcDeta( aTmp, aTmpFac, lTotal )

   local nCalculo
   local nUnidades
   local nCosto
   local nMargen
   local nRentabilidad
   local nBase

   IIF( lTotal == nil, lTotal := .F., ) ;

   if aTmp[ 69 ]
      nCalculo    := aTmp[ 72 ]
   else
      nCalculo    := aTmp[ 6 ]
   end

   nCalculo       -= aTmp[ 33  ]

   nUnidades      := nTotNFacCli( aTmp )





   if !aTmp[ 40 ]
      if aTmp[ 83 ]
         nCalculo += aTmp[ 42 ] * NotCero( aTmp[ 67 ] )
      else
         nCalculo += aTmp[ 42 ]
      end
   end

   nCalculo       *= nUnidades





   if aTmp[ 8 ] <> 0
      nCalculo    += nUnidades * aTmp[ 8 ]
   end





   if aTmp[ 9    ] <> 0
      nCalculo    -= nCalculo * aTmp[ 9    ] / 100
   end

   if aTmp[ 10 ] <> 0
      nCalculo    -= nCalculo * aTmp[ 10 ] / 100
   end





   nCosto            := nUnidades * aTmp[ 37 ]

   if aTmp[ 40 ] .AND. aTmp[ 11 ] <> 0
      nBase          := nCalculo - Round( nCalculo / ( 100 / aTmp[ 11 ] + 1 ), nRouDiv )
   else
      nBase          := nCalculo
   end

   nMargen           := nBase - nCosto

   if nCalculo == 0
      nRentabilidad  := 0
   else
      nRentabilidad  := nRentabilidad( nCalculo, 0, nCosto )
   end





   if aTmpFac[ 117 ]
      nCalculo       += nUnidades * aTmp[ 7 ]
   end





   if !Empty( oTotalLinea )
      oTotalLinea:cText( nCalculo )
   end

   if !Empty( oRentabilidadLinea )
      oRentabilidadLinea:cText( AllTrim( Trans( nMargen, cPorDiv ) + AllTrim( cSimDiv( cCodDiv, dbfDiv ) ) + " : " + AllTrim( Trans( nRentabilidad, "999.99" ) ) + "%" ) )
   end

   if !Empty( oComisionLinea )
      oComisionLinea:cText( Round( ( nBase * aTmp[ 18 ] / 100 ), nRouDiv ) )
   end

Return ( if( !lTotal, .T., nCalculo ) )







static function lRecibosPagadosTmp( dbfTmpPgo )

   local nRecAct
   local lRecPgd  := .F.

   if Empty( Select( dbfTmpPgo ) )
      Return ( lRecPgd )
   end

   nRecAct        := ( dbfTmpPgo )->( Recno() )

   while !( dbfTmpPgo )->( eof() )
      if ( dbfTmpPgo )->lCobrado
         lRecPgd  := .T.
         exit
      end
      ( dbfTmpPgo )->( dbSkip() )
   end

   ( dbfTmpPgo )->( dbGoTo( nRecAct) )

return ( lRecPgd )







STATIC FUNCTION SetDlgMode( aTmp, aGet, oGet2, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oStkAct, nMode, oTotal, aTmpFac, oRentLin )

   if !lUseCaj()
      aGet[ 12 ]:Hide()
   else
      aGet[ 12 ]:SetText( cNombreCajas() )
   end

   aGet[ 19 ]:SetText( cNombreUnidades() )

   if !Empty( aGet[ 84 ] )
      aGet[ 84 ]:Show()
   end

   if aGet[ 42 ] <> nil

      if !uFieldEmpresa( "lUseImp" )
         aGet[ 42 ]:Hide()
         aGet[ 83 ]:Hide()
      else

         if !uFieldEmpresa( "lModImp" )
            aGet[ 42 ]:Disable()
         end

         if !uFieldEmpresa( "lIvaImpEsp" )
            aGet[ 83 ]:Disable()
         end

      end

   end

   if !lTipMov()

      if !Empty( " _CTIPMOV " ) .AND. !Empty( oGet2 )
         aGet[ 22 ]:hide()
         oGet2:hide()
      end

   end

   if aGet[ 8 ] <> nil
      if !uFieldEmpresa( "lUsePor", .F. )
         aGet[ 8 ]:Hide()
      end
   end

   if aGet[ 7 ] <> nil
      if !uFieldEmpresa( "lUsePnt", .F. ) .OR. !aTmpFac[ 117 ]
         aGet[ 7 ]:Hide()
      end
   end

   if aGet[ 33 ] <> nil
      if !uFieldEmpresa( "lDtoLin", .F. )
         aGet[ 33 ]:Hide()
      end
   end

   if oRentLin <> nil .AND. oUser():lNotRentabilidad()
      oRentLin:Hide()
   end

   if aTmp[ 69 ]
      aGet[ 6 ]:Hide()
      aGet[ 72  ]:Show()
   end

   if aTmp[ 43 ]

      if !Empty( aGet[ 45 ] )
         aGet[ 45 ]:Show()
      end

      if !Empty( aGet[ 46 ] )
         aGet[ 46 ]:Show()
      end

   else

      if !Empty( aGet[ 45 ] )
         aGet[ 45 ]:Hide()
      end

      if !Empty( aGet[ 46 ] )
         aGet[ 46 ]:Hide()
      end

   end

   do case
   case nMode == 1

      aTmp[ 4    ]  := Space( 32 )
      aTmp[ 40 ]  := aTmpFac[ 58 ]

      aGet[ 12 ]:cText( 1 )
      aGet[ 19]:cText( 1 )

      if !Empty( aGet[ 35  ] )
         aGet[ 35  ]:cText( nLastNum( dbfTmpLin ) )
      else
         aTmp[ 35  ] := nLastNum( dbfTmpLin )
      end

      aGet[ 39 ]:cText( aTmpFac[ 7 ] )

      if lTipMov() .AND. aGet[ 22 ] <> nil
         aGet[ 22  ]:cText( cDefVta() )
      end

      aGet[ 5]:Show()
      aGet[ 23 ]:Hide()

      if aTmpFac[ 65 ] <= 1
         aGet[ 11 ]:cText( nIva( dbfIva, cDefIva() ) )
         aTmp[ 57 ]:= nReq( dbfIva, cDefIva() )
      end

      if !Empty( oStkAct )

         if !uFieldEmpresa( "lNStkAct" )
            oStkAct:Show()
            oStkAct:cText( 0 )
         else
            oStkAct:Hide()
         end

      end

   case ( nMode == 2 .OR. nMode == 3 )

      if !Empty( aTmp[ 4 ] )
         aGet[5]:show()
         aGet[23 ]:hide()
      else
         if !aTmp[ 13 ]
            aGet[5]:hide()
            aGet[23 ]:show()
         else
            aGet[5]:show()
            aGet[23 ]:hide()
         end
      end

      if !Empty ( oStock )

         oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 39 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 45 ], aTmp[ 47 ], aTmp[ 36 ], oStkAct )

         if uFieldEmpresa( "lNStkAct" )
            oStkAct:Hide()
         end

      end

   end

   if !Empty( aTmp[28 ] )

      if !Empty( aGet[ 30 ] )
         aGet[ 30 ]:Show()
         aGet[ 30 ]:lValid()
      end
      if !Empty( oSayPr1 )
         oSayPr1:Show()
         oSayPr1:SetText( retProp( aTmp[28], dbfPro ) )
      end
      if !Empty( oSayVp1 )
         oSayVp1:Show()
      end

   else

      if !Empty( aGet[ 30 ] )
         aGet[30 ]:hide()
      end
      if !Empty( oSayPr1 )
         oSayPr1:hide()
      end
      if !Empty( oSayVp1 )
         oSayVp1:hide()
      end

   end

   if !Empty( aTmp[29 ] )

      if !Empty( aGet[ 31 ] )
         aGet[ 31 ]:Show()
         aGet[ 31 ]:lValid()
      end
      if !Empty( oSayPr2 )
         oSayPr2:Show()
         oSayPr2:SetText( retProp( aTmp[ 29 ], dbfPro ) )
      end
      if !Empty( oSayVp2 )
         oSayVp2:Show()
      end

   else

      if !Empty( aGet[ 31 ] )
         aGet[31 ]:hide()
      end
      if !Empty( oSayPr2 )
         oSayPr2:hide()
      end
      if !Empty( oSayVp2 )
         oSayVp2:hide()
      end

   end

   oTotal:cText( 0 )





   if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ] )
      aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:Hide()
   end

   if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ] )
      aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:Hide()
   end

   if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ] )
      aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:Hide()
   end

   if oUndMedicion:oDbf:Seek( aTmp[ 16 ] )

      if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( dbfFacCliL )->( fieldpos( "nMedUno" ) ) ]:Show()
      end

      if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( dbfFacCliL )->( fieldpos( "nMedDos" ) ) ]:Show()
      end

      if !Empty( aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( dbfFacCliL )->( fieldpos( "nMedTre" ) ) ]:Show()
      end

   end





   if Empty( aTmp[ 77 ] )
      if !Empty( aGet[ 77 ] )
         aGet[ 77 ]:cText( aTmpFac[ 18 ] )
      else
         aTmp[ 77 ]     := aTmpFac[ 18 ]
      end
   end

   if !Empty( aGet[ 77 ] )
      if !uFieldEmpresa( "lPreLin" )
         aGet[ 77 ]:Hide()
      else
         aGet[ 77 ]:Show()
      end
   end





   if !Empty( aGet[ 22 ] )
      aGet[ 22 ]:lValid()
   end

   if !Empty( aGet[ 53 ] )
      aGet[ 53 ]:lValid()
   end

   aGet[ 39 ]:lValid()

   if !lAccArticulo() .OR. oUser():lNotCostos()

      if !Empty( aGet[ 37 ] )
         aGet[ 37 ]:Hide()
      end

   end





   if ( Empty( aTmp[ 6 ] ) .OR. lUsrMaster() .OR. oUser():lCambiarPrecio() ) .AND. nMode <> 3

      aGet[ 6 ]:HardEnable()
      aGet[ 8  ]:HardEnable()

      if !Empty( aGet[ 7 ] )
          aGet[ 7 ]:HardEnable()
      end

      aGet[ 9     ]:HardEnable()
      aGet[ 10  ]:HardEnable()

      if !Empty( aGet[ 33 ] )
         aGet[ 33  ]:HardEnable()
      end

   else

      aGet[ 6 ]:HardDisable()
      aGet[ 8  ]:HardDisable()

      if !Empty( aGet[ 7 ] )
            aGet[ 7  ]:HardDisable()
      end

      aGet[ 9     ]:HardDisable()
      aGet[ 10  ]:HardDisable()

      if !Empty(  aGet[ 33  ] )
          aGet[ 33  ]:HardDisable()
      end
   end

Return nil



FUNCTION nDtoUFacCli( dbfTmpLin, nDec, nVdv )

   local nCalculo := ( dbfTmpLin )->nDtoDiv

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

    IF nVdv <> 0
      nCalculo    := ( dbfTmpLin )->nDtoDiv / nVdv
    end

RETURN ( round( nCalculo, nDec ) )







STATIC FUNCTION nTotFFacCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPorDiv )

   local nCalculo    := 0

   IIF( dbfLin == nil, dbfLin := dbfFacCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nRou == nil, nRou := nRouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lDto == nil, lDto := .T., ) ;
   IIF( lPntVer == nil, lPntVer := .T., ) ;
   IIF( lImpTrn == nil, lImpTrn := .T., ) ;

   nCalculo          += nTotLFacCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn )
   nCalculo          += nTotIFacCli( dbfLin, nDec, nRou, nVdv )

return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )







STATIC FUNCTION LoaArt( aGet, bmpImage, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, nMode, lFocused )

    local nDtoAge
   local nImpAtp
   local nImpOfe
   local nCosPro
   local cCodArt              := aGet[ 4 ]:varGet()
   local cCodFam
   local lChgCodArt           := ( Rtrim( cOldCodArt ) <> Rtrim( cCodArt ) )
   local nPrePro              := 0
   local cPrpArt
   local nPosComa
   local cProveedor
   local nTarOld              := aTmp[ 77 ]
   local nNumDto              := 0

   IIF( lFocused == nil, lFocused := .T., ) ;

   if Empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir líneas sin codificar" )
         return .F.
      end

      if Empty( aTmp[ 11 ] ) .AND. !aTmp[ 84 ]
         aGet[ 11 ]:bWhen  := {|| .T. }
      end

      aGet[ 5 ]:cText( Space( 50 ) )
      aGet[ 5 ]:bWhen   := {|| .T. }
      aGet[ 5 ]:Hide()

      if !Empty( aGet[ 23 ] )
         aGet[ 23 ]:Show()
         if lFocused
            aGet[ 23 ]:SetFocus()
         end
      end

      if !Empty( aGet[ 30 ] )
         aGet[ 30 ]:Hide()
      end

      if !Empty( oSayPr1 )
         oSayPr1:Hide()
      end

      if !Empty( oSayVp1 )
         oSayVp1:Hide()
      end

      if !Empty( aGet[31 ] )
         aGet[30 ]:Hide()
      end

      if !Empty( oSayPr2 )
         oSayPr1:Hide()
      end

      if !Empty( oSayVp2 )
         oSayVp1:Hide()
      end

      Return .T.

   end

   if !aTmp[ 84 ]
      if lModIva()
         aGet[ 11 ]:bWhen     := {|| .T. }
      else
         aGet[ 11 ]:bWhen     := {|| .F. }
      end
   end





   if "," $ cCodArt
      nPosComa                := At( ",", cCodArt )
      cProveedor              := RJust( Left( cCodArt, nPosComa - 1 ), "0", RetNumCodPrvEmp() )
      cCodArt                 := cSeekProveedor( cCodArt, dbfArtPrv )
   else
      cCodArt                 := cSeekCodebar( cCodArt, dbfCodebar, dbfArticulo )
   end





   ( dbfArticulo )->( OrdSetFocus( "Codigo" ) )

   if ( dbfArticulo )->( dbSeek( cCodArt ) ) .OR. ( dbfArticulo )->( dbSeek( Upper( cCodArt ) ) )





      aTmp[ 51 ]        := ( dbfArticulo )->lMsgVta
      aTmp[ 52 ]        := ( dbfArticulo )->lNotVta





      if !Empty( aGet[ 61 ] )
         aGet[ 61 ]:cText( ( dbfArticulo )->cImagen )
      else
         aTmp[ 61 ]     := ( dbfArticulo )->cImagen
      end

      if !Empty( bmpImage )
         if !Empty( aTmp[ 61 ] )
            bmpImage:Show()
            bmpImage:LoadBmp( cFileBitmap( cPatImg(), aTmp[ 61 ] ) )
         else
            bmpImage:Hide()
         end
      end





      if ( lChgCodArt )

         if ( dbfArticulo )->lObs
            MsgStop( "Artículo catalogado como obsoleto" )
            return .F.
         end

         cCodArt              := ( dbfArticulo )->Codigo

         aTmp[ 4 ]        := cCodArt
         aGet[ 4 ]:cText( cCodArt )

         if ( dbfArticulo )->lMosCom .AND. !Empty( ( dbfArticulo )->mComent )
            MsgStop( Trim( ( dbfArticulo )->mComent ) )
         end

         if !Empty( cProveedor )

            aTmp[ 59 ]  := cProveedor
            aTmp[ 60 ]  := AllTrim( RetProvee( cProveedor ) )
            aTmp[ 66 ]  := Padr( cRefPrvArt( cCodArt, Padr( cProveedor, 12 ) , dbfArtPrv ), 18 )

         else

            aTmp[ 59 ]  := ( dbfArticulo )->cPrvHab
            aTmp[ 60 ]  := AllTrim( RetProvee( ( dbfArticulo )->cPrvHab ) )
            aTmp[ 66 ]  := Padr( cRefPrvArt( cCodArt, ( dbfArticulo )->cPrvHab , dbfArtPrv ), 18 )
            if ( IsMuebles() )
               aGet[ 59 ]:cText( (dbfArticulo)->cPrvHab )
               aGet[ 60 ]:cText( AllTrim( RetProvee( (dbfArticulo)->cPrvHab ) ) )
               aGet[ 66 ]:cText( Padr( cRefPrvArt( cCodArt, ( dbfArticulo )->cPrvHab , dbfArtPrv ), 18 ) )
            end

         end

         aGet[ 5 ]:show()
         aGet[ 23  ]:hide()

         aGet[ 5 ]:cText( ( dbfArticulo )->Nombre  )

         if aGet[ 23 ] <> nil
            aGet[ 23 ]:cText( ( dbfArticulo )->Descrip )
         else
            aTmp[ 23 ]  := ( dbfArticulo )->Descrip
         end






         if !Empty( aGet[ 14 ] )
            aGet[ 14  ]:cText( ( dbfArticulo )->nPesoKg )
         else
            aGet[ 14  ] := ( dbfArticulo )->nPesoKg
         end

         if !Empty( aGet[ 15 ] )
             aGet[ 15 ]:cText( ( dbfArticulo )->cUndDim )
         else
             aTmp[ 15 ] := ( dbfArticulo )->cUndDim
         end

         if !Empty( aGet[ 67 ] )
            aGet[ 67 ]:cText( ( dbfArticulo )->nVolumen )
         else
            aGet[ 67 ] := ( dbfArticulo )->nVolumen
         end

         if !Empty( aGet[ 16 ] )
             aGet[ 16 ]:cText( ( dbfArticulo )->cUnidad )
             aGet[ 16 ]:lValid()
         else
             aTmp[ 16 ] := ( dbfArticulo )->cUnidad
         end

         if !Empty( aGet[ 68 ] )
             aGet[ 68 ]:cText( ( dbfArticulo )->cVolumen )
         else
             aTmp[ 68 ]:= ( dbfArticulo )->cVolumen
         end

         if !Empty( aGet[53 ] )
            aGet[ 53 ]:cText( ( dbfArticulo )->cCodTip )
         else
            aTmp[ 53 ]  := ( dbfArticulo )->cCodTip
         end






         aTmp[ 32 ]     := 1






         if ( dbfArticulo )->lLote

            if !Empty( aGet[ 45 ] )

               aGet[ 45 ]:Show()

               if Empty( aGet[ 45 ]:VarGet() )
                  aGet[ 45 ]:cText( ( dbfArticulo )->cLote )
                  aGet[ 45 ]:lValid()
               end

            else

               if Empty( aTmp[ 45 ] )
                  aTmp[ 45 ] := ( dbfArticulo )->cLote
               end

            end

            aTmp[ 43 ]    := ( dbfArticulo )->lLote

            if !Empty( aGet[ 46 ] )

               aGet[ 46 ]:Show()

               if Empty( aGet[ 46 ]:VarGet() )
                  aGet[ 46 ]:cText( dFechaCaducidadLote( aTmp[ 4 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 45 ], dbfAlbPrvL, dbfFacPrvL ) )
               end

            end

         else

            if !Empty( aGet[ 45 ] )
               aGet[ 45 ]:Hide()
            end

            if !Empty( aGet[ 46 ] )
               aGet[ 46 ]:Hide()
            end

         end





         cCodFam                 := ( dbfArticulo )->Familia

         if !Empty( cCodFam )

            if aGet[ 55 ] <> nil
               aGet[ 55 ]:cText( cCodFam )
               aGet[ 55 ]:lValid()
            else
               aTmp[ 55 ]  := cCodFam
            end

            if aGet[ 56 ] <> nil
               aGet[ 56 ]:cText( cGruFam( cCodFam, dbfFamilia ) )
               aGet[ 56 ]:lValid()
            else
               aTmp[ 56 ]  := cGruFam( cCodFam, dbfFamilia )
            end

            if aGet[ 79 ] <> nil
               aGet[ 79 ]:cText( cCodFra( cCodFam, dbfFamilia ) )
               aGet[ 79 ]:lValid()
            else
               aTmp[ 79 ]  := cCodFra( cCodFam, dbfFamilia )
            end

         else

            if aGet[ 55 ] <> nil
               aGet[ 55 ]:cText( Space( 8 ) )
               aGet[ 55 ]:lValid()
            end

            if aGet[ 56 ] <> nil
               aGet[ 56 ]:cText( Space( 3 ) )
               aGet[ 56 ]:lValid()
            end

            if aGet[ 79 ] <> nil
               aGet[ 79 ]:cText( Space( 3 ) )
               aGet[ 79 ]:lValid()
            end

         end





         if ( dbfArticulo )->lKitArt

            aTmp[ 47 ]     := ( dbfArticulo )->lKitArt
            aTmp[ 27 ]     := lImprimirCompuesto( ( dbfArticulo )->Codigo, dbfArticulo )
            aTmp[ 49 ]     := lPreciosCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )

            if lStockCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )

               if aGet[ 36 ] <> nil
                  aGet[ 36 ]:SetOption( ( dbfArticulo )->nCtlStock )
               else
                  aTmp[ 36 ]  := ( dbfArticulo )->nCtlStock
               end

            else

               if aGet[ 36 ] <> nil
                  aGet[ 36 ]:SetOption( 3 )
               else
                  aTmp[ 36 ]  := 3
               end

            end

         else

            aTmp[ 27 ]     := .F.

            if aGet[ 36 ] <> nil
               aGet[ 36 ]:SetOption( ( dbfArticulo )->nCtlStock )
            else
               aTmp[ 36 ]  := ( dbfArticulo )->nCtlStock
            end

         end





         if oStkAct <> nil .AND. aTmp[ 36 ] <= 1
            oStock:nPutStockActual( cCodArt, aTmp[ 39 ], , , , aTmp[ 47 ], aTmp[ 36 ], oStkAct )
            oStkAct:Refresh()
         end





         if aTmpFac[ 65 ] <= 1
            aGet[ 11 ]:cText( nIva( dbfIva, ( dbfArticulo )->TipoIva ) )
            aTmp[ 57 ]        := nReq( dbfIva, ( dbfArticulo )->TipoIva )
         end





         if !Empty( ( dbfArticulo )->cCodImp )

            aTmp[ 41 ]     := ( dbfArticulo )->cCodImp
            aGet[ 42 ]:cText( oNewImp:nValImp( ( dbfArticulo )->cCodImp, aTmpFac[ 58 ], aTmp[ 11 ] ) )

            aTmp[ 83 ]     := RetFld( ( dbfArticulo )->cCodImp, oNewImp:oDbf:cAlias, "lIvaVol" )

            if !Empty( aGet[ 83 ] )
               aGet[ 83 ]:Refresh()
            end

         end

         if ( dbfArticulo )->nCajEnt <> 0
            aGet[12 ]:cText( (dbfArticulo)->nCajEnt )
         end

         if ( dbfArticulo )->nUniCaja <> 0
            aGet[19]:cText( ( dbfArticulo )->nUniCaja )
         end





        if !Empty( aGet[ 50 ] )
            aGet[ 50 ]:cText( ( dbfArticulo )->nMesGrt )
        else
            aGet[ 50 ]  := ( dbfArticulo )->nMesGrt
        end





         aGet[18 ]:cText( aTmpFac[ 23 ] )





         if !Empty( ( dbfArticulo )->cCodFra )

            if aGet[ 79 ] <> nil
               aGet[ 79 ]:cText( ( dbfArticulo )->cCodFra )
               aGet[ 79 ]:lValid()
            else
               aTmp[ 79 ]  := ( dbfArticulo )->cCodFra
            end

         end





         if !Empty( aGet[ 81 ] )
            aGet[ 81 ]:cText( ( dbfArticulo )->Descrip )
         else
            aTmp[ 81 ]     := ( dbfArticulo )->Descrip
         end





            aTmp[ 28 ]     := ( dbfArticulo )->cCodPrp1
            aTmp[ 29 ]     := ( dbfArticulo )->cCodPrp2

            if !Empty( aTmp[ 28 ] )

               if aGet[ 30 ] <> nil
                  aGet[ 30 ]:show()
                  if lFocused
                     aGet[ 30 ]:SetFocus()
                  end
               end

               if oSayPr1 <> nil
                  oSayPr1:SetText( retProp( ( dbfArticulo )->cCodPrp1, dbfPro ) )
                  oSayPr1:show()
               end

               if oSayVp1 <> nil
                  oSayVp1:SetText( "" )
                  oSayVp1:Show()
               end

            else

               if !Empty( aGet[ 30 ] )
                  aGet[ 30 ]:hide()
               end

               if !Empty( oSayPr1 )
                  oSayPr1:hide()
               end

               if !Empty( oSayVp1 )
                  oSayVp1:hide()
               end

            end

            if !empty( aTmp[ 29 ] )

               if aGet[ 31 ] <> nil
                  aGet[ 31 ]:show()
               end

               if oSayPr2 <> nil
                  oSayPr2:SetText( retProp( ( dbfArticulo )->cCodPrp2, dbfPro ) )
                  oSayPr2:show()
               end

               if !Empty( oSayVp2 )
                  oSayVp2:SetText( "" )
                  oSayVp2:Show()
               end

            else

               if !Empty( aGet[ 31 ] )
                  aGet[ 31 ]:hide()
               end

               if!Empty( oSayPr2 )
                  oSayPr2:hide()
               end

               if !Empty( oSayVp2 )
                  oSayVp2:hide()
               end

            end

         end





      cPrpArt              := aTmp[ 28 ] + aTmp[ 29 ] + aTmp[ 30 ] + aTmp[ 31 ]

      if ( lChgCodArt ) .OR. ( cPrpArt <> cOldPrpArt )





         if nMode == 1
            cCodFam        := RetFamArt( cCodArt, dbfArticulo )
         else
            cCodFam        := aTmp[55]
         end

         if aTmp[ 69 ]
            aGet[ 6 ]:cText( 0 )
            aGet[ 72 ]:cText( nPreAlq( aTmp[ 4 ], aTmp[ 77 ], aTmpFac[58], dbfArticulo ) )
         end





         if !Empty( aGet[7 ] )
             aGet[ 7 ]:cText( ( dbfArticulo )->NPNTVER1 )
         else
             aTmp [ 7 ]   :=  ( dbfArticulo )->NPNTVER1
         end

         aTmp[38 ]         := ( dbfArticulo )->PvpRec





         if !uFieldEmpresa( "lCosAct" )

            nCosPro              := oStock:nCostoMedio( aTmp[ 4 ], aTmp[ 39 ], aTmp[ 28 ], aTmp[ 30 ], aTmp[ 29 ], aTmp[ 31 ] )

            if nCosPro == 0
               nCosPro           := nCosto( aTmp[ 4 ], dbfArticulo, dbfKit, .F., , dbfDiv )
            end

         else

            nCosPro              := nCosto( aTmp[ 4 ], dbfArticulo, dbfKit, .F., , dbfDiv )

         end

         if aGet[ 37 ] <> nil
            aGet[ 37 ]:cText( nCosPro )
         else
            aTmp[ 37 ]  := nCosPro
         end





         nNumDto              := RetFld( aTmpFac[ 6 ], dbfClient, "nDtoArt" )

         if nNumDto <> 0

            do case
               case nNumDto == 1

                  if !Empty( aGet[ 9 ] )
                     aGet[ 9 ]:cText( ( dbfArticulo )->nDtoArt1 )
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt1
                  else
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt1
                  end

               case nNumDto == 2

                  if !Empty( aGet[ 9 ] )
                     aGet[ 9 ]:cText( ( dbfArticulo )->nDtoArt2 )
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt2
                  else
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt2
                  end

               case nNumDto == 3

                  if !Empty( aGet[ 9 ] )
                     aGet[ 9]:cText( ( dbfArticulo )->nDtoArt3 )
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt3
                  else
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt3
                  end

               case nNumDto == 4

                  if !Empty( aGet[ 9 ] )
                     aGet[ 9 ]:cText( ( dbfArticulo )->nDtoArt4 )
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt4
                  else
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt4
                  end

               case nNumDto == 5

                  if !Empty( aGet[ 9 ] )
                     aGet[ 9 ]:cText( ( dbfArticulo )->nDtoArt5 )
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt5
                  else
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt5
                  end

               case nNumDto == 6

                  if !Empty( aGet[ 9 ] )
                     aGet[ 9]:cText( ( dbfArticulo )->nDtoArt6 )
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt6
                  else
                     aTmp[ 9 ]     := ( dbfArticulo )->nDtoArt6
                  end

            end

         end





         if aTmp[ 9 ] == 0

            if !Empty( aGet[ 9 ] )
               aGet[ 9 ]:cText( nDescuentoFamilia( cCodFam, dbfFamilia ) )
            else
               aTmp[ 9 ]     := nDescuentoFamilia( cCodFam, dbfFamilia )
            end

         end



         nPrePro           := nPrePro( aTmp[ 4 ], aTmp[ 28 ], aTmp[ 30 ], aTmp[ 29 ], aTmp[ 31 ], aTmp[ 77 ], aTmpFac[ 58 ], dbfArtDiv, dbfTarPreL, aTmpFac[21] )

         if nPrePro == 0
            aGet[6]:cText( nRetPreArt( aTmp[ 77 ], aTmpFac[ 60 ], aTmpFac[ 58 ], dbfArticulo, dbfDiv, dbfKit, dbfIva, , aGet[ 77 ] ) )
         else
            aGet[6]:cText( nPrePro )
         end



         if !Empty( aTmpFac[21] )


            nImpOfe  := RetPrcTar( cCodArt, aTmpFac[ 21 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 31 ], dbfTarPreL, aTmp[ 77 ] )
            if nImpOfe <> 0
               aGet[6]:cText( nImpOfe )
            end


            nImpOfe  := RetPctTar( cCodArt, cCodFam, aTmpFac[ 21 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 31 ], dbfTarPreL )
            if nImpOfe <> 0
               aGet[9   ]:cText( nImpOfe )
            end


            nImpOfe  := RetLinTar( cCodArt, cCodFam, aTmpFac[21], aTmp[28], aTmp[29], aTmp[30], aTmp[31], dbfTarPreL )
            if nImpOfe <> 0
               aGet[33]:cText( nImpOfe )
            end


            nImpOfe  := RetComTar( cCodArt, cCodFam, aTmpFac[21], aTmp[28], aTmp[29], aTmp[30], aTmp[31], aTmpFac[19], dbfTarPreL, dbfTarPreS )
            if nImpOfe <> 0
               aGet[18]:cText( nImpOfe )
            end



            nImpOfe  := RetDtoPrm( cCodArt, cCodFam, aTmpFac[21], aTmp[28], aTmp[29], aTmp[30], aTmp[31], aTmpFac[5], dbfTarPreL )
            if nImpOfe  <> 0
               aGet[10]:cText( nImpOfe )
            end



            nDtoAge  := RetDtoAge( cCodArt, cCodFam, aTmpFac[21], aTmp[28], aTmp[29], aTmp[30], aTmp[31], aTmpFac[5], aTmpFac[19], dbfTarPreL, dbfTarPreS )
            if nDtoAge  <> 0
               aGet[18]:cText( nDtoAge )
            end

         end




         do case

            case lSeekAtpArt( aTmpFac[ 6 ] + cCodArt, aTmp[ 28 ] + aTmp[ 29 ], aTmp[ 30 ] + aTmp[ 31 ], aTmpFac[ 5 ], dbfClientAtp ) .AND.  ( dbfClientAtp )->lAplFac

            nImpAtp     := nImpAtp( nTarOld, dbfClientAtp, , , aGet[ 77 ] )
            if nImpAtp  <> 0
               aGet[ 6 ]:cText( nImpAtp )
            end





            nImpAtp     := nDtoAtp( nTarOld, dbfClientAtp )
            if nImpAtp  <> 0
               aGet[ 9 ]:cText( nImpAtp )
            end





            if ( dbfClientAtp )->nDprArt <> 0
               aGet[ 10 ]:cText( ( dbfClientAtp )->NDPRART )
            end

            if ( dbfClientAtp )->nComAge <> 0
               aGet[ 18 ]:cText( ( dbfClientAtp )->NCOMAGE )
            end

            if ( dbfClientAtp )->nDtoDiv <> 0
               aGet[ 33 ]:cText( ( dbfClientAtp )->nDtoDiv )
            end




         case lSeekAtpFam( aTmpFac[6] + aTmp[ 55 ], aTmpFac[5], dbfClientAtp ) .AND.  ( dbfClientAtp )->lAplFac

            if ( dbfClientAtp )->nDtoArt <> 0
               aGet[ 9    ]:cText( ( dbfClientAtp )->NDTOART )
            end

            if ( dbfClientAtp )->NDPRART <> 0
               aGet[ 10 ]:cText( ( dbfClientAtp )->NDPRART )
            end

            if ( dbfClientAtp )->NCOMAGE <> 0
               aGet[ 18 ]:cText( ( dbfClientAtp )->NCOMAGE )
            end

            if ( dbfClientAtp )->nDtoDiv <> 0
               aGet[ 33 ]:cText( ( dbfClientAtp )->nDtoDiv )
            end

         end





         if !Empty( aGet[ 16 ] )
            aGet[ 16 ]:cText( ( dbfArticulo )->cUnidad )
         else
            aTmp[ 16 ]  := ( dbfArticulo )->cUnidad
         end

         ValidaMedicion( aTmp, aGet )

      end





      lBuscaOferta( cCodArt, aGet, aTmp, aTmpFac, dbfOferta, dbfArticulo, dbfDiv, dbfKit, dbfIva  )





      cOldPrpArt  := cPrpArt
      cOldCodArt  := cCodArt





      if Empty( aTmp[ 6 ] ) .OR. lUsrMaster() .OR. oUser():lCambiarPrecio()

         aGet[ 6 ]:HardEnable()
         aGet[ 8 ]:HardEnable()

         if !Empty( aGet[ 7 ] )
             aGet[ 7 ]:HardEnable()
         end

         aGet[ 9    ]:HardEnable()
         aGet[ 10 ]:HardEnable()

         if !Empty( aGet[ 33 ] )
             aGet[ 33 ]:HardEnable()
         end

      else

         aGet[ 6 ]:HardDisable()
         aGet[ 8 ]:HardDisable()

         if !Empty( aGet[ 7 ] )
             aGet[ 7 ]:HardEnable()
         end
         aGet[ 9    ]:HardDisable()
         aGet[ 10 ]:HardDisable()

         if !Empty( aGet[ 33 ] )
             aGet[ 33 ]:HardEnable()
         end

      end

   else

      MsgStop( "Artículo no encontrado" )
      Return .F.

   end

RETURN .T.







STATIC FUNCTION SaveDeta( aTmp, aTmpFac, aGet, oGet2, oBrw, oDlg, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, oTotal, oStkAct, nStkAct, cCodArt, oBtn, oBtnSer )

   local aXbyStr
   local nTotUnd  := 0
   local nRec     := ( dbfTmpLin )->( RecNo() )
   local aClo     := aClone( aTmp )



   oBtn:SetFocus()

   if !aGet[ 4 ]:lValid()
      return nil
   end







   if !lMoreIva( aTmp[11] )
      return nil
   end

   if Empty( aTmp[ 39 ] )
      MsgStop( "Código de almacen no puede estar vacio" )
      aGet[ 39 ]:SetFocus()
      Return nil
   end

   if !cAlmacen( aGet[ 39 ], dbfAlm )
      Return nil
   end





   if ( nMode == 1 ) .AND. RetFld( aTmp[ 4 ], dbfArticulo, "lNumSer" ) .AND. !( dbfTmpSer )->( dbSeek( Str( aTmp[ 35 ], 4 ) + aTmp[ 4 ] ) )
      MsgStop( "Tiene que introducir números de serie para este artículo." )
      oBtnSer:Click()
      Return nil
   end





   if nMode == 5

      ( dbfTmpLin )->( dbGoTop() )
      while !( dbfTmpLin )->( eof() )

         if ( dbfTmpLin )->lSel
            aEval( aTmp, {| cFld, n | if( !Empty( aTmp[ n ] ), ( dbfTmpLin )->( FieldPut( n, aTmp[ n ] ) ), ) } )
         end

         ( dbfTmpLin )->( dbSkip() )

      end

      ( dbfTmpLin )->( dbGoTo( nRec ) )

      oBrw:Refresh()

      oDlg:end( 1 )

      return nil

   end



   if !Empty( aTmp[ 4 ] ) .AND. ( aTmp[ 52 ] .OR. aTmp[ 51 ] )

      nTotUnd     := nTotNFacCli( aTmp )

      if nMode == 2
         nTotUnd  -= nTotNFacCli( dbfTmpLin )
      end

      if nTotUnd <> 0

         do case
            case oStkAct:VarGet() - nTotUnd < 0

               if aTmp[ 52 ]
                  MsgStop( "No hay stock suficiente, tenemos " + Alltrim( Trans( oStkAct:VarGet(), MasUnd() ) ) + " unidad(es) disponible(s)," + Chr(13)+Chr(10) + "en almacén " + aTmp[ 39 ] + "." )
                  return nil
               end

               if aTmp[ 51 ]
                  if !ApoloMsgNoYes( "No hay stock suficiente, tenemos " + Alltrim( Trans( oStkAct:VarGet(), MasUnd() ) ) + " unidad(es) disponible(s)," + Chr(13)+Chr(10) + " en almacén " + aTmp[ 39 ] + ".", "¿Desea continuar?" )
                     return nil
                  end
               end

            case oStkAct:VarGet() - nTotUnd < RetFld( aTmp[ 4 ], dbfArticulo, "nMinimo"  )

               if aTmp[ 51 ]
                  if !ApoloMsgNoYes( "El stock está por debajo del minimo.", "¿Desea continuar?" )
                     return nil
                  end
               end

         end

      end

   end

   aTmp[ 57 ]     := nPReq( dbfIva, aTmp[ 11 ] )



   if nMode == 1

      aTmp[ 4 ]  := cCodArt

      if aTmp[ 43 ]
         GraLotArt( aTmp[ 4 ], dbfArticulo, aTmp[ 45 ] )
      end





      aXbYStr        := nXbYAtipica( aTmp[ 4 ], aTmpFac[ 6 ], aTmp[ 12 ], aTmp[ 19 ], aTmpFac[ 5 ], dbfClientAtp )

      if aXbYStr[ 1 ] == 0





         if !aTmp[ 82 ]

            aXbyStr              := nXbYOferta( aTmp[ 4 ], aTmpFac[ 6 ], aTmpFac[ 82 ], aTmp[ 12 ], aTmp[ 19 ], aTmpFac[ 5 ], dbfOferta, 1 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 82 ]  := .T.
            end

         end





         if !aTmp[ 82 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "FAMILIA", "CODIGO" ), aTmpFac[ 6 ], aTmpFac[ 82 ], aTmp[ 12 ], aTmp[ 19 ], aTmpFac[ 5 ], dbfOferta, 2 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 82 ]  := .T.
            end

         end





         if !aTmp[ 82 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODTIP", "CODIGO" ), aTmpFac[ 6 ], aTmpFac[ 82 ], aTmp[ 12 ], aTmp[ 19 ], aTmpFac[ 5 ], dbfOferta, 3 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 82 ]  := .T.
            end

         end





         if !aTmp[ 82 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODCATE", "CODIGO" ), aTmpFac[ 6 ], aTmpFac[ 82 ], aTmp[ 12 ], aTmp[ 19 ], aTmpFac[ 5 ], dbfOferta, 4 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 82 ]  := .T.
            end

         end





         if !aTmp[ 82 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODTEMP", "CODIGO" ), aTmpFac[ 6 ], aTmpFac[ 82 ], aTmp[ 12 ], aTmp[ 19 ], aTmpFac[ 5 ], dbfOferta, 5 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 82 ]  := .T.
            end

         end





         if !aTmp[ 82 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODFAB", "CODIGO" ), aTmpFac[ 6 ], aTmpFac[ 82 ], aTmp[ 12 ], aTmp[ 19 ], aTmpFac[ 5 ], dbfOferta, 6 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 82 ]  := .T.
            end

         end

      end





      if aXbYStr[ 1 ] <> 0 .AND. aXbYStr[ 2 ] <> 0





         if aXbYStr[ 1 ] == 1





            aTmp[ 12  ] -= aXbYStr[ 2 ]
            aClo              := aClone( aTmp )

            WinGather( aTmp, , dbfTmpLin, oBrw, nMode, nil, .F. )





            AppKit( aClo, aTmpFac, dbfTmpLin, dbfArticulo, dbfKit )





            aTmp[ 12  ] := aXbYStr[ 2 ]
            aTmp[ 6 ] := 0
            aClo              := aClone( aTmp )

            WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )





            AppKit( aClo, aTmpFac, dbfTmpLin, dbfArticulo, dbfKit )

         else





            if aTmp[ 19 ] < 0
               aTmp[ 19 ] += aXbYStr[ 2 ]
            else
               aTmp[ 19 ] -= aXbYStr[ 2 ]
            end
            aClo              := aClone( aTmp )

            WinGather( aTmp, , dbfTmpLin, oBrw, nMode, nil, .F. )





            AppKit( aClo, aTmpFac, dbfTmpLin, dbfArticulo, dbfKit )





            if aTmp[ 19 ] < 0
               aTmp[ 19 ] := -( aXbYStr[ 2 ] )
            else
               aTmp[ 19 ] := aXbYStr[ 2 ]
            end

            aTmp[ 6 ] := 0
            aClo              := aClone( aTmp )

            WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )





            AppKit( aClo, aTmpFac, dbfTmpLin, dbfArticulo, dbfKit )

         end

      else





         WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )





         AppKit( aClo, aTmpFac, dbfTmpLin, dbfArticulo, dbfKit )

      end

   else























      WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )

   end





  if !Empty( bmpImage )
      bmpImage:Hide()
      PalBmpFree( bmpImage:hBitmap, bmpImage:hPalette )
   end

   cOldCodArt     := ""
   cOldUndMed     := ""

   if !Empty( aGet[ 16 ] )
      aGet[ 16 ]:lValid()
   end

   if nMode == 1 .AND. lEntCon()

      RecalculaTotal( aTmpFac )

      SetDlgMode( aTmp, aGet, oGet2, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oStkAct, nMode, oTotal, aTmpFac )

      SysRefresh()

      if !Empty( aGet[ 4 ] )
         aGet[ 4 ]:SetFocus()
      end

      if !Empty( aGet[ 83 ] )
         aGet[ 83 ]:Refresh()
      end

   else

      oDlg:end( 1 )

   end

Return nil



STATIC FUNCTION AppKit( aClo, aTmpFac, dbfTmpLin, dbfArticulo, dbfKit )

   local nRec        := ( dbfTmpLin )->( RecNo() )
   local nNumLin     := ( dbfTmpLin )->nNumLin
   local nUnidades   := 0
   local nStkActual  := 0

   if aClo[ 47 ] .AND. ( dbfKit )->( dbSeek( aClo[ 4 ] ) )

      while ( dbfKit )->cCodKit == aClo[ 4 ] .AND. !( dbfKit )->( eof() )

         if ( dbfArticulo )->( dbSeek( ( dbfKit )->cRefKit ) )

            ( dbfTmpLin )->( dbAppend() )

            if lKitAsociado( aClo[ 4 ], dbfArticulo )
               ( dbfTmpLin )->nNumLin  := nLastNum( dbfTmpLin )
               ( dbfTmpLin )->lKitChl  := .F.
            else
               ( dbfTmpLin )->nNumLin  := nNumLin
               ( dbfTmpLin )->lKitChl  := .T.
            end

            ( dbfTmpLin )->cRef        := ( dbfKit      )->cRefKit
            ( dbfTmpLin )->nPreUnit    := ( dbfKit      )->nPreKit

            ( dbfTmpLin )->cDetalle    := ( dbfArticulo )->Nombre
            ( dbfTmpLin )->nPntVer     := ( dbfArticulo )->nPntVer1
            ( dbfTmpLin )->nPesokg     := ( dbfArticulo )->nPesoKg
            ( dbfTmpLin )->cPesokg     := ( dbfArticulo )->cUndDim
            ( dbfTmpLin )->cUnidad     := ( dbfArticulo )->cUnidad
            ( dbfTmpLin )->nVolumen    := ( dbfArticulo )->nVolumen
            ( dbfTmpLin )->cVolumen    := ( dbfArticulo )->cVolumen
            ( dbfTmpLin )->nCtlStk     := ( dbfArticulo )->nCtlStock
            ( dbfTmpLin )->cCodImp     := ( dbfArticulo )->cCodImp
            ( dbfTmpLin )->lLote       := ( dbfarticulo )->lLote
            ( dbfTmpLin )->nLote       := ( dbfarticulo )->nLote
            ( dbfTmpLin )->cLote       := ( dbfarticulo )->cLote
            ( dbfTmpLin )->nPvpRec     := ( dbfArticulo )->PvpRec

            if ( dbfArticulo )->lFacCnv
               ( dbfTmpLin )->nFacCnv  := ( dbfArticulo )->nFacCnv
            end

            ( dbfTmpLin )->nCosDiv     := nCosto( nil, dbfArticulo, dbfKit )
            ( dbfTmpLin )->nValImp     := oNewImp:nValImp( ( dbfArticulo )->cCodImp )

            ( dbfTmpLin )->cSerie      := aClo[ 1  ]
            ( dbfTmpLin )->nNumFac     := aClo[ 2 ]
            ( dbfTmpLin )->cSufFac     := aClo[ 3 ]
            ( dbfTmpLin )->nCanEnt     := aClo[ 12 ]
            ( dbfTmpLin )->dFecha      := aClo[ 21  ]
            ( dbfTmpLin )->cTipMov     := aClo[ 22 ]
            ( dbfTmpLin )->nNumLin     := aClo[ 35 ]
            ( dbfTmpLin )->cAlmLin     := aClo[ 39 ]
            ( dbfTmpLin )->lIvaLin     := aClo[ 40 ]
            ( dbfTmpLin )->nComAge     := aClo[ 18 ]





            ( dbfTmpLin )->nUniCaja    := aClo[ 19] * ( dbfKit )->nUndKit





            if !Empty( aClo[ 11 ] )
               ( dbfTmpLin )->nIva     := nIva( dbfIva, ( dbfArticulo )->TipoIva )
               ( dbfTmpLin )->nReq     := nReq( dbfIva, ( dbfArticulo )->TipoIva )
            else
               ( dbfTmpLin )->nIva     := 0
               ( dbfTmpLin )->nReq     := 0
            end





            ( dbfTmpLin )->lImpLin     := lImprimirComponente( aClo[ 4 ], dbfArticulo )
            ( dbfTmpLin )->lKitPrc     := lPreciosComponentes( aClo[ 4 ], dbfArticulo )

            if ( dbfTmpLin )->lKitPrc
               ( dbfTmpLin )->nPreUnit := nRetPreArt( aClo[ 77 ], aTmpFac[ 60 ], aTmpFac[ 58 ], dbfArticulo, dbfDiv, dbfKit, dbfIva )
            end

            if lStockComponentes( aClo[ 4 ], dbfArticulo )
               ( dbfTmpLin )->nCtlStk  := ( dbfArticulo )->nCtlStock
            else
               ( dbfTmpLin )->nCtlstk  := 3
            end





            if ( dbfKit )->lAplDto
               ( dbfTmpLin )->nDto     := aClo[ 9    ]
               ( dbfTmpLin )->nDtoPrm  := aClo[ 10 ]
               ( dbfTmpLin )->nDtoDiv  := aClo[ 33 ]
            end





            if ( dbfArticulo)->lMsgVta .AND. !uFieldEmpresa( "lNStkAct" )

               nStkActual              := oStock:nStockAlmacen( ( dbfKit )->cRefKit, ( dbfTmpLin )->cAlmLin )
               nUnidades               := aClo[ 19 ] * ( dbfKit )->nUndKit

               do case
                  case nStkActual - nUnidades < 0



                     MsgStop( "No hay stock suficiente para realizar la venta" + Chr(13)+Chr(10) +  "del componente " + AllTrim( ( dbfKit )->cRefKit ) + " - " + AllTrim( ( dbfArticulo )->Nombre ), "¡Atención!" )

                  case nStkActual - nUnidades < ( dbfArticulo)->nMinimo






                     MsgStop( "El stock del componente " + AllTrim( ( dbfKit )->cRefKit ) + " - " + AllTrim( ( dbfArticulo )->Nombre ) + Chr(13)+Chr(10) +  "está bajo minimo." + Chr(13)+Chr(10) +  "Unidades a vender : " + AllTrim( Trans( nUnidades, MasUnd() ) ) + Chr(13)+Chr(10) +  "Stock mínimo : " + AllTrim( Trans( ( dbfArticulo)->nMinimo, MasUnd() ) ) + Chr(13)+Chr(10) +  "Stock actual : " + AllTrim( Trans( nStkActual, MasUnd() ) ), "¡Atención!" )
               end

            end

         end

         ( dbfKit )->( dbSkip() )

      end

      ( dbfTmpLin )->( dbGoTo( nRec ) )

   end

RETURN NIL



STATIC FUNCTION lMoreIva( nCodIva )





   IF aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 3, 3 ] == nil
        RETURN .T.
    end

    IF aTotIva[ 1, 3 ] == nCodIva .OR. aTotIva[ 2, 3 ] == nCodIva .OR. aTotIva[ 3, 3 ] == nCodIva
        RETURN .T.
    end

   MsgStop( "Factura con más de 3 tipos de " + cImp() )

RETURN .F.







STATIC FUNCTION EdtDeta( oBrwDet, bEdtDet, aTmp, lTot, nFacMod )

   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden modificar registros a una factura con recibos cobrados" )
      return .F.
   end






   if ( dbfTmpLin )->lSel
      WinMulRec( oBrwDet, bEdtDet, dbfTmpLin, lTot, nFacMod, aTmp )
   else
      WinEdtRec( oBrwDet, bEdtDet, dbfTmpLin, lTot, nFacMod, aTmp )
   end










RETURN ( RecalculaTotal( aTmp ) )







STATIC FUNCTION DelDeta()

   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden eliminar registros a una factura con recibos cobrados" )
      return .F.
   end

   CursorWait()

   while ( dbfTmpSer )->( dbSeek( Str( ( dbfTmpLin )->nNumLin, 4 ) ) )
      ( dbfTmpSer )->( dbDelete() )
   end

   if ( dbfTmpLin )->lKitArt
      dbDelKit( , dbfTmpLin, ( dbfTmpLin )->nNumLin )
   end

   CursorWE()

RETURN .T.







STATIC FUNCTION EndTrans( aTmp, aGet, oBrw, oBrwDet, oBrwPgo, aNumAlb, nMode, oDlg )

   local n
   local nOrd
   local oError
   local oBlock
   local cSerFac
   local nNumFac
   local nNumNFC
   local cSufFac
   local cNumPed
   local cNumAlb
   local dFecFac

   if Empty( aTmp[ 1 ] )
      aTmp[ 1 ]   := "A"
   end

   cSerFac              := aTmp[ 1  ]
   nNumFac              := aTmp[ 2 ]
   cSufFac              := aTmp[ 3 ]
   cNumPed              := aTmp[ 38 ]
   cNumAlb              := aTmp[ 37 ]
   dFecFac              := aTmp[ 5 ]





   if !lValidaOperacion( aTmp[ 5 ] )
      Return .F.
   end





   if lCliBlq( aTmp[ 6 ], dbfClient )
      msgStop( "Cliente bloqueado, no se pueden realizar operaciones de venta" )
      aGet[ 6 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 9 ] )
      msgStop( "Nombre de cliente no puede estar vacío." )
      aGet[ 9 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 10 ] )
      msgStop( "Domicilio de cliente no puede estar vacío." )
      aGet[ 10 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 15 ] )
      msgStop( "D.N.I. / C.I.F. de cliente no puede estar vacío." )
      aGet[ 15 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 7 ] )
      msgStop( "Almacén no puede estar vacío." )
      aGet[ 7 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 32 ] )
      msgStop( "Forma de pago no puede estar vacía." )
      aGet[ 32 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 60 ] )
      MsgStop( "No puede almacenar documento sin código de divisa." )
      aGet[ 60 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 19 ] ) .AND. lRecogerAgentes()
      msgStop( "Agente no puede estar vacío." )
      aGet[ 19 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 22 ] ) .AND. lObras()
      MsgStop( "Debe de introducir una obra." )
      aGet[ 22 ]:SetFocus()
      return .F.
   end

   if ( dbfTmpLin )->( eof() )
      MsgStop( "No puede almacenar un documento sin lineas." )
      return .F.
   end

   if lPasNil() .AND. ( nMode == 1 .OR. nMode == 4 )

      ( dbfTmpLin )->( dbGoTop() )
      while !( dbfTmpLin )->( eof() )

         if !( dbfTmpLin )->lControl .AND. ( dbfTmpLin )->nPreUnit == 0 .AND. !( dbfTmpLin )->lKitPrc
            if !ApoloMsgNoYes( "El artículo " + Rtrim( ( dbfTmpLin )->cRef ) + " - " + Rtrim( Descrip( dbfTmpLin ) ) + " no esta valorado.", "¿ Desea continuar archivando la factura ?" )
               return .F.
            end
         end

         ( dbfTmpLin )->( dbSkip() )

      end

   end





   DisableAcceso()

   oDlg:Disable()

   oBlock      := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      oMsgText( "Archivando" )
      oMeter:Set( 1 )

      BeginTransaction()





      ( dbfTmpLin )->( dbClearFilter() )





      aTmp[ 80 ]        := GetSysDate()
      aTmp[ 81 ]        := Time()





      if !Empty( oTipFac ) .AND. oTipFac:nAt == 2
         aTmp[ 91 ]   := .T.
      else
         aTmp[ 91 ]   := .F.
      end

      do case
      case nMode == 1 .OR. nMode == 4

         oMsgText( "Obteniendo nuevos numeros" )
         oMeter:Set( 2 )





         nNumFac              := nNewDoc( cSerFac, dbfFacCliT, "NFACCLI", , dbfCount )
         nNumNFC              := nNewNFC( cSerFac, dbfFacCliT, "NFACCLI", dbfCount )

         aTmp[ 2 ]     := nNumFac
         aTmp[ 108    ]     := nNumNFC

         aTmp[ 28 ]     := !Empty( aNumAlb )

      case nMode == 2

         oMsgText( "Eliminando detalles anteriores" )
         oMeter:Set( 2 )





         while ( dbfFacCliL )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) )
            if dbLock( dbfFacCliL )
               ( dbfFacCliL )->( dbDelete() )
               ( dbfFacCliL )->( dbUnLock() )
            end
         end





         while ( ( dbfFacCliI )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) ) .AND. !( dbfFacCliI )->( eof() ) )
            if dbLock( dbfFacCliI )
               ( dbfFacCliI )->( dbDelete() )
               ( dbfFacCliI )->( dbUnLock() )
            end
         end





         while ( ( dbfFacCliD )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) ) .AND. !( dbfFacCliD )->( eof() ) )
            if dbLock( dbfFacCliD )
               ( dbfFacCliD )->( dbDelete() )
               ( dbfFacCliD )->( dbUnLock() )
            end
         end





         while ( ( dbfFacCliP )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) ) .AND. !( dbfFacCliP )->( eof() ) )
            if dbLock( dbfFacCliP )
               ( dbfFacCliP )->( dbDelete() )
               ( dbfFacCliP )->( dbUnLock() )
            end
         end





         while ( ( dbfFacCliS )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) ) .AND. !( dbfFacCliS )->( eof() ) )
            if dbLock( dbfFacCliS )
               ( dbfFacCliS )->( dbDelete() )
               ( dbfFacCliS )->( dbUnLock() )
            end
         end





         nOrd                             := ( dbfAntCliT )->( OrdSetFocus( "cNumDoc" ) )
         while ( ( dbfAntCliT )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) ) .AND. !( dbfAntCliT )->( eof() ) )
            if dbLock( dbfAntCliT )
               ( dbfAntCliT )->lLiquidada := .F.
               ( dbfAntCliT )->cNumDoc    := ""
               ( dbfAntCliT )->( dbUnLock() )
            end
         end
         ( dbfAntCliT )->( OrdSetFocus( nOrd ) )

      end

      oMsgText( "Almancenando datos" )
      oMeter:Set( 3 )





      ( dbfTmpLin )->( dbGoTop() )
      while ( dbfTmpLin )->( !eof() )
         ( dbfTmpLin )->dFecFac  := dFecFac
         dbPass( dbfTmpLin, dbfFacCliL, .T., cSerFac, nNumFac, cSufFac )
         ( dbfTmpLin )->( dbSkip() )
      end





      ( dbfTmpInc )->( dbGoTop() )
      while ( dbfTmpInc )->( !eof() )
         dbPass( dbfTmpInc, dbfFacCliI, .T., cSerFac, nNumFac, cSufFac )
         ( dbfTmpInc )->( dbSkip() )
      end





      ( dbfTmpDoc )->( dbGoTop() )
      while ( dbfTmpDoc )->( !eof() )
         dbPass( dbfTmpDoc, dbfFacCliD, .T., cSerFac, nNumFac, cSufFac )
         ( dbfTmpDoc )->( dbSkip() )
      end





      ( dbfTmpSer )->( dbGoTop() )
      while ( dbfTmpSer )->( !eof() )
         dbPass( dbfTmpSer, dbfFacCliS, .T., cSerFac, nNumFac, cSufFac, dFecFac )
         ( dbfTmpSer )->( dbSkip() )
      end





      ( dbfTmpAnt )->( dbGoTop() )
      while ( dbfTmpAnt )->( !eof() )
         if ( dbfAntCliT )->( dbSeek( ( dbfTmpAnt )->cSerAnt + Str( ( dbfTmpAnt )->nNumAnt ) + ( dbfTmpAnt )->cSufAnt ) )
            if dbLock( dbfAntCliT )
               ( dbfAntCliT )->lLiquidada := .T.
               ( dbfAntCliT )->lSndDoc    := .T.
               ( dbfAntCliT )->cNumDoc    := cSerFac + Str( nNumFac ) + cSufFac
               ( dbfAntCliT )->dLiquidada := GetSysDate()
               ( dbfAntCliT )->cTurLiq    := cCurSesion()
               ( dbfAntCliT )->cCajLiq    := oUser():cCaja()
               ( dbfAntCliT )->( dbUnLock() )
            end
         end
         ( dbfTmpAnt )->( dbSkip() )
      end





      ( dbfTmpPgo )->( dbGoTop() )

      while ( dbfTmpPgo )->( !eof() )

         if ( dbfTmpPgo )-> cCodCli <> aTmp[ 6 ]
            ( dbfTmpPgo )-> cCodCli := aTmp[ 6 ]
         end

         if ( dbfTmpPgo )-> cNomCli <> aTmp[ 9 ]
            ( dbfTmpPgo )-> cNomCli := aTmp[ 9 ]
         end

         ( dbfTmpPgo )->( dbSkip() )

      end





      ( dbfTmpPgo )->( dbGoTop() )
      while ( dbfTmpPgo )->( !eof() )
         dbPass( dbfTmpPgo, dbfFacCliP, .T., cSerFac, nNumFac, cSufFac )
         ( dbfTmpPgo )->( dbSkip() )
      end





      oMsgText( "Guardamos los totales" )
      oMeter:Set( 4 )

      aTmp[ 101 ]  := nTotNet
      aTmp[ 103 ]  := nTotIva
      aTmp[ 104 ]  := nTotReq
      aTmp[ 105 ]  := nTotFac
      aTmp[ 102 ]  := nTotSup
      aTmp[ 115 ]  := nTotCob
      aTmp[ 116 ]  := nTotFac - nTotCob





      oMsgText( "Guardamos el documento" )
      oMeter:Set( 4 )

      WinGather( aTmp, , dbfFacCliT, , nMode )





      oMsgText( "Actualizamos el estado de los albaranes" )
      oMeter:Set( 5 )

      if len( aNumAlb ) > 0
         for n := 1 to len( aNumAlb )
            if ( dbfAlbCliT )->( dbSeek( aNumAlb[ n ] ) )
               SetFacturadoAlbaranCliente( .T., , dbfAlbCliT, dbfAlbCliL, dbfAlbCliS, cSerFac + Str( nNumFac ) + cSufFac )
            end
         next
      end





      oMsgText( "Actualizamos el estado de los pedidos" )
      oMeter:Set( 6 )

      if !Empty( cNumPed )





         oStock:SetEstadoPedCli( cNumPed, .T., cSerFac + Str( nNumFac ) + cSufFac )

         if( dbfPedCliP )->( dbSeek( cNumPed ) )

            while ( dbfPedCliP )->cSerPed + Str( ( dbfPedCliP )->nNumPed ) + ( dbfPedCliP )->cSufPed == cNumPed .AND. !( dbfPedCliP )->( Eof() )

               if dbLock( dbfPedCliP )
                  ( dbfPedCliP )->lPasado := .T.
                  ( dbfPedCliP )->( dbUnLock() )
               end

               ( dbfPedCliP )->( dbSkip() )

            end

         end

      end





      oMsgText( "Marcamos las entregas de los albaranes" )
      oMeter:Set( 7 )

      if !Empty( cNumAlb )

         if( dbfAlbCliP )->( dbSeek( cNumAlb ) )

            while ( dbfAlbCliP )->cSerAlb + Str( ( dbfAlbCliP )->nNumAlb ) + ( dbfAlbCliP )->cSufAlb == cNumAlb .AND. !( dbfAlbCliP )->( Eof() )

               if dbLock( dbfAlbCliP )
                  ( dbfAlbCliP )->lPasado := .T.
                  ( dbfAlbCliP )->( dbUnLock() )
               end

               ( dbfAlbCliP )->( dbSkip() )

            end

         end

      end





      oMsgText( "Generamos los pagos" )
      oMeter:Set( 8 )

      GenPgoFacCli( cSerFac + Str( nNumFac ) + cSufFac, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfAntCliT, dbfClient, dbfFPago, dbfDiv, dbfIva, nMode )





      oMsgText( "Comprobamos el estado de la factura" )
      oMeter:Set( 8 )

      ChkLqdFacCli( nil, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfAntCliT, dbfIva, dbfDiv )





      oMsgText( "Finalizamos la transacción" )
      oMeter:Set( 9 )

      dbCommitAll()

      CommitTransaction()

   RECOVER USING oError

      RollBackTransaction()

      msgStop( "Imposible almacenar documento" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end
   ErrorBlock( oBlock )





   oMsgText( "Cerramos el dialogo" )
   oMeter:Set( 10 )

   oDlg:Enable()
   oDlg:End( 1 )

   EnableAcceso()

Return .T.







FUNCTION ChkLqdFacCli( aTmp, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfAntCliT, dbfIva, dbfDiv )

   local lChkLqd
   local cFactura
   local nPagFacCli
    local nTotal
   local cDivFac
   local nRec     := ( dbfFacCliP )->( RecNo() )

   if aTmp <> nil
      cFactura    := aTmp[ 1  ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]
      cDivFac     := aTmp[ 60 ]
   else
      cFactura    := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac
      cDivFac     := ( dbfFacCliT )->cDivFac
   end

   nTotal         := abs( nTotFacCli( cFactura, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, nil, nil, nil, .F. ) )
   nPagFacCli     := abs( nPagFacCli( cFactura, dbfFacCliT, dbfFacCliP, dbfIva, dbfDiv, nil, .T. ) )
   nPagFacCli     += abs( nTotAntFacCli( cFactura, dbfAntCliT, dbfIva, dbfDiv, nil, .F. ) )

   lChkLqd        := !lMayorIgual( nTotal, nPagFacCli, 0.1 )

   if aTmp <> nil
      aTmp[ 24 ]        := lChkLqd
   end

   if dbLock( dbfFacCliT )
      ( dbfFacCliT )->lLiquidada := lChkLqd
      ( dbfFacCliT )->( dbUnLock() )
   end

   ( dbfFacCliP )->( dbGoTo( nRec ) )

RETURN ( lChkLqd )






FUNCTION dFecFacCli( cFacCli, dbfFacCliT )

   local aStatus
    local dFecFac    := CtoD("")

   if ValType( dbfFacCliT ) == "O"
      dbfFacCliT:GetStatus( .T. )
      if dbfFacCliT:Seek( cFacCli )
         dFecFac  := dbfFacCliT:dFecFac
      end
      dbfFacCliT:SetStatus()
   else
      aStatus  := aGetStatus( dbfFacCliT, .T. )
      if ( dbfFacCliT )->( dbSeek( cFacCli ) )
         dFecFac  := ( dbfFacCliT )->dFecFac
      end
      SetStatus( dbfFacCliT, aStatus )
   end

RETURN ( dFecFac )







FUNCTION BrowseInformesFacCli( oGet, oGet2 )

    local oDlg
    local oBrw
   local oGet1
   local cGet1
   local oCbxOrd
   local cCbxOrd
   local nOrd
   local aCbxOrd

   if !OpenFiles()
      Return .F.
   end

   aCbxOrd           := { "Número", "Fecha", "Cliente", "Nombre" }
   nOrd              := GetBrwOpt( "BrwFacCli" )
   nOrd              := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrd ]

   oDlg = TDialog():New(,,,, "Facturas de clientes", "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F., )






        oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, dbfFacCliT ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, dbfFacCliT, nil, nil, .F. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( dbfFacCliT )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:refresh(), oGet1:SetFocus() )},,,, .F.,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := dbfFacCliT
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Factura de cliente.Browse informes"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( dbfFacCliT )->cSerie + "/" + RTrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + ( dbfFacCliT )->cSufFac }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecFac"
         :bEditValue       := {|| Dtoc( ( dbfFacCliT )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Cliente"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| Rtrim( ( dbfFacCliT )->cCodCli ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| Rtrim( ( dbfFacCliT )->cNomCli ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotFacCli( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT, nil, cDivEmp(), .T. ) }
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end





        TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )





        TButton():ReDefine( 501, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )




        TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   if oDlg:nResult == 1
      oGet:cText( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac )
      oGet2:cText( ( dbfFacCliT )->cNomCli )
   end

   SetBrwOpt( "BrwFacCli", ( dbfFacCliT )->( OrdNumber() ) )

   ( dbfFacCliT )->( dbClearFilter() )

   CloseFiles()





   oBrw:CloseData()

RETURN ( oDlg:nResult == 1 )



FUNCTION lValidInformeFacCli( oGet, oGet2 )

   local lClose   := .F.
   local lValid   := .F.
    local xValor     := oGet:varGet()

   if Empty( xValor )
      return .T.
   end

   if !OpenFiles()
      Return .F.
   end

   if ( dbfFacCliT )->( dbSeek( xValor ) )

      oGet:cText( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac )
      oGet2:cText( ( dbfFacCliT )->cNomCli )

      lValid   := .T.

   else

      msgStop( "Factura no encontrada" )

   end

   CloseFiles()

RETURN lValid



Function dJulianoFacCli( cFacCliL )

   IIF( cFacCliL == nil, cFacCliL := dbfFacCliL, ) ;

RETURN ( AddMonth( JulianoToDate( , Val( ( cFacCliL )->cLote ) ), 6 ) )








Static Function CreateFileEDI()

   local cCabeceraFactura     := uFieldEmpresa( "cRutEdi" ) + "\" + "SINCC.TXT"
   local cLineaFactura        := uFieldEmpresa( "cRutEdi" ) + "\" + "SINCL.TXT"
   local cVencimientoFactura  := uFieldEmpresa( "cRutEdi" ) + "\" + "SINCV.TXT"
   local cDescuentoFactura    := uFieldEmpresa( "cRutEdi" ) + "\" + "SINCD.TXT"
   local cImpuestosFactura    := uFieldEmpresa( "cRutEdi" ) + "\" + "SINCI.TXT"

   if file( cCabeceraFactura )
      ferase( cCabeceraFactura )
   end
   if file( cLineaFactura )
      ferase( cLineaFactura )
   end
   if file( cVencimientoFactura )
      ferase( cVencimientoFactura )
   end
   if file( cDescuentoFactura )
      ferase( cDescuentoFactura )
   end
   if file( cImpuestosFactura )
      ferase( cImpuestosFactura )
   end

   hCabeceraFactura           := fCreate( cCabeceraFactura     )
   hLineaFactura              := fCreate( cLineaFactura        )
   hVencimientoFactura        := fCreate( cVencimientoFactura  )
   hDescuentoFactura          := fCreate( cDescuentoFactura    )
   hImpuestosFactura          := fCreate( cImpuestosFactura    )

return nil



Static Function CloseFileEDI()

   fClose( hCabeceraFactura      )
   fClose( hLineaFactura         )
   fClose( hVencimientoFactura   )
   fClose( hDescuentoFactura     )
   fClose( hImpuestosFactura     )

return nil



Static Function ExportarEDI( lNoExportados, oTree )

   local oNode
   local nDescuento           := 0
   local nNumeroLinea         := 0
   local cNumeroFactura

   if ( dbfFacCliT )->lExpEdi .AND. lNoExportados
      oNode                   := oTree:Add( "Factura : " + ( dbfFacCliT )->cSerie + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + Alltrim( ( dbfFacCliT )->cSufFac ) + " anteriormente generada.", 1 )
      oTree:Select( oNode )
      Return .F.
   end

   cNumeroFactura             := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac





   if hCabeceraFactura        <> -1 .AND. hLineaFactura           <> -1 .AND. hVencimientoFactura     <> -1 .AND. hDescuentoFactura       <> -1 .AND. hImpuestosFactura       <> -1

      nTotFacCli( cNumeroFactura, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT )





      ExportaEDICabecera( hCabeceraFactura )





      if !Empty( ( dbfFacCliT )->nDtoEsp )
         ExportaEDIDescuentoCabecera( ( dbfFacCliT )->nDtoEsp, nTotDto, ++nDescuento, hDescuentoFactura )
      end

      if !Empty( ( dbfFacCliT )->nDpp )
         ExportaEDIDescuentoCabecera( ( dbfFacCliT )->nDpp, nTotDpp, ++nDescuento, hDescuentoFactura )
      end

      if !Empty( ( dbfFacCliT )->nDtoAtp )
         ExportaEDIDescuentoCabecera( ( dbfFacCliT )->nDtoAtp, nTotAtp, ++nDescuento, hDescuentoFactura )
      end

      if !Empty( ( dbfFacCliT )->nDtoUno )
         ExportaEDIDescuentoCabecera( ( dbfFacCliT )->nDtoUno, nTotUno, ++nDescuento, hDescuentoFactura )
      end

      if !Empty( ( dbfFacCliT )->nDtoDos )
         ExportaEDIDescuentoCabecera( ( dbfFacCliT )->nDtoDos, nTotDos, ++nDescuento, hDescuentoFactura )
      end





      ExportaEDIImpuestos( hImpuestosFactura )





      if ( dbfFacCliL )->( dbSeek( cNumeroFactura ) )

         while ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac == cNumeroFactura .AND. !( dbfFacCliL )->( eof() )

            if lValLine( dbfFacCliL )

               ExportaEDILinea( ++nNumeroLinea, hLineaFactura  )

               if ( dbfFacCliL )->nDto <> 0
                  ExportaEDIDescuentoLinea( ( dbfFacCliL )->nDto, nDtoLFacCli( dbfFacCliL, nRouDiv, nVdvDiv ), nNumeroLinea, ++nDescuento, hDescuentoFactura  )
               end

               if ( dbfFacCliL )->nDtoPrm <> 0
                  ExportaEDIDescuentoLinea( ( dbfFacCliL )->nDtoPrm, nPrmLFacCli( dbfFacCliL, nRouDiv, nVdvDiv ), nNumeroLinea, ++nDescuento, hDescuentoFactura  )
               end

            end

            ( dbfFacCliL )->( dbSkip() )

         end

      end





      nNumeroLinea         := 0

      if ( dbfFacCliP )->( dbSeek( cNumeroFactura ) )

         while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cNumeroFactura .AND. !( dbfFacCliP )->( eof() )

            ExportaEDIRecibo( ++nNumeroLinea, hVencimientoFactura )

            ( dbfFacCliP )->( dbSkip() )

         end

      end





      if dbLock( dbfFacCliT )
         ( dbfFacCliT )->lExpEdi    := .T.
         ( dbfFacCliT )->dFecEdi    := GetSysDate()
         ( dbfFacCliT )->cHorEdi    := Time()
         ( dbfFacCliL )->( dbUnlock() )
      end

      oNode                := oTree:Add( "Factura : " + ( dbfFacCliT )->cSerie + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + Alltrim( ( dbfFacCliT )->cSufFac ) + " ficheros generados.", 1 )

   else

      oNode                := oTree:Add( "Factura : " + ( dbfFacCliT )->cSerie + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + Alltrim( ( dbfFacCliT )->cSufFac ) + " ficheros no generados.", 0 )

   end

   oTree:Select( oNode )

Return .T.



Static Function ExportaEDICabecera( hFicheroFactura )

   local cCabecera         := ""
   local nDescuento        := 0


   cCabecera         += Padr( "380", 6 )
   cCabecera         += Padr( Alltrim( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac) , 17 )
   cCabecera         += Padr( uFieldEmpresa( "cCodEdi" ), 13 )
   cCabecera         += Padr( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "cCodEdi" ), 13 )
   cCabecera         += Padr( "", 6 )
   cCabecera         += Padr( Dtos( ( dbfFacCliT )->dFecFac ), 8 )
   cCabecera         += Padr( Dtos( ( dbfFacCliT )->dFecFac ) + Dtos( ( dbfFacCliT )->dFecFac ), 16 )
   cCabecera         += Padr( "42", 6 )
   cCabecera         += Padr( uFieldEmpresa( "cCodEdi" ), 13 )
   cCabecera         += Padr( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "cCodEdi" ), 13 )
   if !Empty( ( dbfFacCliT )->cCodObr )
      cCabecera      += Padr( Retfld( ( dbfFacCliT )->cCodCli + ( dbfFacCliT )->cCodObr, dbfObrasT, "cCodEdi" ), 13 )
   else
      cCabecera      += Padr( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "cCodEdi" ), 13 )
   end
   cCabecera         += Padr( uFieldEmpresa( "cCodEdi" ), 13 )
   cCabecera         += Padr( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "cCodEdi" ), 13 )
   cCabecera         += Padr( "", 6 )
   cCabecera         += Padr( ( dbfFacCliT )->cSuFac, 17 )
   cCabecera         += Padr( ( dbfFacCliT )->cSuAlb, 17 )
   cCabecera         += Padr( "", 3 )
   cCabecera         += Padr( "", 17 )
   cCabecera         += Padr( "", 17 )
   cCabecera         += Padr( "", 17 )
   cCabecera         += Padr( ( dbfFacCliT )->cNomCli, 70 )
   cCabecera         += Padr( ( dbfFacCliT )->cDirCli, 70 )
   cCabecera         += Padr( ( dbfFacCliT )->cPobCli, 35 )
   cCabecera         += Padr( ( dbfFacCliT )->cPosCli, 9 )
   cCabecera         += Padr( ( dbfFacCliT )->cDniCli, 17 )
   cCabecera         += Padr( uFieldEmpresa( "cDomicilio" ), 70 )
   cCabecera         += Padr( uFieldEmpresa( "cPoblacion" ), 35 )
   cCabecera         += Padr( uFieldEmpresa( "cCodPos" ), 9 )
   cCabecera         += Padr( ( dbfFacCliT )->cDivFac, 6 )
   cCabecera         += Padr( "", 8 )
   cCabecera         += Padl( Trans( nTotNet, "99999999999999.999" ), 18 )
   cCabecera         += Padl( Trans( nTotNet, "99999999999999.999" ), 18 )
   cCabecera         += Padl( Trans( nTotBrt, "99999999999999.999" ), 18 )
   cCabecera         += Padl( Trans( nTotImp, "99999999999999.999" ), 18 )
   cCabecera         += Padl( Trans( nTotFac, "99999999999999.999" ), 18 )
   cCabecera         += Padl( Trans( 0, "99999999999999.999" ), 18 )
   cCabecera         += Padl( Trans( 0, "99999999999999.999" ), 18 )
   cCabecera         += Padl( Trans( nTotDto, "99999999999999.999" ), 18 )
   cCabecera         += Padr( "", 17 )
   cCabecera         += Padr( "", 13 )
   cCabecera         += Padr( "", 17 )
   cCabecera         += Chr(13)+Chr(10)

   fWrite( hFicheroFactura, cCabecera )

Return nil

Static Function ExportaEDILinea( nNumeroLinea, hFicheroFactura )

   local cLinea      := ""


   cLinea            += Padr( "380", 6 )
   cLinea            += Padr( Alltrim( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac) , 17 )
   cLinea            += Padr( uFieldEmpresa( "cCodEdi" ), 13 )
   cLinea            += Padr( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "cCodEdi" ), 13 )
   cLinea            += Padl( Trans( nNumeroLinea, "999999" ), 6 )
   cLinea            += Padr( RetFld( ( dbfFacCliL )->cRef, dbfArticulo, "Codebar" ), 15 )
   cLinea            += Padr( if( !Empty( ( dbfFacCliL )->cDetalle ), ( dbfFacCliL )->cDetalle, ( dbfFacCliL )->mLngDes ), 35 )
   cLinea            += Padr( "M", 1 )
   cLinea            += Padr( "", 15 )
   cLinea            += Padr( "", 15 )
   cLinea            += Padr( "", 15 )
   cLinea            += Padr( "", 15 )
   cLinea            += Padr( ( dbfFacCliL )->cLote, 15 )
   cLinea            += Padl( Trans( nTotNFacCli( dbfFacCliL ), "999999999999.999" ), 16 )
   cLinea            += Padl( Trans( 0, "999999999999.999" ), 16 )
   cLinea            += Padr( "", 6 )
   cLinea            += Padl( Trans( 0, "999999999999.999" ), 16 )
   cLinea            += Padl( Trans( 0, "999999999999.999" ), 16 )
   cLinea            += Padl( Trans( nTotLFacCli( dbfFacCliL, nDouDiv, nRouDiv ), "99999999999999.999" ), 18 )
   cLinea            += Padl( Trans( nTotUFacCli( dbfFacCliL, nDouDiv ), "99999999999.999" ), 16 )
   cLinea            += Padl( Trans( nTotPFacCli( dbfFacCliL, nDouDiv ), "9999999999.9999" ), 16 )
   cLinea            += Padr( "", 6 )
   cLinea            += Padr( "VAT", 6 )
   cLinea            += Padl( Trans( ( dbfFacCliL )->nIva, "999.99" ), 6 )
   cLinea            += Padl( Trans( 0, "9999999999999.999" ), 18 )
   cLinea            += Padl( Trans( if( ( dbfFacCliT )->lRecargo, ( dbfFacCliL )->nReq, 0 ), "999.99" ), 6 )
   cLinea            += Padl( Trans( 0, "9999999999999.999" ), 18 )
   cLinea            += Padr( "", 6 )
   cLinea            += Padl( Trans( 0, "999.99" ), 6 )
   cLinea            += Padl( Trans( 0, "9999999999999.999" ), 18 )
   cLinea            += Padr( ( dbfFacCliT )->cNumPed, 17 )
   cLinea            += Padr( ( dbfFacCliL )->cCodAlb, 17 )
   cLinea            += Padl( Trans( 0, "99999999" ), 8 )
   cLinea            += Padr( "", 7 )
   cLinea            += Padl( Trans( nTotLFacCli( dbfFacCliL, nDouDiv, nRouDiv, nVdvDiv, .F. ), "99999999999999.999" ), 18 )
   cLinea            += Chr(13)+Chr(10)

   fWrite( hFicheroFactura, cLinea )

Return nil

Static Function ExportaEDIRecibo( nNumeroRecibo, hFicheroFactura )

   local cRecibo     := ""


   cRecibo           += Padr( "380", 6 )
   cRecibo           += Padr( Alltrim( ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac ) , 17 )
   cRecibo           += Padr( uFieldEmpresa( "cCodEdi" ), 13 )
   cRecibo           += Padr( Retfld( ( dbfFacCliP )->cCodCli, dbfClient, "cCodEdi" ), 13 )
   cRecibo           += Padl( Trans( nNumeroRecibo, "999999" ), 6 )
   cRecibo           += Padr( Dtos( ( dbfFacCliP )->dFecVto ), 8 )
   cRecibo           += Padl( Trans( nTotRecCli( dbfFacCliP, dbfDiv ), "999999999999.999" ), 16 )
   cRecibo           += Chr(13)+Chr(10)

   fWrite( hFicheroFactura, cRecibo )

Return nil

Static Function ExportaEDIDescuentoCabecera( nPorcentajeDescuento, nTotalDescuento, nDescuento, hFicheroFactura )

   local cCabecera   := ""


   cCabecera         += Padr( "380", 6 )
   cCabecera         += Padr( Alltrim( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) , 17 )
   cCabecera         += Padr( uFieldEmpresa( "cCodEdi" ), 13 )
   cCabecera         += Padr( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "cCodEdi" ), 13 )
   cCabecera         += Padl( Trans( 0, "999999" ), 6 )
   cCabecera         += Padl( Trans( nDescuento, "99" ), 2 )
   cCabecera         += "A"
   cCabecera         += Padl( Trans( nDescuento, "999" ), 3 )
   cCabecera         += Padl( Trans( nPorcentajeDescuento, "9999.9999" ), 9 )
   cCabecera         += Padl( Trans( nTotalDescuento, "99999999999999.999" ), 18 )
   cCabecera         += Padl( Trans( 0, "99999999999999.999" ), 18 )
   cCabecera         += Padl( Trans( 0, "999999999999.999" ), 16 )
   cCabecera         += Padr( "TD", 6 )
   cCabecera         += Padl( Trans( 0, "999999999999.999" ), 16 )
   cCabecera         += Padr( "", 6 )
   cCabecera         += Chr(13)+Chr(10)

  fWrite( hFicheroFactura, cCabecera )

Return nil

Static Function ExportaEDIDescuentoLinea( nPorcentajeDescuento, nTotalDescuento, nLinea, nDescuento, hFicheroFactura )

   local cLinea      := ""


   cLinea            += Padr( "380", 6 )
   cLinea            += Padr( Alltrim( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) , 17 )
   cLinea            += Padr( uFieldEmpresa( "cCodEdi" ), 13 )
   cLinea            += Padr( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "cCodEdi" ), 13 )
   cLinea            += Padl( Trans( nLinea, "999999" ), 6 )
   cLinea            += Padl( Trans( nDescuento, "99" ), 2 )
   cLinea            += "A"
   cLinea            += Padl( Trans( nDescuento, "999" ), 3 )
   cLinea            += Padl( Trans( nPorcentajeDescuento, "9999.9999" ), 9 )
   cLinea            += Padl( Trans( nTotalDescuento, "99999999999999.999" ), 18 )
   cLinea            += Padl( Trans( 0, "99999999999999.999" ), 18 )
   cLinea            += Padl( Trans( 0, "999999999999.999" ), 16 )
   cLinea            += Padr( "TD", 6 )
   cLinea            += Padl( Trans( 0, "999999999999.999" ), 16 )
   cLinea            += Padr( "", 6 )
   cLinea            += Chr(13)+Chr(10)

  fWrite( hFicheroFactura, cLinea )

Return nil

Static Function ExportaEDIImpuestos( hFicheroFactura )

   local nImpuesto   := 0
   local cImpuesto   := ""

   if !Empty( aIvaUno[ 3 ] )

      cImpuesto      += Padr( "380", 6 )
      cImpuesto      += Padr( Alltrim( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) , 17 )
      cImpuesto      += Padr( uFieldEmpresa( "cCodEdi" ), 13 )
      cImpuesto      += Padr( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "cCodEdi" ), 13 )
      cImpuesto      += Padl( Trans( ++nImpuesto, "99" ), 2 )
      cImpuesto      += Padr( "VAT", 6 )
      cImpuesto      += Padl( Trans( aIvaUno[ 3 ], "999.99" ), 6 )
      cImpuesto      += Padl( Trans( aIvaUno[ 8 ], "99999999999999.999" ), 18 )
      cImpuesto      += Padl( Trans( aIvaUno[ 2 ], "99999999999999.999" ), 18 )
      cImpuesto      += Chr(13)+Chr(10)
   end

   if !Empty( aIvaDos[ 3 ] )

      cImpuesto      += Padr( "380", 6 )
      cImpuesto      += Padr( Alltrim( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) , 17 )
      cImpuesto      += Padr( uFieldEmpresa( "cCodEdi" ), 13 )
      cImpuesto      += Padr( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "cCodEdi" ), 13 )
      cImpuesto      += Padl( Trans( ++nImpuesto, "99" ), 2 )
      cImpuesto      += Padr( "VAT", 6 )
      cImpuesto      += Padl( Trans( aIvaDos[ 3 ], "999.99" ), 6 )
      cImpuesto      += Padl( Trans( aIvaDos[ 8 ], "99999999999999.999" ), 18 )
      cImpuesto      += Padl( Trans( aIvaDos[ 2 ], "99999999999999.999" ), 18 )
      cImpuesto      += Chr(13)+Chr(10)
   end

   if !Empty( aIvaTre[ 3 ] )

      cImpuesto      += Padr( "380", 6 )
      cImpuesto      += Padr( Alltrim( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) , 17 )
      cImpuesto      += Padr( uFieldEmpresa( "cCodEdi" ), 13 )
      cImpuesto      += Padr( Retfld( ( dbfFacCliT )->cCodCli, dbfClient, "cCodEdi" ), 13 )
      cImpuesto      += Padl( Trans( ++nImpuesto, "99" ), 2 )
      cImpuesto      += Padr( "VAT", 6 )
      cImpuesto      += Padl( Trans( aIvaTre[ 3 ], "999.99" ), 6 )
      cImpuesto      += Padl( Trans( aIvaTre[ 8 ], "99999999999999.999" ), 18 )
      cImpuesto      += Padl( Trans( aIvaTre[ 2 ], "99999999999999.999" ), 18 )
      cImpuesto      += Chr(13)+Chr(10)
   end

   fWrite( hFicheroFactura, cImpuesto )

Return nil



static function lChangeEDI( aGet, aTmp )

   if aTmp[ 95 ]
      aGet[ 96 ]:cText( GetSysDate() )
      aGet[ 97 ]:cText( Time() )
   else
      aGet[ 96 ]:cText( Ctod( "" ) )
      aGet[ 97 ]:cText( Space( 5 ) )
   end

Return .T.



Static Function CreateFileFacturae( oTree, lFirmar, lEnviar )

   local a
   local oTax
   local nPago
   local nTotal
   local cNumero
   local nNumero
   local oFactura
   local oDiscount
   local nAnticipo
   local oItemLine
   local oInstallment

   nNumero              := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac
   cNumero              := ( dbfFacCliT )->cSerie + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) + Rtrim( ( dbfFacCliT )->cSufFac )

   nTotal               := nTotFacCli( nNumero, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT )
   nPago                := nPagFacCli( nNumero, dbfFacCliT, dbfFacCliP, dbfIva, dbfDiv )
   nAnticipo            := nTotAntFacCli( nNumero, dbfAntCliT, dbfIva, dbfDiv )

   oFactura             := TFacturaElectronica():New( oTree )

   with object ( oFactura )

      :cFicheroOrigen            := cPatXml() + cNumero + ".xml"
      :cFicheroDestino           := cPatXml() + cNumero + ".f64"





      :cMailServer               := Rtrim( uFieldEmpresa( "cSrvMai" ) )
      :cMailServerPort           := uFieldEmpresa( "nPrtMai" )
      :cMailServerUserName       := Rtrim( uFieldEmpresa( "cCtaMai" ) )
      :cMailServerPassword       := Rtrim( uFieldEmpresa( "cPssMai" ) )





      :cNif                      := uFieldEmpresa( "cNif" )

      :cInvoiceSeriesCode        := ( dbfFacCliT )->cSerie
      :cInvoiceNumber            := Str( Year( ( dbfFacCliT )->dFecFac ) ) + "/" + ( dbfFacCliT )->cSerie + Rtrim( ( dbfFacCliT )->cSufFac ) + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) )
      :cInvoiceCurrencyCode      := ( dbfFacCliT )->cDivFac
      :cTaxCurrencyCode          := ( dbfFacCliT )->cDivFac
      :nInvoiceTotalAmount       := nTotal
      :nTotalOutstandingAmount   := nTotal - nPago
      :nTotalExecutableAmount    := nTotal





      :oSellerParty:cTaxIdentificationNumber          := "ES" + uFieldEmpresa( "cNif" )

      if Val( Left( uFieldEmpresa( "cNif" ), 1 ) ) <> 0
         :oSellerParty:cPersonTypeCode                := "F"
         :oSellerParty:cName                          := uFieldEmpresa( "cNombre" )
         :oSellerParty:cFirstSurname                  := uFieldEmpresa( "cNombre" )
      else
         :oSellerParty:cPersonTypeCode                := "J"
         :oSellerParty:cCorporateName                 := uFieldEmpresa( "cNombre" )
         :oSellerParty:cTradeName                     := uFieldEmpresa( "cNombre" )
         :oSellerParty:cRegisterOfCompaniesLocation   := uFieldEmpresa( "cNumRegMer" )
      end

      :oSellerParty:cAddress                          := uFieldEmpresa( "cDomicilio" )
      :oSellerParty:cPostCode                         := uFieldEmpresa( "cCodPos" )
      :oSellerParty:cTown                             := uFieldEmpresa( "cPoblacion" )
      :oSellerParty:cProvince                         := uFieldEmpresa( "cProvincia" )
      :oSellerParty:cTelephone                        := uFieldEmpresa( "cTlf" )
      :oSellerParty:cTelFax                           := uFieldEmpresa( "cFax" )
      :oSellerParty:cWebAddress                       := uFieldEmpresa( "Web" )
      :oSellerParty:cElectronicMail                   := uFieldEmpresa( "EMail" )





      :oBuyerParty:cTaxIdentificationNumber           := "ES" + ( dbfFacCliT )->cDniCli

      if Val( Left( ( dbfFacCliT )->cDniCli, 1 ) ) <> 0
         :oBuyerParty:cPersonTypeCode                 := "F"
         :oBuyerParty:cName                           := ( dbfFacCliT )->cNomCli
         :oBuyerParty:cFirstSurname                   := ( dbfFacCliT )->cNomCli
      else
         :oBuyerParty:cPersonTypeCode                 := "J"
         :oBuyerParty:cCorporateName                  := ( dbfFacCliT )->cNomCli
         :oBuyerParty:cTradeName                      := ( dbfFacCliT )->cNomCli
      end

      :oBuyerParty:cAddress                           := ( dbfFacCliT )->cDirCli
      :oBuyerParty:cPostCode                          := ( dbfFacCliT )->cPosCli
      :oBuyerParty:cTown                              := ( dbfFacCliT )->cPobCli
      :oBuyerParty:cProvince                          := ( dbfFacCliT )->cPrvCli
      :oBuyerParty:cTelephone                         := RetFld( ( dbfFacCliT )->cCodCli, dbfClient, "Telefono" )
      :oBuyerParty:cTelFax                            := RetFld( ( dbfFacCliT )->cCodCli, dbfClient, "Fax" )
      :oBuyerParty:cWebAddress                        := RetFld( ( dbfFacCliT )->cCodCli, dbfClient, "cWebInt" )
      :oBuyerParty:cElectronicMail                    := RetFld( ( dbfFacCliT )->cCodCli, dbfClient, "cMeiInt" )





      :dOperationDate                              := ( dbfFacCliT )->dFecFac
      :dIssueDate                                  := ( dbfFacCliT )->dFecFac


      :cPlaceOfIssuePostCode                       := uFieldEmpresa( "cCodPos" )
      :cPlaceOfIssueDescription                    := uFieldEmpresa( "cPoblacion" )





      :nInvoiceTotal                               := nTotal
      :nTotalGrossAmount                           := nTotBrt





      for each a in aTotIva

         if !IsNil( a[ 3 ] )

            oTax                                   := Tax()
            oTax:nTaxBase                          := a[ 2 ]
            oTax:nTaxRate                          := a[ 3 ]
            oTax:nTaxAmount                        := a[ 8 ]
            oTax:nEquivalenceSurcharge             := a[ 4 ]
            oTax:nEquivalenceSurchargeAmount       := a[ 9 ]

            :addTax( oTax )

         end

      next





      if nTotDto <> 0

         oDiscount                                 := Discount()
         oDiscount:cDiscountReason                 := ( dbfFacCliT )->cDtoEsp
         oDiscount:nDiscountRate                   := ( dbfFacCliT )->nDtoEsp
         oDiscount:nDiscountAmount                 := nTotDto

         :addDiscount( oDiscount )

      end

      if nTotDpp <> 0

         oDiscount                                 := Discount()
         oDiscount:cDiscountReason                 := ( dbfFacCliT )->cDpp
         oDiscount:nDiscountRate                   := ( dbfFacCliT )->nDpp
         oDiscount:nDiscountAmount                 := nTotDpp

         :addDiscount( oDiscount )

      end

      if nTotUno <> 0

         oDiscount                                 := Discount()
         oDiscount:cDiscountReason                 := ( dbfFacCliT )->cDtoUno
         oDiscount:nDiscountRate                   := ( dbfFacCliT )->nDtoUno
         oDiscount:nDiscountAmount                 := nTotUno

         :addDiscount( oDiscount )

      end

      if nTotDos <> 0

         oDiscount                                 := Discount()
         oDiscount:cDiscountReason                 := ( dbfFacCliT )->cDtoDos
         oDiscount:nDiscountRate                   := ( dbfFacCliT )->nDtoDos
         oDiscount:nDiscountAmount                 := nTotDos

         :addDiscount( oDiscount )

      end

      if nTotAtp <> 0

         oDiscount                                 := Discount()
         oDiscount:cDiscountReason                 := ""
         oDiscount:nDiscountRate                   := ( dbfFacCliT )->nDtoAtp
         oDiscount:nDiscountAmount                 := nTotAtp

         :addDiscount( oDiscount )

      end







      if ( dbfFacCliL )->( dbSeek( nNumero ) )

         while ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac == nNumero .AND. !( dbfFacCliL )->( Eof() )

            if lValLine( dbfFacCliL ) .AND. !( dbfFacCliL )->lTotLin

               oItemLine                           := ItemLine():New( oFactura )

               oItemLine:cItemDescription          := Descrip( dbfFacCliL )
               oItemLine:nQuantity                 := nTotNFacCli( dbfFacCliL )
               oItemLine:nUnitPriceWithoutTax      := nTotUFacCli( dbfFacCliL, nRouDiv )



               if ( dbfFacCliL )->nDto <> 0

                  oDiscount                        := Discount()
                  oDiscount:nDiscountRate          := ( dbfFacCliL )->nDto

                  oItemLine:addDiscount( oDiscount )

               end



               if ( dbfFacCliL )->nDtoPrm <> 0

                  oDiscount                        := Discount()
                  oDiscount:nDiscountRate          := ( dbfFacCliL )->nDtoPrm

                  oItemLine:addDiscount( oDiscount )

               end



               oTax                                := Tax()
               oTax:nTaxRate                       := ( dbfFacCliL )->nIva
               oTax:nTaxBase                       := nTotLFacCli( dbfFacCliL, nDouDiv, nRouDiv, , , .F., .F. )
               oTax:nTaxAmount                     := nIvaLFacCli( dbfFacCliT, dbfFacCliL, nDouDiv, nRouDiv, , .F., .F., .F. )

               if ( dbfFacCliT )->lRecargo
                  oTax:nEquivalenceSurcharge       := ( dbfFacCliL )->nReq
                  oTax:nEquivalenceSurchargeAmount := nReqLFacCli( dbfFacCliT, dbfFacCliL, nDouDiv, nRouDiv, , .F., .F., .F. )
               end

               oItemLine:addTax( oTax )



               :addItemLine( oItemLine )

            end

            ( dbfFacCliL )->( dbSkip() )

         end

      end





      if ( dbfFacCliP )->( dbSeek( nNumero ) )

         while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == nNumero .AND. !( dbfFacCliP )->( Eof() )

            if Empty( ( dbfFacCliP )->cTipRec )

               if !Empty( cCodigoXmlPago( ( dbfFacCliP )->cCodPgo, dbfFPago ) )

                  oInstallment                           := Installment()
                  oInstallment:dInstallmentDueDate       := ( dbfFacCliP )->dFecVto
                  oInstallment:nInstallmentAmount        := nTotRecCli( dbfFacCliP, dbfDiv )
                  oInstallment:cPaymentMeans             := cCodigoXmlPago( ( dbfFacCliP )->cCodPgo, dbfFPago )





                  if oInstallment:cPaymentMeans == "02"

                     if lBancoDefecto( ( dbfFacCliT )->cCodCli, dbfCliBnc )

                        oInstallment:oAccountToBeCredited               := Account()
                        oInstallment:oAccountToBeCredited:cIBAN         := ( dbfCliBnc )->cCtaBnc
                        oInstallment:oAccountToBeCredited:cBankCode     := Left( ( dbfCliBnc )->cCtaBnc, 4 )
                        oInstallment:oAccountToBeCredited:cBranchCode   := SubStr( ( dbfCliBnc )->cCtaBnc, 4, 4 )
                        oInstallment:oAccountToBeCredited:cAddress      := ( dbfCliBnc )->cDirBnc
                        oInstallment:oAccountToBeCredited:cPostCode     := ( dbfCliBnc )->cCpBnc
                        oInstallment:oAccountToBeCredited:cTown         := ( dbfCliBnc )->cPobBnc
                        oInstallment:oAccountToBeCredited:cProvince     := ( dbfCliBnc )->cProBnc
                        oInstallment:oAccountToBeCredited:cCountryCode  := "ESP"

                     end

                  end

                  :addInstallment( oInstallment )

               else

                  oTree:Add( "Recibo : " + ( dbfFacCliP )->cSerie + "/" + AllTrim( Str( ( dbfFacCliP )->nNumFac ) ) + "/" + ( dbfFacCliP )->cSufFac + "-" + Str( ( dbfFacCliP )->nNumRec ) + " no tiene código de facturae." )

               end

            end

            ( dbfFacCliP )->( dbSkip() )

         end

      end

   end





   oFactura:GeneraXml()

   if !oFactura:lError
      if dbLock( dbfFacCliT )
         ( dbfFacCliT )->lExpFac := .T.
         ( dbfFacCliT )->( dbUnLock() )
      end
   end





   if lFirmar
      oFactura:Firma()
   end

   if lEnviar
      oFactura:Enviar()
   end

   oFactura:ShowInWeb()

return nil







FUNCTION cChkPagFacCli( cFacCli, dbfFacCliT, dbfFacCliP )

   local cChkPag        := ""
   local nChkPag        := nChkPagFacCli( cFacCli, dbfFacCliT, dbfFacCliP )

   do case
      case nChkPag == 1
         cChkPag        := "Cobrado"

      case nChkPag == 2
         cChkPag        := "Parcialmente"

      case nChkPag == 3
         cChkPag        := "Pendiente"

   end

RETURN ( cChkPag )



FUNCTION nChkPagFacCli( cFacCli, dbfFacCliT, dbfFacCliP )

   local nBitmap        := 3

   if ( dbfFacCliT )->lLiquidada

      nBitmap           := 1

   elseif ( dbfFacCliP )->( dbSeek( cFacCli ) )

      while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cFacCli .AND. !( dbfFacCliP )->( eof() )

         if ( dbfFaccliP )->lCobrado .AND. !( dbfFacCliP )->lDevuelto

            nBitmap     := 2
            exit

         end

         ( dbfFacCliP )->( dbSkip() )

      end

   end

RETURN nBitmap



Static Function loadRecCli( aTmp, oBrwPgo )

   local nRec
   local cFac

   DisableAcceso()

   nRec           := ( dbfTmpPgo  )->( Recno() )
   cFac           := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]

   ( dbfTmpPgo )->( __dbZap() )

   if ( dbfFacCliP )->( dbSeek( cFac ) )

      while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cFac .AND. ( dbfFacCliP )->( !eof() )

         if Empty( ( dbfFacCliP )->cTipRec )
            dbPass( dbfFacCliP, dbfTmpPgo, .T. )
         end

         ( dbfFacCliP )->( dbSkip() )

      end

   end

   ( dbfTmpPgo )->( dbGoto( nRec ) )

   if !Empty( oBrwPgo )
      oBrwPgo:Refresh()
   end

   EnableAcceso()

RETURN nil






Function nTotalSaldo16( cCodArt, cCodCli, dFecha )

   IIF( cCodArt == nil, cCodArt := Padr( "16", 18 ), ) ;
   IIF( cCodCli == nil, cCodCli := ( dbfFacCliT )->cCodCli, ) ;
   IIF( dFecha == nil, dFecha := ( dbfFacCliT )->dFecFac, ) ;

Return oStock:nTotalSaldo( cCodArt, cCodCli, dFecha )




Function nTotalSaldo8( cCodArt, cCodCli, dFecha )

   IIF( cCodArt == nil, cCodArt := Padr( "8", 18 ), ) ;
   IIF( cCodCli == nil, cCodCli := ( dbfFacCliT )->cCodCli, ) ;
   IIF( dFecha == nil, dFecha := ( dbfFacCliT )->dFecFac, ) ;

Return oStock:nTotalSaldo( cCodArt, cCodCli, dFecha )




Function nTotalSaldo4( cCodArt, cCodCli, dFecha )

   IIF( cCodArt == nil, cCodArt := Padr( "4", 18 ), ) ;
   IIF( cCodCli == nil, cCodCli := ( dbfFacCliT )->cCodCli, ) ;
   IIF( dFecha == nil, dFecha := ( dbfFacCliT )->dFecFac, ) ;

Return oStock:nTotalSaldo( cCodArt, cCodCli, dFecha )




Function nSaldoDoc16( cCodArt, cNumDoc )

   IIF( cCodArt == nil, cCodArt := Padr( "16", 18 ), ) ;
   IIF( cNumDoc == nil, cNumDoc := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, ) ;

Return oStock:nSaldoDocumento( cCodArt, cNumDoc )




Function nSaldoDoc8( cCodArt, cNumDoc )

   IIF( cCodArt == nil, cCodArt := Padr( "8", 18 ), ) ;
   IIF( cNumDoc == nil, cNumDoc := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, ) ;

Return oStock:nSaldoDocumento( cCodArt, cNumDoc )




Function nSaldoDoc4( cCodArt, cNumDoc )

   IIF( cCodArt == nil, cCodArt := Padr( "4", 18 ), ) ;
   IIF( cNumDoc == nil, cNumDoc := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, ) ;

Return oStock:nSaldoDocumento( cCodArt, cNumDoc )




Function nSaldoAnt16( cCodArt, cNumDoc )

   IIF( cCodArt == nil, cCodArt := Padr( "16", 18 ), ) ;
   IIF( cNumDoc == nil, cNumDoc := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, ) ;

Return oStock:nSaldoAnterior( cCodArt, cNumDoc )




Function nSaldoAnt8( cCodArt, cNumDoc )

   IIF( cCodArt == nil, cCodArt := Padr( "8", 18 ), ) ;
   IIF( cNumDoc == nil, cNumDoc := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, ) ;

Return oStock:nSaldoAnterior( cCodArt, cNumDoc )




Function nSaldoAnt4( cCodArt, cNumDoc )

   IIF( cCodArt == nil, cCodArt := Padr( "4", 18 ), ) ;
   IIF( cNumDoc == nil, cNumDoc := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac, ) ;

Return oStock:nSaldoAnterior( cCodArt, cNumDoc )



Function cTotFacCli()

Return ( Num2Text( nTotFac ) )



Static Function EndPgo( aTmp, aGet, lPgdOld, nImpOld, dbfTmpPgo, oBrw, oDlg, nMode )

   local nImp
   local nCon
   local nRec        := ( dbfTmpPgo )->( Recno() )
   local lImpNeg     := ( dbfTmpPgo )->nImporte < 0
   local nImpTmp     := abs( aTmp[ ( dbfTmpPgo )->( FieldPos( "nImporte" ) ) ] )
   local nImpFld     := abs( ( dbfTmpPgo )->nImporte )

   if !aGet[ ( dbfTmpPgo )->( FieldPos( "nImpCob" ) ) ]:lValid()
      return .F.
   end





   if nImpTmp > nImpFld
      msgStop( "El importe no puede ser superior al actual." )
      return nil
   end

   oDlg:Disable()





   if nImpFld <> nImpTmp





      nImp                       := ( nImpFld - nImpTmp ) * if( lImpNeg, - 1 , 1 )





      ( dbfTmpPgo )->( dbAppend() )
      nCon                       := ( dbfTmpPgo )->( LastRec() )
      ( dbfTmpPgo )->cSerie      := aTmp[ ( dbfTmpPgo )->( FieldPos( "CSERIE"  ) ) ]
      ( dbfTmpPgo )->nNumFac     := aTmp[ ( dbfTmpPgo )->( FieldPos( "NNUMFAC" ) ) ]
      ( dbfTmpPgo )->cSufFac     := aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUFFAC" ) ) ]
      ( dbfTmpPgo )->nNumRec     := nCon
      ( dbfTmpPgo )->cCodCaj     := aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCAJ" ) ) ]
      ( dbfTmpPgo )->cCodCli     := aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCLI" ) ) ]
      ( dbfTmpPgo )->dEntrada    := Ctod( "" )
      ( dbfTmpPgo )->nImporte    := nImp
      ( dbfTmpPgo )->nImpGas     := 0
      ( dbfTmpPgo )->cDescrip    := "Recibo nº" + AllTrim( Str( nCon ) ) + " de factura " + aTmp[ ( dbfTmpPgo )->( FieldPos( "CSERIE" ) ) ] + "/" + AllTrim( Str( aTmp[ ( dbfTmpPgo )->( FieldPos( "NNUMFAC" ) ) ] ) ) + "/" + aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUFFAC" ) ) ]
      ( dbfTmpPgo )->dPreCob     := dFecFacCli( aTmp[ ( dbfTmpPgo )->( FieldPos( "CSERIE" ) ) ] + Str( aTmp[ ( dbfTmpPgo )->( FieldPos( "NNUMFAC" ) ) ] ) + aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUFFAC" ) ) ], dbfFacCliT )
      ( dbfTmpPgo )->dFecVto     := dFecFacCli( aTmp[ ( dbfTmpPgo )->( FieldPos( "CSERIE" ) ) ] + Str( aTmp[ ( dbfTmpPgo )->( FieldPos( "NNUMFAC" ) ) ] ) + aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUFFAC" ) ) ], dbfFacCliT )
      ( dbfTmpPgo )->cPgdoPor    := ""
      ( dbfTmpPgo )->lCobrado    := .F.
      ( dbfTmpPgo )->cDivPgo     := aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ]
      ( dbfTmpPgo )->nVdvPgo     := aTmp[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ]
      ( dbfTmpPgo )->lConPgo     := .F.

      ( dbfTmpPgo )->cTurRec     := cCurSesion()

      ( dbfTmpPgo )->( dbUnLock() )






      if !Empty( oAuditor() )
         oAuditor():AddEvent( "Genera recibo de factura de clientes", ( dbfTmpPgo )->cSerie + Str( ( dbfTmpPgo )->nNumFac ) + ( dbfTmpPgo )->cSufFac + Str( ( dbfTmpPgo )->nNumRec ), "18" )
      end


   end

   ( dbfTmpPgo )->( dbGoTo( nRec ) )





   WinGather( aTmp, aGet, dbfTmpPgo, oBrw, nMode )





   dbCommitAll()

   oDlg:Enable()

   oDlg:End( 1 )

return .T.



































































































_HB_CLASS sTotal ; UTILITY FUNCTION sTotal(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "sTotal" , { HBObject():Classh } ) ) ;

   _HB_MEMBER { nTotalNeto} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalNeto" }, .F., .F. ), )

   _HB_MEMBER { aTotalBase} ; IIF( !.F., s_oClass:AddMultiData(, { 0, 0, 0 }, nScope + IIF( .F., 32, 0 ), { "aTotalBase" }, .F., .F. ), )

   _HB_MEMBER { nTotalBruto} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalBruto" }, .F., .F. ), )
   _HB_MEMBER { aTotalBruto} ; IIF( !.F., s_oClass:AddMultiData(, { 0, 0, 0 }, nScope + IIF( .F., 32, 0 ), { "aTotalBruto" }, .F., .F. ), )

   _HB_MEMBER { nTotalDocumento} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalDocumento" }, .F., .F. ), )

   _HB_MEMBER { nTotalPuntoVerde} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalPuntoVerde" }, .F., .F. ), )
   _HB_MEMBER { nTotalTransporte} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalTransporte" }, .F., .F. ), )
   _HB_MEMBER { nTotalAgente} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalAgente" }, .F., .F. ), )

   _HB_MEMBER { nTotalIva} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalIva" }, .F., .F. ), )
   _HB_MEMBER { aTotalIva} ; IIF( !.F., s_oClass:AddMultiData(, { 0, 0, 0 }, nScope + IIF( .F., 32, 0 ), { "aTotalIva" }, .F., .F. ), )

   _HB_MEMBER { aPorcentajeIva} ; IIF( !.F., s_oClass:AddMultiData(, { nil, nil, nil }, nScope + IIF( .F., 32, 0 ), { "aPorcentajeIva" }, .F., .F. ), )

   _HB_MEMBER { nTotalRecargoEquivalencia} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalRecargoEquivalencia" }, .F., .F. ), )

   _HB_MEMBER { nTotalImpuestoHidrocarburos} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalImpuestoHidrocarburos" }, .F., .F. ), )
   _HB_MEMBER { aTotalImpuestoHidrocarburos} ; IIF( !.F., s_oClass:AddMultiData(, { 0, 0, 0 }, nScope + IIF( .F., 32, 0 ), { "aTotalImpuestoHidrocarburos" }, .F., .F. ), )

   _HB_MEMBER { nTotalRetencion} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalRetencion" }, .F., .F. ), )

   _HB_MEMBER { nTotalCosto} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalCosto" }, .F., .F. ), )
   _HB_MEMBER { nTotalRentabilidad} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalRentabilidad" }, .F., .F. ), )

   _HB_MEMBER { nTotalDescuentoGeneral} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalDescuentoGeneral" }, .F., .F. ), )
   _HB_MEMBER { nTotalDescuentoProntoPago} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalDescuentoProntoPago" }, .F., .F. ), )
   _HB_MEMBER { nTotalDescuentoUno} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalDescuentoUno" }, .F., .F. ), )
   _HB_MEMBER { nTotalDescuentoDos} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalDescuentoDos" }, .F., .F. ), )

   _HB_MEMBER { nTotalCobrado} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalCobrado" }, .F., .F. ), )

   _HB_MEMBER { nPromocion} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nPromocion" }, .F., .F. ), )

   _HB_MEMBER { nTotalPersona} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nTotalPersona" }, .F., .F. ), )

   _HB_MEMBER { nDecimalesRedondeo} ; IIF( !.F., s_oClass:AddMultiData(, 2, nScope + IIF( .F., 32, 0 ), { "nDecimalesRedondeo" }, .F., .F. ), )

   _HB_MEMBER { nCobrado} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nCobrado" }, .F., .F. ), )
   _HB_MEMBER { nCambio} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nCambio" }, .F., .F. ), )

   _HB_MEMBER nTotalPrimerBruto(); IIF( .F., s_oClass:ModInline( "nTotalPrimerBruto", {|Self | Self, ( ::aTotalBruto[ 1 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalPrimerBruto", {|Self | Self, ( ::aTotalBruto[ 1 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER nTotalSegundoBruto(); IIF( .F., s_oClass:ModInline( "nTotalSegundoBruto", {|Self | Self, ( ::aTotalBruto[ 2 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalSegundoBruto", {|Self | Self, ( ::aTotalBruto[ 2 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER nTotalTercerBruto(); IIF( .F., s_oClass:ModInline( "nTotalTercerBruto", {|Self | Self, ( ::aTotalBruto[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalTercerBruto", {|Self | Self, ( ::aTotalBruto[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER TotalBruto(); IIF( .F., s_oClass:ModInline( "TotalBruto", {|Self | Self, ( ::aTotalBruto[ 1 ] + ::aTotalBruto[ 2 ] + ::aTotalBruto[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "TotalBruto", {|Self | Self, ( ::aTotalBruto[ 1 ] + ::aTotalBruto[ 2 ] + ::aTotalBruto[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER nTotalPrimeraBase(); IIF( .F., s_oClass:ModInline( "nTotalPrimeraBase", {|Self | Self, ( ::aTotalBase[ 1 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalPrimeraBase", {|Self | Self, ( ::aTotalBase[ 1 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER nTotalSegundaBase(); IIF( .F., s_oClass:ModInline( "nTotalSegundaBase", {|Self | Self, ( ::aTotalBase[ 2 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalSegundaBase", {|Self | Self, ( ::aTotalBase[ 2 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER nTotalTerceraBase(); IIF( .F., s_oClass:ModInline( "nTotalTerceraBase", {|Self | Self, ( ::aTotalBase[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalTerceraBase", {|Self | Self, ( ::aTotalBase[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER TotalBase(); IIF( .F., s_oClass:ModInline( "TotalBase", {|Self | Self, ( ::aTotalBase[ 1 ] + ::aTotalBase[ 2 ] + ::aTotalBase[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "TotalBase", {|Self | Self, ( ::aTotalBase[ 1 ] + ::aTotalBase[ 2 ] + ::aTotalBase[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER nTotalPrimerIva(); IIF( .F., s_oClass:ModInline( "nTotalPrimerIva", {|Self | Self, ( ::aTotalIva[ 1 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalPrimerIva", {|Self | Self, ( ::aTotalIva[ 1 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER nTotalSegundoIva(); IIF( .F., s_oClass:ModInline( "nTotalSegundoIva", {|Self | Self, ( ::aTotalIva[ 2 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalSegundoIva", {|Self | Self, ( ::aTotalIva[ 2 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER nTotalTercerIva(); IIF( .F., s_oClass:ModInline( "nTotalTercerIva", {|Self | Self, ( ::aTotalIva[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalTercerIva", {|Self | Self, ( ::aTotalIva[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER TotalIva(); IIF( .F., s_oClass:ModInline( "TotalIva", {|Self | Self, ( ::aTotalIva[ 1 ] + ::aTotalIva[ 2 ] + ::aTotalIva[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "TotalIva", {|Self | Self, ( ::aTotalIva[ 1 ] + ::aTotalIva[ 2 ] + ::aTotalIva[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER nPorcentajePrimerIva(); IIF( .F., s_oClass:ModInline( "nPorcentajePrimerIva", {|Self | Self, ( ::aPorcentajeIva[ 1 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nPorcentajePrimerIva", {|Self | Self, ( ::aPorcentajeIva[ 1 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER nPorcentajeSegundoIva(); IIF( .F., s_oClass:ModInline( "nPorcentajeSegundoIva", {|Self | Self, ( ::aPorcentajeIva[ 2 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nPorcentajeSegundoIva", {|Self | Self, ( ::aPorcentajeIva[ 2 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER nPorcentajeTercerIva(); IIF( .F., s_oClass:ModInline( "nPorcentajeTercerIva", {|Self | Self, ( ::aPorcentajeIva[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nPorcentajeTercerIva", {|Self | Self, ( ::aPorcentajeIva[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER nTotalPrimerImpuestoHidrocarburos(); IIF( .F., s_oClass:ModInline( "nTotalPrimerImpuestoHidrocarburos", {|Self | Self, ( ::aTotalImpuestoHidrocarburos[ 1 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalPrimerImpuestoHidrocarburos", {|Self | Self, ( ::aTotalImpuestoHidrocarburos[ 1 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER nTotalSegundoImpuestoHidrocarburos(); IIF( .F., s_oClass:ModInline( "nTotalSegundoImpuestoHidrocarburos", {|Self | Self, ( ::aTotalImpuestoHidrocarburos[ 2 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalSegundoImpuestoHidrocarburos", {|Self | Self, ( ::aTotalImpuestoHidrocarburos[ 2 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER nTotalTercerImpuestoHidrocarburos(); IIF( .F., s_oClass:ModInline( "nTotalTercerImpuestoHidrocarburos", {|Self | Self, ( ::aTotalImpuestoHidrocarburos[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalTercerImpuestoHidrocarburos", {|Self | Self, ( ::aTotalImpuestoHidrocarburos[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER TotalImpuestoHidrocarburos(); IIF( .F., s_oClass:ModInline( "TotalImpuestoHidrocarburos", {|Self | Self, ( ::aTotalImpuestoHidrocarburos[ 1 ] + ::aTotalImpuestoHidrocarburos[ 2 ] + ::aTotalImpuestoHidrocarburos[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "TotalImpuestoHidrocarburos", {|Self | Self, ( ::aTotalImpuestoHidrocarburos[ 1 ] + ::aTotalImpuestoHidrocarburos[ 2 ] + ::aTotalImpuestoHidrocarburos[ 3 ] ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER TotalDescuento(); IIF( .F., s_oClass:ModInline( "TotalDescuento", {|Self | Self, ( ::nTotalDescuentoGeneral + ::nTotalDescuentoProntoPago + ::nTotalDescuentoUno + ::nTotalDescuentoDos ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "TotalDescuento", {|Self | Self, ( ::nTotalDescuentoGeneral + ::nTotalDescuentoProntoPago + ::nTotalDescuentoUno + ::nTotalDescuentoDos ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER TotalDocumento(); IIF( .F., s_oClass:ModInline( "TotalDocumento", {|Self | Self, ( Round( ::nTotalDocumento, ::nDecimalesRedondeo ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "TotalDocumento", {|Self | Self, ( Round( ::nTotalDocumento, ::nDecimalesRedondeo ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER TotalRentabilidad(); IIF( .F., s_oClass:ModInline( "TotalRentabilidad", {|Self | Self, ( Round( ::aTotalBase - ::nTotalCosto, ::nDecimalesRedondeo ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "TotalRentabilidad", {|Self | Self, ( Round( ::aTotalBase - ::nTotalCosto, ::nDecimalesRedondeo ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )
   _HB_MEMBER PorcentajeRentabilidad(); IIF( .F., s_oClass:ModInline( "PorcentajeRentabilidad", {|Self | Self, ( nRentabilidad( ::aTotalBase, 0, ::nTotalCosto ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "PorcentajeRentabilidad", {|Self | Self, ( nRentabilidad( ::aTotalBase, 0, ::nTotalCosto ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

   _HB_MEMBER nTotalCobro(); IIF( .F., s_oClass:ModInline( "nTotalCobro", {|Self | Self, ( Round( ::nCobrado - ::nCambio, ::nDecimalesRedondeo ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddInline( "nTotalCobro", {|Self | Self, ( Round( ::nCobrado - ::nCambio, ::nDecimalesRedondeo ) ) }, nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ) )

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS sTotal ;






Static Function FacCliExcelImport()

   local n
   local sBancasImportacion
   local cCodigoCliente
   local nVentaBruta
   local nComision
   local nVentaNeta
   local nBeneficio
   local oOleExcel
   local cFileExcel                    := cGetFile( "Excel ( *.Xls ) | *.xls |Excel ( *.Xlsx ) | *.xlsx", "Seleccione la hoja de calculo" )

   if File( cFileExcel )

      oOleExcel                        := TOleExcel():New( "Importando hoja de excel", "Conectando...", .F. )

      oOleExcel:oExcel:Visible         := .T.
      oOleExcel:oExcel:DisplayAlerts   := .F.
      oOleExcel:oExcel:WorkBooks:Open( cFileExcel )
      oOleExcel:oExcel:WorkSheets( 1 ):Activate()

      for n := 1 to 65536

         sBancasImportacion                     := sBancasImportacion()

         sBancasImportacion:cCodigoCliente      := oOleExcel:oExcel:ActiveSheet:Range( "A" + lTrim( Str( n ) ) ):Value
         if !Empty( sBancasImportacion:cCodigoCliente )

            sBancasImportacion:cCodigoCliente   := Left( sBancasImportacion:cCodigoCliente, 3 )
            sBancasImportacion:cCodigoCliente   := Rjust( sBancasImportacion:cCodigoCliente, "0", RetNumCodCliEmp() )

            sBancasImportacion:nVentaBruta      := oOleExcel:oExcel:ActiveSheet:Range( "D" + lTrim( Str( n ) ) ):Value
            sBancasImportacion:nComision        := oOleExcel:oExcel:ActiveSheet:Range( "E" + lTrim( Str( n ) ) ):Value
            sBancasImportacion:nVentaNeta       := oOleExcel:oExcel:ActiveSheet:Range( "F" + lTrim( Str( n ) ) ):Value
            sBancasImportacion:nBeneficio       := oOleExcel:oExcel:ActiveSheet:Range( "L" + lTrim( Str( n ) ) ):Value
            sBancasImportacion:nPremios         := oOleExcel:oExcel:ActiveSheet:Range( "K" + lTrim( Str( n ) ) ):Value
            sBancasImportacion:nPorcentaje      := Round( sBancasImportacion:nComision / sBancasImportacion:nVentaBruta * 100, 0 )

            WinAppRec( oWndBrw:oBrw, bEdtRec, dbfFacCliT, , , sBancasImportacion )

         else

            exit

         end

      next

      msgStop( "Proceso de importación finalizazo." )

      oOleExcel:oExcel:Quit()

      oOleExcel:oExcel:DisplayAlerts := .T.

      oOleExcel:End()

   end

Return nil



Static Function FacCliExcelNovotecno()

   local oDlg
   local oBmp
   local aFichero
   local oBtnCancel
   local oBrwFichero
   local oTreeImportacion
   local oMeterImportacion
   local nMeterInformacion                := 0

   aFichero                               := {}

   oDlg = TDialog():New(,,,,, "ImpNovotecno",, .F.,,,,,, .F.,,,,,, .F., )





      oBmp := TBitmap():ReDefine( 500, "Novotecno_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )





      oBrwFichero                         := TXBrowse():New( oDlg )

      oBrwFichero:bClrSel                 := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwFichero:bClrSelFocus            := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwFichero:SetArray( aFichero, , , .F. )

      oBrwFichero:nMarqueeStyle           := 5

      oBrwFichero:lHScroll                := .F.

      oBrwFichero:CreateFromResource( 220 )

      oBrwFichero:bLDblClick              := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( aFichero[ oBrwFichero:nArrayAt ] ) ) }

      with object ( oBrwFichero:AddCol() )
         :cHeader          := "Fichero"
         :bEditValue       := {|| aFichero[ oBrwFichero:nArrayAt ] }
         :nWidth           := 460
      end




      TButton():ReDefine( 200, {||( AddFichero( aFichero, oBrwFichero ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 210, {||( DelFichero( aFichero, oBrwFichero ) )}, oDlg,,, .F.,,,, .F. )





      oTreeImportacion                    := TTreeView():Redefine( 300, oDlg )





      oMeterImportacion := TMeter():ReDefine( 310, { | u | If( PCount()==0, nMeterInformacion, nMeterInformacion:= u ) },, oDlg, .F.,,, .T.,,,, )




      TButton():ReDefine( 1, {||( ExecuteImportacion( aFichero, oTreeImportacion, oMeterImportacion, oBtnCancel, oDlg ) )}, oDlg,,, .F.,,,, .F. )





      oBtnCancel := TButton():ReDefine( 2, {||( lCancelImportacion := .T., oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:AddFastKey( 116, {|| ExecuteImportacion( aFichero, oTreeImportacion, oMeterImportacion, oBtnCancel, oDlg ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   oTreeImportacion:Destroy()

   oBmp:End()

Return nil



static function AddFichero( aFichero, oBrwFichero )

   local i
   local cFile
   local aFile
   local nFlag    := nOr( 0x00000800, 0x00000008, 0x00000200, 0x00080000, 0x00200000 )

   cFile          := cGetFile( "Excel ( *.Xlsx ) | *.xlsx|Excel ( *.Xls ) | *.xls", "Seleccione la hoja de calculo", "*.*" , , .F., .T., nFlag )
   cFile          := Left( cFile, At( Chr( 0 ) + Chr( 0 ), cFile ) - 1 )

   if !Empty( cFile )

      cFile       := StrTran( cFile, Chr( 0 ), "," )
      aFile       := hb_aTokens( cFile, "," )

      if Len( aFile ) > 1

         for i := 2 to Len( aFile )
            aFile[ i ] := aFile[ 1 ] + "\" + aFile[ i ]
         next

         aDel( aFile, 1, .T. )

      endif

      if IsArray( aFile )

         for i := 1 to Len( aFile )
            aAdd( aFichero, aFile[ i ] )
         next

      else

         aAdd( aFichero, aFile )

      endif

   end

   oBrwFichero:Refresh()

return nil



Static Function DelFichero( aFichero, oBrwFichero )

   aDel( aFichero, oBrwFichero:nArrayAt, .T. )

   oBrwFichero:Refresh()

return nil



_HB_CLASS sBancasImportacion ; UTILITY FUNCTION sBancasImportacion(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "sBancasImportacion" , { HBObject():Classh } ) ) ;

   _HB_MEMBER { nVentaBruta} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nVentaBruta" }, .F., .F. ), )
   _HB_MEMBER { nComision} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nComision" }, .F., .F. ), )
   _HB_MEMBER { nVentaNeta} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nVentaNeta" }, .F., .F. ), )
   _HB_MEMBER { nBeneficio} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nBeneficio" }, .F., .F. ), )
   _HB_MEMBER { nPorcentaje} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nPorcentaje" }, .F., .F. ), )
   _HB_MEMBER { nPremios} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nPremios" }, .F., .F. ), )

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS sBancasImportacion ;



_HB_CLASS sNovotecnoImportacion ; UTILITY FUNCTION sNovotecnoImportacion(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "sNovotecnoImportacion" , { HBObject():Classh } ) ) ;

   _HB_MEMBER { cCodigoCliente} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cCodigoCliente" }, .F., .F. ), )
   _HB_MEMBER { dFecha} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "dFecha" }, .F., .F. ), )
   _HB_MEMBER { cHora} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cHora" }, .F., .F. ), )
   _HB_MEMBER { cCodigoArticulo} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cCodigoArticulo" }, .F., .F. ), )
   _HB_MEMBER { cNombreArticulo} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cNombreArticulo" }, .F., .F. ), )
   _HB_MEMBER { nNumeroOperacion} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nNumeroOperacion" }, .F., .F. ), )

   _HB_MEMBER { nImporteClaro} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nImporteClaro" }, .F., .F. ), )
   _HB_MEMBER { nImporteOrange} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nImporteOrange" }, .F., .F. ), )
   _HB_MEMBER { nImporteViva} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nImporteViva" }, .F., .F. ), )
   _HB_MEMBER { nImporteMount} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nImporteMount" }, .F., .F. ), )
   _HB_MEMBER { nImporteTricom} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nImporteTricom" }, .F., .F. ), )
   _HB_MEMBER { nImporteLoterias} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nImporteLoterias" }, .F., .F. ), )

   _HB_MEMBER { cTipo} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cTipo" }, .F., .F. ), )
   _HB_MEMBER { lValid} ; IIF( !.F., s_oClass:AddMultiData(, .T., nScope + IIF( .F., 32, 0 ), { "lValid" }, .F., .F. ), )
   _HB_MEMBER { nPrecio} ; IIF( !.F., s_oClass:AddMultiData(, 0, nScope + IIF( .F., 32, 0 ), { "nPrecio" }, .F., .F. ), )

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS sNovotecnoImportacion ;



Static Function ExecuteImportacion( aFichero, oTreeImportacion, oMeterImportacion, oBtnCancel, oDlg )

   local n
   local oNode
   local oError
   local oBlock
   local oError2
   local oBlock2
   local cFichero
   local oOleExcel
   local oActiveSheet
   local nActiveSheetRows
   local nActiveSheetColumns
   local sNovotecnoImportacion

   oDlg:Disable()
   oBtnCancel:Enable()

   aImportacion                           := {}
   lCancelImportacion                     := .F.

   for each cFichero in aFichero

      oBlock                              := ErrorBlock( { | oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

         oTreeImportacion:Select( oTreeImportacion:Add( "Importando hoja de excel " + cFichero ) )

         oOleExcel                        := TOleExcel():New( "Importando hoja de excel", "Conectando...", .F. )

         oOleExcel:oExcel:Visible         := .F.
         oOleExcel:oExcel:DisplayAlerts   := .F.

         oOleExcel:oExcel:Workbooks:Add()
         oOleExcel:oExcel:Workbooks:Open( cFichero )

         oActiveSheet                     := oOleExcel:oExcel:ActiveSheet

         nActiveSheetRows                 := oActiveSheet:UsedRange:Rows:Count()
         nActiveSheetColumns              := oActiveSheet:UsedRange:Columns:Count()

         oMeterImportacion:SetTotal( nActiveSheetRows )

         for n := 2 to ( nActiveSheetRows - 1 )

            oBlock2                                         := ErrorBlock( { | oError2 | Break( oError2 ) } )
            BEGIN SEQUENCE

            if !lCancelImportacion

               sNovotecnoImportacion                        := sNovotecnoImportacion()



               oNode                                        := oTreeImportacion:Add( "Procesando operación " + lTrim( Str( n ) ) )
               oTreeImportacion:Select( oNode )

               sNovotecnoImportacion:cCodigoCliente         := oOleExcel:oExcel:ActiveSheet:Range( "A" + lTrim( Str( n ) ) ):Value

               if !Empty( sNovotecnoImportacion:cCodigoCliente )

                  if IsNum( sNovotecnoImportacion:cCodigoCliente )
                     sNovotecnoImportacion:cCodigoCliente   := Round( sNovotecnoImportacion:cCodigoCliente, 0 )
                     sNovotecnoImportacion:cCodigoCliente   := Str( sNovotecnoImportacion:cCodigoCliente )
                     sNovotecnoImportacion:cCodigoCliente   := Alltrim( sNovotecnoImportacion:cCodigoCliente )
                  end

                  if dbSeekInOrd( sNovotecnoImportacion:cCodigoCliente, "cCodPos", dbfObrasT )
                     sNovotecnoImportacion:cCodigoCliente   := ( dbfObrasT )->cCodCli
                  else
                     sNovotecnoImportacion:cCodigoCliente   := Rjust( sNovotecnoImportacion:cCodigoCliente, "0", RetNumCodCliEmp() )
                  end

                  sNovotecnoImportacion:dFecha              := Date()
                  sNovotecnoImportacion:cHora               := Time()

                  sNovotecnoImportacion:nImporteClaro       := oOleExcel:oExcel:ActiveSheet:Range( "B" + lTrim( Str( n ) ) ):Value
                  sNovotecnoImportacion:nImporteOrange      := oOleExcel:oExcel:ActiveSheet:Range( "C" + lTrim( Str( n ) ) ):Value
                  sNovotecnoImportacion:nImporteViva        := oOleExcel:oExcel:ActiveSheet:Range( "D" + lTrim( Str( n ) ) ):Value
                  sNovotecnoImportacion:nImporteMount       := oOleExcel:oExcel:ActiveSheet:Range( "E" + lTrim( Str( n ) ) ):Value
                  sNovotecnoImportacion:nImporteTricom      := oOleExcel:oExcel:ActiveSheet:Range( "F" + lTrim( Str( n ) ) ):Value
                  sNovotecnoImportacion:nImporteLoterias    := oOleExcel:oExcel:ActiveSheet:Range( "G" + lTrim( Str( n ) ) ):Value

                  sNovotecnoImportacion:lValid              := .T.

                  oTreeImportacion:Select( oNode:Add( "Cliente " + sNovotecnoImportacion:cCodigoCliente ) )
                  oTreeImportacion:Select( oNode:Add( "Fecha " + Dtoc( sNovotecnoImportacion:dFecha ) ) )
                  oTreeImportacion:Select( oNode:Add( "Hora " + sNovotecnoImportacion:cHora ) )
                  oTreeImportacion:Select( oNode:Add( "Precio Claro " + Alltrim( cValToChar( sNovotecnoImportacion:nImporteClaro ) ) ) )

                  if sNovotecnoImportacion:lValid
                     aAdd( aImportacion, sNovotecnoImportacion )
                  end

               end

            end

            RECOVER USING oError2

               msgStop( ErrorMessage( oError2 ), "Error al importar facturas" )

            end

            ErrorBlock( oBlock2 )

            oMeterImportacion:Set( n )

         next

         oOleExcel:oExcel:Quit()
         oOleExcel:oExcel:DisplayAlerts   := .T.

      RECOVER USING oError

         msgStop( ErrorMessage( oError ), "Error al importar facturas" )

      end

      ErrorBlock( oBlock )

      if !Empty( oOleExcel )
         oOleExcel:End()
      end

      if lCancelImportacion
         oTreeImportacion:Select( oTreeImportacion:Add( "Proceso cancelado por el usuario" ) )
      end

   next

   if !lCancelImportacion .AND. !Empty( aImportacion )
      FacturaImportacion( oTreeImportacion )
   end

   oDlg:Enable()

return nil



static function FacturaImportacion( oTreeImportacion )

   local s
   local aTotalFactura
   local cCodigoCambio
   local cSerieFactura
   local nNumeroFactura
   local cSufijoFactura
   local nNumeroLinea                  := 1
   local lAppendFactura                := .F.

   aSort( aImportacion, , , {|x,y| x:cCodigoCliente > y:cCodigoCliente } )

   for each s in aImportacion





      nNumeroLinea                     := 1
      lAppendFactura                   := .F.





      if dbSeekInOrd( s:cCodigoCliente, "Cod", dbfClient )

         cSerieFactura                 := if( !Empty( ( dbfClient )->Serie ), ( dbfClient )->Serie, "A" )
         nNumeroFactura                := nNewDoc( cSerieFactura, dbfFacCliT, "nFacCli", , dbfCount )
         cSufijoFactura                := RetSufEmp()

         ( dbfFacCliT )->( dbAppend() )
         if !( dbfFacCliT )->( NetErr() )

            ( dbfFacCliT )->cSerie     := cSerieFactura
            ( dbfFacCliT )->nNumFac    := nNumeroFactura
            ( dbfFacCliT )->cSufFac    := cSufijoFactura

            ( dbfFacCliT )->cCodCli    := ( dbfClient )->Cod
            ( dbfFacCliT )->cNomCli    := ( dbfClient )->Titulo
            ( dbfFacCliT )->cDirCli    := ( dbfClient )->Domicilio
            ( dbfFacCliT )->cPobCli    := ( dbfClient )->Poblacion
            ( dbfFacCliT )->cPrvCli    := ( dbfClient )->Provincia
            ( dbfFacCliT )->cPosCli    := ( dbfClient )->CodPostal
            ( dbfFacCliT )->cDniCli    := ( dbfClient )->Nif

            ( dbfFacCliT )->cCodPago   := if( !Empty( ( dbfClient )->CodPago ), ( dbfClient )->CodPago, cDefFpg() )
            ( dbfFacCliT )->nTarifa    := Max( ( dbfClient )->nTarifa, 1 )
            ( dbfFacCliT )->dFecFac    := s:dFecha
            ( dbfFacCliT )->cTurFac    := cCurSesion()
            ( dbfFacCliT )->cCodAlm    := oUser():cAlmacen()
            ( dbfFacCliT )->cCodUsr    := cCurUsr()
            ( dbfFacCliT )->dFecCre    := Date()
            ( dbfFacCliT )->cTimCre    := Time()
            ( dbfFacCliT )->cCodDlg    := RetFld( cCurUsr(), dbfUsr, "cCodDlg" )
            ( dbfFacCliT )->cCodCaj    := oUser():cCaja()

            lAppendFactura             := .T.

            oTreeImportacion:Select( oTreeImportacion:Add( "Nueva factura creada " + ( dbfFacCliT )->cSerie + "/" + Alltrim( Str( ( dbfFacCliT )->nNumFac ) ) + "/" + Alltrim( ( dbfFacCliT )->cSufFac ) ) )

         end

      else

         oTreeImportacion:Add( "Cliente no encontrado " + s:cCodigoCliente )

      end

      if lAppendFactura

         if s:nImporteClaro <> 0

            ( dbfFacCliL )->( dbAppend() )
            if !( dbfFacCliL )->( NetErr() )

               ( dbfFacCliL )->nNumLin    := nNumeroLinea++
               ( dbfFacCliL )->cSerie     := cSerieFactura
               ( dbfFacCliL )->nNumFac    := nNumeroFactura
               ( dbfFacCliL )->cSufFac    := cSufijoFactura
               ( dbfFacCliL )->cRef       := "CLARO"
               ( dbfFacCliL )->cDetalle   := "CLARO"
               ( dbfFacCliL )->nUniCaja   := 1
               ( dbfFacCliL )->nPreUnit   := s:nImporteClaro
               ( dbfFacCliL )->cAlmLin    := oUser():cAlmacen()

            end

         end

         if s:nImporteOrange <> 0

            ( dbfFacCliL )->( dbAppend() )
            if !( dbfFacCliL )->( NetErr() )

               ( dbfFacCliL )->nNumLin    := nNumeroLinea++
               ( dbfFacCliL )->cSerie     := cSerieFactura
               ( dbfFacCliL )->nNumFac    := nNumeroFactura
               ( dbfFacCliL )->cSufFac    := cSufijoFactura
               ( dbfFacCliL )->cRef       := "ORANGE"
               ( dbfFacCliL )->cDetalle   := "ORANGE"
               ( dbfFacCliL )->nUniCaja   := 1
               ( dbfFacCliL )->nPreUnit   := s:nImporteOrange
               ( dbfFacCliL )->cAlmLin    := oUser():cAlmacen()

            end

         end

         if s:nImporteViva <> 0

            ( dbfFacCliL )->( dbAppend() )
            if !( dbfFacCliL )->( NetErr() )

               ( dbfFacCliL )->nNumLin    := nNumeroLinea++
               ( dbfFacCliL )->cSerie     := cSerieFactura
               ( dbfFacCliL )->nNumFac    := nNumeroFactura
               ( dbfFacCliL )->cSufFac    := cSufijoFactura
               ( dbfFacCliL )->cRef       := "VIVA"
               ( dbfFacCliL )->cDetalle   := "VIVA"
               ( dbfFacCliL )->nUniCaja   := 1
               ( dbfFacCliL )->nPreUnit   := s:nImporteViva
               ( dbfFacCliL )->cAlmLin    := oUser():cAlmacen()

            end

         end

         if s:nImporteTricom <> 0

            ( dbfFacCliL )->( dbAppend() )
            if !( dbfFacCliL )->( NetErr() )

               ( dbfFacCliL )->nNumLin    := nNumeroLinea++
               ( dbfFacCliL )->cSerie     := cSerieFactura
               ( dbfFacCliL )->nNumFac    := nNumeroFactura
               ( dbfFacCliL )->cSufFac    := cSufijoFactura
               ( dbfFacCliL )->cRef       := "TRICOM"
               ( dbfFacCliL )->cDetalle   := "TRICOM"
               ( dbfFacCliL )->nUniCaja   := 1
               ( dbfFacCliL )->nPreUnit   := s:nImporteTricom
               ( dbfFacCliL )->cAlmLin    := oUser():cAlmacen()

            end

         end

         if s:nImporteLoterias <> 0

            ( dbfFacCliL )->( dbAppend() )
            if !( dbfFacCliL )->( NetErr() )

               ( dbfFacCliL )->nNumLin    := nNumeroLinea++
               ( dbfFacCliL )->cSerie     := cSerieFactura
               ( dbfFacCliL )->nNumFac    := nNumeroFactura
               ( dbfFacCliL )->cSufFac    := cSufijoFactura
               ( dbfFacCliL )->cRef       := "LOTERIAS"
               ( dbfFacCliL )->cDetalle   := "LOTERIAS"
               ( dbfFacCliL )->nUniCaja   := 1
               ( dbfFacCliL )->nPreUnit   := s:nImporteLoterias
               ( dbfFacCliL )->cAlmLin    := oUser():cAlmacen()

            end

         end

      end

      if lAppendFactura .AND. !Empty( cSerieFactura ) .AND. !Empty( nNumeroFactura )
         GeneraCobrosImportacion( cSerieFactura, nNumeroFactura, cSufijoFactura )
      end

   next

   oTreeImportacion:Select( oTreeImportacion:Add( "Proceso de importación finalizado" ) )

return nil



static function GeneraCobrosImportacion( cSerieFactura, nNumeroFactura, cSufijoFactura )

   local aTotalFactura





   GenPgoFacCli( cSerieFactura + Str( nNumeroFactura ) + cSufijoFactura, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfAntCliT, dbfClient, dbfFPago, dbfDiv, dbfIva )

   ChkLqdFacCli( , dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfAntCliT, dbfIva, dbfDiv, .F. )





   aTotalFactura                 := aTotFacCli( cSerieFactura + Str( nNumeroFactura ) + cSufijoFactura, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT, ( dbfFacCliT )->cDivFac )

   if dbLock( dbfFacCliT )

      ( dbfFacCliT )->nTotNet    := aTotalFactura[ 1 ]
      ( dbfFacCliT )->nTotIva    := aTotalFactura[ 2 ]
      ( dbfFacCliT )->nTotReq    := aTotalFactura[ 3 ]
      ( dbfFacCliT )->nTotFac    := aTotalFactura[ 4 ]

      ( dbfFacCliT )->( dbUnLock() )

   end

return nil



static function lBuscaOferta( cCodArt, aGet, aTmp, aTmpFac, dbfOferta, dbfArticulo, dbfDiv, dbfKit, dbfIva  )

   local sOfeArt
   local nTotalLinea    := 0


   if ( dbfArticulo )->Codigo == cCodArt .OR. ( dbfArticulo )->( dbSeek( cCodArt ) )





      nTotalLinea       := lCalcDeta( aTmp, aTmpFac, .T. )

      sOfeArt           := sOfertaArticulo( cCodArt, aTmpFac[ 6 ], aTmpFac[ 82 ], aTmp[ 19 ], aTmpFac[ 5 ], dbfOferta, aTmp[ 77 ], , aTmp[28], aTmp[29], aTmp[30], aTmp[31], aTmp[ 60 ], dbfArticulo, dbfDiv, dbfKit, dbfIva, aTmp[ 12 ], nTotalLinea )

      if !Empty( sOfeArt ) .AND. sOfeArt:nPrecio <> 0

         aGet[ 6 ]:cText( sOfeArt:nPrecio )
         aGet[ 9     ]:cText( sOfeArt:nDtoPorcentual )
         aGet[ 33  ]:cText( sOfeArt:nDtoLineal )

         aTmp[ 82  ]  := .T.

      end

      if !aTmp[ 82 ]





         sOfeArt        := sOfertaFamilia( ( dbfArticulo )->Familia, aTmpFac[ 6 ], aTmpFac[ 82 ], aTmpFac[ 5 ], dbfOferta, aTmp[ 77 ], dbfArticulo, aTmp[ 19 ], aTmp[ 12 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 9 ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 33 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 82 ]  := .T.
         end

      end

      if !aTmp[ 82 ]





         sOfeArt     := sOfertaTipoArticulo( ( dbfArticulo )->cCodTip, aTmpFac[ 6 ], aTmpFac[ 82 ], aTmpFac[ 5 ], dbfOferta, aTmp[ 77 ], dbfArticulo, aTmp[ 19 ], aTmp[ 12 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 33 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 82 ]  := .T.
         end

      end

      if !aTmp[ 82 ]





         sOfeArt     := sOfertaCategoria( ( dbfArticulo )->cCodCate, aTmpFac[ 6 ], aTmpFac[ 82 ], aTmpFac[ 5 ], dbfOferta, aTmp[ 77 ], dbfArticulo, aTmp[ 19 ], aTmp[ 12 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 33 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 82 ]  := .T.
         end

      end

      if !aTmp[ 82 ]





         sOfeArt     := sOfertaTemporada( ( dbfArticulo )->cCodTemp, aTmpFac[ 6 ], aTmpFac[ 82 ], aTmp[ 5 ], dbfOferta, aTmp[ 77 ], dbfArticulo, aTmp[ 19 ], aTmp[ 12 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 9 ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 33 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 82 ]  := .T.
         end

      end

      if !aTmp[ 82 ]





         sOfeArt     := sOfertaFabricante( ( dbfArticulo )->cCodFab, aTmpFac[ 6 ], aTmpFac[ 82 ], aTmpFac[ 5 ], dbfOferta, aTmp[ 77 ], dbfArticulo, aTmp[ 19 ], aTmp[ 12 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 33 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 82 ]  := .T.
         end

      end

   end

return .T.



Static Function lValidLote( aTmp, aGet, oStkAct )

   if !uFieldEmpresa( "lNStkAct" )
      oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 39 ], aTmp[ 30 ], aTmp[ 31 ], aTmp[ 45 ], aTmp[ 47 ], aTmp[ 36 ], oStkAct )
   end

Return ( .T. )



Static Function EditarNumeroSerie( aTmp, oStock, nMode )

   local oNumerosSeries

   with object ( TNumerosSerie() )

      :nMode            := nMode

      :cCodArt          := aTmp[ 4    ]
      :cCodAlm          := aTmp[ 39 ]
      :nNumLin          := aTmp[ 35 ]

      :nTotalUnidades   := nTotNFacCli( aTmp )

      :oStock           := oStock

      :uTmpSer          := dbfTmpSer

      :Resource()

   end

Return ( nil )






Function lRectificadaCli( cNumFac, cFacCliT, cFacRecT )

   local lRectificada   := .F.

   IIF( cFacCliT == nil, cFacCliT := dbfFacCliT, ) ;
   IIF( cFacRecT == nil, cFacRecT := dbfFacRecT, ) ;
   IIF( cNumFac == nil, cNumFac := ( cFacCliT )->cSerie + Str( ( cFacCliT )->nNumFac ) + ( cFacCliT )->cSufFac, ) ;

   if dbSeekInOrd( cNumFac, "CNUMFAC", cFacRecT )
      lRectificada      := .T.
   end

return ( lRectificada )
