#line 112 "hbclass.ch"
   DYNAMIC DivertConstructorCall
















DECLARE HBClass  New( cName AS String, OPTIONAL SuperParams ) AS CLASS HBClass  Create() AS Object  Instance() AS Object  AddClsMethod( cName AS String, @MethodName(), nScope AS Numeric, n2 AS Numeric, n3 AS Numeric )  AddDelegate( cName AS String, cDelegate AS String, cObject AS String, nScope AS Numeric, lPersistent AS LOGICAL )  AddMultiClsData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String )  AddMultiData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String, x AS LOGICAL, lPer AS LOGICAL )  AddMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  AddInLine( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  AddVirtual( cName AS String )  ModMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  ModClsMethod( cName AS String, @MethodName(), nScope AS Numeric )  ModInline( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  SetOnError( @MethodName() )
#line 85 "\Fwh1204\Include\FiveWin.Ch"
   EXTERNAL GetProcAdd
   EXTERNAL TActiveX




extern errorsys
#line 216 ".\Prg\Precli.prg"
memvar cDbf
memvar cDbfCol
memvar cDetalle
memvar cCliente
memvar cDbfCli
memvar cDbfObr
memvar cDbfAge
memvar cAgente
memvar cDbfPgo
memvar cFPago
memvar cDbfIva
memvar cDbfUsr
memvar cIva
memvar cTarPreL
memvar cTarPreS
memvar cPromoL
memvar cDbfPromol
memvar cDbfRut
memvar cDbfTrn
memvar cDbfPro
memvar cDbfTblPro
memvar aTotIva
memvar aTotIvm
memvar cCtaCli
memvar nTotBrt
memvar nTotIva
memvar nTotReq
memvar nTotImp
memvar nTotPre
memvar nTotDto
memvar nTotDpp
memvar nTotUno
memvar nTotDos
memvar nTotNet
memvar nTotPnt
memvar nTotCos
memvar nTotIvm
memvar nTotPes
memvar nTotAge
memvar nTotTrn
memvar nTotRnt
memvar nTotDif
memvar nTotAtp
memvar nPctRnt
memvar aIvaUno
memvar aIvaDos
memvar aIvaTre
memvar aIvmUno
memvar aIvmDos
memvar aIvmTre
memvar nTotUnd
memvar nTotPage
memvar aImpVto
memvar aDatVto
memvar cPicUndPre
memvar nVdvDivPre
memvar cPouDivPre
memvar cPorDivPre
memvar cPouChgPre
memvar nDouDivPre
memvar nRouDivPre
memvar nTotArt
memvar nTotCaj
memvar nPagina
memvar lEnd
memvar nTotalDto

memvar oReport

static oWndBrw
static oBrwIva
static dbfUsr
static dbfRuta
static dbfPreCliT
static dbfPreCliL
static dbfPreCliI
static dbfPreCliD
static dbfClient
static dbfCliInc
static dbfArtPrv
static dbfDiv
static dbfCajT
static dbfInci
static oBandera
static oNewImp
static dbfArticulo
static dbfCodebar
static dbfTarPreL
static dbfTarPreS
static dbfPromoT
static dbfPromoL
static dbfPromoC
static dbfTblCnv
static dbfIva
static dbfTmpLin
static dbfTmpInc
static dbfTmpDoc
static dbfKit
static dbfFPago
static dbfObrasT
static dbfAlm
static dbfAgent
static dbfFamilia
static dbfCliAtp
static dbfDoc
static dbfOferta
static dbfTVta
static dbfTblPro
static dbfPro
static dbfFlt
static dbfArtDiv
static dbfDelega
static dbfAgeCom
static dbfCount
static dbfEmp
static dbfPedPrvL
static dbfAlbPrvL
static dbfFacPrvL
static dbfRctPrvL
static dbfPedCliL
static dbfAlbCliL
static dbfFacCliL
static dbfFacRecL
static dbfTikCliL
static dbfAlbCliT
static dbfFacCliP
static dbfAntCliT
static dbfTikCliT
static dbfProLin
static dbfProMat
static dbfHisMov
static dbfSitua
static cTmpLin
static cTmpInc
static cTmpDoc
static oGetNet
static oGetTrn
static oGetIva
static oGetReq
static oGetAge
static oGetIvm
static oGetPnt
static oGetRnt
static oGetPes
static oGetDif
static oGetTotal
static oFont
static oMenu
static cPouDiv
static cPorDiv
static cPicUnd
static nDouDiv
static nRouDiv
static cPpvDiv
static nDpvDiv
static oTrans
static nVdvDiv
static oStock
static oTipArt
static oGrpFam
static oFraPub
static bEdtRec          := { | aTmp, aGet, dbfPreCliT, oBrw, bWhen, bValid, nMode | EdtRec( aTmp, aGet, dbfPreCliT, oBrw, bWhen, bValid, nMode ) }
static bEdtPda          := { | aTmp, aGet, dbfPreCliT, oBrw, bWhen, bValid, nMode | EdtPda( aTmp, aGet, dbfPreCliT, oBrw, bWhen, bValid, nMode ) }
static bEdtDet          := { | aTmp, aGet, dbfPreCliL, oBrw, bWhen, bValid, nMode, aTmpPre | EdtDet( aTmp, aGet, dbfPreCliL, oBrw, bWhen, bValid, nMode, aTmpPre ) }
static bDetPda          := { | aTmp, aGet, dbfPreCliL, oBrw, bWhen, bValid, nMode, aTmpPre | DetPda( aTmp, aGet, dbfPreCliL, oBrw, bWhen, bValid, nMode, aTmpPre ) }
static bEdtInc          := { | aTmp, aGet, dbfPreCliL, oBrw, bWhen, bValid, nMode, aTmpPre | EdtInc( aTmp, aGet, dbfPreCliI, oBrw, bWhen, bValid, nMode, aTmpPre ) }
static bEdtDoc          := { | aTmp, aGet, dbfPreCliD, oBrw, bWhen, bValid, nMode, aTmpPre | EdtDoc( aTmp, aGet, dbfPreCliD, oBrw, bWhen, bValid, nMode, aTmpPre ) }
static nNumArt          := 0
static nNumCaj          := 0
static cOldCodCli       := ""
static cOldCodArt       := ""
static cOldPrpArt       := ""
static cOldUndMed       := ""
static lOpenFiles       := .F.
static lExternal        := .F.
static aTipPre          := { "Venta", "Alquiler" }
static oTipPre
static oUndMedicion
static cFiltroUsuario   := ""

static nTarifaPrecio    := 0

static oComisionLinea
static nComisionLinea      := 0









FUNCTION GenPreCli( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local oInf
   local oDevice
   local nNumPre

   if ( dbfPreCliT )->( Lastrec() ) == 0
      return nil
   end

   nNumPre              := ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre

   IIF( nDevice == nil, nDevice := 1, ) ;
   IIF( cCaption == nil, cCaption := "Imprimiendo presupuesto", ) ;
   IIF( cCodDoc == nil, cCodDoc := cFormatoDocumento( ( dbfPreCliT )->cSerPre, "nPreCli", dbfCount ), ) ;
   IIF( nCopies == nil, nCopies := if( nCopiasDocumento( ( dbfPreCliT )->cSerPre, "nPreCli", dbfCount ) == 0, Max( Retfld( ( dbfPreCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( ( dbfPreCliT )->cSerPre, "nPreCli", dbfCount ) ), ) ;

   if Empty( cCodDoc )
      cCodDoc           := cFirstDoc( "RC", dbfDoc )
   end

   if !lExisteDocumento( cCodDoc, dbfDoc )
      return nil
   end





   if !Empty( oAuditor() )
      if nDevice == 1
         oAuditor():AddEvent( "Impreso presupuesto a clientes",    nNumPre, "08" )
      else
         oAuditor():AddEvent( "Previsualizado presupuesto a clientes",  nNumPre, "08" )
      end
   end





   if lVisualDocumento( cCodDoc, dbfDoc )

      PrintReportPreCli( nDevice, nCopies, cPrinter, dbfDoc )

   else





      nTotPreCli( nNumPre, dbfPreCliT, dbfPreCliL, dbfIva, dbfDiv, dbfFpago, nil, nil, .T. )





      ( dbfPreCliL )->( dbSeek( nNumPre ) )
      ( dbfClient  )->( dbSeek( ( dbfPreCliT )->CCODCLI ) )
      ( dbfAgent   )->( dbSeek( ( dbfPreCliT )->CCODAGE ) )
      ( dbfFPago   )->( dbSeek( ( dbfPreCliT )->CCODPGO ) )
      ( dbfRuta    )->( dbSeek( ( dbfPreCliT )->cCodRut ) )
      ( dbfObrasT  )->( dbSeek( ( dbfPreCliT )->CCODCLI + ( dbfPreCliT )->CCODOBR ) )

      oTrans:oDbf:Seek( ( dbfPreCliT )->cCodTrn )

      private cDbf         := dbfPreCliT
      private cDbfCol      := dbfPreCliL
      private cDetalle     := dbfPreCliL
      private cCliente     := dbfClient
      private cDbfCli      := dbfClient
      private cDbfObr      := dbfObrasT
      private cDbfAge      := dbfAgent
      private cAgente      := dbfAgent
      private cDbfPgo      := dbfFPago
      private cFPago       := dbfFPago
      private cDbfIva      := dbfIva
      private cIva         := dbfIva
      private cTarPreL     := dbfTarPreL
      private cTarPreS     := dbfTarPreS
      private cPromoL      := dbfPromoL
      private cDbfPromol   := dbfPromoL
      private cDbfRut      := dbfRuta
      private cDbfUsr      := dbfUsr
      private cDbfTrn      := oTrans:GetAlias()
      private cDbfPro      := dbfPro
      private cDbfTblPro   := dbfTblPro
      private nTotPage     := nTotLPreCli( dbfPreCliT, dbfPreCliL )
      private cPicUndPre   := cPicUnd
      private nVdvDivPre   := nVdvDiv
      private cPouDivPre   := cPouDiv
      private cPorDivPre   := cPorDiv
      private cPouChgPre   := cPouDiv( cDivChg(), dbfDiv )
      private nDouDivPre   := nDouDiv
      private nRouDivPre   := nRouDiv

      private nTotArt      := nNumArt
      private nTotCaj      := nNumCaj

      IIF( cCaption == nil, cCaption := "Imprimiendo presupuesto", ) ;
      IIF( cCodDoc == nil, cCodDoc := "RC1", ) ;

      if !Empty( cPrinter )
         oDevice              := TPrinter():New( cCaption, .F., .T., cPrinter )
         oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .F.,, oDevice, cCaption,,, )
      else
         oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .T.,,, cCaption,,, )
      end

      if !Empty( oInf ) .AND. oInf:lCreated

         private oReport      := oInf

         oInf:lAutoland       := .F.
         oInf:lFinish         := .F.
         oInf:lNoCancel       := .T.
         oInf:bSkip           := {|| PreCliReportSkipper( dbfPreCliT, dbfPreCliL ) }

         oInf:oDevice:lPrvModal  := .T.

         do case
            case nDevice == 1

               oInf:oDevice:SetCopies( nCopies )

               oInf:bPreview  := {| oDevice | PrintPreview( oDevice ) }

            case nDevice == 3

               oInf:bPreview  := {| oDevice | PrintPdf( oDevice ) }

         end

         SetMargin(  cCodDoc, oInf )
         PrintColum( cCodDoc, oInf )

      end

      RptEnd()

      if !Empty( oInf )




         oInf:Activate({||               ( !( dbfPreCliL )->lImpLin )}, {||             ( ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->nNumPre ) + ( dbfPreCliL )->cSufPre == nNumPre .AND. !( dbfPreCliL )->( Eof() ))},,,, {||        ePage( oInf, cCodDoc )},,,,,,,, )

         if nDevice == 1
            oInf:oDevice:end()
         end

      end

      oInf                 := nil

   end

   lChgImpDoc( dbfPreCliT )

RETURN NIL



Static Function PreCliReportSkipper( dbfPreCliT, dbfPreCliL )

   ( dbfPreCliL )->( dbSkip() )

   nTotPage              += nTotLPreCli( dbfPreCliT, dbfPreCliL )

Return nil



Static Function ePage( oInf, cCodDoc )

   private nPagina      := oInf:nPage
    private lEnd            := oInf:lFinish

   PrintItems( cCodDoc, oInf )

Return nil



STATIC FUNCTION OpenFiles( lExt )

   local oError
   local oBlock

   if lOpenFiles
      MsgStop( "Imposible abrir ficheros de presupuestos de clientes" )
      Return ( .F. )
   end

   IIF( lExt == nil, lExt := .F., ) ;

   lExternal            := lExt

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

      DisableAcceso()

      lOpenFiles        := .T.

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLIT.DBF" ), ( cCheckArea( "PRECLIT", @dbfPreCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLIL.DBF" ), ( cCheckArea( "PRECLIL", @dbfPreCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLII.DBF" ), ( cCheckArea( "PRECLII", @dbfPreCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLID.DBF" ), ( cCheckArea( "PRECLID", @dbfPreCliD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLID.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfClient ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CliInc.Dbf" ), ( cCheckArea( "CliInc", @dbfCliInc ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "CliInc.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROVART.DBF" ), ( cCheckArea( "PROVART", @dbfArtPrv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROVART.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "CliAtp.Dbf" ), ( cCheckArea( "CLIATP", @dbfCliAtp ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "CliAtp.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "AGENTES.DBF" ), ( cCheckArea( "AGENTES", @dbfAgent ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "AGENTES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ArtCodebar.Dbf" ), ( cCheckArea( "CODEBAR", @dbfCodebar ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ArtCodebar.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TARPREL.DBF" ), ( cCheckArea( "TARPREL", @dbfTarPreL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TARPREL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TARPRES.DBF" ), ( cCheckArea( "TARPRES", @dbfTarPreS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TARPRES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROMOT.DBF" ), ( cCheckArea( "PROMOT", @dbfPromoT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROMOT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROMOL.DBF" ), ( cCheckArea( "PROMOL", @dbfPromoL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROMOL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROMOC.DBF" ), ( cCheckArea( "PROMOC", @dbfPromoC ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROMOC.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatGrp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatGrp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RDOCUMEN.DBF" ), ( cCheckArea( "RDOCUMEN", @dbfDoc ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RDOCUMEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CTIPO" )

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "OFERTA.DBF" ), ( cCheckArea( "OFERTA", @dbfOferta ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "OFERTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTKIT.DBF" ), ( cCheckArea( "ARTTIK", @dbfKit ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTKIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TVTA.DBF" ), ( cCheckArea( "TVTA", @dbfTVta ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TVTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PRO.DBF" ), ( cCheckArea( "PRO", @dbfPro ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TBLPRO.DBF" ), ( cCheckArea( "TBLPRO", @dbfTblPro ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TBLPRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "ObrasT.Dbf" ), ( cCheckArea( "OBRAS", @dbfObrasT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "ObrasT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatCli() + "RUTA.DBF" ), ( cCheckArea( "RUTA", @dbfRuta ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatCli() + "RUTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTDIV.DBF" ), ( cCheckArea( "ARTDIV", @dbfArtDiv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTDIV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TBLCNV.DBF" ), ( cCheckArea( "TBLCNV", @dbfTblCnv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TBLCNV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "Cajas.Dbf" ), ( cCheckArea( "CAJAS", @dbfCajT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "Cajas.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatAlm() + "Almacen.Dbf" ), ( cCheckArea( "ALMACEN", @dbfAlm ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatAlm() + "Almacen.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "USERS.DBF" ), ( cCheckArea( "USERS", @dbfUsr ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "USERS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIPINCI.DBF" ), ( cCheckArea( "TIPINCI", @dbfInci ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIPINCI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DELEGA.DBF" ), ( cCheckArea( "DELEGA", @dbfDelega ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DELEGA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "CNFFLT.DBF" ), ( cCheckArea( "CNFFLT", @dbfFlt ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "CNFFLT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatGrp() + "AGECOM.DBF" ), ( cCheckArea( "AGECOM", @dbfAgeCom ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatGrp() + "AGECOM.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "NCOUNT.DBF" ), ( cCheckArea( "NCOUNT", @dbfCount ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "NCOUNT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "EMPRESA.DBF" ), ( cCheckArea( "EMPRESA", @dbfEmp ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "EMPRESA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PedProvL.DBF" ), ( cCheckArea( "PedProvL", @dbfPedPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PedProvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVL.DBF" ), ( cCheckArea( "ALBPROVL", @dbfAlbPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cStkFast" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @dbfFacPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "RctPrvL", @dbfRctPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PedCliL.DBF" ), ( cCheckArea( "PedCliL", @dbfPedCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PedCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIL.DBF" ), ( cCheckArea( "ALBCLIL", @dbfAlbCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cStkFast" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIL.DBF" ), ( cCheckArea( "FACCLIL", @dbfFacCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecL.DBF" ), ( cCheckArea( "FacRecL", @dbfFacRecL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKET.DBF" ), ( cCheckArea( "TIKET", @dbfTikCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKET.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKEL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CSTKFAST" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROLIN.DBF" ), ( cCheckArea( "PROLIN", @dbfProLin ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROLIN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMAT.DBF" ), ( cCheckArea( "PROMAT", @dbfProMat ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMAT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "HISMOV.DBF" ), ( cCheckArea( "HISMOV", @dbfHisMov ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "HISMOV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRefMov" )

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "SITUA.DBF" ), ( cCheckArea( "SITUA", @dbfSitua ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "SITUA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIT.DBF" ), ( cCheckArea( "ALBCLIT", @dbfAlbCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliP.Dbf" ), ( cCheckArea( "FacCliP", @dbfFacCliP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliP.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.Dbf" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      oBandera          := TBandera():New()

      oStock            := TStock():Create( cPatGrp() )
      if !oStock:lOpenFiles()
         lOpenFiles     := .F.
      else
         oStock:cKit       := dbfKit

         oStock:cPedPrvL   := dbfPedPrvL
         oStock:cAlbPrvL   := dbfAlbPrvL
         oStock:cFacPrvL   := dbfFacPrvL
         oStock:cRctPrvL   := dbfRctPrvL

         oStock:cPedCliL   := dbfPedCliL

         oStock:cAlbCliT   := dbfAlbCliT
         oStock:cAlbCliL   := dbfAlbCliL

         oStock:cFacCliL   := dbfFacCliL
         oStock:cFacCliP   := dbfFacCliP

         oStock:cFacRecL   := dbfFacRecL

         oStock:cAntCliT   := dbfAntCliT

         oStock:cTikT      := dbfTikCliT
         oStock:cTikL      := dbfTikCliL

         oStock:cProducL   := dbfProLin
         oStock:cProducM   := dbfProMat

         oStock:cHisMov    := dbfHisMov
      end

      oNewImp           := TNewImp():New( cPatEmp() )
      if !oNewImp:OpenFiles()
         lOpenFiles     := .F.
      end

      oTrans            := TTrans():New( cPatCli() )
      if !oTrans:OpenFiles()
         lOpenFiles     := .F.
      end

      oTipArt           := TTipArt():Create( cPatArt() )
      if !oTipArt:OpenFiles()
         lOpenFiles     := .F.
      end

      oGrpFam           := TGrpFam():Create( cPatArt() )
      if !oGrpFam:OpenFiles()
         lOpenFiles     := .F.
      end

      oFraPub           := TFrasesPublicitarias():Create( cPatArt() )
      if !oFraPub:OpenFiles()
         lOpenFiles     := .F.
      end



      oUndMedicion      := UniMedicion():Create( cPatGrp() )
      if !oUndMedicion:OpenFiles()
         lOpenFiles     := .F.
      end





      oFont             := TFont():New( "Arial", 8, 26, .F., .T. )





      public nTotPre    := 0
      public nTotDto    := 0
      public nTotDPP    := 0
      public nTotNet    := 0
      public nTotIvm    := 0
      public nTotIva    := 0
      public nTotReq    := 0
      public nTotAge    := 0
      public nTotUno    := 0
      public nTotDos    := 0
      public nTotPnt    := 0
      public nTotTrn    := 0
      public nTotCos    := 0
      public nTotAtp    := 0
      public nTotPes    := 0
      public nPctRnt    := 0
      public nTotRnt    := 0
      public nTotDif    := 0
      public nTotUnd    := 0

      public aTotIva    := { { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 } }
      public aIvaUno    := aTotIva[ 1 ]
      public aIvaDos    := aTotIva[ 2 ]
      public aIvaTre    := aTotIva[ 3 ]

      public aTotIvm    := { { 0,nil,0 }, { 0,nil,0 }, { 0,nil,0 }, }
      public aIvmUno    := aTotIvm[ 1 ]
      public aIvmDos    := aTotIvm[ 2 ]
      public aIvmTre    := aTotIvm[ 3 ]

      public aImpVto    := {}
      public aDatVto    := {}

      public nNumArt    := 0
      public nNumCaj    := 0





      if oUser():lFiltroVentas()
         cFiltroUsuario    := "Field->cCodUsr == '" + oUser():cCodigo() + "' .and. Field->cCodCaj == '" + oUser():cCaja() + "'"
      end

      EnableAcceso()

   RECOVER USING oError

      lOpenFiles     := .F.

      msgStop( "Imposible abrir todas las bases de datos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      EnableAcceso()

   end

   ErrorBlock( oBlock )

   if !lOpenFiles
      CloseFiles()
   end

RETURN ( lOpenFiles )



STATIC FUNCTION CloseFiles()

   DisableAcceso()

   DestroyFastFilter( dbfPreCliT, .T., .T. )

   if !Empty( oFont )
      oFont:end()
   end

   if ( dbfPreCliT ) <> nil
      ( dbfPreCliT )->( dbCloseArea() )
   end

   if !Empty( dbfPreCliL   )
      ( dbfPreCliL   )->( dbCloseArea() )
   end

   if !Empty( dbfPreCliI   )
      ( dbfPreCliI   )->( dbCloseArea() )
   end

   if !Empty( dbfPreCliD   )
      ( dbfPreCliD   )->( dbCloseArea() )
   end

   if !Empty( dbfClient )
      ( dbfClient    )->( dbCloseArea() )
   end

   if !Empty( dbfIva )
      ( dbfIva       )->( dbCloseArea() )
   end

   if !Empty( dbfTarPreL )
      ( dbfTarPreL   )->( dbCloseArea() )
   end

   if !Empty( dbfTarPreS )
      ( dbfTarPreS   )->( dbCloseArea() )
   end

   if !Empty( dbfPromoT )
      ( dbfPromoT    )->( dbCloseArea() )
   end

   if !Empty( dbfPromoL )
      ( dbfPromoL    )->( dbCloseArea() )
   end

   if !Empty( dbfPromoC )
      ( dbfPromoC    )->( dbCloseArea() )
   end

   if !Empty( dbfAgent )
      ( dbfAgent     )->( dbCloseArea() )
   end

   if !Empty( dbfArticulo )
      ( dbfArticulo  )->( dbCloseArea() )
   end

   if dbfCodebar <> nil
      ( dbfCodebar )->( dbCloseArea() )
   end

   if !Empty( dbfCliAtp )
      ( dbfCliAtp    )->( dbCloseArea() )
   end

   if !Empty( dbfFPago )
      ( dbfFPago     )->( dbCloseArea() )
   end

   if !Empty( dbfDiv )
      ( dbfDiv       )->( dbCloseArea() )
   end

   if !Empty( dbfDoc )
      ( dbfDoc       )->( dbCloseArea() )
   end

   if !Empty( dbfFamilia )
      ( dbfFamilia   )->( dbCloseArea() )
   end

   if !Empty( dbfOferta )
      ( dbfOferta    )->( dbCloseArea() )
   end

   if !Empty( dbfKit )
      ( dbfKit       )->( dbCloseArea() )
   end

   if !Empty( dbfTVta )
      ( dbfTVta      )->( dbCloseArea() )
   end

   if !Empty( dbfPro )
      ( dbfPro       )->( dbCloseArea() )
   end

   if !Empty( dbfTblPro )
      ( dbfTblPro    )->( dbCloseArea() )
   end

   if !Empty( dbfObrasT )
      ( dbfObrasT    )->( dbCloseArea() )
   end

   if !Empty( dbfRuta )
      ( dbfRuta      )->( dbCloseArea() )
   end

   if !Empty( dbfArtDiv )
      ( dbfArtDiv    )->( dbCloseArea() )
   end

   if !Empty( dbfTblCnv )
      ( dbfTblCnv    )->( dbCloseArea() )
   end

   if !Empty( dbfCajT )
      ( dbfCajT )->( dbCloseArea() )
   end

   if !Empty( dbfAlm )
      ( dbfAlm )->( dbCloseArea() )
   end

   if !Empty( dbfUsr )
      ( dbfUsr )->( dbCloseArea() )
   end

   if dbfInci <> nil
      ( dbfInci )->( dbCloseArea() )
   end

   if dbfArtPrv <> nil
      ( dbfArtPrv )->( dbCloseArea() )
   end

   if dbfDelega <> nil
      ( dbfDelega )->( dbCloseArea() )
   end

   if dbfAgeCom <> nil
      ( dbfAgeCom )->( dbCloseArea() )
   end

   if dbfFlt <> nil
      ( dbfFlt )->( dbCloseArea() )
   end

   if dbfCount <> nil
      ( dbfCount )->( dbCloseArea() )
   end

   if dbfEmp <> nil
      ( dbfEmp )->( dbCloseArea() )
   end

   if dbfPedPrvL <> nil
      ( dbfPedPrvL )->( dbCloseArea() )
   end

   if dbfAlbPrvL <> nil
      ( dbfAlbPrvL )->( dbCloseArea() )
   end

   if dbfFacPrvL <> nil
      ( dbfFacPrvL )->( dbCloseArea() )
   end

   if dbfRctPrvL <> nil
      ( dbfRctPrvL )->( dbCloseArea() )
   end

   if dbfPedCliL <> nil
      ( dbfPedCliL )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliT )
      ( dbfAlbCliT )->( dbCloseArea() )
   end

   if dbfAlbCliL <> nil
      ( dbfAlbCliL )->( dbCloseArea() )
   end

   if dbfFacCliL <> nil
      ( dbfFacCliL )->( dbCloseArea() )
   end

   if dbfFacRecL <> nil
      ( dbfFacRecL )->( dbCloseArea() )
   end

   if dbfTikCliT <> nil
      ( dbfTikCliT )->( dbCloseArea() )
   end

   if dbfTikCliL <> nil
      ( dbfTikCliL )->( dbCloseArea() )
   end

   if dbfProLin <> nil
      ( dbfProLin )->( dbCloseArea() )
   end

   if dbfProMat <> nil
      ( dbfProMat )->( dbCloseArea() )
   end

   if dbfHisMov <> nil
      ( dbfHisMov )->( dbCloseArea() )
   end

   if dbfCliInc <> nil
      ( dbfCliInc )->( dbCloseArea() )
   end

   if dbfSitua <> nil
      ( dbfSitua )->( dbCloseArea() )
   end

   if dbfFacCliP <> nil
      ( dbfFacCliP )->( dbCloseArea() )
   end

   if dbfAntCliT <> nil
      ( dbfAntCliT )->( dbCloseArea() )
   end

   if !Empty( oNewImp )
      oNewImp:End()
   end

   if !Empty( oTrans )
      oTrans:End()
   end

   if !Empty( oStock )
      oStock:end()
   end

   if !Empty( oTipArt )
      oTipArt:end()
   end

   if !Empty( oGrpFam )
      oGrpFam:end()
   end

   if !Empty( oUndMedicion )
      oUndMedicion:end()
   end

   if !Empty( oFraPub )
      oFraPub:end()
   end

   dbfPreCliT     := nil
   dbfPreCliL     := nil
   dbfPreCliI     := nil
   dbfPreCliD     := nil
   dbfClient      := nil
   dbfArtPrv      := nil
   dbfIva         := nil
   dbfTarPreL     := nil
   dbfTarPreS     := nil
   dbfPromoT      := nil
   dbfPromoL      := nil
   dbfPromoC      := nil
   dbfAgent       := nil
   dbfArticulo    := nil
   dbfCodebar     := nil
   dbfCliAtp      := nil
   dbfFpago       := nil
   dbfDiv         := nil
   dbfDoc         := nil
   dbfFamilia     := nil
   dbfOferta      := nil
   dbfKit         := nil
   dbfTVta        := nil
   dbfPro         := nil
   dbfTblPro      := nil
   dbfObrasT      := nil
   dbfRuta        := nil
   dbfArtDiv      := nil
   dbfTblCnv      := nil
   dbfCajT        := nil
   dbfUsr         := nil
   dbfDelega      := nil
   dbfCount       := nil
   oBandera       := nil
   oNewImp        := nil
   oTrans         := nil
   oStock         := nil
   oTipArt        := nil
   oGrpFam        := nil
   dbfInci        := nil
   dbfFlt         := nil
   dbfAgeCom      := nil
   dbfEmp         := nil

   dbfPedPrvL     := nil
   dbfAlbPrvL     := nil
   dbfFacPrvL     := nil
   dbfFacPrvL     := nil

   dbfPedCliL     := nil
   dbfAlbCliL     := nil
   dbfFacCliL     := nil
   dbfFacRecL     := nil
   dbfTikCliL     := nil

   dbfProLin      := nil
   dbfProMat      := nil
   dbfHisMov      := nil
   dbfCliInc      := nil

   lOpenFiles     := .F.

   oWndBrw        := nil

   EnableAcceso()

RETURN .T.



FUNCTION PreCli( oMenuItem, oWnd, cCodCli, cCodArt )

   local oSnd
   local oRpl
   local oImp
   local oPrv
   local oDel
   local oPdf
   local oMail
   local oDup
   local oBtnEur
   local nLevel
   local lEuro          := .F.
   local oRotor

   IIF( oMenuItem == nil, oMenuItem := "01055", ) ;
   IIF( oWnd == nil, oWnd := oWnd(), ) ;
   IIF( cCodCli == nil, cCodCli := "", ) ;
   IIF( cCodArt == nil, cCodArt := "", ) ;

   nLevel               := nLevelUsr( oMenuItem )
   if nAnd( nLevel, 1 ) <> 0
      msgStop( "Acceso no permitido." )
      return .F.
   end





   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

   if !OpenFiles()
      return .F.
   end





   DisableAcceso()



















   oWndBrw := TShell():New( 0, 0, 22, 80, "Presupuestos a clientes",, oWnd,,, .F.,,, ( dbfPreCliT ),,,,, {"Número", "Fecha", "Código", "Nombre", "Obra", "Agente"}, {||( WinAppRec( oWndBrw:oBrw, bEdtRec, dbfPreCliT, cCodCli, cCodArt ) )}, {||( WinEdtRec( oWndBrw:oBrw, bEdtRec, dbfPreCliT, cCodCli, cCodArt ) )}, {||( WinDelRec( oWndBrw:oBrw, dbfPreCliT, {|| QuiPreCli() } ) )}, {||( WinDupRec( oWndBrw:oBrw, bEdtRec, dbfPreCliT, cCodCli, cCodArt ) )}, nil, nLevel, "Notebook_user1_16", ( 104 + ( 0 * 256 ) + ( 63 * 65536 ) ),, {||( WinZooRec( oWndBrw:oBrw, bEdtRec, dbfPreCliT ) )}, .T. )

      oWndBrw:lFechado     := .T.

      oWndBrw:bChgIndex    := {|| if( oUser():lFiltroVentas(), CreateFastFilter( cFiltroUsuario, dbfPreCliT, .F., , cFiltroUsuario ), CreateFastFilter( "", dbfPreCliT, .F. ) ) }

      oWndBrw:SetYearComboBoxChange( {|| YearComboBoxChange() } )

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión cerrada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfPreCliT )->lCloPre }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Zoom16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Estado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfPreCliT )->lEstado }
         :nWidth           := 20
         :SetCheck( { "Bullet_Square_Green_16", "Bullet_Square_Red_16" } )
         :AddResource( "trafficlight_on_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfPreCliT )->lSndDoc }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Lbl16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Incidencia"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nEstadoIncidencia( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre ) }
         :nWidth           := 20
         :lHide            := .T.
         :AddResource( "Bullet_Square_Red_16" )
         :AddResource( "Bullet_Square_Yellow_16" )
         :AddResource( "Bullet_Square_Green_16" )
         :AddResource( "informacion_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Imprimir"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfPreCliT )->lImprimido }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "IMP16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Tipo"
         :bEditValue       := {|| aTipPre[ if( ( dbfPreCliT )->lAlquiler, 2, 1 ) ] }
         :nWidth           := 50
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumPre"
         :bEditValue       := {|| ( dbfPreCliT )->cSerPre + "/" + AllTrim( Str( ( dbfPreCliT )->nNumPre ) ) + "/" + ( dbfPreCliT )->cSufPre }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :bEditValue       := {|| ( dbfPreCliT )->cCodDlg }
         :nWidth           := 20
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión"
         :bEditValue       := {|| Trans( ( dbfPreCliT )->cTurPre, "######" ) }
         :nWidth           := 40
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecPre"
         :bEditValue       := {|| Dtoc( ( dbfPreCliT )->dFecPre ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( dbfPreCliT )->cCodCaj }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Usuario"
         :bEditValue       := {|| ( dbfPreCliT )->cCodUsr }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Situación"
         :bEditValue       := {|| AllTrim( ( dbfPreCliT )->cSituac ) }
         :nWidth           := 80
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| AllTrim( ( dbfPreCliT )->cCodCli ) }
         :nWidth           := 70
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| ( dbfPreCliT )->cNomCli }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Agente"
         :cSortOrder       := "cCodAge"
         :bEditValue       := {|| ( dbfPreCliT )->cCodAge }
         :nWidth           := 50
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Ruta"
         :bEditValue       := {|| ( dbfPreCliT )->cCodRut }
         :nWidth           := 40
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Almacén"
         :bEditValue       := {|| ( dbfPreCliT )->cCodAlm }
         :nWidth           := 60
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Obra"
         :cSortOrder       := "cCodObr"
         :bEditValue       := {|| ( dbfPreCliT )->cCodObr }
         :nWidth           := 50
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( dbfPreCliT )->nTotNet }
         :cEditPicture     := cPorDiv( ( dbfPreCliT )->cDivPre, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( dbfPreCliT )->nTotIva }
         :cEditPicture     := cPorDiv( ( dbfPreCliT )->cDivPre, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "R.E."
         :bEditValue       := {|| ( dbfPreCliT )->nTotReq }
         :cEditPicture     := cPorDiv( ( dbfPreCliT )->cDivPre, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( dbfPreCliT )->nTotPre }
         :cEditPicture     := cPorDiv( ( dbfPreCliT )->cDivPre, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( if( lEuro, cDivChg(), ( dbfPreCliT )->cDivPre ), dbfDiv ) }
         :nWidth           := 30
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      oWndBrw:CreateXFromCode()





   oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

   oWndBrw:AddSeaBar()







   oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )







   oDup := oWndBrw:NewAt( "DUP",,, {||( oWndBrw:RecDup() )}, "(D)uplicar", "D",, {|This|This:Toggle()}, 2,, .F. )







      oWndBrw:NewAt( "Dup",,, {||( DupSerie( oWndBrw ) )}, "Series",,,, 2, oDup, .F. )






   oWndBrw:NewAt( "EDIT",,, {||( oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )






   oWndBrw:NewAt( "ZOOM",,, {||( oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 8,, .F. )







   oDel := oWndBrw:NewAt( "DEL",,, {||( oWndBrw:RecDel() )}, "(E)liminar", "E",, {|This|This:Toggle()}, 16,, .F. )








   oPrv := oWndBrw:NewAt( "IMP",, "Imprimir pedidos", {||( GenPreCli( 1 ), oWndBrw:Refresh() )}, "(I)mprimir", "I",, {|This|This:Toggle()}, 32,, .F. )


      lGenPreCli( oWndBrw:oBrw, oPrv, 1 )





   oWndBrw:NewAt( "SERIE1",,, {||( PrnSerie( oWndBrw:oBrw ), oWndBrw:Refresh() )}, "Imp(r)imir series", "R",,, 32,, .F. )








   oImp := oWndBrw:NewAt( "PREV1",, "Previsualizar pedidos", {||( GenPreCli( 2 ), oWndBrw:Refresh() )}, "(P)revisualizar", "P",, {|This|This:Toggle()}, 32,, .F. )


      lGenPreCli( oWndBrw:oBrw, oImp, 2 )






   oPdf := oWndBrw:NewAt( "DOCLOCK",,, {||( GenPreCli( 3 ) )}, "Pd(f)", "F",, {|This|This:Toggle()}, 32,, .F. )


      lGenPreCli( oWndBrw:oBrw, oPdf, 3 )





   oMail := oWndBrw:NewAt( "Mail",,, {||( GenPreCli( 6 ) )}, "Correo electrónico",,, {|This|This:Toggle()}, 32,, .F. )


      lGenPreCli( oWndBrw:oBrw, oMail, 6 )
   if oUser():lAdministrador()






      oWndBrw:NewAt( "CHGSTATE",,, {||( ChgState( oWndBrw:oBrw ) )}, "Cambiar Es(t)ado", "T",,, 4,, .F. )

   end








   oSnd := oWndBrw:NewAt( "LBL",, "Seleccionar presupuestos para ser enviados", {||lSnd( oWndBrw, dbfPreCliT )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, dbfPreCliT, "lSndDoc", .T., .T., .T. ) )}, "Todos",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, dbfPreCliT, "lSndDoc", .F., .T., .T. ) )}, "Ninguno",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, dbfPreCliT, "lSndDoc", .T., .F., .T. ) )}, "Abajo",,,, 4, oSnd, .F. )






   oBtnEur := oWndBrw:NewAt( "BAL_EURO",,, {||( lEuro := !lEuro, oWndBrw:Refresh() )}, "M(o)neda", "O",,,,, .F. )
   if oUser():lAdministrador()






      oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( TDlgFlt():New( aItmPreCli(), dbfPreCliT ):ChgFields(), oWndBrw:Refresh() )}, "Cambiar campos",,, {|This|This:Toggle()}, 4,, .F. )







         oWndBrw:NewAt( "BMPCHG",,, {||( TDlgFlt():New( aColPreCli(), dbfPreCliL ):ChgFields(), oWndBrw:Refresh() )}, "Lineas",,,, 4, oRpl, .F. )

   end






   oWndBrw:NewAt( "INFO",,, {||( TTrazaDocumento():Activate( "08", ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre ) )}, "I(n)forme documento", "N",,, 4,, .F. )






   oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,, {|This|This:Toggle()},,, .F. )




      oWndBrw:NewAt( "USER1_",,, {||( EdtCli( ( dbfPreCliT )->cCodCli ) )}, "Modificar cliente",,,,, oRotor, .F. )




      oWndBrw:NewAt( "INFO",,, {||( InfCliente( ( dbfPreCliT )->cCodCli ) )}, "Informe de cliente",,,,, oRotor, .F. )




      oWndBrw:NewAt( "Worker",,, {||( if( !Empty( ( dbfPreCliT )->cCodObr ), EdtObras( ( dbfPreCliT )->cCodCli, ( dbfPreCliT )->cCodObr, dbfObrasT ), MsgStop( "No hay obra asociada al presupuesto" ) ) )}, "Modificar obra",,,,, oRotor, .F. )





      oWndBrw:NewAt( "CLIPBOARD_EMPTY_USER1_",,, {||( if( !( dbfPreCliT )->lEstado, PedCli( nil, nil, nil, nil, ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre ), MsgStop( "El presupuesto ya ha sido aceptado" ) ) )}, "Generar pedido",,,,, oRotor, .T. )




      oWndBrw:NewAt( "CLIPBOARD_EMPTY_USER1_",,, {||( Pre2Ped( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre ) )}, "Modificar pedido",,,,, oRotor, .F. )





      oWndBrw:NewAt( "DOCUMENT_USER1_",,, {||( if( !( dbfPreCliT )->lEstado, FactCli( nil, nil, nil, nil, nil, { ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre, nil, nil, nil } ), MsgStop( "El presupuesto ya ha sido aceptado" ) ) )}, "Generar factura",,,,, oRotor, .T. )





      oWndBrw:NewAt( "Note_",,, {||( PreCliNotas() )}, "Generar nota de agenda",,,,, oRotor, .T. )





      oWndBrw:NewAt( "CASHIER_USER1_",,, {||( if( !( dbfPreCliT )->lEstado .AND. Empty( ( dbfPreCliT )->cNumTik ), FrontTpv( nil, nil, nil, nil, .F., .F., { ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre, nil, nil } ), MsgStop( "Presupuesto aceptado o convertido a ticket" ) ) )}, "Convertir a ticket",,,,, oRotor, .T. )




   oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .F. )

   if !oUser():lFiltroVentas()
      oWndBrw:oActiveFilter:aTField       := aItmPreCli()
      oWndBrw:oActiveFilter:cDbfFilter    := dbfFlt
      oWndBrw:oActiveFilter:cTipFilter    := "08"
   end

   oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles() )},, oWndBrw:bLButtonUp )

   EnableAcceso()

   if !Empty( cCodCli ) .OR. !Empty( cCodArt )
      oWndBrw:RecAdd()
      cCodCli  := nil
      cCodArt  := nil
   end

Return .T.



STATIC FUNCTION EdtRec( aTmp, aGet, dbfPreCliT, oBrw, cCodCli, cCodArt, nMode )

   local oDlg
   local oFld
   local nOrd
   local oBrwLin
   local oBrwInc
   local oBrwDoc
   local oSay           := Array( 11 )
   local cSay           := Array( 11 )
   local oSayLabels     := Array( 10 )
   local oGetMasDiv
   local cGetMasDiv     := ""
   local oBmpEmp
   local oBmpDiv
   local oBtnKit
   local oRieCli
   local nRieCli
   local oTlfCli
   local cTlfCli
   local cSerie         := cNewSer( "nPreCli", dbfCount )
   local oAprovado
   local cAprovado
   local oSayGetRnt
   local cTipPre
   local oSayDias
   local oSayTxtDias
   local oBmpGeneral





   cOldCodCli           := aTmp[6]

   do case
   case nMode == 1

      if !lCurSesion()
         MsgStop( "No hay sesiones activas, imposible añadir documentos" )
         Return .F.
      end

      if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 4 ]  := cCurSesion()
      aTmp[ 17 ]  := oUser():cAlmacen()
      aTmp[ 46 ]  := cDivEmp()
      aTmp[ 18 ]  := oUser():cCaja()
      aTmp[ 19 ]  := cDefFpg()
      aTmp[ 58 ]  := cCurUsr()
      aTmp[ 47 ]  := nChgDiv( aTmp[ 46 ], dbfDiv )
      aTmp[ 22 ]  := .F.
      aTmp[ 3 ]  := RetSufEmp()
      aTmp[ 62 ]  := nDiasValidez()
      aTmp[ 48 ]  := .T.
      aTmp[ 67 ]  := oUser():cDelegacion()
      aTmp[ 52 ]  := uFieldEmpresa( "lIvaInc" )
      aTmp[ 73 ]  := Padr( "Gastos", 250 )
      aTmp[ 53 ]  := nIva( dbfIva, cDefIva() )

      if !Empty( cCodCli )
         aTmp[ 6 ]  := cCodCli
      end

   case nMode == 2

      if aTmp[ 57 ] .AND. !oUser():lAdministrador()
         msgStop( "El presupuesto está cerrado." )
         Return .F.
      end

   case nMode == 4

      if !lCurSesion()
         MsgStop( "No hay sesiones activas, imposible añadir documentos" )
         Return .F.
      end

      if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 5 ]   := GetSysDate()
      aTmp[ 4 ]  := cCurSesion()
      aTmp[ 22 ]  := .F.
      aTmp[ 57 ]  := .F.

   end

   if Empty( Rtrim( aTmp[ 1 ] ) )
      aTmp[ 1 ]  := cSerie
   end

   if Empty( aTmp[ 28 ] )
      aTmp[ 28 ]  := Max( uFieldEmpresa( "nPreVta" ), 1 )
   end

   if Empty( aTmp[ 29 ] )
      aTmp[ 29 ]  := Padr( "General", 50 )
   end

   if Empty( aTmp[ 31 ] )
      aTmp[ 31 ]     := Padr( "Pronto pago", 50 )
   end





   cTipPre              := aTipPre[ if( aTmp[ 72 ], 2, 1  ) ]





   if BeginTrans( aTmp )
      Return .F.
   end

   cAprovado            := if( aTmp[22], "Aprobado", "" )





   if Empty( aTmp[ 75 ] )
      aTmp[ 75 ] := RetFld( aTmp[ 6 ], dbfClient, "Telefono" )
   end





   nOrd                 := ( dbfPreCliT )->( ordSetFocus( 1 ) )

   cPicUnd              := MasUnd()
   cPouDiv              := cPouDiv( aTmp[ 46 ], dbfDiv )
   cPorDiv              := cPorDiv( aTmp[ 46 ], dbfDiv )
   nDouDiv              := nDouDiv( aTmp[ 46 ], dbfDiv )
   nRouDiv              := nRouDiv( aTmp[ 46 ], dbfDiv )





   cSay[ 2 ]            := RetFld( aTmp[ 16 ], dbfTarPreS )
   cSay[ 3 ]            := RetFld( aTmp[ 6 ] + aTmp[ 15 ], dbfObrasT, "cNomObr" )
   cSay[ 4 ]            := RetFld( aTmp[ 17 ], dbfAlm )
   cSay[ 5 ]            := RetFld( aTmp[ 19 ], dbfFPago )
   cSay[ 6 ]            := RetFld( aTmp[ 14 ], dbfAgent )
   cSay[ 7 ]            := RetFld( aTmp[ 20 ], dbfRuta )
   cSay[ 8 ]            := oTrans:cNombre( aTmp[ 55 ] )
   cSay[ 9 ]            := RetFld( aTmp[ 18 ], dbfCajT )
   cSay[10 ]            := RetFld( aTmp[ 58 ], dbfUsr, "cNbrUse" )
   cSay[11 ]            := RetFld( cCodEmp() + aTmp[ 67 ], dbfDelega, "cNomDlg" )

   cTlfCli              := RetFld( aTmp[ 6 ], dbfClient, "Telefono" )

   nRieCli              := oStock:nRiesgo( aTmp[ 6 ] )





   InitTarifaCabecera( aTmp[ 28 ] )





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "presupuestos a clientes", "PEDCLI",, .F.,,,,,, .F.,,,,,, .F., )











      oFld := TFolder():ReDefine( 200, {"&Presupuesto", "Da&tos", "&Incidencias", "D&ocumentos"}, { "PRECLI_1","PRECLI_2","PEDCLI_3","PEDCLI_4" }, oDlg,,,,, .F., )









      oBmpGeneral := TBitmap():ReDefine( 990, "presupuesto_cliente_48_alpha",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "folder2_red_alpha_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "information_48_alpha",, oFld:aDialogs[3],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "address_book2_alpha_48",, oFld:aDialogs[4],,, .F., .F.,,, .F.,,, .T. )







        aGet[6] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[6], aTmp[6]:= u ) }, oFld:aDialogs[1],,, {||    ( LoaCli( aGet, aTmp, nMode, oRieCli ), RecalculaTotal( aTmp ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwClient( aGet[6] ) )}, nil, "LUPA",, )




      aGet[7] := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, aTmp[7], aTmp[7]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[12] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 8 ] := TGetHlp():ReDefine( 102, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 8 ], Rtrim( aTmp[ 9 ] ) + Space( 1 ) + Rtrim( aTmp[ 10 ] ) )}, nil, "Environnment_View_16",, )




      aGet[ 9 ] := TGetHlp():ReDefine( 103, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[ 10 ] := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




        aGet[11] := TGetHlp():ReDefine( 107, { | u | If( PCount()==0, aTmp[11], aTmp[11]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )









      aGet[ 28 ] := TGetHlp():ReDefine( 132, { | u | If( PCount()==0, aTmp[ 28 ], aTmp[ 28 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( ChangeTarifaCabecera( aTmp[ 28 ], dbfTmpLin, oBrwLin ) )},,,,,, .F., {||     ( nMode <> 3 .AND. ( lUsrMaster() .OR. oUser():lCambiarPrecio() ) )},, .F., .T.,,, {||      1}, {||      6},, nil,,, )





      oRieCli := TGetHlp():ReDefine( 133, { | u | If( PCount()==0, nRieCli, nRieCli:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[75] := TGetHlp():ReDefine( 106, { | u | If( PCount()==0, aTmp[75], aTmp[75]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 58 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 58 ], aTmp[ 58 ]:= u ) }, oFld:aDialogs[2],,, {||    ( SetUsuario( aGet[ 58 ], oSay[ 10 ], nil, dbfUsr ) )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 10 ] := TGetHlp():ReDefine( 126, { | u | If( PCount()==0, cSay[ 10 ], cSay[ 10 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )












        aGet[16] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[16], aTmp[16]:= u ) }, oFld:aDialogs[1],,, {||    ( cTarifa( aGet[16], oSay[ 2 ] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. oUser():lAdministrador() )},, .F., .F.,,,,, {|Self|( BrwTarifa( aGet[16], oSay[ 2 ] ) )}, nil, "LUPA",, )




      oSay[ 2 ] := TGetHlp():ReDefine( 141, { | u | If( PCount()==0, cSay[ 2 ], cSay[ 2 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )












        aGet[15] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[15], aTmp[15]:= u ) }, oFld:aDialogs[1],,, {||    ( cObras( aGet[15], oSay[ 3 ], aTmp[6], dbfObrasT ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwObras( aGet[15], oSay[ 3 ], aTmp[6], dbfObrasT ) )}, nil, "LUPA",, )




      oSay[ 3 ] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, cSay[ 3 ], cSay[ 3 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )











      aGet[ 17 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 17 ], aTmp[ 17 ]:= u ) }, oFld:aDialogs[ 1 ],,, {||    ( cAlmacen( aGet[ 17 ], , oSay[ 4 ] ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 17 ], oSay[ 4 ] ) )}, nil, "LUPA",, )






      oSay[ 4 ] := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cSay[ 4 ], cSay[ 4 ]:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( ExpAlmacen( aTmp[ 17 ], dbfTmpLin, oBrwLin ) )}, nil, "Bot",, )












      aGet[ 19 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cFPago( aGet[ 19 ], dbfFPago, oSay[ 5 ] ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFPago( aGet[ 19 ], oSay[ 5 ] ) )}, nil, "LUPA",, )




      oSay[ 5 ] := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, cSay[ 5 ], cSay[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )












      aGet[ 14 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAgentes( aGet[ 14 ], dbfAgent, oSay[ 6 ], aGet[ 43 ], dbfAgeCom ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 14 ], oSay[ 6 ] ) )}, nil, "LUPA",, )






      oSay[ 6 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, cSay[ 6 ], cSay[ 6 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( ExpAgente( aTmp[ 14 ], aTmp[ 43 ], dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, nil, "Bot",, )







      aGet[ 43 ] := TGetHlp():ReDefine( 182, { | u | If( PCount()==0, aTmp[ 43 ], aTmp[ 43 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( !Empty( aTmp[ 14 ] ) .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      oGetAge := TGetHlp():ReDefine( 183, { | u | If( PCount()==0, nTotAge, nTotAge:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )










      aGet[ 20 ] := TGetHlp():ReDefine( 185, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cRuta( aGet[ 20 ], dbfRuta, oSay[ 7 ] ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwRuta( aGet[ 20 ], dbfRuta, oSay[ 7 ] ) )}, nil, "LUPA",, )




      oSay[ 7 ] := TGetHlp():ReDefine( 186, { | u | If( PCount()==0, cSay[ 7 ], cSay[ 7 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )













        aGet[ 46 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cDivOut( aGet[ 46 ], oBmpDiv, aGet[ 47 ], @cPouDiv, @nDouDiv, @cPorDiv, @nRouDiv, nil, nil, oGetMasDiv, dbfDiv, oBandera ) )}, "N/W*",,,,, .F., {||     ( nMode == 1 .AND. ( dbfTmpLin )->( LastRec() ) == 0 )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ 46 ], oBmpDiv, aGet[ 47 ], dbfDiv, oBandera )}, nil, "LUPA",, )




        oBmpDiv := TBitmap():ReDefine( 201, "BAN_EURO",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .F. )








      oBmpEmp := TBitmap():ReDefine( 500,, "Bmp\ImgPreCli.bmp", oDlg,,, .F., .F.,,, .F.,,, .F. )





      oBrwLin                 := IXBrowse():New( oFld:aDialogs[1] )

      oBrwLin:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwLin:cAlias          := dbfTmpLin

      oBrwLin:nMarqueeStyle   := 6
      oBrwLin:cName           := "Presupuesto a cliente.Detalle"

      oBrwLin:CreateFromResource( 210 )

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Oferta"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfTmpLin )->lLinOfe }
         :nWidth              := 60
         :SetCheck( { "Star_Red_16", "Nil16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Número"
         :bEditValue          := {|| ( dbfTmpLin )->nNumLin }
         :cEditPicture        := "9999"
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Código"
         :bEditValue          := {|| ( dbfTmpLin )->cRef }
         :nWidth              := 60
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "C. Barras"
         :bEditValue          := {|| cCodigoBarrasDefecto( ( dbfTmpLin )->cRef, dbfCodeBar ) }
         :nWidth              := 100
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Descripción"
         :bEditValue          := {|| if( Empty( ( dbfTmpLin )->cRef ), ( dbfTmpLin )->mLngDes, ( dbfTmpLin )->cDetalle ) }
         :nWidth              := 300
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Código proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cCodPrv ) }
         :nWidth              := 50
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Nombre proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cNomPrv ) }
         :nWidth              := 150
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Referencia proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cRefPrv ) }
         :nWidth              := 50
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 1"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr1 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 2"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr2 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Lote"
         :bEditValue          := {|| ( dbfTmpLin )->cLote }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := cNombreUnidades()
         :bEditValue          := {|| nTotNPreCli( dbfTmpLin ) }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "UM. Unidad de medición"
         :bEditValue          := {|| ( dbfTmpLin )->cUnidad }
         :nWidth              := 25
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Alm."
         :bEditValue          := {|| ( dbfTmpLin )->cAlmLin }
         :nWidth              := 35
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Precio"
         :bEditValue          := {|| nImpUPreCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Dto."
         :bEditValue          := {|| ( dbfTmpLin )->nDto }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Dto. Lin."
         :bEditValue          := {|| nDtoUPreCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Prm."
         :bEditValue          := {|| ( dbfTmpLin )->nDtoPrm }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Age"
         :bEditValue          := {|| ( dbfTmpLin )->nComAge }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% " + cImp()
         :bEditValue          := {|| ( dbfTmpLin )->nIva }
         :cEditPicture        := "@E 99.9"
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Portes"
         :bEditValue          := {|| nTrnUPreCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "P. verde"
         :bEditValue          := {|| nPntUPreCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Total"
         :bEditValue          := {|| nTotLPreCli( , dbfTmpLin, nDouDiv, nRouDiv, , , aTmp[ 80 ] ) }
         :cEditPicture        := cPorDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      if nMode <> 3
         oBrwLin:bLDblClick  := {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) }
      end








      aGet[ 29 ] := TGetHlp():ReDefine( 219, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 30 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      aGet[ 31 ] := TGetHlp():ReDefine( 229, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








        aGet[ 32 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )






        aGet[ 33 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









        aGet[ 34 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )






      aGet[ 35 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 36 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      oBrwIva                        := TXBrowse():New( oFld:aDialogs[ 1 ] )

      oBrwIva:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwIva:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwIva:SetArray( aTotIva, , , .F. )
      oBrwIva:lHscroll               := .F.

      oBrwIva:nMarqueeStyle          := 5
      oBrwIva:lRecordSelector        := .F.

      oBrwIva:CreateFromResource( 490 )

      with object ( oBrwIva:AddCol() )
         :cHeader          := "Base"
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil, Trans( aTotIva[ oBrwIva:nArrayAt, 2 ], cPorDiv ), "" ) }
         :nWidth           := 105
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader       := "%" + cImp()
         :bStrData      := {|| if( !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ), aTotIva[ oBrwIva:nArrayAt, 3 ], "" ) }
         :bEditValue    := {|| aTotIva[ oBrwIva:nArrayAt, 3 ] }
         :nWidth        := 58
         :cEditPicture  := "@E 999.99"
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
         :nEditType     := 1
         :bEditWhen     := {|| !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ) }
         :bOnPostEdit   := {|o,x| EdtIva( o, x, aTotIva[ oBrwIva:nArrayAt, 3 ], dbfTmpLin, dbfIva, oBrwLin ), RecalculaTotal( aTmp ) }
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := cImp()
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil, Trans( aTotIva[ oBrwIva:nArrayAt, 8 ], cPorDiv ), "" ) }
         :nWidth           := 64
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "% R.E."
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil .AND. aTmp[ 42 ], Trans( aTotIva[ oBrwIva:nArrayAt, 4 ], "@EZ 99.9" ), "" ) }
         :nWidth           := 58
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "R.E."
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil .AND. aTmp[ 42 ], Trans( aTotIva[ oBrwIva:nArrayAt, 9 ], cPorDiv ), "" ) }
         :nWidth           := 58
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end









      aGet[ 73 ] := TGetHlp():ReDefine( 411, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 53 ] := TGetHlp():ReDefine( 412, { | u | If( PCount()==0, aTmp[ 53 ], aTmp[ 53 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lTiva( dbfIva, aTmp[ 53 ] ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 53 ], dbfIva, , .T. ) )}, nil, "LUPA",, )







      aGet[ 54 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[1],, cPorDiv, {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )



      oGetNet := TSay():ReDefine( 401, {|| nTotNet}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oGetTrn := TSay():ReDefine( 402, {|| nTotTrn}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oGetIvm := TSay():ReDefine( 403, {|| nTotIvm}, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      aGet[ 80 ] := TCheckBox():ReDefine( 409, { | u | If( PCount()==0, aTmp[ 80 ], aTmp[ 80 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ), oBrwLin:Refresh() )},,,,, .F., {||         ( nMode <> 3 )}, .F. )



      oGetPnt := TSay():ReDefine( 404, {|| nTotPnt}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oGetIva := TSay():ReDefine( 405, {|| nTotIva}, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      aGet[ 42 ] := TCheckBox():ReDefine( 406, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ) )},,,,, .F., {||         ( nMode <> 3 )}, .F. )



      oGetReq := TSay():ReDefine( 407, {|| nTotReq}, oFld:aDialogs[1],,,, .F.,, .F., .F. )

      oSayGetRnt := TSay():ReDefine( 709,, oFld:aDialogs[1],,,, .F.,, .F., .F. )



      oGetRnt := TGetHlp():ReDefine( 408, { | u | If( PCount()==0, nTotRnt, nTotRnt:= u ) }, oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




      oGetMasDiv := TSay():ReDefine( 410, {|| cGetMasDiv}, oFld:aDialogs[1],,,, .F., oFont, .F., .F. )




      oGetTotal := TSay():ReDefine( 420, {|| nTotPre}, oFld:aDialogs[1],,,, .F., oFont, .F., .F. )









        TButton():ReDefine( 515, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .T. ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 500, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .F. ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 501, {||( EdtDeta( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( DelDeta( oBrwLin, aTmp ), oTipPre:Refresh() )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( EdtZoom( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )





        TButton():ReDefine( 524, {||( DbSwapUp( dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 525, {||( DbSwapDown( dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )




      oBtnKit := TButton():ReDefine( 526, {||( ShowKit( dbfPreCliT, dbfTmpLin, oBtnKit, oBrwLin ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )










      aGet[1] := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, aTmp[1], aTmp[1]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( aTmp[1] >= "A" .AND. aTmp[1] <= "Z"  )}, "N/W*",,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[1] ) )}, {||  ( DwSerie( aGet[1] ) )},,,, nil,,, )





        aGet[2] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[2], aTmp[2]:= u ) }, oFld:aDialogs[1],, "999999999",,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )




        aGet[3] := TGetHlp():ReDefine( 105, { | u | If( PCount()==0, aTmp[3], aTmp[3]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )






        aGet[5] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[5], aTmp[5]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )








      aGet[ 71 ] := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 71 ], aTmp[ 71 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,, 114, )








      aGet[ 70 ] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[ 70 ], aTmp[ 70 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,, 115, )





      oSayDias := TSay():ReDefine( 113, {||      ( aTmp[ 70 ] - aTmp[ 71 ] )}, oFld:aDialogs[1], "9999",,, .F.,, .F., .F. )



      oSayTxtDias := TSay():ReDefine( 116,, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      oAprovado := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, cAprovado, cAprovado:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,, 121, )





      aGet[ 61 ] := TComboBox():ReDefine( 218, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, ( aSituacion( dbfSitua ) ), oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )},,,,, )






      oTipPre := TComboBox():ReDefine( 217, { | u | If( PCount()==0, cTipPre, cTipPre:= u ) }, aTipPre, oFld:aDialogs[1],,, {|Self|(SetDialog( aGet, oSayDias, oSayTxtDias, oSayGetRnt, oGetRnt ) )},,,, .F., {||     ( ( dbfTmpLin )->( LastRec() ) == 0 )},,,,, )






        aGet[23] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[23], aTmp[23]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,, 123, )




      aGet[52] := TCheckBox():ReDefine( 129, { | u | If( PCount()==0, aTmp[52], aTmp[52]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( ( dbfTmpLin )->( LastRec() ) == 0 )}, .F. )






      aGet[ 67 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 67 ], aTmp[ 67 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 11 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSay[ 11 ], cSay[ 11 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )











      aGet[ 55 ] := TGetHlp():ReDefine( 235, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[2],,, {||    ( LoadTrans( aTmp, aGet[ 55 ], aGet[ 56 ], oSay[ 8 ] ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oTrans:Buscar( aGet[ 55 ] ), .T. )}, nil, "LUPA",, )




      oSay[ 8 ] := TGetHlp():ReDefine( 236, { | u | If( PCount()==0, cSay[ 8 ], cSay[ 8 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )





      aGet[ 56 ] := TGetHlp():ReDefine( 237, { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )












      aGet[ 18 ] := TGetHlp():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[2],,, {||    cCajas( aGet[ 18 ], dbfCajT, oSay[ 9 ] )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 18 ], oSay[ 9 ] ) )}, nil, "LUPA",, )





      oSay[ 9 ] := TGetHlp():ReDefine( 166, { | u | If( PCount()==0, cSay[ 9 ], cSay[ 9 ]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







     aGet[44] := TGetHlp():ReDefine( 128, { | u | If( PCount()==0, aTmp[44], aTmp[44]:= u ) }, oFld:aDialogs[2],, "999",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[ 62 ] := TGetHlp():ReDefine( 219, { | u | If( PCount()==0, aTmp[ 62 ], aTmp[ 62 ]:= u ) }, oFld:aDialogs[2],, "999",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )









      aGet[49] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[49], aTmp[49]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[50] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[50], aTmp[50]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )










      aGet[21] := TGetHlp():ReDefine( 127, { | u | If( PCount()==0, aTmp[21], aTmp[21]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





        aGet[24] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[24], aTmp[24]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





        aGet[25] := TMultiGet():ReDefine( 250, { | u | If( PCount()==0, aTmp[25], aTmp[25]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, .F.,, )





        aGet[26] := TMultiGet():ReDefine( 240, { | u | If( PCount()==0, aTmp[26], aTmp[26]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, .F.,, )








      aGet[ 64 ] := TCheckBox():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 64 ], aTmp[ 64 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 .AND. lUsrMaster() )}, .F. )




      aGet[ 65 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 65 ], aTmp[ 65 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )




      aGet[ 66 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 66 ], aTmp[ 66 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )





      oGetPes := TGetHlp():ReDefine( 570, { | u | If( PCount()==0, nTotPes, nTotPes:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oGetDif := TGetHlp():ReDefine( 580, { | u | If( PCount()==0, nTotDif, nTotDif:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oBrwInc                 := IXBrowse():New( oFld:aDialogs[ 3 ] )

      oBrwInc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwInc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwInc:cAlias          := dbfTmpInc

      oBrwInc:nMarqueeStyle   := 6
      oBrwInc:cName           := "Presupuesto a cliente.Incidencias"

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Resuelta"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpInc )->lListo }
            :nWidth           := 70
            :SetCheck( { "Sel16", "Cnt16" } )
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Código"
            :bEditValue       := {|| ( dbfTmpInc )->cCodTip }
            :nWidth           := 80
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Incidencia"
            :bEditValue       := {|| cNomInci( ( dbfTmpInc )->cCodTip, dbfInci ) }
            :nWidth           := 250
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpInc )->dFecInc ) }
            :nWidth           := 90
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpInc )->mDesInc }
            :nWidth           := 500
         end

         if nMode <> 3
            oBrwInc:bLDblClick   := {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) }
         end

         oBrwInc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F.,,,, .F. )





      oBrwDoc                 := TXBrowse():New( oFld:aDialogs[ 4 ] )

      oBrwDoc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDoc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDoc:cAlias          := dbfTmpDoc

      oBrwDoc:nMarqueeStyle   := 6
      oBrwDoc:nRowHeight      := 40
      oBrwDoc:nDataLines      := 2

         with object ( oBrwDoc:AddCol() )
            :cHeader          := "Documento"
            :bEditValue       := {|| Rtrim( ( dbfTmpDoc )->cNombre ) + Chr(13)+Chr(10) + Space( 5 ) + Rtrim( ( dbfTmpDoc )->cRuta ) }
            :nWidth           := 960
         end

         if nMode <> 3
            oBrwDoc:bLDblClick   := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( ( dbfTmpDoc )->cRuta ) ) }
         end

         oBrwDoc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwDoc, bEdtDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( ShellExecute( oDlg:hWnd, "open", rTrim( ( dbfTmpDoc )->cRuta ) ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )









      TButton():ReDefine( 3, {||( RecPreCli( aTmp ), nTotPreCli( nil, dbfPreCliT, dbfTmpLin, dbfIva, dbfDiv, dbfFPago, aTmp ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 1, {||( EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 4, {||( if( EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ), GenPreCli( 1 ), ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 2, {||( if ( ExitNoSave( nMode, dbfTmpLin ), oDlg:end(), ) )}, oDlg,,, .F.,,,, .F. )

      oSayLabels[ 1 ] := TGroup():ReDefine( 700,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 2 ] := TSay():ReDefine( 703,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 3 ] := TSay():ReDefine( 704,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 4 ] := TSay():ReDefine( 705,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 5 ] := TSay():ReDefine( 706,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 6 ] := TSay():ReDefine( 708,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 7 ] := TSay():ReDefine( 710,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 8 ] := TSay():ReDefine( 711,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 9 ] := TSay():ReDefine( 712,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )

   if nMode <> 3

      oFld:aDialogs[1]:AddFastKey( 113, {|| AppDeta( oBrwLin, bEdtDet, aTmp, .F. ) } )
      oFld:aDialogs[1]:AddFastKey( 114, {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) } )
      oFld:aDialogs[1]:AddFastKey( 115, {|| DelDeta( oBrwLin, aTmp ), oTipPre:Refresh() } )

      oFld:aDialogs[3]:AddFastKey( 113, {|| WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 114, {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 115, {|| WinDelRec( oBrwInc, dbfTmpInc ) } )

      oFld:aDialogs[4]:AddFastKey( 113, {|| WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 114, {|| WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 115, {|| WinDelRec( oBrwDoc, dbfTmpDoc ) } )

      oDlg:AddFastKey( 116, {|| EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ) } )
      oDlg:AddFastKey( 117, {|| if( EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ), GenPreCli( 1 ), ) } )

      oDlg:AddFastKey( 65,    {|| if( GetKeyState( 17 ), CreateInfoArticulo(), ) } )

   end

   oDlg:AddFastKey( 112, {|| ChmHelp( "Presupuesto" ) } )

   do case
      case nMode == 1 .AND. lRecogerUsuario() .AND. Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 58 ], dbfUsr ), , oDlg:End() ) }

      case nMode == 1 .AND. lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 58 ], dbfUsr ), AppDeta( oBrwLin, bEdtDet, aTmp, nil, cCodArt ), oDlg:End() ) }

      case nMode == 1 .AND. !lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| AppDeta( oBrwLin, bEdtDet, aTmp, nil, cCodArt ) }

      otherwise
         oDlg:bStart := {|| ShowKit( dbfPreCliT, dbfTmpLin, oBtnKit, oBrwLin, .F., dbfTmpInc, cCodCli, dbfClient, oRieCli, oGetRnt, aGet, oSayGetRnt ) }

   end







    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|(  RecalculaTotal( aTmp ) )}, .T.,,, {|Self|(  EdtRecMenu( aTmp, oDlg ) , SetDialog( aGet, oSayDias, oSayTxtDias, oSayGetRnt, oGetRnt ) , oBrwLin:Load() , oBrwInc:Load() )}, oDlg:bRClicked,,, )

   oMenu:End()

   oBmpEmp:end()
   oBmpDiv:end()
   oBmpGeneral:End()

   ( dbfPreCliT )->( ordSetFocus( nOrd ) )

   KillTrans( oBrwLin )





   oBrwInc:CloseData()

RETURN ( oDlg:nResult == 1 )



Static Function EdtRecMenu( aTmp, oDlg )

   oMenu := MenuBegin( .F.,,, .F., .F. )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F. )

         MenuBegin( .F.,,, .F., .F. )

            if !lExternal




            MenuAddItem( "&1. Modificar cliente", "Modificar la ficha del cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), EdtCli( aTmp[ 6 ] ), MsgStop( "Código cliente vacío" ) ) )},, "User1_16",,,,, .F.,,, .F. )





            MenuAddItem( "&2. Informe de cliente", "Abrir el informe del cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), InfCliente( aTmp[ 6 ] ), MsgStop( "Código cliente vacío" ) ) )},, "Info16",,,,, .F.,,, .F. )



            MenuAddItem( "&3. Modificar obra", "Modificar ficha de la obra", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 15 ] ), EdtObras( aTmp[ 6 ], aTmp[ 15 ], dbfObrasT ), MsgStop( "No hay obra asociada para el presupuesto" ) ) )},, "Worker16",,,,, .F.,,, .F. )

            MenuAddItem()

            end




            MenuAddItem( "&4. Informe del documento", "Abrir el informe del documento", .F.,, {|oMenuItem|( TTrazaDocumento():Activate( "08", aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ] ) )},, "Info16",,,,, .F.,,, .F. )

         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMenu )

Return ( oMenu )






STATIC FUNCTION AppDeta( oBrwLin, bEdtDet, aTmp, lTot, cCodArt  )

   IIF( lTot == nil, lTot := .F., ) ;





   WinAppRec( oBrwLin, bEdtDet, dbfTmpLin, lTot, cCodArt, aTmp )

   if !Empty( oBrwLin )
      oBrwLin:Refresh()
   end

RETURN RecalculaTotal( aTmp )







STATIC FUNCTION EdtDeta( oBrwLin, bEdtDet, aTmp )

   WinEdtRec( oBrwLin, bEdtDet, dbfTmpLin, .F., nil, aTmp )

RETURN RecalculaTotal( aTmp )







STATIC FUNCTION DelDeta( oBrwLin, aTmp )

   local lKitArt  := ( dbfTmpLin )->lKitArt
   local nNumLin  := ( dbfTmpLin )->nNumLin

   if lKitArt
      DbDelKit( oBrwLin, dbfTmpLin, nNumLin )
   end

   WinDelRec( oBrwLin, dbfTmpLin, , {|| if( lKitArt, DbDelKit( oBrwLin, dbfTmpLin, nNumLin ), ) } )

   RecalculaTotal( aTmp )

RETURN ( .T. )







STATIC FUNCTION EdtZoom( oBrwLin, bEdtDet, aTmp )

RETURN WinZooRec( oBrwLin, bEdtDet, dbfTmpLin, .F., nil, aTmp )






STATIC FUNCTION EdtDet( aTmp, aGet, dbfPreCliL, oBrw, lTotLin, cCodArtEnt, nMode, aTmpPre )

   local oDlg
   local oFld
   local oBtn
    local oTotal
   local nTotPreCli
   local cGet2
   local oGet2
   local cGet3
   local oGet3
   local oSayPr1
   local oSayPr2
   local cSayPr1           := ""
   local cSayPr2           := ""
   local oSayVp1
   local oSayVp2
   local cSayVp1           := ""
   local cSayVp2           := ""
   local oSayAlm
   local cSayAlm           := ""
   local bmpImage
   local oSayLote
   local oSayGrp
   local cSayGrp           := ""
   local oSayFam
   local cSayFam           := ""
   local oStkAct
   local nStkAct           := 0
   local cCodArt           := Padr( aTmp[ 4 ], 32 )
   local oRentLin
   local cRentLin
   local cCodDiv           := aTmpPre[ 46 ]
   local oSayDias
   local oGetCaducidad
   local dGetCaducidad

   IIF( lTotLin == nil, lTotLin := .F., ) ;

   SysRefresh()

   do case
   case nMode == 1
      aTmp[ 1  ]    := aTmpPre[ 1 ]
      aTmp[ 2  ]    := aTmpPre[ 2 ]
      aTmp[ 3  ]    := aTmpPre[ 3 ]
      aTmp[ 8 ]    := 1
      aTmp[ 31  ]    := cDefVta()
      aTmp[ 23  ]    := lTotLin
      aTmp[ 7  ]    := 1
      aTmp[ 37  ]    := aTmpPre[ 52 ]
      aTmp[ 36  ]    := aTmpPre[ 17 ]
      aTmp[ 73  ]    := aTmpPre[ 28 ]
      aTmp[ 74  ]    := .T.

      if !Empty( cCodArtEnt )
         cCodArt           := Padr( cCodArtEnt, 32 )
      end

      aTmp[ 66 ]    := aTmpPre[ 71 ]
      aTmp[ 65 ]    := aTmpPre[ 70 ]

      if !Empty( oTipPre )
         if oTipPre:nAt == 2
            aTmp[ 68 ]  := .T.
         else
            aTmp[ 68 ]  := .F.
         end
      end

   case nMode == 2
      lTotLin           := aTmp[ 23 ]

   end





   cOldCodArt           := aTmp[ 4 ]
   cOldPrpArt           := aTmp[ 25 ] + aTmp[ 26 ] + aTmp[ 27 ] + aTmp[ 28 ]
   cOldUndMed           := aTmp[ 18 ]





   cSayGrp              := RetFld( aTmp[ 52 ], oGrpFam:GetAlias() )
   cSayFam              := RetFld( aTmp[ 51 ], dbfFamilia )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "líneas de presupuestos a clientes", "LFACCLI",, .F.,,,,,, .F.,,,,,, .F., )

      if aTmp[ 68 ]



         oFld := TFolder():ReDefine( 400, {"&General",    "Da&tos",    "&Observaciones"}, { "LPRECLI_4","LALBCLI_2","LFACCLI_3" }, oDlg,,,,, .F., )

      else



         oFld := TFolder():ReDefine( 400, {"&General",    "Da&tos",    "&Observaciones"}, { "LFACCLI_1","LALBCLI_2","LFACCLI_3" }, oDlg,,,,, .F., )

      end








      aGet[ 4 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cCodArt, cCodArt:= u ) }, oFld:aDialogs[1],,, {||    ( LoaArt( aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwArticulo( aGet[4], aGet[5] ) )}, nil, "LUPA",, )




      aGet[ 5 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 5 ] ) ) .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ 22 ] := TMultiGet():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[1],, "N/W*",,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 22 ] ) ) .AND. nMode <> 3 )}, .F.,, )








      oSayLote := TSay():ReDefine( 113,, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      aGet[ 42 ] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      aGet[ 42 ]:bValid   := {|| if( !uFieldEmpresa( "lNStkAct" ), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], aTmp[ 43 ], aTmp[ 33 ], oStkAct ), .T. ), .T. }

      if !aTmp[ 68 ]






      oGetCaducidad := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, dGetCaducidad, dGetCaducidad:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 341, )

      end






      if !aTmp[ 68 ]










      aGet[ 27 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 27 ], aTmp[ 27 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[27], oSayVp1, aTmp[25 ], dbfTblPro ), LoaArt( aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ), .F. ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[27], oSayVp1, aTmp[25 ] ) )}, nil, "LUPA",, )

         aGet[ 27 ]:bChange   := {|| aGet[ 27 ]:Assign(), if( !uFieldEmpresa( "lNStkAct" ), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], aTmp[ 43 ], aTmp[ 33 ], oStkAct ), .T. ) }



      oSayPr1 := TSay():ReDefine( 271, {|| cSayPr1}, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      oSayVp1 := TGetHlp():ReDefine( 272, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )










      aGet[28] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[28], aTmp[28]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[28], oSayVp2, aTmp[26 ], dbfTblPro ), LoaArt( aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ), .F. ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[28], oSayVp2, aTmp[26 ] ) )}, nil, "LUPA",, )

         aGet[ 28 ]:bChange   := {|| aGet[ 28 ]:Assign(), if( !uFieldEmpresa( "lNStkAct" ), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], aTmp[ 43 ], aTmp[ 33 ], oStkAct ), .T. ) }



      oSayPr2 := TSay():ReDefine( 281, {|| cSayPr2}, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      oSayVp2 := TGetHlp():ReDefine( 282, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )

      end













      aGet[ 18 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oUndMedicion:Existe( aGet[ 18 ], aGet[ 18 ]:oHelpText, "cNombre" ), ValidaMedicion( aTmp, aGet ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oUndMedicion:Buscar( aGet[ 18 ] ), ValidaMedicion( aTmp, aGet ) )}, nil, "LUPA",, 171 )











      aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ] := TGetHlp():ReDefine( 520, { | u | If( PCount()==0, aTmp[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ], aTmp[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 521, )

         aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ] := TGetHlp():ReDefine( 530, { | u | If( PCount()==0, aTmp[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ], aTmp[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 531, )

         aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ] := TGetHlp():ReDefine( 540, { | u | If( PCount()==0, aTmp[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ], aTmp[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 541, )

         aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetColor( 8388608 )

      if IsMuebles()





         aGet[ 62 ] := TGetHlp():ReDefine( 500, { | u | If( PCount()==0, aTmp[ 62 ], aTmp[ 62 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,, 501, )

      end









      aGet[ 6 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lTiva( dbfIva, aTmp[ 6 ], @aTmp[ 53 ] ) )}, "N/W*",,,,, .F., {||     ( lModIva() .AND. nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 6 ], dbfIva, , .T. ) )}, nil, "LUPA",, )

      if aTmp[ 68 ]







      aGet[ 66 ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ 66 ], aTmp[ 66 ]:= u ) }, oFld:aDialogs[1],,, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ), oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,,, )







      aGet[ 65 ] := TGetHlp():ReDefine( 430, { | u | If( PCount()==0, aTmp[ 65 ], aTmp[ 65 ]:= u ) }, oFld:aDialogs[1],,, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ), oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,,, )





      oSayDias := TSay():ReDefine( 440, {||      ( aTmp[ 65 ] - aTmp[ 66 ] )}, oFld:aDialogs[1], "9999",,, .F.,, .F., .F. )

      else









      aGet[ 39 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[1],, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,, {|Self|( oNewImp:nBrwImp( aGet[ 39 ] ) )}, nil,, 126, )

      end









      aGet[ 7 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ) )},,,,,, .F., {||     ( lUseCaj() .AND. nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 131, )









      aGet[ 8 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 141, )









      aGet[ 11 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )










      aGet[ 73 ] := TGetHlp():ReDefine( 156, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( aTmp[ 73 ] >= 1 .AND. aTmp[ 73 ] <= 6 )},,,,,, .F., {||     ( nMode <> 3 .AND. ( lUsrMaster() .OR. oUser():lCambiarPrecio() ) )}, {|nKey,nFlags,Self| ( ChangeTarifa( aTmp, aGet, aTmpPre ), RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,, {||      1}, {||      6},, nil,,, )





      if aTmp[ 68 ]









         aGet[ 67 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 67 ], aTmp[ 67 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )

      end









      aGet[ 13 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 351, )









      aGet[12] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],, cPpvDiv, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 152, )





      aGet[ 29 ] := TGetHlp():ReDefine( 295, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )





      aGet[ 19 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )




      aGet[ 20 ] := TGetHlp():ReDefine( 175, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )





      aGet[ 63 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 63 ], aTmp[ 63 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin)},, .F., .F.,,,,,, nil,,, )





      aGet[ 64 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 64 ], aTmp[ 64 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )








      aGet[14] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[14], aTmp[14]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 15 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 15 ], aTmp[ 15 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )







      aGet[ 16 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .T.,,,,,, nil,,, )

      if !aTmp[ 68 ]





      oComisionLinea := TGetHlp():ReDefine( 201, { | u | If( PCount()==0, nComisionLinea, nComisionLinea:= u ) }, oFld:aDialogs[ 1 ],, cPorDiv,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

      end











      aGet[30] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[30], aTmp[30]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) .AND. aTmp[30] >= 0 )}, ( 255 + ( 0 * 256 ) + ( 0 * 65536 ) ),,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,, {||      0},,, nil,, 261, )






      oTotal := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nTotPre, nTotPre:= u ) }, oFld:aDialogs[1],, cPorDiv,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )








      aGet[31] := TGetHlp():ReDefine( 290, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[1],,, {||        ( cTVta( aGet[31], dbfTVta, oGet2 ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( BrwTVta( aGet[31], dbfTVta, oGet2 ) )}, nil, "LUPA", 292, )





        oGet2 := TGetHlp():ReDefine( 291, { | u | If( PCount()==0, cGet2, cGet2:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )











      aGet[ 50 ] := TGetHlp():ReDefine( 205, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oTipArt:lValid( aGet[ 50 ], oGet3 ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( oTipArt:Buscar( aGet[ 50 ] ) )}, nil, "LUPA",, )





      oGet3 := TGetHlp():ReDefine( 206, { | u | If( PCount()==0, cGet3, cGet3:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )












      aGet[36] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[36], aTmp[36]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[36], , oSayAlm ), if( !uFieldEmpresa( "lNStkAct" ), oStock:lPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], aTmp[ 43 ], aTmp[ 33 ], oStkAct ), .T. ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[36], oSayAlm ) )}, nil, "LUPA",, )




      oSayAlm := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSayAlm, cSayAlm:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )





      oStkAct := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, nStkAct, nStkAct:= u ) }, oFld:aDialogs[1],, cPicUnd,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






      aGet[46] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[46], aTmp[46]:= u ) }, oFld:aDialogs[1],, "99",,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )











      aGet[32] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[32], aTmp[32]:= u ) }, oFld:aDialogs[2],, "9999",, "N/W*",,,,, .F., {||     ( nMode == 1 )},, .F., .T.,,,,,, nil,,, )




      aGet[24] := TCheckBox():ReDefine( 110, { | u | If( PCount()==0, aTmp[24], aTmp[24]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      aGet[21] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[21], aTmp[21]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[9] := TCheckBox():ReDefine( 130, { | u | If( PCount()==0, aTmp[9], aTmp[9]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )







      aGet[ 34 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[1],, cPouDiv,,,,,,, .F., {||     ( oUser():lAdministrador() .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,, 321, )






      aGet[ 35 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[2],, cPouDiv,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








      aGet[ 57 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 57 ], aTmp[ 57 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( ChgBmp( aGet[ 57 ], bmpImage ) ) }, .F., .F.,,,,, {|Self|( GetBmp( aGet[ 57 ], bmpImage ) )}, nil, "LUPA",, )











      aGet[ 52 ] := TGetHlp():ReDefine( ( 150 ), { | u | If( PCount()==0, aTmp[ 52 ], aTmp[ 52 ]:= u ) }, oFld:aDialogs[ 2 ],,, {||    ( oSayGrp:cText( RetFld( aTmp[ 52  ], oGrpFam:GetAlias() ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oGrpFam:Buscar( aGet[ 52 ] ) )}, nil, "LUPA",, )




      oSayGrp := TGetHlp():ReDefine( ( 151 ), { | u | If( PCount()==0, cSayGrp, cSayGrp:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      aGet[ 51 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oSayFam:cText( RetFld( aTmp[ 51  ], dbfFamilia ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFamilia( aGet[ 51 ], oSayFam ) )}, nil, "LUPA",, )




      oSayFam := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cSayFam, cSayFam:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )




      oRentLin := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, cRentLin, cRentLin:= u ) }, oFld:aDialogs[2],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,, 301, )




      aGet[ 74 ] := TCheckBox():ReDefine( 310, { | u | If( PCount()==0, aTmp[ 74 ], aTmp[ 74 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )






      aGet[ 75 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ 75 ], aTmp[ 75 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

         aGet[ 75 ]:bValid := {|| oFraPub:lValid( aGet[ 75 ], aGet[ 76 ] ) }
         aGet[ 75 ]:bHelp  := {|| oFraPub:Buscar( aGet[ 75 ] ) }





      aGet[ 76 ] := TGetHlp():ReDefine( 321, { | u | If( PCount()==0, aTmp[ 76 ], aTmp[ 76 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 44 ] := TCheckBox():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 45 ] := TCheckBox():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 33 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[ 2 ],, { 350, 351, 352 },,,,, .F., {||     ( nMode <> 3 )}, )





      aGet[ 54 ] := TMultiGet():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      aGet[ 77 ] := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 77 ], aTmp[ 77 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )

if ( IsMuebles() )





      aGet[55] := TGetHlp():ReDefine( 800, { | u | If( PCount()==0, aTmp[55], aTmp[55]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      aGet[56] := TGetHlp():ReDefine( 801, { | u | If( PCount()==0, aTmp[56], aTmp[56]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

end





      bmpImage := TBitmap():ReDefine( 220,, ( cFileBitmap( cPatImg(), aTmp[ 57 ] ) ), oDlg,, { |nRow,nCol,nKeyFlags| ( bmpImage:lStretch := !bmpImage:lStretch, bmpImage:Refresh() ) }, .F., .F.,,, .F.,,, .F. )

         bmpImage:SetColor( , GetSysColor( 15 ) )









      oBtn := TButton():ReDefine( 1, {||( SaveDeta( aTmp, aTmpPre, aGet, oDlg, oBrw, bmpImage, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGet2, oTotal, oSayLote, cCodArt, oBtn ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 9, {||( ChmHelp( "Añadir_v" ) )}, oDlg,,, .F.,,,, .F. )

      if nMode <> 3
         oDlg:AddFastKey( 116, {|| oBtn:SetFocus(), oBtn:Click() } )
      end

      oDlg:AddFastKey( 112, {|| ChmHelp( "Añadir_v" ) } )




      oDlg:bStart := {||   SetDlgMode( aTmp, aGet, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGet2, oTotal, aTmpPre, oSayLote, oRentLin ), if( !Empty( oGetCaducidad ), oGetCaducidad:Hide(), ), if( !Empty( cCodArtEnt ), aGet[ 4 ]:lValid(), ), aGet[ 18 ]:lValid() }



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )}, .T.,,, {|Self|( EdtDetMenu( aGet[ 4 ], oDlg ) )}, oDlg:bRClicked,,, )

   EndDetMenu()

RETURN ( oDlg:nResult == 1 )







STATIC FUNCTION SetDlgMode( aTmp, aGet, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGet2, oTotal, aTmpPre, oSayLote, oRentLin )

   local cCodArt  := aGet[ 4 ]:varGet()

   if aGet[ 7 ] <> nil
      if !lUseCaj()
         aGet[ 7 ]:hide()
      else
         aGet[ 7 ]:SetText( cNombreCajas() )
      end
   end

   if aGet[ 8 ] <> nil
      aGet[ 8 ]:SetText( cNombreUnidades() )
   end

   if aGet[ 39 ] <> nil
      if !uFieldEmpresa( "lUseImp" )
         aGet[ 39 ]:Hide()
      else
         if !uFieldEmpresa( "lModImp" )
            aGet[ 39 ]:Disable()
         end
      end
   end

   if aGet[ 13 ] <> nil
      if !uFieldEmpresa( "lUsePor" )
         aGet[ 13 ]:Hide()
      end
   end

   if aGet[ 12 ] <> nil
      if !uFieldEmpresa( "lUsePnt" ) .OR. !aTmpPre[ 80 ]
         aGet[ 12 ]:Hide()
      end
   end

   if aGet[ 30 ] <> nil
      if !uFieldEmpresa( "lDtoLin" )
         aGet[ 30 ]:Hide()
      end
   end

   if oRentLin <> nil .AND. oUser():lNotRentabilidad()
      oRentLin:Hide()
   end

   if aTmp[ 68 ]
      aGet[ 11 ]:Hide()
      aGet[ 67 ]:Show()
   end

   do case
   case nMode == 1

      aTmp[ 4    ]  := Space( 32 )
      aTmp[ 37 ]  := aTmpPre[ 52 ]

      if aGet[ 32 ] <> nil
         aGet[ 32 ]:cText( nLastNum( dbfTmpLin ) )
      end

      aGet[ 7 ]:cText( 1 )
      aGet[ 8 ]:cText( 1 )
      aGet[ 36  ]:cText( aTmpPre[ 17 ] )
      aGet[ 5 ]:show()

      if aGet[ 22 ] <> nil
         aGet[ 22 ]:hide()
      end

      if aGet[ 42 ] <> nil
         aGet[ 42 ]:hide()
      end

      if oSayLote <> nil
         oSayLote:Hide()
      end

      if aTmpPre[ 51 ] <= 1
         aGet[ 6 ]:cText( nIva( dbfIva, cDefIva() ) )
      end

   case nMode <> 1 .AND. empty( cCodArt )

      aGet[ 4    ]:hide()
      aGet[ 5]:hide()

      if aGet[ 22 ] <> nil
         aGet[ 22 ]:show()
      end

      if aGet[ 42 ] <> nil
         aGet[ 42 ]:hide()
      end

      if oSayLote <> nil
         oSayLote:hide()
      end

   case nMode <> 1 .AND. !empty( cCodArt )

      aGet[ 4     ]:show()
      aGet[ 5 ]:show()
      aGet[ 22  ]:hide()

      if aTmp[ 40 ]

         if !Empty( aGet[ 42 ] ) .AND. !Empty( oSayLote )
            aGet[ 42 ]:Show()
            oSayLote:Show()
         end

      else

        if !Empty( aGet[ 42 ] ) .AND. !Empty( oSayLote )
            aGet[ 42 ]:Hide()
            oSayLote:Hide()
        end

      end

      if oStkAct <> nil
         oStock:nPutStockActual( cCodArt, aTmp[ 36 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], aTmp[ 43 ], aTmp[ 33 ], oStkAct )
      end

   end

   if !Empty( oStkAct )

      if !uFieldEmpresa( "lNStkAct" )
         oStkAct:Show()
      else
         oStkAct:Hide()
      end

   end

   if !lTipMov()

      if aGet[ 31 ] <> nil
         aGet[ 31 ]:hide()
      end

      if oGet2 <> nil
         oGet2:hide()
      end

   end

   if !aTmp[ 68 ]

      if !Empty( aTmp[ 25 ] )

         if !Empty( aGet[27 ] )
            aGet[ 27 ]:Show()
            aGet[ 27 ]:lValid()
         end
         if !Empty( oSayPr1 )
            oSayPr1:Show()
            oSayPr1:SetText( retProp( aTmp[25], dbfPro ) )
         end
         if !Empty( oSayVp1 )
            oSayVp1:Show()
         end

      else

         if !Empty( aGet[27 ] )
            aGet[27 ]:hide()
         end
         if !Empty( oSayPr1 )
            oSayPr1:hide()
         end
         if !Empty( oSayVp1 )
            oSayVp1:hide()
         end

      end

      if !Empty( aTmp[ 26 ] )

         if !Empty( aGet[28 ] )
            aGet[ 28 ]:Show()
            aGet[ 28 ]:lValid()
         end

         if !Empty( oSayPr2 )
            oSayPr2:Show()
            oSayPr2:SetText( retProp(  aTmp[26], dbfPro ) )
         end

         if !Empty( oSayVp2 )
            oSayVp2:Show()
         end

      else

         if !Empty( aGet[28 ] )
            aGet[28 ]:hide()
         end
         if !Empty( oSayPr2 )
            oSayPr2:hide()
         end
         if !Empty( oSayVp2 )
            oSayVp2:hide()
         end

      end

   end





   if Empty( aTmp[ 73 ] )
      if !Empty( aGet[ 73 ] )
         aGet[ 73 ]:cText( aTmpPre[ 28 ] )
      else
         aTmp[ 73 ]     := aTmpPre[ 28 ]
      end
   end

   if !Empty( aGet[ 73 ] )
      if !uFieldEmpresa( "lPreLin" )
         aGet[ 73 ]:Hide()
      else
         aGet[ 73 ]:Show()
      end
   end





   if aGet[ 31 ] <> nil
      aGet[ 31 ]:lValid()
   end

   if aGet[ 36 ] <> nil
      aGet[ 36 ]:lValid()
   end

   aGet[ 4 ]:SetFocus()

   if !lAccArticulo() .OR. oUser():lNotCostos()

      if !Empty( aGet[ 34 ] )
         aGet[ 34 ]:Hide()
      end

   end





   if ( Empty( aTmp[ 11 ] ) .OR. lUsrMaster() .OR. oUser():lCambiarPrecio() ) .AND. nMode <> 3

      aGet[ 11 ]:HardEnable()
      aGet[ 14    ]:HardEnable()
      aGet[ 15 ]:HardEnable()

      if aGet[ 13 ] <> nil
         aGet[ 13 ]:HardEnable()
      end

      if aGet[ 12 ] <> nil
         aGet[ 12 ]:HardEnable()
      end

      if aGet[ 30 ] <> nil
         aGet[ 30 ]:HardEnable()
      end

   else

      aGet[ 11 ]:HardDisable()
      aGet[ 14    ]:HardDisable()
      aGet[ 15 ]:HardDisable()

      if aGet[ 13 ] <> nil
         aGet[ 13 ]:HardDisable()
      end

      if aGet[ 12 ] <> nil
         aGet[ 12 ]:HardDisable()
      end

      if aGet[ 30 ] <> nil
         aGet[ 30 ]:HardDisable()
      end

   end



   if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ] )
      aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:Hide()
   end

   if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ] )
      aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:Hide()
   end

   if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ] )
      aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:Hide()
   end

   if oUndMedicion:oDbf:Seek(  aTmp[ 18 ] )

      if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:Show()
      end

      if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:Show()
      end

      if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:Show()
      end

   end

Return nil



STATIC FUNCTION SaveDeta( aTmp, aTmpPre, aGet, oDlg2, oBrw, bmpImage, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGet2, oTotal, oSayLote, cCodArt, oBtn )

   local aXbyStr
   local aClo     := aClone( aTmp )
   local nRec     := ( dbfTmpLin )->( RecNo() )

   oBtn:SetFocus()

   if !aGet[ 4 ]:lValid()
      return nil
   end

   if !lMoreIva( aTmp[6] )
      return nil
   end

   if Empty( aTmp[ 36 ] ) .AND. !Empty( aTmp[ 4 ] )
      msgStop( "Código de almacén no puede estar vacío", "Atención" )
      Return nil
   end

   if !cAlmacen( aGet[ 36 ], dbfAlm )
      Return nil
   end

   if nMode == 1

      aTmp[4]    := cCodArt

      if aTmp[ 40 ]
         GraLotArt( aTmp[ 4 ], dbfArticulo, aTmp[ 42 ] )
      end





      aXbYStr                    := nXbYAtipica( aTmp[ 4 ], aTmpPre[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmpPre[ 5 ], dbfCliAtp )

      if aXbYStr[ 1 ] == 0





         if !aTmp[ 78 ]

            aXbyStr              := nXbYOferta( aTmp[ 4 ], aTmpPre[ 6 ], aTmpPre[ 63 ], aTmp[ 7 ], aTmp[ 8 ], aTmpPre[ 5 ], dbfOferta, 1 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 78 ]  := .T.
            end

         end





         if !aTmp[ 78 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "FAMILIA", "CODIGO" ), aTmpPre[ 6 ], aTmpPre[ 63 ], aTmp[ 7 ], aTmp[ 8 ], aTmpPre[ 5 ], dbfOferta, 2 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 78 ]  := .T.
            end

         end





         if !aTmp[ 78 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODTIP", "CODIGO" ), aTmpPre[ 6 ], aTmpPre[ 63 ], aTmp[ 7 ], aTmp[ 8 ], aTmpPre[ 5 ], dbfOferta, 3 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 78 ]  := .T.
            end

         end





         if !aTmp[ 78 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODCATE", "CODIGO" ), aTmpPre[ 6 ], aTmpPre[ 63 ], aTmp[ 7 ], aTmp[ 8 ], aTmpPre[ 5 ], dbfOferta, 4 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 78 ]  := .T.
            end

         end





         if !aTmp[ 78 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODTEMP", "CODIGO" ), aTmpPre[ 6 ], aTmpPre[ 63 ], aTmp[ 7 ], aTmp[ 8 ], aTmpPre[ 5 ], dbfOferta, 5 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 78 ]  := .T.
            end

         end





         if !aTmp[ 78 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 4 ], dbfArticulo, "CCODFAB", "CODIGO" ), aTmpPre[ 6 ], aTmpPre[ 63 ], aTmp[ 7 ], aTmp[ 8 ], aTmpPre[ 5 ], dbfOferta, 6 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 78 ]  := .T.
            end

         end

      end





      if aXbYStr[ 1 ] <> 0 .AND. aXbYStr[ 2 ] <> 0





         if aXbyStr[ 1 ] == 1





            aTmp[ 7  ] -= aXbyStr[ 2 ]

            WinGather( aTmp, , dbfTmpLin, oBrw, nMode, nil, .F. )

            if aClo[ 43 ]
               AppendKit( aClo, aTmpPre )
            end

            aTmp[ 7  ] := aXbYStr[ 2 ]
            aTmp[ 11  ] := 0

            WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )

            if aClo[ 43 ]
               AppendKit( aClo, aTmpPre )
            end

         else





            if aTmp[ 8 ] < 0
               aTmp[ 8 ] += aXbYStr[ 2 ]
            else
               aTmp[ 8 ] -= aXbYStr[ 2 ]
            end

            WinGather( aTmp, , dbfTmpLin, oBrw, nMode, nil, .F. )

            if aClo[ 43 ]
               AppendKit( aClo, aTmpPre )
            end

            if aTmp[ 8 ] < 0
               aTmp[ 8 ] := -( aXbYStr[ 2 ] )
            else
               aTmp[ 8 ] := aXbYStr[ 2 ]
            end

            aTmp[ 11  ] := 0

            WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )

            if aClo[ 43 ]
               AppendKit( aClo, aTmpPre )
            end

         end

      else





         WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )

         if aClo[ 43 ]
            AppendKit( aClo, aTmpPre )
         end

      end

   else

      aTmp[ 53 ]                    := nPReq( dbfIva, aTmp[ 6 ] )





      WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )

   end

   ( dbfTmpLin )->( dbGoTo( nRec ) )





   cOldCodArt                          := ""
   cOldUndMed                          := ""

   if !Empty( aGet[ 18 ] )
      aGet[ 18 ]:lValid()
   end





   if bmpImage <> nil
      bmpImage:Hide()

      if !Empty( bmpImage:hBitmap )
         PalBmpFree( bmpImage:hBitmap, bmpImage:hPalette )
      endif

   end

   if nMode == 1 .AND. lEntCon()

      nTotPreCli( nil, dbfPreCliT, dbfTmpLin, dbfIva, dbfDiv, dbfFPago, aTmpPre )

      SetDlgMode( aTmp, aGet, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGet2, oTotal, aTmpPre, oSayLote )

      SysRefresh()

      if !Empty( aGet[ 4 ] )
         aGet[ 4 ]:SetFocus()
      end

   else

      oDlg2:end( 1 )

   end

RETURN NIL



Static Function EdtInc( aTmp, aGet, dbfPreCliI, oBrw, bWhen, bValid, nMode, aTmpPre )

   local oDlg
   local oNomInci
   local cNomInci          := RetFld( aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], dbfInci )

   if nMode == 1
      aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]  := .T.
   end

   if ( "PDA" $ cParamsMain() )
   oDlg = TDialog():New(,,,,, "PRECLI_INC_PDA",, .F.,,,,,, .F.,,,,,, .F., )
   else
   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "incidencias de presupuestos a clientes", "INCIDENCIA",, .F.,,,,,, .F.,,,,,, .F., )
   end








      aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ]:= u ) }, oDlg,,, {||    ( cTipInci( aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], dbfInci, oNomInci ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwIncidencia( dbfInci, aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], oNomInci ) )}, nil, "LUPA",, )




      oNomInci := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, cNomInci, cNomInci:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )





      TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN ( oDlg:nResult == 1 )



Static Function EdtDoc( aTmp, aGet, dbfPreCliD, oBrw, bWhen, bValid, nMode, aTmpLin )

   local oDlg
   local oRuta
   local oNombre
   local oObservacion

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "documento de presupuesto a cliente", "DOCUMENTOS",, .F.,,,,,, .F.,,,,,, .F., )




      oNombre := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      oRuta := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oRuta:cText( cGetFile( "Doc ( *.* ) | " + "*.*", "Seleccione el nombre del fichero" ) ) )}, nil, "FOLDER",, )





      oObservacion := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



STATIC FUNCTION PrnSerie()

    local oDlg
   local oFmtDoc
   local cFmtDoc     := cFormatoDocumento( ( dbfPreCliT )->cSerPre, "nPreCli", dbfCount )
   local oSayFmt
   local cSayFmt
   local oSerIni
   local oSerFin
   local nRecno      := ( dbfPreCliT )->( recno() )
   local nOrdAnt     := ( dbfPreCliT )->( OrdSetFocus(1) )
   local cSerIni     := ( dbfPreCliT )->cSerPre
   local cSerFin     := ( dbfPreCliT )->cSerPre
   local nDocIni     := ( dbfPreCliT )->nNumPre
   local nDocFin     := ( dbfPreCliT )->nNumPre
   local cSufIni     := ( dbfPreCliT )->cSufPre
   local cSufFin     := ( dbfPreCliT )->cSufPre
   local oPrinter
   local cPrinter    := PrnGetName()
   local lCopiasPre  := .T.
   local lInvOrden   := .F.
   local oNumCop
   local nNumCop     := if( nCopiasDocumento( ( dbfPreCliT )->cSerPre, "nPreCli", dbfCount ) == 0, Max( Retfld( ( dbfPreCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( ( dbfPreCliT )->cSerPre, "nPreCli", dbfCount ) )

   if Empty( cFmtDoc )
      cFmtDoc           := cSelPrimerDoc( "RC" )
   end

   cSayFmt           := cNombreDoc( cFmtDoc )

   oDlg = TDialog():New(,,,, "Imprimir series de presupuestos", "IMPSERDOC",, .F.,,,,,, .F.,,,,,, .F., )









   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z"  )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )









   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z"  )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )





   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )



   TCheckBox():ReDefine( 500, { | u | If( PCount()==0, lInvOrden, lInvOrden:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 170, { | u | If( PCount()==0, lCopiasPre, lCopiasPre:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oNumCop := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, nNumCop, nNumCop:= u ) }, oDlg,, "999999999", {||    nNumCop > 0},,,,,, .F., {||     !lCopiasPre},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )







   oFmtDoc := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cFmtDoc, cFmtDoc:= u ) }, oDlg,,, {||    ( cDocumento( oFmtDoc, oSayFmt, dbfDoc ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oFmtDoc, oSayFmt, "RC" ) )}, nil, "LUPA",, )





   oSayFmt := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayFmt, cSayFmt:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 92, "Printer_pencil_16",,,,,{|| EdtDocumento( cFmtDoc ) }, oDlg, .F., , .F.,  )




   oPrinter := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cPrinter, cPrinter:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 161, "Printer_preferences_16",,,,,{|| PrinterPreferences( oPrinter ) }, oDlg, .F., , .F.,  )





   TButton():ReDefine( 1, {||(  StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, nil, lCopiasPre, nNumCop, lInvOrden ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, nil, lCopiasPre, nNumCop, lInvOrden ), oDlg:end( 1 ) } )

   oDlg:bStart := { || oSerIni:SetFocus() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   (dbfPreCliT)->( dbGoTo( nRecNo ) )
   (dbfPreCliT)->( ordSetFocus( nOrdAnt ) )

    oWndBrw:oBrw:refresh()

RETURN NIL



STATIC FUNCTION StartPrint( cFmtDoc, cDocIni, cDocFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden )

   local nCopyClient

   oDlg:disable()

   if ! lInvOrden

      if ( dbfPreCliT )->( dbSeek( cDocIni, .T. ) )



         while ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre >= cDocIni   .AND.  ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre <= cDocFin   .AND.  !( dbfPreCliT )->( Eof() )

               lChgImpDoc( dbfPreCliT )

            if lCopiasPre

               nCopyClient := if( nCopiasDocumento( ( dbfPreCliT )->cSerPre, "nPreCli", dbfCount ) == 0, Max( Retfld( ( dbfPreCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( ( dbfPreCliT )->cSerPre, "nPreCli", dbfCount ) )

               GenPreCli( 1, "Imprimiendo documento : " + ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre, cFmtDoc, cPrinter, nCopyClient )

            else

               GenPreCli( 1, "Imprimiendo documento : " + ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre, cFmtDoc, cPrinter, nNumCop )

            end

            ( dbfPreCliT )->( dbSkip() )

         end

      end

   else

      if ( dbfPreCliT )->( dbSeek( cDocFin ) )



         while ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre >= cDocIni   .AND. ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre <= cDocFin   .AND. !( dbfPreCliT )->( Bof() )

               lChgImpDoc( dbfPreCliT )

            if lCopiasPre

               nCopyClient := if( nCopiasDocumento( ( dbfPreCliT )->cSerPre, "nPreCli", dbfCount ) == 0, Max( Retfld( ( dbfPreCliT )->cCodCli, dbfClient, "CopiasF" ), 1 ), nCopiasDocumento( ( dbfPreCliT )->cSerPre, "nPreCli", dbfCount ) )

               GenPreCli( 1, "Imprimiendo documento : " + ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre, cFmtDoc, cPrinter, nCopyClient )

            else

               GenPreCli( 1, "Imprimiendo documento : " + ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre, cFmtDoc, cPrinter, nNumCop )

            end

            ( dbfPreCliT )->( dbSkip( -1 ) )

         end

      end

   end

   oDlg:enable()

RETURN NIL



FUNCTION nTotPreCli( cPresupuesto, cPreCliT, cPreCliL, cIva, cDiv, cFPago, aTmp, cDivRet, lPic, cDbfClient )

    local nRecno
    local cCodDiv
   local bCondition
    local nTotalArt
    local nDtoEsp
    local nDtoPP
    local nDtoUno
    local nDtoDos
   local nDtoAtp
   local nSbrAtp
   local dFecFac
   local lIvaInc
   local nIvaMan
   local nKgsTrn
   local lPntVer           := .F.
   local nManObr           := 0
   local nTotalLin         := 0
   local nTotalUnd         := 0
   local aTotalDto         := { 0, 0, 0 }
   local aTotalDPP         := { 0, 0, 0 }
   local aTotalUno         := { 0, 0, 0 }
   local aTotalDos         := { 0, 0, 0 }
   local aTotalAtp         := { 0, 0, 0 }
   local lRecargo
   local nTotAcu           := 0
   local n
   local nDescuentosLineas := 0

   IIF( cPreCliT == nil, cPreCliT := dbfPreCliT, ) ;
   IIF( cPreCliL == nil, cPreCliL := dbfPreCliL, ) ;
   IIF( cDbfClient == nil, cDbfClient := dbfClient, ) ;
   IIF( cIva == nil, cIva := dbfIva, ) ;
   IIF( cDiv == nil, cDiv := dbfDiv, ) ;
   IIF( cFPago == nil, cFPago := dbfFPago, ) ;
   IIF( cPresupuesto == nil, cPresupuesto := ( cPreCliT )->cSerPre + Str( ( cPreCliT )->nNumPre ) + ( cPreCliT )->cSufPre, ) ;
   IIF( lPic == nil, lPic := .F., ) ;

   if Empty( Select( cPreCliT ) )
      Return ( 0 )
   end

   if Empty( Select( cPreCliL ) )
      Return ( 0 )
   end

   if Empty( Select( cIva ) )
      Return ( 0 )
   end

   if Empty( Select( cDiv ) )
      Return ( 0 )
   end

   public nTotBrt    := 0
   public nTotPre    := 0
   public nTotDto    := 0
   public nTotDPP    := 0
   public nTotNet    := 0
   public nTotIvm    := 0
   public nTotIva    := 0
   public nTotReq    := 0
   public nTotAge    := 0
   public nTotUno    := 0
   public nTotDos    := 0
   public nTotPnt    := 0
   public nTotTrn    := 0
   public nTotCos    := 0
   public nTotRnt    := 0
   public nTotAtp    := 0
   public nTotPes    := 0
   public nPctRnt    := 0
   public nTotDif    := 0
   public nTotUnd    := 0

   public aTotIva    := { { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0 } }
   public aIvaUno    := aTotIva[ 1 ]
   public aIvaDos    := aTotIva[ 2 ]
   public aIvaTre    := aTotIva[ 3 ]

   public aTotIvm    := { { 0,nil,0 }, { 0,nil,0 }, { 0,nil,0 }, }
   public aIvmUno    := aTotIvm[ 1 ]
   public aIvmDos    := aTotIvm[ 2 ]
   public aIvmTre    := aTotIvm[ 3 ]

   public aImpVto    := {}
   public aDatVto    := {}

   public nNumArt    := 0
   public nNumCaj    := 0

   public nTotalDto  := 0

   public cCtaCli    := cClientCuenta( ( cPreCliT )->cCodCli )

   nRecno            := ( cPreCliL )->( RecNo() )

   if aTmp <> nil
        lRecargo            := aTmp[ 42]
        nDtoEsp            := aTmp[ 30 ]
        nDtoPP            := aTmp[ 32    ]
        nDtoUno            := aTmp[ 34 ]
        nDtoDos            := aTmp[ 36 ]
      cCodDiv        := aTmp[ 46 ]
        nVdvDiv            := aTmp[ 47 ]
      dFecFac        := aTmp[ 5 ]
      lIvaInc        := aTmp[ 52 ]
      nIvaMan        := aTmp[ 53 ]
      nManObr        := aTmp[ 54 ]
      nDtoAtp        := aTmp[ 68 ]
      nSbrAtp        := aTmp[ 69 ]
      nKgsTrn        := aTmp[ 56 ]
      lPntVer        := aTmp[ 80 ]
      bCondition     := {|| !( cPreCliL )->( eof() ) }
      ( cPreCliL )->( dbGoTop() )
   else
      lRecargo       := ( cPreCliT )->lRecargo
      nDtoEsp        := ( cPreCliT )->nDtoEsp
      nDtoPP         := ( cPreCliT )->nDpp
      nDtoUno        := ( cPreCliT )->nDtoUno
      nDtoDos        := ( cPreCliT )->nDtoDos
      cCodDiv        := ( cPreCliT )->cDivPre
      nVdvDiv        := ( cPreCliT )->nVdvPre
      dFecFac        := ( cPreCliT )->dFecPre
      nIvaMan        := ( cPreCliT )->nIvaMan
      lIvaInc        := ( cPreCliT )->lIvaInc
      nManObr        := ( cPreCliT )->nManObr
      nDtoAtp        := ( cPreCliT )->nDtoAtp
      nSbrAtp        := ( cPreCliT )->nSbrAtp
      nKgsTrn        := ( cPreCliT )->nKgsTrn
      lPntVer        := ( cPreCliT )->lOperPV
      bCondition     := {|| ( cPreCliL )->cSerPre + Str( ( cPreCliL )->nNumPre ) + ( cPreCliL )->cSufPre == cPresupuesto .AND. !( cPreCliL )->( eof() ) }
      ( cPreCliL )->( dbSeek( cPresupuesto ) )
   end





   cPouDiv           := cPouDiv( cCodDiv, cDiv )
   cPorDiv           := cPorDiv( cCodDiv, cDiv )
   cPpvDiv           := cPpvDiv( cCodDiv, cDiv )
   nDouDiv           := nDouDiv( cCodDiv, cDiv )
   nRouDiv           := nRouDiv( cCodDiv, cDiv )
   nDpvDiv           := nDpvDiv( cCodDiv, cDiv )

    WHILE Eval( bCondition )

      if lValLine( cPreCliL )

         if ( cPreCliL )->lTotLin





            if ( cPreCliL )->nPreDiv <> nTotalLin .OR. ( cPreCliL )->nUniCaja <> nTotalUnd

               if ( cPreCliL )->( dbRLock() )
                  ( cPreCliL )->nPreDiv    := nTotalLin
                  ( cPreCliL )->nUniCaja   := nTotalUnd
                  ( cPreCliL )->( dbUnLock() )
               end

            end





            nTotalLin         := 0
            nTotalUnd         := 0

         else

            nTotArt           := nTotLPreCli( cPreCliT, cPreCliL, nDouDiv, nRouDiv, , , .F., .F. )
            nTotPnt           := if( lPntVer, nPntLPreCli( cPreCliL, nDpvDiv ), 0 )
            nTotTrn           := nTrnLPreCli( cPreCliL, nDouDiv )
            nTotIvm           := nTotIPreCli( cPreCliL, nDouDiv, nRouDiv )
            nTotCos           += nTotCPreCli( cPreCliL, nDouDiv, nRouDiv )
            nTotPes           += nPesLPreCli( cPreCliL )
            nDescuentosLineas += nTotDtoLPreCli( cPreCliL, nDouDiv )

            if aTmp <> nil
               nTotAge        += nComLPreCli( aTmp, cPreCliL, nDouDiv, nRouDiv )
            else
               nTotAge        += nComLPreCli( cPreCliT, cPreCliL, nDouDiv, nRouDiv )
            end

            nNumArt           += nTotNPreCli( cPreCliL )
            nNumCaj           += ( cPreCliL )->nCanPre





            nTotUnd           += nTotNPreCli( cPreCliL )





            DO CASE
            CASE aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 1, 3 ] == ( cPreCliL )->nIva
               aTotIva[ 1, 3 ]      := ( cPreCliL )->nIva
               aTotIva[ 1, 4 ]      := ( cPreCliL )->nReq
               aTotIva[ 1, 1 ]      += nTotArt
               aTotIva[ 1, 6 ]      += nTotIvm
               aTotIva[ 1, 7 ]      += nTotTrn
               aTotIva[ 1, 5 ]      += nTotPnt

            CASE aTotIva[ 2, 3 ] == NIL .OR. aTotIva[ 2, 3 ] == ( cPreCliL )->nIva
               aTotIva[ 2, 3 ]      := ( cPreCliL )->nIva
               aTotIva[ 2, 4 ]      := ( cPreCliL )->nReq
               aTotIva[ 2, 1 ]      += nTotArt
               aTotIva[ 2, 6 ]      += nTotIvm
               aTotIva[ 2, 7 ]      += nTotTrn
               aTotIva[ 2, 5 ]      += nTotPnt

            CASE aTotIva[ 3, 3 ] == NIL .OR. aTotIva[ 3, 3 ] == ( cPreCliL )->nIva
               aTotIva[ 3, 3 ]      := ( cPreCliL )->nIva
               aTotIva[ 3, 4 ]      := ( cPreCliL )->nReq
               aTotIva[ 3, 1 ]      += nTotArt
               aTotIva[ 3, 6 ]      += nTotIvm
               aTotIva[ 3, 7 ]      += nTotTrn
               aTotIva[ 3, 5 ]      += nTotPnt

            end




            if ( cPreCliL )->nValImp <> 0

               do case
                  case aTotIvm[ 1, 2 ] == nil .OR. aTotIvm[ 1, 2 ] == ( cPreCliL )->nValImp
                     aTotIvm[ 1, 1 ]      += nTotNPreCli( cPreCliL ) * if( ( cPreCliL )->lVolImp, NotCero( ( cPreCliL )->nVolumen ), 1 )
                     aTotIvm[ 1, 2 ]      := ( cPreCliL )->nValImp
                     aTotIvm[ 1, 3 ]      := aTotIvm[ 1, 1 ] * aTotIvm[ 1, 2 ]

                  case aTotIvm[ 2, 2 ] == nil .OR. aTotIvm[ 2, 2 ] == ( cPreCliL )->nValImp
                     aTotIvm[ 2, 1 ]      += nTotNPreCli( cPreCliL ) * if( ( cPreCliL )->lVolImp, NotCero( ( cPreCliL )->nVolumen ), 1 )
                     aTotIvm[ 2, 2 ]      := ( cPreCliL )->nValImp
                     aTotIvm[ 2, 3 ]      := aTotIvm[ 2, 1 ] * aTotIvm[ 2, 2 ]

                  case aTotIvm[ 3, 2 ] == nil .OR. aTotIvm[ 3, 2 ] == ( cPreCliL )->nValImp
                     aTotIvm[ 3, 1 ]      += nTotNPreCli( cPreCliL ) * if( ( cPreCliL )->lVolImp, NotCero( ( cPreCliL )->nVolumen ), 1 )
                     aTotIvm[ 3, 2 ]      := ( cPreCliL )->nValImp
                     aTotIvm[ 3, 3 ]      := aTotIvm[ 3, 1 ] * aTotIvm[ 3, 2 ]

               end

            end

         end

      end

      ( cPreCliL )->( dbSkip() )

   end

   ( cPreCliL )->( dbGoto( nRecno ) )





   aTotIva           := aSort( aTotIva,,, {|x,y| if( x[3] <> nil, x[3], -1 ) > if( y[3] <> nil, y[3], -1 )  } )

   aTotIva[ 1, 2 ]         := Round( aTotIva[ 1, 1 ], nRouDiv )
   aTotIva[ 2, 2 ]         := Round( aTotIva[ 2, 1 ], nRouDiv )
   aTotIva[ 3, 2 ]         := Round( aTotIva[ 3, 1 ], nRouDiv )

   nTotBrt           := aTotIva[ 1, 1 ] + aTotIva[ 2, 1 ] + aTotIva[ 3, 1 ]







   if nSbrAtp <= 1 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end





    IF nDtoEsp     <> 0

      aTotalDto[1]   := Round( aTotIva[ 1, 2 ] * nDtoEsp / 100, nRouDiv )
      aTotalDto[2]   := Round( aTotIva[ 2, 2 ] * nDtoEsp / 100, nRouDiv )
      aTotalDto[3]   := Round( aTotIva[ 3, 2 ] * nDtoEsp / 100, nRouDiv )

      nTotDto        := aTotalDto[1] + aTotalDto[2] + aTotalDto[3]

        aTotIva[ 1, 2 ]        -= aTotalDto[1]
        aTotIva[ 2, 2 ]        -= aTotalDto[2]
        aTotIva[ 3, 2 ]        -= aTotalDto[3]

    end





   if nSbrAtp == 2 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end





    IF nDtoPP    <> 0

      aTotalDPP[1]   := Round( aTotIva[ 1, 2 ] * nDtoPP / 100, nRouDiv )
      aTotalDPP[2]   := Round( aTotIva[ 2, 2 ] * nDtoPP / 100, nRouDiv )
      aTotalDPP[3]   := Round( aTotIva[ 3, 2 ] * nDtoPP / 100, nRouDiv )

      nTotDPP        := aTotalDPP[1] + aTotalDPP[2] + aTotalDPP[3]

        aTotIva[ 1, 2 ]        -= aTotalDPP[1]
        aTotIva[ 2, 2 ]        -= aTotalDPP[2]
        aTotIva[ 3, 2 ]        -= aTotalDPP[3]

    end





   if nSbrAtp == 3 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end

    IF nDtoUno <> 0

      aTotalUno[1]   := Round( aTotIva[ 1, 2 ] * nDtoUno / 100, nRouDiv )
      aTotalUno[2]   := Round( aTotIva[ 2, 2 ] * nDtoUno / 100, nRouDiv )
      aTotalUno[3]   := Round( aTotIva[ 3, 2 ] * nDtoUno / 100, nRouDiv )

      nTotUno        := aTotalUno[1] + aTotalUno[2] + aTotalUno[3]

        aTotIva[ 1, 2 ]        -= aTotalUno[1]
        aTotIva[ 2, 2 ]        -= aTotalUno[2]
        aTotIva[ 3, 2 ]        -= aTotalUno[3]

    end





   if nSbrAtp == 4 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end

    IF nDtoDos <> 0

      aTotalDos[1]   := Round( aTotIva[ 1, 2 ] * nDtoDos / 100, nRouDiv )
      aTotalDos[2]   := Round( aTotIva[ 2, 2 ] * nDtoDos / 100, nRouDiv )
      aTotalDos[3]   := Round( aTotIva[ 3, 2 ] * nDtoDos / 100, nRouDiv )

      nTotDos        := aTotalDos[1] + aTotalDos[2] + aTotalDos[3]

        aTotIva[ 1, 2 ]        -= aTotalDos[1]
        aTotIva[ 2, 2 ]        -= aTotalDos[2]
        aTotIva[ 3, 2 ]        -= aTotalDos[3]

    end





   if nSbrAtp == 5 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end





   if nManObr <> 0

      do case
      case aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 1, 3 ] == nIvaMan

         aTotIva[ 1, 3 ]   := nIvaMan
         aTotIva[ 1, 2 ]   += nManObr

      case aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 2, 3 ] == nIvaMan

         aTotIva[ 2, 3 ]   := nIvaMan
         aTotIva[ 2, 2 ]   += nManObr

      case aTotIva[ 3, 3 ] == nil .OR. aTotIva[ 3, 3 ] == nIvaMan

         aTotIva[ 3, 3 ]   := nIvaMan
         aTotIva[ 3, 2 ]   += nManObr

      end

   end





   aTotIva[ 1, 2 ]         += aTotIva[ 1, 7 ]
   aTotIva[ 2, 2 ]         += aTotIva[ 2, 7 ]
   aTotIva[ 3, 2 ]         += aTotIva[ 3, 7 ]





   aTotIva[ 1, 2 ]         += aTotIva[ 1, 5 ]
   aTotIva[ 2, 2 ]         += aTotIva[ 2, 5 ]
   aTotIva[ 3, 2 ]         += aTotIva[ 3, 5 ]





   aTotIva[ 1, 2 ]         += aTotIva[ 1, 6 ]
   aTotIva[ 2, 2 ]         += aTotIva[ 2, 6 ]
   aTotIva[ 3, 2 ]         += aTotIva[ 3, 6 ]

   if !lIvaInc





      aTotIva[ 1, 8 ]      := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 3 ] / 100, nRouDiv ), 0 )
      aTotIva[ 2, 8 ]      := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 3 ] / 100, nRouDiv ), 0 )
      aTotIva[ 3, 8 ]      := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 3 ] / 100, nRouDiv ), 0 )





      if lRecargo
         aTotIva[ 1, 9 ]   := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 4 ] / 100, nRouDiv ), 0 )
         aTotIva[ 2, 9 ]   := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 4 ] / 100, nRouDiv ), 0 )
         aTotIva[ 3, 9 ]   := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 4 ] / 100, nRouDiv ), 0 )
      end

      aTotIva[ 1, 2 ]      -= aTotIva[ 1, 6 ]
      aTotIva[ 2, 2 ]      -= aTotIva[ 2, 6 ]
      aTotIva[ 3, 2 ]      -= aTotIva[ 3, 6 ]

   else

      if aTotIva[ 1, 3 ] <> 0
         aTotIva[ 1, 8 ]   := if( aTotIva[ 1, 3 ] <> nil, Round( aTotIva[ 1, 2 ] / ( 100 / aTotIva[ 1, 3 ] + 1 ), nRouDiv ), 0 )
      end
      if aTotIva[ 2, 3 ] <> 0
         aTotIva[ 2, 8 ]   := if( aTotIva[ 2, 3 ] <> nil, Round( aTotIva[ 2, 2 ] / ( 100 / aTotIva[ 2, 3 ] + 1 ), nRouDiv ), 0 )
      end
      if aTotIva[ 3, 3 ] <> 0
         aTotIva[ 3, 8 ]   := if( aTotIva[ 3, 3 ] <> nil, Round( aTotIva[ 3, 2 ] / ( 100 / aTotIva[ 3, 3 ] + 1 ), nRouDiv ), 0 )
      end

      if lRecargo
         if aTotIva[ 1, 4 ] <> 0
            aTotIva[ 1, 9 ]   := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] / ( 100 / aTotIva[ 1, 4 ] + 1 ), nRouDiv ), 0 )
         end
         if aTotIva[ 3, 4 ] <> 0
            aTotIva[ 2, 9 ]   := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] / ( 100 / aTotIva[ 2, 4 ] + 1 ), nRouDiv ), 0 )
         end
         if aTotIva[ 3, 4 ] <> 0
            aTotIva[ 3, 9 ]   := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] / ( 100 / aTotIva[ 3, 4 ] + 1 ), nRouDiv ), 0 )
         end
      end

      aTotIva[ 1, 2 ]      -= aTotIva[ 1, 8 ]
      aTotIva[ 2, 2 ]      -= aTotIva[ 2, 8 ]
      aTotIva[ 3, 2 ]      -= aTotIva[ 3, 8 ]

      aTotIva[ 1, 2 ]      -= aTotIva[ 1, 9 ]
      aTotIva[ 2, 2 ]      -= aTotIva[ 2, 9 ]
      aTotIva[ 3, 2 ]      -= aTotIva[ 3, 9 ]

   end





   nTotNet           := Round( aTotIva[ 1, 2 ] + aTotIva[ 2, 2 ] + aTotIva[ 3, 2 ], nRouDiv )





   if nKgsTrn <> 0
      nTotDif        := nKgsTrn - nTotPes
   else
      nTotDif        := 0
   end





   nTotIvm           := Round( aTotIvm[ 1, 3 ] + aTotIvm[ 2, 3 ] + aTotIvm[ 3, 3 ], nRouDiv )





   nTotTrn           := Round( aTotIva[ 1, 7 ] + aTotIva[ 2, 7 ] + aTotIva[ 3, 7 ], nRouDiv )





   nTotPnt           := Round( aTotIva[ 1, 5 ] + aTotIva[ 2, 5 ] + aTotIva[ 3, 5 ], nRouDiv )





   nTotIva           := Round( aTotIva[ 1, 8 ] + aTotIva[ 2, 8 ] + aTotIva[ 3, 8 ], nRouDiv )





   nTotReq           := Round( aTotIva[ 1, 9 ] + aTotIva[ 2, 9 ] + aTotIva[ 3, 9 ], nRouDiv )





   nTotImp           := nTotIva + nTotReq + nTotIvm





   nTotRnt           := Round(  nTotNet - nManObr - nTotAge - nTotPnt - nTotAtp - nTotCos, nRouDiv )

   nPctRnt           := nRentabilidad( nTotNet - nManObr - nTotAge - nTotPnt, nTotAtp, nTotCos )





   nTotPre           := nTotNet + nTotImp





   nTotalDto         := nDescuentosLineas + nTotDto + nTotDpp + nTotUno + nTotDos + nTotAtp
























   ( cPreCliL )->( dbGoTo( nRecno) )





   if cDivRet <> nil .AND. cDivRet <> cCodDiv
      nTotNet     := nCnv2Div( nTotNet, cCodDiv, cDivRet, cDiv )
      nTotIvm     := nCnv2Div( nTotIvm, cCodDiv, cDivRet, cDiv )
      nTotIva     := nCnv2Div( nTotIva, cCodDiv, cDivRet, cDiv )
      nTotReq     := nCnv2Div( nTotReq, cCodDiv, cDivRet, cDiv )
      nTotPre     := nCnv2Div( nTotPre, cCodDiv, cDivRet, cDiv )
      nTotPnt     := nCnv2Div( nTotPnt, cCodDiv, cDivRet, cDiv )
      nTotTrn     := nCnv2Div( nTotTrn, cCodDiv, cDivRet, cDiv )
      cPorDiv     := cPorDiv( cDivRet, cDiv )
   end

RETURN ( if( lPic, Trans( nTotPre, cPorDiv ), nTotPre ) )



STATIC FUNCTION RecalculaTotal( aTmp )

   nTotPreCli( nil, dbfPreCliT, dbfTmpLin, dbfIva, dbfDiv, dbfFPago, aTmp )





   aTotIva     := aSort( aTotIva,,, {|x,y| x[1] > y[1] } )

   if oBrwIva  <> nil
      oBrwIva:Refresh()
   end





   if oGetNet <> nil
      oGetNet:SetText( Trans( nTotNet, cPorDiv ) )
   end

   if oGetIvm <> nil
      oGetIvm:SetText( Trans( nTotIvm, cPorDiv ) )
   end

   if oGetRnt <> nil
      oGetRnt:cText( AllTrim( Trans( nTotRnt, cPorDiv ) + Space( 1 ) + AllTrim( cSimDiv( aTmp[ 46 ], dbfDiv ) ) + " : " + AllTrim( Trans( nPctRnt, "999.99" ) ) + "%" ) )
   end

   IF oGetIva <> nil
      oGetIva:SetText( Trans( nTotIva, cPorDiv ) )
   end

   if oGetReq <> nil
      oGetReq:SetText( Trans( nTotReq, cPorDiv ) )
   end

   if oGetPnt <> nil
      oGetPnt:SetText( Trans( nTotPnt, cPorDiv ) )
   end

   if oGetTrn <> nil
      oGetTrn:SetText( Trans( nTotTrn, cPorDiv ) )
   end

   if oGetTotal <> nil
      oGetTotal:SetText( Trans( nTotPre, cPorDiv ) )
   end

   if oGetAge <> nil
      oGetAge:SetText( Trans( nTotAge, cPorDiv ) )
   end

   if oGetPes <> nil
      oGetPes:cText( nTotPes )
   end

   if oGetDif <> nil
      oGetDif:cText( nTotDif )
   end

Return .T.



FUNCTION aTotPreCli( cPre, dbfMaster, dbfLine, dbfIva, dbfDiv, dbfFPago, cDivRet )

   nTotPreCli( cPre, dbfMaster, dbfLine, dbfIva, dbfDiv, dbfFPago, nil, cDivRet )

RETURN ( { nTotNet, nTotIva, nTotReq, nTotPre, nTotPnt, nTotTrn, nTotAge, nTotCos } )



STATIC FUNCTION LoaArt( aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, lFocused )

    local nDtoAge
   local nImpAtp
   local nImpOfe
   local nCosPro
   local cCodFam
   local cCodArt     := aGet[ 4 ]:VarGet()
   local cPrpArt
   local nPrePro     := 0
   local nPosComa
   local cProveedor
   local nTarOld     := aTmp[ 73 ]
   local lChgCodArt  := ( Empty( cOldCodArt ) .OR. Rtrim( cOldCodArt ) <> Rtrim( cCodArt ) )
   local nNumDto     := 0

   IIF( lFocused == nil, lFocused := .T., ) ;

   if Empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir lineas sin codificar" )
         return .F.
      end

      if Empty( aTmp[ 6 ] )
         aGet[ 6 ]:bWhen     := {|| .T. }
      end

      aGet[ 5 ]:Hide()

      if !Empty( aGet[ 22 ] )
          aGet[ 22 ]:Show()
      end

      if lFocused .AND. !Empty( aGet[ 22 ] )
        aGet[ 22 ]:SetFocus()
      end

   else

      if lModIva()
         aGet[6    ]:bWhen   := {|| .T. }
      else
         aGet[6    ]:bWhen   := {|| .F. }
      end

        aGet[5]:show()

      if aGet[22 ] <> nil
         aGet[22 ]:hide()
      end





      if "," $ cCodArt
         nPosComa                := At( ",", cCodArt )
         cProveedor              := RJust( Left( cCodArt, nPosComa - 1 ), "0", RetNumCodPrvEmp() )
         cCodArt                 := cSeekProveedor( cCodArt, dbfArtPrv )
      else
         cCodArt                 := cSeekCodebar( cCodArt, dbfCodebar, dbfArticulo )
      end





      if ( dbfArticulo )->( dbSeek( cCodArt ) ) .OR. ( dbfArticulo )->( dbSeek( Upper( cCodArt ) ) )

         if ( dbfArticulo )->lObs
            MsgStop( "Artículo catalogado como obsoleto" )
            return .F.
         end

         if ( lChgCodArt )

            cCodArt := ( dbfArticulo )->Codigo

            aTmp[ 4 ]        := cCodArt
            aGet[ 4 ]:cText( cCodArt )

            if ( dbfArticulo )->lMosCom .AND. !Empty( ( dbfArticulo )->mComent )
               MsgStop( Trim( ( dbfArticulo )->mComent ) )
            end

            if !Empty( cProveedor )
               aTmp[ 55 ]  := cProveedor
               aTmp[ 56 ]  := AllTrim( RetProvee( cProveedor ) )
               aTmp[ 62 ]  := Padr( cRefPrvArt( cCodArt, Padr( cProveedor, 12 ) , dbfArtPrv ), 18 )

if ( IsMuebles() )
               aGet[ 55 ]:cText( cProveedor )
               aGet[ 56 ]:cText( AllTrim( RetProvee( cProveedor ) ) )
               aGet[ 62 ]:cText( Padr( cRefPrvArt( cCodArt, Padr( cProveedor, 12 ) , dbfArtPrv ), 18 ) )
end

            else
               aTmp[ 55 ]  := (dbfArticulo)->cPrvHab
               aTmp[ 56 ]  := AllTrim( RetProvee( (dbfArticulo)->cPrvHab ) )
               aTmp[ 62 ]  := Padr( cRefPrvArt( cCodArt, ( dbfArticulo )->cPrvHab , dbfArtPrv ), 18 )

if ( IsMuebles() )
               aGet[ 55 ]:cText( (dbfArticulo)->cPrvHab )
               aGet[ 56 ]:cText( AllTrim( RetProvee( (dbfArticulo)->cPrvHab ) ) )
               aGet[ 62 ]:cText( Padr( cRefPrvArt( cCodArt, ( dbfArticulo )->cPrvHab , dbfArtPrv ), 18 ) )
end

            end






            if ( dbfArticulo )->lLote

               if oSayLote <> nil
                  oSayLote:Show()
               end

               if aGet[ 42 ] <> nil
                  aGet[ 42 ]:show()
               end

               if aGet[ 42 ] <> nil
                  aGet[ 42 ]:cText( ( dbfArticulo )->cLote )
               else
                  aTmp[ 42 ] := ( dbfArticulo )->cLote
               end

               aTmp[ 40 ]    := ( dbfArticulo )->lLote

            else

               if oSayLote <> nil
                  oSayLote:hide()
               end

               if aGet[ 42 ] <> nil
                  aGet[ 42 ]:hide()
               end

            end

            aTmp[40   ]      := ( dbfArticulo )->lLote





            aTmp[47 ]      := ( dbfArticulo )->lMsgVta
            aTmp[48 ]      := ( dbfArticulo )->lNotVta

            cCodFam              := ( dbfArticulo )->Familia

            if !Empty( cCodFam )

               if aGet[ 51 ] <> nil
                  aGet[ 51 ]:cText( cCodFam )
                  aGet[ 51 ]:lValid()
               else
                  aTmp[ 51 ]  := cCodFam
               end

               if aGet[ 52 ] <> nil
                  aGet[ 52 ]:cText( cGruFam( cCodFam, dbfFamilia ) )
                  aGet[ 52 ]:lValid()
               else
                  aTmp[ 52 ]  := cGruFam( cCodFam, dbfFamilia )
               end

               if aGet[ 75 ] <> nil
                  aGet[ 75 ]:cText( cCodFra( cCodFam, dbfFamilia ) )
                  aGet[ 75 ]:lValid()
               else
                  aTmp[ 75 ]  := cCodFra( cCodFam, dbfFamilia )
               end

            else

               if aGet[ 51 ] <> nil
                  aGet[ 51 ]:cText( Space( 8 ) )
                  aGet[ 51 ]:lValid()
               end

               if aGet[ 52 ] <> nil
                  aGet[ 52 ]:cText( Space( 3 ) )
                  aGet[ 52 ]:lValid()
               end

               if aGet[ 75 ] <> nil
                  aGet[ 75 ]:cText( Space( 3 ) )
                  aGet[ 75 ]:lValid()
               end

            end





            if !Empty( aGet[ 77 ] )
               aGet[ 77 ]:cText( ( dbfArticulo )->Descrip )
            else
               aTmp[ 77 ]     := ( dbfArticulo )->Descrip
            end





            if ( dbfArticulo )->nCajEnt <> 0
               if  aGet[ 7 ] <> nil
                   aGet[ 7 ]:cText( ( dbfArticulo )->nCajEnt )
               else
                   aTmp[ 7 ] := ( dbfArticulo )->nCajEnt

               end
            end

            if ( dbfArticulo )->nUniCaja <> 0
               if aGet[ 8 ] <> nil
                  aGet[ 8 ]:cText( ( dbfArticulo )->nUniCaja )
               else
                  aTmp[ 8 ] := ( dbfArticulo )->nUniCaja
               end
            end





            if aTmpPre[ 51 ] <= 1

               if aGet[ 6 ] <> nil
                  aGet[ 6 ]:cText( nIva( dbfIva, ( dbfArticulo )->TipoIva ) )
               else
                  aTmp[ 6 ] := nIva( dbfIva, ( dbfArticulo )->TipoIva )
               end

               aTmp[ 53 ]     := nReq( dbfIva, ( dbfArticulo )->TipoIva )

            end

            if aGet[ 5 ] <> nil
               aGet[ 5 ]:cText( ( dbfArticulo )->Nombre )
            else
               aTmp[ 5 ] := ( dbfArticulo )->Nombre
            end

            if aGet[ 22 ] <> nil
               aGet[ 22 ]:cText( ( dbfArticulo )->Descrip )
            else
               aTmp[ 22 ]  := ( dbfArticulo )->Descrip
            end





            if ( dbfArticulo )->lKitArt
               aTmp[ 43 ]        := .T.
               aTmp[ 24 ]        := lImprimirCompuesto( ( dbfArticulo )->Codigo, dbfArticulo )
               aTmp[ 45 ]        := lPreciosCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )

               if lStockCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )
                  if aGet[ 33 ] <> nil
                     aGet[ 33 ]:SetOption( ( dbfArticulo )->nCtlStock )
                  else
                     aTmp[ 33 ]  := ( dbfArticulo )->nCtlStock
                  end
               else
                  if aGet[ 33 ] <> nil
                     aGet[ 33 ]:SetOption( 3 )
                  else
                     aTmp[ 33 ]  := 3
                  end
               end

            else

               aTmp[ 24 ]        := .F.
               if aGet[ 33 ] <> nil
                  aGet[ 33 ]:SetOption( ( dbfArticulo )->nCtlStock )
               else
                  aTmp[ 33 ]     := ( dbfArticulo )->nCtlStock
               end

            end





            if !Empty( ( dbfArticulo )->cCodImp )
               aTmp[ 38 ]     := ( dbfArticulo )->cCodImp

               if aGet[ 39 ] <> nil
                  aGet[ 39 ]:cText( oNewImp:nValImp( ( dbfArticulo )->cCodImp, aTmpPre[ 52 ], aTmp[ 6 ] ) )
               else
                  aTmp[ 39 ]  := oNewImp:nValImp( ( dbfArticulo )->cCodImp, aTmpPre[ 52 ], aTmp[ 6 ] )
               end

               aTmp[ 79 ]     := RetFld( ( dbfArticulo )->cCodImp, oNewImp:oDbf:cAlias, "lIvaVol" )

            end





            if !Empty( ( dbfArticulo )->cCodFra )

               if aGet[ 75 ] <> nil
                  aGet[ 75 ]:cText( ( dbfArticulo )->cCodFra )
                  aGet[ 75 ]:lValid()
               else
                  aTmp[ 75 ]  := ( dbfArticulo )->cCodFra
               end

            end





            aTmp[25 ]         := ( dbfArticulo )->cCodPrp1
            aTmp[26 ]         := ( dbfArticulo )->cCodPrp2

            if !Empty( aTmp[ 25 ] )

               if aGet[ 27 ] <> nil
                  aGet[ 27 ]:Show()
                  if lFocused
                     aGet[ 27 ]:SetFocus()
                  end
               end

               if oSayPr1 <> nil
                  oSayPr1:SetText( retProp( ( dbfArticulo )->cCodPrp1, dbfPro ) )
                  oSayPr1:show()
               end

               if oSayVp1 <> nil
                  oSayVp1:SetText( "" )
                  oSayVp1:Show()
               end

            else

               if aGet[ 27 ] <>  nil
                  aGet[ 27 ]:hide()
               end

               if oSayPr1 <> nil
                  oSayPr1:Hide()
               end

               if oSayVp1 <> nil
                  oSayVp1:Hide()
               end

            end

            if !Empty( aTmp[ 26 ] )

               if aGet[ 28 ] <> nil
                  aGet[ 28 ]:show()
               end

               if oSayPr2 <> nil
                  oSayPr2:SetText( retProp( ( dbfArticulo )->cCodPrp2, dbfPro ) )
                  oSayPr2:Show()
               end

               if oSayVp2 <> nil
                  oSayVp2:SetText( "" )
                  oSayVp2:Show()
               end

            else

               if aGet[ 28 ] <> nil
                  aGet[ 28 ]:hide()
               end

               if oSayPr2 <> nil
                  oSayPr2:hide()
               end

               if oSayVp2 <> nil
                  oSayVp2:hide()
               end

            end





            if aGet[ 46 ] <> nil
               aGet[ 46 ]:cText( ( dbfArticulo )->nMesGrt )
            else
               aTmp[ 46 ]  := ( dbfArticulo )->nMesGrt
            end





            aGet[ 16 ]:cText( aTmpPre[ 43 ] )






            if !Empty( aGet[ 19 ] )
               aGet[ 19  ]:cText( ( dbfArticulo )->nPesoKg )
            else
               aGet[ 19  ] := ( dbfArticulo )->nPesoKg
            end

            if !Empty( aGet[ 20 ] )
                aGet[ 20 ]:cText( ( dbfArticulo )->cUndDim )
            else
                aGet[ 20 ] := ( dbfArticulo )->cUndDim
            end

            if !Empty( aGet[ 63 ] )
               aGet[ 63 ]:cText( ( dbfArticulo )->nVolumen )
            else
               aGet[ 63 ] := ( dbfArticulo )->nVolumen
            end

            if !Empty( aGet[ 18 ] )
                aGet[ 18 ]:cText( ( dbfArticulo )->cUnidad )
                aGet[ 18 ]:lValid()
            else
                aTmp[ 18 ] := ( dbfArticulo )->cUnidad
            end

            if !Empty( aGet[ 64 ] )
                aGet[ 64 ]:cText( ( dbfArticulo )->cVolumen )
            else
                aTmp[ 64 ]:= ( dbfArticulo )->cVolumen
            end





            if ( dbfArticulo )->lFacCnv
               aTmp[ 29 ]     := ( dbfArticulo )->nFacCnv
            end





            if oStkAct <> nil .AND. !uFieldEmpresa( "lNStkAct" ) .AND. aTmp[ 33 ] <= 1
               oStock:nPutStockActual( cCodArt, aTmp[ 36 ], , , , aTmp[ 43 ], aTmp[ 33 ], oStkAct )
            end





            if !Empty( aGet[ 57 ] )
               aGet[ 57 ]:cText( ( dbfArticulo )->cImagen )
            else
               aTmp[ 57 ]     := ( dbfArticulo )->cImagen
            end

            if !Empty( bmpImage )
               if !Empty( aTmp[ 57 ] )
                  bmpImage:Show()
                  bmpImage:LoadBmp( cFileBitmap( cPatImg(), aTmp[ 57 ] ) )
               else
                  bmpImage:Hide()
               end
            end





            if aGet[ 50 ] <> nil
               aGet[ 50 ]:cText( ( dbfArticulo )->cCodTip )
            else
               aTmp[ 50 ]  := ( dbfArticulo )->cCodTip
            end

         end






         cPrpArt                 := aTmp[ 25 ] + aTmp[ 26 ] + aTmp[ 27 ] + aTmp[ 28 ]

         if ( lChgCodArt ) .OR. ( cPrpArt <> cOldPrpArt )





            if nMode == 1
               cCodFam        := RetFamArt( cCodArt, dbfArticulo )
            else
               cCodFam        := aTmp[ 51 ]
            end





            if aGet[ 12 ] <> nil
               aGet[ 12 ]:cText( ( dbfArticulo )->nPntVer1 )
            else
               aTmp[ 12 ]  := ( dbfArticulo )->nPntVer1
            end

            aTmp[ 35 ]     := ( dbfArticulo )->PvpRec





            if !uFieldEmpresa( "lCosAct" )
               nCosPro           := oStock:nCostoMedio( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 27 ], aTmp[ 26 ], aTmp[ 28 ] )
               if nCosPro == 0
                  nCosPro        := nCosto( aTmp[ 4 ], dbfArticulo, dbfKit, .F., , dbfDiv )
               end
            else
               nCosPro           := nCosto( aTmp[ 4 ], dbfArticulo, dbfKit, .F., , dbfDiv )
            end

            if aGet[ 34 ] <> nil
               aGet[ 34 ]:cText( nCosPro )
            else
               aTmp[ 34 ]  := nCosPro
            end





            nNumDto              := RetFld( aTmpPre[ 6 ], dbfClient, "nDtoArt" )

            if nNumDto <> 0

               do case
                  case nNumDto == 1

                     if !Empty( aGet[ 14 ] )
                        aGet[ 14 ]:cText( ( dbfArticulo )->nDtoArt1 )
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt1
                     else
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt1
                     end

                  case nNumDto == 2

                     if !Empty( aGet[ 14 ] )
                        aGet[ 14 ]:cText( ( dbfArticulo )->nDtoArt2 )
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt2
                     else
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt2
                     end

                  case nNumDto == 3

                     if !Empty( aGet[ 14 ] )
                        aGet[ 14]:cText( ( dbfArticulo )->nDtoArt3 )
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt3
                     else
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt3
                     end

                  case nNumDto == 4

                     if !Empty( aGet[ 14 ] )
                        aGet[ 14 ]:cText( ( dbfArticulo )->nDtoArt4 )
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt4
                     else
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt4
                     end

                  case nNumDto == 5

                     if !Empty( aGet[ 14 ] )
                        aGet[ 14 ]:cText( ( dbfArticulo )->nDtoArt5 )
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt5
                     else
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt5
                     end

                  case nNumDto == 6

                     if !Empty( aGet[ 14 ] )
                        aGet[ 14]:cText( ( dbfArticulo )->nDtoArt6 )
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt6
                     else
                        aTmp[ 14 ]     := ( dbfArticulo )->nDtoArt6
                     end

               end

            end





            if aTmp[ 14 ] == 0

               if !Empty( aGet[ 14 ] )
                  aGet[ 14 ]:cText( nDescuentoFamilia( cCodFam, dbfFamilia ) )
               else
                  aTmp[ 14 ]     := nDescuentoFamilia( cCodFam, dbfFamilia )
               end

            end





            if !Empty( aGet[ 18 ] )
               aGet[ 18 ]:cText( ( dbfArticulo )->cUnidad )
            else
               aTmp[ 18 ]  := ( dbfArticulo )->cUnidad
            end





            if !aTmp[ 68 ]

               nPrePro        := nPrePro( aTmp[ 4 ], aTmp[ 25 ], aTmp[ 27 ], aTmp[ 26 ], aTmp[ 28 ], aTmp[ 73 ], aTmpPre[ 52 ], dbfArtDiv, dbfTarPreL, aTmpPre[16] )

               if nPrePro == 0
                  aGet[ 11 ]:cText( nRetPreArt( aTmp[ 73 ], aTmpPre[ 46 ], aTmpPre[52], dbfArticulo, dbfDiv, dbfKit, dbfIva, , aGet[ 73 ] ) )
               else
                  aGet[ 11 ]:cText( nPrePro )
               end

            else

               aGet[ 11 ]:cText( 0 )
               aGet[ 67 ]:cText( nPreAlq( aTmp[ 4 ], aTmp[ 73 ], aTmpPre[52], dbfArticulo ) )

            end





            if !Empty( aTmpPre[ 16 ] )





               nImpOfe     := RetPrcTar( cCodArt, aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], dbfTarPreL, aTmp[ 73 ] )
               if nImpOfe  <> 0
                  aGet[ 11 ]:cText( nImpOfe )
               end

               nImpOfe     := RetPctTar( cCodArt, cCodFam, aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], dbfTarPreL )
               if nImpOfe  <> 0
                  aGet[ 14 ]:cText( nImpOfe )
               end

               nImpOfe     := RetLinTar( cCodArt, cCodFam, aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], dbfTarPreL )
               if nImpOfe  <> 0
                  aGet[ 30 ]:cText( nImpOfe )
               end

               nImpOfe     := RetComTar( cCodArt, cCodFam, aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], aTmpPre[14], dbfTarPreL, dbfTarPreS )
               if nImpOfe  <> 0
                  aGet[ 16 ]:cText( nImpOfe )
               end



               nImpOfe     := RetDtoPrm( cCodArt, cCodFam, aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], aTmpPre[5], dbfTarPreL )
               if nImpOfe  <> 0
                  aGet[ 15 ]:cText( nImpOfe )
               end





               nDtoAge     := RetDtoAge( cCodArt, cCodFam, aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], aTmpPre[5], aTmpPre[14], dbfTarPreL, dbfTarPreS )
               if nDtoAge  <> 0
                  aGet[ 16 ]:cText( nDtoAge )
               end

            end





            do case

            case  lSeekAtpArt( aTmpPre[ 6 ] + cCodArt, aTmp[ 25 ] + aTmp[ 26 ], aTmp[ 27 ] + aTmp[ 28 ], aTmpPre[ 5 ], dbfCliAtp ) .AND.  ( dbfCliAtp )->lAplPre

               nImpAtp     := nImpAtp( nTarOld, dbfCliAtp, , , aGet[ 73 ] )
               if nImpAtp  <> 0
                  aGet[ 11 ]:cText( nImpAtp )
               end





               nImpAtp     := nDtoAtp( nTarOld, dbfCliAtp )
               if nImpAtp  <> 0
                  aGet[ 14 ]:cText( nImpAtp )
               end





               if ( dbfCliAtp )->nDprArt <> 0
                  aGet[15]:cText( ( dbfCliAtp )->nDprArt )
               end

               if ( dbfCliAtp )->nComAge <> 0
                  aGet[16]:cText( ( dbfCliAtp )->nComAge )
               end

               if ( dbfCliAtp )->nDtoDiv <> 0
                  if aGet[ 30 ] <> nil
                     aGet[ 30 ]:cText( ( dbfCliAtp )->nDtoDiv )
                  else
                     aTmp[ 30 ]  := ( dbfCliAtp )->nDtoDiv
                  end
               end






            case lSeekAtpFam( aTmpPre[ 6 ] + aTmp[ 51 ], aTmpPre[ 5 ], dbfCliAtp ) .AND.  ( dbfCliAtp )->lAplPre

               if ( dbfCliAtp )->nDtoArt <> 0
                  aGet[14   ]:cText( ( dbfCliAtp )->nDtoArt )
               end

               if ( dbfCliAtp )->nDprArt <> 0
                  aGet[15]:cText( ( dbfCliAtp )->nDprArt )
               end

               if ( dbfCliAtp )->nComAge <> 0
                  aGet[16]:cText( ( dbfCliAtp )->nComAge )
               end

               if ( dbfCliAtp )->nDtoDiv <> 0
                  if aGet[ 30 ] <> nil
                     aGet[ 30 ]:cText( ( dbfCliAtp )->nDtoDiv )
                  else
                     aGet[ 30 ]  := ( dbfCliAtp )->nDtoDiv
                  end
               end

            end

























            if !IsPda()

            if oUndMedicion:oDbf:Seek( ( dbfArticulo )->cUnidad )

               if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:cText( ( dbfArticulo )->nLngArt )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:Show()
               else
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:Hide()
               end

               if oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:cText( ( dbfArticulo )->nAltArt )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:Show()
               else
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:Hide()
               end

               if oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:cText( ( dbfArticulo )->nAncArt )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:Show()
               else
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
                  aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:Hide()
               end

            else

               aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:Hide()

               aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:Hide()

               aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:Hide()

            end

            end

         end





         lBuscaOferta( cCodArt, aGet, aTmp, aTmpPre, dbfOferta, dbfArticulo, dbfDiv, dbfKit, dbfIva  )





         cOldPrpArt := cPrpArt
         cOldCodArt := cCodArt





         if Empty( aTmp[ 11 ] ) .OR. lUsrMaster() .OR. oUser():lCambiarPrecio()
            aGet[ 11 ]:HardEnable()
            aGet[ 14    ]:HardEnable()
            aGet[ 15 ]:HardEnable()
            if aGet[ 13 ] <> nil
               aGet[ 13 ]:HardEnable()
            end
            if aGet[ 12 ] <> nil
               aGet[ 12 ]:HardEnable()
            end
            if aGet[ 30 ] <> nil
               aGet[ 30 ]:HardEnable()
            end
         else
            aGet[ 11 ]:HardDisable()
            aGet[ 14    ]:HardDisable()
            aGet[ 15 ]:HardDisable()
            if aGet[ 13 ] <> nil
               aGet[ 13 ]:HardDisable()
            end
            if aGet[ 12 ] <> nil
               aGet[ 12 ]:HardDisable()
            end
            if aGet[ 30 ] <> nil
               aGet[ 30 ]:HardDisable()
            end
         end

      else

         MsgStop( "Artículo no encontrado" )
         Return .F.

      end

   end

Return .T.



static function lBuscaOferta( cCodArt, aGet, aTmp, aTmpPre, dbfOferta, dbfArticulo, dbfDiv, dbfKit, dbfIva  )

   local sOfeArt
   local nTotalLinea    := 0


   if ( dbfArticulo )->Codigo == cCodArt .OR. ( dbfArticulo )->( dbSeek( cCodArt ) )





      nTotalLinea := RecalculaLinea( aTmp, aTmpPre, nDouDiv, , , aTmpPre[ 46 ], .T. )

      sOfeArt     := sOfertaArticulo( cCodArt, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmp[ 8 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], , aTmp[25], aTmp[26], aTmp[27], aTmp[28], aTmp[ 46 ], dbfArticulo, dbfDiv, dbfKit, dbfIva, aTmp[ 7 ], nTotalLinea )

      if !Empty( sOfeArt ) .AND. sOfeArt:nPrecio <> 0
         aGet[ 11 ]:cText( sOfeArt:nPrecio )
         aGet[ 14 ]:cText( sOfeArt:nDtoPorcentual )
         aGet[ 30 ]:cText( sOfeArt:nDtoLineal )
         aTmp[ 78 ]  := .T.
      end

      if !aTmp[ 78 ]





         sOfeArt     := sOfertaFamilia( ( dbfArticulo )->Familia, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], dbfArticulo, aTmp[ 8 ], aTmp[ 7 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 14 ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 30 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 78 ]  := .T.
         end

      end

      if !aTmp[ 78 ]





         sOfeArt     := sOfertaTipoArticulo( ( dbfArticulo )->cCodTip, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], dbfArticulo, aTmp[ 8 ], aTmp[ 7 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 14 ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 30 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 78 ]  := .T.
         end

      end

      if !aTmp[ 78 ]





         sOfeArt     := sOfertaCategoria( ( dbfArticulo )->cCodCate, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], dbfArticulo, aTmp[ 8 ], aTmp[ 7 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 14 ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 30 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 78 ]  := .T.
         end

      end

      if !aTmp[ 78 ]





         sOfeArt     := sOfertaTemporada( ( dbfArticulo )->cCodTemp, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], dbfArticulo, aTmp[ 8 ], aTmp[ 7 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 14 ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 30 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 78 ]  := .T.
         end

      end

      if !aTmp[ 78 ]





         sOfeArt     := sOfertaFabricante( ( dbfArticulo )->cCodFab, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], dbfArticulo, aTmp[ 8 ], aTmp[ 7 ], nTotalLinea )

         if !Empty( sOfeArt ) .AND. ( sOfeArt:nDtoPorcentual <> 0 .OR. sOfeArt:nDtoLineal <> 0 )
            aGet[ 14 ]:cText( sOfeArt:nDtoPorcentual )
            aGet[ 30 ]:cText( sOfeArt:nDtoLineal )
            aTmp[ 78 ]  := .T.
         end

      end

   end

return .T.



FUNCTION BrwPreCli( oGet, dbfPreCliT, dbfPreCliL, dbfIva, dbfDiv, dbfFPago, oIva )

    local oDlg
    local oBrw
   local oGet1
   local cGet1
   local nOrd     := GetBrwOpt( "BrwPreCli" )
   local lIva     := oIva:VarGet()
    local oCbxOrd
   local aCbxOrd  := { "Número", "Fecha", "Cliente", "Nombre" }
   local cCbxOrd
   local nOrdAnt
   local nRecAnt

   nOrd           := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd        := aCbxOrd[ nOrd ]
   nOrdAnt        := ( dbfPreCliT )->( OrdSetFocus( nOrd ) )
   nRecAnt        := ( dbfPreCliT )->( Recno() )

   ( dbfPreCliT )->( dbSetFilter( {|| !Field->lEstado .AND. Field->lIvaInc == lIva }, "!lEstado .and. lIvaInc == lIva" ) )
   ( dbfPreCliT )->( dbGoTop() )

   oDlg = TDialog():New(,,,, if( lIva, "Presupuestos de clientes con " + cImp() + " incluido", "Presupuestos de clientes con " + cImp() + " desglosado" ), "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F., )






        oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, dbfPreCliT ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, dbfPreCliT, .T., nil, .F. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( dbfPreCliT )->( ordSetFocus( oCbxOrd:nAt ) ), oBrw:Refresh(), oGet1:SetFocus() )},,,, .F.,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := dbfPreCliT
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Presupuesto a cliente.Browse"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Tipo"
         :bEditValue       := {|| aTipPre[ if( ( dbfPreCliT )->lAlquiler, 2, 1  ) ] }
         :nWidth           := 50
         :lHide            := .T.
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumPre"
         :bEditValue       := {|| ( dbfPreCliT )->cSerPre + "/" + AllTrim( Str( ( dbfPreCliT )->nNumPre ) ) + "/" + ( dbfPreCliT )->cSufPre }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecPre"
         :bEditValue       := {|| dtoc( ( dbfPreCliT )->dFecPre ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Cliente"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| AllTrim( ( dbfPreCliT )->cCodCli ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| AllTrim( ( dbfPreCliT )->cNomCli ) }
         :nWidth           := 200
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotPreCli( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre, dbfPreCliT, dbfPreCliL, dbfIva, dbfDiv, dbfFPago, nil, cDivEmp(), .T. ) }
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end




        TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




        TButton():ReDefine( 500,, oDlg,,, .F., {||     .F.},,, .F. )




        TButton():ReDefine( 501,, oDlg,,, .F., {||     .F.},,, .F. )

   oDlg:AddFastKey( 116,       {|| oDlg:end( 1 ) } )
   oDlg:AddFastKey( 13,   {|| oDlg:end( 1 ) } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   DestroyFastFilter( dbfPreCliT )

   SetBrwOpt( "BrwPreCli", ( dbfPreCliT )->( OrdNumber() ) )

   if oDlg:nResult == 1
      oGet:cText( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre )
      oGet:lValid()
   end

   ( dbfPreCliT )->( dbClearFilter() )
   ( dbfPreCliT )->( ordSetFocus( nOrdAnt ) )
   ( dbfPreCliT )->( dbGoTo( nRecAnt ) )

RETURN ( oDlg:nResult == 1 )



FUNCTION ChgPreCli( cPre, nMode, dbfPreCliT )

   local oBlock
   local oError
    local lExito := .T.
    local lClose := .F.

   IF nMode <> 1 .OR. Empty( cPre )
        RETURN NIL
    end

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

    IF dbfPreCliT == NIL

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLI.DBF" ), ( cCheckArea( "PRECLI", @dbfPreCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
        lClose := .T.

   end

   IF (dbfPreCliT)->( dbSeek( cPre ) )
      if dbDialogLock( dbfPreCliT )
         (dbfPreCliT)->lEstado   := .T.
         (dbfPreCliT)->( dbUnLock() )
      end
    ELSE
        lExito := .F.
    end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

    IF lClose
        (dbfPreCliT)->( dbCloseArea() )
    end

RETURN lExito







STATIC FUNCTION RecalculaLinea( aTmp, aTmpPre, nDec, oTotal, oMargen, cCodDiv, lTotal )

   local nCalculo
   local nUnidades
   local nMargen
   local nCosto
   local nRentabilidad
   local nBase    := 0

   IIF( lTotal == nil, lTotal := .F., ) ;

   nUnidades      := nTotNPreCli( aTmp )

   if aTmp[ 68 ]
      nCalculo    := aTmp[ 67  ]
   else
      nCalculo    := aTmp[ 11  ]
   end

   nCalculo       -= aTmp[ 30  ]





   if !aTmp[ 37 ]

      if aTmp[ 79 ]
         nCalculo += aTmp[ 39 ] * NotCero( aTmp[ 63 ] )
      else
         nCalculo += aTmp[ 39 ]
      end

   end

   nCalculo       *= nUnidades





   if aTmp[ 13 ] <> 0
      nCalculo    += aTmp[ 13 ] * nUnidades
   end





   IF aTmp[ 14    ] <> 0
      nCalculo    -= nCalculo * aTmp[ 14    ] / 100
    end

    IF aTmp[ 15 ] <> 0
      nCalculo    -= nCalculo * aTmp[ 15 ] / 100
    end





   nCosto            := nUnidades * aTmp[ 34 ]

   if aTmp[ 37 ] .AND. aTmp[ 6 ] <> 0
      nBase          := nCalculo - Round( nCalculo / ( 100 / aTmp[ 6 ] + 1 ), nRouDiv )
   else
      nBase          := nCalculo
   end

   nMargen           := nBase - nCosto

   if nCalculo == 0
      nRentabilidad  := 0
   else
      nRentabilidad  := nRentabilidad( nCalculo, 0, nCosto )
   end





   if aTmpPre[ 80 ] .AND. aTmp[ 12 ] <> 0
      nCalculo    += aTmp[ 12  ] * nUnidades
   end

   nCalculo       := Round( nCalculo, nDec )

   if !Empty( oTotal )
      oTotal:cText( nCalculo )
   end

   if oMargen <> nil
      oMargen:cText( AllTrim( Trans( nMargen, cPorDiv ) + Space( 1 ) + AllTrim( cSimDiv( cCodDiv, dbfDiv ) ) + " : " + AllTrim( Trans( nRentabilidad, "999.99" ) ) + "%" ) )
   end

   if !Empty( oComisionLinea )
      oComisionLinea:cText( Round( ( nMargen * aTmp[ 16 ] / 100 ), nRouDiv ) )
   end

return if( !lTotal, .T., nCalculo )



FUNCTION nTotUPreCli( uTmpLin, nDec, nVdv )

   local nCalculo       := 0

   IIF( uTmpLin == nil, uTmpLin := dbfPreCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   do case
      case Valtype( uTmpLin ) == "C"

         if ( uTmpLin )->lAlquiler
            nCalculo    := ( uTmpLin )->nPreAlq
         else
            nCalculo    := ( uTmpLin )->nPreDiv
         end

      case Valtype( uTmpLin ) == "O"

         if uTmpLin:lAlquiler
            nCalculo    := uTmpLin:nPreAlq
         else
            nCalculo    := uTmpLin:nPreDiv
         end

   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nImpUPreCli( uTmpLin, nDec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( nDec == nil, nDec := 2, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   if ValType( uTmpLin ) == "C"

      if ( uTmpLin )->lAlquiler
         nCalculo    := ( uTmpLin )->nPreAlq
      else
         nCalculo    := ( uTmpLin )->nPreDiv
      end

      if ( uTmpLin )->lIvaLin

         if ( uTmpLin )->nIva <> 0
            nCalculo -= nCalculo / ( 100 / ( uTmpLin )->nIva + 1 )
         end

         if ( uTmpLin )->nValImp <> 0
            nCalculo -= ( uTmpLin )->nValImp
         end

      end

   else

      if uTmpLin:lAlquiler
         nCalculo    := uTmpLin:nPreAlq
      else
         nCalculo    := uTmpLin:nPreDiv
      end

      if uTmpLin:lIvaLin

         if uTmpLin:nIva <> 0
            nCalculo -= nCalculo / ( 100 / uTmpLin:nIva + 1 )
         end

         if uTmpLin:nValImp <> 0
            nCalculo -= uTmpLin:nValImp
         end

      end

   end

   nCalculo          := Round( nCalculo / nVdv, nDec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nBrtLPreCli( uTmpLin, nDec, nRec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( nDec == nil, nDec := 2, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nImpUPreCli( uTmpLin, nDec, nVdv, cPorDiv )
   nCalculo          *= nTotNPreCli( uTmpLin )

   nCalculo          := Round( nCalculo / nVdv, nRec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nIvaUPreCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUPreCli( dbfTmpLin, nDec, nVdv )
   nCalculo       := nCalculo * ( dbfTmpLin )->nIva / 100

   if nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )






FUNCTION nTotFPreCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPorDiv )

   local nCalculo    := 0

   IIF( dbfLin == nil, dbfLin := dbfPreCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nRou == nil, nRou := nRouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lDto == nil, lDto := .T., ) ;
   IIF( lPntVer == nil, lPntVer := .T., ) ;
   IIF( lImpTrn == nil, lImpTrn := .T., ) ;

   nCalculo          += nTotLPreCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn )
   nCalculo          += nTotIPreCli( dbfLin, nDec, nRou, nVdv )

return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION cDesPreCli( cPreCliL )

   IIF( cPreCliL == nil, cPreCliL := dbfPreCliL, ) ;

RETURN ( Descrip( cPreCliL ) )



FUNCTION nTotLPreCli( cPreCliT, cPreCliL, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo

   IIF( cPreCliT == nil, cPreCliT := dbfPreCliT, ) ;
   IIF( cPreCliL == nil, cPreCliL := dbfPreCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nRou == nil, nRou := nRouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lDto == nil, lDto := .T., ) ;
   IIF( lPntVer == nil, lPntVer := ( cPreCliT )->lOperPv, ) ;
   IIF( lImpTrn == nil, lImpTrn := .T., ) ;

   if ( cPreCliL )->lTotLin

      nCalculo          := nTotUPreCli( cPreCliL, nDec )

   else

      nCalculo          := nTotUPreCli( cPreCliL, nDec ) * nTotNPreCli( cPreCliL )





      nCalculo          -= Round( ( cPreCliL )->nDtoDiv / nVdv , nDec )

      if ( cPreCliL )->nDto <> 0 .AND. lDto
         nCalculo       -= nCalculo * ( cPreCliL )->nDto / 100
      end

      if ( cPreCliL )->nDtoPrm <> 0 .AND. lDto
         nCalculo       -= nCalculo * ( cPreCliL )->nDtoPrm / 100
      end





      if lPntVer .AND. ( cPreCliL )->nPntVer <> 0
         nCalculo       += ( cPreCliL )->nPntVer * nTotNPreCli( cPreCliL )
      end





      if lImpTrn .AND. ( cPreCliL )->nImpTrn <> 0
         nCalculo       += ( cPreCliL )->nImpTrn * nTotNPreCli( cPreCliL )
      end

   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

   if nRou <> nil
      nCalculo          := Round( nCalculo, nRou )
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nTotCPreCli( dbfLine, nDec, nRec, nVdv, cPouDiv )

   local nCalculo       := 0

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRec == nil, nRec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   if !( dbfLine )->lKitChl
      nCalculo          := nTotNPreCli( dbfLine )
      nCalculo          *= ( dbfLine )->nCosDiv
   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

   nCalculo             := Round( nCalculo, nRec )

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nPesLPreCli( cPreCliL )

   local nCalculo    := 0

   IIF( cPreCliL == nil, cPreCliL := dbfPreCliL, ) ;

   if !( cPreCliL )->lTotLin .AND. !( cPreCliL )->lControl
      nCalculo       := Abs( nTotNPreCli( cPreCliL ) ) * ( cPreCliL )->nPesoKg
   end

RETURN ( nCalculo )



FUNCTION nVolLPreCli( dbfLine )

   local nCalculo    := 0

   if !( dbfLine )->lTotLin .AND. !( dbfLine )->lControl
      nCalculo       := nTotNPreCli( dbfLine ) * ( dbfLine )->nVolumen
   end

RETURN ( nCalculo )



FUNCTION nIvaLPreCli( dbfT, dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo := nTotLPreCli( dbfT, dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   if !( dbfLin )->lIvaLin
      nCalculo    := nCalculo * ( dbfLin )->nIva / 100
   else
      nCalculo    -= nCalculo / ( 1 + ( dbfLin )->nIva / 100 )
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



Function nPntUPreCli( dbfTmpLin, nDec, nVdv )

    local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := ( dbfTmpLin )->nPntVer

    IF nVdv <> 0
      nCalculo    := ( dbfTmpLin )->nPntVer / nVdv
    end

RETURN ( round( nCalculo, nDec ) )



FUNCTION nPntLPreCli( dbfLin, nDec, nVdv )

   local nPntVer

   IIF( dbfLin == nil, dbfLin := dbfPreCliL, ) ;
   IIF( nDec == nil, nDec := 2, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;





   nPntVer           := nPntUPreCli( dbfLin, nDec, nVdv )
   nPntVer           *= nTotNPreCli( dbfLin )

RETURN ( Round( nPntVer, nDec ) )



FUNCTION nTrnUPreCli( dbfTmpLin, nDec, nVdv )

    local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := ( dbfTmpLin )->nImpTrn

   IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
    end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nTrnLPreCli( dbfLin, nDec, nRou, nVdv )

   local nImpTrn

   IIF( dbfLin == nil, dbfLin := dbfPreCliL, ) ;
   IIF( nDec == nil, nDec := 2, ) ;
   IIF( nRou == nil, nRou := 2, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;





   nImpTrn           := nTrnUPreCli( dbfLin, nDec ) * nTotNPreCli( dbfLin )

   IF nVdv <> 0
      nImpTrn        := nImpTrn / nVdv
    end

RETURN ( Round( nImpTrn, nRou ) )



FUNCTION nDtoUPreCli( dbfTmpLin, nDec, nVdv )

   local nCalculo := ( dbfTmpLin )->nDtoDiv

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   if nVdv <> 0
      nCalculo    /= nVdv
   end

RETURN ( round( nCalculo, nDec ) )



STATIC FUNCTION nTotLAgePre( dbfDetalle )

   local nCalculo := ( dbfDetalle )->nPreDiv * (dbfDetalle)->nUniCaja

   IF lCalCaj()
      nCalculo    *= If( ( dbfDetalle )->nCanPre <> 0, ( dbfDetalle )->nCanPre, 1 )
    end

   nCalculo       := Round( nCalculo * ( dbfDetalle )->nComAge / 100, 0 )

RETURN ( nCalculo )







STATIC FUNCTION nTotLNumArt( dbfDetalle )

    local nCalculo := 0

   IF lCalCaj() .AND. (dbfDetalle)->NCANPRE <> 0 .AND. (dbfDetalle)->NPREDIV <> 0
        nCalculo := (dbfDetalle)->NCANPRE
    end

RETURN ( nCalculo )



FUNCTION mkPreCli( cPath, lAppend, cPathOld, oMeter, bFor )

    local dbfPreCliT
   local dbfPreCliL
   local dbfPreCliI
   local dbfPreCliD
   local oldPreCliT
   local oldPreCliL
   local oldPreCliI
   local oldPreCliD

   if oMeter <> NIL
        oMeter:cText    := "Generando Bases"
        sysrefresh()
   end

   IIF( bFor == nil, bFor := {|| .T. }, ) ;

   CreateFiles( cPath )
   rxPreCli( cPath, oMeter )

   If lAppend .AND. lIsDir( cPathOld )

      dbUseArea( .T., cDriver(), cPath + "PRECLIT.DBF", cCheckArea( "PRECLIT", @dbfPreCliT ), .F. )
      if !( dbfPreCliT )->( neterr() )
         ( dbfPreCliT )->( ordListAdd( cPath + "PRECLIT.CDX" ) )
      end

      dbUseArea( .T., cDriver(), cPath + "PreCliL.DBF", cCheckArea( "PreCliL", @dbfPreCliL ), .F. )
      if !( dbfPreCliL )->( neterr() )
         ( dbfPreCliL )->( ordListAdd( cPath + "PreCliL.CDX" ) )
      end

      dbUseArea( .T., cDriver(), cPath + "PreCliI.Dbf", cCheckArea( "PreCliI", @dbfPreCliI ), .F. )
      if !( dbfPreCliI )->( neterr() )
         ( dbfPreCliI )->( ordListAdd( cPath + "PreCliI.Cdx" ) )
      end

      dbUseArea( .T., cDriver(), cPath + "PreCliD.Dbf", cCheckArea( "PreCliD", @dbfPreCliD ), .F. )
      if !( dbfPreCliD )->( neterr() )
         ( dbfPreCliD )->( ordListAdd( cPath + "PreCliD.Cdx" ) )
      end





      dbUseArea( .T., cDriver(), cPathOld + "PreCliT.DBF", cCheckArea( "PreCliT", @oldPreCliT ), .F. )
      if !( dbfPreCliT )->( neterr() )
         ( oldPreCliT )->( ordListAdd( cPathOld + "PreCliT.CDX" ) )
      end

      dbUseArea( .T., cDriver(), cPathOld + "PreCliL.DBF", cCheckArea( "PreCliL", @oldPreCliL ), .F. )
      if !( oldPreCliL )->( neterr() )
         ( oldPreCliL )->( ordListAdd( cPathOld + "PreCliL.CDX" ) )
      end

      dbUseArea( .T., cDriver(), cPathOld + "PreCliI.DBF", cCheckArea( "PreCliI", @oldPreCliI ), .F. )
      if !( oldPreCliI )->( neterr() )
         ( oldPreCliI )->( ordListAdd( cPathOld + "PreCliI.CDX"  ) )
      end

      dbUseArea( .T., cDriver(), cPathOld + "PreCliD.DBF", cCheckArea( "PreCliD", @oldPreCliD ), .F. )
      if !( oldPreCliD )->( neterr() )
         ( oldPreCliD )->( ordListAdd( cPathOld + "PreCliD.CDX"  ) )
      end





      while !( oldPreCliT )->( eof() )

         if eval( bFor, oldPreCliT )

            dbCopy( oldPreCliT, dbfPreCliT, .T. )

            if ( oldPreCliL )->( dbSeek( ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre ) )
               while ( oldPreCliL )->cSerPre + Str( ( oldPreCliL )->nNumPre ) + ( oldPreCliL )->cSufPre == ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre .AND. !( oldPreCliL )->( eof() )
                  dbCopy( oldPreCliL, dbfPreCliL, .T. )
                  ( oldPreCliL )->( dbSkip() )
               end
            end

            if ( oldPreCliI )->( dbSeek( ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre ) )
               while ( oldPreCliI )->cSerPre + Str( ( oldPreCliI )->nNumPre ) + ( oldPreCliI )->cSufPre == ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre .AND. !( oldPreCliI )->( eof() )
                  dbCopy( oldPreCliI, dbfPreCliI, .T. )
                  ( oldPreCliI )->( dbSkip() )
               end
            end

            if ( oldPreCliD )->( dbSeek( ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre ) )
               while ( oldPreCliD )->cSerPre + Str( ( oldPreCliD )->nNumPre ) + ( oldPreCliD )->cSufPre == ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre .AND. !( oldPreCliI )->( eof() )
                  dbCopy( oldPreCliD, dbfPreCliD, .T. )
                  ( oldPreCliD )->( dbSkip() )
               end
            end

         end

         ( oldPreCliT )->( dbSkip() )

      end

        ( dbfPreCliT )->( dbCloseArea() )
      ( dbfPreCliL )->( dbCloseArea() )
      ( dbfPreCliI )->( dbCloseArea() )
      ( dbfPreCliD )->( dbCloseArea() )

      ( oldPreCliT )->( dbCloseArea() )
      ( oldPreCliL )->( dbCloseArea() )
      ( oldPreCliI )->( dbCloseArea() )
      ( oldPreCliD )->( dbCloseArea() )

   end

Return Nil



FUNCTION rxPreCli( cPath, oMeter )

    local dbfPreCliT

   IIF( cPath == nil, cPath := cPatEmp(), ) ;




   if !lExistTable( cPath + "PRECLIT.DBF" ) .OR.  !lExistTable( cPath + "PRECLIL.DBF" ) .OR.  !lExistTable( cPath + "PRECLII.DBF" ) .OR.  !lExistTable( cPath + "PRECLID.DBF" )
      CreateFiles( cPath )
   end

   fEraseIndex( cPath + "PRECLIT.CDX" )
   fEraseIndex( cPath + "PRECLIL.CDX" )
   fEraseIndex( cPath + "PRECLII.CDX" )
   fEraseIndex( cPath + "PRECLID.CDX" )

   dbUseArea( .T., cDriver(), cPath + "PRECLIT.DBF", cCheckArea( "PRECLIT", @dbfPreCliT ), .F. )
   if !( dbfPreCliT )->( neterr() )
      ( dbfPreCliT )->( __dbPack() )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PRECLIT.CDX", "NNUMPRE", "CSERPRE + STR( NNUMPRE ) + CSUFPRE", {|| Field->CSERPRE + STR(Field->NNUMPRE) + Field->CSUFPRE } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PRECLIT.CDX", "DFECPRE", "DFECPRE", {|| Field->DFECPRE } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PRECLIT.CDX", "CCODCLI", "CCODCLI + Dtos( dFecPre )", {|| Field->CCODCLI + Dtos( Field->dFecPre ) } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PRECLIT.CDX", "CNOMCLI", "cNomCli + Dtos( dFecPre )", {|| Field->cNomCli + Dtos( Field->dFecPre ) } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PRECLIT.CDX", "cCodObr", "cCodObr", {|| Field->cCodObr } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PRECLIT.CDX", "cCodAge", "cCodAge", {|| Field->cCodAge } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PRECLIT.CDX", "CTURPRE", "CTURPRE + CSUFPRE + cCodCaj", {|| Field->CTURPRE + Field->CSUFPRE + Field->cCodCaj } ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ))
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.CDX", "lSndDoc", "lSndDoc", {|| Field->lSndDoc } ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "cCodUsr", "Field->cCodUsr + Dtos( Field->dFecCre ) + Field->cTimCre", {|| Field->cCodUsr + Dtos( Field->dFecCre ) + Field->cTimCre } ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "iNumPre", "'PRESUPUESTO CLIENTES          ' + cSerPre + Str( nNumPre ) + cSufPre", {|| "PRESUPUESTO CLIENTES          " + Field->cSerPre + Str( Field->nNumPre ) + Field->cSufPre } ) )

      ( dbfPreCliT )->( dbCloseArea() )

   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de presupuestos de clientes" )
   end

   dbUseArea( .T., cDriver(), cPath + "PRECLIL.DBF", cCheckArea( "PRECLIL", @dbfPreCliT ), .F. )
   if !( dbfPreCliT )->( neterr() )
      ( dbfPreCliT )->( __dbPack() )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliL.Cdx", "NNUMPRE", "CSERPRE + STR( NNUMPRE ) + CSUFPRE", {|| Field->CSERPRE + STR( Field->NNUMPRE ) + Field->CSUFPRE } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliL.Cdx", "CREF", "CREF", {|| Field->CREF }, ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliL.Cdx", "Lote", "cLote", {|| Field->cLote }, ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliL.Cdx", "iNumPre", "'PRESUPUESTO CLIENTES          ' + cSerPre + Str( nNumPre ) + cSufPre", {|| "PRESUPUESTO CLIENTES          " + Field->cSerPre + Str( Field->nNumPre ) + Field->cSufPre } ) )

      ( dbfPreCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de presupuestos de clientes" )
   end

   dbUseArea( .T., cDriver(), cPath + "PRECLII.DBF", cCheckArea( "PRECLII", @dbfPreCliT ), .F. )
   if !( dbfPreCliT )->( neterr() )
      ( dbfPreCliT )->( __dbPack() )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PRECLII.CDX", "NNUMPRE", "CSERPRE + STR( NNUMPRE ) + CSUFPRE", {|| Field->CSERPRE + STR(Field->NNUMPRE) + Field->CSUFPRE } ) )

      ( dbfPreCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de presupuestos de clientes" )
   end

   dbUseArea( .T., cDriver(), cPath + "PRECLID.DBF", cCheckArea( "PRECLID", @dbfPreCliT ), .F. )
   if !( dbfPreCliT )->( neterr() )
      ( dbfPreCliT )->( __dbPack() )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PRECLID.CDX", "NNUMPRE", "CSERPRE + STR( NNUMPRE ) + CSUFPRE", {|| Field->CSERPRE + STR(Field->NNUMPRE) + Field->CSUFPRE } ) )

      ( dbfPreCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de presupuestos de clientes" )
   end






























RETURN NIL



STATIC FUNCTION BeginTrans( aTmp, lIndex )

   local lErrors  := .F.
   local cDbfLin  := "PCliL"
   local cDbfInc  := "PCliI"
   local cDbfDoc  := "PCliD"
   local cPre     := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]
   local oError
   local oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   IIF( lIndex == nil, lIndex := .T., ) ;

   BEGIN SEQUENCE

   cTmpLin        := cGetNewFileName( cPatTmp() + cDbfLin )
   cTmpInc        := cGetNewFileName( cPatTmp() + cDbfInc )
   cTmpDoc        := cGetNewFileName( cPatTmp() + cDbfDoc )





   dbCreate( cTmpInc, aSqlStruct( aIncPreCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpInc, cCheckArea( cDbfInc, @dbfTmpInc ), .F. )
   if lIndex
      if !NetErr()
         ( dbfTmpInc )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
         ( dbfTmpInc )->( OrdCreate( cTmpInc, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
      else
         lErrors     := .T.
      end
   end

   dbCreate( cTmpDoc, aSqlStruct( aPreCliDoc() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpDoc, cCheckArea( cDbfDoc, @dbfTmpDoc ), .F. )
   if lIndex
      if !NetErr()
         ( dbfTmpDoc )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
         ( dbfTmpDoc )->( OrdCreate( cTmpDoc, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
      else
         lErrors     := .T.
      end
   end

   dbCreate( cTmpLin, aSqlStruct( aColPreCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpLin, cCheckArea( cDbfLin, @dbfTmpLin ), .F. )
   if lIndex
      if !NetErr()

         ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpLin )->( OrdCreate( cTmpLin, "nNumLin", "Str( nNumLin, 4 )", {|| Str( Field->nNumLin ) } ) )

         ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
         ( dbfTmpLin )->( OrdCreate( cTmpLin, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )

      else
         lErrors     := .T.
      end
   end





   if ( dbfPreCliL )->( dbSeek( cPre ) )

      while ( ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->NNUMPRE ) + ( dbfPreCliL )->CSUFPRE == cPre .AND. !( dbfPreCliL )->( eof() ) )

         dbPass( dbfPreCliL, dbfTmpLin, .T. )
         ( dbfPreCliL )->( dbSkip() )

      end

   end

   ( dbfTmpLin )->( dbGoTop() )





   if ( dbfPreCliI )->( dbSeek( cPre ) )

      while ( ( dbfPreCliI )->cSerPre + Str( ( dbfPreCliI )->NNUMPRE ) + ( dbfPreCliI )->CSUFPRE == cPre .AND. !( dbfPreCliI )->( eof() ) )

         dbPass( dbfPreCliI, dbfTmpInc, .T. )
         ( dbfPreCliI )->( DbSkip() )

      end

   end

   ( dbfTmpInc )->( dbGoTop() )





   if ( dbfPreCliD )->( dbSeek( cPre ) )

      while ( ( dbfPreCliD )->cSerPre + Str( ( dbfPreCliD )->NNUMPRE ) + ( dbfPreCliD )->CSUFPRE == cPre .AND. !( dbfPreCliD )->( eof() ) )

         dbPass( dbfPreCliD, dbfTmpDoc, .T. )
         ( dbfPreCliD )->( dbSkip() )

      end

   end

   ( dbfTmpDoc )->( dbGoTop() )

   RECOVER USING oError

      msgStop( "Imposible crear tablas temporales" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      KillTrans()

      lErrors     := .T.

   end

   ErrorBlock( oBlock )

RETURN ( lErrors )



STATIC FUNCTION EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg )

    local aTabla
   local oError
   local oBlock
   local cSerPre
   local nNumPre
   local cSufPre

   if Empty( aTmp[ 1 ] )
      aTmp[ 1 ]  := "A"
   end

   cSerPre              := aTmp[ 1 ]
   nNumPre              := aTmp[ 2 ]
   cSufPre              := aTmp[ 3 ]





   if !lValidaOperacion( aTmp[5] )
      Return .F.
   end

   if Empty( aTmp[ 6 ] )
      msgStop( "Cliente no puede estar vacío." )
      aGet[ 6 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 17 ] )
      msgStop( "Almacén no puede estar vacío." )
      aGet[ 17 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 18 ] )
      msgStop( "Caja no puede estar vacía." )
      aGet[ 18 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 46 ] )
      MsgStop( "No puede almacenar documento sin código de divisa." )
      aGet[ 46 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 14 ] ) .AND. lRecogerAgentes()
      msgStop( "Agente no puede estar vacio." )
      aGet[ 14 ]:SetFocus()
      return .F.
   end

   if ( dbfTmpLin )->( eof() )
      MsgStop( "No puede almacenar un documento sin lineas." )
      return .F.
   end

   oDlg:Disable()

   oMsgText( "Archivando" )





   ( dbfTmpLin )->( dbClearFilter() )





   aTmp[ 59 ]        := Date()
   aTmp[ 60 ]        := Time()





   if !Empty( oTipPre ) .AND. oTipPre:nAt == 2
      aTmp[ 72 ]   := .T.
   else
      aTmp[ 72 ]   := .F.
   end

   do case
   case nMode == 1 .OR. nMode == 4

      nNumPre              := nNewDoc( cSerPre, dbfPreCliT, "NPRECLI", , dbfCount )
      aTmp[ 2 ]     := nNumPre

   case nMode == 2

      if nNumPre <> 0 .AND. ( dbfPreCliL )->( dbSeek( cSerPre + str( nNumPre ) + cSufPre ) )

         while ( ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->nNumPre ) + ( dbfPreCliL )->cSufPre == cSerPre + str( nNumPre ) + cSufPre )

            if dbLock( dbfPreCliL )
               ( dbfPreCliL )->( dbDelete() )
               ( dbfPreCliL )->( dbUnLock() )
            end

            ( dbfPreCliL )->( dbSkip() )

         end

      end

      if nNumPre <> 0

         while ( dbfPreCliI )->( dbSeek( cSerPre + str( nNumPre ) + cSufPre ) )
            if dbLock( dbfPreCliI )
               ( dbfPreCliI )->( dbDelete() )
               ( dbfPreCliI )->( dbUnLock() )
            end
         end

         while ( dbfPreCliD )->( dbSeek( cSerPre + str( nNumPre ) + cSufPre ) )
            if dbLock( dbfPreCliD )
               ( dbfPreCliD )->( dbDelete() )
               ( dbfPreCliD )->( dbUnLock() )
            end
         end

      end

   end

   if !( "PDA" $ cParamsMain() )
      oMsgProgress()
      oMsgProgress():SetRange( 0, ( dbfTmpLin )->( LastRec() ) )
   end





   ( dbfTmpLin )->( dbGoTop() )
   while !( dbfTmpLin )->( Eof() )

      dbPass( dbfTmpLin, dbfPreCliL, .T., cSerPre, nNumPre, cSufPre )
      ( dbfTmpLin )->( dbSkip() )

      if !( "PDA" $ cParamsMain() )
         oMsgProgress():Deltapos(1)
      end

   end





   ( dbfTmpInc )->( dbGoTop() )
   while !( dbfTmpInc )->( Eof() )

      dbPass( dbfTmpInc, dbfPreCliI, .T., cSerPre, nNumPre, cSufPre )
      ( dbfTmpInc )->( dbSkip() )

   end





   ( dbfTmpDoc )->( dbGoTop() )
   while !( dbfTmpDoc )->( Eof() )

      dbPass( dbfTmpDoc, dbfPreCliD, .T., cSerPre, nNumPre, cSufPre )
      ( dbfTmpDoc )->( dbSkip() )

   end





   aTmp[ 76 ]     := nTotNet
   aTmp[ 77 ]     := nTotIva
   aTmp[ 78 ]     := nTotReq
   aTmp[ 79 ]     := nTotPre

   WinGather( aTmp, , dbfPreCliT, , nMode )





   dbCommitAll()

   if !( "PDA" $ cParamsMain() )
      oMsgProgress()
      oMsgText()

      EndProgress()
   end

   oDlg:Enable()
   oDlg:End( 1 )

Return .T.



Static Function KillTrans( oBrwLin )





   if !Empty( dbfTmpLin ) .AND. ( dbfTmpLin )->( Used() )
      ( dbfTmpLin )->( dbCloseArea() )
   end

   if !Empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )
      ( dbfTmpInc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpDoc ) .AND. ( dbfTmpDoc )->( Used() )
      ( dbfTmpDoc )->( dbCloseArea() )
   end

   dbfErase( cTmpLin )
   dbfErase( cTmpInc )
   dbfErase( cTmpDoc )

Return .T.



STATIC FUNCTION LoaCli( aGet, aTmp, nMode, oRieCli, oTlfCli )

   local lValid      := .T.
   local cNewCodCli  := aGet[ 6 ]:VarGet()
   local lChgCodCli  := ( Empty( cOldCodCli ) .OR. cOldCodCli <> cNewCodCli )

   if Empty( cNewCodCli )
      return .T.
   elseif At( ".", cNewCodCli ) <> 0
      cNewCodCli     := PntReplace( aGet[6], "0", RetNumCodCliEmp() )
   else
      cNewCodCli     := Rjust( cNewCodCli, "0", RetNumCodCliEmp() )
   end

   if ( dbfClient )->( dbSeek( cNewCodCli ) )

      if ( dbfClient )->lBlqCli
         msgStop( "Cliente bloqueado, no se pueden realizar operaciones de venta" )
         return .F.
      end

      if oTlfCli <> nil
         oTlfCli:SetText( ( dbfClient )->Telefono )
      end





      aGet[ 6 ]:cText( ( dbfClient )->Cod )





      if ( dbfClient )->nColor <> 0
         aGet[ 7 ]:SetColor( , ( dbfClient )->nColor )
      end

      if Empty( aGet[ 7 ]:varGet() ) .OR. lChgCodCli
         aGet[ 7 ]:cText( ( dbfClient )->Titulo )
      end

      if Empty( aGet[ 75 ]:varGet() ) .OR. lChgCodCli
         aGet[ 75 ]:cText( ( dbfClient )->Telefono )
      end

      if !Empty( aGet[ 8 ] ) .AND. ( Empty( aGet[ 8 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 8 ]:cText( ( dbfClient )->Domicilio )
      end

      if !Empty( aGet[ 9 ] ) .AND. ( Empty( aGet[ 9 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 9 ]:cText( ( dbfClient )->Poblacion )
      end

      if !Empty( aGet[ 10 ] ) .AND. ( Empty( aGet[ 10 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 10 ]:cText( ( dbfClient )->Provincia )
      end

      if !Empty( aGet[ 11 ] ) .AND. ( Empty( aGet[ 11 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 11 ]:cText( ( dbfClient )->CodPostal )
      end

      if !Empty( aGet[12] ) .AND. ( Empty( aGet[ 12 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 12 ]:cText( ( dbfClient )->Nif )
      end

      if ( Empty( aTmp[63] ) .OR. lChgCodCli )
         aTmp[ 63 ]  := ( dbfClient )->cCodGrp
      end

      if ( lChgCodCli )





         if oRieCli <> nil
            oStock:SetRiesgo( cNewCodCli, oRieCli, ( dbfClient )->Riesgo )
         end

         aTmp[ 13 ]  := ( dbfClient )->lModDat

      end

      if ( lChgCodCli )
         aTmp[ 80 ]  := ( dbfClient )->lPntVer
      end

      if nMode == 1

         aTmp[ 51 ]   := ( dbfClient )->nRegIva





         if Empty( aTmp[ 1 ] )

            if !Empty( ( dbfClient )->Serie )
               aGet[ 1 ]:cText( ( dbfClient )->Serie )
            end

         else

            if !Empty( ( dbfClient )->Serie ) .AND. aTmp[ 1 ] <> ( dbfClient )->Serie .AND. ApoloMsgNoYes( "La serie del cliente seleccionado es distinta a la anterior.", "¿Desea cambiar la serie?" )
               aGet[ 1 ]:cText( ( dbfClient )->Serie )
            end

         end

         if !Empty( aGet[ 17 ] )
            if ( Empty( aGet[ 17 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodAlm )
               aGet[ 17 ]:cText( ( dbfClient )->cCodAlm )
               aGet[ 17 ]:lValid()
            end
         end

         if aGet[ 16 ] <> nil
            if !Empty( aGet[ 16 ] ) .AND. ( Empty( aGet[ 16 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodTar )
               aGet[ 16 ]:cText( ( dbfClient )->cCodTar )
               aGet[ 16 ]:lValid()
            end
         end

         if ( Empty( aGet[ 19 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->CodPago )
            aGet[ 19 ]:cText( (dbfClient )->CodPago )
            aGet[ 19 ]:lValid()
         end

         if aGet[14] <> nil
            if ( Empty( aGet[ 14 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cAgente )
               aGet[ 14 ]:cText( ( dbfClient )->cAgente )
               aGet[ 14 ]:lValid()
            end
         end

         if ( Empty( aGet[ 20 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodRut )
            aGet[ 20 ]:cText( ( dbfClient )->cCodRut )
            aGet[ 20 ]:lValid()
         end

         if !Empty( aGet[ 28 ] ) .AND. ( Empty( aGet[ 28 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->nTarifa )
            aGet[ 28 ]:cText( ( dbfClient )->nTarifa )
         end

         if !Empty( aGet[ 55 ] ) .AND. ( Empty( aGet[ 55 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( dbfClient )->cCodTrn )
            aGet[ 55 ]:cText( ( dbfClient )->cCodTrn )
            aGet[ 55 ]:lValid()
         end

         if lChgCodCli

            aGet[ 42 ]:Click( ( dbfClient )->lReq ):Refresh()

            aGet[ 80 ]:Click( ( dbfClient )->lPntVer ):Refresh()

            if ( dbfClient )->lMosCom .AND. !Empty( ( dbfClient )->mComent ) .AND. lChgCodCli
               MsgStop( Trim( ( dbfClient )->mComent ) )
            end





















            aGet[ 29 ]:cText( ( dbfClient )->cDtoEsp )

            aGet[ 30 ]:cText( ( dbfClient )->nDtoEsp )

            aGet[ 31    ]:cText( ( dbfClient )->cDpp )

            aGet[ 32    ]:cText( ( dbfClient )->nDpp )

            aGet[ 33 ]:cText( ( dbfClient )->cDtoUno )

            aGet[ 34 ]:cText( ( dbfClient )->nDtoCnt )

            aGet[ 35 ]:cText( ( dbfClient )->cDtoDos )

            aGet[ 36 ]:cText( ( dbfClient )->nDtoRap )

            aTmp[ 68 ]  := ( dbfClient )->nDtoAtp

            aTmp[ 69 ]  := ( dbfClient )->nSbrAtp

            ShowInciCliente( ( dbfClient )->Cod, dbfCliInc )

         end

      end

      cOldCodCli  := ( dbfClient )->Cod

      lValid      := .T.

    ELSE

        msgStop( "Cliente no encontrado", "Cadena buscada : " + cNewCodCli )
      lValid      := .T.

    end

RETURN lValid



STATIC FUNCTION CreateFiles( cPath )

   if !lExistTable( cPath + "PreCliT.Dbf" )
      dbCreate( cPath + "PreCliT.Dbf", aSqlStruct( aItmPreCli() ), cDriver() )
   end

   if !lExistTable( cPath + "PreCliL.Dbf" )
      dbCreate( cPath + "PreCliL.Dbf", aSqlStruct( aColPreCli() ),  cDriver() )
   end

   if !lExistTable( cPath + "PreCliI.Dbf" )
      dbCreate( cPath + "PreCliI.Dbf", aSqlStruct( aIncPreCli() ),  cDriver() )
   end

   if !lExistTable( cPath + "PreCliD.Dbf" )
      dbCreate( cPath + "PreCliD.Dbf", aSqlStruct( aPreCliDoc() ),  cDriver() )
   end











RETURN NIL



STATIC FUNCTION ChgState( oBrw )

   local nRec

   for each nRec in ( oBrw:aSelected )

      ( dbfPreCliT )->( dbGoTo( nRec ) )

      if dbLock( dbfPreCliT )
         ( dbfPreCliT )->lEstado := !( dbfPreCliT )->lEstado
         ( dbfPreCliT )->( dbRUnlock() )
      end

   next

   oBrw:Refresh()
   oBrw:SetFocus()

RETURN NIL






STATIC FUNCTION lMoreIva( nCodIva )





   IF aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 3, 3 ] == nil
        RETURN .T.
    end

    IF aTotIva[ 1, 3 ] == nCodIva .OR. aTotIva[ 2, 3 ] == nCodIva .OR. aTotIva[ 3, 3 ] == nCodIva
        RETURN .T.
    end

   MsgStop( "Documento con mas de 3 Tipos de " + cImp() )

RETURN .F.
































static function lGenPreCli( oBrw, oBtn, nDevice )

   local bAction

   IIF( nDevice == nil, nDevice := 1, ) ;

   if Empty( oBtn )
      return nil
   end

   IF !( dbfDoc )->( dbSeek( "RC" ) )








         oWndBrw:NewAt( "DOCUMENT",,, {||( msgStop( "No hay pedidos de proveedores predefinidos" ) )}, "No hay documentos", "N",,, 4, oBtn, .F. )

   ELSE

      WHILE ( dbfDoc )->CTIPO == "RC" .AND. !( dbfDoc )->( eof() )

         bAction  := bGenPreCli( nDevice, "Imprimiendo presupuestos a clientes", ( dbfDoc )->CODIGO )

         oWndBrw:NewAt( "Document", , , bAction, Rtrim( ( dbfDoc )->cDescrip ) , , , , , oBtn )

         ( dbfDoc )->( dbSkip() )

      end

   end

   SysRefresh()

return nil



static function bGenPreCli( nDevice, cTitle, cCodDoc )

   local bGen
   local nDev  := by( nDevice )
   local cTit  := by( cTitle    )
   local cCod  := by( cCodDoc   )

   if nDev == 1
      bGen     := {|| nGenPreCli( nDev, cTit, cCod ) }
   else
      bGen     := {|| GenPreCli( nDev, cTit, cCod ) }
   end

return ( bGen )



static function nGenPreCli( nDevice, cTitle, cCodDoc, cPrinter, nCopy )

   local nImpYet     := 1
   local nCopyClient := Retfld( ( dbfPreCliT )->cCodCli, dbfClient, "CopiasF" )

   IIF( nDevice == nil, nDevice := 1, ) ;
   IIF( nCopy == nil, nCopy := Max( nCopyClient, nCopiasDocumento( ( dbfPreCliT )->cSerPre, "nPreCli", dbfCount ) ), ) ;

   nCopy             := Max( nCopy, 1 )

   while nImpYet <= nCopy
      GenPreCli( nDevice, cTitle, cCodDoc, cPrinter )
      nImpYet++
   end


   lChgImpDoc( dbfPreCliT )

return nil



FUNCTION nTotNPreCli( uDbf )

   local nTotUnd

   IIF( uDbf == nil, uDbf := dbfPreCliL, ) ;

   do case
   case ValType( uDbf ) == "A"

      if uDbf[ 68 ]

         nTotUnd  := NotCaja( uDbf[ 7 ] )
         nTotUnd  *= uDbf[ 8 ]
         nTotUnd  *= NotCero( uDbf[ 10 ] )
         nTotUnd  *= NotCero( uDbf[ 65 ] - uDbf[ 66 ] )
         nTotUnd  *= NotCero( uDbf[ 70 ] )
         nTotUnd  *= NotCero( uDbf[ 71 ] )
         nTotUnd  *= NotCero( uDbf[ 72 ] )

      else

         nTotUnd  := NotCaja( uDbf[ 7 ] )
         nTotUnd  *= uDbf[ 8 ]
         nTotUnd  *= NotCero( uDbf[ 10 ] )
         nTotUnd  *= NotCero( uDbf[ 70 ] )
         nTotUnd  *= NotCero( uDbf[ 71 ] )
         nTotUnd  *= NotCero( uDbf[ 72 ] )

      end

   case ValType( uDbf ) == "O"

      if uDbf:lAlquiler

         nTotUnd  := NotCaja( uDbf:nCanPre )
         nTotUnd  *= uDbf:nUniCaja
         nTotUnd  *= NotCero( uDbf:nUndKit )
         nTotUnd  *= NotCero( uDbf:dFecEnt - uDbf:dFecSal )
         nTotUnd  *= NotCero( uDbf:nMedUno )
         nTotUnd  *= NotCero( uDbf:nMedDos )
         nTotUnd  *= NotCero( uDbf:nMedTre )

      else

         nTotUnd  := NotCaja( uDbf:nCanPre )
         nTotUnd  *= uDbf:nUniCaja
         nTotUnd  *= NotCero( uDbf:nUndKit )
         nTotUnd  *= NotCero( uDbf:nMedUno )
         nTotUnd  *= NotCero( uDbf:nMedDos )
         nTotUnd  *= NotCero( uDbf:nMedTre )

      end

   otherwise

      if ( uDbf )->lAlquiler

         nTotUnd  := NotCaja( ( uDbf )->nCanPre )
         nTotUnd  *= ( uDbf )->nUniCaja
         nTotUnd  *= NotCero( ( uDbf )->nUndKit )
         nTotUnd  *= NotCero( ( uDbf )->dFecEnt - ( uDbf )->dFecSal )
         nTotUnd  *= NotCero( ( uDbf )->nMedUno )
         nTotUnd  *= NotCero( ( uDbf )->nMedDos )
         nTotUnd  *= NotCero( ( uDbf )->nMedTre )

      else

         nTotUnd  := NotCaja( ( uDbf )->nCanPre )
         nTotUnd  *= ( uDbf )->nUniCaja
         nTotUnd  *= NotCero( ( uDbf )->nUndKit )
         nTotUnd  *= NotCero( ( uDbf )->nMedUno )
         nTotUnd  *= NotCero( ( uDbf )->nMedDos )
         nTotUnd  *= NotCero( ( uDbf )->nMedTre )

      end

   end

RETURN ( nTotUnd )



STATIC FUNCTION nClrPane( dbfTmpLin )

   local cClr

   if ( dbfTmpLin )->lControl .OR. ( dbfTmpLin )->lTotLin
      cClr     := 14197607
   else
      cClr     := 16777215
   end

return cClr



STATIC FUNCTION nClrText( dbfTmpLin )

   local cClr

   if ( dbfTmpLin )->lKitChl
      cClr     := 8421504
   else
      cClr     := 0
   end

return cClr



FUNCTION nTotIPreCli( dbfLin, nDec, nRouDec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( dbfLin == nil, dbfLin := dbfPreCliL, ) ;
   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRouDec == nil, nRouDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   IF !( dbfLin )->LTOTLIN





      nCalculo       := Round( ( dbfLin )->nValImp, nDec )





      nCalculo       *= nTotNPreCli( dbfLin )

         if ( dbfLin )->LVOLIMP
            nCalculo *= NotCero( ( dbfLin )->nVolumen )
         end

      nCalculo       := Round( nCalculo / nVdv, nRouDec )

   end

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nImpLPreCli( uPreCliT, dbfPreCliL, nDec, nRou, nVdv, lIva, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo
   local lIvaInc

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRou == nil, nRou := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lIva == nil, lIva := .F., ) ;
   IIF( lDto == nil, lDto := .T., ) ;
   IIF( lPntVer == nil, lPntVer := .F., ) ;
   IIF( lImpTrn == nil, lImpTrn := .F., ) ;

   nCalculo          := nTotLPreCli( uPreCliT, dbfPreCliL, nDec, nRou, nVdv, .T., lPntVer, lImpTrn )

   if ValType( uPreCliT ) == "A"
      nCalculo       -= Round( nCalculo * uPreCliT[ 30 ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uPreCliT[ 32    ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uPreCliT[ 34 ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uPreCliT[ 36 ]  / 100, nRou )
      lIvaInc        := uPreCliT[ 52 ]
   else
      nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoEsp / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uPreCliT )->nDpp    / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoUno / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoDos / 100, nRou )
      lIvaInc        := ( uPreCliT )->lIvaInc
   end

   if ( dbfPreCliL )->nIva <> 0
      if lIva
         if !lIvaInc
            nCalculo += Round( nCalculo * ( dbfPreCliL )->nIva / 100, nRou )
         end
      else
         if lIvaInc
            nCalculo -= Round( nCalculo / ( 100 / ( dbfPreCliL )->nIva  + 1 ), nRou )
         end
      end
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nDtoAtpPreCli( uPreCliT, dbfPreCliL, nDec, nRou, nVdv, lPntVer, lImpTrn )

   local nCalculo    := 0
   local nDtoAtp     := 0

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRou == nil, nRou := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lPntVer == nil, lPntVer := .F., ) ;
   IIF( lImpTrn == nil, lImpTrn := .F., ) ;

   nCalculo          := nTotLPreCli( uPreCliT, dbfPreCliL, nDec, nRou, nVdv, .T., lPntVer, lImpTrn )

   if ( uPreCliT )->nSbrAtp <= 1 .AND. ( uPreCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uPreCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoEsp / 100, nRou )

   if ( uPreCliT )->nSbrAtp == 2 .AND. ( uPreCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uPreCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uPreCliT )->nDpp    / 100, nRou )

   if ( uPreCliT )->nSbrAtp == 3 .AND. ( uPreCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uPreCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoUno / 100, nRou )

   if ( uPreCliT )->nSbrAtp == 4 .AND. ( uPreCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uPreCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoDos / 100, nRou )

   if ( uPreCliT )->nSbrAtp == 5 .AND. ( uPreCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uPreCliT )->nDtoAtp / 100, nRou )
   end

RETURN ( nDtoAtp )



FUNCTION nComLPreCli( dbfPreCliT, dbfPreCliL, nDecOut, nDerOut )

   local nImp        := nImpLPreCli( dbfPreCliT, dbfPreCliL, nDecOut, nDerOut )

RETURN ( nImp * ( dbfPreCliL )->nComAge / 100 )



FUNCTION dFecPreCli( cPreCli, dbfPreCliT )

   local dFecPre  := CtoD("")

   IF ( dbfPreCliT )->( dbSeek( cPreCli ) )
      dFecPre  := ( dbfPreCliT )->dFecPre
   end

RETURN ( dFecPre )



FUNCTION lEstPreCli( cPreCli, dbfPreCliT )

   local lEstPre  := .F.

   IF ( dbfPreCliT )->( dbSeek( cPreCli ) )
      lEstPre     := ( dbfPreCliT )->lEstado
   end

RETURN ( lEstPre )



FUNCTION cNbrPreCli( cPreCli, dbfPreCliT )

   local cNomCli  := ""

   IF ( dbfPreCliT )->( dbSeek( cPreCli ) )
      cNomCli  := ( dbfPreCliT )->CNOMCLI
    end

RETURN ( cNomCli )






function nTotDPreCli( cCodArt, dbfPreCliL )

   local nTotVta  := 0
   local nRecno   := ( dbfPreCliL )->( Recno() )

   if ( dbfPreCliL )->( dbSeek( cCodArt ) )

      while ( dbfPreCliL )->CREF == cCodArt .AND. !( dbfPreCliL )->( eof() )

         If !( dbfPreCliL )->LTOTLIN
            nTotVta += nTotNPreCli( dbfPreCliL )
         end

         ( dbfPreCliL )->( dbSkip() )

      end

   end

   ( dbfPreCliL )->( dbGoTo( nRecno ) )

return ( nTotVta )



function nVtaPreCli( cCodCli, dDesde, dHasta, dbfPreCliT, dbfPreCliL, dbfIva, dbfDiv )

   local nCon     := 0
   local nRec     := ( dbfPreCliT )->( Recno() )





   if ( dbfPreCliT )->( dbSeek( cCodCli ) )

      while ( dbfPreCliT )->cCodCli == cCodCli .AND. !( dbfPreCliT )->( Eof() )


         if ( dDesde == nil .OR. ( dbfPreCliT )->dFecPre >= dDesde )    .AND. ( dHasta == nil .OR. ( dbfPreCliT )->dFecPre <= dHasta )

            nCon  += nTotPreCli( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre, dbfPreCliT, dbfPreCliL, dbfIva, dbfDiv, nil, nil, cDivEmp(), .F. )

         end

         ( dbfPreCliT )->( dbSkip() )

      end

   end

   ( dbfPreCliT )->( dbGoTo( nRec ) )

return nCon



FUNCTION aDocPreCli()

   local aDoc  := {}





   aAdd( aDoc, { "Empresa",         "EM" } )
   aAdd( aDoc, { "Presupuesto",     "RC" } )
   aAdd( aDoc, { "Cliente",         "CL" } )
   aAdd( aDoc, { "Almacen",         "AL" } )
   aAdd( aDoc, { "Obras",           "OB" } )
   aAdd( aDoc, { "Rutas",           "RT" } )
   aAdd( aDoc, { "Agentes",         "AG" } )
   aAdd( aDoc, { "Divisas",         "DV" } )
   aAdd( aDoc, { "Formas de pago",  "PG" } )
   aAdd( aDoc, { "Transportistas",  "TR" } )

RETURN ( aDoc )



function aItmPreCli()

   local aItmPreCli :=  {}

   aAdd( aItmPreCli, { "CSERPRE",   "C",  1,  0, "Serie de presupuesto" ,           "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NNUMPRE",   "N",  9,  0, "Número de presupuesto" ,          "'999999999'",        "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CSUFPRE",   "C",  2,  0, "Sufijo de presupuesto" ,          "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CTURPRE",   "C",  6,  0, "Sesión del presupuesto",          "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "DFECPRE",   "D",  8,  0, "Fecha del presupuesto",           "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CCODCLI",   "C", 12,  0, "Código del cliente",              "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CNOMCLI",   "C", 80,  0, "Nombre del cliente",              "'@!'",               "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CDIRCLI",   "C",100,  0, "Domicilio del cliente",           "'@!'",               "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CPOBCLI",   "C", 35,  0, "Población del cliente",           "'@!'",               "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CPRVCLI",   "C", 20,  0, "Provincia del cliente",           "'@!'",               "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CPOSCLI",   "C", 15,  0, "Código postal del cliente",       "'@!'",               "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CDNICLI",   "C", 30,  0, "DNI del cliente",                 "'@!'",               "", "( cDbf )"} )
   aAdd( aItmPreCli, { "LMODCLI",   "L",  1,  0, "Modificar datos del cliente",     "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CCODAGE",   "C",  3,  0, "Código del agente",               "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CCODOBR",   "C", 10,  0, "Código de obra",                  "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CCODTAR",   "C",  5,  0, "Código de tarifa",                "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CCODALM",   "C",  3,  0, "Código del almacen",              "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CCODCAJ",   "C",  3,  0, "Código de caja",                  "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CCODPGO",   "C",  2,  0, "Código de pago",                  "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CCODRUT",   "C",  4,  0, "Código de la ruta",               "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "DFECENT",   "D",  8,  0, "Fecha de entrada",                "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "LESTADO",   "L",  1,  0, "Estado del presupuesto",          "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CSUPRE",    "C", 10,  0, "Su presupuesto",                  "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CCONDENT",  "C",100,  0, "",                                "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "MCOMENT",   "M", 10,  0, "Comentarios",                     "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "MOBSERV",   "M", 10,  0, "Observaciones",                   "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "LMAYOR",    "L",  1,  0, "" ,                               "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NTARIFA",   "N",  1,  0, "Tarifa de precio aplicada" ,      "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CDTOESP",   "C", 50,  0, "Descripción del descuento",       "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NDTOESP",   "N",  5,  2, "Porcentaje de descuento",         "'@EZ 99,99'",        "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CDPP",      "C", 50,  0, "Descripción del descuento por pronto pago","",          "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NDPP",      "N",  5,  2, "Pct. de dto. por pronto pago",    "'@EZ 99,99'",        "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CDTOUNO",   "C", 50,  0, "Desc. del primer descuento pers.","'@!'",               "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NDTOUNO",   "N",  5,  2, "Pct. del primer descuento pers.", "'@EZ 99,99'",        "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CDTODOS",   "C", 50,  0, "Desc. del segundo descuento pers.","'@!'",              "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NDTODOS",   "N",  5,  2, "Pct. del segundo descuento pers.","'@EZ 99,99'",        "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NDTOCNT",   "N",  5,  2, "Pct. de dto. por pago contado",   "'@EZ 99,99'",        "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NDTORAP",   "N",  5,  2, "Pct. de dto. por rappel",         "'@EZ 99,99'",        "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NDTOPUB",   "N",  5,  2, "Pct. de dto. por publicidad",     "'@EZ 99,99'",        "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NDTOPGO",   "N",  5,  2, "Pct. de dto. por pago centralizado", "'@EZ 99,99'",     "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NDTOPTF",   "N",  7,  2, "",                                "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "LRECARGO",  "L",  1,  0, "Aplicar recargo de equivalencia", "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NPCTCOMAGE","N",  5,  2, "Pct. de comisión del agente",     "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NBULTOS",   "N",  3,  0, "Numero de bultos",                "'999'",              "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CNUMALB",   "C", 10,  0, "" ,                               "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CDIVPRE",   "C",  3,  0, "Código de divisa",                "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NVDVPRE",   "N", 10,  4, "Valor del cambio de la divisa",   "'@EZ 999,999.9999'", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "LSNDDOC",   "L",  1,  0, "Valor lógico documento enviado",  "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CRETPOR",   "C",150,  0, "Retirado por" ,                   "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CRETMAT",   "C",150,  0, "Matrícula" ,                      "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NREGIVA",   "N",  1,  0, "Regimen de " + cImp() ,           "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "LIVAINC",   "L",  1,  0, "Lógico de " + cImp() + " incluido" ,        "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NIVAMAN",   "N",  6,  2, "Porcentaje de " + cImp() + " del gasto" ,   "'@EZ 999,99'",       "", "( cDbf )"} )
   aAdd( aItmPreCli, { "NMANOBR",   "N", 16,  6, "Gastos" ,                         "cPorDivPre",         "", "( cDbf )"} )
   aAdd( aItmPreCli, { "cCodTrn",   "C",  9,  0, "Código de transportista" ,        "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "nKgsTrn"   ,"N", 16,  6, "TARA del transportista" ,         "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "lCloPre",   "L",  1,  0, "" ,                               "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "cCodUsr",   "C",  3,  0, "Código de usuario",               "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "dFecCre",   "D",  8,  0, "Fecha de creación del documento", "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "cTimCre",   "C",  5,  0, "Hora de creación del documento",  "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "cSituac",   "C", 20,  0, "Situación del documento",         "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "nDiaVal",   "N",  3,  0, "Dias de validez",                 "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "cCodGrp",   "C",  4,  0, "Código de grupo de cliente",      "",                   "", "( cDbf )"} )
   aAdd( aItmPreCli, { "lImprimido","L",  1,  0, "Lógico de imprimido del documento",                 "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "dFecImp",   "D",  8,  0, "Última fecha de impresión del documento",           "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "cHorImp",   "C",  5,  0, "Hora de la última impresión del documento",         "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "cCodDlg",   "C",  2,  0, "Código delegación" ,                                "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "nDtoAtp",   "N",  6,  2, "Porcentaje de descuento atípico",                   "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "nSbrAtp",   "N",  1,  0, "Lugar donde aplicar dto atípico",                   "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "dFecEntr",  "D",  8,  0, "Fecha de entrada de alquiler",                      "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "dFecSal",   "D",  8,  0, "fecha de salidad de alquiler",                      "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "lAlquiler", "L",  1,  0, "Lógico de alquiler",                                "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "cManObr",   "C",250,  0, "Literal de gastos" ,                                "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "cNumTik",   "C", 13,  0, "Número del ticket generado" ,                       "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "CTLFCLI",   "C", 20,  0, "Teléfono del cliente" ,                             "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "nTotNet",   "N", 16,  6, "Total neto" ,                                       "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "nTotIva",   "N", 16,  6, "Total " + cImp() ,                                  "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "nTotReq",   "N", 16,  6, "Total recargo" ,                                    "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "nTotPre",   "N", 16,  6, "Total presupuesto" ,                                "", "", "( cDbf )"} )
   aAdd( aItmPreCli, { "lOperPV",   "L",  1,  0, "Lógico para operar con punto verde" ,               "", "", "( cDbf )", .T.} )

return ( aItmPreCli )



function aCalPreCli()












































   local aCalPreCli  := {  { "nTotArt",                                                   "N", 16,  6, "Total artículos",             "cPicUndPre",  "" }, { "nTotCaj",                                                   "N", 16,  6, "Total cajas",                 "cPicUndPre",  "" }, { "aTotIva[1,1]",                                              "N", 16,  6, "Bruto primer tipo de " + cImp(),    "cPorDivPre",  "aTotIva[1,1] != 0" }, { "aTotIva[2,1]",                                              "N", 16,  6, "Bruto segundo tipo de " + cImp(),   "cPorDivPre",  "aTotIva[2,1] != 0" }, { "aTotIva[3,1]",                                              "N", 16,  6, "Bruto tercer tipo de " + cImp(),    "cPorDivPre",  "aTotIva[3,1] != 0" }, { "aTotIva[1,2]",                                              "N", 16,  6, "Base primer tipo de " + cImp(),     "cPorDivPre",  "aTotIva[1,2] != 0" }, { "aTotIva[2,2]",                                              "N", 16,  6, "Base segundo tipo de " + cImp(),    "cPorDivPre",  "aTotIva[2,2] != 0" }, { "aTotIva[3,2]",                                              "N", 16,  6, "Base tercer tipo de " + cImp(),     "cPorDivPre",  "aTotIva[3,2] != 0" }, { "aTotIva[1,3]",                                              "N",  5,  2, "Porcentaje primer tipo " + cImp(),  "'@R 99.99%'", "aTotIva[1,3] != 0" }, { "aTotIva[2,3]",                                              "N",  5,  2, "Porcentaje segundo tipo " + cImp(), "'@R 99.99%'", "aTotIva[2,3] != 0" }, { "aTotIva[3,3]",                                              "N",  5,  2, "Porcentaje tercer tipo " + cImp(),  "'@R 99.99%'", "aTotIva[3,3] != 0" }, { "aTotIva[1,4]",                                              "N",  5,  2, "Porcentaje primer tipo RE",   "'@R 99.99%'", "aTotIva[1,4] != 0" }, { "aTotIva[2,4]",                                              "N",  5,  2, "Porcentaje segundo tipo RE",  "'@R 99.99%'", "aTotIva[2,4] != 0" }, { "aTotIva[3,4]",                                              "N",  5,  2, "Porcentaje tercer tipo RE",   "'@R 99.99%'", "aTotIva[3,4] != 0" }, { "round( aTotIva[1,2] * aTotIva[1,3] / 100, nDouDivPre )",    "N", 16,  6, "Importe primer tipo " + cImp(),     "cPorDivPre",  "aTotIva[1,2] != 0" }, { "round( aTotIva[2,2] * aTotIva[2,3] / 100, nDouDivPre )",    "N", 16,  6, "Importe segundo tipo " + cImp(),    "cPorDivPre",  "aTotIva[2,2] != 0" }, { "round( aTotIva[3,2] * aTotIva[3,3] / 100, nDouDivPre )",    "N", 16,  6, "Importe tercer tipo " + cImp(),     "cPorDivPre",  "aTotIva[3,2] != 0" }, { "round( aTotIva[1,2] * aTotIva[1,4] / 100, nDouDivPre )",    "N", 16,  6, "Importe primer RE",           "cPorDivPre",  "aTotIva[1,2] != 0" }, { "round( aTotIva[2,2] * aTotIva[2,4] / 100, nDouDivPre )",    "N", 16,  6, "Importe segundo RE",          "cPorDivPre",  "aTotIva[2,2] != 0" }, { "round( aTotIva[3,2] * aTotIva[3,4] / 100, nDouDivPre )",    "N", 16,  6, "Importe tercer RE",           "cPorDivPre",  "aTotIva[3,2] != 0" }, { "aTotIvm[1,1]",                                              "N", 16,  6, "Total unidades primer tipo de impuestos especiales",    "cPorDivPre",  "aTotIvm[1,1] != 0" }, { "aTotIvm[2,1]",                                              "N", 16,  6, "Total unidades segundo tipo de impuestos especiales",   "cPorDivPre",  "aTotIvm[2,1] != 0" }, { "aTotIvm[3,1]",                                              "N", 16,  6, "Total unidades tercer tipo de impuestos especiales",    "cPorDivPre",  "aTotIvm[3,1] != 0" }, { "aTotIva[1,2]",                                              "N", 16,  6, "Importe del primer tipo de impuestos especiales",       "cPorDivPre",  "aTotIvm[1,2] != 0" }, { "aTotIva[2,2]",                                              "N", 16,  6, "Importe del segundo tipo de impuestos especiales",      "cPorDivPre",  "aTotIvm[2,2] != 0" }, { "aTotIva[3,2]",                                              "N", 16,  6, "Importe del tercer tipo de impuestos especiales",       "cPorDivPre",  "aTotIvm[3,2] != 0" }, { "aTotIvm[1,3]",                                              "N", 16,  6, "Total importe primer tipo de impuestos especiales",     "cPorDivPre",  "aTotIvm[1,3] != 0" }, { "aTotIvm[2,3]",                                              "N", 16,  6, "Total importe segundo tipo de impuestos especiales",    "cPorDivPre",  "aTotIvm[2,3] != 0" }, { "aTotIvm[3,3]",                                              "N", 16,  6, "Total importe tercer tipo de impuestos especiales",     "cPorDivPre",  "aTotIvm[3,3] != 0" }, { "nTotBrt",                                                   "N", 16,  6, "Total bruto",                 "cPorDivPre",  "lEnd" }, { "nTotDto",                                                   "N", 16,  6, "Total descuento",             "cPorDivPre",  "lEnd" }, { "nTotDpp",                                                   "N", 16,  6, "Total descuento pronto pago", "cPorDivPre",  "lEnd" }, { "nTotNet",                                                   "N", 16,  6, "Total neto",                  "cPorDivPre",  "lEnd" }, { "nTotIva",                                                   "N", 16,  6, "Total " + cImp(),             "cPorDivPre",  "lEnd" }, { "nTotIvm",                                                   "N", 16,  6, "Total IVMH",                  "cPorDivPre",  "lEnd" }, { "nTotReq",                                                   "N", 16,  6, "Total RE",                    "cPorDivPre",  "lEnd" }, { "nTotPre",                                                   "N", 16,  6, "Total presupuesto",           "cPorDivPre",  "lEnd" }, { "nTotPes",                                                   "N", 16,  6, "Total peso",                  "'@E 99,999.99'","lEnd" }, { "nTotCos",                                                   "N", 16,  6, "Total costo",                 "cPorDivPre",  "lEnd" }, { "nTotPage",                                                  "N", 16,  6, "Total página",                "cPorDivPre",  "!lEnd" }, { "nImpEuros( nTotPre, (cDbf)->cDivPre, cDbfDiv )",            "N", 16,  6, "Total Presupuesto (Euros)",   "",            "lEnd" }, { "nImpPesetas( nTotPre, (cDbf)->cDivPre, cDbfDiv )",          "N", 16,  6, "Total Presupuesto (Pesetas)", "",            "lEnd" }, { "nPagina",                                                   "N",  2,  0, "Numero de página",            "'99'",        "" }, { "lEnd",                                                      "L",  1,  0, "Fin del documento",           "",            "" } }

return ( aCalPreCli )



function aColPreCli()

   local aColPreCli  := {}

   aAdd( aColPreCli, { "CSERPRE", "C",    1,  0, "Serie de presupuesto" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NNUMPRE", "N",    9,  0, "Numero de presupuesto" ,           "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CSUFPRE", "C",    2,  0, "Sufijo de presupuesto" ,           "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CREF",    "C",   18,  0, "Referencia del producto" ,         "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CDETALLE","C",  250,  0, "" ,                                "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NIVA"    ,"N",    6,  2, "Importe del " + cImp() ,                 "'@E 99.9'",          "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NCANPRE" ,"N",   16,  6, "Cantidad pedida" ,                 "MasUnd()",           "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NUNICAJA","N",   16,  6, "Unidades por caja" ,               "MasUnd()",           "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "LCONTROL","L",    1,  0, "" ,                                "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NUNDKIT", "N",   16,  6, "Unidades tipo kit" ,               "MasUnd()",           "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NPREDIV" ,"N",   16,  6, "Importe del producto" ,            "cPorDivPre",         "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NPNTVER", "N",   16,  6, "Importe punto verde" ,             "cPorDivPre",         "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "nImpTrn", "N",   16,  6, "Importe del transporte",           "cPorDivPre",         "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NDTO",    "N",    6,  2, "Descuento del producto" ,          "'@E 99.99'",         "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NDTOPRM", "N",    6,  2, "Descuento de la promoción" ,       "'@E 99.99'",         "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NCOMAGE", "N",    6,  2, "Comisión del agente" ,             "'@E 99.99'",         "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NCANENT", "N",   16,  6, "Unidades de entrada" ,             "MasUnd()",           "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CUNIDAD", "C",    2,  0, "Unidad de venta" ,                 "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NPESOKG", "N",   16,  6, "Peso del producto" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "cPesoKg", "C",    2,  0, "Unidad de peso del producto" ,     "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "DFECHA",  "D",    8,  0, "Fecha de entrega",                 "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "MLNGDES", "M",   10,  0, "Descripción de artículo sin codificar", "",              "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "LTOTLIN", "L",    1,  0, "Linea de total" ,                  "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "LIMPLIN", "L",    1,  0, "Linea no imprimible" ,             "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CCODPR1", "C",   10,  0, "Código de la primera propiedad",   "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CCODPR2", "C",   10,  0, "Código de la segunda propiedad",   "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CVALPR1", "C",   10,  0, "Valor de la primera propiedad",    "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CVALPR2", "C",   10,  0, "Valor de la segunda propiedad",    "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NFACCNV", "N",   16,  6, "Factor de conversión de la compra","",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NDTODIV", "N",   16,  6, "Descuento lineal de la compra",    "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CTIPMOV", "C",    2,  0, "Tipo de movimiento",               "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NNUMLIN", "N",    4,  0, "Numero de la línea",               "'9999'",             "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NCTLSTK", "N",    1,  0, "Tipo de stock de la línea",        "'9'",                "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NCOSDIV", "N",   16,  6, "Costo del producto" ,              "cPorDivPre",         "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NPVPREC", "N",   16,  6, "Precio de venta recomendado" ,     "cPorDivPre",         "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CALMLIN", "C",    3,  0, "Código de almacén" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "LIVALIN", "L",    1,  0, "Línea con " + cImp() + " incluido",           "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CCODIMP", "C",    3,  0, "Código del impuesto especial",     "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NVALIMP", "N",   16,  6, "Importe de impuesto",              "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "LLOTE",   "L",    1,  0, "",                                 "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NLOTE",   "N",    9,  0, "",                                 "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CLOTE",   "C",   12,  0, "Número de Lote",                   "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "LKITART", "L",    1,  0, "Línea con escandallo",             "" ,                  "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "LKITCHL", "L",    1,  0, "Línea pertenciente a escandallo",  "" ,                  "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "LKITPRC", "L",    1,  0, "",                                 "" ,                  "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NMESGRT", "N",    2,  0, "Meses de garantía",                "'99'",               "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "LMSGVTA", "L",    1,  0, "Avisar en venta sin stocks",       "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "LNOTVTA", "L",    1,  0, "No permitir venta sin stocks",     "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "MNUMSER", "M",   10,  0, "" ,                                "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CCODTIP", "C",    3,  0, "Código del tipo de artículo",      "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CCODFAM", "C",   16,  0, "Código de familia",                "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CGRPFAM", "C",    3,  0, "Código del grupo de familia",      "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NREQ",    "N",    6,  2, "Recargo de equivalencia",          "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "MOBSLIN", "M",   10,  0, "Observacion de línea",             "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CCODPRV", "C",   12,  0, "Código del proveedor",             "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CNOMPRV", "C",   30,  0, "Nombre del proveedor",             "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CIMAGEN", "C",  250,  0, "Fichero de imagen" ,               "",                   "", "( cDbfCol )", .T. } )
   aAdd( aColPreCli, { "NPUNTOS", "N",   15,  6, "Puntos del artículo",              "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NVALPNT", "N",   16,  6, "Valor del punto",                  "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NDTOPNT", "N",    5,  2, "Descuento puntos",                 "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NINCPNT", "N",    5,  2, "Incremento porcentual",            "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CREFPRV", "C",   18,  0, "Referencia artículo proveedor",    "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "NVOLUMEN","N",   16,  6, "Volumen del producto" ,            "'@E 9,999.99'",      "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "CVOLUMEN","C",    2,  0, "Unidad del volumen" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "DFECENT" ,"D",    8,  0, "Fecha de entrada del alquiler",    "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "DFECSAL" ,"D",    8,  0, "Fecha de salida del alquiler",     "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "nPreAlq" ,"N",   16,  6, "Precio de alquiler",               "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "lAlquiler","L",   1,  0, "Lógico de alquiler",               "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "nNumMed"  ,"N",   1,  0, "Número de mediciones",             "MasUnd()",           "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "nMedUno"  ,"N",  16,  6, "Primera unidad de medición",       "MasUnd()",           "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "nMedDos"  ,"N",  16,  6, "Segunda unidad de medición",       "MasUnd()",           "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "nMedTre"  ,"N",  16,  6, "Tercera unidad de medición",       "MasUnd()",           "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "nTarLin"  ,"N",   1,  0, "Tarifa de precio aplicada" ,       "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "lImpFra"  ,"L",   1,  0, "Lógico de imprimir frase publicitaria", "",              "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "cCodFra"  ,"C",   3,  0, "Código de frase publicitaria",     "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "cTxtFra"  ,"C", 250,  0, "",                                 "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "Descrip"  ,"M",  10,  0, "Descripción larga",                "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "lLinOfe"  ,"L",   1,  0, "Línea con oferta",                 "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "lVolImp"  ,"L",   1,  0, "Lógico aplicar volumen con IpusEsp",  "",                "", "( cDbfCol )" } )

return ( aColPreCli )



function aCocPreCli()

   local aCocPreCli :=  {}

   aAdd( aCocPreCli, { "Descrip( cDbfCol )",                                         "C", 50, 0, "Detalle del artículo",       "",            "Descripción", "" } )
   aAdd( aCocPreCli, { "nTotNPreCli( cDbfCol )",                                     "N", 16, 6, "Total articulos",            "MasUnd()",    "Unidades",    "" } )
   aAdd( aCocPreCli, { "nTotUPreCli( cDbfCol, nDouDivPre, nVdvDivPre )",             "N", 16, 6, "Precio unitario",            "cPouDivPre",  "Precio",      "" } )
   aAdd( aCocPreCli, { "nTotLPreCli( cDbfCol, nDouDivPre, nRouDivPre, nVdvDivPre )", "N", 16, 6, "Total línea de presupuesto", "cPorDivPre",  "Total",       "" } )
   aAdd( aCocPreCli, { "cFrasePublicitaria( cDbfCol )",                              "C", 50, 0, "Texto de frase publicitaria","",            "Publicidad",  "" } )

return ( aCocPreCli )



function aIncPreCli()

   local aColPreCli  := {}

   aAdd( aColPreCli, { "cSerPre", "C",    1,  0, "Serie de presupuesto" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "nNumPre", "N",    9,  0, "Numero de presupuesto" ,           "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "cSufPre", "C",    2,  0, "Sufijo de presupuesto" ,           "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "cCodTip", "C",    3,  0, "Tipo de incidencia" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "dFecInc", "D",    8,  0, "Fecha de la incidencia" ,          "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "mDesInc", "M",   10,  0, "Descripción de la incidencia" ,    "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "lListo",  "L",    1,  0, "Lógico de listo" ,                 "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "lAviso",  "L",    1,  0, "Lógico de aviso" ,                 "",                   "", "( cDbfCol )" } )

return ( aColPreCli )



function aPreCliDoc()

   local aPreCliDoc  := {}

   aAdd( aPreCliDoc, { "cSerPre", "C",    1,  0, "Serie de presupuesto" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aPreCliDoc, { "nNumPre", "N",    9,  0, "Numero de presupuesto" ,           "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aPreCliDoc, { "cSufPre", "C",    2,  0, "Sufijo de presupuesto" ,           "",                   "", "( cDbfCol )" } )
   aAdd( aPreCliDoc, { "cNombre", "C",  250,  0, "Nombre del documento" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aPreCliDoc, { "cRuta",   "C",  250,  0, "Ruta del documento" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aPreCliDoc, { "mObsDoc", "M",   10,  0, "Observaciones del documento" ,     "",                   "", "( cDbfCol )" } )

return ( aPreCliDoc )



STATIC FUNCTION RecPreCli( aTmpPre )

    local nDtoAge
   local nImpAtp  := 0
   local nImpOfe  := 0
   local nRecno
   local cCodFam




   if !ApoloMsgNoYes( "¡Atención!,"                                      + Chr(13)+Chr(10) +  "todos los precios se recalcularán en función de"  + Chr(13)+Chr(10) +  "los valores en las bases de datos.", "¿Desea proceder?" )
      return nil
   end

   nRecno         := ( dbfTmpLin )->( RecNo() )

   ( dbfTmpLin )->( dbGotop() )
   ( dbfArticulo )->( ordSetFocus( "CODIGO" ) )

   while !( dbfTmpLin )->( eof() )





      if ( dbfArticulo )->( dbSeek( ( dbfTmpLin )->cRef ) )

         if aTmpPre[ 51 ] <= 1
            ( dbfTmpLin )->nIva     := nIva( dbfIva, ( dbfArticulo )->TipoIva )
            ( dbfTmpLin )->nReq     := nReq( dbfIva, ( dbfArticulo )->TipoIva )
         end





         if !Empty( ( dbfArticulo )->cCodImp )
            ( dbfTmpLin )->cCodImp  := ( dbfArticulo )->cCodImp
            ( dbfTmpLin )->nValImp  := oNewImp:nValImp( ( dbfArticulo )->cCodImp, aTmpPre[ 52 ], ( dbfTmpLin )->nIva )
         end





         ( dbfTmpLin )->nPreDiv  := nRetPreArt( ( dbfTmpLin )->nTarLin, aTmpPre[ 46 ], aTmpPre[ 52 ], dbfArticulo, dbfDiv, dbfKit, dbfIva )





         ( dbfTmpLin )->nCtlStk  := ( dbfArticulo )->nCtlStock
         ( dbfTmpLin )->nPvpRec  := ( dbfArticulo )->PvpRec
         ( dbfTmpLin )->nCosDiv  := nCosto( nil, dbfArticulo, dbfKit )





         ( dbfTmpLin )->nPntVer  := ( dbfArticulo )->nPntVer1





         do case

         case lSeekAtpArt( aTmpPre[ 6 ] + ( dbfTmpLin )->cRef, ( dbfTmpLin )->cCodPr1 + ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1 + ( dbfTmpLin )->cValPr2, aTmpPre[ 5 ], dbfCliAtp ) .AND.  ( dbfCliAtp )->lAplPre

               nImpAtp  := nImpAtp( ( dbfTmpLin )->nTarLin, dbfCliAtp )
               if nImpAtp <> 0
                  ( dbfTmpLin )->nPreDiv  := nImpAtp
               end

               nImpAtp  := nDtoAtp( ( dbfTmpLin )->nTarLin, dbfCliAtp )
               if nImpAtp <> 0
                  ( dbfTmpLin )->nDto     := nImpAtp
               end

               if ( dbfCliAtp )->nDprArt <> 0
                  ( dbfTmpLin )->nDtoPrm  := ( dbfCliAtp )->nDprArt
               end

               if ( dbfCliAtp )->nComAge <> 0
                  ( dbfTmpLin )->nComAge  := ( dbfCliAtp )->nComAge
               end





         case !Empty( aTmpPre[ 16 ] )

            cCodFam  := ( dbfTmpLin )->cCodFam

            nImpOfe  := RetPrcTar( ( dbfTmpLin )->cRef, aTmpPre[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL, ( dbfTmpLin )->nTarLin )
            if nImpOfe <> 0
               ( dbfTmpLin )->nPreDiv  := nImpOfe
            end

            nImpOfe  := RetPctTar( ( dbfTmpLin )->cRef, cCodFam, aTmpPre[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL )
            if nImpOfe <> 0
               ( dbfTmpLin )->nDto     := nImpOfe
            end

            nImpOfe  := RetComTar( ( dbfTmpLin )->cRef, cCodFam, aTmpPre[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpPre[ 14 ], dbfTarPreL, dbfTarPreS )
            if nImpOfe <> 0
               ( dbfTmpLin )->nComAge  := nImpOfe
            end





            nImpOfe  := RetDtoPrm( ( dbfTmpLin )->cRef, cCodFam, aTmpPre[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpPre[ 5 ], dbfTarPreL )
            if nImpOfe <> 0
               ( dbfTmpLin )->nDtoPrm  := nImpOfe
            end





            nDtoAge  := RetDtoAge( ( dbfTmpLin )->cRef, cCodFam, aTmpPre[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpPre[ 5 ], aTmpPre[ 14 ], dbfTarPreL, dbfTarPreS )
            if nDtoAge <> 0
               ( dbfTmpLin )->nComAge  := nDtoAge
            end

         end





         nImpOfe     := nImpOferta( ( dbfTmpLin )->cRef, aTmpPre[ 6 ], aTmpPre[ 63 ], ( dbfTmpLin )->nUniCaja, aTmpPre[ 5 ], dbfOferta, ( dbfTmpLin )->nTarLin, nil, ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2 )
         if nImpOfe  <> 0
            ( dbfTmpLin )->nPreDiv     := nCnv2Div( nImpOfe, cDivEmp(), aTmpPre[ 46 ], dbfDiv )
         end





         nImpOfe     := nDtoOferta( ( dbfTmpLin )->cRef, aTmpPre[ 6 ], aTmpPre[ 63 ], ( dbfTmpLin )->nUniCaja, aTmpPre[ 5 ], dbfOferta, ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2 )
         if nImpOfe  <> 0
            ( dbfTmpLin )->nDtoPrm  := nImpOfe
         end

      end

      ( dbfTmpLin )->( dbSkip() )

   end

   ( dbfTmpLin )->( dbGoTo( nRecno ) )

return nil



Function SynPreCli( cPath )

   local oError
   local oBlock
   local aTotPre

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLIT.DBF" ), ( cCheckArea( "PRECLIT", @dbfPreCliT ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLIL.DBF" ), ( cCheckArea( "PRECLIL", @dbfPreCliL ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLII.DBF" ), ( cCheckArea( "PRECLII", @dbfPreCliI ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatArt() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatArt() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatArt() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatGrp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), if(.F. .OR. .T., !.T., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatGrp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      while !( dbfPreCliT )->( eof() )

         if Empty( ( dbfPreCliT )->cCodCaj )
            ( dbfPreCliT )->cCodCaj := "000"
         end

         if Empty( ( dbfPreCliT )->cCodGrp )
            ( dbfPreCliT )->cCodGrp := RetGrpCli( ( dbfPreCliT )->cCodCli, dbfClient )
         end

         if !( ( dbfPreCliT )->cSerPre >= "A" .AND. ( dbfPreCliT )->cSerPre <= "Z" )
            ( dbfPreCliT )->( dbDelete() )
         end





         if ( dbfPreCliT )->nTotPre == 0 .AND. dbLock( dbfPreCliT )

            aTotPre                 := aTotPreCli( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre, dbfPreCliT, dbfPreCliL, dbfIva, dbfDiv, dbfFPago, ( dbfPreCliT )->cDivPre )

            ( dbfPreCliT )->nTotNet := aTotPre[1]
            ( dbfPreCliT )->nTotIva := aTotPre[2]
            ( dbfPreCliT )->nTotReq := aTotPre[3]
            ( dbfPreCliT )->nTotPre := aTotPre[4]

            ( dbfPreCliT )->( dbUnLock() )

         end

         ( dbfPreCliT )->( dbSkip() )

      end

      while !( dbfPreCliL )->( eof() )

         if !( dbfPreCliT )->( dbSeek( ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->nNumPre ) + ( dbfPreCliL )->cSufPre ) )

            ( dbfPreCliL )->( dbDelete() )

         else

            if Empty( ( dbfPreCliL )->cLote ) .AND. !Empty( ( dbfPreCliL )->nLote )
               ( dbfPreCliL )->cLote   := AllTrim( Str( ( dbfPreCliL )->nLote ) )
            end

            if ( dbfPreCliL )->lIvaLin == ( dbfPreCliT )->lIvaInc
               ( dbfPreCliL )->lIvaLin := ( dbfPreCliT )->lIvaInc
            end

            if !Empty( ( dbfPreCliL )->cRef ) .AND. Empty( ( dbfPreCliL )->cCodFam )
               ( dbfPreCliL )->cCodFam := RetFamArt( ( dbfPreCliL )->cRef, dbfArticulo )
            end

            if !Empty( ( dbfPreCliL )->cRef ) .AND. !Empty( ( dbfPreCliL )->cCodFam )
               ( dbfPreCliL )->cGrpFam := cGruFam( ( dbfPreCliL )->cCodFam, dbfFamilia )
            end

            if Empty( ( dbfPreCliL )->nReq )
               ( dbfPreCliL )->nReq    := nPReq( dbfIva, ( dbfPreCliL )->nIva )
            end

         end

         ( dbfPreCliL )->( dbSkip() )

         SysRefresh()

      end

      while !( dbfPreCliI )->( eof() )

         if !( dbfPreCliT )->( dbSeek( ( dbfPreCliI )->cSerPre + Str( ( dbfPreCliI )->nNumPre ) + ( dbfPreCliI )->cSufPre ) )
            ( dbfPreCliI )->( dbDelete() )
         end

         ( dbfPreCliI )->( dbSkip() )

         SysRefresh()

      end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfPreCliT )->( dbCloseArea() )
   ( dbfPreCliL )->( dbCloseArea() )
   ( dbfPreCliI )->( dbCloseArea() )
   ( dbfArticulo)->( dbCloseArea() )
   ( dbfFamilia )->( dbCloseArea() )
   ( dbfIva     )->( dbCloseArea() )
   ( dbfDiv     )->( dbCloseArea() )
   ( dbfFPago   )->( dbCloseArea() )

return nil



Function EdtIva( oColumn, uVal, nIvaAnt, dbfTmpLin, dbfIva, oBrw )

   local nRec        := ( dbfTmpLin )->( Recno() )

   if Valtype( uVal ) <> "N"
      uVal           := Val( uVal )
   end

   if uVal <> nIvaAnt

      if lTiva( dbfIva, uVal )





         if !lShwKit()
            ( dbfTmpLin )->( dbClearFilter() )
         end

         ( dbfTmpLin )->( dbGoTop() )

         while !( dbfTmpLin )->( eof() )

            if ( dbfTmpLin )->nIva == nIvaAnt
               ( dbfTmpLin )->nIva := uVal
               ( dbfTmpLin )->nReq := nPorcentajeRE( dbfIva, uVal )
            end

            ( dbfTmpLin )->( dbSkip() )

         end





         if !lShwKit()
            ( dbfTmpLin )->( dbSetFilter( {|| ! Field->lKitChl }, "!lKitChl" ) )
         end

         ( dbfTmpLin )->( dbGoTo( nRec ) )

      end

      oBrw:Refresh()

   end

return .T.



_HB_CLASS TPresupuestosClientesSenderReciver ; UTILITY FUNCTION TPresupuestosClientesSenderReciver(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TPresupuestosClientesSenderReciver" , {TSenderReciverItem():classh} ) ) ; ;

   _HB_MEMBER CreateData(); IIF( .F., s_oClass:ModMethod( "CreateData", @TPresupuestosClientesSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CreateData", @TPresupuestosClientesSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER RestoreData(); IIF( .F., s_oClass:ModMethod( "RestoreData", @TPresupuestosClientesSenderReciver_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "RestoreData", @TPresupuestosClientesSenderReciver_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER SendData(); IIF( .F., s_oClass:ModMethod( "SendData", @TPresupuestosClientesSenderReciver_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SendData", @TPresupuestosClientesSenderReciver_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER ReciveData(); IIF( .F., s_oClass:ModMethod( "ReciveData", @TPresupuestosClientesSenderReciver_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "ReciveData", @TPresupuestosClientesSenderReciver_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Process(); IIF( .F., s_oClass:ModMethod( "Process", @TPresupuestosClientesSenderReciver_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Process", @TPresupuestosClientesSenderReciver_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TPresupuestosClientesSenderReciver ;



UTILITY STATIC function TPresupuestosClientesSenderReciver_CreateData() ; local Self AS CLASS TPresupuestosClientesSenderReciver := QSelf() AS CLASS TPresupuestosClientesSenderReciver

   local oBlock
   local oError
   local lSnd        := .F.
   local dbfPreCliT
   local dbfPreCliL
   local dbfPreCliI
   local tmpPreCliT
   local tmpPreCliL
   local tmpPreCliI
   local cFileName   := "PreCli" + StrZero( ::nGetNumberToSend(), 6 ) + "." + RetSufEmp()

   ::oSender:SetText( "Enviando presupuestos de clientes" )

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliT.DBF" ), ( cCheckArea( "PreCliT", @dbfPreCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliL.DBF" ), ( cCheckArea( "PreCliL", @dbfPreCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliI.DBF" ), ( cCheckArea( "PreCliI", @dbfPreCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end





   rxPreCli( cPatSnd() )

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "PreCliT.DBF" ), ( cCheckArea( "PreCliT", @tmpPreCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "PreCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "PreCliL.DBF" ), ( cCheckArea( "PreCliL", @tmpPreCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "PreCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "PreCliI.DBF" ), ( cCheckArea( "PreCliI", @tmpPreCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "PreCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   if !Empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( dbfPreCliT )->( LastRec() )
   end

   while !( dbfPreCliT )->( eof() )

      if ( dbfPreCliT )->lSndDoc

         lSnd  := .T.

         dbPass( dbfPreCliT, tmpPreCliT, .T. )
         ::oSender:SetText( ( dbfPreCliT )->cSerPre + "/" + AllTrim( Str( ( dbfPreCliT )->nNumPre ) ) + "/" + AllTrim( ( dbfPreCliT )->cSufPre ) + "; " + Dtoc( ( dbfPreCliT )->dFecPre ) + "; " + AllTrim( ( dbfPreCliT )->cCodCli ) + "; " + ( dbfPreCliT )->cNomCli )

         if ( dbfPreCliL )->( dbSeek( ( dbfPreCliT )->CSERPre + Str( ( dbfPreCliT )->NNUMPre ) + ( dbfPreCliT )->CSUFPre ) )
            while ( ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->NNUMPre ) + ( dbfPreCliL )->CSUFPre ) == ( ( dbfPreCliT )->CSERPre + Str( ( dbfPreCliT )->NNUMPre ) + ( dbfPreCliT )->CSUFPre ) .AND. !( dbfPreCliL )->( eof() )
               dbPass( dbfPreCliL, tmpPreCliL, .T. )
               ( dbfPreCliL )->( dbSkip() )
            end
         end

         if ( dbfPreCliI )->( dbSeek( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre ) )
            while ( ( dbfPreCliI )->cSerPre + Str( ( dbfPreCliI )->nNumPre ) + ( dbfPreCliI )->cSufPre ) == ( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre ) .AND. !( dbfPreCliI )->( eof() )
               dbPass( dbfPreCliI, tmpPreCliI, .T. )
               ( dbfPreCliI )->( dbSkip() )
            end
         end

      end

      ( dbfPreCliT )->( dbSkip() )

      if !Empty( ::oSender:oMtr )
         ::oSender:oMtr:Set( ( dbfPreCliT )->( OrdKeyNo() ) )
      end

   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfPreCliT )->( dbCloseArea() )
   ( dbfPreCliL )->( dbCloseArea() )
   ( dbfPreCliI )->( dbCloseArea() )
   ( tmpPreCliT )->( dbCloseArea() )
   ( tmpPreCliL )->( dbCloseArea() )
   ( tmpPreCliI )->( dbCloseArea() )

   if lSnd





      ::oSender:SetText( "Comprimiendo presupuestos a clientes" )

      if ::oSender:lZipData( cFileName )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay presupuestos a clientes para enviar" )

   end

Return ( Self )



UTILITY STATIC function TPresupuestosClientesSenderReciver_RestoreData() ; local Self AS CLASS TPresupuestosClientesSenderReciver := QSelf() AS CLASS TPresupuestosClientesSenderReciver

   local oBlock
   local oError
   local dbfPreCliT

   if ::lSuccesfullSend





      oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliT.Dbf" ), ( cCheckArea( "PreCliT", @dbfPreCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end
      ( dbfPreCliT )->( OrdSetFocus( "lSndDoc" ) )

      while ( dbfPreCliT )->( dbSeek( .T. ) ) .AND. !( dbfPreCliT )->( eof() )
         if ( dbfPreCliT )->( dbRLock() )
            ( dbfPreCliT )->lSndDoc := .F.
            ( dbfPreCliT )->( dbRUnlock() )
         end
      end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

      ( dbfPreCliT )->( dbCloseArea() )

   end

Return ( Self )



UTILITY STATIC function TPresupuestosClientesSenderReciver_SendData() ; local Self AS CLASS TPresupuestosClientesSenderReciver := QSelf() AS CLASS TPresupuestosClientesSenderReciver

   local cFileName         := "PreCli" + StrZero( ::nGetNumberToSend(), 6 ) + "." + RetSufEmp()

   if File( cPatOut() + cFileName )





      if ftpSndFile( cPatOut() + cFileName, cFileName, 2000, ::oSender )
         ::lSuccesfullSend := .T.
         ::IncNumberToSend()
         ::oSender:SetText( "Fichero enviado " + cFileName )
      else
         ::oSender:SetText( "ERROR al enviar fichero" )
      end

   end

Return ( Self )



UTILITY STATIC function TPresupuestosClientesSenderReciver_ReciveData() ; local Self AS CLASS TPresupuestosClientesSenderReciver := QSelf() AS CLASS TPresupuestosClientesSenderReciver

   local n
   local aExt        := aRetDlgEmp()





   ::oSender:SetText( "Recibiendo presupuestos de clientes" )

   for n := 1 to len( aExt )
      ftpGetFiles( "PreCli*." + aExt[ n ], cPatIn(), 2000, ::oSender )
   next

   ::oSender:SetText( "Presupuestos de clientes recibidos" )

Return Self



UTILITY STATIC function TPresupuestosClientesSenderReciver_Process() ; local Self AS CLASS TPresupuestosClientesSenderReciver := QSelf() AS CLASS TPresupuestosClientesSenderReciver

   local m
   local oBlock
   local oError
   local dbfPreCliT
   local dbfPreCliL
   local dbfPreCliI
   local dbfPreClid
   local tmpPreCliT
   local tmpPreCliL
   local tmpPreCliI
   local tmpPreCliD
   local aFiles      := Directory( cPatIn() + "PreCli*.*" )

   for m := 1 to len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )

      BEGIN SEQUENCE

         if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )







            if lExistTable( cPatSnd() + "PreCliT.DBF" )   .AND. lExistTable( cPatSnd() + "PreCliL.DBF" )   .AND. lExistTable( cPatSnd() + "PreCliI.DBF" )

               dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "PreCliT.DBF" ), ( cCheckArea( "PreCliT", @tmpPreCliT ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
               if !lAIS() ; ordListAdd( ( cPatSnd() + "PreCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "PreCliL.DBF" ), ( cCheckArea( "PreCliL", @tmpPreCliL ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
               if !lAIS() ; ordListAdd( ( cPatSnd() + "PreCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "PreCliI.DBF" ), ( cCheckArea( "PreCliI", @tmpPreCliI ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
               if !lAIS() ; ordListAdd( ( cPatSnd() + "PreCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "PreCliD.DBF" ), ( cCheckArea( "PreCliD", @tmpPreCliD ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
               if !lAIS() ; ordListAdd( ( cPatSnd() + "PreCliD.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliT.DBF" ), ( cCheckArea( "PreCliT", @dbfPreCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliL.DBF" ), ( cCheckArea( "PreCliL", @dbfPreCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliI.DBF" ), ( cCheckArea( "PreCliI", @dbfPreCliI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliD.DBF" ), ( cCheckArea( "PreCliD", @dbfPreCliD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliD.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               while !( tmpPreCliT )->( eof() )


                  if lValidaOperacion( ( tmpPreCliT )->dFecPre, .F. ) .AND.  !( dbfPreCliT )->( dbSeek( ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre ) )

                     dbPass( tmpPreCliT, dbfPreCliT, .T. )
                     ::oSender:SetText( "Añadido     : " + ( tmpPreCliL )->cSerPre + "/" + AllTrim( Str( ( tmpPreCliL )->nNumPre ) ) + "/" + AllTrim( ( tmpPreCliL )->cSufPre ) + "; " + Dtoc( ( tmpPreCliT )->dFecPre ) + "; " + AllTrim( ( tmpPreCliT )->cCodCli ) + "; " + ( tmpPreCliT )->cNomCli )

                     if ( tmpPreCliL )->( dbSeek( ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre ) )
                        while ( tmpPreCliL )->cSerPre + Str( ( tmpPreCliL )->nNumPre ) + ( tmpPreCliL )->cSufPre == ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre .AND. !( tmpPreCliL )->( eof() )
                           dbPass( tmpPreCliL, dbfPreCliL, .T. )
                           ( tmpPreCliL )->( dbSkip() )
                        end
                     end

                     if ( tmpPreCliI )->( dbSeek( ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre ) )
                        while ( tmpPreCliI )->cSerPre + Str( ( tmpPreCliI )->nNumPre ) + ( tmpPreCliI )->cSufPre == ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre .AND. !( tmpPreCliI )->( eof() )
                           dbPass( tmpPreCliI, dbfPreCliI, .T. )
                           ( tmpPreCliI )->( dbSkip() )
                        end
                     end

                     if ( tmpPreCliD )->( dbSeek( ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre ) )
                        while ( tmpPreCliD )->cSerPre + Str( ( tmpPreCliD )->nNumPre ) + ( tmpPreCliD )->cSufPre == ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre .AND. !( tmpPreCliD )->( eof() )
                           dbPass( tmpPreCliD, dbfPreCliD, .T. )
                           ( tmpPreCliD )->( dbSkip() )
                        end
                     end

                  else

                     ::oSender:SetText( "Desestimado : " + ( tmpPreCliL )->cSerPre + "/" + AllTrim( Str( ( tmpPreCliL )->nNumPre ) ) + "/" + AllTrim( ( tmpPreCliL )->cSufPre ) + "; " + Dtoc( ( tmpPreCliT )->dFecPre ) + "; " + AllTrim( ( tmpPreCliT )->cCodCli ) + "; " + ( tmpPreCliT )->cNomCli )

                  end

                  ( tmpPreCliT )->( dbSkip() )

               end

               ( dbfPreCliT )->( dbCloseArea() )
               ( dbfPreCliL )->( dbCloseArea() )
               ( dbfPreCliI )->( dbCloseArea() )
               ( tmpPreCliT )->( dbCloseArea() )
               ( tmpPreCliL )->( dbCloseArea() )
               ( tmpPreCliI )->( dbCloseArea() )

               ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

            else

               ::oSender:SetText( "Faltan ficheros" )

               if !lExistTable( cPatSnd() + "PreCliT.DBF" )
                  ::oSender:SetText( "Falta " + cPatSnd() + "PreCliT.DBF" )
               end

               if !lExistTable( cPatSnd() + "PreCliL.DBF" )
                  ::oSender:SetText( "Falta " + cPatSnd() + "PreCliL.DBF" )
               end

               if !lExistTable( cPatSnd() + "PreCliI.DBF" )
                  ::oSender:SetText( "Falta " + cPatSnd() + "PreCliL.DBF" )
               end

               if !lExistTable( cPatSnd() + "PreCliD.DBF" )
                  ::oSender:SetText( "Falta " + cPatSnd() + "PreCliD.DBF" )
               end

            end

            fErase( cPatSnd() + "PreCliT.DBF" )
            fErase( cPatSnd() + "PreCliL.DBF" )
            fErase( cPatSnd() + "PreCliI.DBF" )
            fErase( cPatSnd() + "PreCliD.DBF" )

         else

            ::oSender:SetText( "Error al descomprimir los ficheros" )

         end

      RECOVER USING oError

         ( dbfPreCliT )->( dbCloseArea() )
         ( dbfPreCliL )->( dbCloseArea() )
         ( dbfPreCliI )->( dbCloseArea() )
         ( dbfPreCliD )->( dbCloseArea() )
         ( tmpPreCliT )->( dbCloseArea() )
         ( tmpPreCliL )->( dbCloseArea() )
         ( tmpPreCliI )->( dbCloseArea() )
         ( tmpPreCliD )->( dbCloseArea() )

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

   next

Return Self



Static Function nEstadoIncidencia( cNumPre )

   local nEstado  := 0

   if ( dbfPreCliI )->( dbSeek( cNumPre ) )

      while ( dbfPreCliI )->cSerPre + Str( ( dbfPreCliI )->nNumPre ) + ( dbfPreCliI )->cSufPre == cNumPre .AND. !( dbfPreCliI )->( Eof() )

         if ( dbfPreCliI )->lListo
            do case
               case nEstado == 0 .OR. nEstado == 3
                    nEstado := 3
               case nEstado == 1
                    nEstado := 2
            end
         else
            do case
               case nEstado == 0
                    nEstado := 1
               case nEstado == 3
                    nEstado := 2
            end
         end

         ( dbfPreCliI )->( dbSkip() )

      end

   end

Return ( nEstado )



Function AppPreCli( cCodCli, cCodArt, lOpenBrowse )

   local nLevel         := nLevelUsr( "01055" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 2 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli( nil, nil, cCodCli, cCodArt )
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( .T. )
         WinAppRec( nil, bEdtRec, dbfPreCliT, cCodCli, cCodArt )
         CloseFiles()
      end

   end

RETURN .T.



FUNCTION EdtPreCli( cNumPre, lOpenBrowse )

   local nLevel         := nLevelUsr( "01055" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli()
         if dbSeekInOrd( cNumPre, "nNumPre", dbfPreCliT )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra presupuesto" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumPre, "nNumPre", dbfPreCliT )
            WinEdtRec( nil, bEdtRec, dbfPreCliT )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION ZooPreCli( cNumPre, lOpenBrowse, lPda )

   local nLevel         := nLevelUsr( "01055" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;
   IIF( lPda == nil, lPda := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli()
         if dbSeekInOrd( cNumPre, "nNumPre", dbfPreCliT )
            oWndBrw:RecZoom()
         else
            MsgStop( "No se encuentra presupuesto" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumPre, "nNumPre", dbfPreCliT )
            if lPda
               WinZooRec( nil, bEdtPda, dbfPreCliT )
            else
               WinZooRec( nil, bEdtRec, dbfPreCliT )
            end
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION DelPreCli( cNumPre, lOpenBrowse )

   local nLevel         := nLevelUsr( "01055" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 16 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli()
         if dbSeekInOrd( cNumPre, "nNumPre", dbfPreCliT )
            WinDelRec( nil, dbfPreCliT, {|| QuiPreCli() } )
         else
            MsgStop( "No se encuentra presupuesto" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumPre, "nNumPre", dbfPreCliT )
            WinDelRec( nil, dbfPreCliT, {|| QuiPreCli() } )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION PrnPreCli( cNumPre, lOpenBrowse )

   local nLevel         := nLevelUsr( "01055" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli()
         if dbSeekInOrd( cNumPre, "nNumPre", dbfPreCliT )
            GenPreCli( 1 )
         else
            MsgStop( "No se encuentra presupuesto" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( cNumPre, "nNumPre", dbfPreCliT )
            GenPreCli( 1 )
         else
            MsgStop( "No se encuentra presupuesto" )
         end
         CloseFiles()
      end

   end

Return .T.



FUNCTION VisPreCli( cNumPre, lOpenBrowse )

   local nLevel         := nLevelUsr( "01055" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli()
         if dbSeekInOrd( cNumPre, "nNumPre", dbfPreCliT )
            GenPreCli( 2 )
         else
            MsgStop( "No se encuentra presupuesto" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumPre, "nNumPre", dbfPreCliT )
            GenPreCli( 2 )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION QuiPreCli()

   local nOrdDet
   local nOrdInc
   local nOrdDoc

   if ( dbfPreCliT )->lCloPre .AND. !oUser():lAdministrador()
      msgStop( "Solo puede eliminar presupuestos cerrados los administradores." )
      Return .F.
   end

   nOrdDet        := ( dbfPreCliL )->( OrdSetFocus( "nNumPre" ) )
   nOrdInc        := ( dbfPreCliI )->( OrdSetFocus( "nNumPre" ) )
   nOrdDoc        := ( dbfPreCliD )->( OrdSetFocus( "nNumPre" ) )





   while ( dbfPreCliL )->( dbSeek( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT  )->cSufPre ) ) .AND. !( dbfPreCliL )->( eof() )
      if dbLock( dbfPreCliL )
         ( dbfPreCliL )->( dbDelete() )
         ( dbfPreCliL )->( dbUnLock() )
      end
   end





   while ( dbfPreCliI )->( dbSeek( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT  )->cSufPre ) ) .AND. !( dbfPreCliI )->( eof() )
      if dbLock( dbfPreCliI )
         ( dbfPreCliI )->( dbDelete() )
         ( dbfPreCliI )->( dbUnLock() )
      end
   end





   while ( dbfPreCliD )->( dbSeek( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT  )->cSufPre ) ) .AND. !( dbfPreCliD )->( eof() )
      if dbLock( dbfPreCliD )
         ( dbfPreCliD )->( dbDelete() )
         ( dbfPreCliD )->( dbUnLock() )
      end
   end

   ( dbfPreCliL )->( OrdSetFocus( nOrdDet ) )
   ( dbfPreCliI )->( OrdSetFocus( nOrdInc ) )
   ( dbfPreCliD )->( OrdSetFocus( nOrdDoc ) )

Return .T.



Static Function DesgPnt( cCodArt, aTmp, nTarifa, oPreDiv, oCosDiv, nMode )

   local oDlg
   local oPuntos
   local oValorPunto
   local oDtoPnt
   local oIncPnt
   local oImporte
   local nPuntos     := 0
   local nValorPunto := 0
   local nDtoPnt     := 0
   local nIncPnt     := 0



   if Empty( cCodArt )
      MsgInfo( "Debe seleccinar un artículo", "Código vacío" )
      return .F.
   end



   nPuntos           := aTmp[ 58 ]
   nValorPunto       := aTmp[ 59 ]
   nDtoPnt           := aTmp[ 60 ]
   nIncPnt           := aTmp[ 61 ]

   oDlg = TDialog():New(,,,, "Desglose de puntos", "DESGPUNTOS",, .F.,,,,,, .F.,,,,,, .F., )







   oPuntos := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, nPuntos, nPuntos:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,,,,, nil,,, )







   oValorPunto := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, nValorPunto, nValorPunto:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,,,,, nil,,, )









   oDtoPnt := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nDtoPnt, nDtoPnt:= u ) }, oDlg,, "999.99",,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,, {||      0}, {||      100},, nil,,, )









   oIncPnt := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, nIncPnt, nIncPnt:= u ) }, oDlg,, "999.99",,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,, {||      0}, {||      100},, nil,,, )





   oImporte := TSay():ReDefine( 240, {|| nCalculoPuntos( nPuntos, nValorPunto, nDtoPnt, nIncPnt )}, oDlg, cPouDiv, "N/W*",, .F.,, .F., .F. )





   TButton():ReDefine( 500, {||( EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, dbfArticulo, nDouDiv ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




   TButton():ReDefine( 550, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, dbfArticulo, nDouDiv ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      aTmp[ 58 ]     := nPuntos
      aTmp[ 59 ]     := nValorPunto
      aTmp[ 60 ]     := nDtoPnt
      aTmp[ 61 ]     := nIncPnt
      oCosDiv:cText( oImporte:VarGet() )
      oCosDiv:Refresh()

   end

Return ( .T. )



Function EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, dbfArticulo, nDouDiv )

   local nCosto   := oImporte:VarGet()
   local nRec     := ( dbfArticulo )->( RecNo() )
   local nNewPre

   if ( dbfArticulo )->( dbSeek( cCodArt ) )

      do case
         case nTarifa == 1
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr1 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef1, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
         case nTarifa == 2
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr2 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef2, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
         case nTarifa == 3
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr3 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef3, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
         case nTarifa == 4
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr4 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef4, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
         case nTarifa == 5
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr5 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef5, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
         case nTarifa == 6
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr6 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef6, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
      end

   end

   oPreDiv:cText( nNewPre )

   oPreDiv:Refresh()

   ( dbfArticulo )->( dbGoTo( nRec ) )

Return ( .T. )



Function PreCliDialog()

   local oDlg
   local oBrw
   local nLevel
   local oGetBuscar
   local cGetBuscar     := Space( 100 )
   local oCbxOrden
   local cCbxOrden      := "Número"

   nLevel               := nLevelUsr( "01055" )
   if nAnd( nLevel, 1 ) <> 0
      msgStop( "Acceso no permitido." )
      return .F.
   end





   if !OpenFiles()
      return .F.
   end





   oDlg = TDialog():New(,,,,, "Dialog_Pda",, .F.,,,,,, .F.,,,,,, .F., )





      oGetBuscar := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cGetBuscar, cGetBuscar:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "FIND",, )

      oGetBuscar:bChange   := {| nKey, nFlags | AutoSeek( nKey, nFlags, oGetBuscar, oBrw, dbfPreCliT ) }





      oCbxOrden := TComboBox():ReDefine( 110, { | u | If( PCount()==0, cCbxOrden, cCbxOrden:= u ) }, { "Número", "Fecha", "Código", "Nombre" }, oDlg,,,,,,, .F.,,,,,, )

      oCbxOrden:bChange    := {|| ( dbfPreCliT )->( OrdSetFocus( oCbxOrden:nAt ) ), ( dbfPreCliT )->( dbGoTop() ), oBrw:Refresh(), oGetBuscar:SetFocus() }





































































   oDlg:Activate( , , , .T., , , {|| EditMenu( nLevel, oBrw, oDlg ) } )

   CloseFiles()

RETURN ( nil )



Static Function EditMenu( nLevel, oBrw, oDlg )

   oMenu := MenuBegin( .F.,,, .F., .F. )

      MenuAddItem( "Presupuestos",, .F.,,,,,,,,, .F.,,, .F. )

      MenuAddItem( "&1. Edición",, .F.,,,,,,,,, .F.,,, .F. )

         MenuBegin( .F.,,, .F., .F. )



            MenuAddItem( "&1. Añadir",, .F.,, {|oMenuItem|( if( nAnd( nLevel, 2 ) <> 0, WinAppRec( oBrw, bEdtPda, dbfPreCliT ),  MsgStop( "Acceso no permitido" ) ) )},,,,,,, .F.,,, .F. )


            MenuAddItem( "&2. Modificar",, .F.,, {|oMenuItem|( if( nAnd( nLevel, 4 ) <> 0, WinEdtRec( oBrw, bEdtPda, dbfPreCliT ),  MsgStop( "Acceso no permitido" ) ) )},,,,,,, .F.,,, .F. )


            MenuAddItem( "&3. Eliminar",, .F.,, {|oMenuItem|( if( nAnd( nLevel, 16 ) <> 0, WinDelRec( oBrw, dbfPreCliT ) ,          MsgStop( "Acceso no permitido" ) ) )},,,,,,, .F.,,, .F. )


            MenuAddItem( "&4. Zoom",, .F.,, {|oMenuItem|( if( nAnd( nLevel, 8 ) <> 0, WinZooRec( oBrw, bEdtPda, dbfPreCliT ),  MsgStop( "Acceso no permitido" ) ) )},,,,,,, .F.,,, .F. )


            MenuAddItem( "&5. Generar nota",, .F.,, {|oMenuItem|( if( nAnd( nLevel, 8 ) <> 0, PreCliNotas(),                           MsgStop( "Acceso no permitido" ) ) )},,,,,,, .F.,,, .F. )
         MenuEnd()





      MenuAddItem( "&S. Salir", "Salir de la ventana actual", .F.,, {|oMenuItem|( oDlg:End() )},, "End",,,,, .F.,,, .F. )
   MenuEnd()

   oDlg:SetMenu( oMenu )

Return ( oMenu )




STATIC FUNCTION EdtPda( aTmp, aGet, dbfPreCliT, oBrw, cCodCli, cCodArt, nMode )

   local oDlg
   local oFld
   local nOrd
   local oBrwLin
   local oBrwInc
   local cAprovado




   local cNbrObr
   local oNbrObr
   local oSayPgo
   local cSayPgo
   local cRuta
   local oRuta
   local nRieCli
   local oRieCli
   local oTitulo
   local cTitulo              := LblTitle( nMode ) + " presupuesto de cliente"
   local oTlfCli
   local cTlfCli





   cOldCodCli           := aTmp[ 6 ]

   do case
   case nMode == 1

      if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 1 ]  := cNewSer( "nPreCli" )
      aTmp[ 4 ]  := cCurSesion()
      aTmp[ 17 ]  := oUser():cAlmacen()
      aTmp[ 46 ]  := cDivEmp()
      aTmp[ 18 ]  := oUser():cCaja()
      aTmp[ 19 ]  := cDefFpg()
      aTmp[ 58 ]  := cCurUsr()
      aTmp[ 47 ]  := nChgDiv( aTmp[ 46 ], dbfDiv )
      aTmp[ 22 ]  := .F.
      aTmp[ 3 ]  := RetSufEmp()
      aTmp[ 62 ]  := nDiasValidez()
      aTmp[ 48 ]  := .T.
      aTmp[ 67 ]  := oUser():cDelegacion()
      aTmp[ 73 ]  := Padr( "Gastos", 250 )

      if !Empty( cCodCli )
         aTmp[ 6 ]  := cCodCli
      end

   case nMode == 2

      if aTmp[ 57 ] .AND. !oUser():lAdministrador()
         msgStop( "Solo puede modificar los presupuestos cerrados los administradores." )
         Return .F.
      end

   case nMode == 4

      if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 22 ]  := .F.
      aTmp[ 57 ]  := .F.

   end

   if Empty( aTmp[ 1 ] )
      aTmp[ 1 ]  := "A"
   end

   if Empty( aTmp[28] )
      aTmp[ 28 ]  := 1
   end

   if Empty( aTmp[ 29 ] )
      aTmp[ 29 ]  := Padr( "General", 50 )
   end

   if Empty( aTmp[ 31 ] )
      aTmp[ 31 ]     := Padr( "Pronto pago", 50 )
   end





   if BeginTrans( aTmp, .F. )
      Return .F.
   end

   cAprovado            := if( aTmp[ 22 ], "Aprobado", "" )





   nOrd                 := ( dbfPreCliT )->( ordSetFocus( 1 ) )
   cPicUnd              := MasUnd()
   cPouDiv              := cPouDiv( aTmp[ 46 ], dbfDiv )
   cPorDiv              := cPorDiv( aTmp[ 46 ], dbfDiv )
   nDouDiv              := nDouDiv( aTmp[ 46 ], dbfDiv )
   nRouDiv              := nRouDiv( aTmp[ 46 ], dbfDiv )









   cNbrObr              := RetFld( aTmp[ 6 ] + aTmp[ 15 ], dbfObrasT, "cNomObr" )
   cSayPgo              := RetFld( aTmp[ 19 ], dbfFPago, "CDESPAGO")
   cRuta                := RetFld( aTmp[ 20 ], dbfRuta,  "CDESRUT")


   oDlg = TDialog():New(,,,,, "PRECLI_PDA_0",, .F.,,,,,, .F.,,,,,, .F., )





   oFld := TFolder():ReDefine( 200, {"Cabecera",       "Líneas",         "Incidencias",    "Totales"}, { "PRECLI_PDA_1","PRECLI_PDA_2","PRECLI_PDA_2","PRECLI_PDA_3" }, oDlg,,,,, .F., )











      aGet[ 1 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 1 ], aTmp[ 1 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( aTmp[1] >= "A" .AND. aTmp[1] <= "Z"  )}, "N/W*",,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[1] ) )}, {||  ( DwSerie( aGet[1] ) )},,,, nil,,, )





        aGet[2] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[2], aTmp[2]:= u ) }, oFld:aDialogs[1],, "999999999",,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )




        aGet[3] := TGetHlp():ReDefine( 102, { | u | If( PCount()==0, aTmp[3], aTmp[3]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 103, { | u | If( PCount()==0, cAprovado, cAprovado:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )





      aGet[5] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[5], aTmp[5]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      aGet[ 61 ] := TComboBox():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, ( aSituacion( dbfSitua ) ), oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )},,,,, )









      aGet[ 28 ] := TGetHlp():ReDefine( 132, { | u | If( PCount()==0, aTmp[ 28 ], aTmp[ 28 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( aTmp[ 28 ] >= 1 .AND. aTmp[ 28 ] <= 6 )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,, {||      1}, {||      6},, nil,,, )








      aGet[ 6 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],, RetPicCodCliEmp(), {||    ( LoaCli( aGet, aTmp, nMode, oRieCli, oTlfCli ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwClient( aGet[ 6 ] ) )}, nil, "LUPA",, )




      aGet[ 7 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 8 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 11 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 9 ] := TGetHlp():ReDefine( 141, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




       oTlfCli := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cTlfCli, cTlfCli:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oRieCli := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, nRieCli, nRieCli:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ 15 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 15 ], aTmp[ 15 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cObras( aGet[ 15 ], oNbrObr, aTmp[ 6 ], dbfObrasT ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwObras( aGet[ 15 ], oNbrObr, aTmp[ 6 ], dbfObrasT ) )}, nil, "LUPA",, )




      oNbrObr := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cNbrObr, cNbrObr:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      aGet[ 20 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[1],,, {||    (cRuta( aGet[ 20 ], dbfRuta, oRuta ) )},,,,,, .F., {||     (nMode <> 3)},, .F., .F.,,,,, {|Self|( BrwRuta( aGet[ 20 ], dbfRuta, oRuta ) )}, nil, "LUPA",, )




      oRuta := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, cRuta, cRuta:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      aGet[ 49 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 49 ], aTmp[ 49 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 50 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ 19 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cFpago( aGet[ 19 ], dbfFPago, oSayPgo ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( pdaBrwFPago( aGet[ 19 ],dbfFPago, oSayPgo ) )}, nil, "LUPA",, )




      oSayPgo := TGetHlp():ReDefine( 191, { | u | If( PCount()==0, cSayPgo, cSayPgo:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




















































































































































































      TBtnBmp():ReDefine( 100, "New16",,,,, {|Self|( AppDeta( oBrwLin, bDetPda, aTmp ) )}, oFld:aDialogs[ 2 ], .F., {||     ( nMode <> 3 )}, .F., "Añadir línea",,,,, !.T.,, .F.,,, .F., !.F. )








      TBtnBmp():ReDefine( 110, "Edit16",,,,, {|Self|( EdtDeta( oBrwLin, bDetPda, aTmp ) )}, oFld:aDialogs[ 2 ], .F., {||     ( nMode <> 3 )}, .F., "Editar línea",,,,, !.T.,, .F.,,, .F., !.F. )








      TBtnBmp():ReDefine( 120, "Del16",,,,, {|Self|( DelDeta( oBrwLin, aTmp ) )}, oFld:aDialogs[ 2 ], .F., {||     ( nMode <> 3 )}, .F., "Eliminar línea",,,,, !.T.,, .F.,,, .F., !.F. )







      TBtnBmp():ReDefine( 130, "Zoom16",,,,, {|Self|( EdtZoom( oBrwLin, bDetPda, aTmp ) )}, oFld:aDialogs[ 2 ], .F.,, .F., "Zoom línea",,,,, !.T.,, .F.,,, .F., !.F. )




























































      TBtnBmp():ReDefine( 100, "New16",,,,, {|Self|( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[3], .F., {||     ( nMode <> 3 )}, .F., "Añadir incidencia",,,,, !.T.,, .F.,,, .F., !.F. )








      TBtnBmp():ReDefine( 110, "Edit16",,,,, {|Self|( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[3], .F., {||     ( nMode <> 3 )}, .F., "Editar incidencia",,,,, !.T.,, .F.,,, .F., !.F. )








      TBtnBmp():ReDefine( 120, "Del16",,,,, {|Self|( DbDelRec( oBrwInc, dbfTmpInc, nil, nil, .T. ) )}, oFld:aDialogs[3], .F., {||     ( nMode <> 3 )}, .F., "Eliminar incidencia",,,,, !.T.,, .F.,,, .F., !.F. )







      TBtnBmp():ReDefine( 130, "Zoom16",,,,, {|Self|( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[3], .F.,, .F., "Zoom incidencia",,,,, !.T.,, .F.,,, .F., !.F. )








      aGet[ 29 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[4],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 30 ] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[4],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      aGet[ 31 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[4],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








        aGet[ 32 ] := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[4],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





        aGet[ 33 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[4],, "@!",,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








        aGet[ 34 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[4],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      aGet[ 35 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[4],, "@!",,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 36 ] := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[4],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )








       oGetRnt := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, nTotRnt, nTotRnt:= u ) }, oFld:aDialogs[4],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 73 ] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[4],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ 54 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[4],, cPorDiv, {||    ( nTotPreCli( nil, dbfPreCliT, dbfTmpLin, dbfIva, dbfDiv, dbfFPago, aTmp ), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( nTotPreCli( nil, dbfPreCliT, dbfTmpLin, dbfIva, dbfDiv, dbfFPago, aTmp ) ) }, .F., .F.,,,,,, nil,,, )





      aGet[ 42 ] := TCheckBox():ReDefine( 430, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[4],, {||( nTotPreCli( nil, dbfPreCliT, dbfTmpLin, dbfIva, dbfDiv, dbfFPago, aTmp ) )},,,,, .F., {||         ( nMode <> 3 )}, .F. )



      oGetNet := TSay():ReDefine( 400, {|| nTotNet}, oFld:aDialogs[4],,,, .F.,, .F., .F. )



      oGetIva := TSay():ReDefine( 420, {|| nTotIva}, oFld:aDialogs[4],,,, .F.,, .F., .F. )



      oGetReq := TSay():ReDefine( 440, {|| nTotReq}, oFld:aDialogs[4],,,, .F.,, .F., .F. )




      oGetTotal := TSay():ReDefine( 450, {|| nTotPre}, oFld:aDialogs[4],,,, .F., oFont, .F., .F. )



       oTitulo := TSay():ReDefine( 100, {|| cTitulo}, oDlg,,,, .F.,, .F., .F. )









        TButton():ReDefine( 1, {||( EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 2, {||( If( ExitNoSave( nMode, dbfTmpLin ), oDlg:end(), ) )}, oDlg,,, .F.,,,, .F. )

      oDlg:AddFastKey( 116, {|| EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ) } )

      oDlg:bStart := {|| aGet[ 6 ]:SetFocus() }



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( RecalculaTotal( aTmp ) )}, oDlg:bRClicked,,, )

   ( dbfPreCliT )->( ordSetFocus( nOrd ) )







   KillTrans( oBrwLin )

RETURN ( oDlg:nResult == 1 )



Static Function DetPda( aTmp, aGet, dbfPreCliL, oBrw, lTotLin, cCodArtEnt, nMode, aTmpPre )

   local oDlg
   local oBtn
    local oTotal
   local nTotPreCli
   local cCodArt     := Padr( aTmp[ 4 ], 32 )
   local oLinea
   local cLinea      := LblTitle( nMode ) + " linea de presupuesto"
   local oSayPr1
   local oSayPr2
   local cSayPr1     := ""
   local cSayPr2     := ""
   local oSayVp1
   local oSayVp2
   local cSayVp1     := ""
   local cSayVp2     := ""



   IIF( lTotLin == nil, lTotLin := .F., ) ;

   SysRefresh()

   do case
   case nMode == 1
      aTmp[ 1  ] := aTmpPre[ 1 ]
      aTmp[ 2  ] := aTmpPre[ 2 ]
      aTmp[ 3  ] := aTmpPre[ 3 ]
      aTmp[ 8 ] := 1
      aTmp[ 31  ] := cDefVta()
      aTmp[ 23  ] := lTotLin
      aTmp[ 7  ] := 1
      aTmp[ 37  ] := aTmpPre[ 52 ]
      aTmp[ 36  ] := aTmpPre[ 17 ]
      if !Empty( cCodArtEnt )
         cCodArt        := Padr( cCodArtEnt, 32 )
      end

   case nMode == 2
      lTotLin           := aTmp[ 23 ]

   end





   cOldCodArt           := aTmp[ 4 ]
   cOldPrpArt           := aTmp[ 25 ] + aTmp[ 26 ] + aTmp[ 27 ] + aTmp[ 28 ]

   oDlg = TDialog():New(,,,,, "PRECLI_LIN_PDA",, .F.,,,,,, .F.,,,,,, .F., )








      aGet[4] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cCodArt, cCodArt:= u ) }, oDlg,,, {||    ( LoaArt( aTmp, aGet, aTmpPre, ,oSayPr1 ,oSayPr2 ,oSayVp1 ,oSayVp2 , , , nMode ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwArticulo( aGet[4], aGet[5] ) )}, nil, "LUPA",, )




      aGet[5] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[5], aTmp[5]:= u ) }, oDlg,,,,,,,,, .F., {||     ( lModDes() .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ 22 ] := TMultiGet():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oDlg,, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, .F.,, )
















      aGet[27] := TGetHlp():ReDefine( 251, { | u | If( PCount()==0, aTmp[27], aTmp[27]:= u ) }, oDlg,,, {||    ( if( lPrpAct( aTmp[27], oSayVp1, aTmp[25 ], dbfTblPro ), LoaArt( aTmp, aGet, aTmpPre, , oSayPr1, oSayPr2, oSayVp1, oSayVp2, , , nMode ), .F. ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[27], oSayVp1, aTmp[25 ] ) )}, nil, "LUPA",, )

         aGet[ 27 ]:bChange   := {|| aGet[ 27 ]:Assign(), if( !uFieldEmpresa( "lNStkAct" ), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], aTmp[ 43 ], aTmp[ 33 ] ), .T. ) }



      oSayPr1 := TSay():ReDefine( 250, {|| cSayPr1}, oDlg,,,, .F.,, .F., .F. )





      oSayVp1 := TGetHlp():ReDefine( 252, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )










      aGet[28] := TGetHlp():ReDefine( 261, { | u | If( PCount()==0, aTmp[28], aTmp[28]:= u ) }, oDlg,,, {||    ( if( lPrpAct( aTmp[28], oSayVp2, aTmp[26 ], dbfTblPro ), LoaArt( aTmp, aGet, aTmpPre, , oSayPr1, oSayPr2, oSayVp1, oSayVp2, , , nMode ), .F. ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[28], oSayVp2, aTmp[26 ] ) )}, nil, "LUPA",, )

         aGet[ 28 ]:bChange   := {|| aGet[ 28 ]:Assign(), if( !uFieldEmpresa( "lNStkAct" ), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], aTmp[ 43 ], aTmp[ 33 ] ), .T. ) }



      oSayPr2 := TSay():ReDefine( 260, {|| cSayPr2}, oDlg,,,, .F.,, .F., .F. )





      oSayVp2 := TGetHlp():ReDefine( 262, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )














      aGet[ 6 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oDlg,, "@E 99.99", {||    ( lTiva( dbfIva, aTmp[ 6 ], @aTmp[ 53 ] ) )}, "N/W*",,,,, .F., {||     ( lModIva() .AND. nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 6 ], dbfIva, , .T. ) )}, nil, "LUPA",, )









      aGet[ 7 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oDlg,, cPicUnd, {||    ( RecalculaLinea( aTmp, nDouDiv, oTotal ) )},,,,,, .F., {||     ( lUseCaj() .AND. nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, nDouDiv, oTotal ) ) }, .F., .T.,,,,,, nil,, 131, )









      aGet[8] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[8], aTmp[8]:= u ) }, oDlg,, cPicUnd, {||    ( RecalculaLinea( aTmp, nDouDiv, oTotal ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, nDouDiv, oTotal ) ) }, .F., .T.,,,,,, nil,, 141, )









      aGet[11] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[11], aTmp[11]:= u ) }, oDlg,, cPouDiv, {||    ( RecalculaLinea( aTmp, nDouDiv, oTotal ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, nDouDiv, oTotal ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 13 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oDlg,, cPouDiv, {||    ( RecalculaLinea( aTmp, nDouDiv, oTotal ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, nDouDiv, oTotal ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[14] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[14], aTmp[14]:= u ) }, oDlg,, "@E 99.99", {||    ( RecalculaLinea( aTmp, nDouDiv, oTotal ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, nDouDiv, oTotal ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[15] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[15], aTmp[15]:= u ) }, oDlg,, "@E 99.99", {||    ( RecalculaLinea( aTmp, nDouDiv, oTotal ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, nDouDiv, oTotal ) ) }, .F., .T.,,,,,, nil,,, )






      aGet[16] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[16], aTmp[16]:= u ) }, oDlg,, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .T.,,,,,, nil,,, )





      oTotal := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nTotPre, nTotPre:= u ) }, oDlg,, cPorDiv,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )












      aGet[ 36 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oDlg,,, {||    ( cAlmacen( aGet[ 36 ] ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 36 ] ) )}, nil, "LUPA",, )



      oLinea := TSay():ReDefine( 230, {|| cLinea}, oDlg,,,, .F.,, .F., .F. )










      oBtn := TButton():ReDefine( 1, {||( SaveDeta( aTmp, aTmpPre, aGet, oDlg, oBrw, , nMode, ,oSayPr1 ,oSayPr2 ,oSayVp1 , oSayVp2 , , oTotal, , cCodArt, oBtn ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





     TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:bStart := {|| SetDlgMode( aTmp, aGet, nMode, , oSayPr1, oSayPr2, oSayVp1, oSayVp2, , oTotal, aTmpPre, , ) }

      if nMode <> 3
         oDlg:AddFastKey( 116, {|| SaveDeta( aTmp, aTmpPre, aGet, oDlg, oBrw, , nMode, , , , , , , oTotal, , cCodArt, oBtn ) } )
      end



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|( RecalculaLinea( aTmp, nDouDiv, oTotal ) )}, .T.,,,, oDlg:bRClicked,,, )

RETURN ( oDlg:nResult == 1 )



Static Function PreCliNotas()

   local cObserv  := ""
   local aData    := {}

   aAdd( aData, "Presupuesto " + ( dbfPreCliT )->cSerPre + "/" + AllTrim( Str( ( dbfPreCliT )->nNumPre ) ) + "/" + Alltrim( ( dbfPreCliT )->cSufPre ) + " de " + Rtrim( ( dbfPreCliT )->cNomCli ) )
   aAdd( aData, "08" )
   aAdd( aData, ( dbfPreCliT )->cCodCli )
   aAdd( aData, ( dbfPreCliT )->cNomCli )
   aAdd( aData, ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre )

   if !Empty( ( dbfPreCliT )->cRetPor )
      cObserv     += Rtrim( ( dbfPreCliT )->cRetPor ) + Space( 1 )
   end

   if !Empty( ( dbfPreCliT )->cRetMat )
      cObserv     += Rtrim( ( dbfPreCliT )->cRetMat ) + Space( 1 )
   end



















   aAdd( aData, cObserv )

   GenerarNotas( aData )

Return ( nil )



Static Function AppendKit( uTmpLin, aTmpPre )

   local cCodArt
   local cSerPre
   local nNumPre
   local cSufPre
   local nCanPre
   local dFecPre
   local cTipMov
   local cAlmLin
   local nIvaLin
   local lIvaLin
   local nComAge
   local nUniCaj
   local nDtoGrl
   local nDtoPrm
   local nDtoDiv
   local nNumLin
   local nTarLin
   local nRecAct                       := ( dbfKit )->( Recno() )
   local nUnidades                     := 0
   local nStkActual                    := 0

   if ValType( uTmpLin ) == "A"
      cCodArt                          := uTmpLin[ 4    ]
      cSerPre                          := uTmpLin[ 1 ]
      nNumPre                          := uTmpLin[ 2 ]
      cSufPre                          := uTmpLin[ 3 ]
      nCanPre                          := uTmpLin[ 7 ]
      dFecPre                          := uTmpLin[ 21  ]
      cTipMov                          := uTmpLin[ 31 ]
      cAlmLin                          := uTmpLin[ 36 ]
      nIvaLin                          := uTmpLin[ 6    ]
      lIvaLin                          := uTmpLin[ 37 ]
      nComAge                          := uTmpLin[ 16 ]
      nUniCaj                          := uTmpLin[ 8]
      nDtoGrl                          := uTmpLin[ 14    ]
      nDtoPrm                          := uTmpLin[ 15 ]
      nDtoDiv                          := uTmpLin[ 30 ]
      nNumLin                          := uTmpLin[ 32 ]
      nTarLin                          := uTmpLin[ 73 ]
   else
      cCodArt                          := ( uTmpLin )->cRef
      cSerPre                          := ( uTmpLin )->cSerPre
      nNumPre                          := ( uTmpLin )->nNumPre
      cSufPre                          := ( uTmpLin )->cSufPre
      nCanPre                          := ( uTmpLin )->nCanPre
      dFecPre                          := ( uTmpLin )->dFecha
      cTipMov                          := ( uTmpLin )->cTipMov
      cAlmLin                          := ( uTmpLin )->cAlmLin
      nIvaLin                          := ( uTmpLin )->nIva
      lIvaLin                          := ( uTmpLin )->lIvaLin
      nComAge                          := ( uTmpLin )->nComAge
      nUniCaj                          := ( uTmpLin )->nUniCaja
      nDtoGrl                          := ( uTmpLin )->nDto
      nDtoPrm                          := ( uTmpLin )->nDtoPrm
      nDtoDiv                          := ( uTmpLin )->nDtoDiv
      nNumLin                          := ( uTmpLin )->nNumLin
      nTarLin                          := ( uTmpLin )->nTarLin
   end

   if ( dbfKit )->( dbSeek( cCodArt ) )

      while ( dbfKit )->cCodKit == cCodArt .AND. !( dbfKit )->( eof() )

         if ( dbfArticulo )->( dbSeek( ( dbfKit )->cRefKit ) )

            ( dbfTmpLin )->( dbAppend() )

            if lKitAsociado( cCodArt, dbfArticulo )
               ( dbfTmpLin )->nNumLin  := nLastNum( dbfTmpLin )
               ( dbfTmpLin )->lKitChl  := .F.
            else
               ( dbfTmpLin )->nNumLin  := nNumLin
               ( dbfTmpLin )->lKitChl  := .T.
            end

            ( dbfTmpLin )->cRef        := ( dbfkit      )->cRefKit
            ( dbfTmpLin )->cDetalle    := ( dbfArticulo )->Nombre
            ( dbfTmpLin )->nPntVer     := ( dbfArticulo )->nPntVer1
            ( dbfTmpLin )->cUnidad     := ( dbfArticulo )->cUnidad
            ( dbfTmpLin )->nPesokg     := ( dbfArticulo )->nPesoKg
            ( dbfTmpLin )->cPesokg     := ( dbfArticulo )->cUndDim
            ( dbfTmpLin )->nVolumen    := ( dbfArticulo )->nVolumen
            ( dbfTmpLin )->cVolumen    := ( dbfArticulo )->cVolumen

            ( dbfTmpLin )->nPvpRec     := ( dbfArticulo )->PvpRec
            ( dbfTmpLin )->cCodImp     := ( dbfArticulo )->cCodImp
            ( dbfTmpLin )->lLote       := ( dbfArticulo )->lLote
            ( dbfTmpLin )->nLote       := ( dbfArticulo )->nLote
            ( dbfTmpLin )->cLote       := ( dbfArticulo )->cLote

            ( dbfTmpLin )->nValImp     := oNewImp:nValImp( ( dbfArticulo )->cCodImp )
            ( dbfTmpLin )->nCosDiv     := nCosto( nil, dbfArticulo, dbfKit )

            if ( dbfArticulo )->lFacCnv
               ( dbfTmpLin )->nFacCnv  := ( dbfArticulo )->nFacCnv
            end

            ( dbfTmpLin )->cSerPre     := cSerPre
            ( dbfTmpLin )->nNumPre     := nNumPre
            ( dbfTmpLin )->cSufPre     := cSufPre
            ( dbfTmpLin )->nCanPre     := nCanPre
            ( dbfTmpLin )->dFecha      := dFecPre
            ( dbfTmpLin )->cTipMov     := cTipMov
            ( dbfTmpLin )->cAlmLin     := cAlmLin
            ( dbfTmpLin )->lIvaLin     := lIvaLin
            ( dbfTmpLin )->nComAge     := nComAge





            ( dbfTmpLin )->lImpLin     := lImprimirComponente( cCodArt, dbfArticulo )
            ( dbfTmpLin )->lKitPrc     := lPreciosComponentes( cCodArt, dbfArticulo )





            ( dbfTmpLin )->nUniCaja    := nUniCaj * ( dbfKit )->nUndKit

            if ( dbfTmpLin )->lKitPrc
               ( dbfTmpLin )->nPreDiv  := nRetPreArt( nTarLin, aTmpPre[ 46 ], aTmpPre[ 52 ], dbfArticulo, dbfDiv, dbfKit, dbfIva )
            end





            if !Empty( nIvaLin )
               ( dbfTmpLin )->nIva     := nIva( dbfIva, ( dbfArticulo )->TipoIva )
               ( dbfTmpLin )->nReq     := nReq( dbfIva, ( dbfArticulo )->TipoIva )
            else
               ( dbfTmpLin )->nIva     := 0
               ( dbfTmpLin )->nReq     := 0
            end

            if lStockComponentes( cCodArt, dbfArticulo )
               ( dbfTmpLin )->nCtlStk  := ( dbfArticulo )->nCtlStock
            else
               ( dbfTmpLin )->nCtlstk  := 3
            end





            if ( dbfKit )->lAplDto
               ( dbfTmpLin )->nDto     := nDtoGrl
               ( dbfTmpLin )->nDtoPrm  := nDtoPrm
               ( dbfTmpLin )->nDtoDiv  := nDtoDiv
            end

            if ( dbfArticulo )->lKitArt
               AppendKit( dbfTmpLin, aTmpPre )
            end





            if ( dbfArticulo )->lMsgVta .AND. !uFieldEmpresa( "lNStkAct" )

               nStkActual     := oStock:nStockAlmacen( ( dbfKit )->cRefKit, cAlmLin )
               nUnidades      := nUniCaj * ( dbfKit )->nUndKit

               do case
                  case nStkActual - nUnidades < 0



                        MsgStop( "No hay stock suficiente para realizar la venta" + Chr(13)+Chr(10) +  "del componente " + AllTrim( ( dbfKit )->cRefKit ) + " - " + AllTrim( ( dbfArticulo )->Nombre ), "¡Atención!" )

                  case nStkActual - nUnidades < ( dbfArticulo)->nMinimo





                        MsgStop( "El stock del componente " + AllTrim( ( dbfKit )->cRefKit ) + " - " + AllTrim( ( dbfArticulo )->Nombre ) + Chr(13)+Chr(10) +  "está bajo minimo." + Chr(13)+Chr(10) +  "Unidades a vender : " + AllTrim( Trans( nUnidades, MasUnd() ) ) + Chr(13)+Chr(10) +  "Stock actual : " + AllTrim( Trans( nStkActual, MasUnd() ) ), "¡Atención!" )

               end

            end

         end

         ( dbfKit )->( dbSkip() )

      end

   end

   ( dbfKit )->( dbGoTo( nRecAct ) )

Return ( nil )



STATIC FUNCTION DupSerie( oWndBrw )

   local oDlg
   local oSerIni
   local oSerFin
   local oTxtDup
   local nTxtDup     := 0
   local nRecno      := ( dbfPreCliT )->( Recno() )
   local nOrdAnt     := ( dbfPreCliT )->( OrdSetFocus( 1 ) )
   local oDesde      := TDesdeHasta():Init( ( dbfPreCliT )->cSerPre, ( dbfPreCliT )->nNumPre, ( dbfPreCliT )->cSufPre, GetSysDate() )
   local lCancel     := .F.
   local oBtnAceptar
   local oBtnCancel
   local oFecDoc
   local cFecDoc     := GetSysDate()




   oDlg = TDialog():New(,,,, "Duplicar series de presupuestos", "DUPSERDOC",, .F.,,,,, oWndBrw, .F.,,,,,, .F., )



   TRadMenu():Redefine( { | u | If( PCount()==0, oDesde:nRadio, oDesde:nRadio:= u ) }, oDlg,, { 90, 91 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, oDesde:cSerieInicio, oDesde:cSerieInicio:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieInicio >= "A" .AND. oDesde:cSerieInicio <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, oDesde:cSerieFin, oDesde:cSerieFin:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieFin >= "A" .AND. oDesde:cSerieFin <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, oDesde:nNumeroInicio, oDesde:nNumeroInicio:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, oDesde:nNumeroFin, oDesde:nNumeroFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, oDesde:cSufijoInicio, oDesde:cSufijoInicio:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, oDesde:cSufijoFin, oDesde:cSufijoFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 170, { | u | If( PCount()==0, oDesde:dFechaInicio, oDesde:dFechaInicio:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 180, { | u | If( PCount()==0, oDesde:dFechaFin, oDesde:dFechaFin:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )




   oFecDoc := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, cFecDoc, cFecDoc:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   oBtnAceptar := TButton():ReDefine( 1, {||( DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, cFecDoc ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( lCancel := .T., oDlg:end() )}, oDlg,,, .F.,,,, .T. )





   oTxtDup := TMeter():ReDefine( 160, { | u | If( PCount()==0, nTxtDup, nTxtDup:= u ) }, ( dbfPreCliT )->( OrdKeyCount() ), oDlg, .F.,,, .T.,,,, )

      oDlg:AddFastKey( 116, {|| DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, cFecDoc ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T., {|Self|( lCancel )},,, oDlg:bRClicked,,, )

   ( dbfPreCliT )->( dbGoTo( nRecNo ) )
   ( dbfPreCliT )->( ordSetFocus( nOrdAnt ) )

   oWndBrw:SetFocus()
   oWndBrw:Refresh()

RETURN NIL



STATIC FUNCTION DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, lCancel, cFecDoc )

   local nOrd
   local nDuplicados    := 0
   local nProcesed      := 0

   oBtnAceptar:Hide()
   oBtnCancel:bAction   := {|| lCancel := .T. }

   if oDesde:nRadio == 1

      nOrd              := ( dbfPreCliT )->( OrdSetFocus( "nNumPre" ) )

      ( dbfPreCliT )->( dbSeek( oDesde:cNumeroInicio(), .T. ) )

      while !lCancel .AND. ( dbfPreCliT )->( !eof() )






         if ( dbfPreCliT )->cSerPre >= oDesde:cSerieInicio  .AND. ( dbfPreCliT )->cSerPre <= oDesde:cSerieFin     .AND. ( dbfPreCliT )->nNumPre >= oDesde:nNumeroInicio .AND. ( dbfPreCliT )->nNumPre <= oDesde:nNumeroFin    .AND. ( dbfPreCliT )->cSufPre >= oDesde:cSufijoInicio .AND. ( dbfPreCliT )->cSufPre <= oDesde:cSufijoFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( dbfPreCliT )->cSerPre + "/" + Alltrim( Str( ( dbfPreCliT )->nNumPre ) ) + "/" + ( dbfPreCliT )->cSufPre

            DupPresupuesto( cFecDoc )

         end

         ( dbfPreCliT )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( dbfPreCliT )->( OrdSetFocus( nOrd ) )

   else

      nOrd              := ( dbfPreCliT )->( OrdSetFocus( "dFecPre" ) )

      ( dbfPreCliT )->( dbSeek( oDesde:dFechaInicio, .T. ) )

      while !lCancel .AND. ( dbfPreCliT )->( !eof() )


         if ( dbfPreCliT )->dFecPre >= oDesde:dFechaInicio  .AND. ( dbfPreCliT )->dFecPre <= oDesde:dFechaFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( dbfPreCliT )->cSerPre + "/" + Alltrim( Str( ( dbfPreCliT )->nNumPre ) ) + "/" + ( dbfPreCliT )->cSufPre

            DupPresupuesto( cFecDoc )

         end

         ( dbfPreCliT )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( dbfPreCliT )->( OrdSetFocus( nOrd ) )

   end

   lCancel              := .T.

   oBtnAceptar:Show()

   if lCancel
      msgStop( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso cancelado" )
   else
      msgInfo( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso finalizado" )
   end

RETURN ( oDlg:End() )



STATIC FUNCTION PreRecDup( cDbf, xField1, xField2, xField3, lCab, cFecDoc )

   local nRec           := ( cDbf )->( Recno() )
   local aTabla         := {}
   local nOrdAnt

   IIF( lCab == nil, lCab := .F., ) ;

   aTabla               := DBScatter( cDbf )
   aTabla[ 1 ]   := xField1
   aTabla[ 2 ]   := xField2
   aTabla[ 3 ]   := xField3

   if lCab

      aTabla[ 4     ]  := cCurSesion()
      if !Empty( cFecDoc )
         aTabla[ 5  ]  := cFecDoc
      end
      aTabla[ 18     ]  := oUser():cCaja()
      aTabla[ 21     ]  := Ctod("")
      aTabla[ 45     ]  := Space( 12 )
      aTabla[ 48     ]  := .T.
      aTabla[ 57     ]  := .F.
      aTabla[ 58     ]  := cCurUsr()
      aTabla[ 59     ]  := GetSysDate()
      aTabla[ 60     ]  := Time()
      aTabla[ 64  ]  := .F.
      aTabla[ 65     ]  := Ctod("")
      aTabla[ 66     ]  := Space( 5 )
      aTabla[ 67     ]  := oUser():cDelegacion()
      aTabla[ 22     ]  := .F.

      nOrdAnt                 := ( cDbf )->( OrdSetFocus( "NNUMPRE" ) )

   end

   if dbDialogLock( cDbf, .T. )
      aEval( aTabla, { | uTmp, n | ( cDbf )->( fieldPut( n, uTmp ) ) } )
      ( cDbf )->( dbUnLock() )
   end

   if lCab
      ( cDbf )->( OrdSetFocus( nOrdAnt ) )
   end

   ( cDbf )->( dbGoTo( nRec ) )

RETURN ( .T. )



STATIC FUNCTION DupPresupuesto( cFecDoc )

   local nNewNumPre  := 0



   nNewNumPre  := nNewDoc( ( dbfPreCliT )->cSerPre, dbfPreCliT, "NPRECLI" )



   PreRecDup( dbfPreCliT, ( dbfPreCliT )->cSerPre, nNewNumPre, ( dbfPreCliT )->cSufPre, .T., cFecDoc )



   if ( dbfPreCliL )->( dbSeek( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre ) )


      while ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre == ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->nNumPre ) + ( dbfPreCliL )->cSufPre .AND.  !( dbfPreCliL )->( Eof() )

            PreRecDup( dbfPreCliL, ( dbfPreCliT )->cSerPre, nNewNumPre, ( dbfPreCliT )->cSufPre, .F. )

         ( dbfPreCliL )->( dbSkip() )

      end

   end



   if ( dbfPreCliD )->( dbSeek( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre ) )


      while ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre == ( dbfPreCliD )->cSerPre + Str( ( dbfPreCliD )->nNumPre ) + ( dbfPreCliD )->cSufPre .AND.  !( dbfPreCliD )->( Eof() )

            PreRecDup( dbfPreCliD, ( dbfPreCliT )->cSerPre, nNewNumPre, ( dbfPreCliT )->cSufPre, .F. )

         ( dbfPreCliD )->( dbSkip() )

      end

   end

RETURN ( .T. )



STATIC FUNCTION SetDialog( aGet, oSayDias, oSayTxtDias, oSayGetRnt, oGetRnt )

   if oTipPre:nAt == 2

      aGet[ 70 ]:Show()
      aGet[ 71  ]:Show()
      aGet[ 23   ]:Hide()

      oSayDias:Show()
      oSayTxtDias:Show()

   else

      aGet[ 70 ]:Hide()
      aGet[ 71  ]:Hide()
      aGet[ 23   ]:Show()

      oSayDias:Hide()
      oSayTxtDias:Hide()

   end

   aGet[ 70 ]:Refresh()
   aGet[ 71  ]:Refresh()
   aGet[ 23   ]:Refresh()

   oSayDias:Refresh()
   oSayTxtDias:Refresh()

   if !lAccArticulo() .OR. oUser():lNotRentabilidad()

      if !Empty( oSayGetRnt )
         oSayGetRnt:Hide()
      end

      if !Empty( oGetRnt )
         oGetRnt:Hide()
      end

   end

Return nil



Function ExpAlmacen( cCodAlm, dbfTmpLin, oBrw )

   local nRec  := ( dbfTmpLin )->( Recno() )

   ( dbfTmpLin )->( dbGoTop() )
   while !( dbfTmpLin )->( eof() )

      if ( dbfTmpLin )->cAlmLin <> cCodAlm
         ( dbfTmpLin )->cAlmLin := cCodAlm
      end

      ( dbfTmpLin )->( dbSkip() )

   end

   ( dbfTmpLin )->( dbGoTo( nRec ) )

   oBrw:Refresh()

Return nil



Function ExpAgente( cCodAge, nComAge, dbfTmpLin, oBrw )

   local nRec  := ( dbfTmpLin )->( Recno() )

   ( dbfTmpLin )->( dbGoTop() )
   while !( dbfTmpLin )->( eof() )

      if ( dbfTmpLin )->nComAge <> nComAge
         ( dbfTmpLin )->nComAge := nComAge
      end

      ( dbfTmpLin )->( dbSkip() )

   end

   ( dbfTmpLin )->( dbGoTo( nRec ) )

   oBrw:Refresh()

Return nil



Function ChangeTarifaCabecera( nNumTar, dbfTmpLin, oBrw )

   local nRec

   if ( nNumTar >= 1 .AND. nNumTar <= 6 )

      if ( nNumTar <> nTarifaPrecio .AND. ( dbfTmpLin )->( LastRec() ) > 0 )

         if ApoloMsgNoYes( "¿ Desea cambiar todas las tarifas de precios a todas las líneas del documento ?" )

            nRec        := ( dbfTmpLin )->( Recno() )

            ( dbfTmpLin )->( dbGoTop() )
            while !( dbfTmpLin )->( eof() )

               if ( dbfTmpLin )->nTarLin <> nNumTar
                  ( dbfTmpLin )->nTarLin := nNumTar
               end

               ( dbfTmpLin )->( dbSkip() )

            end

            ( dbfTmpLin )->( dbGoTo( nRec ) )

            oBrw:Refresh()

         end

         nTarifaPrecio  := nNumTar

      end

   end

Return .T.



Function InitTarifaCabecera( nNumTar )

   nTarifaPrecio  := nNumTar

Return .T.



STATIC FUNCTION ChangeTarifa( aTmp, aGet, aTmpPre )

   local nPrePro  := 0

   if !aTmp[ 68 ]

      nPrePro     := nPrePro( aTmp[ 4 ], aTmp[ 25 ], aTmp[ 27 ], aTmp[ 26 ], aTmp[ 28 ], aTmp[ 73 ], aTmpPre[ 52 ], dbfArtDiv, dbfTarPreL, aTmpPre[ 16 ] )

      if nPrePro == 0
         nPrePro  := nRetPreArt( aTmp[ 73 ], aTmpPre[ 46 ], aTmpPre[ 52 ], dbfArticulo, dbfDiv, dbfKit, dbfIva )
      end

      if nPrePro <> 0
         aGet[ 11 ]:cText( nPrePro )
      end


   else

      aGet[ 11 ]:cText( 0 )

      nPrePro := nPreAlq( aTmp[ 4 ], aTmp[ 73 ], aTmpPre[ 52 ], dbfArticulo )

      if nPrePro <> 0
         aGet[ 67 ]:cText( nPrePro )
      end

   end

return .T.



Static Function ValidaMedicion( aTmp, aGet )

   local cNewUndMed  := aGet[ 18 ]:VarGet





   if ( Empty( cOldUndMed ) .OR. cOldUndMed <> cNewUndMed )

      if oUndMedicion:oDbf:Seek( aTmp[ 18 ] )

         if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
            if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:cText( ( dbfArticulo )->nLngArt )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:Show()
            else
               aTmp[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]  := ( dbfArticulo )->nLngArt
            end
         else
            if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:Hide()
            else
               aTmp[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
            if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:cText( ( dbfArticulo )->nAltArt )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:Show()
            else
               aTmp[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]  := ( dbfArticulo )->nAltArt
            end

         else
            if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:Hide()
            else
               aTmp[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
            if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:cText( ( dbfArticulo ) ->nAncArt )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:Show()
            else
               aTmp[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]  := ( dbfArticulo )->nAncArt
            end
         else
            if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:Hide()
            else
               aTmp[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]  := 0
            end
         end

      else

         if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ] )
            aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:Hide()
            aGet[ ( dbfPreCliL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ] )
            aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:Hide()
            aGet[ ( dbfPreCliL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ] )
            aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:Hide()
            aGet[ ( dbfPreCliL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
         end

      end

      cOldUndMed := cNewUndMed

   end

Return .T.



Static Function LoadTrans( aTmp, oGetCod, oGetKgs, oSayTrn )

   local uValor   := oGetCod:VarGet()

   if Empty( uValor )

      oSayTrn:cText( "" )
      oGetKgs:cText( 0 )

   else

      if oTrans:oDbf:SeekInOrd( uValor, "cCodTrn" )
         oGetCod:cText( uValor )
         oSayTrn:cText( oTrans:oDbf:cNomTrn )
         oGetKgs:cText( oTrans:oDbf:nKgsTrn )
      else
         msgStop( "Código de transportista no encontrado." )
         Return .F.
      end

   end

   RecalculaTotal( aTmp )

Return .T.



Function cFrasePublicitaria( cDbfCol )

   local cTxtFra  := ""

   if ( cDbfCol )->lImpFra
      cTxtFra     := ( cDbfCol )->cTxtFra
   end

Return ( cTxtFra )



FUNCTION IsPreCli( cPath )

   IIF( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "PreCliT.Dbf" )
      dbCreate( cPath + "PreCliT.Dbf", aSqlStruct( aItmPreCli() ), cDriver() )
   end

   if !lExistTable( cPath + "PreCliL.Dbf" )
      dbCreate( cPath + "PreCliL.Dbf", aSqlStruct( aColPreCli() ), cDriver() )
   end

   if !lExistTable( cPath + "PreCliI.Dbf" )
      dbCreate( cPath + "PreCliI.Dbf", aSqlStruct( aIncPreCli() ), cDriver() )
   end

   if !lExistTable( cPath + "PreCliD.Dbf" )
      dbCreate( cPath + "PreCliD.Dbf", aSqlStruct( aPreCliDoc() ), cDriver() )
   end




   if !lExistIndex( cPath + "PreCliT.Cdx" ) .OR.  !lExistIndex( cPath + "PreCliL.Cdx" ) .OR.  !lExistIndex( cPath + "PreCliI.Cdx" ) .OR.  !lExistTable( cPath + "PreCliD.Cdx" )

      rxPreCli( cPath )

   end

Return ( nil )
#line 12281 ".\Prg\Precli.prg"
Static Function DataReport( oFr )





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "Presupuestos", ( dbfPreCliT )->( Select() ), .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "Presupuestos", cItemsToReport( aItmPreCli() ) )

   oFr:SetWorkArea(     "Lineas de presupuestos", ( dbfPreCliL )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de presupuestos", cItemsToReport( aColPreCli() ) )

   oFr:SetWorkArea(     "Incidencias de presupuestos", ( dbfPreCliI )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de presupuestos", cItemsToReport( aIncPreCli() ) )

   oFr:SetWorkArea(     "Documentos de presupuestos", ( dbfPreCliD )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de presupuestos", cItemsToReport( aPreCliDoc() ) )

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Clientes", ( dbfClient )->( Select() ) )
   oFr:SetFieldAliases( "Clientes", cItemsToReport( aItmCli() ) )

   oFr:SetWorkArea(     "Obras", ( dbfObrasT )->( Select() ) )
   oFr:SetFieldAliases( "Obras",  cItemsToReport( aItmObr() ) )

   oFr:SetWorkArea(     "Almacenes", ( dbfAlm )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Rutas", ( dbfRuta )->( Select() ) )
   oFr:SetFieldAliases( "Rutas", cItemsToReport( aItmRut() ) )

   oFr:SetWorkArea(     "Agentes", ( dbfAgent )->( Select() ) )
   oFr:SetFieldAliases( "Agentes", cItemsToReport( aItmAge() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Transportistas", oTrans:Select() )
   oFr:SetFieldAliases( "Transportistas", cObjectsToReport( oTrans:oDbf ) )

   oFr:SetWorkArea(     "Artículos", ( dbfArticulo )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Ofertas", ( dbfOferta )->( Select() ) )
   oFr:SetFieldAliases( "Ofertas", cItemsToReport( aItmOfe() ) )

   oFr:SetWorkArea(     "Unidades de medición",  oUndMedicion:Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( oUndMedicion:oDbf ) )

   oFr:SetMasterDetail( "Presupuestos", "Lineas de presupuestos",          {|| ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre } )
   oFr:SetMasterDetail( "Presupuestos", "Incidencias de presupuestos",     {|| ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre } )
   oFr:SetMasterDetail( "Presupuestos", "Documentos de presupuestos",      {|| ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre } )
   oFr:SetMasterDetail( "Presupuestos", "Empresa",                         {|| cCodigoEmpresaEnUso() } )
   oFr:SetMasterDetail( "Presupuestos", "Clientes",                        {|| ( dbfPreCliT )->cCodCli } )
   oFr:SetMasterDetail( "Presupuestos", "Obras",                           {|| ( dbfPreCliT )->cCodCli + ( dbfPreCliT )->cCodObr } )
   oFr:SetMasterDetail( "Presupuestos", "Almacen",                         {|| ( dbfPreCliT )->cCodAlm } )
   oFr:SetMasterDetail( "Presupuestos", "Rutas",                           {|| ( dbfPreCliT )->cCodRut } )
   oFr:SetMasterDetail( "Presupuestos", "Agentes",                         {|| ( dbfPreCliT )->cCodAge } )
   oFr:SetMasterDetail( "Presupuestos", "Formas de pago",                  {|| ( dbfPreCliT )->cCodPgo } )
   oFr:SetMasterDetail( "Presupuestos", "Transportistas",                  {|| ( dbfPreCliT )->cCodTrn } )

   oFr:SetMasterDetail( "Lineas de presupuestos", "Artículos",             {|| ( dbfPreCliL )->cRef } )
   oFr:SetMasterDetail( "Lineas de presupuestos", "Ofertas",               {|| ( dbfPreCliL )->cRef } )
   oFr:SetMasterDetail( "Lineas de presupuestos", "Unidades de medición",  {|| ( dbfPreCliL )->cUnidad } )

   oFr:SetResyncPair(   "Presupuestos", "Lineas de presupuestos" )
   oFr:SetResyncPair(   "Presupuestos", "Incidencias de presupuestos" )
   oFr:SetResyncPair(   "Presupuestos", "Documentos de presupuestos" )
   oFr:SetResyncPair(   "Presupuestos", "Empresa" )
   oFr:SetResyncPair(   "Presupuestos", "Clientes" )
   oFr:SetResyncPair(   "Presupuestos", "Obras" )
   oFr:SetResyncPair(   "Presupuestos", "Almacenes" )
   oFr:SetResyncPair(   "Presupuestos", "Rutas" )
   oFr:SetResyncPair(   "Presupuestos", "Agentes" )
   oFr:SetResyncPair(   "Presupuestos", "Formas de pago" )
   oFr:SetResyncPair(   "Presupuestos", "Transportistas" )

   oFr:SetResyncPair(   "Lineas de presupuestos", "Artículos" )
   oFr:SetResyncPair(   "Lineas de presupuestos", "Ofertas" )
   oFr:SetResyncPair(   "Lineas de presupuestos", "Unidades de medición" )

Return nil



Static Function VariableReport( oFr )

   oFr:DeleteCategory(  "Presupuestos" )
   oFr:DeleteCategory(  "Lineas de presupuestos" )





   oFr:AddVariable(     "Presupuestos",             "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Presupuestos",             "Total presupuesto",                   "GetHbVar('nTotPre')" )
   oFr:AddVariable(     "Presupuestos",             "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Presupuestos",             "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Presupuestos",             "Total descuentos",                    "GetHbVar('nTotalDto')" )
   oFr:AddVariable(     "Presupuestos",             "Total neto",                          "GetHbVar('nTotNet')" )
   oFr:AddVariable(     "Presupuestos",             "Total primer descuento definible",    "GetHbVar('nTotUno')" )
   oFr:AddVariable(     "Presupuestos",             "Total segundo descuento definible",   "GetHbVar('nTotDos')" )
   oFr:AddVariable(     "Presupuestos",             "Total " + cImp(),                     "GetHbVar('nTotIva')" )
   oFr:AddVariable(     "Presupuestos",             "Total RE",                            "GetHbVar('nTotReq')" )
   oFr:AddVariable(     "Presupuestos",             "Total página",                        "GetHbVar('nTotPag')" )
   oFr:AddVariable(     "Presupuestos",             "Total retención",                     "GetHbVar('nTotRet')" )
   oFr:AddVariable(     "Presupuestos",             "Total peso",                          "GetHbVar('nTotPes')" )
   oFr:AddVariable(     "Presupuestos",             "Total costo",                         "GetHbVar('nTotCos')" )
   oFr:AddVariable(     "Presupuestos",             "Total anticipado",                    "GetHbVar('nTotAnt')" )
   oFr:AddVariable(     "Presupuestos",             "Total cobrado",                       "GetHbVar('nTotCob')" )
   oFr:AddVariable(     "Presupuestos",             "Total artículos",                     "GetHbVar('nTotArt')" )
   oFr:AddVariable(     "Presupuestos",             "Total cajas",                         "GetHbVar('nTotCaj')" )
   oFr:AddVariable(     "Presupuestos",             "Cuenta por defecto del cliente",      "GetHbVar('cCtaCli')" )

   oFr:AddVariable(     "Presupuestos",             "Bruto primer tipo de " + cImp(),      "GetHbArrayVar('aIvaUno',1)" )
   oFr:AddVariable(     "Presupuestos",             "Bruto segundo tipo de " + cImp(),     "GetHbArrayVar('aIvaDos',1)" )
   oFr:AddVariable(     "Presupuestos",             "Bruto tercer tipo de " + cImp(),      "GetHbArrayVar('aIvaTre',1)" )
   oFr:AddVariable(     "Presupuestos",             "Base primer tipo de " + cImp(),       "GetHbArrayVar('aIvaUno',2)" )
   oFr:AddVariable(     "Presupuestos",             "Base segundo tipo de " + cImp(),      "GetHbArrayVar('aIvaDos',2)" )
   oFr:AddVariable(     "Presupuestos",             "Base tercer tipo de " + cImp(),       "GetHbArrayVar('aIvaTre',2)" )
   oFr:AddVariable(     "Presupuestos",             "Porcentaje primer tipo " + cImp(),    "GetHbArrayVar('aIvaUno',3)" )
   oFr:AddVariable(     "Presupuestos",             "Porcentaje segundo tipo " + cImp(),   "GetHbArrayVar('aIvaDos',3)" )
   oFr:AddVariable(     "Presupuestos",             "Porcentaje tercer tipo " + cImp(),    "GetHbArrayVar('aIvaTre',3)" )
   oFr:AddVariable(     "Presupuestos",             "Porcentaje primer tipo RE",           "GetHbArrayVar('aIvaUno',4)" )
   oFr:AddVariable(     "Presupuestos",             "Porcentaje segundo tipo RE",          "GetHbArrayVar('aIvaDos',4)" )
   oFr:AddVariable(     "Presupuestos",             "Porcentaje tercer tipo RE",           "GetHbArrayVar('aIvaTre',4)" )
   oFr:AddVariable(     "Presupuestos",             "Importe primer tipo " + cImp(),       "GetHbArrayVar('aIvaUno',8)" )
   oFr:AddVariable(     "Presupuestos",             "Importe segundo tipo " + cImp(),      "GetHbArrayVar('aIvaDos',8)" )
   oFr:AddVariable(     "Presupuestos",             "Importe tercer tipo " + cImp(),       "GetHbArrayVar('aIvaTre',8)" )
   oFr:AddVariable(     "Presupuestos",             "Importe primer RE",                   "GetHbArrayVar('aIvaUno',9)" )
   oFr:AddVariable(     "Presupuestos",             "Importe segundo RE",                  "GetHbArrayVar('aIvaDos',9)" )
   oFr:AddVariable(     "Presupuestos",             "Importe tercer RE",                   "GetHbArrayVar('aIvaTre',9)" )

   oFr:AddVariable(     "Presupuestos",             "Total unidades primer tipo de impuestos especiales",            "GetHbArrayVar('aIvmUno',1 )" )
   oFr:AddVariable(     "Presupuestos",             "Total unidades segundo tipo de impuestos especiales",           "GetHbArrayVar('aIvmDos',1 )" )
   oFr:AddVariable(     "Presupuestos",             "Total unidades tercer tipo de impuestos especiales",            "GetHbArrayVar('aIvmTre',1 )" )
   oFr:AddVariable(     "Presupuestos",             "Importe del primer tipo de impuestos especiales",               "GetHbArrayVar('aIvmUno',2 )" )
   oFr:AddVariable(     "Presupuestos",             "Importe del segundo tipo de impuestos especiales",              "GetHbArrayVar('aIvmDos',2 )" )
   oFr:AddVariable(     "Presupuestos",             "Importe del tercer tipo de impuestos especiales",               "GetHbArrayVar('aIvmTre',2 )" )
   oFr:AddVariable(     "Presupuestos",             "Total importe primer tipo de impuestos especiales",             "GetHbArrayVar('aIvmUno',3 )" )
   oFr:AddVariable(     "Presupuestos",             "Total importe segundo tipo de impuestos especiales",            "GetHbArrayVar('aIvmDos',3 )" )
   oFr:AddVariable(     "Presupuestos",             "Total importe tercer tipo de impuestos especiales",             "GetHbArrayVar('aIvmTre',3 )" )

   oFr:AddVariable(     "Presupuestos",             "Fecha del primer vencimiento",        "GetHbArrayVar('aDatVto',1)" )
   oFr:AddVariable(     "Presupuestos",             "Fecha del segundo vencimiento",       "GetHbArrayVar('aDatVto',2)" )
   oFr:AddVariable(     "Presupuestos",             "Fecha del tercer vencimiento",        "GetHbArrayVar('aDatVto',3)" )
   oFr:AddVariable(     "Presupuestos",             "Fecha del cuarto vencimiento",        "GetHbArrayVar('aDatVto',4)" )
   oFr:AddVariable(     "Presupuestos",             "Fecha del quinto vencimiento",        "GetHbArrayVar('aDatVto',5)" )
   oFr:AddVariable(     "Presupuestos",             "Importe del primer vencimiento",      "GetHbArrayVar('aImpVto',1)" )
   oFr:AddVariable(     "Presupuestos",             "Importe del segundo vencimiento",     "GetHbArrayVar('aImpVto',2)" )
   oFr:AddVariable(     "Presupuestos",             "Importe del tercero vencimiento",     "GetHbArrayVar('aImpVto',3)" )
   oFr:AddVariable(     "Presupuestos",             "Importe del cuarto vencimiento",      "GetHbArrayVar('aImpVto',4)" )
   oFr:AddVariable(     "Presupuestos",             "Importe del quinto vencimiento",      "GetHbArrayVar('aImpVto',5)" )

   oFr:AddVariable(     "Lineas de presupuestos",   "Detalle del artículo",                "CallHbFunc('cDesPreCli')"  )
   oFr:AddVariable(     "Lineas de presupuestos",   "Total unidades artículo",             "CallHbFunc('nTotNPreCli')" )
   oFr:AddVariable(     "Lineas de presupuestos",   "Precio unitario del artículo",        "CallHbFunc('nTotUPreCli')" )
   oFr:AddVariable(     "Lineas de presupuestos",   "Total línea de presupuesto",          "CallHbFunc('nTotLPreCli')" )
   oFr:AddVariable(     "Lineas de presupuestos",   "Total peso por línea",                "CallHbFunc('nPesLPreCli')" )
   oFr:AddVariable(     "Lineas de presupuestos",   "Total final línea del presupuesto",   "CallHbFunc('nTotFPreCli')" )

Return nil



Function DesignReportPreCli( oFr, dbfDoc )

   local lOpen    := .F.
   local lFlag    := .F.





   if lOpenFiles
      lFlag       := .T.
   else
      if Openfiles()
         lFlag    := .T.
         lOpen    := .T.
      else
         lFlag    := .F.
      end
   end

   if lFlag





      DataReport( oFr )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "   CallHbFunc('nTotPreCli');"                              + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "CabeceraColumnas",  "MainPage", 6 )
         oFr:SetProperty(     "CabeceraColumnas",  "Top", 200 )
         oFr:SetProperty(     "CabeceraColumnas",  "Height", 0 )
         oFr:SetProperty(     "CabeceraColumnas",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "CabeceraColumnas",  "DataSet", "Presupuestos" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de presupuestos" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      VariableReport( oFr )





      oFr:DesignReport()





      oFr:DestroyFr()





      if lOpen
         CloseFiles()
      end

   else

      Return .F.

   end

Return .T.



Function PrintReportPreCli( nDevice, nCopies, cPrinter, dbfDoc )

   local oFr

  local cFilePdf       := cPatTmp() + "PresupuestoCliente" + StrTran( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre, " ", "" ) + ".Pdf"

   IIF( nDevice == nil, nDevice := 2, ) ;
   IIF( nCopies == nil, nCopies := 1, ) ;
   IIF( cPrinter == nil, cPrinter := PrnGetName(), ) ;

   SysRefresh()

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





   DataReport( oFr )





   if !Empty( ( dbfDoc )->mReport )

      oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





      VariableReport( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2

            oFr:ShowPreparedReport()

         case nDevice == 1

            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:Print()

         case nDevice == 3

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatTmp() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .T. )
            oFr:DoExport(     "PDFExport" )

         case nDevice == 6

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatTmp() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .F. )
            oFr:DoExport(     "PDFExport" )

            if file( cFilePdf )

               with object ( TGenMailing():New() )

                  :SetTypeDocument( "nPreCli" )
                  :SetDe(           uFieldEmpresa( "cNombre" ) )
                  :SetCopia(        uFieldEmpresa( "cCcpMai" ) )
                  :SetAdjunto(      cFilePdf )
                  :SetPara(         RetFld( ( dbfPreCliT )->cCodCli, dbfClient, "cMeiInt" ) )
                  :SetAsunto(       "Envio de presupuesto de cliente número " + ( dbfPreCliT )->cSerPre + "/" + Alltrim( Str( ( dbfPreCliT )->nNumPre ) ) )
                  :SetMensaje(      "Adjunto le remito nuestro presupuesto de cliente " + ( dbfPreCliT )->cSerPre + "/" + Alltrim( Str( ( dbfPreCliT )->nNumPre ) ) + Space( 1 ) )
                  :SetMensaje(      "de fecha " + Dtoc( ( dbfPreCliT )->dFecPre ) + Space( 1 ) )
                  :SetMensaje(      Chr(13)+Chr(10) )
                  :SetMensaje(      Chr(13)+Chr(10) )
                  :SetMensaje(      "Reciba un cordial saludo." )

                  :GeneralResource( dbfPreCliT, aItmPreCli() )

               end

            end

      end

   end





   oFr:DestroyFr()

Return .T.









FUNCTION nRentabilidad( nImporte, nDtoAtipico, nCosto )

   if nCosto == 0
      Return ( 100 )
   end

RETURN( ( ( ( nImporte - nDtoAtipico ) / nCosto ) - 1 ) * 100  )



FUNCTION nRentabilidadVentas( nImporte, nDtoAtipico, nCosto )

   if nImporte == 0
      Return ( 100 )
   end

RETURN( ( 1 - Div( nCosto, ( nImporte - nDtoAtipico ) ) ) * 100  )



Function lValLine( dbfLine )

   local lVal  := .T.

   if ( dbfLine )->lControl
      Return .F.
   end

   if ( dbfLine )->lKitArt .OR. ( dbfLine )->lKitChl
      lVal     := ( dbfLine )->lKitPrc
   end

Return ( lVal )



FUNCTION UpSerie( oGet )

   local nAsc
   local cChr
   local cSer  := oGet:VarGet()

   if Empty( cSer ) .OR. cSer < "A"
      cSer     := "A"
      nAsc     := Asc( cSer )
   else
      nAsc     := Asc( cSer ) + 1
   end

   cChr        := Chr( nAsc )

   if cChr <= "Z"
      oGet:cText( cChr )
   end

return nil



FUNCTION DwSerie( oGet )

   local nAsc
   local cChr
   local cSer  := oGet:VarGet()

   nAsc        := Asc( cSer ) - 1
   cChr        := Chr( nAsc )

   if cChr >= "A"
      oGet:cText( cChr )
   end

return nil



Function nLastNum( uTmpLin, cFieldName )

   local nRec
   local nNum           := 0

   IIF( cFieldName == nil, cFieldName := "nNumLin", ) ;

   do case
   case IsChar( uTmpLin )

      nRec              := ( uTmpLin )->( RecNo() )
      ( uTmpLin )->( dbGoTop() )

      while !( uTmpLin )->( eof() )
         nNum           := Max( nNum, ( uTmpLin )->( FieldGet( FieldPos( cFieldName ) ) ) )
         ( uTmpLin )->( dbSkip() )
      end

      ( uTmpLin )->( dbGoTo( nRec ) )

   case IsObject( uTmpLin )

      nRec              := uTmpLin:RecNo()
      uTmpLin:GoTop()

      while !( uTmpLin:eof() )
         nNum           := Max( nNum, uTmpLin:FieldGetByName( cFieldName ) )
         uTmpLin:Skip()
      end

      uTmpLin:GoTo( nRec )

   end

Return ( ++nNum )



Function nCalculoPuntos( nPuntos, nValorPunto, nDtoPnt, nIncPnt )

   local nTotal   := 0

   nTotal         := nPuntos * nValorPunto
   nTotal         -= ( nTotal * nDtoPnt ) / 100

   if nIncPnt <> 0
      nTotal      := nTotal + ( ( nIncPnt * nTotal ) / 100 )
   end

Return ( nTotal )



Function cRefPrvArt( cCodArt, cCodPrv, dbfArtPrv )

   local cReferencia := ""
   local nRec        := ( dbfArtPrv )->( RecNo() )
   local nOrdAnt     := ( dbfArtPrv )->( OrdSetFocus( "cCodPrv" ) )

   if ( dbfArtPrv )->( dbSeek( cCodPrv + cCodArt ) )
      cReferencia    := AllTrim( ( dbfArtPrv )->cRefPrv )
   end

   ( dbfArtPrv )->( OrdSetFocus( nOrdAnt ) )
   ( dbfArtPrv )->( dbGoTo( nRec ) )

Return cReferencia








FUNCTION nDtoLPreCli( dbfLin, nDec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( dbfLin == nil, dbfLin := dbfPreCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   if ( dbfLin )->nDto <> 0
      nCalculo       := nTotUPreCli( dbfLin, nDec ) * ( dbfLin )->nDto / 100
      nCalculo       := Round( nCalculo / nVdv, nDec )
   end

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



Function nTotDtoLPreCli( dbfLin, nDec, nVdv, cPorDiv )

   local nCalculo

   IIF( dbfLin == nil, dbfLin := dbfPreCliL, ) ;
   IIF( nDec == nil, nDec := nDouDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nDtoLPreCli( dbfLin, nDec, nVdv ) * nTotNPreCli( dbfLin )

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

   nCalculo          := Round( nCalculo, nDec )

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )




Static Function YearComboBoxChange()

     if oWndBrw:oWndBar:lAllYearComboBox()
        DestroyFastFilter( dbfPreCliT )
      CreateUserFilter( "", dbfPreCliT, .F., , , "all" )
     else
        DestroyFastFilter( dbfPreCliT )
      CreateUserFilter( "Year( Field->dFecPre ) == " + oWndBrw:oWndBar:cYearComboBox(), dbfPreCliT, .F., , , "Year( Field->dFecPre ) == " + oWndBrw:oWndBar:cYearComboBox() )
     end

     ( dbfPreCliT )->( dbGoTop() )

     oWndBrw:Refresh()

Return nil
