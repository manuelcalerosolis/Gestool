#line 112 "hbclass.ch"
   DYNAMIC DivertConstructorCall
















DECLARE HBClass  New( cName AS String, OPTIONAL SuperParams ) AS CLASS HBClass  Create() AS Object  Instance() AS Object  AddClsMethod( cName AS String, @MethodName(), nScope AS Numeric, n2 AS Numeric, n3 AS Numeric )  AddDelegate( cName AS String, cDelegate AS String, cObject AS String, nScope AS Numeric, lPersistent AS LOGICAL )  AddMultiClsData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String )  AddMultiData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String, x AS LOGICAL, lPer AS LOGICAL )  AddMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  AddInLine( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  AddVirtual( cName AS String )  ModMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  ModClsMethod( cName AS String, @MethodName(), nScope AS Numeric )  ModInline( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  SetOnError( @MethodName() )
#line 85 "\Fwh1204\Include\FiveWin.ch"
   EXTERNAL GetProcAdd
   EXTERNAL TActiveX




extern errorsys
#line 211 ".\Prg\Albprov.prg"
memvar cDbf
memvar cDbfCol
memvar cDbfPrv
memvar cDbfPgo
memvar cDbfIva
memvar cDbfDiv
memvar cDbfAlm
memvar cDbfArt
memvar cDbfKit
memvar cDbfPro
memvar cDbfTblPro
memvar aTotIva
memvar aIvaUno
memvar aIvaDos
memvar aIvaTre
memvar nTotBrt
memvar nTotDto
memvar nTotDpp
memvar nTotNet
memvar nTotIva
memvar nTotReq
memvar nTotAlb
memvar nTotImp
memvar aImpVto
memvar aDatVto
memvar cPicUndAlb
memvar cPinDivAlb
memvar cPirDivAlb
memvar nDinDivAlb
memvar nDirDivAlb
memvar nVdvDivAlb
memvar nPagina
memvar lEnd

static oWndBrw
static oInf
static oGetTot
static dbfPrv
static dbfIva
static dbfTmp
static dbfInci
static dbfTmpInc
static dbfTmpDoc
static dbfTmpSer
static dbfAlbPrvT
static dbfAlbPrvL
static dbfAlbPrvS
static tmpAlbPrvL
static tmpAlbPrvS
static filAlbPrvL
static dbfAlbPrvI
static dbfAlbPrvD
static dbfFPago
static dbfArtCom
static dbfUbicaL
static dbfDiv
static dbfCajT
static oBandera
static dbfArticulo
static dbfCodebar
static dbfFamilia
static dbfArtPrv
static dbfKit
static dbfDoc
static dbfTblCnv
static dbfPedPrvT
static dbfPedPrvL
static dbfPedCliT
static dbfPedCliL
static dbfPro
static dbfFlt
static dbfTblPro
static dbfDelega
static dbfAlm
static dbfUsr
static dbfCount
static dbfEmp
static dbfFacPrvL
static dbfFacPrvS
static dbfRctPrvL
static dbfRctPrvS
static dbfAlbCliL
static dbfAlbCliS
static dbfFacCliL
static dbfFacCliS
static dbfFacRecL
static dbfFacRecS
static dbfTikCliL
static dbfTikCliS
static dbfProLin
static dbfProSer
static dbfProMat
static dbfHisMov
static cNewFile
static cTmpInc
static cTmpDoc
static cTmpSer
static cPinDiv
static cPirDiv
static cPicUnd
static nDinDiv
static nDirDiv
static oGetNet
static oGetIva
static oGetReq
static oUsr
static cUsr
static nOldEst
static oBrwIva
static oStock
static oFont
static oMenu
static nNumAlb
static aNumAlb          := {}
static nGetNeto         := 0
static nGetIva          := 0
static nGetReq          := 0
static nLabels          := 1
static aAlbaranes       := {}

static cOldCodCli       := ""
static cOldCodArt       := ""
static cOldPrpArt       := ""
static cOldUndMed       := ""

static lOpenFiles       := .F.
static lExternal        := .F.

static bEdtRec          := { |aTmp, aGet, dbfAlbPrvT, oBrw, bWhen, bValid, nMode, cCodPed | EdtRec( aTmp, aGet, dbfAlbPrvT, oBrw, bWhen, bValid, nMode, cCodPed ) }
static bEdtDet          := { |aTmp, aGet, dbfAlbPrvT, oBrw, bWhen, bValid, nMode, aAlbPrv | EdtDet( aTmp, aGet, dbfAlbPrvT, oBrw, bWhen, bValid, nMode ) }
static bEdtInc          := { |aTmp, aGet, dbfAlbPrvI, oBrw, bWhen, bValid, nMode, aTmpLin | EdtInc( aTmp, aGet, dbfAlbPrvI, oBrw, bWhen, bValid, nMode, aTmpLin ) }
static bEdtDoc          := { |aTmp, aGet, dbfAlbPrvD, oBrw, bWhen, bValid, nMode, aTmpLin | EdtDoc( aTmp, aGet, dbfAlbPrvD, oBrw, bWhen, bValid, nMode, aTmpLin ) }

static oUndMedicion
static cFiltroUsuario   := ""
static cInforme

static oNumerosSerie
static oBtnNumerosSerie



STATIC FUNCTION OpenFiles( lExt )

   local oBlock

   if lOpenFiles
      MsgStop( "Ficheros de albaranes de proveedores ya abiertos" )
      Return ( .F. )
   end

   IIF( lExt == nil, lExt := .F., ) ;

   lExternal            := lExt

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      DisableAcceso()

      lOpenFiles        := .T.

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVT.DBF" ), ( cCheckArea( "ALBPROVT", @dbfAlbPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVL.DBF" ), ( cCheckArea( "ALBPROVL", @dbfAlbPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPRVI.DBF" ), ( cCheckArea( "ALBPRVI", @dbfAlbPrvI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPRVI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPRVD.DBF" ), ( cCheckArea( "ALBPRVD", @dbfAlbPrvD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPRVD.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbPrvS.DBF" ), ( cCheckArea( "AlbPrvS", @dbfAlbPrvS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbPrvS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatPrv() + "PROVEE.DBF" ), ( cCheckArea( "PROVEE", @dbfPrv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatPrv() + "PROVEE.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROVART.DBF" ), ( cCheckArea( "PROVART", @dbfArtPrv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROVART.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodPrv" )

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ArtCodebar.Dbf" ), ( cCheckArea( "CODEBAR", @dbfCodebar ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ArtCodebar.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatAlm() + "ALMACEN.DBF" ), ( cCheckArea( "ALMACEN", @dbfAlm ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatAlm() + "ALMACEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTKIT.DBF" ), ( cCheckArea( "ARTTIK", @dbfKit ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTKIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ArtDiv.Dbf" ), ( cCheckArea( "ARTCOM", @dbfArtCom ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ArtDiv.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TBLCNV.DBF" ), ( cCheckArea( "TBLCNV", @dbfTblCnv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TBLCNV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RDOCUMEN.DBF" ), ( cCheckArea( "RDOCUMEN", @dbfDoc ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RDOCUMEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CTIPO" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDPROVT.DBF" ), ( cCheckArea( "PEDPROVT", @dbfPedPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDPROVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDPROVL.DBF" ), ( cCheckArea( "PEDPROVL", @dbfPedPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIT.DBF" ), ( cCheckArea( "PEDCLIT", @dbfPedCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIL.DBF" ), ( cCheckArea( "PEDCLIL", @dbfPedCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatGrp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatGrp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "Cajas.Dbf" ), ( cCheckArea( "CAJAS", @dbfCajT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "Cajas.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatAlm() + "UBICAL.DBF" ), ( cCheckArea( "UBICAL", @dbfUbicaL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatAlm() + "UBICAL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "USERS.DBF" ), ( cCheckArea( "USERS", @dbfUsr ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "USERS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIPINCI.DBF" ), ( cCheckArea( "TIPINCI", @dbfInci ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIPINCI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PRO.DBF" ), ( cCheckArea( "PRO", @dbfPro ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TBLPRO.DBF" ), ( cCheckArea( "TBLPRO", @dbfTblPro ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TBLPRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DELEGA.DBF" ), ( cCheckArea( "DELEGA", @dbfDelega ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DELEGA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "NCOUNT.DBF" ), ( cCheckArea( "NCOUNT", @dbfCount ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "NCOUNT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "CNFFLT.DBF" ), ( cCheckArea( "CNFFLT", @dbfFlt ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "CNFFLT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "EMPRESA.DBF" ), ( cCheckArea( "EMPRESA", @dbfEmp ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "EMPRESA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @dbfFacPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVS.DBF" ), ( cCheckArea( "FACPRVS", @dbfFacPrvS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "RctPrvL", @dbfRctPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvS.DBF" ), ( cCheckArea( "RctPrvS", @dbfRctPrvS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIL.DBF" ), ( cCheckArea( "ALBCLIL", @dbfAlbCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cStkFast" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIS.DBF" ), ( cCheckArea( "ALBCLIS", @dbfAlbCliS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIL.DBF" ), ( cCheckArea( "FACCLIL", @dbfFacCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIS.DBF" ), ( cCheckArea( "FACCLIS", @dbfFacCliS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecL.DBF" ), ( cCheckArea( "FacRecL", @dbfFacRecL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecS.DBF" ), ( cCheckArea( "FacRecS", @dbfFacRecS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKEL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CSTKFAST" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKES.DBF" ), ( cCheckArea( "TIKES", @dbfTikCliS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROLIN.DBF" ), ( cCheckArea( "PROLIN", @dbfProLin ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROLIN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROSER.DBF" ), ( cCheckArea( "PROSER", @dbfProSer ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROSER.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMAT.DBF" ), ( cCheckArea( "PROMAT", @dbfProMat ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMAT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "HISMOV.DBF" ), ( cCheckArea( "HISMOV", @dbfHisMov ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "HISMOV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRefMov" )



      oUndMedicion      := UniMedicion():Create( cPatGrp() )
      if !oUndMedicion:OpenFiles()
         lOpenFiles     := .F.
      end



      oBandera             := TBandera():New()

      oStock               := TStock():Create( cPatGrp() )
      if !oStock:lOpenFiles()

         lOpenFiles        := .F.

      else

         oStock:cPedPrvT   := dbfPedPrvT
         oStock:cPedPrvL   := dbfPedPrvL

         oStock:cAlbPrvT   := dbfAlbPrvT
         oStock:cAlbPrvL   := dbfAlbPrvL
         oStock:cAlbPrvS   := dbfAlbPrvS

         oStock:cFacPrvL   := dbfFacPrvL
         oStock:cFacPrvS   := dbfFacPrvS

         oStock:cRctPrvL   := dbfRctPrvL
         oStock:cRctPrvS   := dbfRctPrvS

         oStock:cPedCliT   := dbfPedCliT
         oStock:cPedCliL   := dbfPedCliL

         oStock:cKit       := dbfKit

         oStock:cAlbCliL   := dbfAlbCliL
         oStock:cAlbCliS   := dbfAlbCliS

         oStock:cFacCliL   := dbfFacCliL
         oStock:cFacCliS   := dbfFacCliS

         oStock:cFacRecL   := dbfFacRecL
         oStock:cFacRecS   := dbfFacRecS

         oStock:cTikL      := dbfTikCliL
         oStock:cTikS      := dbfTikCliS

         oStock:cProducL   := dbfProLin
         oStock:cProducS   := dbfProSer

         oStock:cProducM   := dbfProMat
         oStock:cHisMov    := dbfHisMov

      end

      cPicUnd              := MasUnd()





      public nTotAlb       := 0
      public nTotBrt       := 0
      public nTotDto       := 0
      public nTotDPP       := 0
      public nTotNet       := 0
      public nTotIva       := 0
      public nTotReq       := 0
      public nTotImp       := 0
      public aTotIva       := { { 0,0,nil,0,0,0 }, { 0,0,nil,0,0,0 }, { 0,0,nil,0,0,0 } }
      public aIvaUno       := aTotIva[ 1 ]
      public aIvaDos       := aTotIva[ 2 ]
      public aIvaTre       := aTotIva[ 3 ]
      public aImpVto       := {}
      public aDatVto       := {}





      if oUser():lFiltroVentas()
         cFiltroUsuario    := "Field->cCodUsr == '" + oUser():cCodigo() + "' .and. Field->cCodCaj == '" + oUser():cCaja() + "'"
      end





      oNumerosSerie           := TNumerosSerie()
      oNumerosSerie:lCompras  := .T.
      oNumerosSerie:oStock    := oStock

      EnableAcceso()

   RECOVER

      lOpenFiles           := .F.

      EnableAcceso()

      MsgStop( "Imposible abrir ficheros de albaranes de proveedores" )

   end

   ErrorBlock( oBlock )

   if !lOpenFiles
      CloseFiles()
   end

RETURN ( lOpenFiles )



STATIC FUNCTION CloseFiles()

   DisableAcceso()

   DestroyFastFilter( dbfAlbPrvT, .T., .T. )

   if !Empty( oFont )
      oFont:end()
   end

   if !Empty( dbfAlbPrvT )
      ( dbfAlbPrvT )->( dbCloseArea() )
   end

   if dbfAlbPrvL <> nil
      ( dbfAlbPrvL )->( dbCloseArea() )
   end

   if dbfAlbPrvI <> nil
      ( dbfAlbPrvI )->( dbCloseArea() )
   end

   if dbfAlbPrvD <> nil
      ( dbfAlbPrvD )->( dbCloseArea() )
   end

   if !Empty( dbfAlbPrvS )
      ( dbfAlbPrvS )->( dbCloseArea() )
   end

   if dbfPrv <> nil
      ( dbfPrv )->( dbCloseArea() )
   end

   if dbfArtPrv <> nil
      ( dbfArtPrv )->( dbCloseArea() )
   end

   if dbfIva <> nil
      ( dbfIva )->( dbCloseArea() )
   end

   if dbfAlm <> nil
      ( dbfAlm )->( dbCloseArea() )
   end

   if dbfArticulo <> nil
      ( dbfArticulo)->( dbCloseArea() )
   end

   if dbfCodebar <> nil
      ( dbfCodebar )->( dbCloseArea() )
   end

   if dbfFamilia <> nil
      ( dbfFamilia )->( dbCloseArea() )
   end

   if dbfKit <> nil
      ( dbfKit )->( dbCloseArea() )
   end

   if dbfArtCom <> nil
      ( dbfArtCom )->( dbCloseArea() )
   end

   if dbfDiv <> nil
      ( dbfDiv )->( dbCloseArea() )
   end

   if dbfTblCnv <> nil
      ( dbfTblCnv )->( dbCloseArea() )
   end

   if dbfDoc <> nil
      ( dbfDoc )->( dbCloseArea() )
   end

   if dbfPedPrvT <> nil
      ( dbfPedPrvT )->( dbCloseArea() )
   end

   if dbfPedPrvL <> nil
      ( dbfPedPrvL )->( dbCloseArea() )
   end

   if dbfPro <> nil
      ( dbfPro )->( dbCloseArea() )
   end

   if dbfTblPro <> nil
      ( dbfTblPro)->( dbCloseArea() )
   end

   if dbfFPago <> nil
      ( dbfFPago )->( dbCloseArea() )
   end

   if dbfCajT <> nil
      ( dbfCajT )->( dbCloseArea() )
   end

   if dbfUbicaL <> nil
      ( dbfUbicaL )->( dbCloseArea() )
   end

   if dbfUsr <> nil
      ( dbfUsr )->( dbCloseArea() )
   end

   if dbfInci <> nil
      ( dbfInci )->( dbCloseArea() )
   end

   if dbfDelega <> nil
      ( dbfDelega )->( dbCloseArea() )
   end

   if dbfCount <> nil
      ( dbfCount )->( dbCloseArea() )
   end

   if dbfFlt <> nil
      ( dbfFlt )->( dbCloseArea() )
   end

   if dbfPedCliT <> nil
      ( dbfPedCliT )->( dbCloseArea() )
   end

   if dbfPedCliL <> nil
      ( dbfPedCliL )->( dbCloseArea() )
   end

   if dbfEmp <> nil
      ( dbfEmp )->( dbCloseArea() )
   end

   if dbfFacPrvL <> nil
      ( dbfFacPrvL )->( dbCloseArea() )
   end

   if dbfFacPrvS <> nil
      ( dbfFacPrvS )->( dbCloseArea() )
   end

   if dbfRctPrvL <> nil
      ( dbfRctPrvL )->( dbCloseArea() )
   end

   if dbfRctPrvS <> nil
      ( dbfRctPrvS )->( dbCloseArea() )
   end

   if dbfAlbCliL <> nil
      ( dbfAlbCliL )->( dbCloseArea() )
   end

   if dbfAlbCliS <> nil
      ( dbfAlbCliS )->( dbCloseArea() )
   end

   if dbfFacCliL <> nil
      ( dbfFacCliL )->( dbCloseArea() )
   end

   if dbfFacCliS <> nil
      ( dbfFacCliS )->( dbCloseArea() )
   end

   if dbfFacRecL <> nil
      ( dbfFacRecL )->( dbCloseArea() )
   end

   if dbfFacRecS <> nil
      ( dbfFacRecS )->( dbCloseArea() )
   end

   if dbfTikCliL <> nil
      ( dbfTikCliL )->( dbCloseArea() )
   end

   if dbfTikCliS <> nil
      ( dbfTikCliS )->( dbCloseArea() )
   end

   if dbfProLin <> nil
      ( dbfProLin )->( dbCloseArea() )
   end

   if dbfProSer <> nil
      ( dbfProSer )->( dbCloseArea() )
   end

   if dbfProMat <> nil
      ( dbfProMat )->( dbCloseArea() )
   end

   if dbfHisMov <> nil
      ( dbfHisMov )->( dbCloseArea() )
   end

   if oStock <> nil
      oStock:end()
   end

   if !Empty( oUndMedicion )
      oUndMedicion:end()
   end

   dbfUbicaL   := nil
   dbfPrv      := nil
   dbfAlbPrvT  := nil
   dbfAlbPrvL  := nil
   dbfAlbPrvI  := nil
   dbfAlbPrvD  := nil
   dbfAlbPrvS  := nil
   dbfArtPrv   := nil
   dbfIva      := nil
   dbfArticulo := nil
   dbfCodebar  := nil
   dbfFamilia  := nil
   dbfKit      := nil
   dbfArtCom   := nil
   dbfDiv      := nil
   dbfTblCnv   := nil
   dbfDoc      := nil
   dbfPro      := nil
   dbfTblPro   := nil
   dbfAlm      := nil
   dbfFPago    := nil
   dbfCajT     := nil
   dbfUsr      := nil
   dbfInci     := nil
   dbfDelega   := nil
   dbfFlt      := nil
   dbfCount    := nil
   dbfPedCliT  := nil
   dbfPedCliL  := nil
   dbfEmp      := nil
   dbfFacPrvL  := nil
   dbfFacPrvS  := nil
   dbfRctPrvL  := nil
   dbfRctPrvS  := nil

   dbfAlbCliL  := nil
   dbfAlbCliS  := nil

   dbfFacCliL  := nil
   dbfFacCliS  := nil

   dbfFacRecL  := nil
   dbfFacRecS  := nil

   dbfTikCliL  := nil
   dbfTikCliS  := nil

   dbfProLin   := nil
   dbfProSer   := nil

   dbfProMat   := nil

   dbfHisMov   := nil

   oBandera    := nil
   oStock      := nil

   lOpenFiles  := .F.

   oWndBrw     := nil

   EnableAcceso()

RETURN .T.



FUNCTION AlbPrv( oMenuItem, oWnd, cCodPrv, cCodArt, cCodPed )

   local oSnd
   local oRpl
   local oPrv
   local oImp
   local oDel
   local oPdf
   local oMail
   local oRotor
   local nLevel
   local oBtnEur
   local lEuro          := .F.

   IIF( oMenuItem == nil, oMenuItem := "01047", ) ;
   IIF( oWnd == nil, oWnd := oWnd(), ) ;
   IIF( cCodPrv == nil, cCodPrv := "", ) ;
   IIF( cCodArt == nil, cCodArt := "", ) ;
   IIF( cCodPed == nil, cCodPed := "", ) ;





   nLevel            := nLevelUsr( oMenuItem )
   if nAnd( nLevel, 1 ) <> 0
      msgStop( "Acceso no permitido." )
      return .F.
   end





   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

   if !OpenFiles()
      return .F.
   end





   DisableAcceso()


















   oWndBrw := TShell():New( 0, 0, 22, 80, "Albaranes de proveedores",, oWnd,,, .F.,,, ( dbfAlbPrvT ),,,,, {"Número", "Fecha", "Código", "Nombre proveedor", "Su albarán"}, {||( WinAppRec( oWndBrw:oBrw, bEdtRec, dbfAlbPrvT, cCodPrv, cCodArt, cCodPed ) )}, {||( WinEdtRec( oWndBrw:oBrw, bEdtRec, dbfAlbPrvT, cCodPrv, cCodArt, cCodPed ) )}, {||( WinDelRec( oWndBrw:oBrw, dbfAlbPrvT, {|| QuiAlbPrv() } ) )}, {||( WinDupRec( oWndBrw:oBrw, bEdtRec, dbfAlbPrvT, cCodPrv, cCodArt, cCodPed ) )}, nil, nLevel, "Document_plain_businessman_16", ( 0 + ( 114 * 256 ) + ( 198 * 65536 ) ),, {||( WinZooRec( oWndBrw:oBrw, bEdtRec, dbfAlbPrvT ) )}, .T. )

      oWndBrw:lFechado     := .T.

      oWndBrw:bChgIndex    := {|| if( oUser():lFiltroVentas(), CreateFastFilter( cFiltroUsuario, dbfAlbPrvT, .F., , cFiltroUsuario ), CreateFastFilter( "", dbfAlbPrvT, .F. ) ) }

      oWndBrw:SetYearComboBoxChange( {|| YearComboBoxChange() } )

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión cerrada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfAlbPrvT )->lCloAlb }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Zoom16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfAlbPrvT )->lSndDoc }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Lbl16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Facturado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfAlbPrvT )->lFacturado }
         :nWidth           := 20
         :SetCheck( { "Bullet_Square_Green_16", "Bullet_Square_Red_16" } )
         :AddResource( "Trafficlight_on_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Incidencia"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nEstadoIncidencia( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb ) }
         :nWidth           := 20
         :lHide            := .T.
         :AddResource( "Bullet_Square_Red_16" )
         :AddResource( "Bullet_Square_Yellow_16" )
         :AddResource( "Bullet_Square_Green_16" )
         :AddResource( "Informacion_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Impreso"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfAlbPrvT )->lImprimido }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "IMP16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumAlb"
         :bEditValue       := {|| ( dbfAlbPrvT )->cSerAlb + "/" + Alltrim( Str( ( dbfAlbPrvT )->nNumAlb ) ) + "/" + ( dbfAlbPrvT )->cSufAlb }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Su albarán"
         :cSortOrder       := "cSuAlb"
         :bEditValue       := {|| ( dbfAlbPrvT )->cSuAlb }
         :nWidth           := 60
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :bEditValue       := {|| ( dbfAlbPrvT )->cCodDlg }
         :nWidth           := 60
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión"
         :bEditValue       := {|| Trans( ( dbfAlbPrvT )->cTurAlb, "######" ) }
         :nWidth           := 60
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecAlb"
         :bEditValue       := {|| Dtoc( ( dbfAlbPrvT )->dFecAlb ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( dbfAlbPrvT )->cCodCaj }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Usuario"
         :bEditValue       := {|| ( dbfAlbPrvT )->cCodUsr }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Entrada"
         :cSortOrder       := "dFecEnt"
         :bEditValue       := {|| Dtoc( ( dbfAlbPrvT )->dFecEnt ) }
         :nWidth           := 80
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodPrv"
         :bEditValue       := {|| ( dbfAlbPrvT )->cCodPrv }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre proveedor"
         :cSortOrder       := "cNomPrv"
         :bEditValue       := {|| ( dbfAlbPrvT )->cNomPrv }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( dbfAlbPrvT )->nTotNet }
         :cEditPicture     := cPirDiv( ( dbfAlbPrvT )->cDivAlb, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( dbfAlbPrvT )->nTotIva }
         :cEditPicture     := cPirDiv( ( dbfAlbPrvT )->cDivAlb, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "R.E."
         :bEditValue       := {|| ( dbfAlbPrvT )->nTotReq }
         :cEditPicture     := cPirDiv( ( dbfAlbPrvT )->cDivAlb, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( dbfAlbPrvT )->nTotAlb }
         :cEditPicture     := cPirDiv( ( dbfAlbPrvT )->cDivAlb, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( if( lEuro, cDivChg(), ( dbfAlbPrvT )->cDivAlb ), dbfDiv ) }
         :nWidth           := 30
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total unidades"
         :bEditValue       := {|| nTotalUnd( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb, dbfAlbPrvL, cPicUnd ) }
         :nWidth           := 80
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      oWndBrw:cHtmlHelp    := "Albaran de proveedor"

      oWndBrw:CreateXFromCode()





   oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

   oWndBrw:AddSeaBar()








   oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )







   oWndBrw:NewAt( "DUP",,, {||( oWndBrw:RecDup() )}, "(D)uplicar", "D",,, 2,, .F. )






   oWndBrw:NewAt( "EDIT",,, {||( oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )






   oWndBrw:NewAt( "ZOOM",,, {||( oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 4,, .F. )







   oDel := oWndBrw:NewAt( "Del",,, {||( oWndBrw:RecDel() )}, "(E)liminar", "E",, {|This|This:Toggle()}, 16,, .F. )







   oPrv := oWndBrw:NewAt( "Imp",,, {||( GenAlbPrv( 1 ), oWndBrw:Refresh() )}, "(I)mprimir", "I",, {|This|This:Toggle()}, 32,, .F. )

      if !Empty( oPrv )
         lGenAlb( oWndBrw:oBrw, oPrv, 1 )
      end






   oWndBrw:NewAt( "Serie1",,, {||( PrnSerie( oWndBrw ), oWndBrw:Refresh() )}, "Imp(r)imir series", "R",,, 32,, .F. )







   oImp := oWndBrw:NewAt( "Prev1",,, {||( GenAlbPrv( 2 ), oWndBrw:Refresh() )}, "(P)revisualizar", "P",, {|This|This:Toggle()}, 32,, .F. )

      if !Empty( oImp )
         lGenAlb( oWndBrw:oBrw, oImp, 2 )
      end







   oPdf := oWndBrw:NewAt( "DocLock",,, {||( GenAlbPrv( 3 ) )}, "Pd(f)", "F",, {|This|This:Toggle()}, 32,, .F. )

      if !Empty( oPdf )
         lGenAlb( oWndBrw:oBrw, oPdf, 3 )
      end






   oMail := oWndBrw:NewAt( "Mail",,, {||( GenAlbPrv( 6 ) )}, "Correo electrónico",,, {|This|This:Toggle()}, 32,, .F. )


      lGenAlb( oWndBrw:oBrw, oMail, 6 )





   oWndBrw:NewAt( "RemoteControl_",,, {||( TAlbaranProveedoresLabelGenerator():Create() )}, "Eti(q)uetas", "Q",,, 32,, .F. )

   if oUser():lAdministrador()






      oWndBrw:NewAt( "ChgState",,, {||( SetFacturadoAlbaranProveedor( !( dbfAlbPrvT )->lFacturado, oStock, oWndBrw:oBrw ) )}, "Cambiar es(t)ado", "T",,, 4,, .F. )

   end








   oSnd := oWndBrw:NewAt( "Lbl",, "Seleccionar albaranes para ser enviados", {||lSnd( oWndBrw, dbfAlbPrvT )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )






   oBtnEur := oWndBrw:NewAt( "BAL_EURO",,, {||( lEuro := !lEuro, oWndBrw:Refresh() )}, "M(o)neda", "O",,,,, .F. )
   if oUser():lAdministrador()








      oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( TDlgFlt():New( aItmAlbPrv(), dbfAlbPrvT ):ChgFields(), oWndBrw:Refresh() )}, "Cambiar campos",,, {|This|This:Toggle()}, 4,, .F. )







         oWndBrw:NewAt( "BMPCHG",,, {||( TDlgFlt():New( aColAlbPrv(), dbfAlbPrvL ):ChgFields(), oWndBrw:Refresh() )}, "Lineas",,,, 4, oRpl, .F. )

   end






   oWndBrw:NewAt( "INFO",,, {||( TTrazaDocumento():Activate( "02", ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb ) )}, "I(n)forme documento", "N",,, 4,, .F. )





   oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,,, 4,, .F. )






      oWndBrw:NewAt( "BUSINESSMAN_",,, {||( EdtPrv( ( dbfAlbPrvT )->cCodPrv ) )}, "Modificar proveedor",,,, 4, oRotor, .F. )






      oWndBrw:NewAt( "INFO",,, {||( InfProveedor( ( dbfAlbPrvT )->cCodPrv ) )}, "Informe proveedor",,,, 4, oRotor, .F. )






      oWndBrw:NewAt( "CLIPBOARD_EMPTY_BUSINESSMAN_",,, {||( if( !Empty( ( dbfAlbPrvT )->cNumPed ), ZooPedPrv( ( dbfAlbPrvT )->cNumPed ), msgStop( "No hay pedido asociado" ) ) )}, "Visualizar pedido",,,, 4, oRotor, .F. )






      oWndBrw:NewAt( "DOCUMENT_BUSINESSMAN_",,, {||( if( ( dbfAlbPrvT )->lFacturado, MsgStop( "Albarán facturado" ), FacPrv( nil, oWnd, nil, nil, ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb ) ) )}, "Generar factura",,,, 4, oRotor, .T. )





      oWndBrw:NewAt( "DOCUMENT_BUSINESSMAN_",,, {||( if( !Empty( ( dbfAlbPrvT )->cNumFac ), EdtFacPrv( ( dbfAlbPrvT )->cNumFac ), msgStop( "No hay factura asociada" ) ) )}, "Modificar factura",,,, 4, oRotor, .F. )

   if ( "ICG" $ cParamsMain() )





   oWndBrw:NewAt( "Document_plain_user1_",,, {||( IcgMotor() )}, "ICG",,,,,, .F. )
   end





   oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .T. )

   if !oUser():lFiltroVentas()
      oWndBrw:oActiveFilter:aTField       := aItmAlbPrv()
      oWndBrw:oActiveFilter:cDbfFilter    := dbfFlt
      oWndBrw:oActiveFilter:cTipFilter    := "02"
   end

   oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles() )},, oWndBrw:bLButtonUp )

   EnableAcceso()

   if !Empty( cCodPrv ) .OR. !Empty( cCodArt ) .OR. !Empty( cCodPed )

      if !Empty( oWndBrw )
         oWndBrw:RecAdd()
      end

      cCodPrv  := nil
      cCodArt  := nil
      cCodPed  := nil

   end

RETURN .T.



STATIC FUNCTION EdtRec( aTmp, aGet, dbfAlbPrvT, oBrw, cCodPrv, cCodArt, nMode, cCodPed )

   local nOrd
   local oDlg
   local oFld
   local oBrwLin
   local oBrwInc
   local oBrwDoc
   local oBmpDiv
   local oSay           := Array( 6 )
   local cSay           := Array( 6 )
   local oSayLabels     := Array( 7 )
   local oGetMasDiv
   local cGetMasDiv     := ""
   local oBmpEmp
   local cEstado        := if( aTmp[ 30 ], "Facturado", "No facturado" )
   local cTlfPrv
   local oTlfPrv
   local oBmpGeneral

   cTlfPrv              := RetFld( aTmp[ 6 ], dbfPrv, "Telefono" )

    DO CASE
   CASE nMode == 1

      if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 1 ]     := cNewSer( "NALBPRV", dbfCount )
      aTmp[ 4 ]     := cCurSesion()
      aTmp[ 7 ]     := oUser():cAlmacen()
      aTmp[ 8 ]     := oUser():cCaja()
      aTmp[ 32 ]     := cDivEmp()
      aTmp[ 33 ]     := nChgDiv( aTmp[ 32 ], dbfDiv )
      aTmp[ 3 ]     := RetSufEmp()
      aTmp[ 34 ]     := .T.
      aTmp[ 40 ]     := cCurUsr()
      aTmp[ 55 ]     := oUser():cDelegacion()
      aTmp[ 51 ]     := Ctod( "" )
      aTmp[ 17  ]     := Ctod( "" )

      if !Empty( cCodPrv )
         aTmp[ 6 ]  := cCodPrv
      end

      if !Empty( cCodPed )
         aTmp[ 29 ]  := cCodPed
      end

   CASE nMode == 4

      if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 4 ]     := cCurSesion()
      aTmp[ 8 ]     := oUser():cCaja()
      aTmp[ 34 ]     := .T.
      aTmp[ 51 ]     := Ctod( "" )
      aTmp[ 39 ]     := .F.

   CASE nMode == 2

      if aTmp[ 30 ]
         msgStop( "Albarán ya fue facturado." )
         Return .T.
      end

      if aTmp[ 39 ] .AND. !oUser():lAdministrador()
         msgStop( "Solo puede modificar los albaranes cerrados los administradores." )
         Return .F.
      end

   end

   if Empty( aTmp[ 21 ] )
      aTmp[ 21 ]  := Padr( "General", 50 )
   end

   if Empty( aTmp[ 23 ] )
      aTmp[ 23 ]     := Padr( "Pronto pago", 50 )
   end

   if BeginTrans( aTmp )
      Return .F.
   end





   cOldCodCli           := aTmp[ 6 ]





   nOrd                 := ( dbfAlbPrvT )->( ordSetFocus( 1 ) )

   cPicUnd              := MasUnd()
   cPinDiv              := cPinDiv( aTmp[ 32 ], dbfDiv )
   cPirDiv              := cPirDiv( aTmp[ 32 ], dbfDiv )
   nDinDiv              := nDinDiv( aTmp[ 32 ], dbfDiv )
   nDirDiv              := nRouDiv( aTmp[ 32 ], dbfDiv )

   oFont                := TFont():New( "Arial", 8, 26, .F., .T. )





   cSay[ 2 ]            := RetFld( aTmp[ 7 ], dbfAlm )
   cSay[ 3 ]            := RetFld( aTmp[ 18 ], dbfFPago )
   cSay[ 4 ]            := RetFld( aTmp[ 8 ], dbfCajT )
   cSay[ 5 ]            := RetFld( aTmp[ 6 ], dbfPrv )
   cSay[ 6 ]            := RetFld( cCodEmp() + aTmp[ 55 ], dbfDelega, "cNomDlg" )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "albaranes de proveedores", "PEDPRV",, .F.,,,,,, .F.,,,,,, .F., )











      oFld := TFolder():ReDefine( 400, {"&Albarán", "Da&tos", "&Incidencias", "D&ocumentos"}, { "ALBPRV_1","ALBPRV_2","PEDCLI_3","PEDCLI_4" }, oDlg,,,,, .F., )







      oBmpGeneral := TBitmap():ReDefine( 990, "albaran_proveedor_48_alpha",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "folder2_red_alpha_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "information_48_alpha",, oFld:aDialogs[3],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "address_book2_alpha_48",, oFld:aDialogs[4],,, .F., .F.,,, .F.,,, .T. )





      aGet[ 40 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 40 ], aTmp[ 40 ]:= u ) }, oFld:aDialogs[2],,, {||    ( SetUsuario( aGet[ 40 ], oUsr, nil, dbfUsr ) )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oUsr := TGetHlp():ReDefine( 221, { | u | If( PCount()==0, cUsr, cUsr:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

      cUsr        := RetFld( aTmp[ 40 ], dbfUsr, "cNbrUse" )













      aGet[6] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[6], aTmp[6]:= u ) }, oFld:aDialogs[1],, ( RetPicCodPrvEmp() ), {||    ( LoaPrv( aGet, aTmp, dbfPrv, nMode, oSay[ 5 ], oTlfPrv ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwProvee( aGet[6], oSay[ 5 ] ) )}, nil, "LUPA",, )





      aGet[9] := TGetHlp():ReDefine( 141, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[14] := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, aTmp[14], aTmp[14]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oTlfPrv := TGetHlp():ReDefine( 106, { | u | If( PCount()==0, cTlfPrv, cTlfPrv:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )






      aGet[ 10 ] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 10 ], Rtrim( aTmp[ 11 ] ) + Space( 1 ) + Rtrim( aTmp[ 12 ] ) )}, nil, "Environnment_View_16",, )





      aGet[ 13 ] := TGetHlp():ReDefine( 102, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 11 ] := TGetHlp():ReDefine( 103, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 12 ] := TGetHlp():ReDefine( 107, { | u | If( PCount()==0, aTmp[ 12 ], aTmp[ 12 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









        aGet[18] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[18], aTmp[18]:= u ) }, oFld:aDialogs[1],, "@!", {||    cFPago( aGet[18], dbfFPago, oSay[ 3 ] )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|BrwFPago( aGet[18 ], oSay[ 3 ] )}, nil, "LUPA",, )





      oSay[ 3 ] := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cSay[ 3 ], cSay[ 3 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )












      aGet[ 8 ] := TGetHlp():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],,, {||    cCajas( aGet[ 8 ], dbfCajT, oSay[ 4 ] )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 8 ], oSay[ 4 ] ) )}, nil, "LUPA",, )





      oSay[ 4 ] := TGetHlp():ReDefine( 166, { | u | If( PCount()==0, cSay[ 4 ], cSay[ 4 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )













        aGet[ 32 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cDivIn( aGet[ 32 ], oBmpDiv, aGet[ 33 ], @cPinDiv, @nDinDiv, @cPirDiv, @nDirDiv, oGetMasDiv, dbfDiv, oBandera ) )}, "N/W*",,,,, .F., {||     ( nMode == 1 .AND. ( dbfTmp )->( LastRec() ) == 0 )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ 32 ], oBmpDiv, aGet[ 33 ], dbfDiv, oBandera )}, nil, "LUPA",, )




      oBmpDiv := TBitmap():ReDefine( 171, "BAN_EURO",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .F. )






        aGet[ 33 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.9999",, "N/W*",,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )








      aGet[7] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[7], aTmp[7]:= u ) }, oFld:aDialogs[1],,, {||    ( cNomUbicaT( aTmp, aGet, dbfAlm ), cAlmacen( aGet[7], dbfAlm, oSay[ 2 ] ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( Self, oSay[ 2 ] ) )}, nil, "LUPA",, )




      oSay[ 2 ] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, cSay[ 2 ], cSay[ 2 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )



      aGet[41] := TSay():ReDefine( 310, {|| aTmp[41]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[44] := TGetHlp():ReDefine( 311, { | u | If( PCount()==0, aTmp[44], aTmp[44]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[44], aGet[47], aTmp[41], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[47] := TGetHlp():ReDefine( 3111, { | u | If( PCount()==0, aTmp[47], aTmp[47]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      aGet[42] := TSay():ReDefine( 320, {|| aTmp[42]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[45] := TGetHlp():ReDefine( 321, { | u | If( PCount()==0, aTmp[45], aTmp[45]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[45], aGet[48], aTmp[42], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[48] := TGetHlp():ReDefine( 3211, { | u | If( PCount()==0, aTmp[48], aTmp[48]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      aGet[43] := TSay():ReDefine( 330, {|| aTmp[43]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[46] := TGetHlp():ReDefine( 331, { | u | If( PCount()==0, aTmp[46], aTmp[46]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[46], aGet[49], aTmp[43], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[49] := TGetHlp():ReDefine( 3311, { | u | If( PCount()==0, aTmp[49], aTmp[49]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      oBmpEmp := TBitmap():ReDefine( 500,, "Bmp\ImgAlbPrv.bmp", oDlg,,, .F., .F.,,, .F.,,, .F. )
      oBrwLin                 := IXBrowse():New( oFld:aDialogs[1] )

      oBrwLin:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwLin:cAlias          := dbfTmp

      oBrwLin:nMarqueeStyle   := 6
      oBrwLin:cName           := "Lineas de albaranes a proveedor"

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Número"
            :bEditValue       := {|| if( ( dbfTmp )->lKitChl, "", Trans( ( dbfTmp )->nNumLin, "9999" ) ) }
            :nWidth           := 65
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Código"
            :bEditValue       := {|| ( dbfTmp )->cRef }
            :nWidth           := 80
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "C. Barras"
            :bEditValue       := {|| cCodigoBarrasDefecto( ( dbfTmp )->cRef, dbfCodeBar ) }
            :nWidth           := 100
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Código proveedor"
            :bEditValue       := {|| ( dbfTmp )->cRefPrv }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| if( Empty( ( dbfTmp )->cRef ) .AND. !Empty( ( dbfTmp )->mLngDes ), ( dbfTmp )->mLngDes, ( dbfTmp )->cDetalle ) }
            :nWidth           := 305
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Prop. 1"
            :bEditValue       := {|| ( dbfTmp )->cValPr1 }
            :nWidth           := 60
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Prop. 2"
            :bEditValue       := {|| ( dbfTmp )->cValPr2 }
            :nWidth           := 60
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Lote"
            :bEditValue       := {|| ( dbfTmp )->cLote }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Caducidad"
            :bEditValue       := {|| ( dbfTmp )->dFecCad }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Pedido cliente"
            :bEditValue       := {|| if( !Empty( ( dbfTmp )->cNumPed ), Trans( ( dbfTmp )->cNumPed, "@R #/#########/##" ), "" ) }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Cliente"
            :bEditValue       := {|| if( !Empty( (dbfTmp)->cNumPed ), GetCliente( (dbfTmp)->cNumPed ), "" ) }
            :nWidth           := 180
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := cNombreUnidades()
            :bEditValue       := {|| nTotNAlbPrv( dbfTmp ) }
            :cEditPicture     := cPicUnd
            :nWidth           := 60
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "UM. Unidad de medición"
            :bEditValue       := {|| ( dbfTmp )->cUnidad }
            :nWidth           := 25
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Almacen"
            :bEditValue       := {|| ( dbfTmp )->cAlmLin }
            :nWidth           := 60
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Importe"
            :bEditValue       := {|| nTotUAlbPrv( dbfTmp, nDinDiv ) }
            :cEditPicture     := cPinDiv
            :nWidth           := 90
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% Dto."
            :bEditValue       := {|| ( dbfTmp )->nDtoLin }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 50
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% Prm."
            :bEditValue       := {|| ( dbfTmp )->nDtoPrm }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 40
            :lHide            := .T.
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% " + cImp()
            :bEditValue       := {|| ( dbfTmp )->nIva }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 50
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Total"
            :bEditValue       := {|| nTotLAlbPrv( dbfTmp, nDinDiv, nDirDiv ) }
            :cEditPicture     := cPirDiv
            :nWidth           := 80
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         if nMode <> 3
            oBrwLin:bLDblClick   := {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) }
         end

         oBrwLin:CreateFromResource( 190 )





        TButton():ReDefine( 500, {||( AppDeta( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 501, {||( EdtDeta( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwLin, dbfTmp, {|| delDeta() }, {|| RecalculaTotal( aTmp ) } ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( EdtZoom( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )





        TButton():ReDefine( 524, {||( DbSwapUp( dbfTmp, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 525, {||( DbSwapDown( dbfTmp, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )









      aGet[ 21 ] := TGetHlp():ReDefine( 199, { | u | If( PCount()==0, aTmp[ 21 ], aTmp[ 21 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )







        aGet[ 22 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99",,,,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      aGet[ 23 ] := TGetHlp():ReDefine( 209, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )








        aGet[ 24 ] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99",, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )






      aGet[ 35 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 36 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )






      aGet[ 37 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 37 ], aTmp[ 37 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 38 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




































      oBrwIva                        := TXBrowse():New( oFld:aDialogs[ 1 ] )

      oBrwIva:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwIva:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwIva:SetArray( aTotIva )

      oBrwIva:lHScroll               := .F.
      oBrwIva:lVScroll               := .F.
      oBrwIva:nMarqueeStyle          := 5
      oBrwIva:lRecordSelector        := .F.

      oBrwIva:CreateFromResource( 490 )

      with object ( oBrwIva:aCols[ 1 ] )
         :cHeader       := "Bruto"
         :bStrData      := {|| if( !Empty( aTotIva[ oBrwIva:nArrayAt, 1 ] ), Trans( aTotIva[ oBrwIva:nArrayAt, 2 ], cPirDiv ), "" ) }
         :nWidth        := 96
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 2 ] )
         :cHeader       := "Base"
         :bStrData      := {|| if( !Empty( aTotIva[ oBrwIva:nArrayAt, 2 ] ), Trans( aTotIva[ oBrwIva:nArrayAt, 2 ], cPirDiv ), "" ) }
         :nWidth        := 96
         :cEditPicture  := cPirDiv
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 3 ] )
         :cHeader       := "%" + cImp()
         :bStrData      := {|| if( !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ), aTotIva[ oBrwIva:nArrayAt, 3 ], "" ) }
         :bEditValue    := {|| aTotIva[ oBrwIva:nArrayAt, 3 ] }
         :nWidth        := 50
         :cEditPicture  := "@E 999.99"
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
         :nEditType     := 1
         :bEditWhen     := {|| !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ) }
         :bOnPostEdit   := {|o,x| EdtIva( o, x, aTotIva[ oBrwIva:nArrayAt, 3 ], dbfTmp, dbfIva, oBrwLin ), RecalculaTotal( aTmp ) }
      end

      with object ( oBrwIva:aCols[ 4 ] )
         :cHeader       := "%R.E."
         :bStrData      := {|| if( !Empty( aTotIva[ oBrwIva:nArrayAt, 4 ] ) .AND. aTmp[ 25 ], Trans( aTotIva[ oBrwIva:nArrayAt, 4 ], "@E 99.9" ), "" ) }
         :nWidth        := 50
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 5 ] )
         :cHeader       := cImp()
         :bStrData      := {|| if( !Empty( aTotIva[ oBrwIva:nArrayAt, 5 ] ), Trans( aTotIva[ oBrwIva:nArrayAt, 5 ], cPirDiv ), "" ) }
         :nWidth        := 80
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 6 ] )
         :cHeader       := "R.E."
         :bStrData      := {|| if( !Empty( aTotIva[ oBrwIva:nArrayAt, 6 ] ) .AND. aTmp[ 25 ], Trans( aTotIva[ oBrwIva:nArrayAt, 6 ], cPirDiv ), "" ) }
         :nWidth        := 80
         :cEditPicture  := cPirDiv
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
      end








        oGetNet := TSay():ReDefine( 370, {|| nGetNeto}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



        oGetIva := TSay():ReDefine( 380, {|| nGetIva}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



        oGetReq := TSay():ReDefine( 390, {|| nGetReq}, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      aGet[ 25 ] := TCheckBox():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 25 ], aTmp[ 25 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ) )},,,,, .F., {||         ( nMode <> 3 )}, .F. )




      oGetTot := TSay():ReDefine( 410, {|| nTotAlb}, oFld:aDialogs[1],,,, .F., oFont, .F., .F. )




      oGetMasDiv := TSay():ReDefine( 420, {|| cGetMasDiv}, oFld:aDialogs[1],,,, .F., oFont, .F., .F. )










      aGet[ 1 ] := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, aTmp[ 1 ], aTmp[ 1 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( aTmp[ 1 ] >= "A" .AND. aTmp[ 1 ] <= "Z"  )}, "N/W*",,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[ 1 ] ) )}, {||  ( DwSerie( aGet[ 1 ] ) )},,,, nil,,, )





      aGet[ 2 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 2 ], aTmp[ 2 ]:= u ) }, oFld:aDialogs[1],, "999999999",,,,,,, .F., {||      ( .F. )},, .F., .F.,,,,,, nil,,, )




      aGet[ 3 ] := TGetHlp():ReDefine( 105, { | u | If( PCount()==0, aTmp[ 3 ], aTmp[ 3 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )






      TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TButton():ReDefine( 558, {||( GrpPed( aGet, aTmp, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode == 1 .AND. Empty( aTmp[29] ) )},,, .F. )











      aGet[ 29 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],, "@R #/#########/##", {||    ( cPedPrv( aGet, aTmp, oBrwLin, nMode ) )}, "N/W*",,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,, {|Self|(  BrwPedPrv( aGet[ 29 ], dbfPedPrvT, dbfPedPrvL, dbfIva, dbfDiv, dbfFPago ), ::lValid(), oFld:aDialogs[1]:GoNextCtrl( oFld:aDialogs[1]:hWnd ) )}, nil, "LUPA",, )




      aGet[ 30 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, cEstado, cEstado:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      aGet[ 16 ] := TGetHlp():ReDefine( 135, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 17 ] := TGetHlp():ReDefine( 136, { | u | If( PCount()==0, aTmp[ 17 ], aTmp[ 17 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      oSayLabels[ 1 ] := TGroup():ReDefine( 700,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 2 ] := TSay():ReDefine( 701,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 3 ] := TSay():ReDefine( 702,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 4 ] := TSay():ReDefine( 703,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 5 ] := TSay():ReDefine( 704,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 6 ] := TSay():ReDefine( 705,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 7 ] := TSay():ReDefine( 706,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )






      aGet[ 55 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 6 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSay[ 6 ], cSay[ 6 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








      aGet[ 56 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[2],, { 270, 271, 272, 273 },,,,, .F., {||     ( .F. )}, )








        aGet[15] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[15], aTmp[15]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[19] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[19], aTmp[19]:= u ) }, oFld:aDialogs[2],, "@E 999,999",,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





        aGet[27] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[27], aTmp[27]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






        aGet[28] := TMultiGet():ReDefine( 200, { | u | If( PCount()==0, aTmp[28], aTmp[28]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, .F.,, )






      aGet[ 50 ] := TCheckBox():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 .AND. lUsrMaster() )}, .F. )




      aGet[ 51 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )




      aGet[ 52 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 52 ], aTmp[ 52 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )





      oBrwInc                 := IXBrowse():New( oFld:aDialogs[ 3 ] )

      oBrwInc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwInc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwInc:cAlias          := dbfTmpInc

      oBrwInc:nMarqueeStyle   := 5
      oBrwInc:cName           := "Incidencias de albaranes a proveedor"

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Resuelta"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpInc )->lListo }
            :nWidth           := 65
            :SetCheck( { "Sel16", "Cnt16" } )
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Código"
            :bEditValue       := {|| ( dbfTmpInc )->cCodTip }
            :nWidth           := 80
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Incidencia"
            :bEditValue       := {|| cNomInci( ( dbfTmpInc )->cCodTip, dbfInci ) }
            :nWidth           := 220
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpInc )->dFecInc ) }
            :nWidth           := 90
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpInc )->mDesInc }
            :nWidth           := 420
         end

         if nMode <> 3
            oBrwInc:bLDblClick   := {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) }
         end

         oBrwInc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( DbDelRec( oBrwInc, dbfTmpInc, nil, nil, .T. ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F.,,,, .F. )





      oBrwDoc                 := TXBrowse():New( oFld:aDialogs[ 4 ] )

      oBrwDoc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDoc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDoc:cAlias          := dbfTmpDoc

      oBrwDoc:nMarqueeStyle   := 5
      oBrwDoc:nRowHeight      := 40
      oBrwDoc:nDataLines      := 2

         with object ( oBrwDoc:AddCol() )
            :cHeader          := "Documento"
            :bEditValue       := {|| Rtrim( ( dbfTmpDoc )->cNombre ) + Chr(13)+Chr(10) + Space( 5 ) + Rtrim( ( dbfTmpDoc )->cRuta ) }
            :nWidth           := 885
         end

         if nMode <> 3
            oBrwDoc:bLDblClick   := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( ( dbfTmpDoc )->cRuta ) ) }
         end

         oBrwDoc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( DbDelRec( oBrwDoc, dbfTmpDoc, nil, nil, .F. ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwDoc, bEdtDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( ShellExecute( oDlg:hWnd, "open", rTrim( ( dbfTmpDoc )->cRuta ) ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )









      TButton():ReDefine( 4, {||( RecalculaAlbaranProveedores( aTmp, oDlg ), ( oBrwLin:Refresh() ), RecalculaTotal( aTmp ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 1, {||( EndTrans( aTmp, aGet, dbfIva, nDinDiv, nDirDiv, oBrw, nMode, oDlg ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 3, {||( if( EndTrans( aTmp, aGet, dbfIva, nDinDiv, nDirDiv, oBrw, nMode, oDlg ), GenAlbPrv( 1 ), ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( If( ExitNoSave( nMode, dbfTmp ), oDlg:end(), ) )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oFld:aDialogs[1]:AddFastKey( 113, {|| AppDeta( oBrwLin, bEdtDet, aTmp ) } )
      oFld:aDialogs[1]:AddFastKey( 114, {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) } )
      oFld:aDialogs[1]:AddFastKey( 115, {|| WinDelRec( oBrwLin, dbfTmp, {|| delDeta() }, {|| RecalculaTotal( aTmp ) } ) } )

      oFld:aDialogs[3]:AddFastKey( 113, {|| WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 114, {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 115, {|| DbDelRec( oBrwInc, dbfTmpInc, nil, nil, .T. ) } )

      oFld:aDialogs[4]:AddFastKey( 113, {|| WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 114, {|| WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 115, {|| DbDelRec( oBrwDoc, dbfTmpDoc, nil, nil, .F. ) } )

      oDlg:AddFastKey( 118, {|| ExcelImport( aTmp, dbfTmp, dbfArticulo, dbfArtCom, dbfFamilia, dbfDiv, oBrwLin ) } )
      oDlg:AddFastKey( 116, {|| EndTrans( aTmp, aGet, dbfIva, nDinDiv, nDirDiv, oBrw, nMode, oDlg ) } )
      oDlg:AddFastKey( 117, {|| if( EndTrans( aTmp, aGet, dbfIva, nDinDiv, nDirDiv, oBrw, nMode, oDlg ), GenAlbPrv( 1 ), ) } )
      oDlg:AddFastKey( 65,    {|| if( GetKeyState( 17 ), CreateInfoArticulo(), ) } )
   end

   oDlg:AddFastKey ( 112, {|| GoHelp() } )

   do case
      case nMode == 1 .AND. lRecogerUsuario() .AND. Empty( cCodArt )


         oDlg:bStart := {|| if( lGetUsuario( aGet[ 40 ], dbfUsr ), ShowKitCom( dbfAlbPrvT, dbfTmp, oBrwLin, cCodPrv, dbfTmpInc, aGet ), oDlg:end() ) }

      case nMode == 1 .AND. lRecogerUsuario() .AND. !Empty( cCodArt )


         oDlg:bStart := {|| if( lGetUsuario( aGet[ 40 ], dbfUsr ), ( AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt ), ShowKitCom( dbfAlbPrvT, dbfTmp, oBrwLin, cCodPrv, dbfTmpInc, aGet ) ), oDlg:end() ) }

      case nMode == 1 .AND. !lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt ), ShowKitCom( dbfAlbPrvT, dbfTmp, oBrwLin, cCodPrv, dbfTmpInc, aGet ) }

      otherwise
         oDlg:bStart := {|| ShowKitCom( dbfAlbPrvT, dbfTmp, oBrwLin, cCodPrv, dbfTmpInc, aGet ) }

   end





    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|( RecalculaTotal( aTmp ) )}, .T.,,, {|Self|(  if( !Empty( cCodPed ), aGet[ 29 ]:lValid(), ), cNomUbicaT( aTmp, aGet, dbfAlm ), EdtRecMenu( aTmp, oDlg ), oBrwLin:Load() )}, oDlg:bRClicked,,, )

   EndEdtRecMenu()

   oBmpEmp:end()
   oBmpDiv:end()
   oFont:end()
   oBmpGeneral:End()

   ( dbfAlbPrvT )->( OrdSetFocus( nOrd ) )





   if !Empty( aTmp[29] ) .AND. nOldEst <> nil
      if dbLock( dbfPedPrvT )
         ( dbfPedPrvT )->nEstado := nOldEst
         ( dbfPedPrvT )->( dbUnLock() )
      end
   end

   nOldEst           := nil





   KillTrans( oBrwLin, oBrwInc )





   dbCommitAll()

RETURN ( oDlg:nResult == 1 )



Static Function EdtRecMenu( aTmp, oDlg )

   oMenu := MenuBegin( .F.,,, .F., .F. )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F. )

         MenuBegin( .F.,,, .F., .F. )

            if !lExternal




            MenuAddItem( "&1. Visualizar pedido", "Visualiza el pedido del que proviene", .F.,, {|oMenuItem|( if(!Empty( aTmp[ 29 ] ), ZooPedPrv( aTmp[ 29 ] ), msgStop( "No hay pedido asociado" ) ) )},, "Clipboard_empty_businessman_16",,,,, .F.,,, .F. )

            MenuAddItem()




            MenuAddItem( "&2. Modificar proveedor", "Modificar la ficha del proveedor", .F.,, {|oMenuItem|( EdtPrv( aTmp[ 6 ] ) )},, "Businessman_16",,,,, .F.,,, .F. )





            MenuAddItem( "&3. Informe de proveedor", "Abrir el informe del proveedor", .F.,, {|oMenuItem|( InfProveedor( aTmp[ 6 ] ) )},, "Info16",,,,, .F.,,, .F. )
            MenuAddItem()

            end




            MenuAddItem( "&4. Informe del documento", "Abrir el informe del documento", .F.,, {|oMenuItem|( TTrazaDocumento():Activate( "02", ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb ) )},, "Info16",,,,, .F.,,, .F. )

         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMenu )

Return ( oMenu )



Static Function EndEdtRecMenu()

Return ( oMenu:End() )



Static Function RecalculaAlbaranProveedores( aTmp, oDlg )

   local nRecNum
   local nPreCom
   local cCodPrv                    := aTmp[ 6 ]




   if !ApoloMsgNoYes( "¡Atención!,"                                      + Chr(13)+Chr(10) +  "todos los precios se recalcularán en función de"  + Chr(13)+Chr(10) +  "los valores en las bases de datos.", "¿ Desea proceder ?" )
      return nil
   end

   oDlg:Disable()

   ( dbfArticulo )->( ordSetFocus( "Codigo" ) )

   nRecNum                          := ( dbfTmp )->( RecNo() )

   ( dbfTmp )->( dbGotop() )
   while !( dbfTmp )->( eof() )





      nPreCom                       := nComPro( ( dbfTmp )->cRef, ( dbfTmp )->cCodPr1, ( dbfTmp )->cValPr1, ( dbfTmp )->cCodPr2, ( dbfTmp )->cValPr2, dbfArtCom )

      if nPrecom  <> 0

         ( dbfTmp )->nPreDiv        := nPreCom

      else

         if uFieldEmpresa( "lCosPrv", .F. )
            nPreCom                 := nPreArtPrv( cCodPrv, ( dbfTmp )->cRef, dbfArtPrv )
         end

         if nPreCom <> 0
            ( dbfTmp )->nPreDiv     := nPreCom
         else
            ( dbfTmp )->nPreDiv     := nCosto( ( dbfTmp )->cRef, dbfArticulo, dbfKit, .F., aTmp[ 32 ], dbfDiv )
         end





         if uFieldEmpresa( "lCosPrv", .F. )

            nPreCom                 := nDtoArtPrv( cCodPrv, ( dbfTmp )->cRef, dbfArtPrv )

            if nPreCom <> 0
               ( dbfTmp )->nPreDiv  := nPreCom
            end





            nPreCom                 := nPrmArtPrv( cCodPrv, ( dbfTmp )->cRef, dbfArtPrv )

            if nPreCom <> 0
               ( dbfTmp )->nDtoPrm  := nPreCom
            end

         end

      end

      ( dbfTmp )->( dbSkip() )

   end

   ( dbfTmp )->( dbGoTo( nRecNum ) )

   oDlg:Enable()

return nil



Function ExcelImport( aTmpAlb, dbfTmp, dbfArticulo, dbfArtCom, dbfFamilia, dbfDiv, oBrw, lPedido )

   local n
   local m
   local nComPro
   local nUnidad
   local nCajas
   local cCodigo
   local cProp1
   local cProp2
   local oOleExcel
   local cFileExcel  := cGetFile( "Excel ( *.Xls ) | " + "*.Xls", "Seleccione la hoja de calculo" )

   IIF( lPedido == nil, lPedido := .F., ) ;

   if File( cFileExcel )

      oOleExcel                        := TOleExcel():New( "Importando hoja de excel", "Conectando...", .F. )

      oOleExcel:oExcel:Visible         := .T.
      oOleExcel:oExcel:DisplayAlerts   := .F.
      oOleExcel:oExcel:WorkBooks:Open( cFileExcel )

      for m := 1 to 3

         oOleExcel:oExcel:WorkSheets( m ):Activate()

         for n := 9 to 33

            nUnidad  := oOleExcel:oExcel:ActiveSheet:Range( "C" + lTrim( Str( n ) ) ):Value
            nCajas   := oOleExcel:oExcel:ActiveSheet:Range( "E" + lTrim( Str( n ) ) ):Value
            cCodigo  := oOleExcel:oExcel:ActiveSheet:Range( "D" + lTrim( Str( n ) ) ):Value

            if !Empty( nUnidad ) .AND. !Empty( nCajas ) .AND. !Empty( cCodigo )
               cProp1   := Str( nCajas, 3 )
               cProp2   := StrTran( cCodigo, "V", "T" )
               cCodigo  := "2044" + StrTran( Str( nCajas, 3 ), Space( 1 ), "0" )





               if ( dbfArticulo )->( dbSeek( cCodigo ) )

                  ( dbfTmp )->( dbAppend() )

                  ( dbfTmp )->nNumLin     := nLastNum( dbfTmp )
                  ( dbfTmp )->cRef        := ( dbfArticulo )->Codigo
                  ( dbfTmp )->cDetalle    := ( dbfArticulo )->Nombre
                  ( dbfTmp )->cCodPr1     := "1"
                  ( dbfTmp )->cValPr1     := cProp1
                  ( dbfTmp )->cCodPr2     := "2"
                  ( dbfTmp )->cValPr2     := cProp2
                  ( dbfTmp )->nIva        := nIva( dbfIva, ( dbfArticulo )->TipoIva )
                  ( dbfTmp )->nUniCaja    := nUnidad
                  ( dbfTmp )->cCodFam     := ( dbfArticulo )->Familia
                  ( dbfTmp )->cGrpFam     := cGruFam( ( dbfArticulo )->Familia, dbfFamilia )

                  if lPedido

                     ( dbfTmp )->nCanPed  := nCajas / 100
                     ( dbfTmp )->nPreDiv  := nRetPreArt( 1, cDivEmp(), .F., dbfArticulo, dbfDiv, dbfKit, dbfIva )

                  else

                     ( dbfTmp )->nCanEnt     := nCajas / 100

                     nComPro                 := nComPro( ( dbfTmp )->cRef, ( dbfTmp )->cCodPr1, ( dbfTmp )->cValPr1, ( dbfTmp )->cCodPr2, ( dbfTmp )->cValPr2, dbfArtCom )
                     if nComPro <> 0
                        ( dbfTmp )->nPreDiv  := nComPro
                     else
                        ( dbfTmp )->nPreDiv  := ( dbfArticulo )->pCosto
                     end

                  end





                  ( dbfTmp )->( dbUnLock() )

               end

            end

         next

      next

      oOleExcel:oExcel:Quit()

      oOleExcel:oExcel:DisplayAlerts := .T.

      oOleExcel:End()

      ( dbfTmp )->( dbGoTop() )

      oBrw:Refresh()

   end

Return nil







STATIC FUNCTION LoaPrv( aGet, aTmp, dbfPrv, nMode, oSay, oTlfPrv )

   local lValid      := .F.
   local cNewCodCli  := aGet[ 6 ]:VarGet()
   local lChgCodCli  := ( Empty( cOldCodCli ) .OR. cOldCodCli <> cNewCodCli )

   if Empty( cNewCodCli )
      Return .T.
   elseif At( ".", cNewCodCli ) <> 0
      cNewCodCli     := PntReplace( aGet[ 6 ], "0", RetNumCodPrvEmp() )
   else
      cNewCodCli     := Rjust( cNewCodCli, "0", RetNumCodPrvEmp() )
   end

   if ( dbfPrv )->( dbSeek( cNewCodCli ) )

      if ( dbfPrv )->lBlqPrv
         msgStop( "Proveedor bloqueado, no se pueden realizar operaciones de compra" )
         return .F.
      end

      aGet[ 6 ]:cText( ( dbfPrv )->Cod )

      if Empty( aGet[ 9 ]:varGet() ) .OR. lChgCodCli
         aGet[ 9 ]:cText( ( dbfPrv )->Titulo )
      end

      if oTlfPrv <> nil
         oTlfPrv:cText( ( dbfPrv )->Telefono )
      end

      if Empty( aGet[ 10 ]:varGet() ) .OR. lChgCodCli
         aGet[ 10 ]:cText( ( dbfPrv )->Domicilio )
      endif

      if Empty( aGet[ 11 ]:varGet() ) .OR. lChgCodCli
         aGet[ 11 ]:cText( (dbfPrv)->Poblacion )
      endif

      if Empty( aGet[ 12 ]:varGet() ) .OR. lChgCodCli
         aGet[ 12 ]:cText( (dbfPrv)->Provincia )
      endif

      if Empty( aGet[ 13 ]:varGet() ) .OR. lChgCodCli
         aGet[ 13 ]:cText( (dbfPrv)->CodPostal )
      endif

      if Empty( aGet[ 14 ]:varGet() ) .OR. lChgCodCli
         aGet[ 14 ]:cText( ( dbfPrv )->Nif )
      endif





      if lChgCodCli
         aGet[ 21 ]:cText( ( dbfPrv )->cDtoEsp )
         aGet[ 22 ]:cText( ( dbfPrv )->nDtoEsp )
         aGet[ 23    ]:cText( ( dbfPrv )->cDtoPp )
         aGet[ 24    ]:cText( ( dbfPrv )->DtoPp )
      end

      if Empty( aGet[ 18 ]:VarGet() )
         aGet[ 18 ]:cText( ( dbfPrv )->fPago )
         aGet[ 18 ]:lValid()
      end

      if nMode == 1

         aGet[ 56 ]:nOption( Max( ( dbfPrv )->nRegIva, 1 ) )
         aGet[ 56 ]:Refresh()

         if Empty( aTmp[ 1 ] )

            if !Empty( ( dbfPrv )->Serie )
               aGet[ 1 ]:cText( ( dbfPrv )->Serie )
            end

         else

            if !Empty( ( dbfPrv )->Serie ) .AND. aTmp[ 1 ] <> ( dbfPrv )->Serie .AND. ApoloMsgNoYes( "La serie del proveedor seleccionado es distinta a la anterior.", "¿Desea cambiar la serie?" )
               aGet[ 1 ]:cText( ( dbfPrv )->Serie )
            end

         end

      end

      if lChgCodCli
         aTmp[ 25 ] := ( dbfPrv )->lReq
         aGet[ 25 ]:Refresh()
      end

      if ( dbfPrv )->lMosCom .AND. !Empty( ( dbfPrv )->mComent ) .AND. lChgCodCli
         MsgStop( AllTrim( ( dbfPrv )->mComent ) )
      end

      cOldCodCli  := ( dbfPrv )->Cod

      lValid      := .T.

   else

      msgStop( "Proveedor no encontrado" )

   end

RETURN lValid







STATIC FUNCTION AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt )

   WinAppRec( oBrwLin, bEdtDet, dbfTmp, aTmp, cCodArt )

RETURN ( RecalculaTotal( aTmp ) )







STATIC FUNCTION EdtDeta( oBrwLin, bEdtDet, aTmp )

   WinEdtRec( oBrwLin, bEdtDet, dbfTmp, aTmp )

RETURN ( RecalculaTotal( aTmp ) )







STATIC FUNCTION DelDeta()

   CursorWait()

   while ( dbfTmpSer )->( dbSeek( Str( ( dbfTmp )->nNumLin, 4 ) ) )
      ( dbfTmpSer )->( dbDelete() )
   end

   if ( dbfTmp )->lKitArt
      dbDelKit( , dbfTmp, ( dbfTmp )->nNumLin )
   end

   CursorWE()

Return ( .T. )







STATIC FUNCTION EdtZoom( oBrwLin, bEdtDet, aTmp )

   WinZooRec( oBrwLin, bEdtDet, dbfTmp, aTmp )

RETURN NIL







STATIC FUNCTION EdtDet( aTmp, aGet, dbfAlbPrvL, oBrw, aTmpAlb, cCodArt, nMode )

    local oDlg
   local oFld
   local oBmp
   local oBtn
   local oGet1
   local oTotal
    local nTotal
   local cSay2
   local oSay2
   local cGetIra           := Space( 50 )
   local oGetIra
   local oBrwPrp
   local oSayPr1
   local oSayPr2
   local oSayVp1
   local oSayVp2
   local cSayVp1           := ""
   local cSayVp2           := ""
   local cSayPr1           := ""
   local cSayPr2           := ""
   local oBeneficioSobre   := Array( 6 )
   local cBeneficioSobre   := Afill( Array( 6 ), "" )
   local aBeneficioSobre   := { "Costo", "Venta" }
   local oGetStk
   local nGetStk           := 0
   local oSayLote

   cOldCodArt              := aTmp[ 4 ]
   cOldPrpArt              := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]
   cOldUndMed              := aTmp[ 13 ]





   do case
   case nMode == 1

      aTmp[ 8 ]    := 1
      aTmp[ 58  ]    := aTmpAlb[ 7 ]
      aTmp[ 57  ]    := aTmpAlb[ 29 ]
      aTmp[ 51  ]    := lActCos()
      aTmp[ 101  ]    := Ctod( "" )
      aTmp[ 63  ]    := nLastNum( dbfTmp )

      if !Empty( cCodArt )
         aTmp[ 4 ]     := cCodArt
      end

   case nMode == 2

      if !Empty( aTmp[ 4 ] )
         ( dbfArticulo )->( dbSeek( aTmp[ 4 ] ) )
      end

   end

   cBeneficioSobre[ 1 ]    := aBeneficioSobre[ Max( aTmp[ 31 ], 1 ) ]
   cBeneficioSobre[ 2 ]    := aBeneficioSobre[ Max( aTmp[ 32 ], 1 ) ]
   cBeneficioSobre[ 3 ]    := aBeneficioSobre[ Max( aTmp[ 33 ], 1 ) ]
   cBeneficioSobre[ 4 ]    := aBeneficioSobre[ Max( aTmp[ 34 ], 1 ) ]
   cBeneficioSobre[ 5 ]    := aBeneficioSobre[ Max( aTmp[ 35 ], 1 ) ]
   cBeneficioSobre[ 6 ]    := aBeneficioSobre[ Max( aTmp[ 36 ], 1 ) ]

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "lineas a albaranes de proveedores", "LAlbPrv",, .F.,,,,,, .F.,,,,,, .F., )









      oFld := TFolder():ReDefine( 400, {"&General", "&Precios", "&Observaciones"}, { "LALBPRV_1","LALBPRV_2","LFACPRV_5" }, oDlg,,,,, .F., )

      oFld:aEnable   := { .T., !Empty( aTmp[ 4 ] ), .T. }







      aGet[ 4 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 4 ], aTmp[ 4 ]:= u ) }, oFld:aDialogs[1],,, {||    ( loaArt( aGet, aTmp, aTmpAlb, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oGetIra, oDlg, oSayLote, oGetStk, oBeneficioSobre, oTotal, nMode ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwArticulo( aGet[ 4 ], aGet[ 6 ] ) )}, nil, "LUPA",, )








      oSayLote := TSay():ReDefine( 111,, oFld:aDialogs[1],,,, .F.,, .F., .F. )




      aGet[ 62 ] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[ 62 ], aTmp[ 62 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ 101 ] := TGetHlp():ReDefine( 113, { | u | If( PCount()==0, aTmp[ 101 ], aTmp[ 101 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 114, )




      aGet[ 6 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 6 ] ) ) .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 14 ] := TMultiGet():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||         ( nMode <> 3 )}, .F.,, )









      aGet[ 7 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( if( lTiva( dbfIva, aTmp[ 7 ], @aTmp[ 92 ] ), ( aGet[ 49 ]:cText( aTmp[ 7 ] ), .T. ), .F. ) )},,,,,, .F., {||     ( lModIva() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) ) }, .F., .F.,,,,, {|Self|( BrwIva( Self, dbfIva, , .T. ) )}, nil, "LUPA",, )














      aGet[ 54 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aGet[ 54 ], oSayVp1, aTmp[ 52 ], dbfTblPro ), loaArt( aGet, aTmp, aTmpAlb, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oGetIra, oDlg, oSayLote, oGetStk, oBeneficioSobre, oTotal, nMode ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[ 54 ], oSayVp1, aTmp[ 52 ] ) )}, nil, "LUPA",, )

         aGet[ 54 ]:bChange   := {|| aGet[ 54 ]:Assign(), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 58 ], aTmp[ 54 ], aTmp[ 55 ], aTmp[ 62 ], aTmp[ 65 ], aTmp[ 59 ], oGetStk ) }



      oSayPr1 := TSay():ReDefine( 221, {|| cSayPr1}, oFld:aDialogs[1],,,, .F.,, .F., .F. )




      oSayVp1 := TGetHlp():ReDefine( 222, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 55 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aGet[ 55 ], oSayVp2, aTmp[ 53 ], dbfTblPro ), loaArt( aGet, aTmp, aTmpAlb, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oGetIra, oDlg, oSayLote, oGetStk, oBeneficioSobre, oTotal, nMode ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[ 55 ], oSayVp2, aTmp[ 53 ] ) )}, nil, "LUPA",, )

         aGet[ 55 ]:bChange   := {|| aGet[ 55 ]:Assign(), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 58 ], aTmp[ 54 ], aTmp[ 55 ], aTmp[ 62 ], aTmp[ 65 ], aTmp[ 59 ], oGetStk ) }



      oSayPr2 := TSay():ReDefine( 231, {|| cSayPr2}, oFld:aDialogs[1],,,, .F.,, .F., .F. )




      oSayVp2 := TGetHlp():ReDefine( 232, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      oBrwPrp := TWBrowse():ReDefine( 100, {|| { "" } }, oFld:aDialogs[1], {""},,,,,,,,,,,,, .F.,,,,, )















      aGet[ 9 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) )}, "N/W*",,,,, .F., {||     ( lUseCaj() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 141, )










      aGet[ 8 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 151, )








      aGet[ 13 ] := TGetHlp():ReDefine( 152, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oUndMedicion:Existe( aGet[ 13 ], aGet[ 13 ]:oHelpText, "cNombre" ), ValidaMedicion( aTmp, aGet) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oUndMedicion:Buscar( aGet[ 13 ] ), ValidaMedicion( aTmp, aGet ) )}, nil, "LUPA",, 153 )











      aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ], aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 421, )

      aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ] := TGetHlp():ReDefine( 430, { | u | If( PCount()==0, aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ], aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 431, )

      aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ] := TGetHlp():ReDefine( 440, { | u | If( PCount()==0, aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ], aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 441, )

      aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ 10 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],, cPinDiv, {||    ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )









        aGet[15] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[15], aTmp[15]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )









      aGet[16] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[16], aTmp[16]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpAlb, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )







      aGet[17] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[17], aTmp[17]:= u ) }, oFld:aDialogs[1],, "@E 99.99",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      oGetStk := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, nGetStk, nGetStk:= u ) }, oFld:aDialogs[1],, cPicUnd,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      aGet[ 5 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )



















      aGet[58] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[58], aTmp[58]:= u ) }, oFld:aDialogs[1],,, {||    ( cNomUbica( aTmp, aGet, dbfAlm ), cAlmacen( aGet[58], dbfAlm, oSay2 ), oStock:lPutStockActual( aTmp[ 4 ], aTmp[ 58 ], aTmp[ 54 ], aTmp[ 55 ], aTmp[ 62 ], aTmp[ 65 ], aTmp[ 59 ], oGetStk ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( Self, oSay2 ) )}, nil, "LUPA",, )




        oSay2 := TGetHlp():ReDefine( 241, { | u | If( PCount()==0, cSay2, cSay2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )



      aGet[81] := TSay():ReDefine( 300, {|| aTmp[81]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[84] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[84], aTmp[84]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[84], aGet[87], aTmp[81], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[87] := TGetHlp():ReDefine( 271, { | u | If( PCount()==0, aTmp[87], aTmp[87]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      aGet[82] := TSay():ReDefine( 310, {|| aTmp[82]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[85] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[85], aTmp[85]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[85], aGet[88], aTmp[82], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[88] := TGetHlp():ReDefine( 281, { | u | If( PCount()==0, aTmp[88], aTmp[88]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      aGet[83] := TSay():ReDefine( 320, {|| aTmp[83]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[86] := TGetHlp():ReDefine( 290, { | u | If( PCount()==0, aTmp[86], aTmp[86]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[86], aGet[89], aTmp[83], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[89] := TGetHlp():ReDefine( 291, { | u | If( PCount()==0, aTmp[89], aTmp[89]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      oTotal := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, nTotal, nTotal:= u ) }, oFld:aDialogs[1],, cPirDiv,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )







      oGetIra := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, cGetIra, cGetIra:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( SearchProperty( oGetIra, oBrwPrp ) )}, nil, "Lupa", 411, )









      aGet[ 49 ] := TGetHlp():ReDefine( 80, { | u | If( PCount()==0, aTmp[ 49 ], aTmp[ 49 ]:= u ) }, oFld:aDialogs[2],, "@E 999.99",,,,,,, .F., {||        .F.},, .F., .F.,,,,,, nil,,, )




        aGet[ 50 ] := TCheckBox():ReDefine( 90, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     .F.}, .F. )





      aGet[ 18 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[2],, cPinDiv,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 19 ] := TCheckBox():ReDefine( 500, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 25 ] := TGetHlp():ReDefine( 510, { | u | If( PCount()==0, aTmp[ 25 ], aTmp[ 25 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 1 ]:nAt <= 1, aTmp[ 18 ], aTmp[ 19 ], aTmp[ 25 ], aTmp[ 7 ], aGet[ 37 ], aGet[ 43 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 19 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 1 ] := TComboBox():ReDefine( 520, { | u | If( PCount()==0, cBeneficioSobre[ 1 ], cBeneficioSobre[ 1 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 19 ], aGet[ 25 ]:lValid(), aGet[ 37 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 37 ] := TGetHlp():ReDefine( 530, { | u | If( PCount()==0, aTmp[ 37 ], aTmp[ 37 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfPts( oBeneficioSobre[ 1 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 37 ], aGet[ 25 ], aTmp[ 7 ], aGet[ 43 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 43 ] := TGetHlp():ReDefine( 540, { | u | If( PCount()==0, aTmp[ 43 ], aTmp[ 43 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfIva( oBeneficioSobre[ 1 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 43 ], aGet[ 25 ], aTmp[ 7 ], aGet[ 37 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )









      aGet[ 20 ] := TCheckBox():ReDefine( 1, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 26 ] := TGetHlp():ReDefine( 560, { | u | If( PCount()==0, aTmp[ 26 ], aTmp[ 26 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 2 ]:nAt <= 1, aTmp[ 18 ], aTmp[ 20 ], aTmp[ 26 ], aTmp[ 7 ], aGet[ 38 ], aGet[ 44 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 20 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 2 ] := TComboBox():ReDefine( 570, { | u | If( PCount()==0, cBeneficioSobre[ 2 ], cBeneficioSobre[ 2 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 20 ], aGet[ 26 ]:lValid(), aGet[ 38 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 38 ] := TGetHlp():ReDefine( 580, { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfPts( oBeneficioSobre[ 2 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 38 ], aGet[ 26 ], aTmp[ 7 ], aGet[ 44 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 44 ] := TGetHlp():ReDefine( 590, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfIva( oBeneficioSobre[ 2 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 44 ], aGet[ 26 ], aTmp[ 7 ], aGet[ 38 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )









      aGet[ 21 ] := TCheckBox():ReDefine( 600, { | u | If( PCount()==0, aTmp[ 21 ], aTmp[ 21 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 27 ] := TGetHlp():ReDefine( 610, { | u | If( PCount()==0, aTmp[ 27 ], aTmp[ 27 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 3 ]:nAt <= 1, aTmp[ 18 ], aTmp[ 21 ], aTmp[ 27 ], aTmp[ 7 ], aGet[ 39 ], aGet[ 45 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 21 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 3 ] := TComboBox():ReDefine( 620, { | u | If( PCount()==0, cBeneficioSobre[ 3 ], cBeneficioSobre[ 3 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 21 ], aGet[ 27 ]:lValid(), aGet[ 39 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 39 ] := TGetHlp():ReDefine( 630, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfPts( oBeneficioSobre[ 3 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 39 ], aGet[ 27 ], aTmp[ 7 ], aGet[ 45 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 45 ] := TGetHlp():ReDefine( 640, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfIva( oBeneficioSobre[ 3 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 45 ], aGet[ 27 ], aTmp[ 7 ], aGet[ 39 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )









      aGet[ 22 ] := TCheckBox():ReDefine( 650, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 28 ] := TGetHlp():ReDefine( 660, { | u | If( PCount()==0, aTmp[ 28 ], aTmp[ 28 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 4 ]:nAt <= 1, aTmp[ 18 ], aTmp[ 22 ], aTmp[ 28 ], aTmp[ 7 ], aGet[ 40 ], aGet[ 46 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 22 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 4 ] := TComboBox():ReDefine( 670, { | u | If( PCount()==0, cBeneficioSobre[ 4 ], cBeneficioSobre[ 4 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 22 ], aGet[ 28 ]:lValid(), aGet[ 40 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 40 ] := TGetHlp():ReDefine( 680, { | u | If( PCount()==0, aTmp[ 40 ], aTmp[ 40 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfPts( oBeneficioSobre[ 4 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 40 ], aGet[ 28 ], aTmp[ 7 ], aGet[ 46 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 46 ] := TGetHlp():ReDefine( 690, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfIva( oBeneficioSobre[ 4 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 46 ], aGet[ 28 ], aTmp[ 7 ], aGet[ 40 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )









      aGet[ 23 ] := TCheckBox():ReDefine( 700, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 29 ] := TGetHlp():ReDefine( 710, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 5 ]:nAt <= 1, aTmp[ 18 ], aTmp[ 23 ], aTmp[ 29 ], aTmp[ 7 ], aGet[ 41 ], aGet[ 47 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 23 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 5 ] := TComboBox():ReDefine( 720, { | u | If( PCount()==0, cBeneficioSobre[ 5 ], cBeneficioSobre[ 5 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 23 ], aGet[ 29 ]:lValid(), aGet[ 41 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 41 ] := TGetHlp():ReDefine( 730, { | u | If( PCount()==0, aTmp[ 41 ], aTmp[ 41 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfPts( oBeneficioSobre[ 5 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 41 ], aGet[ 29 ], aTmp[ 7 ], aGet[ 47 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 47 ] := TGetHlp():ReDefine( 740, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfIva( oBeneficioSobre[ 5 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 47 ], aGet[ 29 ], aTmp[ 7 ], aGet[ 41 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )









      aGet[ 24 ] := TCheckBox():ReDefine( 750, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 30 ] := TGetHlp():ReDefine( 760, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 6 ]:nAt <= 1, aTmp[ 18 ], aTmp[ 24 ], aTmp[ 30 ], aTmp[ 7 ], aGet[ 42 ], aGet[ 48 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 24 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 6 ] := TComboBox():ReDefine( 770, { | u | If( PCount()==0, cBeneficioSobre[ 6 ], cBeneficioSobre[ 6 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 24 ], aGet[ 30 ]:lValid(), aGet[ 42 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 42 ] := TGetHlp():ReDefine( 780, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfPts( oBeneficioSobre[ 6 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 42 ], aGet[ 30 ], aTmp[ 7 ], aGet[ 48 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 48 ] := TGetHlp():ReDefine( 790, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv, {||    ( CalBnfIva( oBeneficioSobre[ 6 ]:nAt <= 1, aTmp[ 50 ], aTmp[ 18 ], aTmp[ 48 ], aGet[ 30 ], aTmp[ 7 ], aGet[ 42 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 50 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )










      aGet[ 59 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 59 ], aTmp[ 59 ]:= u ) }, oFld:aDialogs[ 2 ],, { 350, 351, 352 },,,,, .F., {||     ( nMode <> 3 )}, )




      aGet[ 51 ] := TCheckBox():ReDefine( 420, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 .AND. lActCos() )}, .F. )





      aGet[ 93 ] := TMultiGet():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 93 ], aTmp[ 93 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      oBtn := TButton():ReDefine( 1, {||( SaveDeta( aTmp, aGet, oDlg, oFld, oBrw, nMode, oTotal, oGet1, aTmpAlb, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBrwPrp, oGetIra, oBmp, oSayLote, oGetStk, oBtn ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 9, {||( GoHelp() )}, oDlg,,, .F.,,,, .F. )




      oBtnNumerosSerie := TButton():ReDefine( 552, {||( EditarNumerosSerie( aTmp, nMode ) )}, oDlg,,, .F.,,,, .F. )

      if nMode <> 3
         oDlg:AddFastKey( 117, {|| oBtnNumerosSerie:Click() } )
         oDlg:AddFastKey( 116, {|| oBtn:SetFocus(), oBtn:Click() } )
      end

      oDlg:AddFastKey ( 112, {|| GoHelp() } )



      oDlg:bStart := {|| SetDlgMode( aGet, aTmp, aTmpAlb, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBrwPrp, oGetIra, oBmp, oDlg, oSayLote, oTotal ), if( !Empty( cCodArt ), aGet[ 4 ]:lValid(), ), aGet[ 13 ]:lValid() }



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( EdtDetMenu( aGet[ 4 ], oDlg ) )}, oDlg:bRClicked,,, )

   EndDetMenu()

RETURN ( oDlg:nResult == 1 )



static Function cNomUbica( aTmp, aGet, dbfAlm )

   aTmp[81]      := cGetUbica( aTmp[58], dbfAlm, 1 )
   aTmp[82]      := cGetUbica( aTmp[58], dbfAlm, 2 )
   aTmp[83]      := cGetUbica( aTmp[58], dbfAlm, 3 )

   if Empty( aTmp[81] )
      aGet[81]:Hide()
      aGet[84]:Hide()
      aGet[87]:Hide()
   else
      aGet[81]:Show()
      aGet[84]:Show()
      aGet[87]:Show()
   end

   if Empty( aTmp[82] )
      aGet[82]:Hide()
      aGet[85]:Hide()
      aGet[88]:Hide()
   else
      aGet[82]:Show()
      aGet[85]:Show()
      aGet[88]:Show()
   end

   if Empty( aTmp[83] )
      aGet[83]:Hide()
      aGet[86]:Hide()
      aGet[89]:Hide()
   else
      aGet[83]:Show()
      aGet[86]:Show()
      aGet[89]:Show()
   end

   aGet[81]:Refresh()
   aGet[84]:Refresh()
   aGet[87]:Refresh()
   aGet[82]:Refresh()
   aGet[85]:Refresh()
   aGet[89]:Refresh()
   aGet[83]:Refresh()
   aGet[86]:Refresh()
   aGet[89]:Refresh()

return .T.



static Function cNomUbicaT( aTmp, aGet, dbfAlm )

   if !Empty( aTmp[7] )

      aTmp[41]      := cGetUbica( aTmp[7], dbfAlm, 1 )
      aTmp[42]      := cGetUbica( aTmp[7], dbfAlm, 2 )
      aTmp[43]      := cGetUbica( aTmp[7], dbfAlm, 3 )

      if Empty( aTmp[41] )
         aGet[41]:Hide()
         aGet[44]:Hide()
         aGet[47]:Hide()
      else
         aGet[41]:Show()
         aGet[44]:Show()
         aGet[47]:Show()
      end

      if Empty( aTmp[42] )
         aGet[42]:Hide()
         aGet[45]:Hide()
         aGet[48]:Hide()
      else
         aGet[42]:Show()
         aGet[45]:Show()
         aGet[48]:Show()
      end

      if Empty( aTmp[43] )
         aGet[43]:Hide()
         aGet[46]:Hide()
         aGet[49]:Hide()
      else
         aGet[43]:Show()
         aGet[46]:Show()
         aGet[49]:Show()
      end

   else

      aGet[41]:Hide()
      aGet[44]:Hide()
      aGet[47]:Hide()
      aGet[42]:Hide()
      aGet[45]:Hide()
      aGet[48]:Hide()
      aGet[43]:Hide()
      aGet[46]:Hide()
      aGet[49]:Hide()

   end

   aGet[41]:Refresh()
   aGet[44]:Refresh()
   aGet[47]:Refresh()
   aGet[42]:Refresh()
   aGet[45]:Refresh()
   aGet[49]:Refresh()
   aGet[43]:Refresh()
   aGet[46]:Refresh()
   aGet[49]:Refresh()

return .T.



Static Function SetDlgMode( aGet, aTmp, aTmpAlb, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBrwPrp, oGetIra, oBmp, oDlg, oSayLote, oTotal )

   local cCodArt     := aGet[ 4 ]:varGet()

   if !lUseCaj()
      aGet[ 9 ]:Hide()
   else
      aGet[ 9 ]:SetText( cNombreCajas() )
   end

   aGet[ 8 ]:SetText( cNombreUnidades() )

   if Empty( aTmp[58 ] )
      aTmp[ 58 ]  := aTmpAlb[ 7 ]
   end

   oBrwPrp:Hide()
   oGetIra:Hide()

   oSayPr1:SetText( "" )
   oSayVp1:SetText( "" )

   oSayPr2:SetText( "" )
   oSayVp2:SetText( "" )

   do case
   case nMode == 1

      aGet[ 4    ]:show()
      aGet[ 6]:show()
      aGet[ 14 ]:Hide()
      aGet[ 62   ]:Hide()
      aGet[ 101 ]:Hide()
      aGet[ 9 ]:cText( 1 )
      aGet[ 8]:cText( 1 )
      aGet[ 58 ]:cText( aTmpAlb[ 7 ] )

      aGet[ 7    ]:cText( nIva( dbfIva, cDefIva() ) )
      aGet[ 49 ]:cText( nIva( dbfIva, cDefIva() ) )

      aTmp[ 92    ]  := nReq( dbfIva, cDefIva() )
      aTmp[ 63 ]  := nLastNum( dbfTmp )

      oSayLote:Hide()

   case nMode <> 1 .AND. empty( cCodArt )

      aGet[ 4    ]:Hide()
      aGet[ 6]:Hide()
      aGet[ 14 ]:show()
      aGet[ 62   ]:Hide()
      aGet[ 101 ]:Hide()

      oSayLote:Hide()

   case nMode <> 1 .AND. !empty( cCodArt )

      aGet[ 4    ]:show()
      aGet[ 6]:show()
      aGet[ 14 ]:Hide()

      if aTmp[ 60   ]
         aGet[ 62   ]:Show()
         aGet[ 101 ]:Show()
         oSayLote:Show()
      else
         aGet[ 62   ]:Hide()
         aGet[ 101 ]:Hide()
         oSayLote:Hide()
      end

   end

   lCalcDeta( aTmp, aTmpAlb, aGet, oTotal )

   IF !empty( aTmp[ 52 ] )
      aGet[ 54 ]:Show()
      aGet[ 54 ]:lValid()
      oSayPr1:Show()
      oSayPr1:SetText( retProp( aTmp[52], dbfPro ) )
      oSayVp1:Show()
   ELSE
      aGet[ 54 ]:Hide()
      oSayPr1:Hide()
      oSayVp1:Hide()
   end

   IF !empty( aTmp[ 53 ] )
      aGet[ 55 ]:Show()
      aGet[ 55 ]:lValid()
      oSayPr2:Show()
      oSayPr2:SetText( retProp( aTmp[ 53 ], dbfPro ) )
      oSayVp2:Show()
   ELSE
      aGet[ 55 ]:Hide()
      oSayPr2:Hide()
      oSayVp2:Hide()
   end



   aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:Hide()
   aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:Hide()
   aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:Hide()

   if oUndMedicion:oDbf:Seek( aTmp[ 13 ] )

      if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:Show()
      end

      if oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:Show()
      end

      if oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:Show()
      end

   end

   aGet[ 58  ]:lValid()
   aGet[ 4     ]:SetFocus()








RETURN .T.



STATIC FUNCTION SaveDeta( aTmp, aGet, oDlg, oFld, oBrw, nMode, oTotal, oGet, aTmpAlb, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBrwPrp, oGetIra, oBmp, oSayLote, oGetStk, oBtn, oBtnSer )

   local n, i

   if !lMoreIva( aTmp[ 7 ] )
      Return nil
   end

   if Empty( aTmp[ 58 ] )
      MsgStop( "Código de almacen no puede estar vacio" )
      aGet[ 58 ]:SetFocus()
      Return nil
   end

   if !cAlmacen( aGet[ 58 ], dbfAlm )
      MsgStop( "Código de almacen no encontrado" )
      Return nil
   end





   if ( nMode == 1 ) .AND. ( aTmp[ 106 ] )

      if ( aTmp[ 107 ] )

         AutoNumerosSerie( aTmp, nMode )

      elseif !( dbfTmpSer )->( dbSeek( Str( aTmp[ 63 ], 4 ) + aTmp[ 4 ] ) )

         msgStop( "Tiene que introducir números de serie para este artículo." )

         EditarNumerosSerie( aTmp, nMode )

         Return .F.

      end

   end





   if aTmp[ 60 ] .AND. nMode == 1
      GraLotArt( aTmp[ 4 ], dbfArticulo, aTmp[ 62 ] )
   end

   if nMode == 1

      if !Empty( oBrwPrp:Cargo )

         for n := 1 to len( oBrwPrp:Cargo )

            for i := 1 to len( oBrwPrp:Cargo[ n ] )

               if IsNum( oBrwPrp:Cargo[ n, i ]:Value ) .AND. oBrwPrp:Cargo[ n, i ]:Value <> 0

                  aTmp[ 8]  := oBrwPrp:Cargo[ n, i ]:Value
                  aTmp[ 52 ]  := oBrwPrp:Cargo[ n, i ]:cCodigoPropiedad1
                  aTmp[ 54 ]  := oBrwPrp:Cargo[ n, i ]:cValorPropiedad1
                  aTmp[ 53 ]  := oBrwPrp:Cargo[ n, i ]:cCodigoPropiedad2
                  aTmp[ 55 ]  := oBrwPrp:Cargo[ n, i ]:cValorPropiedad2
                  aTmp[ 10 ]  := oBrwPrp:Cargo[ n, i ]:nPrecioCompra

                  WinGather( aTmp, aGet, dbfTmp, oBrw, nMode, nil, .F. )

               end

            next

         next

         aCopy( dbBlankRec( dbfTmp ), aTmp )

         aEval( aGet, {| o, i | if( "GET" $ o:ClassName(), o:cText( aTmp[ i ] ), ) } )

      else

         WinGather( aTmp, aGet, dbfTmp, oBrw, nMode )

      end

      if lEntCon()

         SetDlgMode( aGet, aTmp, aTmpalb, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBrwPrp, oGetIra, oBmp, oDlg, oSayLote, oTotal )

         nTotAlbPrv( nil, dbfAlbPrvT, dbfTmp, dbfIva, dbfDiv, aTmpAlb )

      else

         oDlg:End( 1 )

      end

   else

      WinGather( aTmp, aGet, dbfTmp, oBrw, nMode )

      oDlg:end( 1 )

   end

   cOldCodArt        := ""
   cOldPrpArt        := ""
   cOldUndMed        := ""

   if !Empty( aGet[ 13 ] )
      aGet[ 13 ]:lValid()
   end

   if !Empty( oBrwPrp )
      oBrwPrp:Cargo  := nil
   end

   if oGet <> nil
      oGet:cText( Space( 18 ) )
      oGet:SetFocus()
   end

   if oGetStk <> nil
      oGetStk:cText( 0 )
   end

RETURN NIL



Static Function EdtInc( aTmp, aGet, dbfAlbPrvI, oBrw, bWhen, bValid, nMode, aTmpAlb )

   local oDlg
   local oNomInci
   local cNomInci

   if !Empty( aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ] )
      cNomInci          := cNomInci( aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], dbfInci )
   end

   if nMode == 1
      aTmp[ 1  ] := aTmpAlb[ 1 ]
      aTmp[ 2  ] := aTmpAlb[ 2 ]
      aTmp[ 3  ] := aTmpAlb[ 3 ]
      if IsMuebles()
         aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]  := .T.
      end
   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "incidencias de albaranes a proveedores", "INCIDENCIA",, .F.,,,,,, .F.,,,,,, .F., )








      aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ]:= u ) }, oDlg,,, {||    ( cTipInci( aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], dbfInci, oNomInci ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwIncidencia( dbfInci, aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], oNomInci ) )}, nil, "LUPA",, )




      oNomInci := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, cNomInci, cNomInci:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



Static Function EdtDoc( aTmp, aGet, dbfPedPrvD, oBrw, bWhen, bValid, nMode, aTmpLin )

   local oDlg
   local oRuta
   local oNombre
   local oObservacion

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "documento de albarán a proveedor", "DOCUMENTOS",, .F.,,,,,, .F.,,,,,, .F., )




      oNombre := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      oRuta := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oRuta:cText( cGetFile( "Doc ( *.* ) | *.*", "Seleccione el nombre del fichero" ) ) )}, nil, "FOLDER",, )





      oObservacion := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



STATIC FUNCTION PrnSerie( oBrw )

    local oDlg
   local oFmtDoc
   local cFmtDoc     := cFormatoDocumento( ( dbfAlbPrvT )->cSerAlb, "nAlbPrv", dbfCount )
   local oSayFmt
   local cSayFmt
   local oSerIni
   local oSerFin
   local nRecno      := ( dbfAlbPrvT )->( Recno() )
   local nOrdAnt     := ( dbfAlbPrvT )->( OrdSetFocus( 1 ) )
   local cSerIni     := ( dbfAlbPrvT )->cSerAlb
   local cSerFin     := ( dbfAlbPrvT )->cSerAlb
   local nDocIni     := ( dbfAlbPrvT )->nNumAlb
   local nDocFin     := ( dbfAlbPrvT )->nNumAlb
   local cSufIni     := ( dbfAlbPrvT )->CSUFALB
   local cSufFin     := ( dbfAlbPrvT )->CSUFALB
   local oPrinter
   local cPrinter    := PrnGetName()
   local lCopiasPre  := .T.
   local lInvOrden   := .F.
   local oNumCop
   local nNumCop     := if( nCopiasDocumento( ( dbfAlbPrvT )->cSerAlb, "nAlbPrv", dbfCount ) == 0, Max( Retfld( ( dbfAlbPrvT )->cCodPrv, dbfPrv, "nCopiasF" ), 1 ), nCopiasDocumento( ( dbfAlbPrvT )->cSerAlb, "nAlbPrv", dbfCount ) )

   if Empty( cFmtDoc )
      cFmtDoc        := cSelPrimerDoc( "AP" )
   end

   cSayFmt           := cNombreDoc( cFmtDoc )

   oDlg = TDialog():New(,,,, "Imprimir series de albaranes", "IMPSERDOC",, .F.,,,,,, .F.,,,,,, .F., )









   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z"  )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )









   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z"  )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )









   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999", {||    ( If ( !( dbfAlbPrvT )->( dbSeek( cSerIni + Str( nDocIni, 9 ) + cSufIni ) ),    ( msgStop( "Documento no valido" ), .F. ),    ( .T. ) ) )}, "N/W*",,,,, .F.,,, .F., .T.,,,,,, nil,,, )









   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999", {||    ( If ( !( dbfAlbPrvT )->( dbSeek( cSerFin  + Str( nDocFin, 9 ) + cSufFin ) ),    ( msgStop( "Documento no valido" ), .F. ),    ( .T. ) ) )}, "N/W*",,,,, .F.,,, .F., .T.,,,,,, nil,,, )








   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##", {||    ( If ( !( dbfAlbPrvT )->( dbSeek( cSerIni  + Str( nDocIni, 9 ) + cSufIni ) ),    ( msgStop( "Documento no valido" ), .F. ),    ( .T. ) ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,,, nil,,, )




   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )



   TCheckBox():ReDefine( 500, { | u | If( PCount()==0, lInvOrden, lInvOrden:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 170, { | u | If( PCount()==0, lCopiasPre, lCopiasPre:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oNumCop := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, nNumCop, nNumCop:= u ) }, oDlg,, "999999999", {||    nNumCop > 0},,,,,, .F., {||     !lCopiasPre},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )







   oFmtDoc := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cFmtDoc, cFmtDoc:= u ) }, oDlg,,, {||    ( cDocumento( oFmtDoc, oSayFmt, dbfDoc ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oFmtDoc, oSayFmt, "AP" ) )}, nil, "LUPA",, )





   oSayFmt := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayFmt, cSayFmt:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 92, "Printer_pencil_16",,,,,{|| EdtDocumento( cFmtDoc ) }, oDlg, .F., , .F.,  )




   oPrinter := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cPrinter, cPrinter:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 161, "Printer_preferences_16",,,,,{|| PrinterPreferences( oPrinter ) }, oDlg, .F., , .F.,  )





   TButton():ReDefine( 1, {||(  StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden ), oDlg:end( 1 ) } )

   oDlg:bStart := { || oSerIni:SetFocus() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   ( dbfAlbPrvT )->( ordSetFocus( nOrdAnt ) )
   ( dbfAlbPrvT )->( dbGoTo( nRecNo ) )

    oBrw:refresh()

RETURN NIL



STATIC FUNCTION StartPrint( cFmtDoc, cDocIni, cDocFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden )

local nCopyProvee

   oDlg:disable()

   if !lInvOrden

      ( dbfAlbPrvT )->( dbSeek( cDocIni, .T. ) )


      while ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb >= cDocIni .AND.  ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb <= cDocFin

            lChgImpDoc( dbfAlbPrvT )

         if lCopiasPre

            nCopyProvee := if( nCopiasDocumento( ( dbfAlbPrvT )->cSerAlb, "nAlbPrv", dbfCount ) == 0, Max( Retfld( ( dbfAlbPrvT )->cCodPrv, dbfPrv, "nCopiasF" ), 1 ), nCopiasDocumento( ( dbfAlbPrvT )->cSerAlb, "nAlbPrv", dbfCount ) )

            GenAlbPrv( 1, "Imprimiendo documento : " + ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb, cFmtDoc, cPrinter, nCopyProvee )

         else

            GenAlbPrv( 1, "Imprimiendo documento : " + ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb, cFmtDoc, cPrinter, nNumCop )

         end

      ( dbfAlbPrvT )->( dbSkip() )

      end

   else

      ( dbfAlbPrvT )->( dbSeek( cDocFin ) )



      while ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb >= cDocIni .AND. ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb <= cDocFin .AND. !( dbfAlbPrvT )->( Bof() )

            lChgImpDoc( dbfAlbPrvT )

         if lCopiasPre

            nCopyProvee := if( nCopiasDocumento( ( dbfAlbPrvT )->cSerAlb, "nAlbPrv", dbfCount ) == 0, Max( Retfld( ( dbfAlbPrvT )->cCodPrv, dbfPrv, "nCopiasF" ), 1 ), nCopiasDocumento( ( dbfAlbPrvT )->cSerAlb, "nAlbPrv", dbfCount ) )

            GenAlbPrv( 1, "Imprimiendo documento : " + ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb, cFmtDoc, cPrinter, nCopyProvee )

         else

            GenAlbPrv( 1, "Imprimiendo documento : " + ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb, cFmtDoc, cPrinter, nNumCop )

         end

      ( dbfAlbPrvT )->( dbSkip( -1 ) )

      end

   end

   oDlg:enable()

RETURN NIL



FUNCTION GenAlbPrv( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local oDevice
   local nAlbaran

   if ( dbfAlbPrvT )->( Lastrec() ) == 0
      Return nil
   end

   nAlbaran             := ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->CSUFALB

   IIF( nDevice == nil, nDevice := 1, ) ;
   IIF( cCaption == nil, cCaption := "Imprimiendo albarán", ) ;
   IIF( cCodDoc == nil, cCodDoc := cFormatoDocumento( ( dbfAlbPrvT )->cSerAlb, "nAlbPrv", dbfCount ), ) ;
   IIF( nCopies == nil, nCopies := if( nCopiasDocumento( ( dbfAlbPrvT )->cSerAlb, "nAlbPrv", dbfCount ) == 0, Max( Retfld( ( dbfAlbPrvT )->cCodPrv, dbfPrv, "nCopiasF" ), 1 ), nCopiasDocumento( ( dbfAlbPrvT )->cSerAlb, "nAlbPrv", dbfCount ) ), ) ;

   if Empty( cCodDoc )
      cCodDoc           := cFirstDoc( "AP", dbfDoc )
   end

   if !lExisteDocumento( cCodDoc, dbfDoc )
      return nil
   end





   if lVisualDocumento( cCodDoc, dbfDoc )

      PrintReportAlbPrv( nDevice, nCopies, cPrinter, dbfDoc )

   else

      if !lExisteDocumento( cCodDoc, dbfDoc )
         return nil
      end





      ( dbfAlbPrvL)->( dbSeek( nAlbaran ) )
      ( dbfPrv    )->( dbSeek( ( dbfAlbPrvT )->cCodPrv ) )
      ( dbfDiv    )->( dbSeek( ( dbfAlbPrvT )->cDivAlb ) )
      ( dbfFPago  )->( dbSeek( ( dbfAlbPrvT )->cCodPgo ) )
      ( dbfAlm    )->( dbSeek( ( dbfAlbPrvT )->cCodAlm ) )

      private cDbf         := dbfAlbPrvT
      private cDbfCol      := dbfAlbPrvL
      private cDbfPrv      := dbfPrv
      private cDbfPgo      := dbfFPago
      private cDbfIva      := dbfIva
      private cDbfDiv      := dbfDiv
      private cDbfAlm      := dbfAlm
      private cDbfArt      := dbfArticulo
      private cDbfKit      := dbfKit
      private cDbfPro      := dbfPro
      private cDbfTblPro   := dbfTblPro
      private cPicUndAlb   := cPicUnd
      private cPinDivAlb   := cPinDiv
      private cPirDivAlb   := cPirDiv
      private nDinDivAlb   := nDinDiv
      private nDirDivAlb   := nDirDiv
      private nVdvDivAlb   := ( dbfAlbPrvT )->nVdvAlb

      if !Empty( cPrinter )
         oDevice           := TPrinter():New( cCaption, .F., .T., cPrinter )
         oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .F.,, oDevice, cCaption,,, )
      else
         oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .T.,,, cCaption,,, )
      end

      if !Empty( oInf ) .AND. oInf:lCreated
         oInf:lAutoLand          := .F.
         oInf:lFinish            := .F.
         oInf:lNoCancel          := .T.
         oInf:bSkip              := {|| AlbPrvReportSkipper( dbfAlbPrvL ) }

         oInf:oDevice:lPrvModal  := .T.

         do case
            case nDevice == 1
               oInf:bPreview     := {| oDevice | PrintPreview( oDevice ) }

            case nDevice == 3
               oInf:bPreview     := {| oDevice | PrintPdf( oDevice ) }

         end

         SetMargin(  cCodDoc, oInf )
         PrintColum( cCodDoc, oInf )

      end

      RptEnd()




      oInf:Activate({||               ( !( dbfAlbPrvL )->lImpLin )}, {||             ( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->CSUFALB == nAlbaran )},,,, {||        EPage( oInf, cCodDoc )},,,,,,,, )

      if nDevice == 1
         oInf:oDevice:end()
      end

      oInf                 := nil

   end

   lChgImpDoc( dbfAlbPrvT )

RETURN NIL



Static Function AlbPrvReportSkipper( dbfAlbPrvL )

   ( dbfAlbPrvL )->( dbSkip() )

Return nil



static function nGenAlbPrv( nDevice, cTitle, cCodDoc, cPrinter, nCopy )

   local nImpYet     := 1
   local nCopyClient := Retfld( ( dbfAlbPrvT )->cCodPrv, dbfPrv, "nCopiasF" )

   IIF( nDevice == nil, nDevice := 1, ) ;
   IIF( nCopy == nil, nCopy := Max( nCopyClient, nCopiasDocumento( ( dbfAlbPrvT )->cSerAlb, "nAlbPrv", dbfCount ) ), ) ;

   nCopy             := Max( nCopy, 1 )

   while nImpYet <= nCopy
      GenAlbPrv( nDevice, cTitle, cCodDoc, cPrinter )
      nImpYet++
   end


   lChgImpDoc( dbfAlbPrvT )

return nil



STATIC FUNCTION EPage( oInf, cCodDoc )

   private nPagina      := oInf:nPage
    private lEnd            := oInf:lFinish

   PrintItems( cCodDoc, oInf )

RETURN NIL






static function nTotalUnd( nAlbaran, dbfAlbPrvL, cPicUnd )

   local nTotUnd  := 0

   if ( dbfAlbPrvL )->( dbSeek( nAlbaran ) )
      while  ( dbfAlbPrvL )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->CSUFALB == nAlbaran .AND. ( dbfAlbPrvL )->( !eof() )
         nTotUnd  += nTotNAlbPrv( dbfAlbPrvL )
         ( dbfAlbPrvL )->( dbSkip() )
      end
   end

RETURN ( Trans( nTotUnd, cPicUnd ) )







FUNCTION nTotAlbPrv( nAlbaran, cAlbPrvT, cAlbPrvL, cIva, cDiv, aTmp, cDivRet, lPic )

    local bCondition
   local nTotArt
    local dFecFac
    local lRecargo
    local nDtoEsp
    local nDtoPP
   local nDtoUno
    local nDtoDos
   local nPorte
    local nRecno
    local cCodDiv
    local cPinDiv
    local nDinDiv
   local nRegIva
    local aTotalDto    := { 0, 0, 0 }
    local aTotalDPP    := { 0, 0, 0 }
   local aTotalUno   := { 0, 0, 0 }
      local aTotalDos   := { 0, 0, 0 }
   local nTotUno
   local nTotDos

   IIF( cAlbPrvT == nil, cAlbPrvT := dbfAlbPrvT, ) ;
   IIF( cAlbPrvL == nil, cAlbPrvL := dbfAlbPrvL, ) ;
   IIF( cIva == nil, cIva := cIva, ) ;
   IIF( cDiv == nil, cDiv := cDiv, ) ;
   IIF( nAlbaran == nil, nAlbaran := ( cAlbPrvT )->cSerAlb + Str( ( cAlbPrvT )->nNumAlb ) + ( cAlbPrvT )->cSufAlb, ) ;
   IIF( lPic == nil, lPic := .F., ) ;

   public nTotAlb    := 0
   public nTotBrt    := 0
   public nTotDto    := 0
   public nTotDPP    := 0
   public nTotNet    := 0
   public nTotIva    := 0
   public nTotReq    := 0
   public nTotImp    := 0
   public aTotIva    := { { 0,0,nil,0,0,0 }, { 0,0,nil,0,0,0 }, { 0,0,nil,0,0,0 } }
   public aIvaUno    := aTotIva[ 1 ]
   public aIvaDos    := aTotIva[ 2 ]
   public aIvaTre    := aTotIva[ 3 ]
   public aImpVto    := {}
   public aDatVto    := {}

   nRecno            := ( cAlbPrvL )->( Recno() )

    IF aTmp <> NIL
        dFecFac            := aTmp[ 5 ]
        lRecargo            := aTmp[ 25]
        nDtoEsp            := aTmp[ 22 ]
        nDtoPP            := aTmp[ 24    ]
      nDtoUno        := aTmp[ 36 ]
      nDtoDos        := aTmp[ 38 ]
      nPorte         := aTmp[ 20 ]
        cCodDiv            := aTmp[ 32 ]
      nRegIva        := aTmp[ 56 ]
      bCondition     := {|| !( cAlbPrvL )->( Eof() ) }
      (cAlbPrvL)->( dbGoTop() )
    ELSE
      dFecFac        := ( cAlbPrvT )->dFecAlb
      lRecargo       := ( cAlbPrvT )->lRecargo
      nDtoEsp        := ( cAlbPrvT )->nDtoEsp
      nDtoPP         := ( cAlbPrvT )->nDpp
      nDtoUno        := ( cAlbPrvT )->nDtoUno
      nDtoDos        := ( cAlbPrvT )->nDtoDos
      nPorte         := ( cAlbPrvT )->nPortes
      cCodDiv        := ( cAlbPrvT )->cDivAlb
      nRegIva        := ( cAlbPrvT )->nRegIva
      bCondition     := {|| ( cAlbPrvL )->cSerAlb + Str( ( cAlbPrvL )->nNumAlb ) + ( cAlbPrvL )->cSufAlb == nAlbaran .AND. (cAlbPrvL)->( !eof() ) }
      ( cAlbPrvL )->( dbSeek( nAlbaran ) )
    end

   cPinDiv           := cPinDiv( cCodDiv, cDiv )
   cPirDiv           := cPirDiv( cCodDiv, cDiv )
   nDinDiv           := nDinDiv( cCodDiv, cDiv )
   nDirDiv           := nRinDiv( cCodDiv, cDiv )

   while Eval( bCondition )

      if lValLine( cAlbPrvL )

         nTotArt     := nTotLAlbPrv( cAlbPrvL, nDinDiv, nDirDiv )
         if nTotArt <> 0





            do case
            case aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 1, 3 ] == ( cAlbPrvL )->nIva
               aTotIva[ 1, 3 ]   := ( cAlbPrvL )->nIva
               aTotIva[ 1, 4 ]   := ( cAlbPrvL )->nReq
               aTotIva[ 1, 1 ]   += nTotArt

            case aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 2, 3 ] == ( cAlbPrvL )->nIva
               aTotIva[ 2, 3 ]   := ( cAlbPrvL )->nIva
               aTotIva[ 2, 4 ]   := ( cAlbPrvL )->nReq
               aTotIva[ 2, 1 ]   += nTotArt

            case aTotIva[ 3, 3 ] == nil .OR. aTotIva[ 3, 3 ] == ( cAlbPrvL )->nIva
               aTotIva[ 3, 3 ]   := ( cAlbPrvL )->nIva
               aTotIva[ 3, 4 ]   := ( cAlbPrvL )->nReq
               aTotIva[ 3, 1 ]   += nTotArt
            end

         end

      end

      ( cAlbPrvL )->( dbSkip() )

   end

   ( cAlbPrvL )->( dbGoTo( nRecno) )





   nTotBrt           := aTotIva[ 1, 1 ] + aTotIva[ 2, 1 ] + aTotIva[ 3, 1 ]





   nTotBrt           += nPorte

   aTotIva[ 1, 2 ]         := aTotIva[ 1, 1 ]
   aTotIva[ 2, 2 ]         := aTotIva[ 2, 1 ]
   aTotIva[ 3, 2 ]         := aTotIva[ 3, 1 ]





   if nDtoEsp <> 0
        aTotalDto[1]    := Round( aTotIva[ 1, 2 ] * nDtoEsp / 100, nDinDiv )
        aTotalDto[2]    := Round( aTotIva[ 2, 2 ] * nDtoEsp / 100, nDinDiv )
        aTotalDto[3]    := Round( aTotIva[ 3, 2 ] * nDtoEsp / 100, nDinDiv )

      nTotDto        := aTotalDto[1] + aTotalDto[2] + aTotalDto[3]

        aTotIva[ 1, 2 ]        -= aTotalDto[1]
        aTotIva[ 2, 2 ]        -= aTotalDto[2]
        aTotIva[ 3, 2 ]        -= aTotalDto[3]
   end

   if nDtoPP <> 0
        aTotalDPP[1]    := Round( aTotIva[ 1, 2 ] * nDtoPP / 100, nDinDiv )
        aTotalDPP[2]    := Round( aTotIva[ 2, 2 ] * nDtoPP / 100, nDinDiv )
        aTotalDPP[3]    := Round( aTotIva[ 3, 2 ] * nDtoPP / 100, nDinDiv )

      nTotDPP        := aTotalDPP[1] + aTotalDPP[2] + aTotalDPP[3]

        aTotIva[ 1, 2 ]        -= aTotalDPP[1]
        aTotIva[ 2, 2 ]        -= aTotalDPP[2]
        aTotIva[ 3, 2 ]        -= aTotalDPP[3]
   end

   if nDtoUno <> 0
      aTotalUno[1]   := Round( aTotIva[ 1, 2 ] * nDtoUno / 100, nDirDiv )
      aTotalUno[2]   := Round( aTotIva[ 2, 2 ] * nDtoUno / 100, nDirDiv )
      aTotalUno[3]   := Round( aTotIva[ 3, 2 ] * nDtoUno / 100, nDirDiv )

      nTotUno        := aTotalUno[1] + aTotalUno[2] + aTotalUno[3]

        aTotIva[ 1, 2 ]        -= aTotalUno[1]
        aTotIva[ 2, 2 ]        -= aTotalUno[2]
        aTotIva[ 3, 2 ]        -= aTotalUno[3]
   end

   if nDtoDos <> 0
      aTotalDos[1]   := Round( aTotIva[ 1, 2 ] * nDtoDos / 100, nDirDiv )
      aTotalDos[2]   := Round( aTotIva[ 2, 2 ] * nDtoDos / 100, nDirDiv )
      aTotalDos[3]   := Round( aTotIva[ 3, 2 ] * nDtoDos / 100, nDirDiv )

      nTotDos        := aTotalDos[1] + aTotalDos[2] + aTotalDos[3]

        aTotIva[ 1, 2 ]        -= aTotalDos[1]
        aTotIva[ 2, 2 ]        -= aTotalDos[2]
        aTotIva[ 3, 2 ]        -= aTotalDos[3]
   end

   nTotNet           := aTotIva[ 1, 2 ] + aTotIva[ 2, 2 ]   + aTotIva[ 3, 2 ]





   if nRegIva <= 1

      aTotIva[ 1, 5 ]      := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 3 ] / 100, nDirDiv ), 0 )
      aTotIva[ 2, 5 ]      := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 3 ] / 100, nDirDiv ), 0 )
      aTotIva[ 3, 5 ]      := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 3 ] / 100, nDirDiv ), 0 )





      if lRecargo
         aTotIva[ 1, 6 ]   := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 4 ] / 100, nDirDiv ), 0 )
         aTotIva[ 2, 6 ]   := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 4 ] / 100, nDirDiv ), 0 )
         aTotIva[ 3, 6 ]   := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 4 ] / 100, nDirDiv ), 0 )
      end

   end





   nTotIva           := Round( aTotIva[ 1, 5 ] + aTotIva[ 2, 5 ] + aTotIva[ 3, 5 ], nDirDiv )





   nTotReq           := Round( aTotIva[ 1, 6 ] + aTotIva[ 2, 6 ] + aTotIva[ 3, 6 ], nDirDiv )





   nTotImp        := nTotIva + nTotReq





   nTotAlb        := nTotNet + nTotImp

   aTotIva        := aSort( aTotIva,,, {|x,y| abs( x[1] ) > abs( y[1] ) } )





   if cDivRet <> nil .AND. cDivRet <> cCodDiv
      nTotNet     := nCnv2Div( nTotNet, cCodDiv, cDivRet, cDiv )
      nTotIva     := nCnv2Div( nTotIva, cCodDiv, cDivRet, cDiv )
      nTotReq     := nCnv2Div( nTotReq, cCodDiv, cDivRet, cDiv )
      nTotAlb     := nCnv2Div( nTotAlb, cCodDiv, cDivRet, cDiv )
      cPirDiv     := cPirDiv( cDivRet, cDiv )
   end

RETURN ( if( lPic, Trans( nTotAlb, cPirDiv ), nTotAlb ) )



Static Function RecalculaTotal( aTmp )

   nTotAlbPrv( nil, dbfAlbPrvT, dbfTmp, dbfIva, dbfDiv, aTmp )

   oBrwIva:Refresh()

   oGetNet:SetText( Trans( nTotNet, cPirDiv ) )

   oGetIva:SetText( Trans( nTotIva, cPirDiv ) )

   oGetReq:SetText( Trans( nTotReq, cPirDiv ) )

   oGetTot:SetText( Trans( nTotAlb, cPirDiv ) )

Return .T.




FUNCTION aTotAlbPrv( cAlbaran, dbfAlbPrvT, dbfAlbPrvL, dbfIva, dbfDiv, cDivRet )

   nTotAlbPrv( cAlbaran, dbfAlbPrvT, dbfAlbPrvL, dbfIva, dbfDiv, nil, cDivRet, .F. )

RETURN ( { nTotNet, nTotIva, nTotReq, nTotAlb, aTotIva } )



Static Function GetArtPrv( cRefPrv, cCodPrv, aGet )

   local nOrdAnt  := ( dbfArtPrv )->( ordSetFocus( "cRefPrv" ) )

   if Empty( cRefPrv )

      return .T.

   else

      if ( dbfArtPrv )->( dbSeek( cCodPrv + cRefPrv ) )

         aGet[ 4 ]:cText( ( dbfArtPrv )->cCodArt )
            aGet[ 4 ]:lValid()

      else

         msgStop( "Referencia de proveedor no encontrada" )

      end

        ( dbfArtPrv )->( ordSetFocus( nOrdAnt ) )

   end

Return .T.



Static Function LoaArt( aGet, aTmp, aTmpAlb, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oGetIra, oDlg, oSayLote, oGetStk, oBeneficioSobre, oTotal, nMode )

   local nIva
   local nOrdAnt
   local cCodFam
   local nPreCos
   local cCodPrv
   local cCodArt
   local cPrpArt
   local nPreCom
   local lChgCodArt
   local lSeek       := .F.

   nIva              := 0
   nPreCom           := 0
   cCodPrv           := aTmpAlb[ 6 ]
   cCodArt           := aGet[ 4    ]:varGet()
   cPrpArt           := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]
   lChgCodArt        := ( Rtrim( cOldCodArt ) <> Rtrim( cCodArt ) .OR. Rtrim( cOldPrpArt ) <> Rtrim( cPrpArt ) )

   if Empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir lineas sin codificar" )
         return .F.
      end

      aGet[ 7    ]:bWhen  := {|| .T. }

      aGet[ 6]:Hide()

      aGet[ 14 ]:Show()
      aGet[ 14 ]:SetFocus()

      if !Empty( oBrwPrp )
         oBrwPrp:Hide()
      end

   else

      if lModIva()
         aGet[ 7 ]:bWhen  := {|| .T. }
      else
         aGet[ 7 ]:bWhen  := {|| .F. }
      end

      aGet[ 4     ]:show()
      aGet[ 6 ]:show()
      aGet[ 14  ]:Hide()

      if !( ( dbfArticulo )->( dbSeek( cCodArt ) ) .OR. ( dbfArticulo )->( dbSeek( Upper( cCodArt ) ) ) )





         nOrdAnt                 := ( dbfArtPrv )->( OrdSetFocus( "cRefPrv" ) )

         if ( dbfArtPrv )->( dbSeek( cCodPrv + cCodArt ) )

            cCodArt              := ( dbfArtPrv )->cCodArt

         end

         ( dbfArtPrv )->( ordSetFocus( nOrdAnt ) )





         cCodArt                 := cSeekCodebar( cCodArt, dbfCodebar, dbfArticulo )





         lSeek                   := ( dbfArticulo )->( dbSeek( cCodArt ) ) .OR. ( dbfArticulo )->( dbSeek( Upper( cCodArt ) ) )

      else

         lSeek                   := .T.

      end



      if lSeek

         if ( lChgCodArt )

            EliminarNumeroSerie( aTmp )

            if ( dbfArticulo )->lObs
               MsgStop( "Artículo catalogado como obsoleto" )
               return .F.
            end

            oFld:aEnable      := { .T., .T., .T. }
            oFld:Refresh()





            nIva              := nIva( dbfIva, ( dbfArticulo )->TipoIva )

            aGet[ 7    ]:cText( nIva )
            aGet[ 49 ]:cText( nIva )
            aGet[ 50 ]:Click( ( dbfArticulo )->lIvaInc ):Refresh()

            aTmp[ 92    ]  := nReq( dbfIva, ( dbfArticulo )->TipoIva )

            aGet[ 4    ]:cText( ( dbfArticulo )->Codigo )
            aGet[ 6]:cText( ( dbfArticulo )->Nombre )

            if ( dbfArticulo )->lMosCom .AND. !Empty( ( dbfArticulo )->mComent )
               MsgStop( Trim( ( dbfArticulo )->mComent ) )
            end

            if ( dbfArticulo )->nCajEnt <> 0
               aGet[ 9 ]:cText( ( dbfArticulo )->nCajEnt )
            end

            if ( dbfArticulo )->nUniCaja <> 0
               aGet[ 8 ]:cText( ( dbfArticulo )->nUniCaja )
            end






            aTmp[ 60 ]       := ( dbfArticulo )->lLote

            if ( dbfArticulo )->lLote
               oSayLote:Show()
               aGet[ 62   ]:Show()
               aGet[ 62   ]:cText( ( dbfArticulo )->cLote )
               aGet[ 101 ]:Show()
               aGet[ 101 ]:cText( dFechaCaducidad( aTmpAlb[ 5 ], ( dbfArticulo )->nDuracion, ( dbfArticulo )->nTipDur ) )
            else
               oSayLote:Hide()
               aGet[ 62   ]:Hide()
               aGet[ 101 ]:Hide()
            end






            aTmp[ 106 ]     := ( dbfArticulo )->lNumSer
            aTmp[ 107 ]     := ( dbfArticulo )->lAutSer





            cCodFam              := ( dbfArticulo )->Familia
            if !Empty( cCodFam )
               aTmp[ 90 ]  := cCodFam
               aTmp[ 91 ]  := cGruFam( cCodFam, dbfFamilia )
            end





            aTmp[ 59 ]     := ( dbfArticulo )->nCtlStock





            if ( dbfArticulo )->lKitArt

               aTmp[ 65 ]     := ( dbfArticulo )->lKitArt
               aTmp[ 68 ]     := lImprimirCompuesto( ( dbfArticulo )->Codigo, dbfArticulo )
               aTmp[ 67 ]     := lPreciosCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )

               if lStockCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )
                  aTmp[ 59 ]  := ( dbfArticulo )->nCtlStock
               else
                  aTmp[ 59 ]  := 3
               end

            else

               aTmp[ 68 ]     := .F.
               aTmp[ 59 ]     := ( dbfArticulo )->nCtlStock

            end





            nOrdAnt                 := ( dbfArtPrv )->( OrdSetFocus( "cCodPrv" ) )

            if ( dbfArtPrv )->( dbSeek( cCodPrv + cCodArt ) )

               if !Empty( aGet[ 5 ] )
                  aGet[ 5 ]:cText( ( dbfArtPrv )->cRefPrv )
               end

            else

               if !Empty( aGet[ 5 ] )
                  aGet[ 5 ]:cText( Space( 20 ) )
               end

            end

            ( dbfArtPrv )->( ordSetFocus( nOrdAnt ) )





            aTmp[52 ]         := ( dbfArticulo )->cCodPrp1
            aTmp[53 ]         := ( dbfArticulo )->cCodPrp2


            if ( !Empty( aTmp[ 52 ] ) .OR. !Empty( aTmp[ 53 ] ) ) .AND.  ( uFieldEmpresa( "lUseTbl" ) .AND. ( nMode == 1 ) )

               nPreCom              := nCosto( nil, dbfArticulo, dbfKit, .F., aTmpAlb[ 32 ], dbfDiv )

               LoadPropertiesTable( cCodArt, nPreCom, aTmp[ 52 ], aTmp[ 53 ], dbfPro, dbfTblPro, dbfArtCom, oBrwPrp, aGet[ 8 ], aGet[ 10 ]  )

               oGetIra:Show()

            else

               oBrwPrp:Hide()
               oGetIra:Hide()

               if !Empty( aTmp[ 52 ] )

                  if aGet[ 54 ] <> nil
                     aGet[ 54 ]:Show()
                     aGet[ 54 ]:SetFocus()
                  end

                  if oSayPr1 <> nil
                     oSayPr1:SetText( retProp( ( dbfArticulo )->cCodPrp1, dbfPro ) )
                     oSayPr1:Show()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:Show()
                  end

               else

                  if aGet[ 54 ] <>  nil
                     aGet[ 54 ]:Hide()
                  end

                  if oSayPr1 <> nil
                     oSayPr1:Hide()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:Hide()
                  end

               end

               if !Empty( aTmp[ 53 ] )

                  if aGet[ 55 ] <> nil
                     aGet[ 55 ]:Show()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:SetText( retProp( ( dbfArticulo )->cCodPrp2, dbfPro ) )
                     oSayPr2:Show()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:Show()
                  end

               else

                  if aGet[ 55 ] <> nil
                     aGet[ 55 ]:Hide()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:Hide()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:Hide()
                  end

               end

            end





            if oGetStk <> nil .AND. aTmp[ 59 ] <= 1
               oStock:nPutStockActual( cCodArt, aTmpAlb[ 7 ], nil, nil, nil, aTmp[ 65 ], aTmp[ 59 ], oGetStk )
            end





            if !Empty( aGet[ 13 ] )
               aGet[ 13 ]:cText( ( dbfArticulo )->cUnidad )
               aGet[ 13 ]:lValid()
            else
               aTmp[ 13 ]  := ( dbfArticulo )->cUnidad
            end

            ValidaMedicion( aTmp, aGet )

         end

         cPrpArt                 := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]

         if ( lChgCodArt ) .OR. ( cPrpArt <> cOldPrpArt )

            nPreCom              := nComPro( aTmp[ 4 ], aTmp[ 52 ], aTmp[ 54 ], aTmp[ 53 ], aTmp[ 55 ], dbfArtCom )

            if nPrecom  <> 0

               aGet[ 10 ]:cText( nPreCom )

            else

               if uFieldEmpresa( "lCosPrv" )
                  nPreCom        := nPreArtPrv( cCodPrv, cCodArt, dbfArtPrv )
               end

               if nPreCom <> 0
                  aGet[ 10 ]:cText( nPreCom )
               else
                  aGet[ 10 ]:cText( nCosto( nil, dbfArticulo, dbfKit, .F., aTmpAlb[ 32 ], dbfDiv ) )
               end





               if uFieldEmpresa( "lCosPrv", .F. )

                  nPreCom           := nDtoArtPrv( cCodPrv, cCodArt, dbfArtPrv )

                  if nPreCom <> 0
                     aGet[ 15 ]:cText( nPreCom )
                  end





                  nPreCom           := nPrmArtPrv( cCodPrv, cCodArt, dbfArtPrv )

                  if nPreCom <> 0
                     aGet[ 16 ]:cText( nPreCom )
                  end

               end

            end





            if aGet[ 18 ] <> nil
               aGet[ 18 ]:cText( nNetUAlbPrv( aTmp, aTmpAlb, nDinDiv, nDirDiv, aTmpAlb[ 33 ] ) )
            end





            aTmp[ 95 ]        := nCnv2Div( ( dbfArticulo )->PvpRec, cDivEmp(), aTmpAlb[ 32 ], dbfDiv )





            aGet[ 25 ]:cText( ( dbfArticulo )->Benef1 )
            aGet[ 26 ]:cText( ( dbfArticulo )->Benef2 )
            aGet[ 27 ]:cText( ( dbfArticulo )->Benef3 )
            aGet[ 28 ]:cText( ( dbfArticulo )->Benef4 )
            aGet[ 29 ]:cText( ( dbfArticulo )->Benef5 )
            aGet[ 30 ]:cText( ( dbfArticulo )->Benef6 )

            aGet[ 19 ]:Click( ( dbfArticulo )->lBnf1 ):Refresh()
            aGet[ 20 ]:Click( ( dbfArticulo )->lBnf2 ):Refresh()
            aGet[ 21 ]:Click( ( dbfArticulo )->lBnf3 ):Refresh()
            aGet[ 22 ]:Click( ( dbfArticulo )->lBnf4 ):Refresh()
            aGet[ 23 ]:Click( ( dbfArticulo )->lBnf5 ):Refresh()
            aGet[ 24 ]:Click( ( dbfArticulo )->lBnf6 ):Refresh()

            aGet[ 37 ]:cText( ( dbfarticulo )->pVenta1  )
            aGet[ 38 ]:cText( ( dbfArticulo )->pVenta2  )
            aGet[ 39 ]:cText( ( dbfArticulo )->pVenta3  )
            aGet[ 40 ]:cText( ( dbfArticulo )->pVenta4  )
            aGet[ 41 ]:cText( ( dbfArticulo )->pVenta5  )
            aGet[ 42 ]:cText( ( dbfArticulo )->pVenta6  )

            aGet[ 43 ]:cText( ( dbfArticulo )->pVtaIva1 )
            aGet[ 44 ]:cText( ( dbfArticulo )->pVtaIva2 )
            aGet[ 45 ]:cText( ( dbfArticulo )->pVtaIva3 )
            aGet[ 46 ]:cText( ( dbfArticulo )->pVtaIva4 )
            aGet[ 47 ]:cText( ( dbfArticulo )->pVtaIva5 )
            aGet[ 48 ]:cText( ( dbfArticulo )->pVtaIva6 )

            oBeneficioSobre[ 1 ]:Select( Max( ( dbfArticulo )->nBnfSbr1, 1 ) )
            oBeneficioSobre[ 2 ]:Select( Max( ( dbfArticulo )->nBnfSbr2, 1 ) )
            oBeneficioSobre[ 3 ]:Select( Max( ( dbfArticulo )->nBnfSbr3, 1 ) )
            oBeneficioSobre[ 4 ]:Select( Max( ( dbfArticulo )->nBnfSbr4, 1 ) )
            oBeneficioSobre[ 5 ]:Select( Max( ( dbfArticulo )->nBnfSbr5, 1 ) )
            oBeneficioSobre[ 6 ]:Select( Max( ( dbfArticulo )->nBnfSbr6, 1 ) )





            nPreCos  := nCnv2Div( ( dbfArticulo )->pCosto, cDivEmp(), aTmpAlb[ 32 ], dbfDiv )


















         end





         lCalcDeta( aTmp, aTmpAlb, aGet, oTotal )

      else

         msgStop( "Artículo no encontrado" )
         Return .F.

      end

   end

   cOldCodArt        := cCodArt
   cOldPrpArt        := cPrpArt

Return .T.



Static Function cPedPrv( aGet, aTmp, oBrw, nMode )

   local nDiv
   local cOldEst
   local cPedCli
   local nTotPed     := 0
   local nTotRec     := 0
   local nTotPdt     := 0
   local lValid      := .F.
   local cPedido     := aGet[ 29 ]:varGet()
   local nAlbaran    := aGet[ 2 ]:varGet()

   if ( nMode <> 1 ) .OR. Empty( cPedido )
      Return .T.
   end

   if ( dbfPedPrvT )->( dbSeek( cPedido ) )

      if ( dbfPedPrvT )->nEstado == 3

         MsgStop( "Pedido recibido", "Opción cancelada" )
         lValid      := .F.

      else





         cOldEst  := ( dbfPedPrvT )->nEstado

         aGet[ 29 ]:cText( ( dbfPedPrvT )->cSerPed + Str( ( dbfPedPrvT )->nNumPed ) + ( dbfPedPrvT )->cSufPed )
         aGet[ 29 ]:bWhen := {|| .F. }

         aGet[ 6 ]:cText( ( dbfPedPrvT )->cCodPrv )
         aGet[ 6 ]:lValid()

         aGet[ 8 ]:cText( ( dbfPedPrvT )->cCodCaj )
         aGet[ 8 ]:lValid()

         aGet[ 7 ]:cText( ( dbfPedPrvT )->cCodAlm )
         aGet[ 7 ]:lValid()

         aGet[ 25]:Click( ( dbfPedPrvT )->lRecargo )

         aGet[ 18 ]:cText( ( dbfPedPrvT )->cCodPgo )
         aGet[ 18 ]:lValid()

         aGet[ 21 ]:cText( ( dbfPedPrvT )->cDtoEsp )
         aGet[ 22 ]:cText( ( dbfPedPrvT )->nDtoEsp )

         aGet[ 23    ]:cText( ( dbfPedPrvT )->cDpp )
         aGet[ 24    ]:cText( ( dbfPedPrvT )->nDpp )

         aGet[ 35 ]:cText( ( dbfPedPrvT )->cDtoUno )
         aGet[ 36 ]:cText( ( dbfPedPrvT )->nDtoUno )

         aGet[ 37 ]:cText( ( dbfPedPrvT )->cDtoDos )
         aGet[ 38 ]:cText( ( dbfPedPrvT )->nDtoDos )

         aGet[ 56 ]:nOption( Max( ( dbfPrv )->nRegIva, 1 ) )
         aGet[ 56 ]:Refresh()

         aGet[ 28 ]:cText( ( dbfPedPrvT )->cObserv )

         cPedCli           := ( dbfPedPrvT )->cNumPedCli





         if ( dbfPedPrvL )->( dbSeek( cPedido ) )

            while ( ( dbfPedPrvL )->cSerPed + Str( ( dbfPedPrvL )->nNumPed ) + ( dbfPedPrvL )->cSufPed == cPedido )





               nTotPed                 := NotCaja( ( dbfPedPrvL )->nCanPed ) * ( dbfPedPrvL )->nUniCaja
               nTotRec                 := nUnidadesRecibidasPedPrv( ( dbfPedPrvL )->cSerPed + Str( ( dbfPedPrvL )->nNumPed ) + ( dbfPedPrvL )->cSufPed, ( dbfPedPrvL )->cRef, ( dbfPedPrvL )->cValPr1, ( dbfPedPrvL )->cValPr2, ( dbfPedPrvL )->cRefPrv, ( dbfPedPrvL )->cDetalle, dbfAlbPrvL )
               nTotPdt                 := nTotPed - nTotRec





               if Abs( nTotPdt ) > 0

                  (dbfTmp)->( dbAppend() )

                  (dbfTmp)->nNumAlb    := nAlbaran
                  (dbfTmp)->cRef       := (dbfPedPrvL)->cRef
                  (dbfTmp)->nIva       := (dbfPedPrvL)->nIva
                  (dbfTmp)->nIvaLin    := (dbfPedPrvL)->nIva
                  (dbfTmp)->nReq       := (dbfPedPrvL)->nReq
                  (dbfTmp)->cDetalle   := (dbfPedPrvL)->cDetalle
                  (dbfTmp)->mLngDes    := (dbfPedPrvL)->mLngDes
                  (dbfTmp)->mNumSer    := (dbfPedPrvL)->mNumSer
                  (dbfTmp)->nPreDiv    := (dbfPedPrvL)->nPreDiv
                  (dbfTmp)->nPreCom    := (dbfPedPrvL)->nPreDiv
                  (dbfTmp)->nCanPed    := (dbfPedPrvL)->nCanPed
                  (dbfTmp)->nUniPed    := (dbfPedPrvL)->nUniCaja
                  (dbfTmp)->cCodPr1    := (dbfPedPrvL)->cCodPr1
                  (dbfTmp)->cCodPr2    := (dbfPedPrvL)->cCodPr2
                  (dbfTmp)->cValPr1    := (dbfPedPrvL)->cValPr1
                  (dbfTmp)->cValPr2    := (dbfPedPrvL)->cValPr2
                  (dbfTmp)->nFacCnv    := (dbfPedPrvL)->nFacCnv
                  (dbfTmp)->cAlmLin    := (dbfPedPrvL)->cAlmLin
                  (dbfTmp)->nCtlStk    := (dbfPedPrvL)->nCtlStk
                  (dbfTmp)->nNumLin    := (dbfPedPrvL)->nNumLin
                  (dbfTmp)->nUndKit    := (dbfPedPrvL)->nUndKit
                  (dbfTmp)->lKitChl    := (dbfPedPrvL)->lKitChl
                  (dbfTmp)->lKitArt    := (dbfPedPrvL)->lKitArt
                  (dbfTmp)->lKitPrc    := (dbfPedPrvL)->lKitPrc
                  (dbfTmp)->nDtoLin    := (dbfPedPrvL)->nDtoLin
                  (dbfTmp)->nDtoPrm    := (dbfPedPrvL)->nDtoPrm
                  (dbfTmp)->nDtoRap    := (dbfPedPrvL)->nDtoRap
                  (dbfTmp)->lImpLin    := (dbfPedPrvL)->lImpLin
                  (dbfTmp)->lLote      := (dbfPedPrvL)->lLote
                  (dbfTmp)->nLote      := (dbfPedPrvL)->nLote
                  (dbfTmp)->cLote      := (dbfPedPrvL)->cLote
                  (dbfTmp)->mObsLin    := (dbfPedPrvL)->mObsLin
                  (dbfTmp)->cRefPrv    := (dbfPedPrvL)->cRefPrv
                  (dbfTmp)->cUnidad    := (dbfPedPrvL)->cUnidad
                  (dbfTmp)->nNumMed    := (dbfPedPrvL)->nNumMed
                  (dbfTmp)->nMedUno    := (dbfPedPrvL)->nMedUno
                  (dbfTmp)->nMedDos    := (dbfPedPrvL)->nMedDos
                  (dbfTmp)->nMedTre    := (dbfPedPrvL)->nMedTre
                  (dbfTmp)->cCodPed    := cPedido
                  (dbfTmp)->cNumPed    := cPedCli





                  if lCalCaj()

                     if nTotRec <> 0

                        nDiv  := Mod( nTotPdt, ( dbfPedPrvL )->nUniCaja )
                        if nDiv == 0 .AND. ( dbfPedPrvL )->nCanPed <> 0
                           ( dbfTmp )->nCanEnt  := Div( nTotPdt, ( dbfPedPrvL )->nUniCaja )
                           ( dbfTmp )->nUniCaja := ( dbfPedPrvL )->nUniCaja
                        else
                           ( dbfTmp )->nCanEnt  := 0
                           ( dbfTmp )->nUniCaja := nTotPdt
                        end

                     else

                        ( dbfTmp )->nCanEnt     := ( dbfPedPrvL )->nCanPed
                        ( dbfTmp )->nUniCaja    := ( dbfPedPrvL )->nUniCaja

                     end

                  else

                     ( dbfTmp )->nUniCaja       := nTotPdt

                  end





                  if ( dbfArticulo )->( dbSeek( ( dbfPedPrvL )->cRef ) )

                     ( dbfTmp )->lIvaLin  := ( dbfArticulo )->lIvaInc

                     ( dbfTmp )->nBnfLin1 := ( dbfArticulo )->Benef1
                     ( dbfTmp )->nBnfLin2 := ( dbfArticulo )->Benef2
                     ( dbfTmp )->nBnfLin3 := ( dbfArticulo )->Benef3
                     ( dbfTmp )->nBnfLin4 := ( dbfArticulo )->Benef4
                     ( dbfTmp )->nBnfLin5 := ( dbfArticulo )->Benef5
                     ( dbfTmp )->nBnfLin6 := ( dbfArticulo )->Benef6

                     ( dbfTmp )->lBnfLin1 := ( dbfArticulo )->lBnf1
                     ( dbfTmp )->lBnfLin2 := ( dbfArticulo )->lBnf2
                     ( dbfTmp )->lBnfLin3 := ( dbfArticulo )->lBnf3
                     ( dbfTmp )->lBnfLin4 := ( dbfArticulo )->lBnf4
                     ( dbfTmp )->lBnfLin5 := ( dbfArticulo )->lBnf5
                     ( dbfTmp )->lBnfLin6 := ( dbfArticulo )->lBnf6

                     ( dbfTmp )->nBnfSbr1 := ( dbfArticulo )->nBnfSbr1
                     ( dbfTmp )->nBnfSbr2 := ( dbfArticulo )->nBnfSbr2
                     ( dbfTmp )->nBnfSbr3 := ( dbfArticulo )->nBnfSbr3
                     ( dbfTmp )->nBnfSbr4 := ( dbfArticulo )->nBnfSbr4
                     ( dbfTmp )->nBnfSbr5 := ( dbfArticulo )->nBnfSbr5
                     ( dbfTmp )->nBnfSbr6 := ( dbfArticulo )->nBnfSbr6

                     ( dbfTmp )->nPvpLin1 := ( dbfarticulo )->pVenta1
                     ( dbfTmp )->nPvpLin2 := ( dbfArticulo )->pVenta2
                     ( dbfTmp )->nPvpLin3 := ( dbfArticulo )->pVenta3
                     ( dbfTmp )->nPvpLin4 := ( dbfArticulo )->pVenta4
                     ( dbfTmp )->nPvpLin5 := ( dbfArticulo )->pVenta5
                     ( dbfTmp )->nPvpLin6 := ( dbfArticulo )->pVenta6

                     ( dbfTmp )->nIvaLin1 := ( dbfArticulo )->pVtaIva1
                     ( dbfTmp )->nIvaLin2 := ( dbfArticulo )->pVtaIva2
                     ( dbfTmp )->nIvaLin3 := ( dbfArticulo )->pVtaIva3
                     ( dbfTmp )->nIvaLin4 := ( dbfArticulo )->pVtaIva4
                     ( dbfTmp )->nIvaLin5 := ( dbfArticulo )->pVtaIva5
                     ( dbfTmp )->nIvaLin6 := ( dbfArticulo )->pVtaIva6

                  end

                  if lActCos()
                     ( dbfTmp )->lChgLin     := .T.
                  end

               end

               ( dbfPedPrvL )->( dbSkip() )

            end

            ( dbfTmp )->( dbGoTop() )

            oBrw:Refresh()

         end



















         aGet[ 29 ]:bWhen     := {|| .F. }
         aGet[ 29 ]:bValid    := {|| .T. }
         lValid                     := .T.

      end

   else

      msgStop( "Pedido no existe" )

   end





   nTotAlbPrv( nil, dbfAlbPrvT, dbfTmp, dbfIva, dbfDiv, aTmp )

Return lValid







Static Function lCalcDeta( aTmp, aTmpAlb, aGet, oTotal )

   oTotal:cText( nTotLAlbPrv( aTmp, nDinDiv, nDirDiv ) )





   aGet[ 18 ]:cText( nNetUAlbPrv( aTmp, aTmpAlb, nDinDiv, nDirDiv ) )

   if aTmp[ 19 ]
         aGet[ 25 ]:lValid()
   else
      if aTmp[ 50 ]
         aGet[ 43 ]:lValid()
      else
         aGet[ 37 ]:lValid()
      end
   end

   if aTmp[ 20 ]
         aGet[ 26 ]:lValid()
   else
      if aTmp[ 50 ]
         aGet[ 44 ]:lValid()
      else
         aGet[ 38 ]:lValid()
      end
   end

   if aTmp[ 21 ]
         aGet[ 27 ]:lValid()
   else
      if aTmp[ 50 ]
         aGet[ 45 ]:lValid()
      else
         aGet[ 39 ]:lValid()
      end
   end

   if aTmp[ 22 ]
         aGet[ 28 ]:lValid()
   else
      if aTmp[ 50 ]
         aGet[ 46 ]:lValid()
      else
         aGet[ 40 ]:lValid()
      end
   end

   if aTmp[ 23 ]
         aGet[ 29 ]:lValid()
   else
      if aTmp[ 50 ]
         aGet[ 47 ]:lValid()
      else
         aGet[ 41 ]:lValid()
      end
   end

   if aTmp[ 24 ]
         aGet[ 30 ]:lValid()
   else
      if aTmp[ 50 ]
         aGet[ 48 ]:lValid()
      else
         aGet[ 42 ]:lValid()
      end
   end

   if lActCos()

      if aTmp[ 10 ] <> 0
         aGet[ 51 ]:Click( .T. ):Refresh()
      else
         aGet[ 51 ]:Click( .F. ):Refresh()
      end

   end

Return .T.




FUNCTION nTotUAlbPrv( uAlbPrvL, nDec, nVdv, cPinDiv )

    local nCalculo

   IIF( uAlbPrvL == nil, uAlbPrvL := if( !Empty( tmpAlbPrvL ), tmpAlbPrvL, dbfAlbPrvL ), ) ;
   IIF( nDec == nil, nDec := nDinDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   do case
      case ValType( uAlbPrvL ) == "A"
         nCalculo    := uAlbPrvL[ 10 ]

      case ValType( uAlbPrvL ) == "C"
         nCalculo    := ( uAlbPrvL )->nPreDiv

      case ValType( uAlbPrvL ) == "O"
         nCalculo    := uAlbPrvL:nPreDiv

   end

   nCalculo          := Round( nCalculo / nVdv, nDec )

RETURN ( ( if( cPinDiv <> nil, Trans( nCalculo, cPinDiv ), nCalculo ) )  )



FUNCTION nNetUAlbPrv( uAlbPrvL, uAlbPrvT, nDec, nRec, nVdv, cPinDiv )

   local nDtoEsp
    local nDtoPP
   local nDtoUno
    local nDtoDos
   local nCalculo
   local nDtoLin
   local nDtoPrm
   local nPorte

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRec == nil, nRec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUAlbPrv( uAlbPrvL, nDec, nVdv )

   if ValType( uAlbPrvL ) == "A"
      nDtoLin     := uAlbPrvL[ 15 ]
      nDtoPrm     := uAlbPrvL[ 16 ]
   else
      nDtoLin     := ( uAlbPrvL )->nDtoLin
      nDtoPrm     := ( uAlbPrvL )->nDtoPrm
   end

   if nDtoLin <> 0
      nCalculo    -= nCalculo * nDtoLin / 100
   end

   if nDtoPrm <> 0
      nCalculo    -= nCalculo * nDtoPrm / 100
   end





   if ValType( uAlbPrvT ) == "A"
      nDtoEsp     := uAlbPrvT[ 22 ]
      nDtoPP      := uAlbPrvT[ 24    ]
      nDtoUno     := uAlbPrvT[ 36 ]
      nDtoDos     := uAlbPrvT[ 38 ]
      nPorte      := uAlbPrvT[ 20 ]
   else
      nDtoEsp     := (uAlbPrvT)->nDtoEsp
      nDtoPP      := (uAlbPrvT)->nDpp
      nDtoUno     := (uAlbPrvT)->nDtoUno
      nDtoDos     := (uAlbPrvT)->nDtoDos
      nPorte      := (uAlbPrvT)->nPorTes
   end

   if nDtoEsp <> 0
      nCalculo    -= Round( nCalculo * nDtoEsp / 100, nDec )
   end

   if nDtoPP <> 0
      nCalculo    -= Round( nCalculo * nDtoPP  / 100, nDec )
   end

   if nDtoUno <> 0
      nCalculo    -= Round( nCalculo * nDtoUno / 100, nDec )
   end

   if nDtoDos <> 0
      nCalculo    -= Round( nCalculo * nDtoDos / 100, nDec )
   end

   nCalculo       := Round( nCalculo, nDec )

RETURN ( if( cPinDiv <> NIL, Trans( nCalculo, cPinDiv ), nCalculo ) )




FUNCTION nTotLAlbPrv( uAlbPrvL, nDec, nRec, nVdv, cPirDiv )

   local nCalculo
   local nDtoLin
   local nDtoPrm
   local nTotDto     := 0

   IIF( uAlbPrvL == nil, uAlbPrvL := if( !Empty( tmpAlbPrvL ), tmpAlbPrvL, dbfAlbPrvL ), ) ;
   IIF( nDec == nil, nDec := nDinDiv(), ) ;
   IIF( nRec == nil, nRec := nRinDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;





   nCalculo          := nTotNAlbPrv( uAlbPrvL )

   do case
      case ValType( uAlbPrvL ) == "A"
         nDtoLin     := uAlbPrvL[ 15 ]
         nDtoPrm     := uAlbPrvL[ 16 ]

      case ValType( uAlbPrvL ) == "C"
         nDtoLin     := ( uAlbPrvL )->nDtoLin
         nDtoPrm     := ( uAlbPrvL )->nDtoPrm

      case ValType( uAlbPrvL ) == "O"
         nDtoLin     := uAlbPrvL:nDtoLin
         nDtoPrm     := uAlbPrvL:nDtoPrm

   end

   if nDtoLin <> 0
      nCalculo       -= nCalculo * nDtoLin / 100
   end

   if nDtoPrm <> 0
      nCalculo       -= nCalculo * nDtoPrm / 100
   end

   nCalculo          -= nTotDto

   nCalculo          *= nTotUAlbPrv( uAlbPrvL, nDec, nVdv )

   if nRec <> nil
      nCalculo       := Round( nCalculo, nRec )
   end

RETURN ( if( cPirDiv <> nil, Trans( nCalculo, cPirDiv ), nCalculo ) )






FUNCTION nImpUAlbPrv( uAlbPrvT, uAlbPrvL, nDec, nVdv, lIva, cPouDiv )

   local nCalculo

   IIF( uAlbPrvT == nil, uAlbPrvT := dbfAlbPrvT, ) ;
   IIF( uAlbPrvL == nil, uAlbPrvL := if( !Empty( tmpAlbPrvL ), tmpAlbPrvL, dbfAlbPrvL ), ) ;
   IIF( nDec == nil, nDec := nDinDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lIva == nil, lIva := .F., ) ;

   nCalculo          := nTotUAlbPrv( uAlbPrvL, nDec, nVdv )

   if ValType( uAlbPrvT ) == "A"
      nCalculo       -= Round( nCalculo * uAlbPrvT[ 22 ]  / 100, nDec )
      nCalculo       -= Round( nCalculo * uAlbPrvT[ 24    ]  / 100, nDec )
      nCalculo       -= Round( nCalculo * uAlbPrvT[ 36 ]  / 100, nDec )
      nCalculo       -= Round( nCalculo * uAlbPrvT[ 38 ]  / 100, nDec )
   else
      nCalculo       -= Round( nCalculo * ( uAlbPrvT )->nDtoEsp / 100, nDec )
      nCalculo       -= Round( nCalculo * ( uAlbPrvT )->nDpp    / 100, nDec )
      nCalculo       -= Round( nCalculo * ( uAlbPrvT )->nDtoUno / 100, nDec )
      nCalculo       -= Round( nCalculo * ( uAlbPrvT )->nDtoDos / 100, nDec )
   end

   if lIva .AND. ( uAlbPrvL )->nIva <> 0
      nCalculo       += nCalculo * ( uAlbPrvL )->nIva / 100
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )






FUNCTION nImpLAlbPrv( uAlbPrvT, uAlbPrvL, nDec, nRou, nVdv, lIva, cPouDiv )

   local nCalculo

   IIF( uAlbPrvT == nil, uAlbPrvT := dbfAlbPrvT, ) ;
   IIF( uAlbPrvL == nil, uAlbPrvL := if( !Empty( tmpAlbPrvL ), tmpAlbPrvL, dbfAlbPrvL ), ) ;
   IIF( nDec == nil, nDec := nDinDiv(), ) ;
   IIF( nRou == nil, nRou := nRinDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lIva == nil, lIva := .F., ) ;

   nCalculo          := nTotLAlbPrv( uAlbPrvL, nDec, nRou, nVdv )

   if ValType( uAlbPrvT ) == "A"
      nCalculo       -= Round( nCalculo * uAlbPrvT[ 22 ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uAlbPrvT[ 24    ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uAlbPrvT[ 36 ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uAlbPrvT[ 38 ]  / 100, nRou )
   else
      nCalculo       -= Round( nCalculo * ( uAlbPrvT )->nDtoEsp / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uAlbPrvT )->nDpp    / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uAlbPrvT )->nDtoUno / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uAlbPrvT )->nDtoDos / 100, nRou )
   end

   if lIva .AND. ( uAlbPrvL )->nIva <> 0
      nCalculo       += nCalculo * ( uAlbPrvL )->nIva / 100
   end

RETURN ( if( cPouDiv <> NIL, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION BrwAlbPrv( oGetNum, dbfAlbPrvT, dbfAlbPrvL, dbfIva, dbfDiv )

    local oDlg
    local oBrw
   local oGet1
   local cGet1
   local nOrd     := GetBrwOpt( "BrwAlbPrv" )
    local oCbxOrd
   local aCbxOrd  := { "N. albarán", "Fecha", "Cod. proveedor", "Nom. proveedor" }
   local cCbxOrd

   local aBmp     := {  LoadBitmap( GetResources(), "BGREEN" ), LoadBitmap( GetResources(), "BRED" ) }

   nOrd           := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd        := aCbxOrd[ nOrd ]
   nOrd           := ( dbfAlbPrvT )->( OrdSetFocus( nOrd ) )

   ( dbfAlbPrvT )->( dbSetFilter( {|| !Field->lFacturado }, "!lFacturado" ) )
   ( dbfAlbPrvT )->( dbGoTop() )

   oDlg = TDialog():New(,,,, "Albaranes de proveedores", "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F., )






        oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, dbfAlbPrvT ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, dbfAlbPrvT ) ) }, .F., .F.,,,,,, nil, "FIND",, )






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( dbfAlbPrvT )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:refresh(), oGet1:SetFocus() )},,,, .F.,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := dbfAlbPrvT
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Albaran de proveedor.Browse"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Es. Estado"
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfAlbPrvT )->lFacturado }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Cnt16" } )
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "N. albarán"
         :cSortOrder       := "nNumAlb"
         :bEditValue       := {|| ( dbfAlbPrvT )->cSerAlb + "/" + AllTrim( Str( ( dbfAlbPrvT )->nNumAlb ) ) + "/" + ( dbfAlbPrvT )->cSufAlb }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecAlb"
         :bEditValue       := {|| dToc( ( dbfAlbPrvT )->dFecAlb ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Cod. proveedor"
         :cSortOrder       := "cCodPrv"
         :bEditValue       := {|| Rtrim( ( dbfAlbPrvT )->cCodPrv ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nom. proveedor"
         :cSortOrder       := "cNomPrv"
         :bEditValue       := {|| Rtrim( ( dbfAlbPrvT )->cNomPrv ) }
         :nWidth           := 200
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotAlbPrv( ( dbfAlbPrvT )->cSerAlb + Str( (dbfAlbPrvT)->nNumAlb ) + (dbfAlbPrvT)->cSufAlb, dbfAlbPrvT, dbfAlbPrvL, dbfIva, dbfDiv, nil, cDivEmp(), .T. ) }
         :nWidth           := 60
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end




        TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 500,, oDlg,,, .F., {||         .F.},,, .F. )




        TButton():ReDefine( 501,, oDlg,,, .F., {||         .F.},,, .F. )

   oDlg:AddFastKey( 13, {|| oDlg:end( 1 ) } )
   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

   oDlg:bStart    := {|| oBrw:Load() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1
      oGetNum:cText( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb )
      oGetNum:disable()
   end

   DestroyFastFilter( dbfAlbPrvT )

   SetBrwOpt( "BrwAlbPrv", ( dbfAlbPrvT )->( OrdNumber() ) )

   ( dbfAlbPrvT )->( dbSetFilter() )
   ( dbfAlbPrvT )->( OrdSetFocus( nOrd ) )

   aEval( aBmp, { | hBmp | DeleteObject( hBmp ) } )

   oBrw:CloseData()

RETURN ( oDlg:nResult == 1 )







FUNCTION mkAlbPrv( cPath, lAppend, cPathOld, oMeter, bFor, dbfMov )

   local oBlock
   local oError
   local dbfAlbPrvT
   local dbfAlbPrvL
   local dbfAlbPrvI
   local dbfAlbPrvD
   local oldAlbPrvT
   local oldAlbPrvL
   local oldAlbPrvI
   local oldAlbPrvD

   IIF( lAppend == nil, lAppend := .F., ) ;
   IIF( bFor == nil, bFor := {|| .T. }, ) ;

    IF oMeter <> NIL
      oMeter:cText   := "Generando bases"
        sysrefresh()
    end

   CreateFiles( cPath )
   rxAlbPrv( cPath, oMeter )

   IF lAppend .AND. lIsDir( cPathOld )

      oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

      dbUseArea( .T., cDriver(), cPath + "ALBPROVT.DBF", cCheckArea( "ALBPROVT", @dbfAlbPrvT ), .F. )
      ordListAdd( cPath + "ALBPROVT.CDX"  )

      dbUseArea( .T., cDriver(), cPath + "ALBPROVL.DBF", cCheckArea( "ALBPROVL", @dbfAlbPrvL ), .F. )
      ordListAdd( cPath + "ALBPROVL.CDX"  )

      dbUseArea( .T., cDriver(), cPath + "AlbPrvI.Dbf", cCheckArea( "AlbPrvI", @dbfAlbPrvI ), .F. )
      ( dbfAlbPrvI )->( ordListAdd( cPath + "AlbPrvI.Cdx"  ) )

      dbUseArea( .T., cDriver(), cPath + "AlbPrvD.Dbf", cCheckArea( "AlbPrvD", @dbfAlbPrvD ), .F. )
      ( dbfAlbPrvD )->( ordListAdd( cPath + "AlbPrvD.Cdx"  ) )

      dbUseArea( .T., cDriver(), cPathOld + "ALBPROVT.DBF", cCheckArea( "ALBPROVT", @oldAlbPrvT ), .F. )
      ordListAdd( cPathOld + "ALBPROVT.CDX"  )

      dbUseArea( .T., cDriver(), cPathOld + "ALBPROVL.DBF", cCheckArea( "ALBPROVL", @oldAlbPrvL ), .F. )
      ordListAdd( cPathOld + "ALBPROVL.CDX"  )

      dbUseArea( .T., cDriver(), cPathOld + "ALBPRVI.Dbf", cCheckArea( "ALBPRVI", @oldAlbPrvI ), .F. )
      ( oldAlbPrvI )->( ordListAdd( cPathOld + "ALBPRVI.Cdx"  ) )

      dbUseArea( .T., cDriver(), cPathOld + "ALBPRVD.Dbf", cCheckArea( "ALBPRVD", @oldAlbPrvD ), .F. )
      ( oldAlbPrvD )->( ordListAdd( cPathOld + "ALBPRVD.Cdx"  ) )

      while !( oldAlbPrvT )->( eof() )

         if eval( bFor, oldAlbPrvT )
            dbCopy( oldAlbPrvT, dbfAlbPrvT, .T. )

            if ( dbfAlbPrvT )->( Rlock() )
               ( dbfAlbPrvT )->cTurAlb    := "   1"
               ( dbfAlbPrvT )->( dbRUnlock() )
            end

            if ( oldAlbPrvL )->( dbSeek( (oldAlbPrvT)->cSerAlb + Str( (oldAlbPrvT)->nNumAlb ) + (oldAlbPrvT)->CSUFALB ) )

               while (oldAlbPrvT)->cSerAlb + Str( (oldAlbPrvL)->nNumAlb ) + (oldAlbPrvL)->CSUFALB == (oldAlbPrvT)->cSerAlb + Str( (dbfAlbPrvT)->nNumAlb ) + (dbfAlbPrvT)->CSUFALB .AND. !(oldAlbPrvL)->( eof() )

                  dbCopy( oldAlbPrvL, dbfAlbPrvL, .T. )





                  if dbfMov <> nil
                     putStock( ( dbfAlbPrvL )->cRef, ( dbfAlbPrvT )->cCodAlm, nCanEnt( dbfAlbprvL ) * - 1 , dbfMov, "EI" )
                  end

                  ( oldAlbPrvL )->( dbSkip() )

               end

            end

            if ( oldAlbPrvI )->( dbSeek( (oldAlbPrvT)->cSerAlb + Str( (oldAlbPrvT)->nNumAlb ) + (oldAlbPrvT)->CSUFALB ) )
               while ( oldAlbPrvI )->cSerAlb + Str( ( oldAlbPrvI )->nNumAlb ) + ( oldAlbPrvI )->cSufAlb == ( oldAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb .AND. !( oldAlbPrvI )->( eof() )
                  dbCopy( oldAlbPrvL, dbfAlbPrvL, .T. )
                  ( oldAlbPrvI )->( dbSkip() )
               end
            end

            if ( oldAlbPrvD )->( dbSeek( (oldAlbPrvT)->cSerAlb + Str( (oldAlbPrvT)->nNumAlb ) + (oldAlbPrvT)->CSUFALB ) )
               while ( oldAlbPrvD )->cSerAlb + Str( ( oldAlbPrvD )->nNumAlb ) + ( oldAlbPrvD )->cSufAlb == ( oldAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb .AND. !( oldAlbPrvI )->( eof() )
                  dbCopy( oldAlbPrvD, dbfAlbPrvD, .T. )
                  ( oldAlbPrvD )->( dbSkip() )
               end
            end

         end

         ( oldAlbPrvT )->( dbSkip() )

      end





      ( dbfAlbPrvT )->( dbEval( {|| ( dbfAlbPrvT )->cTurAlb := Space( 6 ) },,,,, .F. ) )





      ( dbfAlbPrvT )->( dbCloseArea() )
      ( dbfAlbPrvL )->( dbCloseArea() )
      ( dbfAlbPrvI )->( dbCloseArea() )
      ( dbfAlbPrvD )->( dbCloseArea() )

      ( oldAlbPrvT )->( dbCloseArea() )
      ( oldAlbPrvL )->( dbCloseArea() )
      ( oldAlbPrvI )->( dbCloseArea() )
      ( oldAlbPrvD )->( dbCloseArea() )

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos de agentes" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

    end

Return nil



FUNCTION rxAlbPrv( cPath, oMeter )

    local dbfAlbPrvT

   IIF( cPath == nil, cPath := cPatEmp(), ) ;





   if !lExistTable( cPath + "ALBPROVT.DBF" ) .OR.  !lExistTable( cPath + "ALBPROVL.DBF" ) .OR.  !lExistTable( cPath + "ALBPRVI.DBF" )  .OR.  !lExistTable( cPath + "ALBPRVD.DBF" )  .OR.  !lExistTable( cPath + "AlbPrvS.DBF" )
      CreateFiles( cPath )
   end





   fEraseIndex( cPath + "ALBPROVT.CDX" )
   fEraseIndex( cPath + "ALBPROVL.CDX" )
   fEraseIndex( cPath + "ALBPRVI.CDX" )
   fEraseIndex( cPath + "ALBPRVD.CDX" )
   fEraseIndex( cPath + "AlbPrvS.Cdx" )

   dbUseArea( .T., cDriver(), cPath + "ALBPROVT.DBF", cCheckArea( "ALBPROVT", @dbfAlbPrvT ), .F. )

   if !( dbfAlbPrvT )->( neterr() )
      ( dbfAlbPrvT)->( __dbPack() )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "ALBPROVT.CDX", "NNUMALB", "CSERALB + STR( NNUMALB ) + CSUFALB", {|| Field->cSerAlb + STR( Field->nNumAlb ) + Field->CSUFALB } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "ALBPROVT.CDX", "DFECALB", "DFECALB", {|| Field->DFECALB } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "ALBPROVT.CDX", "CCODPRV", "CCODPRV", {|| Field->CCODPRV } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "ALBPROVT.CDX", "CNOMPRV", "Upper( CNOMPRV )", {|| Upper( Field->CNOMPRV ) } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "ALBPROVT.CDX", "CSUALB", "CSUALB", {|| Field->CSUALB } ) )

      ( dbfAlbPrvT)->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "ALBPROVT.CDX", "CNUMFAC", "CNUMFAC", {|| Field->CNUMFAC }, ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "ALBPROVT.CDX", "CTURALB", "CTURALB + CSUFALB + cCodCaj", {|| Field->CTURALB + Field->CSUFALB + Field->cCodCaj } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "ALBPROVT.CDX", "CNUMPED", "CNUMPED", {|| Field->CNUMPED } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "AlbProvT.Cdx", "cCodUsr", "Field->cCodUsr + Dtos( Field->dFecChg ) + Field->cTimChg", {|| Field->cCodUsr + Dtos( Field->dFecChg ) + Field->cTimChg } ) )

      ( dbfAlbPrvT )->( dbCloseArea() )

   else

      msgStop( "Imposible abrir en modo exclusivo la tabla de albaranes de proveedores" )

   end

   dbUseArea( .T., cDriver(), cPath + "ALBPROVL.DBF", cCheckArea( "ALBPROVL", @dbfAlbPrvT ), .F. )

   if !( dbfAlbPrvT )->( neterr() )
      ( dbfAlbPrvT)->( __dbPack() )

      ( dbfAlbPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT )->( ordCreate( cPath + "AlbProvL.Cdx", "nNumAlb", "cSerAlb + Str( nNumAlb ) + cSufAlb", {|| Field->cSerAlb + STR( Field->nNumAlb ) + Field->cSufAlb } ) )

      ( dbfAlbPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT )->( ordCreate( cPath + "AlbProvL.Cdx", "cRef", "cRef + cValPr1 + cValPr2", {|| Field->cRef + Field->cValPr1 + Field->cValPr2 } ) )

      ( dbfAlbPrvT )->( ordCondSet( "!lFacturado .and. !Deleted()", {|| !Field->lFacturado .AND. !Deleted() } ) )
      ( dbfAlbPrvT )->( ordCreate( cPath + "AlbProvL.Cdx", "cRefLote", "cRef + cValPr1 + cValPr2 + cLote", {|| Field->cRef + Field->cValPr1 + Field->cValPr2 + Field->cLote } ) )

      ( dbfAlbPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT )->( ordCreate( cPath + "AlbProvL.Cdx", "Lote", "cLote", {|| Field->cLote } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "AlbProvL.Cdx", "cNumPed", "cNumPed", {|| Field->cNumPed } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "AlbProvL.Cdx", "cPedCliRef", "cNumPed + cRef + cValPr1 + cValPr2", {|| Field->cNumPed + Field->cRef + Field->cValPr1 + Field->cValPr2 } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "AlbProvL.Cdx", "cPedCliDet", "cNumPed + cRef + cValPr1 + cValPr2 + cRefPrv ", {|| Field->cNumPed + Field->cRef + Field->cValPr1 + Field->cValPr2 + Field->cRefPrv } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "AlbProvL.Cdx", "cCodPed", "cCodPed", {|| Field->cCodPed } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "AlbProvL.Cdx", "cPedPrvRef", "cCodPed + cRef + cValPr1 + cValPr2 + cLote", {|| Field->cCodPed + Field->cRef + Field->cValPr1 + Field->cValPr2 + Field->cLote } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "AlbProvL.Cdx", "cPedPrvDet", "cCodPed + cRef + cValPr1 + cValPr2 + cRefPrv ", {|| Field->cCodPed + Field->cRef + Field->cValPr1 + Field->cValPr2 + Field->cRefPrv } ) )

      ( dbfAlbPrvT)->( ordCondSet( "!lFacturado .and. !Deleted()", {|| !Field->lFacturado .AND. !Deleted() } ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "AlbProvL.Cdx", "cStkFast", "cRef", {|| Field->cRef } ) )

      ( dbfAlbPrvT )->( ordCondSet( "!lFacturado .and. !Deleted()", {|| !Field->lFacturado .AND. !Deleted()}  ) )
      ( dbfAlbPrvT )->( ordCreate( cPath + "AlbProvL.Cdx", "cStkRef", "cRef + cValPr1 + cValPr2", {|| Field->cRef + Field->cValPr1 + Field->cValPr2 } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "AlbProvL.Cdx", "cPCliDet", "cNumPed + cRef + cValPr1 + cValPr2 + cLote ", {|| Field->cNumPed + Field->cRef + Field->cValPr1 + Field->cValPr2 + Field->cLote } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "AlbProvL.Cdx", "cPedRef", "cCodPed + cRef", {|| Field->cCodPed + Field->cRef } ) )

      ( dbfAlbPrvT)->( ordCondSet("!Deleted() .and. !lFacturado", {||!Deleted() .AND. !Field->lFacturado }, , , , , , , , , .T.  ) )
      ( dbfAlbPrvT)->( ordCreate( cPath + "AlbProvL.Cdx", "cRefFec", "cRef + dtos( dFecAlb )", {|| Field->cRef + dtos( Field->dFecAlb ) } ) )

      ( dbfAlbPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de albaranes de proveedores" )
   end

   dbUseArea( .T., cDriver(), cPath + "AlbPrvI.DBF", cCheckArea( "AlbPrvI", @dbfAlbPrvT ), .F. )

   if !( dbfAlbPrvT )->( neterr() )
      ( dbfAlbPrvT )->( __dbPack() )

      ( dbfAlbPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT )->( ordCreate( cPath + "AlbPrvI.CDX", "NNUMALB", "CSERALB + STR( NNUMALB ) + CSUFALB", {|| Field->cSerAlb + Str( Field->nNumAlb ) + Field->cSufAlb } ) )

      ( dbfAlbPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de albaranes de proveedores" )
   end

   dbUseArea( .T., cDriver(), cPath + "AlbPrvD.DBF", cCheckArea( "AlbPrvD", @dbfAlbPrvT ), .F. )

   if !( dbfAlbPrvT )->( neterr() )
      ( dbfAlbPrvT )->( __dbPack() )

      ( dbfAlbPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT )->( ordCreate( cPath + "AlbPrvD.CDX", "NNUMALB", "CSERALB + STR( NNUMALB ) + CSUFALB", {|| Field->cSerAlb + Str( Field->nNumAlb ) + Field->cSufAlb } ) )

      ( dbfAlbPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de albaranes de proveedores" )
   end

   dbUseArea( .T., cDriver(), cPath + "AlbPrvS.DBF", cCheckArea( "AlbPrvS", @dbfAlbPrvT ), .F. )
   if !( dbfAlbPrvT )->( neterr() )
      ( dbfAlbPrvT )->( __dbPack() )

      ( dbfAlbPrvT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfAlbPrvT )->( ordCreate( cPath + "AlbPrvS.CDX", "nNumAlb", "cSerAlb + Str( nNumAlb ) + cSufAlb + Str( nNumLin )", {|| Field->cSerAlb + Str( Field->nNumAlb ) + Field->cSufAlb + Str( Field->nNumLin ) } ) )

      ( dbfAlbPrvT )->( ordCondSet( "!lFacturado .and. !Deleted()", {|| !Field->lFacturado .AND. !Deleted() }  ) )
      ( dbfAlbPrvT )->( ordCreate( cPath + "AlbPrvS.CDX", "cRefSer", "cRef + cAlmLin + cNumSer", {|| Field->cRef + Field->cAlmLin + Field->cNumSer } ) )

      ( dbfAlbPrvT )->( ordCondSet( "!Deleted()", {|| !Field->lFacturado .AND. !Deleted() }  ) )
      ( dbfAlbPrvT )->( ordCreate( cPath + "AlbPrvS.CDX", "cNumSer", "cNumSer", {|| Field->cNumSer } ) )

      ( dbfAlbPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de numeros de series de albaranes de proveedores" )
   end

RETURN NIL



STATIC FUNCTION BeginTrans( aTmp, aOld )

   local oBlock
   local lErrors     := .F.
   local cDbf        := "AProL"
   local cDbfInc     := "AProI"
   local cDbfDoc     := "AProD"
   local cDbfSer     := "AProS"
   local nAlbaran    := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      CursorWait()

      cNewFile       := cGetNewFileName( cPatTmp() + cDbf )
      cTmpInc        := cGetNewFileName( cPatTmp() + cDbfInc )
      cTmpDoc        := cGetNewFileName( cPatTmp() + cDbfDoc )
      cTmpSer        := cGetNewFileName( cPatTmp() + cDbfSer )





      dbCreate( cNewFile, aSqlStruct( aColAlbPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFile, cCheckArea( cDbf, @dbfTmp ), .F. )

      if !( dbfTmp )->( neterr() )
         ( dbfTmp )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmp )->( OrdCreate( cNewFile, "nNumLin", "Str( nNumLin, 4 )", {|| Str( Field->nNumLin ) } ) )

         ( dbfTmp )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
         ( dbfTmp )->( OrdCreate( cNewFile, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
      end





      if ( dbfAlbPrvL )->( dbSeek( nAlbaran ) )
         while ( ( dbfAlbPrvL )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->cSufAlb == nAlbaran .AND. !( dbfAlbPrvL )->( eof() ) )
            dbPass( dbfAlbPrvL, dbfTmp, .T. )
            ( dbfAlbPrvL )->( DbSkip() )
         end
      end

      ( dbfTmp )->( dbGoTop() )





      dbCreate( cTmpInc, aSqlStruct( aIncAlbPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpInc, cCheckArea( cDbfInc, @dbfTmpInc ), .F. )

      if !( dbfTmpInc )->( neterr() )
         ( dbfTmpInc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpInc )->( ordCreate( cTmpInc, "Recno", "Recno()", {|| Recno() } ) )
      end





      if ( dbfAlbPrvI )->( dbSeek( nAlbaran ) )
         while ( ( dbfAlbPrvI )->cSerAlb + Str( ( dbfAlbPrvI )->nNumAlb ) + ( dbfAlbPrvI )->cSufAlb == nAlbaran ) .AND. ( dbfAlbPrvI )->( !eof() )
            dbPass( dbfAlbPrvI, dbfTmpInc, .T. )
            ( dbfAlbPrvI )->( dbSkip() )
         end
      end

      ( dbfTmpInc )->( dbGoTop() )





      dbCreate( cTmpDoc, aSqlStruct( aAlbPrvDoc() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpDoc, cCheckArea( cDbfDoc, @dbfTmpDoc ), .F. )

      if !( dbfTmpDoc )->( neterr() )
         ( dbfTmpDoc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpDoc )->( ordCreate( cTmpDoc, "Recno", "Recno()", {|| Recno() } ) )
      end





      if ( dbfAlbPrvD )->( dbSeek( nAlbaran ) )
         while ( ( dbfAlbPrvD )->cSerAlb + Str( ( dbfAlbPrvD )->nNumAlb ) + ( dbfAlbPrvD )->cSufAlb == nAlbaran ) .AND. ( dbfAlbPrvD )->( !eof() )
            dbPass( dbfAlbPrvD, dbfTmpDoc, .T. )
            ( dbfAlbPrvD )->( dbSkip() )
         end
      end

      ( dbfTmpDoc )->( dbGoTop() )





      dbCreate( cTmpSer, aSqlStruct( aSerAlbPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpSer, cCheckArea( cDbf, @dbfTmpSer ), .F. )

      if !( dbfTmpSer )->( neterr() )
         ( dbfTmpSer )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpSer )->( OrdCreate( cTmpSer, "nNumLin", "Str( nNumLin, 4 ) + cRef", {|| Str( Field->nNumLin, 4 ) + Field->cRef } ) )
      end





      if ( dbfAlbPrvS )->( dbSeek( nAlbaran ) )
         while ( ( dbfAlbPrvS )->cSerAlb + Str( ( dbfAlbPrvS )->nNumAlb ) + ( dbfAlbPrvS )->cSufAlb == nAlbaran )
            dbPass( dbfAlbPrvS, dbfTmpSer, .T. )
            ( dbfAlbPrvS )->( dbSkip() )
         end
      end

      ( dbfTmpSer )->( dbGoTop() )

      CursorWE()

   RECOVER

      msgStop( "Imposible crear tablas temporales." )

      KillTrans()

      lErrors     := .T.

   end

   ErrorBlock( oBlock )

RETURN ( lErrors )



function aIncAlbPrv()

   local aIncAlbPrv  := {}

   aAdd( aIncAlbPrv, { "cSerAlb", "C",    1,  0, "Serie de albarán" ,                "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbPrv, { "nNumAlb", "N",    9,  0, "Número de albarán" ,               "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aIncAlbPrv, { "cSufAlb", "C",    2,  0, "Sufijo de albarán" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbPrv, { "cCodTip", "C",    3,  0, "Tipo de incidencia" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbPrv, { "dFecInc", "D",    8,  0, "Fecha de la incidencia" ,          "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbPrv, { "mDesInc", "M",   10,  0, "Descripción de la incidencia" ,    "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbPrv, { "lListo",  "L",    1,  0, "Lógico de listo" ,                 "",                   "", "( cDbfCol )" } )
   aAdd( aIncAlbPrv, { "lAviso",  "L",    1,  0, "Lógico de aviso" ,                 "",                   "", "( cDbfCol )" } )

return ( aIncAlbPrv )



function aAlbPrvDoc()

   local aAlbPrvDoc  := {}

   aAdd( aAlbPrvDoc, { "cSerAlb", "C",    1,  0, "Serie del albarán" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aAlbPrvDoc, { "nNumAlb", "N",    9,  0, "Número del albarán" ,              "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aAlbPrvDoc, { "cSufAlb", "C",    2,  0, "Sufijo del albarán" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aAlbPrvDoc, { "cNombre", "C",  240,  0, "Nombre del documento" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aAlbPrvDoc, { "cRuta",   "C",  240,  0, "Ruta del documento" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aAlbPrvDoc, { "mObsDoc", "M",   10,  0, "Observaciones del documento" ,     "",                   "", "( cDbfCol )" } )

return ( aAlbPrvDoc )



STATIC FUNCTION EndTrans( aTmp, aGet, dbfIva, nDec, nRec, oBrw, nMode, oDlg )

   local aTbl
   local oError
   local oBlock
   local cNumPed
   local cSerAlb
   local nNumAlb
   local cSufAlb
   local dFecAlb
   local aNumPedCli
   local cNumPedPrv
   local aNumPed
   local i

   if Empty( aTmp[ 1 ] )
      aTmp[ 1 ]  := "A"
   end

   cSerAlb              := aTmp[ 1 ]
   nNumAlb              := aTmp[ 2 ]
   cSufAlb              := aTmp[ 3 ]
   dFecAlb              := aTmp[ 5 ]
   cNumPedPrv           := aTmp[ 29 ]
   aNumPedCli           := {}





   if !lValidaOperacion( aTmp[5] )
      Return .F.
   end





   if Empty( aTmp[ 6 ] )
      msgStop( "Código de proveedor no puede estar vacío." )
      aGet[ 6 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 8 ] )
      msgStop( "Caja no puede estar vacía." )
      aGet[ 8 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 7 ] )
      msgStop( "Almacen no puede estar vacío." )
      aGet[ 7 ]:SetFocus()
      return .F.
   end

   if ( dbfTmp )->( eof() )
      MsgStop( "No puede almacenar un documento sin líneas." )
      return .F.
   end

   CursorWait()

   oDlg:Disable()

   oMsgText( "Archivando" )

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      BeginTransaction()





      aTmp[ 53 ]     := GetSysDate()
      aTmp[ 54 ]     := Time()

      do case
      case nMode == 1 .OR. nMode == 4

         nNumAlb           := nNewDoc( cSerAlb, dbfAlbPrvT, "nAlbPrv", , dbfCount )
         aTmp[ 2 ]  := nNumAlb







      case nMode == 2





         while ( dbfAlbPrvL )->( dbSeek( cSerAlb + Str( nNumAlb ) + cSufAlb ) ) .AND. !( dbfAlbPrvL )->( eof() )
            if dbLock( dbfAlbPrvL )
               ( dbfAlbPrvL )->( dbDelete() )
               ( dbfAlbPrvL )->( dbUnLock() )
            end
         end

         while ( dbfAlbPrvI )->( dbSeek( cSerAlb + Str( nNumAlb ) + cSufAlb ) ) .AND. !( dbfAlbPrvI )->( eof() )
            if dbLock( dbfAlbPrvI )
               ( dbfAlbPrvI )->( dbDelete() )
               ( dbfAlbPrvI )->( dbUnLock() )
            end
         end

         while ( dbfAlbPrvD )->( dbSeek( cSerAlb + Str( nNumAlb ) + cSufAlb ) ) .AND. !( dbfAlbPrvD )->( eof() )
            if dbLock( dbfAlbPrvD )
               ( dbfAlbPrvD )->( dbDelete() )
               ( dbfAlbPrvD )->( dbUnLock() )
            end
         end

         while ( dbfAlbPrvS )->( dbSeek( cSerAlb + Str( nNumAlb ) + cSufAlb ) ) .AND. !( dbfAlbPrvS )->( eof() )
            if dbLock( dbfAlbPrvS )
               ( dbfAlbPrvS )->( dbDelete() )
               ( dbfAlbPrvS )->( dbUnLock() )
            end
         end

      end





      ( dbfTmp )->( dbClearFilter() )

      oMsgProgress()
      oMsgProgress():SetRange( 0, ( dbfTmp )->( LastRec() ) )





      ( dbfTmp )->( dbGoTop() )
      while !( dbfTmp )->( eof() )

         aTbl                                               := dbScatter( dbfTmp )
         aTbl[ 1 ]                                   := cSerAlb
         aTbl[ 2 ]                                   := nNumAlb
         aTbl[ 3 ]                                   := cSufAlb
         aTbl[ 51 ]                                   := .F.
         aTbl[ 18 ]                                   := nNetUAlbPrv( aTbl, aTmp, nDinDiv, nDirDiv, aTmp[ 33 ] )
         aTbl[ ( dbfAlbPrvL )->( FieldPos( "dFecAlb" ) ) ]  := aTmp[ 5 ]

         AppRefPrv( aTbl[ 5 ], aTmp[ 6 ], aTbl[ 4 ], aTbl[ 15 ], aTbl[ 16 ], aTmp[ 32 ], aTbl[ 10 ], dbfArtPrv )





         if ( dbfArticulo )->( dbSeek( ( dbfTmp )->cRef ) ) .AND. ( dbfTmp )->lChgLin
            CambioPrecio( aTmp[ 5 ], dbfArticulo, dbfTmp )
         end





         dbGather( aTbl, dbfAlbPrvL, .T. )

         ( dbfTmp )->( dbSkip() )

         oMsgProgress():Deltapos( 1 )

      end





      aTmp[ 57 ]     := nTotNet
      aTmp[ 58 ]     := nTotIva
      aTmp[ 59 ]     := nTotReq
      aTmp[ 60 ]     := nTotAlb





      WinGather( aTmp, , dbfAlbPrvT, , nMode )





      if !Empty( cNumPedPrv )
         oStock:SetPedPrv( cNumPedPrv )
      end





      ( dbfTmpInc )->( dbGoTop() )
      while ( dbfTmpInc )->( !eof() )
         dbPass( dbfTmpInc, dbfAlbPrvI, .T., cSerAlb, nNumAlb, cSufAlb )
         ( dbfTmpInc )->( dbSkip() )
      end





      ( dbfTmpDoc )->( dbGoTop() )
      while ( dbfTmpDoc )->( !eof() )
         dbPass( dbfTmpDoc, dbfAlbPrvD, .T., cSerAlb, nNumAlb, cSufAlb )
         ( dbfTmpDoc )->( dbSkip() )
      end





      ( dbfTmpSer )->( dbGoTop() )
      while ( dbfTmpSer )->( !eof() )
         dbPass( dbfTmpSer, dbfAlbPrvS, .T., cSerAlb, nNumAlb, cSufAlb, dFecAlb )
         ( dbfTmpSer )->( dbSkip() )
      end





      ( dbfTmp )->( dbGoTop() )
      while !( dbfTmp )->( Eof() )
         if aScan( aNumPedCli, ( dbfTmp )->cNumPed ) == 0
            aAdd( aNumPedCli, ( dbfTmp )->cNumPed )
         end
         ( dbfTmp )->( dbSkip() )
      end

      for each cNumPed in aNumPedCli
         oStock:SetRecibidoPedCli( cNumPed )
      next






      if Len( aAlbaranes ) <> 0

         for each aNumPed in aAlbaranes

            oStock:SetPedPrv( aNumPed[ 3 ] )

            if dbSeekInOrd( aNumPed[ 3 ], "nNumPed", dbfPedPrvT )

               if dbLock( dbfPedPrvT )
                  ( dbfPedPrvT )->cNumAlb    := cSerAlb + Str( nNumAlb ) + cSufAlb
                  ( dbfPedPrvT )->( dbUnLock() )
               end

            end

         next

      end





      dbCommitAll()

      CommitTransaction()

   RECOVER USING oError

      RollBackTransaction()

      msgStop( "Imposible guardar el documento" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   oMsgText()
   EndProgress()

   oDlg:Enable()
   oDlg:End( 1 )

   CursorWE()

return .T.



STATIC FUNCTION KillTrans( oBrwLin, oBrwInc )

   if !Empty( dbfTmp ) .AND. ( dbfTmp )->( Used() )
      ( dbfTmp )->( dbCloseArea() )
   end

   if !Empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )
      ( dbfTmpInc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpDoc ) .AND. ( dbfTmpDoc )->( Used() )
      ( dbfTmpDoc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpSer ) .AND. ( dbfTmpSer )->( Used() )
      ( dbfTmpSer )->( dbCloseArea() )
   end

   dbfErase( cNewFile )
   dbfErase( cTmpInc  )
   dbfErase( cTmpDoc  )
   dbfErase( cTmpSer  )





   if oBrwLin <> nil
      oBrwLin:CloseData()
   end

   if oBrwInc <> nil
      oBrwInc:CloseData()
   end

RETURN NIL



STATIC FUNCTION CreateFiles( cPath )

   if !lExistTable( cPath + "ALBPROVT.DBF" )
      dbCreate( cPath + "ALBPROVT.DBF", aSqlStruct( aItmAlbPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "ALBPROVL.DBF" )
      dbCreate( cPath + "ALBPROVL.DBF", aSqlStruct( aColAlbPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "ALBPRVI.DBF" )
      dbCreate( cPath + "ALBPRVI.DBF", aSqlStruct( aIncAlbPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "ALBPRVD.DBF" )
      dbCreate( cPath + "ALBPRVD.DBF", aSqlStruct( aAlbPrvDoc() ), cDriver() )
   end

   if !lExistTable( cPath + "ALBPRVS.DBF" )
      dbCreate( cPath + "ALBPRVS.DBF", aSqlStruct( aSerAlbPrv() ), cDriver() )
   end

RETURN NIL






STATIC FUNCTION ChgState( oBrw )

   if dbDialogLock( dbfAlbPrvT )

      ( dbfAlbPrvT )->lFacturado := !( dbfAlbPrvT )->lFacturado
      ( dbfAlbPrvT )->cNumFac    := Space( 12 )
      ( dbfAlbPrvT )->( dbUnlock() )







   end

   oBrw:Refresh()
   oBrw:SetFocus()

RETURN NIL




STATIC FUNCTION lMoreIva( nCodIva )





    IF aTotIva[ 1, 3 ] == NIL .OR. aTotIva[ 2, 3 ] == NIL .OR. aTotIva[ 3, 3 ] == NIL
        RETURN .T.
    end

    IF aTotIva[ 1, 3 ] == nCodIva .OR. aTotIva[ 2, 3 ] == nCodIva .OR. aTotIva[ 3, 3 ] == nCodIva
        RETURN .T.
    end

   MsgStop( "Albarán con mas de 3 tipos de " + cImp(), "Imposible añadir" )

RETURN .F.







FUNCTION dFecAlbPrv( cAlbPrv, dbfAlbPrvT )

    local dFecFac    := CtoD("")

   if ( dbfAlbPrvT )->( dbSeek( cAlbPrv ) )
      dFecFac     := ( dbfAlbPrvT )->dFecAlb
   end

RETURN ( dFecFac )







FUNCTION cNbrAlbPrv( cAlbPrv, dbfAlbPrvT )

   local cNomPrv  := ""

   if ( dbfAlbPrvT )->( dbSeek( cAlbPrv ) )
      cNomPrv     := ( dbfAlbPrvT )->cNomPrv
   end

RETURN ( cNomPrv )







FUNCTION lFacAlbPrv( cAlbPrv, dbfAlbPrvT )

   local lFacAlb  := .F.

   if ( dbfAlbPrvT )->( dbSeek( cAlbPrv ) )
      lFacAlb     := ( dbfAlbPrvT )->lFacturado
   end

RETURN ( lFacAlb )






function nTotVAlbPrv( cCodArt, dbfAlbPrvL )

   local nTotVta  := 0
   local nRecno   := ( dbfAlbPrvL )->( Recno() )

   if ( dbfAlbPrvL )->( dbSeek( cCodArt ) )

      while ( dbfAlbPrvL )->CREF == cCodArt .AND. !( dbfAlbPrvL )->( eof() )

         nTotVta += nTotLAlbPrv( dbfAlbPrvL, 0 )
         ( dbfAlbPrvL )->( dbSkip() )

      end

   end

   ( dbfAlbPrvL )->( dbGoTo( nRecno ) )

return ( nTotVta )






function nTotDAlbPrv( cCodArt, dbfAlbPrvL, dbfAlbPrvT, cCodAlm )

   local lFacAlb  := .F.
   local nTotVta  := 0
   local nRecno   := ( dbfAlbPrvL )->( Recno() )

   if ( dbfAlbPrvL )->( dbSeek( cCodArt ) )

      while ( dbfAlbPrvL )->cRef == cCodArt .AND. !( dbfAlbPrvL )->( eof() )

         if dbfAlbPrvT <> nil
            lFacAlb     := lFacAlbPrv( ( dbfAlbPrvL )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->CSUFALB, dbfAlbPrvT )
         end

         if !lFacAlb
            if cCodAlm <> nil
               if cCodAlm == ( dbfAlbPrvL )->cAlmLin
                  nTotVta  += nTotNAlbPrv( dbfAlbPrvL )
               end
            else
               nTotVta     += nTotNAlbPrv( dbfAlbPrvL )
            end
         end

         ( dbfAlbPrvL )->( dbSkip() )

      end

   end

   ( dbfAlbPrvL )->( dbGoTo( nRecno ) )

return ( nTotVta )






FUNCTION nPreAlbPrv( dbfAlbPrvL, uTmp, nDec, nRec )

   local cDivAlb
   local nDtoEsp
   local nDtoPp
   local nCalculo := 0

   do case
   case Valtype( uTmp ) == "A"
      cDivAlb     := uTmp[ 32 ]
      nDtoEsp     := uTmp[ 22 ]
      nDtoPp      := uTmp[ 24    ]
   case Valtype( uTmp ) == "C"
      cDivAlb     := (uTmp)->CDIVALB
      nDtoEsp     := (uTmp)->NDTOESP
      nDtoPp      := (uTmp)->NDPP
   end

   IIF( nDec == nil, nDec := nDinDiv( cDivAlb, dbfDiv ), ) ;
   IIF( nRec == nil, nRec := nRinDiv( cDivAlb, dbfDiv ), ) ;

   nCalculo       := nTotLAlbPrv( dbfAlbPrvL, nDec, nRec )

   If nDtoEsp <> 0
      nCalculo    -= nCalculo * nDtoEsp / 100
   end

   If nDtoPp <> 0
      nCalculo    -= nCalculo * nDtoPp / 100
   end

RETURN ( round( nCalculo, nDec ) )



static function lNotOpen()

   if NetErr()
      MsgStop( "Imposible abrir ficheros de albaranes de proveedores" )
      CloseFiles()
      return .T.
   end

return .F.



static function lGenAlb( oBrw, oBtn, nDevice )

   local bAction

   IIF( nDevice == nil, nDevice := 1, ) ;

   if Empty( oBtn )
      return nil
   end

   if !( dbfDoc )->( dbSeek( "AP" ) )








         oWndBrw:NewAt( "DOCUMENT",,, {||( msgStop( "No hay albaranes de proveedores predefinidos" ) )}, "No hay documentos", "N",,, 4, oBtn, .F. )

   else

      while ( dbfDoc )->cTipo == "AP" .AND. !( dbfDoc )->( eof() )

         bAction  := bGenAlb( nDevice, "Imprimiendo albaranes de proveedores", ( dbfDoc )->Codigo )

         oWndBrw:NewAt( "Document", , , bAction, Rtrim( ( dbfDoc )->cDescrip ) , , , , , oBtn )

         ( dbfDoc )->( dbSkip() )

      end

   end

   SysRefresh()

return nil



static function bGenAlb( nDevice, cTitle, cCodDoc )

   local bGen
   local nDev  := by( nDevice )
   local cTit  := by( cTitle  )
   local cCod  := by( cCodDoc )

   if nDev == 1
      bGen     := {|| nGenAlbPrv( nDevice, cTit, cCod ) }
   else
      bGen     := {|| GenAlbPrv( nDevice, cTit, cCod ) }
   end

return bGen



static function nCanEnt( dbfAlbPrvL )

return ( If( ( dbfAlbPrvL )->NCANENT <> 0, ( dbfAlbPrvL )->NCANENT, 1 ) * ( dbfAlbPrvL )->NUNICAJA )



FUNCTION Ped2Alb( cNumPed, lZoom )

   local oBlock
   local oError
   local cNumAlb

   IIF( lZoom == nil, lZoom := .F., ) ;

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVT.DBF" ), ( cCheckArea( "ALBPROVT", @dbfAlbPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
   ( dbfAlbPrvT )->( OrdSetFocus( "cNumPed" ) )

   if ( dbfAlbPrvT )->( dbSeek( cNumPed ) )
      cNumAlb     := ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb
   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos de albaranes de proveedores" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfAlbPrvT )->( dbCloseArea() )

   if !Empty( cNumAlb )
      if lZoom
         ZooAlbPrv( cNumAlb )
      else
         EdtAlbPrv( cNumAlb )
      end
   else
      msgStop( "No hay albarán asociado" )
   end

return NIL



function nVtaAlbPrv( cCodPrv, dDesde, dHasta, dbfAlbPrvT, dbfAlbPrvL, dbfIva, dbfDiv )

   local nCon     := 0
   local nRec     := ( dbfAlbPrvT )->( Recno() )





   if ( dbfAlbPrvT )->( dbSeek( cCodPrv ) )

      while ( dbfAlbPrvT )->cCodPrv == cCodPrv .AND. !( dbfAlbPrvT )->( Eof() )


         if ( dDesde == nil .OR. ( dbfAlbPrvT )->dFecAlb >= dDesde )    .AND. ( dHasta == nil .OR. ( dbfAlbPrvT )->dFecAlb <= dHasta )

            nCon  += nTotAlbPrv( ( dbfAlbPrvT )->cSerAlb + Str( (dbfAlbPrvT)->nNumAlb ) + (dbfAlbPrvT)->cSufAlb, dbfAlbPrvT, dbfAlbPrvL, dbfIva, dbfDiv, nil, cDivEmp(), .F. )

         end

         ( dbfAlbPrvT )->( dbSkip() )

      end

   end

   ( dbfAlbPrvT )->( dbGoTo( nRec ) )

return nCon



























































































































static function nTotUnd( uDbf )

   local nTotUnd

   if ValType( uDbf ) == "A"
      nTotUnd  := NotCaja( uDbf[ 9 ] ) * uDbf[ 8 ]
   else
      nTotUnd  := NotCaja( ( uDbf )->NCANENT ) * ( uDbf )->NUNICAJA
   end

return ( nTotUnd )







FUNCTION CambioPrecio( dFecha, dbfArticulo, dbfTmp )

   if dbDialogLock( dbfArticulo )

      if ( dbfTmp )->nPreCom > 0
         ( dbfArticulo )->pCosto    := ( dbfTmp )->nPreCom
      end

      ( dbfArticulo )->lBnf1        := ( dbfTmp )->lBnfLin1
      ( dbfArticulo )->lBnf2        := ( dbfTmp )->lBnfLin2
      ( dbfArticulo )->lBnf3        := ( dbfTmp )->lBnfLin3
      ( dbfArticulo )->lBnf4        := ( dbfTmp )->lBnfLin4
      ( dbfArticulo )->lBnf5        := ( dbfTmp )->lBnfLin5
      ( dbfArticulo )->lBnf6        := ( dbfTmp )->lBnfLin6

      ( dbfArticulo )->Benef1       := ( dbfTmp )->nBnfLin1
      ( dbfArticulo )->Benef2       := ( dbfTmp )->nBnfLin2
      ( dbfArticulo )->Benef3       := ( dbfTmp )->nBnfLin3
      ( dbfArticulo )->Benef4       := ( dbfTmp )->nBnfLin4
      ( dbfArticulo )->Benef5       := ( dbfTmp )->nBnfLin5
      ( dbfArticulo )->Benef6       := ( dbfTmp )->nBnfLin6

      ( dbfArticulo )->lIvaInc      := ( dbfTmp )->lIvaLin

      ( dbfArticulo )->pVenta1      := ( dbfTmp )->nPvpLin1
      ( dbfArticulo )->pVtaIva1     := ( dbfTmp )->nIvaLin1
      ( dbfArticulo )->pVenta2      := ( dbfTmp )->nPvpLin2
      ( dbfArticulo )->pVtaIva2     := ( dbfTmp )->nIvaLin2
      ( dbfArticulo )->pVenta3      := ( dbfTmp )->nPvpLin3
      ( dbfArticulo )->pVtaIva3     := ( dbfTmp )->nIvaLin3
      ( dbfArticulo )->pVenta4      := ( dbfTmp )->nPvpLin4
      ( dbfArticulo )->pVtaIva4     := ( dbfTmp )->nIvaLin4
      ( dbfArticulo )->pVenta5      := ( dbfTmp )->nPvpLin5
      ( dbfArticulo )->pVtaIva5     := ( dbfTmp )->nIvaLin5
      ( dbfArticulo )->pVenta6      := ( dbfTmp )->nPvpLin6
      ( dbfArticulo )->pVtaIva6     := ( dbfTmp )->nIvaLin6





      ( dbfArticulo )->lLabel       := .T.
      ( dbfArticulo )->nLabel       := Max( ( dbfArticulo )->nLabel, 1 )





      ( dbfArticulo )->dFecChg      := date()

      if dFecha >= ( dbfArticulo )->LastIn
         ( dbfArticulo )->LastIn    := dFecha
      end

      ( dbfArticulo )->lSndDoc      := .T.
      ( dbfArticulo )->LastChg      := GetSysDate()





      ( dbfArticulo )->cUnidad      := ( dbfTmp )->cUnidad





      ( dbfArticulo )->( dbRUnLock() )

   end

RETURN NIL



FUNCTION nTotNAlbPrv( uDbf )

   local nTotUnd

   IIF( uDbf == nil, uDbf := if( !Empty( tmpAlbPrvL ), tmpAlbPrvL, dbfAlbPrvL ), ) ;

   do case
      case ValType( uDbf ) == "A"
         nTotUnd  := NotCaja( uDbf[ 9 ] )
         nTotUnd  *= uDbf[ 8 ]
         nTotUnd  *= NotCero( uDbf[ 64 ] )
         nTotUnd  *= NotCero( uDbf[ 97 ] )
         nTotUnd  *= NotCero( uDbf[ 98 ] )
         nTotUnd  *= NotCero( uDbf[ 99 ] )

      case ValType( uDbf ) == "O"
         nTotUnd  := NotCaja( uDbf:nCanEnt )
         nTotUnd  *= uDbf:nUniCaja
         nTotUnd  *= NotCero( uDbf:nUndKit )
         nTotUnd  *= NotCero( uDbf:nMedUno )
         nTotUnd  *= NotCero( uDbf:nMedDos )
         nTotUnd  *= NotCero( uDbf:nMedTre )

      otherwise
         nTotUnd  := NotCaja( ( uDbf )->nCanEnt )
         nTotUnd  *= ( uDbf )->nUniCaja
         nTotUnd  *= NotCero( ( uDbf )->nUndKit )
         nTotUnd  *= NotCero( ( uDbf )->nMedUno )
         nTotUnd  *= NotCero( ( uDbf )->nMedDos )
         nTotUnd  *= NotCero( ( uDbf )->nMedTre )

   end

RETURN ( nTotUnd )



FUNCTION nBrtLAlbPrv( uTmpLin, nDec, nRec, nVdv, cPorDiv )

   local nCalculo    := 0

   IIF( nDec == nil, nDec := 2, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nTotUAlbPrv( uTmpLin, nDec, nVdv, cPorDiv )
   nCalculo          *= nTotNAlbPrv( uTmpLin )

   nCalculo          := Round( nCalculo / nVdv, nRec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nIvaUAlbPrv( dbfTmp, nDec, nVdv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUAlbPrv( dbfTmp, nDec, nVdv )

   if !( dbfTmp )->lIvaLin
      nCalculo    += nCalculo * ( dbfTmp )->nIva / 100
   end

   if nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nIvaLAlbPrv( dbfAlb, dbfLin, nDec, nRou, nVdv, cPorDiv )

   local nCalculo := nImpLAlbPrv( dbfAlb, dbfLin, nDec, nRou, nVdv )

   nCalculo       := Round( nCalculo * ( dbfLin )->nIva / 100, nRou )

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )






Static Function QuiAlbPrv( lDetail )

   local cNumPed
   local aNumPedCli  := {}
   local nRecAnt
   local nOrdAnt
   local nRecPed
   local nOrdPed
   local cNumPedPrv  := ( dbfAlbPrvT )->cNumPed

   IIF( lDetail == nil, lDetail := .T., ) ;

   if ( dbfAlbPrvT )->lCloAlb .AND. !oUser():lAdministrador()
      msgStop( "Solo puede eliminar albaranes cerrados los administradores." )
      return .F.
   end

   CursorWait()

   nRecAnt           := ( dbfAlbPrvL )->( Recno() )
   nOrdAnt           := ( dbfAlbPrvL )->( OrdSetFocus( "nNumAlb" ) )

   if ( dbfAlbPrvL )->( dbSeek( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb ) )


      while ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb == ( dbfAlbPrvL )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->cSufAlb .AND.  !( dbfAlbPrvL )->( Eof() )

         if aScan( aNumPedCli, ( dbfAlbPrvL )->cNumPed ) == 0
            aAdd( aNumPedCli, ( dbfAlbPrvL )->cNumPed )
         end

         ( dbfAlbPrvL )->( dbSkip() )

      end

   end

   ( dbfAlbPrvL )->( OrdSetFocus( nOrdAnt ) )
   ( dbfAlbPrvL )->( dbGoTo( nRecAnt ) )





   while ( dbfAlbPrvL )->( dbSeek( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT  )->cSufAlb ) ) .AND. !( dbfAlbPrvL )->( eof() )

      if dbLock( dbfAlbPrvL )
         ( dbfAlbPrvL )->( dbDelete() )
         ( dbfAlbPrvL )->( dbUnLock() )
      end

   end





   while ( dbfAlbPrvI )->( dbSeek( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT  )->cSufAlb ) ) .AND. !( dbfAlbPrvI )->( eof() )

      if dbLock( dbfAlbPrvI )
         ( dbfAlbPrvI )->( dbDelete() )
         ( dbfAlbPrvI )->( dbUnLock() )
      end

   end





   while ( dbfAlbPrvD )->( dbSeek( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT  )->cSufAlb ) ) .AND. !( dbfAlbPrvD )->( eof() )

      if dbLock( dbfAlbPrvD )
         ( dbfAlbPrvD )->( dbDelete() )
         ( dbfAlbPrvD )->( dbUnLock() )
      end

   end





   while ( dbfAlbPrvS )->( dbSeek( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT  )->cSufAlb ) ) .AND. !( dbfAlbPrvS )->( eof() )

      if dbLock( dbfAlbPrvS )
         ( dbfAlbPrvS )->( dbDelete() )
         ( dbfAlbPrvS )->( dbUnLock() )
      end

   end





   for each cNumPed in aNumPedCli
      oStock:SetRecibidoPedCli( cNumPed )
   next





   if !Empty( cNumPedPrv )
      oStock:SetPedPrv( cNumPedPrv )
   end





   nRecPed  := ( dbfPedPrvT )->( RecNo() )
   nOrdPed  := ( dbfPedPrvT )->( OrdSetFocus( "cNumAlb" ) )

   if ( dbfPedPrvT )->( dbSeek( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb ) )

      while ( dbfPedPrvT )->cNumAlb == ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT  )->cSufAlb .AND. !( dbfPedPrvT )->( Eof() )

         if dbLock( dbfPedPrvT )
            ( dbfPedPrvT )->cNumAlb    := ""
            ( dbfPedPrvT )->nEstado    := 1
            ( dbfPedPrvT )->( dbUnLock() )
         end

         oStock:SetPedPrv( ( dbfPedPrvT )->cSerPed + Str( ( dbfPedPrvT )->nNumPed ) + ( dbfPedPrvT )->cSufPed )

         ( dbfPedPrvT )->( dbSkip() )

      end

   end

   ( dbfPedPrvT )->( OrdSetFocus( nOrdPed ) )
   ( dbfPedPrvT )->( dbGoTo( nRecPed ) )

   CursorWE()

Return .T.



function aItmAlbPrv()

   local aItmAlbPrv  := {}

   aAdd( aItmAlbPrv, { "CSERALB",      "C",  1,  0, "Serie del albarán",           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "NNUMALB",      "N",  9,  0, "Número del albarán",          "'999999999'",        "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CSUFALB",      "C",  2,  0, "Sufijo de albarán",           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CTURALB",      "C",  6,  0, "Sesión del albarán",          "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "DFECALB",      "D",  8,  0, "Fecha del albarán",           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CCODPRV",      "C", 12,  0, "Código del proveedor",        "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CCODALM",      "C",  3,  0, "Código de almacén",           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CCODCAJ",      "C",  3,  0, "Código de caja",              "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CNOMPRV",      "C", 35,  0, "Nombre del proveedor",        "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CDIRPRV",      "C", 35,  0, "Domicilio del proveedor",     "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CPOBPRV",      "C", 25,  0, "Población del proveedor",     "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CPROPRV",      "C", 20,  0, "Provincia del proveedor",     "'@!'",               "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CPOSPRV",      "C",  5,  0, "Código postal del proveedor", "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CDNIPRV",      "C", 30,  0, "D.N.I. del proveedor",        "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "DFECENT",      "D",  8,  0, "Fecha de entrada",            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CSUALB",       "C", 12,  0, "Número de su albarán",        "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "DSUALB",       "D",  8,  0, "Fecha de su albarán",         "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CCODPGO",      "C",  2,  0, "Código de la forma de pago",  "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "NBULTOS",      "N",  3,  0, "Número de bultos",            "'999'",              "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "NPORTES",      "N",  6,  0, "Precio de los portes",        "'@EZ 999,999'",      "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CDTOESP",      "C", 50,  0, "Descripción de descuento factura","",               "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "NDTOESP",      "N",  6,  2, "Descuento factura",           "'@EZ 99.99'",        "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CDPP",         "C", 50,  0, "Descripción de descuento pronto pago","",           "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "NDPP",         "N",  6,  2, "Descuento pronto pago",       "'@EZ 99.99'",        "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "LRECARGO",     "L",  1,  0, "Recargo de equivalencia",     "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CCONDENT",     "C", 20,  0, "Comentarios del albarán",     "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CEXPED",       "C", 20,  0, "Expedición",                  "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "COBSERV",      "M", 10,  0, "Observaciones",               "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CNUMPED",      "C", 12,  0, "Número del pedido",           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "LFACTURADO",   "L",  1,  0, "Estado del albarán",          "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CNUMFAC",      "C", 12,  0, "Número de la factura",        "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CDIVALB",      "C",  3,  0, "Divisa del albarán",          "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "NVDVALB",      "N", 10,  4, "Valor de la divisa",          "'@EZ 999,999.9999'", "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "LSNDDOC",      "L",  1,  0, "Enviar documento",            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CDTOUNO",      "C", 25,  0, "Descripción de primer descuento personalizado", "", "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "NDTOUNO",      "N",  5,  2, "Porcentaje de primer descuento personalizado",  "", "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CDTODOS",      "C", 25,  0, "Descripción de segundo descuento personalizado","", "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "NDTODOS",      "N",  5,  2, "Porcentaje de segundo descuento personalizado", "", "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "LCLOALB",      "L",  1,  0, "",                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CCODUSR",      "C",  3,  0, "Código de usuario",           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CCODUBIT1",    "C",  5,  0, "",                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CCODUBIT2",    "C",  5,  0, "",                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CCODUBIT3",    "C",  5,  0, "",                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CVALUBIT1",    "C",  5,  0, "",                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CVALUBIT2",    "C",  5,  0, "",                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CVALUBIT3",    "C",  5,  0, "",                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CNOMUBIT1",    "C", 30,  0, "",                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CNOMUBIT2",    "C", 30,  0, "",                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CNOMUBIT3",    "C", 30,  0, "",                            "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "LIMPRIMIDO",   "L",  1,  0, "Lógico de impreso del documento", "",               "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "DFECIMP",      "D",  8,  0, "Última fecha de impresión del documento", "",       "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CHORIMP",      "C",  5,  0, "Hora de la última impresión del documento", "",     "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "DFECCHG",      "D",  8,  0, "Fecha de modificación del documento", "",           "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CTIMCHG",      "C",  5,  0, "Hora de modificación del documento", "",            "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "CCODDLG",      "C",  2,  0, "Código delegación",           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "nRegIva",      "N",  1,  0, "Regimen de " + cImp(),           "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "nTotNet",      "N", 16,  6, "Total neto",                  "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "nTotIva",      "N", 16,  6, "Total " + cImp(),                "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "nTotReq",      "N", 16,  6, "Total R.E.",                  "",                   "", "( cDbf )"} )
   aAdd( aItmAlbPrv, { "nTotAlb",      "N", 16,  6, "Total albarán",               "",                   "", "( cDbf )"} )

Return ( aItmAlbPrv )



function aColAlbPrv()

   local aColAlbPrv  := {}

   aAdd( aColAlbPrv, { "CSERALB",      "C",  1,  0, "Serie del albarán",           "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NNUMALB",      "N",  9,  0, "Número de albarán",           "'999999999'",         "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CSUFALB",      "C",  2,  0, "Sufijo de albarán",           "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CREF",         "C", 18,  0, "Código de artículo",          "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CREFPRV",      "C", 18,  0, "Referencia del proveedor",    "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CDETALLE",     "C",240,  0, "Nombre del artículo",         "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NIVA",         "N",  6,  2, cImp() + " del artículo",            "'@EZ 999.99'",        "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NUNICAJA",     "N", 16,  6, "Unidades por caja",           "cMasUnd()",           "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NCANENT",      "N", 16,  6, "Cantidad recibida",           "cPirDivAlb",          "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NPREDIV",      "N", 16,  6, "Precio",                      "cPirDivAlb",          "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NCANPED",      "N", 16,  6, "Cajas pedidas",               "cMasUnd()",           "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NUNIPED",      "N", 16,  6, "Unidades pedidas",            "cMasUnd()",           "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CUNIDAD",      "C",  2,  0, cNombreUnidades(),             "'@!'",                "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "MLNGDES",      "M", 10,  0, "Descripción de artículo sin codificar", "",          "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NDTOLIN",      "N",  6,  2, "Descuento en líneas",         "'@EZ 999.99'",        "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NDTOPRM",      "N",  6,  2, "Descuento por promociones",   "'@EZ 999.99'",        "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NDTORAP",      "N",  6,  2, "Descuento por rappels",       "'@EZ 999.99'",        "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NPRECOM",      "N", 16,  6, "Precio real de la compra",    "cPinDivAlb",          "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LBNFLIN1",     "L",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LBNFLIN2",     "L",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LBNFLIN3",     "L",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LBNFLIN4",     "L",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LBNFLIN5",     "L",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LBNFLIN6",     "L",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFLIN1",     "N",  6,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFLIN2",     "N",  6,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFLIN3",     "N",  6,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFLIN4",     "N",  6,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFLIN5",     "N",  6,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFLIN6",     "N",  6,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFSBR1",     "N",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFSBR2",     "N",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFSBR3",     "N",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFSBR4",     "N",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFSBR5",     "N",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NBNFSBR6",     "N",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NPVPLIN1",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NPVPLIN2",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NPVPLIN3",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NPVPLIN4",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NPVPLIN5",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NPVPLIN6",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NIVALIN1",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NIVALIN2",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NIVALIN3",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NIVALIN4",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NIVALIN5",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NIVALIN6",     "N", 16,  6, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NIVALIN",      "N",  6,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LIVALIN",      "L",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LCHGLIN",      "L",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CCODPR1",      "C", 10,  0, "Código de primera propiedad", "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CCODPR2",      "C", 10,  0, "Código de segunda propiedad", "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CVALPR1",      "C", 10,  0, "Valor de primera propiedad",  "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CVALPR2",      "C", 10,  0, "Valor de segunda propiedad",  "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NFACCNV",      "N", 13,  4, "Factor de conversión de la compra","",               "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CCODPED",      "C", 12,  0, "Número del pedido",           "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CALMLIN",      "C",  3,  0, "Código del almacén",          "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NCTLSTK",      "N",  1,  0, "Tipo de stock de la línea",   "'9'",                 "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LLOTE",        "L",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NLOTE",        "N",  9,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CLOTE",        "C", 12,  0, "Número de lote",              "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NNUMLIN",      "N",  4,  0, "Número de la línea",          "'9999'",              "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NUNDKIT",      "N", 16,  6, "Unidades del producto kit",   "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LKITART",      "L",  1,  0, "Línea con escandallo",        "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LKITCHL",      "L",  1,  0, "Línea pertenciente a escandallo",  "",               "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LKITPRC",      "L",  1,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LIMPLIN",      "L",  1,  0, "Imprimir línea",              "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "LCONTROL",     "L",  1,  0, "" ,                           "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "MNUMSER",      "M", 10,  0, "" ,                           "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NDTO1",        "N",  5,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NDTO2",        "N",  5,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NDTO3",        "N",  5,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NDTO4",        "N",  5,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NDTO5",        "N",  5,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NRAP1",        "N",  5,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NRAP2",        "N",  5,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NRAP3",        "N",  5,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NRAP4",        "N",  5,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NRAP5",        "N",  5,  2, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CCODUBI1",     "C",  5,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CCODUBI2",     "C",  5,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CCODUBI3",     "C",  5,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CVALUBI1",     "C",  5,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CVALUBI2",     "C",  5,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CVALUBI3",     "C",  5,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CNOMUBI1",     "C", 30,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CNOMUBI2",     "C", 30,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CNOMUBI3",     "C", 30,  0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CCODFAM",      "C", 16,  0, "Código de familia",           "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CGRPFAM",      "C",  3,  0, "Código del grupo de familia", "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "NREQ",         "N", 16,  6, "Recargo de equivalencia",     "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "MOBSLIN",      "M", 10,  0, "Observación de la línea",     "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "CNUMPED",      "C", 12,  0, "Número del pedido de cliente" , "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "nPvpRec",      "N", 16,  6, "Precio de venta recomendado", "cPirDivAlb",          "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "nNumMed",      "N",  1,  0, "Número de mediciones",        "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "nMedUno",      "N", 16,  6, "Primera unidad de medición",  "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "nMedDos",      "N", 16,  6, "Segunda unidad de medición",  "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "nMedTre",      "N", 16,  6, "Tercera unidad de medición",  "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "lFacturado",   "L",  1,  0, "Estado del albarán",          "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "dFecCad",      "D",  8,  0, "Fecha de caducidad",          "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "nUndLin",      "N", 16,  6, "",                            "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "lLabel",       "L",  1,  0, "Lógico para marca de etiqueta","",                   "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "nLabel",       "N",  6,  0, "Unidades de etiquetas a imprimir","",                "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "dFecAlb",      "D",  8,  0, "Fecha de albaran",            "",                    "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "lNumSer",      "L",  1, 0, "Lógico solicitar numero de serie", "",                "", "( cDbfCol )" } )
   aAdd( aColAlbPrv, { "lAutSer",      "L",  1, 0, "Lógico de autoserializar",     "",                    "", "( cDbfCol )" } )

return ( aColAlbPrv )



function aSerAlbPrv()

   local aColAlbPrv  := {}

   aAdd( aColAlbPrv,  { "cSerAlb",     "C",  1,   0, "",                                 "",                  "", "(cDbfCol)" } )
   aAdd( aColAlbPrv,  { "nNumAlb",     "N",  9,   0, "",                                 "",                  "", "(cDbfCol)" } )
   aAdd( aColAlbPrv,  { "cSufAlb",     "C",  2,   0, "",                                 "",                  "", "(cDbfCol)" } )
   aAdd( aColAlbPrv,  { "dFecAlb",     "D",  8,   0, "",                                 "",                  "", "(cDbfCol)" } )
   aAdd( aColAlbPrv,  { "nNumLin",     "N",  4,   0, "Número de la línea",               "'9999'",            "", "(cDbfCol)" } )
   aAdd( aColAlbPrv,  { "cRef",        "C", 18,   0, "Referencia del artículo",          "",                  "", "(cDbfCol)" } )
   aAdd( aColAlbPrv,  { "cAlmLin",     "C",  3,   0, "Código de almacen",                "",                  "", "(cDbfCol)" } )
   aAdd( aColAlbPrv,  { "lFacturado",  "L",  1,   0, "Lógico de facturado",              "",                  "", "(cDbfCol)" } )
   aAdd( aColAlbPrv,  { "lUndNeg",     "L",  1,   0, "Lógico de unidades en negativo",   "",                  "", "( cDbfCol )" } )
   aAdd( aColAlbPrv,  { "cNumSer",     "C", 30,   0, "Numero de serie",                  "",                  "", "(cDbfCol)" } )

return ( aColAlbPrv )



STATIC FUNCTION nClrText( dbfTmp )

   local cClr

   if ( dbfTmp )->lKitChl
      cClr     := 8421504
   else
      cClr     := 0
   end

Return cClr






function nUnidadesRecibidasPedCli( cPedCli, cCodArt, cValPr1, cValPr2, cRefPrv, cDetalle, dbfAlbPrvL )

   local nRec
   local nOrd
   local nTot        := 0

   IIF( cValPr1 == nil, cValPr1 := Space( 10 ), ) ;
   IIF( cValPr2 == nil, cValPr2 := Space( 10 ), ) ;

   if IsMuebles()

      nRec           := ( dbfAlbPrvL )->( Recno() )
      nOrd           := ( dbfAlbPrvL )->( OrdSetFocus( "cPedCliDet" ) )

      if ( dbfAlbPrvL )->( dbSeek( cPedCli + cCodArt + cValPr1 + cValPr2 + cRefPrv + cDetalle ) )

         while ( dbfAlbPrvL )->cNumPed + ( dbfAlbPrvL )->cRef + ( dbfAlbPrvL )->cValPr1 + ( dbfAlbPrvL )->cValPr2 + ( dbfAlbPrvL )->cRefPrv + ( dbfAlbPrvL )->cDetalle  == cPedCli + cCodArt + cValPr1 + cValPr2 + cRefPRv + cDetalle .AND. !( dbfAlbPrvL )->( eof() )

            nTot     += nTotNAlbPrv( dbfAlbPrvL )

            ( dbfAlbPrvL )->( dbSkip() )

         end

      end

      ( dbfAlbPrvL )->( OrdSetFocus( nOrd ) )
      ( dbfAlbPrvL )->( dbGoTo( nRec ) )

   else

      nRec           := ( dbfAlbPrvL )->( Recno() )
      nOrd           := ( dbfAlbPrvL )->( OrdSetFocus( "cPedCliRef" ) )

      if ( dbfAlbPrvL )->( dbSeek( cPedCli + cCodArt + cValPr1 + cValPr2 ) )

         while ( dbfAlbPrvL )->cNumPed + ( dbfAlbPrvL )->cRef + ( dbfAlbPrvL )->cValPr1 + ( dbfAlbPrvL )->cValPr2 == cPedCli + cCodArt + cValPr1 + cValPr2 .AND. !( dbfAlbPrvL )->( eof() )

            nTot     += nTotNAlbPrv( dbfAlbPrvL )

            ( dbfAlbPrvL )->( dbSkip() )

         end

      end

      ( dbfAlbPrvL )->( OrdSetFocus( nOrd ) )
      ( dbfAlbPrvL )->( dbGoTo( nRec ) )

   end

return ( nTot )



function nUnidadesRecibidasPedPrv( cPedPrv, cCodArt, cValPr1, cValPr2, cRefPrv, cDetalle, dbfAlbPrvL )

   local nRec
   local nOrd
   local nTot        := 0

   IIF( cValPr1 == nil, cValPr1 := Space( 10 ), ) ;
   IIF( cValPr2 == nil, cValPr2 := Space( 10 ), ) ;

   if IsMuebles()

      nRec           := ( dbfAlbPrvL )->( Recno() )
      nOrd           := ( dbfAlbPrvL )->( OrdSetFocus( "cPedPrvDet" ) )

      if ( dbfAlbPrvL )->( dbSeek( cPedPrv + cCodArt + cValPr1 + cValPr2 + cRefPrv + cDetalle ) )

         while ( dbfAlbPrvL )->cCodPed + ( dbfAlbPrvL )->cRef + ( dbfAlbPrvL )->cValPr1 + ( dbfAlbPrvL )->cValPr2 + ( dbfAlbPrvL )->cRefPrv + ( dbfAlbPrvL )->cDetalle  == cPedPrv + cCodArt + cValPr1 + cValPr2 + cRefPRv + cDetalle .AND. !( dbfAlbPrvL )->( eof() )

            nTot     += nTotNAlbPrv( dbfAlbPrvL )

            ( dbfAlbPrvL )->( dbSkip() )

         end

      end

      ( dbfAlbPrvL )->( OrdSetFocus( nOrd ) )
      ( dbfAlbPrvL )->( dbGoTo( nRec ) )

   else

      nRec           := ( dbfAlbPrvL )->( Recno() )
      nOrd           := ( dbfAlbPrvL )->( OrdSetFocus( "cPedPrvRef" ) )

      if ( dbfAlbPrvL )->( dbSeek( cPedPrv + cCodArt + cValPr1 + cValPr2 ) )

         while ( dbfAlbPrvL )->cCodPed + ( dbfAlbPrvL )->cRef + ( dbfAlbPrvL )->cValPr1 + ( dbfAlbPrvL )->cValPr2 == cPedPrv + cCodArt + cValPr1 + cValPr2 .AND. !( dbfAlbPrvL )->( eof() )

            nTot     += nTotNAlbPrv( dbfAlbPrvL )

            ( dbfAlbPrvL )->( dbSkip() )

         end

      end

      ( dbfAlbPrvL )->( OrdSetFocus( nOrd ) )
      ( dbfAlbPrvL )->( dbGoTo( nRec ) )

   end

return ( nTot )



Function SynAlbPrv( cPath )

   local oError
   local oBlock      := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   local aTotAlb
   local cNumSer
   local aNumSer
   local nRecPed
   local nOrdPed

   BEGIN SEQUENCE

   dbUseArea( .T., cDriver(), cPath + "ALBPROVT.DBF", cCheckArea( "ALBPROVT", @dbfAlbPrvT ), .F. )
   ordListAdd( cPath + "ALBPROVT.CDX" )

   dbUseArea( .T., cDriver(), cPath + "ALBPROVL.DBF", cCheckArea( "ALBPROVL", @dbfAlbPrvL ), .F. )
   ordListAdd( cPath + "ALBPROVL.CDX" )

   dbUseArea( .T., cDriver(), cPath + "ALBPRVS.DBF", cCheckArea( "ALBPRVS", @dbfAlbPrvS ), .F. )
   ordListAdd( cPath + "ALBPRVS.CDX" )

   dbUseArea( .T., cDriver(), cPath + "ALBPRVI.DBF", cCheckArea( "ALBPRVI", @dbfAlbPrvI ), .F. )
   ordListAdd( cPath + "ALBPRVI.CDX" )

   dbUseArea( .T., cDriver(), cPatArt() + "FAMILIAS.DBF", cCheckArea( "FAMILIAS", @dbfFamilia ), .F. )
   ordListAdd( cPatArt() + "FAMILIAS.CDX" )

   dbUseArea( .T., cDriver(), cPatArt() + "ARTICULO.DBF", cCheckArea( "ARTICULO", @dbfArticulo ), .F. )
   ordListAdd( cPatArt() + "ARTICULO.CDX" )

   dbUseArea( .T., cDriver(), cPatArt() + "PROVART.DBF", cCheckArea( "PROVART", @dbfArtPrv ), .F. )
   ordListAdd( cPatArt() + "PROVART.CDX" )

   dbUseArea( .T., cDriver(), cPatDat() + "TIVA.DBF", cCheckArea( "TIVA", @dbfIva ), .T. )
   ordListAdd( cPatDat() + "TIVA.CDX" )

   dbUseArea( .T., cDriver(), cPatDat() + "DIVISAS.DBF", cCheckArea( "DIVISAS", @dbfDiv ), .T. )
   ordListAdd( cPatDat() + "DIVISAS.CDX" )

   dbUseArea( .T., cDriver(), cPath + "PEDPROVT.DBF", cCheckArea( "PEDPROVT", @dbfPedPrvT ), .F. )
   ordListAdd( cPath + "PEDPROVT.CDX" )

   dbUseArea( .T., cDriver(), cPath + "PEDPROVL.DBF", cCheckArea( "PEDPROVL", @dbfPedPrvL ), .F. )
   ordListAdd( cPath + "PEDPROVL.CDX" )

   oStock               := TStock():Create( cPatGrp() )
   if !oStock:lOpenFiles()
      lOpenFiles        := .F.
   else
      oStock:cPedPrvT   := dbfPedPrvT
      oStock:cPedPrvL   := dbfPedPrvL
      oStock:cAlbPrvL   := dbfAlbPrvL
   end

   while !( dbfAlbPrvT )->( eof() )

      if Empty( ( dbfAlbPrvT )->cCodCaj )
         ( dbfAlbPrvT )->cCodCaj := "000"
      end

      if !( ( dbfAlbPrvT )->cSerAlb >= "A" .AND. ( dbfAlbPrvT )->cSerAlb <= "Z" )
         ( dbfAlbPrvT )->( dbDelete() )
      end





      if ( dbfAlbPrvT )->nTotAlb == 0 .AND. dbLock( dbfAlbPrvT )

         aTotAlb                 := aTotAlbPrv( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb, dbfAlbPrvT, dbfAlbPrvL, dbfIva, dbfDiv, ( dbfAlbPrvT )->cDivAlb )

         ( dbfAlbPrvT )->nTotNet := aTotAlb[ 1 ]
         ( dbfAlbPrvT )->nTotIva := aTotAlb[ 2 ]
         ( dbfAlbPrvT )->nTotReq := aTotAlb[ 3 ]
         ( dbfAlbPrvT )->nTotAlb := aTotAlb[ 4 ]

         ( dbfAlbPrvT )->( dbUnLock() )

      end





      if !Empty( ( dbfAlbPrvT )->cNumPed )
         oStock:SetPedPrv( ( dbfAlbPrvT )->cNumPed )
      end





      nRecPed  := ( dbfPedPrvT )->( RecNo() )
      nOrdPed  := ( dbfPedPrvT )->( OrdSetFocus( "cNumAlb" ) )

      if ( dbfPedPrvT )->( dbSeek( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb ) )

         while ( dbfPedPrvT )->cNumAlb == ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT  )->cSufAlb .AND. !( dbfPedPrvT )->( Eof() )

         oStock:SetPedPrv( ( dbfPedPrvT )->cSerPed + Str( ( dbfPedPrvT )->nNumPed ) + ( dbfPedPrvT )->cSufPed )

         ( dbfPedPrvT )->( dbSkip() )

         end

      end

      ( dbfPedPrvT )->( OrdSetFocus( nOrdPed ) )
      ( dbfPedPrvT )->( dbGoTo( nRecPed ) )

      ( dbfAlbPrvT )->( dbSkip() )

   end

   while !( dbfAlbPrvL )->( eof() )

      if !( dbfAlbPrvT )->( dbSeek( ( dbfAlbPrvL )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->cSufAlb ) )

         ( dbfAlbPrvL )->( dbDelete() )

      else

         if Empty( ( dbfAlbPrvL )->cLote ) .AND. !Empty( ( dbfAlbPrvL )->nLote )
            ( dbfAlbPrvL )->cLote      := AllTrim( Str( ( dbfAlbPrvL )->nLote ) )
         end

         if !Empty( ( dbfAlbPrvL )->cRef ) .AND. Empty( ( dbfAlbPrvL )->cCodFam )
            ( dbfAlbPrvL )->cCodFam    := RetFamArt( ( dbfAlbPrvL )->cRef, dbfArticulo )
         end

         if !Empty( ( dbfAlbPrvL )->cRef ) .AND. !Empty( ( dbfAlbPrvL )->cCodFam )
            ( dbfAlbPrvL )->cGrpFam    := cGruFam( ( dbfAlbPrvL )->cCodFam, dbfFamilia )
         end

         if Empty( ( dbfAlbPrvL )->nReq )
            ( dbfAlbPrvL )->nReq       := nPReq( dbfIva, ( dbfAlbPrvL )->nIva )
         end

         if ( dbfAlbPrvL )->lFacturado <> ( dbfAlbPrvT )->lFacturado
            ( dbfAlbPrvL )->lFacturado := ( dbfAlbPrvT )->lFacturado
         end

         if ( dbfAlbPrvL )->dFecAlb <> ( dbfAlbPrvT )->dFecAlb
            ( dbfAlbPrvL )->dFecAlb    := ( dbfAlbPrvT )->dFecAlb
         end

         if !Empty( ( dbfAlbPrvL )->mNumSer )

            aNumSer                       := hb_aTokens( ( dbfAlbPrvL )->mNumSer, "," )
            for each cNumSer in aNumSer
               ( dbfAlbPrvS )->( dbAppend() )
               ( dbfAlbPrvS )->cSerAlb    := ( dbfAlbPrvL )->cSerAlb
               ( dbfAlbPrvS )->nNumAlb    := ( dbfAlbPrvL )->nNumAlb
               ( dbfAlbPrvS )->cSufAlb    := ( dbfAlbPrvL )->cSufAlb
               ( dbfAlbPrvS )->cRef       := ( dbfAlbPrvL )->cRef
               ( dbfAlbPrvS )->cAlmLin    := ( dbfAlbPrvL )->cAlmLin
               ( dbfAlbPrvS )->nNumLin    := ( dbfAlbPrvL )->nNumLin
               ( dbfAlbPrvS )->lFacturado := ( dbfAlbPrvL )->lFacturado
               ( dbfAlbPrvS )->cNumSer    := cNumSer
            next


            ( dbfAlbPrvL )->mNumSer       := ""

         end

         AppRefPrv( ( dbfAlbPrvL )->cRefPrv, ( dbfAlbPrvT )->cCodPrv, ( dbfAlbPrvL )->cRef, ( dbfAlbPrvL )->nDtoLin, ( dbfAlbPrvL )->nDtoPrm, ( dbfAlbPrvT )->cDivAlb, ( dbfAlbPrvL )->nPreDiv, dbfArtPrv )

      end

      ( dbfAlbPrvL )->( dbSkip() )

      SysRefresh()

   end

   while !( dbfAlbPrvI )->( eof() )

      if !( dbfAlbPrvT )->( dbSeek( ( dbfAlbPrvI )->cSerAlb + Str( ( dbfAlbPrvI )->nNumAlb ) + ( dbfAlbPrvI )->cSufAlb ) )
         ( dbfAlbPrvI )->( dbDelete() )
      end

      ( dbfAlbPrvI )->( dbSkip() )

      SysRefresh()

   end



   while !( dbfAlbPrvS )->( eof() )

      if !( dbfAlbPrvT )->( dbSeek( ( dbfAlbPrvS )->cSerAlb + Str( ( dbfAlbPrvS )->nNumAlb ) + ( dbfAlbPrvS )->cSufAlb ) )

         ( dbfAlbPrvS )->( dbDelete() )

      else

         if ( dbfAlbPrvS )->dFecAlb <> ( dbfAlbPrvT )->dFecAlb
            ( dbfAlbPrvS )->dFecAlb    := ( dbfAlbPrvT )->dFecAlb
         end

      end

      ( dbfAlbPrvS )->( dbSkip() )

      SysRefresh()

   end

   RECOVER USING oError

      msgStop( "Imposible sincronizar albaranes de proveedores" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   if !Empty( dbfAlbPrvT ) .AND. ( dbfAlbPrvT )->( Used() )
      ( dbfAlbPrvT )->( dbCloseArea() )
   end

   if !Empty( dbfAlbPrvL ) .AND. ( dbfAlbPrvL )->( Used() )
      ( dbfAlbPrvL )->( dbCloseArea() )
   end

   if !Empty( dbfAlbPrvI ) .AND. ( dbfAlbPrvI )->( Used() )
      ( dbfAlbPrvI )->( dbCloseArea() )
   end

   if !Empty( dbfAlbPrvS ) .AND. ( dbfAlbPrvS )->( Used() )
      ( dbfAlbPrvS )->( dbCloseArea() )
   end

   if !Empty( dbfArticulo ) .AND. ( dbfArticulo )->( Used() )
      ( dbfArticulo )->( dbCloseArea() )
   end

   if !Empty( dbfFamilia ) .AND. ( dbfFamilia )->( Used() )
      ( dbfFamilia )->( dbCloseArea() )
   end

   if !Empty( dbfArtPrv ) .AND. ( dbfArtPrv )->( Used() )
      ( dbfArtPrv )->( dbCloseArea() )
   end

   if !Empty( dbfIva ) .AND. ( dbfIva )->( Used() )
      ( dbfIva )->( dbCloseArea() )
   end

   if !Empty( dbfDiv ) .AND. ( dbfDiv )->( Used() )
      ( dbfDiv )->( dbCloseArea() )
   end

   if !Empty( dbfPedPrvT ) .AND. ( dbfPedPrvT )->( Used() )
      ( dbfPedPrvT )->( dbCloseArea() )
   end

   if !Empty( dbfPedPrvL ) .AND. ( dbfPedPrvL )->( Used() )
      ( dbfPedPrvL )->( dbCloseArea() )
   end

   if !Empty( oStock )
      oStock:end()
   end

   oStock      := nil

return nil



_HB_CLASS TAlbaranesProveedorSenderReciver ; UTILITY FUNCTION TAlbaranesProveedorSenderReciver(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TAlbaranesProveedorSenderReciver" , {TSenderReciverItem():classh} ) ) ; ;

   _HB_MEMBER CreateData(); IIF( .F., s_oClass:ModMethod( "CreateData", @TAlbaranesProveedorSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CreateData", @TAlbaranesProveedorSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER RestoreData(); IIF( .F., s_oClass:ModMethod( "RestoreData", @TAlbaranesProveedorSenderReciver_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "RestoreData", @TAlbaranesProveedorSenderReciver_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER SendData(); IIF( .F., s_oClass:ModMethod( "SendData", @TAlbaranesProveedorSenderReciver_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SendData", @TAlbaranesProveedorSenderReciver_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER ReciveData(); IIF( .F., s_oClass:ModMethod( "ReciveData", @TAlbaranesProveedorSenderReciver_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "ReciveData", @TAlbaranesProveedorSenderReciver_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Process(); IIF( .F., s_oClass:ModMethod( "Process", @TAlbaranesProveedorSenderReciver_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Process", @TAlbaranesProveedorSenderReciver_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TAlbaranesProveedorSenderReciver ;



UTILITY STATIC function TAlbaranesProveedorSenderReciver_CreateData() ; local Self AS CLASS TAlbaranesProveedorSenderReciver := QSelf() AS CLASS TAlbaranesProveedorSenderReciver

   local oBlock
   local oError
   local lSnd        := .F.
   local dbfAlbPrvT
   local dbfAlbPrvL
   local tmpAlbPrvT
   local tmpAlbPrvL
   local cFileName

   if ::oSender:lServer
      cFileName      := "AlbPrv" + StrZero( ::nGetNumberToSend(), 6 ) + ".All"
   else
      cFileName      := "AlbPrv" + StrZero( ::nGetNumberToSend(), 6 ) + "." + RetSufEmp()
   end

   ::oSender:SetText( "Enviando albaranes a proveedores" )

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbProvT.Dbf" ), ( cCheckArea( "AlbProvT", @dbfAlbPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbProvT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbProvL.Dbf" ), ( cCheckArea( "AlbProvL", @dbfAlbPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbProvL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end





   rxAlbPrv( cPatSnd() )

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "AlbProvT.Dbf" ), ( cCheckArea( "AlbProvT", @tmpAlbPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "AlbProvT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "AlbProvL.Dbf" ), ( cCheckArea( "AlbProvL", @tmpAlbPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "AlbProvL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   if !Empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( dbfAlbPrvT )->( lastrec() )
   end

   while !( dbfAlbPrvT )->( eof() )

      if ( dbfAlbPrvT )->lSndDoc

         lSnd  := .T.

         dbPass( dbfAlbPrvT, tmpAlbPrvT, .T. )

         ::oSender:SetText( ( dbfAlbPrvT )->cSerAlb + "/" + AllTrim( Str( ( dbfAlbPrvT )->nNumAlb ) ) + "/" + AllTrim( ( dbfAlbPrvT )->cSufAlb ) + "; " + Dtoc( ( dbfAlbPrvT )->dFecAlb ) + "; " + AllTrim( ( dbfAlbPrvT )->cCodPrv ) + "; " + ( dbfAlbPrvT )->cNomPrv )

         if ( dbfAlbPrvL )->( dbSeek( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb ) )
            while ( ( dbfAlbPrvL )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->CSUFAlb ) == ( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->CSUFAlb ) .AND. !( dbfAlbPrvL )->( eof() )
               dbPass( dbfAlbPrvL, tmpAlbPrvL, .T. )
               ( dbfAlbPrvL )->( dbSkip() )
            end
         end

      end

      ( dbfAlbPrvT )->( dbSkip() )

      if !Empty( ::oSender:oMtr )
         ::oSender:oMtr:Set( ( dbfAlbPrvT )->( OrdKeyNo() ) )
      end

   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos de albaranes de proveedores" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfAlbPrvT )->( dbCloseArea() )
   ( dbfAlbPrvL )->( dbCloseArea() )
   ( tmpAlbPrvT )->( dbCloseArea() )
   ( tmpAlbPrvL )->( dbCloseArea() )

   dbfAlbPrvT  := nil
   dbfAlbPrvL  := nil
   tmpAlbPrvT  := nil
   tmpAlbPrvL  := nil





   if lSnd

      ::oSender:SetText( "Comprimiendo albaranes de proveedores" )

      if ::oSender:lZipData( cFileName )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay albaranes de proveedores para enviar" )

   end

Return ( Self )



UTILITY STATIC function TAlbaranesProveedorSenderReciver_RestoreData() ; local Self AS CLASS TAlbaranesProveedorSenderReciver := QSelf() AS CLASS TAlbaranesProveedorSenderReciver

   local oBlock
   local oError
   local dbfAlbPrvT

   if ::lSuccesfullSend





      oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbProvT.Dbf" ), ( cCheckArea( "AlbProvT", @dbfAlbPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbProvT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

         lSelectAll( nil, dbfAlbPrvT, "lSndDoc", .F., .T., .F. )

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos de agentes" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

      ( dbfAlbPrvT )->( dbCloseArea() )

   end

Return ( Self )



UTILITY STATIC function TAlbaranesProveedorSenderReciver_SendData() ; local Self AS CLASS TAlbaranesProveedorSenderReciver := QSelf() AS CLASS TAlbaranesProveedorSenderReciver

   local cFileName   := "AlbPrv" + StrZero( ::nGetNumberToSend(), 6 ) + "." + RetSufEmp()

   if file( cPatOut() + cFileName )





      if ftpSndFile( cPatOut() + cFileName, cFileName, 2000, ::oSender )
         ::lSuccesfullSend := .T.
         ::IncNumberToSend()
         ::oSender:SetText( "Fichero enviado " + cFileName  )
      else
         ::oSender:SetText( "ERROR al enviar fichero" )
      end

   end

Return ( Self )



UTILITY STATIC function TAlbaranesProveedorSenderReciver_ReciveData() ; local Self AS CLASS TAlbaranesProveedorSenderReciver := QSelf() AS CLASS TAlbaranesProveedorSenderReciver

   local n
   local aExt        := aRetDlgEmp()





   ::oSender:SetText( "Recibiendo albaranes de proveedores" )

   for n := 1 to len( aExt )
      ftpGetFiles( "AlbPrv*." + aExt[ n ], cPatIn(), 2000, ::oSender )
   next

   ::oSender:SetText( "Albaranes de proveedores recibidos" )

Return Self



UTILITY STATIC function TAlbaranesProveedorSenderReciver_Process() ; local Self AS CLASS TAlbaranesProveedorSenderReciver := QSelf() AS CLASS TAlbaranesProveedorSenderReciver

   local m
   local dbfAlbPrvT
   local dbfAlbPrvL
   local tmpAlbPrvT
   local tmpAlbPrvL
   local aFiles      := Directory( cPatIn() + "AlbPrv*.*" )
   local oBlock
   local oError

   for m := 1 to len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )

      BEGIN SEQUENCE





      if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )

         dbUseArea(.T., cDriver(), cPatSnd() + "AlbProvT.Dbf", cCheckArea( "AlbProvT", @tmpAlbPrvT ), .F., .T. )
         ( tmpAlbPrvT )->( ordListAdd( cPatSnd() + "AlbProvT.Cdx" ) )

         dbUseArea(.T., cDriver(), cPatSnd() + "AlbProvL.Dbf", cCheckArea( "AlbProvL", @tmpAlbPrvL ), .F., .T. )
         ( tmpAlbPrvL )->( ordListAdd( cPatSnd() + "AlbProvL.Cdx" ) )

         dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbProvT.Dbf" ), ( cCheckArea( "AlbProvT", @dbfAlbPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
         if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbProvT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

         dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbProvL.Dbf" ), ( cCheckArea( "AlbProvL", @dbfAlbPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
         if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbProvL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

         WHILE ( tmpAlbPrvT )->( !eof() )






            if lValidaOperacion( ( tmpAlbPrvT )->dFecAlb, .F. ) .AND.  !( dbfAlbPrvT )->( dbSeek( ( tmpAlbPrvT )->cSerAlb + Str( ( tmpAlbPrvT )->nNumAlb ) + ( tmpAlbPrvT )->cSufAlb ) )

               dbPass( tmpAlbPrvT, dbfAlbPrvT, .T. )
               ::oSender:SetText( "Añadido     : " + ( tmpAlbPrvT )->cSerAlb + "/" + AllTrim( Str( ( tmpAlbPrvT )->nNumAlb ) ) + "/" + AllTrim( ( tmpAlbPrvT )->cSufAlb ) + "; " + Dtoc( ( tmpAlbPrvT )->dFecAlb ) + "; " + AllTrim( ( dbfAlbPrvT )->cCodPrv ) + "; " + ( dbfAlbPrvT )->cNomPrv )

               if ( tmpAlbPrvL )->( dbSeek( ( tmpAlbPrvT )->cSerAlb + Str( ( tmpAlbPrvT )->nNumAlb ) + ( tmpAlbPrvT )->CSUFAlb ) )

                  while ( ( tmpAlbPrvL )->cSerAlb + Str( ( tmpAlbPrvL )->nNumAlb ) + ( tmpAlbPrvL )->CSUFAlb ) == ( ( tmpAlbPrvT )->cSerAlb + Str( ( tmpAlbPrvT )->nNumAlb ) + ( tmpAlbPrvT )->CSUFAlb ) .AND. !( tmpAlbPrvL )->( eof() )
                     dbPass( tmpAlbPrvL, dbfAlbPrvL, .T. )
                     ( tmpAlbPrvL )->( dbSkip() )
                  end

               end

            else

               ::oSender:SetText( "Desestimado : " + ( tmpAlbPrvT )->cSerAlb + "/" + AllTrim( Str( ( tmpAlbPrvT )->nNumAlb ) ) + "/" + AllTrim( ( tmpAlbPrvT )->cSufAlb ) + "; " + Dtoc( ( tmpAlbPrvT )->dFecAlb ) + "; " + AllTrim( ( dbfAlbPrvT )->cCodPrv ) + "; " + ( dbfAlbPrvT )->cNomPrv )

            end

            ( tmpAlbPrvT )->( dbSkip() )

         end

         ( dbfAlbPrvT )->( dbCloseArea() )
         ( dbfAlbPrvL )->( dbCloseArea() )
         ( tmpAlbPrvT )->( dbCloseArea() )
         ( tmpAlbPrvL )->( dbCloseArea() )

      end

      ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

      RECOVER USING oError

         ( dbfAlbPrvT )->( dbCloseArea() )
         ( dbfAlbPrvL )->( dbCloseArea() )
         ( tmpAlbPrvT )->( dbCloseArea() )
         ( tmpAlbPrvL )->( dbCloseArea() )

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

   next

Return Self



STATIC FUNCTION GrpPed( aGet, aTmp, oBrw )

   local a
   local oDlg
   local nDiv
   local nOrdAnt
   local oBrwLin
   local nNumLin
   local nTotPed
   local nTotRec
   local nTotPdt
   local nItem       := 1
   local nOffSet     := 0
   local cDesAlb     := ""
   local cCodPrv     := aGet[6]:varGet()

   aNumAlb           := {}
   aAlbaranes        := {}



   if Empty( cCodPrv )
      msgStop( "Es necesario codificar un proveedor", "Agrupar pedidos" )
      return .T.
   end




   nOrdAnt           := ( dbfPedPrvT )->( ordSetFocus( "CCODPRV" ) )



   if !( dbfPedPrvT )->( dbSeek( cCodPrv ) )
       msgStop( "No existen pedidos de este proveedor" )
      RETURN .T.
   else

      while ( dbfPedPrvT )->cCodPrv == cCodPrv .AND. ( dbfPedPrvT )->( !eof() )

         if ( dbfPedPrvT )->nEstado <> 3







            aAdd( aAlbaranes, {  .F. , ( if( ( dbfPedPrvT )->nEstado <= 1, 3, ( dbfPedPrvT )->nEstado ) ), ( dbfPedPrvT )->cSerPed + Str( ( dbfPedPrvT )->nNumPed ) + ( dbfPedPrvT )->cSufPed, ( dbfPedPrvT )->dFecPed , ( dbfPedPrvT )->cCodPrv , ( dbfPedPrvT )->cNomPrv , ( dbfPedPrvT )->cNumPedCli } )

         endif

         ( dbfPedPrvT )->( dbSkip( 1 ) )

      end

   end

   if Len( aAlbaranes ) == 0
      msgStop( "No existen pedidos de este proveedor" )
      return .T.
   end



   ( dbfPedPrvT )->( ordSetFocus( nOrdAnt ) )




   oDlg = TDialog():New(,,,, "Seleccionando pedidos de : " + Rtrim( cCodPrv ) + "-" + Rtrim( RetProvee( cCodPrv ) ), "SET_ALBARAN",, .F.,,,,,, .F.,,,,,, .F., )

      oBrwLin                        := IXBrowse():New( oDlg )

      oBrwLin:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwLin:SetArray( aAlbaranes, , , .F. )

      oBrwLin:nMarqueeStyle          := 5
      oBrwLin:lRecordSelector        := .F.
      oBrwLin:lHScroll               := .F.
      oBrwLin:cName                  := "Agrupar pedidos proveedor"

      oBrwLin:bLDblClick             := {|| aAlbaranes[ oBrwLin:nArrayAt, 1 ] := !aAlbaranes[ oBrwLin:nArrayAt, 1 ], oBrwLin:refresh() }

      oBrwLin:CreateFromResource( 130 )

      with object ( oBrwLin:AddCol() )
         :cHeader                   := "Se. seleccionado"
         :bStrData                  := {|| "" }
         :bEditValue                := {|| aAlbaranes[ oBrwLin:nArrayAt, 1 ] }
         :nWidth                    := 20
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader                   := "Es. estado"
         :bStrData                  := {|| "" }
         :bBmpData                  := {|| aAlbaranes[ oBrwLin:nArrayAt, 2 ] }
         :nWidth                    := 20
         :AddResource( "Bullet_Square_Red_16" )
         :AddResource( "Bullet_Square_Yellow_16" )
         :AddResource( "Bullet_Square_Green_16" )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader                   := "Número"
         :bStrData                  := {|| Trans( aAlbaranes[ oBrwLin:nArrayAt, 3 ], "@R #/999999999/##" ) }
         :nWidth                    := 75
      end

      with object ( oBrwLin:AddCol() )
         :cHeader                   := "Fecha"
         :bStrData                  := {|| Dtoc( aAlbaranes[ oBrwLin:nArrayAt, 4 ] ) }
         :nWidth                    := 75
      end

      with object ( oBrwLin:AddCol() )
         :cHeader                   := "Proveedor"
         :bStrData                  := {|| aAlbaranes[ oBrwLin:nArrayAt, 5 ] + Space(1) + aAlbaranes[ oBrwLin:nArrayAt, 6 ] }
         :nWidth                    := 400
      end

      with object ( oBrwLin:AddCol() )
         :cHeader                   := "Ped. cliente"
         :bStrData                  := {|| Trans( aAlbaranes[ oBrwLin:nArrayAt, 7 ], "@R #/999999999/##" ) }
         :nWidth                    := 75
         :lHide                     := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader                   := "Cliente"
         :bStrData                  := {|| GetCliente( aAlbaranes[ oBrwLin:nArrayAt, 7 ] ) }
         :nWidth                    := 150
         :lHide                     := .T.
      end






      TButton():ReDefine( 514, {||(  aAlbaranes[ oBrwLin:nArrayAt, 1 ] := !aAlbaranes[ oBrwLin:nArrayAt, 1 ], oBrwLin:refresh(), oBrwLin:setFocus() )}, oDlg,,, .F.,,,, .F. )






      TButton():ReDefine( 516, {||(  aEval( aAlbaranes, { |aItem| aItem[1] := .T. } ), oBrwLin:refresh(), oBrwLin:setFocus() )}, oDlg,,, .F.,,,, .F. )






      TButton():ReDefine( 517, {||(  aEval( aAlbaranes, { |aItem| aItem[1] := .F. } ), oBrwLin:Refresh(), oBrwLin:SetFocus() )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

   oDlg:bStart       := {|| oBrwLin:Load() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult <> 1
      aAlbaranes  := {}
   end



   IF oDlg:nResult == 1 .AND. Len( aAlbaranes ) >= 1



      for nItem := 1 to Len( aAlbaranes )
         if ( aAlbaranes[ nItem, 1 ] )
            aAdd( aNumAlb, aAlbaranes[ nItem, 3 ] )
         end
      next

      FOR nItem := 1 TO Len( aAlbaranes )



         IF ( dbfPedPrvT )->( dbSeek( aAlbaranes[ nItem, 3] ) ) .AND. aAlbaranes[ nItem, 1]

            if ( dbfPedPrvT )->lRecargo
               aTmp[ 25 ] := .T.
               aGet[ 25 ]:Refresh()
            end

         end



         IF ( dbfPedPrvL )->( dbSeek( aAlbaranes[ nItem, 3] ) ) .AND. aAlbaranes[ nItem, 1]



            ++nOffSet
            nNumLin              := nil

            if lNumPed()
            (dbfTmp)->( dbAppend() )
            cDesAlb              := "Pedido Nº " + Alltrim( Trans( aAlbaranes[ nItem, 3 ], "@R #/999999999/##" ) )
            cDesAlb              += " - Fecha " + Dtoc( aAlbaranes[ nItem, 4] )
            (dbfTmp)->mLngDes    := cDesAlb
            (dbfTmp)->lControl   := .T.
            (dbfTmp)->nNumLin    := nOffSet
            end



            WHILE ( ( dbfPedPrvL )->cSerPed + Str( ( dbfPedPrvL )->nNumPed ) + ( dbfPedPrvL )->cSufPed == aAlbaranes[ nItem, 3 ] )

               if aAlbaranes[ nItem, 2 ] == 2

                  nTotPed              := nTotNPedPrv( dbfPedPrvL )
                  nTotRec              := nUnidadesRecibidasPedPrv( aAlbaranes[ nItem, 3 ], ( dbfPedPrvL )->cRef, ( dbfPedPrvL )->cCodPr1, ( dbfPedPrvL )->cCodPr2, ( dbfPedPrvL )->cRefPrv, ( dbfPedPrvL )->cDetalle, dbfAlbPrvL )
                  nTotPdt              := nTotPed - nTotRec

                  if nTotPdt > 0

                     if nNumLin <> (dbfPedPrvL)->nNumLin
                        ++nOffSet
                        nNumLin           := (dbfPedPrvL)->nNumLin
                     end

                     (dbfTmp)->( dbAppend() )
                     (dbfTmp)->nNumAlb    := 0
                     (dbfTmp)->nNumLin    := nOffSet
                     (dbfTmp)->cRef       := (dbfPedPrvL)->cRef
                     (dbfTmp)->cRefPrv    := (dbfPedPrvL)->cRefPrv
                     (dbfTmp)->cDetalle   := (dbfPedPrvL)->cDetalle
                     (dbfTmp)->mLngDes    := (dbfPedPrvL)->mLngDes
                     (dbfTmp)->nPreDiv    := (dbfPedPrvL)->nPreDiv
                     (dbfTmp)->cUnidad    := (dbfPedPrvL)->cUnidad
                     (dbfTmp)->nIva       := (dbfPedPrvL)->nIva
                     (dbfTmp)->nReq       := (dbfPedPrvL)->nReq
                     (dbfTmp)->nDtoLin    := (dbfPedPrvL)->nDtoLin
                     (dbfTmp)->nDtoPrm    := (dbfPedPrvL)->nDtoPrm
                     (dbfTmp)->cCodPed    := aAlbaranes[ nItem, 3]
                     (dbfTmp)->nUndKit    := (dbfPedPrvL)->nUndKit
                     (dbfTmp)->lKitArt    := (dbfPedPrvL)->lKitArt
                     (dbfTmp)->lKitChl    := (dbfPedPrvL)->lKitChl
                     (dbfTmp)->lKitPrc    := (dbfPedPrvL)->lKitPrc
                     (dbfTmp)->lImpLin    := (dbfPedPrvL)->lImpLin
                     (dbfTmp)->cCodPr1    := (dbfPedPrvL)->cCodPr1
                     (dbfTmp)->cCodPr2    := (dbfPedPrvL)->cCodPr2
                     (dbfTmp)->cValPr1    := (dbfPedPrvL)->cValPr1
                     (dbfTmp)->cValPr2    := (dbfPedPrvL)->cValPr2
                     (dbfTmp)->nCanPed    := (dbfPedPrvL)->nCanPed
                     (dbfTmp)->nDtoRap    := (dbfPedPrvL)->nDtoRap
                     (dbfTmp)->mNumSer    := (dbfPedPrvL)->mNumSer
                     (dbfTmp)->lLote      := (dbfPedPrvL)->lLote
                     (dbfTmp)->nLote      := (dbfPedPrvL)->nLote
                     (dbfTmp)->cLote      := (dbfPedPrvL)->cLote
                     (dbfTmp)->nFacCnv    := (dbfPedPrvL)->nFacCnv
                     (dbfTmp)->cAlmLin    := (dbfPedPrvL)->cAlmLin
                     (dbfTmp)->nCtlStk    := (dbfPedPrvL)->nCtlStk
                     (dbfTmp)->lControl   := (dbfPedPrvL)->lControl
                     (dbfTmp)->cNumPed    := aAlbaranes[ nItem, 7 ]
                     (dbfTmp)->cUnidad    := (dbfPedPrvL)->cUnidad
                     (dbfTmp)->nNumMed    := (dbfPedPrvL)->nNumMed
                     (dbfTmp)->nMedUno    := (dbfPedPrvL)->nMedUno
                     (dbfTmp)->nMedDos    := (dbfPedPrvL)->nMedDos
                     (dbfTmp)->nMedTre    := (dbfPedPrvL)->nMedTre

                     if dbSeekInOrd( ( dbfPedPrvL )->cRef, "Codigo", dbfArticulo )

                        ( dbfTmp )->lIvaLin  := ( dbfArticulo )->lIvaInc

                        ( dbfTmp )->nBnfLin1 := ( dbfArticulo )->Benef1
                        ( dbfTmp )->nBnfLin2 := ( dbfArticulo )->Benef2
                        ( dbfTmp )->nBnfLin3 := ( dbfArticulo )->Benef3
                        ( dbfTmp )->nBnfLin4 := ( dbfArticulo )->Benef4
                        ( dbfTmp )->nBnfLin5 := ( dbfArticulo )->Benef5
                        ( dbfTmp )->nBnfLin6 := ( dbfArticulo )->Benef6

                        ( dbfTmp )->lBnfLin1 := ( dbfArticulo )->lBnf1
                        ( dbfTmp )->lBnfLin2 := ( dbfArticulo )->lBnf2
                        ( dbfTmp )->lBnfLin3 := ( dbfArticulo )->lBnf3
                        ( dbfTmp )->lBnfLin4 := ( dbfArticulo )->lBnf4
                        ( dbfTmp )->lBnfLin5 := ( dbfArticulo )->lBnf5
                        ( dbfTmp )->lBnfLin6 := ( dbfArticulo )->lBnf6

                        ( dbfTmp )->nBnfSbr1 := ( dbfArticulo )->nBnfSbr1
                        ( dbfTmp )->nBnfSbr2 := ( dbfArticulo )->nBnfSbr2
                        ( dbfTmp )->nBnfSbr3 := ( dbfArticulo )->nBnfSbr3
                        ( dbfTmp )->nBnfSbr4 := ( dbfArticulo )->nBnfSbr4
                        ( dbfTmp )->nBnfSbr5 := ( dbfArticulo )->nBnfSbr5
                        ( dbfTmp )->nBnfSbr6 := ( dbfArticulo )->nBnfSbr6

                        ( dbfTmp )->nPvpLin1 := ( dbfarticulo )->pVenta1
                        ( dbfTmp )->nPvpLin2 := ( dbfArticulo )->pVenta2
                        ( dbfTmp )->nPvpLin3 := ( dbfArticulo )->pVenta3
                        ( dbfTmp )->nPvpLin4 := ( dbfArticulo )->pVenta4
                        ( dbfTmp )->nPvpLin5 := ( dbfArticulo )->pVenta5
                        ( dbfTmp )->nPvpLin6 := ( dbfArticulo )->pVenta6

                        ( dbfTmp )->nIvaLin1 := ( dbfArticulo )->pVtaIva1
                        ( dbfTmp )->nIvaLin2 := ( dbfArticulo )->pVtaIva2
                        ( dbfTmp )->nIvaLin3 := ( dbfArticulo )->pVtaIva3
                        ( dbfTmp )->nIvaLin4 := ( dbfArticulo )->pVtaIva4
                        ( dbfTmp )->nIvaLin5 := ( dbfArticulo )->pVtaIva5
                        ( dbfTmp )->nIvaLin6 := ( dbfArticulo )->pVtaIva6

                     end


                  if lCalCaj()

                     if nTotRec <> 0

                        nDiv  := Mod( nTotPdt, ( dbfPedPrvL )->nUniCaja )
                        if nDiv == 0 .AND. ( dbfPedPrvL )->nCanPed <> 0
                           ( dbfTmp )->nCanEnt  := Div( nTotPdt, ( dbfPedPrvL )->nUniCaja )
                           ( dbfTmp )->nUniCaja := ( dbfPedPrvL )->nUniCaja
                        else
                           ( dbfTmp )->nCanEnt  := 0
                           ( dbfTmp )->nUniCaja := nTotPdt
                        end

                     else

                        ( dbfTmp )->nCanEnt     := ( dbfPedPrvL )->nCanPed
                        ( dbfTmp )->nUniCaja    := ( dbfPedPrvL )->nUniCaja

                     end

                  else

                     ( dbfTmp )->nUniCaja       := nTotPdt

                  end

                  end

               else

                  if nNumLin <> (dbfPedPrvL)->nNumLin
                     ++nOffSet
                     nNumLin           := (dbfPedPrvL)->nNumLin
                  end

                  (dbfTmp)->( dbAppend() )
                  (dbfTmp)->nNumAlb    := 0
                  (dbfTmp)->nNumLin    := nOffSet
                  (dbfTmp)->cRef       := (dbfPedPrvL)->cRef
                  (dbfTmp)->cRefPrv    := (dbfPedPrvL)->cRefPrv
                  (dbfTmp)->cDetalle   := (dbfPedPrvL)->cDetalle
                  (dbfTmp)->mLngDes    := (dbfPedPrvL)->mLngDes
                  (dbfTmp)->nPreDiv    := (dbfPedPrvL)->nPreDiv
                  (dbfTmp)->cUnidad    := (dbfPedPrvL)->cUnidad
                  (dbfTmp)->nIva       := (dbfpedPrvl)->nIva
                  (dbfTmp)->nReq       := (dbfpedPrvl)->nReq
                  (dbfTmp)->nDtoLin    := (dbfpedPrvl)->nDtoLin
                  (dbfTmp)->nDtoPrm    := (dbfPedPrvL)->nDtoPrm
                  (dbfTmp)->cCodPed    := aAlbaranes[ nItem, 3]
                  (dbfTmp)->nUniCaja   := (dbfPedPrvL)->nUniCaja
                  (dbfTmp)->nCanEnt    := (dbfPedPrvL)->nCanEnt
                  (dbfTmp)->nUndKit    := (dbfPedPrvL)->nUndKit
                  (dbfTmp)->lKitArt    := (dbfPedPrvL)->lKitArt
                  (dbfTmp)->lKitChl    := (dbfPedPrvL)->lKitChl
                  (dbfTmp)->lKitPrc    := (dbfPedPrvL)->lKitPrc
                  (dbfTmp)->lImpLin    := (dbfPedPrvL)->lImpLin
                  (dbfTmp)->cCodPr1    := (dbfPedPrvL)->cCodPr1
                  (dbfTmp)->cCodPr2    := (dbfPedPrvL)->cCodPr2
                  (dbfTmp)->cValPr1    := (dbfPedPrvL)->cValPr1
                  (dbfTmp)->cValPr2    := (dbfPedPrvL)->cValPr2
                  (dbfTmp)->nCanPed    := (dbfPedPrvL)->nCanPed
                  (dbfTmp)->nDtoRap    := (dbfPedPrvL)->nDtoRap
                  (dbfTmp)->mNumSer    := (dbfPedPrvL)->mNumSer
                  (dbfTmp)->lLote      := (dbfPedPrvL)->lLote
                  (dbfTmp)->nLote      := (dbfPedPrvL)->nLote
                  (dbfTmp)->cLote      := (dbfPedPrvL)->cLote
                  (dbfTmp)->nFacCnv    := (dbfPedPrvL)->nFacCnv
                  (dbfTmp)->cAlmLin    := (dbfPedPrvL)->cAlmLin
                  (dbfTmp)->nCtlStk    := (dbfPedPrvL)->nCtlStk
                  (dbfTmp)->lControl   := (dbfPedPrvL)->lControl
                  (dbfTmp)->mObsLin    := (dbfPedPrvL)->mObsLin
                  (dbfTmp)->cNumPed    := aAlbaranes[ nItem, 7 ]
                  (dbfTmp)->cUnidad    := (dbfPedPrvL)->cUnidad
                  (dbfTmp)->nNumMed    := (dbfPedPrvL)->nNumMed
                  (dbfTmp)->nMedUno    := (dbfPedPrvL)->nMedUno
                  (dbfTmp)->nMedDos    := (dbfPedPrvL)->nMedDos
                  (dbfTmp)->nMedTre    := (dbfPedPrvL)->nMedTre

                  if dbSeekInOrd( ( dbfPedPrvL )->cRef, "Codigo", dbfArticulo )

                     ( dbfTmp )->lIvaLin  := ( dbfArticulo )->lIvaInc

                     ( dbfTmp )->nBnfLin1 := ( dbfArticulo )->Benef1
                     ( dbfTmp )->nBnfLin2 := ( dbfArticulo )->Benef2
                     ( dbfTmp )->nBnfLin3 := ( dbfArticulo )->Benef3
                     ( dbfTmp )->nBnfLin4 := ( dbfArticulo )->Benef4
                     ( dbfTmp )->nBnfLin5 := ( dbfArticulo )->Benef5
                     ( dbfTmp )->nBnfLin6 := ( dbfArticulo )->Benef6

                     ( dbfTmp )->lBnfLin1 := ( dbfArticulo )->lBnf1
                     ( dbfTmp )->lBnfLin2 := ( dbfArticulo )->lBnf2
                     ( dbfTmp )->lBnfLin3 := ( dbfArticulo )->lBnf3
                     ( dbfTmp )->lBnfLin4 := ( dbfArticulo )->lBnf4
                     ( dbfTmp )->lBnfLin5 := ( dbfArticulo )->lBnf5
                     ( dbfTmp )->lBnfLin6 := ( dbfArticulo )->lBnf6

                     ( dbfTmp )->nBnfSbr1 := ( dbfArticulo )->nBnfSbr1
                     ( dbfTmp )->nBnfSbr2 := ( dbfArticulo )->nBnfSbr2
                     ( dbfTmp )->nBnfSbr3 := ( dbfArticulo )->nBnfSbr3
                     ( dbfTmp )->nBnfSbr4 := ( dbfArticulo )->nBnfSbr4
                     ( dbfTmp )->nBnfSbr5 := ( dbfArticulo )->nBnfSbr5
                     ( dbfTmp )->nBnfSbr6 := ( dbfArticulo )->nBnfSbr6

                     ( dbfTmp )->nPvpLin1 := ( dbfarticulo )->pVenta1
                     ( dbfTmp )->nPvpLin2 := ( dbfArticulo )->pVenta2
                     ( dbfTmp )->nPvpLin3 := ( dbfArticulo )->pVenta3
                     ( dbfTmp )->nPvpLin4 := ( dbfArticulo )->pVenta4
                     ( dbfTmp )->nPvpLin5 := ( dbfArticulo )->pVenta5
                     ( dbfTmp )->nPvpLin6 := ( dbfArticulo )->pVenta6

                     ( dbfTmp )->nIvaLin1 := ( dbfArticulo )->pVtaIva1
                     ( dbfTmp )->nIvaLin2 := ( dbfArticulo )->pVtaIva2
                     ( dbfTmp )->nIvaLin3 := ( dbfArticulo )->pVtaIva3
                     ( dbfTmp )->nIvaLin4 := ( dbfArticulo )->pVtaIva4
                     ( dbfTmp )->nIvaLin5 := ( dbfArticulo )->pVtaIva5
                     ( dbfTmp )->nIvaLin6 := ( dbfArticulo )->pVtaIva6

                  end

               end

               ( dbfPedPrvL )->( dbSkip( 1 ) )

            end

            ( dbfTmp )->( dbGoTop() )


            oBrw:refresh()

         end

      NEXT



      aGet[29]:Disable()



      nTotAlbPrv( nil, dbfAlbPrvT, dbfTmp, dbfIva, dbfDiv, aTmp )

  end

RETURN .T.



Static Function nEstadoIncidencia( cNumAlb )

   local nEstado  := 0

   if ( dbfAlbPrvI )->( dbSeek( cNumAlb ) )

      while ( dbfAlbPrvI )->cSerAlb + Str( ( dbfAlbPrvI )->nNumAlb ) + ( dbfAlbPrvI )->cSufAlb == cNumAlb .AND. !( dbfAlbPrvI )->( Eof() )

         if ( dbfAlbPrvI )->lListo
            do case
               case nEstado == 0 .OR. nEstado == 3
                    nEstado := 3
               case nEstado == 1
                    nEstado := 2
            end
         else
            do case
               case nEstado == 0
                    nEstado := 1
               case nEstado == 3
                    nEstado := 2
            end
         end

         ( dbfAlbPrvI )->( dbSkip() )

      end

   end

Return ( nEstado )



Function AppAlbPrv( cCodPrv, cCodArt, lOpenBrowse )

   local nLevel         := nLevelUsr( "01047" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 2 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbPrv( nil, nil, cCodPrv, cCodArt )
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( .T. )
         WinAppRec( nil, bEdtRec, dbfAlbPrvT, cCodPrv, cCodArt )
         CloseFiles()
      end

   end

RETURN .T.



FUNCTION EdtAlbPrv( nNumAlb, lOpenBrowse )

   local nLevel         := nLevelUsr( "01047" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbPrv()
         if dbSeekInOrd( nNumAlb, "nNumAlb", dbfAlbPrvT )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra albaran" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumAlb, "nNumAlb", dbfAlbPrvT )
            WinEdtRec( nil, bEdtRec, dbfAlbPrvT )
         else
            MsgStop( "No se encuentra albaran" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION ZooAlbPrv( nNumAlb, lOpenBrowse )

   local nLevel         := nLevelUsr( "01047" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbPrv()
         if dbSeekInOrd( nNumAlb, "nNumAlb", dbfAlbPrvT )
            oWndBrw:RecZoom()
         else
            MsgStop( "No se encuentra albaran" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumAlb, "nNumAlb", dbfAlbPrvT )
            WinZooRec( nil, bEdtRec, dbfAlbPrvT )
         else
            MsgStop( "No se encuentra albaran" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION DelAlbPrv( nNumAlb, lOpenBrowse )

   local nLevel         := nLevelUsr( "01047" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbPrv()
         if dbSeekInOrd( nNumAlb, "nNumAlb", dbfAlbPrvT )
            WinDelRec( nil, dbfAlbPrvT, {|| QuiAlbPrv() } )
         else
            MsgStop( "No se encuentra albaran" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumAlb, "nNumAlb", dbfAlbPrvT )
            WinDelRec( nil, dbfAlbPrvT, {|| QuiAlbPrv() } )
         else
            MsgStop( "No se encuentra albaran" )
         end
         CloseFiles()
      end

   end

Return nil



FUNCTION PrnAlbPrv( nNumAlb, lOpenBrowse )

   local nLevel         := nLevelUsr( "01047" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbPrv()
         if dbSeekInOrd( nNumAlb, "nNumAlb", dbfAlbPrvT )
            GenAlbPrv( 1 )
         else
            MsgStop( "No se encuentra albaran" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumAlb, "nNumAlb", dbfAlbPrvT )
            GenAlbPrv( 1 )
         else
            MsgStop( "No se encuentra albaran" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION VisAlbPrv( nNumAlb, lOpenBrowse )

   local nLevel         := nLevelUsr( "01047" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if AlbPrv()
         if dbSeekInOrd( nNumAlb, "nNumAlb", dbfAlbPrvT )
            GenAlbPrv( 2 )
         else
            MsgStop( "No se encuentra albaran" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumAlb, "nNumAlb", dbfAlbPrvT )
            GenAlbPrv( 2 )
         else
            MsgStop( "No se encuentra albaran" )
         end
         CloseFiles()
      end

   end

Return nil



Static Function GetCliente( cNumPed )

   local oBlock
   local oError
   local cCliente := ""
   local dbfPedCliT

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIT.DBF" ), ( cCheckArea( "PEDCLIT", @dbfPedCliT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
   ( dbfPedCliT )->( OrdSetFocus( "NNUMPED" ) )

   if ( dbfPedCliT )->( dbSeek( cNumPed ) )

      cCliente := AllTrim( ( dbfPedCliT )->cCodCli ) + " - " + AllTrim( ( dbfPedCliT )->cNomCli )

   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos de agentes" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfPedCliT )->( dbCloseArea() )

Return cCliente



STATIC FUNCTION ValidaMedicion( aTmp, aGet )

   local cNewUndMed  := aGet[ 13 ]:VarGet





   if ( Empty( cOldUndMed ) .OR. cOldUndMed <> cNewUndMed )

      if oUndMedicion:oDbf:Seek( aTmp[ 13 ] )

         if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
            if !Empty( aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:cText( ( dbfArticulo )->nLngArt )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:Show()
            else
               aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]  := ( dbfArticulo )->nLngArt
            end
         else
            if !Empty( aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:Hide()
            else
               aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
            if !Empty( aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:cText( ( dbfArticulo )->nAltArt )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:Show()
            else
               aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]  := ( dbfArticulo )->nAltArt
            end

         else
            if !Empty( aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:Hide()
            else
                 aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
            if !Empty( aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:cText( ( dbfArticulo ) ->nAncArt )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:Show()
            else
               aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]  := ( dbfArticulo )->nAncArt
            end
         else
            if !Empty( aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:Hide()
            else
               aTmp[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]  := 0
            end
         end

      else

         if !Empty( aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ] )
            aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:Hide()
            aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ] )
            aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:Hide()
            aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ] )
            aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:Hide()
            aGet[ ( dbfAlbPrvL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
         end

      end

      cOldUndMed := cNewUndMed

   end

RETURN .T.



FUNCTION SetFacturadoAlbaranProveedor( lFacturado, oStock, oBrw, cAlbPrvT, cAlbPrvL, cAlbPrvS, cNumFac )

   local nRec
   local nOrd

   IIF( lFacturado == nil, lFacturado := .F., ) ;
   IIF( cNumFac == nil, cNumFac := Space( 12 ), ) ;
   IIF( cAlbPrvT == nil, cAlbPrvT := dbfAlbPrvT, ) ;
   IIF( cAlbPrvL == nil, cAlbPrvL := dbfAlbPrvL, ) ;
   IIF( cAlbPrvS == nil, cAlbPrvS := dbfAlbPrvS, ) ;

   CursorWait()





   if dbDialogLock( cAlbPrvT )

      ( cAlbPrvT )->lFacturado := lFacturado
      ( cAlbPrvT )->cNumFac    := cNumFac
      ( cAlbPrvT )->( dbUnlock() )

   end





   nRec                 := ( cAlbPrvL )->( Recno() )
   nOrd                 := ( cAlbPrvL )->( OrdSetFocus( "nNumAlb" ) )

   if ( cAlbPrvL )->( dbSeek( ( cAlbPrvT )->cSerAlb + Str( ( cAlbPrvT )->nNumAlb ) + ( cAlbPrvT )->cSufAlb ) )

      while ( cAlbPrvT )->cSerAlb + Str( ( cAlbPrvT )->nNumAlb ) + ( cAlbPrvT )->cSufAlb == ( cAlbPrvL )->cSerAlb + Str( ( cAlbPrvL )->nNumAlb ) + ( cAlbPrvL )->cSufAlb .AND. !( cAlbPrvL )->( Eof() )

         if dbDialogLock( cAlbPrvL )
            ( cAlbPrvL )->lFacturado := lFacturado
            ( cAlbPrvL )->( dbUnlock() )
          end

         ( cAlbPrvL )->( dbSkip() )

      end

   end

   ( cAlbPrvL )->( OrdSetFocus( nOrd ) )
   ( cAlbPrvL )->( dbGoTo( nRec ) )





   nRec                 := ( cAlbPrvS )->( Recno() )
   nOrd                 := ( cAlbPrvS )->( OrdSetFocus( "nNumAlb" ) )

   if ( cAlbPrvS )->( dbSeek( ( cAlbPrvT )->cSerAlb + Str( ( cAlbPrvT )->nNumAlb ) + ( cAlbPrvT )->cSufAlb ) )

      while ( cAlbPrvT )->cSerAlb + Str( ( cAlbPrvT )->nNumAlb ) + ( cAlbPrvT )->cSufAlb == ( cAlbPrvS )->cSerAlb + Str( ( cAlbPrvS )->nNumAlb ) + ( cAlbPrvS )->cSufAlb .AND. !( cAlbPrvS )->( Eof() )

         if dbDialogLock( cAlbPrvS )
            ( cAlbPrvS )->lFacturado := lFacturado
            ( cAlbPrvS )->( dbUnlock() )
          end

         ( cAlbPrvS )->( dbSkip() )

      end

   end

   ( cAlbPrvS )->( OrdSetFocus( nOrd ) )
   ( cAlbPrvS )->( dbGoTo( nRec ) )

   CursorWE()





   if oBrw <> nil
      oBrw:Refresh()
      oBrw:SetFocus()
   end

RETURN NIL



Function IsAlbPrv( cPath )

   IIF( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "AlbProvT.Dbf" )
      dbCreate( cPath + "AlbProvT.Dbf", aSqlStruct( aItmAlbPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbProvL.Dbf" )
      dbCreate( cPath + "AlbProvL.Dbf", aSqlStruct( aColAlbPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbPrvI.Dbf" )
      dbCreate( cPath + "AlbPrvI.Dbf", aSqlStruct( aIncAlbPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbPrvD.Dbf" )
      dbCreate( cPath + "AlbPrvD.Dbf", aSqlStruct( aAlbPrvDoc() ), cDriver() )
   end

   if !lExistTable( cPath + "AlbPrvS.Dbf" )
      dbCreate( cPath + "AlbPrvS.Dbf", aSqlStruct( aSerAlbPrv() ), cDriver() )
   end





   if !lExistIndex( cPath + "AlbProvT.Cdx" ) .OR.  !lExistIndex( cPath + "AlbProvL.Cdx" ) .OR.  !lExistIndex( cPath + "AlbPrvI.Cdx" )  .OR.  !lExistIndex( cPath + "AlbPrvD.Cdx" )  .OR.  !lExistIndex( cPath + "AlbPrvS.Cdx" )

      rxAlbPrv( cPath )

   end

Return ( nil )



FUNCTION cCodAlbPrv( cAlbPrvL )

   local cReturn     := ""

   IIF( cAlbPrvL == nil, cAlbPrvL := if( !Empty( tmpAlbPrvL ), tmpAlbPrvL, dbfAlbPrvL ), ) ;

   cReturn           += Alltrim( ( cAlbPrvL )->cRef )

   if !Empty( ( cAlbPrvL )->cValPr1 )
      cReturn        += "."
      cReturn        += Alltrim( ( cAlbPrvL )->cValPr1 )
   end

   if !Empty( ( cAlbPrvL )->cValPr2 )
      cReturn        += "."
      cReturn        += Alltrim( ( cAlbPrvL )->cValPr2 )
   end

RETURN ( cReturn )



FUNCTION cDesAlbPrv( cAlbPrvL, cAlbPrvS )

   IIF( cAlbPrvL == nil, cAlbPrvL := dbfAlbPrvL, ) ;
   IIF( cAlbPrvS == nil, cAlbPrvS := dbfAlbPrvS, ) ;

RETURN ( Descrip( cAlbPrvL, cAlbPrvS ) )





_HB_CLASS TAlbaranProveedoresLabelGenerator ; UTILITY FUNCTION TAlbaranProveedoresLabelGenerator(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TAlbaranProveedoresLabelGenerator" , { HBObject():Classh } ) ) ;

   _HB_MEMBER { oDlg} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDlg" }, .F., .F. ), )
   _HB_MEMBER { oFld} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFld" }, .F., .F. ), )

   _HB_MEMBER { nRecno} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nRecno" }, .F., .F. ), )

   _HB_MEMBER { oSerieInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSerieInicio" }, .F., .F. ), )
   _HB_MEMBER { cSerieInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cSerieInicio" }, .F., .F. ), )

   _HB_MEMBER { oSerieFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSerieFin" }, .F., .F. ), )
   _HB_MEMBER { cSerieFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cSerieFin" }, .F., .F. ), )

   _HB_MEMBER { nDocumentoInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nDocumentoInicio" }, .F., .F. ), )
   _HB_MEMBER { nDocumentoFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nDocumentoFin" }, .F., .F. ), )

   _HB_MEMBER { cSufijoInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cSufijoInicio" }, .F., .F. ), )
   _HB_MEMBER { cSufijoFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cSufijoFin" }, .F., .F. ), )

   _HB_MEMBER { oFormatoLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFormatoLabel" }, .F., .F. ), )
   _HB_MEMBER { cFormatoLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cFormatoLabel" }, .F., .F. ), )

   _HB_MEMBER { cPrinter} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cPrinter" }, .F., .F. ), )

   _HB_MEMBER { nFilaInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nFilaInicio" }, .F., .F. ), )
   _HB_MEMBER { nColumnaInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nColumnaInicio" }, .F., .F. ), )

   _HB_MEMBER { oBrwLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBrwLabel" }, .F., .F. ), )

   _HB_MEMBER { nCantidadLabels} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nCantidadLabels" }, .F., .F. ), )
   _HB_MEMBER { nUnidadesLabels} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nUnidadesLabels" }, .F., .F. ), )

   _HB_MEMBER { oMtrLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oMtrLabel" }, .F., .F. ), )
   _HB_MEMBER { nMtrLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nMtrLabel" }, .F., .F. ), )

   _HB_MEMBER { oFilter} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFilter" }, .F., .F. ), )

   _HB_MEMBER { lClose} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "lClose" }, .F., .F. ), )

   _HB_MEMBER { lErrorOnCreate} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "lErrorOnCreate" }, .F., .F. ), )

   _HB_MEMBER { oBtnListado} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBtnListado" }, .F., .F. ), )
   _HB_MEMBER { oBtnFilter} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBtnFilter" }, .F., .F. ), )
   _HB_MEMBER { oBtnSiguiente} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBtnSiguiente" }, .F., .F. ), )
   _HB_MEMBER { oBtnAnterior} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBtnAnterior" }, .F., .F. ), )
   _HB_MEMBER { oBtnCancel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBtnCancel" }, .F., .F. ), )

   _HB_MEMBER { aSearch} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "aSearch" }, .F., .F. ), )

   _HB_MEMBER { cFileTmpLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cFileTmpLabel" }, .F., .F. ), )
   _HB_MEMBER { cAreaTmpLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cAreaTmpLabel" }, .F., .F. ), )

   _HB_MEMBER New(); IIF( .F., s_oClass:ModMethod( "New", @TAlbaranProveedoresLabelGenerator_New(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "New", @TAlbaranProveedoresLabelGenerator_New(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER Init(); IIF( .F., s_oClass:ModMethod( "Init", @TAlbaranProveedoresLabelGenerator_Init(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Init", @TAlbaranProveedoresLabelGenerator_Init(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Create(); IIF( .F., s_oClass:ModMethod( "Create", @TAlbaranProveedoresLabelGenerator_Create(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Create", @TAlbaranProveedoresLabelGenerator_Create(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER lCreateAuxiliar(); IIF( .F., s_oClass:ModMethod( "lCreateAuxiliar", @TAlbaranProveedoresLabelGenerator_lCreateAuxiliar(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lCreateAuxiliar", @TAlbaranProveedoresLabelGenerator_lCreateAuxiliar(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER DestroyAuxiliar(); IIF( .F., s_oClass:ModMethod( "DestroyAuxiliar", @TAlbaranProveedoresLabelGenerator_DestroyAuxiliar(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DestroyAuxiliar", @TAlbaranProveedoresLabelGenerator_DestroyAuxiliar(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER lCreateTemporal(); IIF( .F., s_oClass:ModMethod( "lCreateTemporal", @TAlbaranProveedoresLabelGenerator_lCreateTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lCreateTemporal", @TAlbaranProveedoresLabelGenerator_lCreateTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER PrepareTemporal( oFr); IIF( .F., s_oClass:ModMethod( "PrepareTemporal", @TAlbaranProveedoresLabelGenerator_PrepareTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "PrepareTemporal", @TAlbaranProveedoresLabelGenerator_PrepareTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER DestroyTemporal(); IIF( .F., s_oClass:ModMethod( "DestroyTemporal", @TAlbaranProveedoresLabelGenerator_DestroyTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DestroyTemporal", @TAlbaranProveedoresLabelGenerator_DestroyTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER End(); IIF( .F., s_oClass:ModMethod( "End", @TAlbaranProveedoresLabelGenerator_End(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "End", @TAlbaranProveedoresLabelGenerator_End(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER BotonAnterior(); IIF( .F., s_oClass:ModMethod( "BotonAnterior", @TAlbaranProveedoresLabelGenerator_BotonAnterior(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "BotonAnterior", @TAlbaranProveedoresLabelGenerator_BotonAnterior(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER BotonSiguiente(); IIF( .F., s_oClass:ModMethod( "BotonSiguiente", @TAlbaranProveedoresLabelGenerator_BotonSiguiente(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "BotonSiguiente", @TAlbaranProveedoresLabelGenerator_BotonSiguiente(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER PutLabel(); IIF( .F., s_oClass:ModMethod( "PutLabel", @TAlbaranProveedoresLabelGenerator_PutLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "PutLabel", @TAlbaranProveedoresLabelGenerator_PutLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER SelectAllLabels(); IIF( .F., s_oClass:ModMethod( "SelectAllLabels", @TAlbaranProveedoresLabelGenerator_SelectAllLabels(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SelectAllLabels", @TAlbaranProveedoresLabelGenerator_SelectAllLabels(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER AddLabel(); IIF( .F., s_oClass:ModMethod( "AddLabel", @TAlbaranProveedoresLabelGenerator_AddLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "AddLabel", @TAlbaranProveedoresLabelGenerator_AddLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER DelLabel(); IIF( .F., s_oClass:ModMethod( "DelLabel", @TAlbaranProveedoresLabelGenerator_DelLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DelLabel", @TAlbaranProveedoresLabelGenerator_DelLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER EditLabel(); IIF( .F., s_oClass:ModMethod( "EditLabel", @TAlbaranProveedoresLabelGenerator_EditLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "EditLabel", @TAlbaranProveedoresLabelGenerator_EditLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER FilterLabel(); IIF( .F., s_oClass:ModMethod( "FilterLabel", @TAlbaranProveedoresLabelGenerator_FilterLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "FilterLabel", @TAlbaranProveedoresLabelGenerator_FilterLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER LoadAuxiliar(); IIF( .F., s_oClass:ModMethod( "LoadAuxiliar", @TAlbaranProveedoresLabelGenerator_LoadAuxiliar(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "LoadAuxiliar", @TAlbaranProveedoresLabelGenerator_LoadAuxiliar(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER lPrintLabels(); IIF( .F., s_oClass:ModMethod( "lPrintLabels", @TAlbaranProveedoresLabelGenerator_lPrintLabels(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lPrintLabels", @TAlbaranProveedoresLabelGenerator_lPrintLabels(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER InitLabel( oLabel); IIF( .F., s_oClass:ModMethod( "InitLabel", @TAlbaranProveedoresLabelGenerator_InitLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "InitLabel", @TAlbaranProveedoresLabelGenerator_InitLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER SelectColumn( oCombo); IIF( .F., s_oClass:ModMethod( "SelectColumn", @TAlbaranProveedoresLabelGenerator_SelectColumn(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SelectColumn", @TAlbaranProveedoresLabelGenerator_SelectColumn(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TAlbaranProveedoresLabelGenerator ;



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_New() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   local oError
   local oBlock

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ::nRecno             := ( dbfAlbPrvT )->( Recno() )

      ::cSerieInicio       := ( dbfAlbPrvT )->cSerAlb
      ::cSerieFin          := ( dbfAlbPrvT )->cSerAlb

      ::nDocumentoInicio   := ( dbfAlbPrvT )->nNumAlb
      ::nDocumentoFin      := ( dbfAlbPrvT )->nNumAlb

      ::cSufijoInicio      := ( dbfAlbPrvT )->cSufAlb
      ::cSufijoFin         := ( dbfAlbPrvT )->cSufAlb

      ::cFormatoLabel      := GetPvProfString( "Etiquetas", "Albaran proveedor", Space( 3 ), cPatEmp() + "Empresa.Ini" )
      if len( ::cFormatoLabel ) < 3
         ::cFormatoLabel   := Space( 3 )
      end

      ::nMtrLabel          := 0

      ::nFilaInicio        := 1
      ::nColumnaInicio     := 1

      ::nCantidadLabels    := 1
      ::nUnidadesLabels    := 1

      ::aSearch            := { "Código", "Nombre" }

      ::lErrorOnCreate     := .F.

   RECOVER USING oError

      ::lErrorOnCreate     := .T.

      msgStop( "Error en la creación de generador de etiquetas" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end
   ErrorBlock( oBlock )

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_Init() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   local oError
   local oBlock
   local lError            := .F.

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if !lOpenFiles
         OpenFiles()
         ::lClose          := .T.
      end

      ::cSerieInicio       := ( dbfAlbPrvT )->cSerAlb
      ::cSerieFin          := ( dbfAlbPrvT )->cSerAlb

      ::nDocumentoInicio   := ( dbfAlbPrvT )->nNumAlb
      ::nDocumentoFin      := ( dbfAlbPrvT )->nNumAlb

      ::cSufijoInicio      := ( dbfAlbPrvT )->cSufAlb
      ::cSufijoFin         := ( dbfAlbPrvT )->cSufAlb

      ::nCantidadLabels    := 1
      ::nUnidadesLabels    := 1

      ::lErrorOnCreate     := .F.

   RECOVER USING oError

      ::lErrorOnCreate     := .T.

      msgStop( "Error en la creación de generador de etiquetas" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end
   ErrorBlock( oBlock )

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_Create() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   local oBtnPrp
   local oBtnMod
   local oBtnZoo
   local oGetOrd
   local cGetOrd     := Space( 100 )
    local oCbxOrd
   local cCbxOrd     := "Código"
   local aCbxOrd     := { "Código", "Nombre" }

   ::New()

   if !::lErrorOnCreate .AND. ::lCreateAuxiliar()

      ::oDlg = TDialog():New(,,,,, "SelectLabels_0",, .F.,,,,,, .F.,,,,,, .F., )





         ::oFld := TPages():Redefine( 10, ::oDlg, {"SelectLabels_1", "SelectLabels_2"},,,, )









         TBitmap():ReDefine( 500, "EnvioEtiquetas",, ::oDlg,,, .F., .F.,,, .F.,,, .F. )








         ::oSerieInicio := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::cSerieInicio, ::cSerieInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "@!", {||    ( ::cSerieInicio >= "A" .AND. ::cSerieInicio <= "Z" )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( ::oSerieInicio ) )}, {||  ( DwSerie( ::oSerieInicio ) )},,,, nil,,, )









         ::oSerieFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::cSerieFin, ::cSerieFin:= u ) }, ::oFld:aDialogs[ 1 ],, "@!", {||    ( ::cSerieFin >= "A" .AND. ::cSerieFin <= "Z" )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( ::oSerieFin ) )}, {||  ( DwSerie( ::oSerieFin ) )},,,, nil,,, )





         TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::nDocumentoInicio, ::nDocumentoInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





         TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::nDocumentoFin, ::nDocumentoFin:= u ) }, ::oFld:aDialogs[ 1 ],, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




         TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::cSufijoInicio, ::cSufijoInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "##",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




         TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::cSufijoFin, ::cSufijoFin:= u ) }, ::oFld:aDialogs[ 1 ],, "##",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )





         TGetHlp():ReDefine( 180, { | u | If( PCount()==0, ::nFilaInicio, ::nFilaInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





         TGetHlp():ReDefine( 190, { | u | If( PCount()==0, ::nColumnaInicio, ::nColumnaInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





         ::oFormatoLabel := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::cFormatoLabel, ::cFormatoLabel:= u ) }, ::oFld:aDialogs[ 1 ],,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 161 )

            ::oFormatoLabel:bValid  := {|| cDocumento( ::oFormatoLabel, ::oFormatoLabel:oHelpText, dbfDoc, "AL" ) }
            ::oFormatoLabel:bHelp   := {|| BrwDocumento( ::oFormatoLabel, ::oFormatoLabel:oHelpText, "AL" ) }

         TBtnBmp():ReDefine( 220, "Printer_pencil_16",,,,, {|| EdtDocumento( ::cFormatoLabel ) }, ::oFld:aDialogs[ 1 ], .F., , .F., "Modificar formato de etiquetas" )



         TRadMenu():Redefine( { | u | If( PCount()==0, ::nCantidadLabels, ::nCantidadLabels:= u ) }, ::oFld:aDialogs[ 1 ],, { 200, 201 },,,,, .F.,, )








         TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::nUnidadesLabels, ::nUnidadesLabels:= u ) }, ::oFld:aDialogs[ 1 ],, "99999",,,,,,, .F., {||     ( ::nCantidadLabels == 2 )},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )









         oGetOrd := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, cGetOrd, cGetOrd:= u ) }, ::oFld:aDialogs[ 2 ],,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "FIND",, )

         oGetOrd:bChange   := {| nKey, nFlags, oGet | AutoSeek( nKey, nFlags, oGet, ::oBrwLabel, ::cAreaTmpLabel ) }
         oGetOrd:bValid    := {|| ( ::cAreaTmpLabel )->( OrdScope( 0, nil ) ), ( ::cAreaTmpLabel )->( OrdScope( 1, nil ) ), ::oBrwLabel:Refresh(), .T. }





         oCbxOrd := TComboBox():ReDefine( 210, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, ::oFld:aDialogs[ 2 ],,,,,,, .F.,,,,,, )

         oCbxOrd:bChange   := {|| ::SelectColumn( oCbxOrd ) }




         TButton():ReDefine( 100, {||( ::PutLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 110, {||( ::SelectAllLabels( .T. ) )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 120, {||( ::SelectAllLabels( .F. ) )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 130, {||( ::AddLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 140, {||( ::DelLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 150, {||( ::EditLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         oBtnPrp := TButton():ReDefine( 220, {||( nil )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         oBtnMod := TButton():ReDefine( 160, {||( nil )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         oBtnZoo := TButton():ReDefine( 165, {||( nil )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         ::oBtnFilter := TButton():ReDefine( 170, {||( ::FilterLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )

         ::oBrwLabel                 := TXBrowse():New( ::oFld:aDialogs[ 2 ] )

         ::oBrwLabel:nMarqueeStyle   := 5
         ::oBrwLabel:nColSel         := 2

         ::oBrwLabel:lHScroll        := .F.
         ::oBrwLabel:cAlias          := ::cAreaTmpLabel

         ::oBrwLabel:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
         ::oBrwLabel:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
         ::oBrwLabel:bLDblClick      := {|| ::PutLabel() }

         ::oBrwLabel:CreateFromResource( 180 )

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Sl. Seleccionada"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->lLabel }
            :nWidth           := 20
            :SetCheck( { "Sel16", "Nil16" } )
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Código"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->cRef }
            :nWidth           := 80
            :cSortOrder       := "cRef"
            :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Nombre"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->cDetalle }
            :nWidth           := 250
            :cSortOrder       := "cDetalle"
            :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Prp. 1"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->cValPr1 }
            :nWidth           := 40
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Prp. 2"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->cValPr2 }
            :nWidth           := 40
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "N. etiquetas"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->nLabel }
            :cEditPicture     := "@E 99,999"
            :nWidth           := 80
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :nEditType        := 1
            :bOnPostEdit      := {|o,x| if( dbDialogLock( ::cAreaTmpLabel ), ( ( ::cAreaTmpLabel )->nLabel := x, ( ::cAreaTmpLabel )->( dbUnlock() ) ), ) }
         end






         ::oMtrLabel := TMeter():ReDefine( 190, { | u | If( PCount()==0, ::nMtrLabel, ::nMtrLabel:= u ) }, ( ::cAreaTmpLabel  )->( lastrec() ), ::oFld:aDialogs[ 2 ], .F.,, "", .F.,,,, )

         ::oMtrLabel:nClrText   := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )
         ::oMtrLabel:nClrBar    := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )
         ::oMtrLabel:nClrBText  := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )








         ::oBtnListado := TButton():ReDefine( 40, {||( ::BotonAnterior() )}, ::oDlg,,, .F.,,,, .F. )




         ::oBtnAnterior := TButton():ReDefine( 20, {||( ::BotonAnterior() )}, ::oDlg,,, .F.,,,, .F. )




         ::oBtnSiguiente := TButton():ReDefine( 30, {||( ::BotonSiguiente() )}, ::oDlg,,, .F.,,,, .F. )




         ::oBtnCancel := TButton():ReDefine( 2, {||( ::oDlg:End() )}, ::oDlg,,, .F.,,,, .F. )

      ::oDlg:bStart  := {|| ::oBtnListado:Hide(), ::oBtnAnterior:Hide(), ::oFormatoLabel:lValid(), oBtnMod:Hide(), oBtnZoo:Hide(), oBtnPrp:Hide() }

      ::oDlg:Activate( ::oDlg:bLClicked, ::oDlg:bMoved, ::oDlg:bPainted, .T.,,,, ::oDlg:bRClicked,,, )

      ::End()

   end

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_lCreateAuxiliar() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   local oBlock
   local oError
   local lCreateAuxiliar   := .T.

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ::cAreaTmpLabel      := "Lbl" + cCurUsr()
      ::cFileTmpLabel      := cGetNewFileName( cPatTmp() + "Lbl" )

      ::DestroyAuxiliar()

      dbCreate( ::cFileTmpLabel, aSqlStruct( aColAlbPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), ::cFileTmpLabel, ::cAreaTmpLabel, .F. )

      if!( ::cAreaTmpLabel )->( neterr() )
         ( ::cAreaTmpLabel )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
         ( ::cAreaTmpLabel )->( OrdCreate( ::cFileTmpLabel, "cRef", "cRef", {|| Field->cRef } ) )

         ( ::cAreaTmpLabel )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
         ( ::cAreaTmpLabel )->( OrdCreate( ::cFileTmpLabel, "cDetalle", "Upper( cDetalle )", {|| Upper( Field->cDetalle ) } ) )
      end

      ( ::cAreaTmpLabel )->( OrdsetFocus( "cRef" ) )

   RECOVER USING oError

      lCreateAuxiliar      := .F.

      MsgStop( "Imposible crear fichero temporal" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

Return ( lCreateAuxiliar )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_DestroyAuxiliar() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   if !Empty( ::cAreaTmpLabel ) .AND. ( ::cAreaTmpLabel )->( Used() )
      ( ::cAreaTmpLabel )->( dbCloseArea() )
   end

   dbfErase( ::cFileTmpLabel )

   SysRefresh()

Return ( nil )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_BotonAnterior() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   ::oFld:GoPrev()

   ::oBtnAnterior:Hide()

   SetWindowText( ::oBtnSiguiente:hWnd, "Siguien&te >" )

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_BotonSiguiente() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   do case
      case ::oFld:nOption == 1

         if Empty( ::cFormatoLabel )

            MsgStop( "Debe cumplimentar un formato de etiquetas" )

         else

            ::LoadAuxiliar()

            ::oFld:GoNext()
            ::oBtnAnterior:Show()
            SetWindowText( ::oBtnSiguiente:hWnd, "&Terminar" )

         end

      case ::oFld:nOption == 2

         if ::lPrintLabels()

            SetWindowText( ::oBtnCancel:hWnd, "&Cerrar" )

         end

   end

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_lCreateTemporal() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   local n
   local nRec
   local oBlock
   local oError
   local nBlancos
   local lCreateTemporal   := .T.

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      tmpAlbPrvL           := "LblAlb"
      filAlbPrvL           := cGetNewFileName( cPatTmp() + "LblAlb" )

      dbCreate( filAlbPrvL, aSqlStruct( aColAlbPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), filAlbPrvL, tmpAlbPrvL, .F. )

      ( tmpAlbPrvL )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
      ( tmpAlbPrvL )->( OrdCreate( filAlbPrvL, "nNumAlb", "cSerAlb + Str( nNumAlb ) + cSufAlb", {|| Field->cSerAlb + Str( Field->nNumAlb ) + Field->cSufAlb } ) )

      nRec                 := ( ::cAreaTmpLabel )->( Recno() )

      ( ::cAreaTmpLabel )->( dbGoTop() )
      while !( ::cAreaTmpLabel )->( eof() )

         if ( ::cAreaTmpLabel )->lLabel
            for n := 1 to ( ::cAreaTmpLabel )->nLabel
               dbPass( ::cAreaTmpLabel, tmpAlbPrvL, .T. )
            next
         end

         ( ::cAreaTmpLabel )->( dbSkip() )

      end
      ( tmpAlbPrvL )->( dbGoTop() )

      ( ::cAreaTmpLabel )->( dbGoTo( nRec ) )

   RECOVER USING oError

      lCreateTemporal      := .F.

      MsgStop( "Imposible crear un fichero temporal de lineas de albaranes" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

Return ( lCreateTemporal )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_DestroyTemporal() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   if ( tmpAlbPrvL )->( Used() )
      ( tmpAlbPrvL )->( dbCloseArea() )
   end

   dbfErase( filAlbPrvL )

   tmpAlbPrvL           := nil

   SysRefresh()

Return ( .T. )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_PrepareTemporal( oFr) ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   local n
   local nBlancos       := 0
   local nPaperHeight   := oFr:GetProperty( "MainPage", "PaperHeight" ) * 3.77953
   local nHeight        := oFr:GetProperty( "CabeceraColumnas", "Height" )
   local nColumns       := oFr:GetProperty( "MainPage", "Columns" )
   local nItemsInColumn := int( nPaperHeight / nHeight )

   nBlancos             := ( ::nColumnaInicio - 1 ) * nItemsInColumn
   nBlancos             += ( ::nFilaInicio - 1 )

   for n := 1 to nBlancos
      dbPass( dbBlankRec( dbfAlbPrvL ), tmpAlbPrvL, .T. )
   next

   ( tmpAlbPrvL )->( dbGoTop() )

Return ( .T. )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_lPrintLabels() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   local oFr

   local nCopies      := 1
   local nDevice      := 2
   local cPrinter     := PrnGetName()

   if ::lCreateTemporal()

      SysRefresh()

      oFr             := frReportManager():New()

      oFr:LoadLangRes(     "Spanish.Xml" )

      oFr:SetIcon( 1 )

      oFr:SetTitle(        "Diseñador de documentos" )





      oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





      DataLabel( oFr, .T. )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





         ::PrepareTemporal( oFr )





         oFr:PrepareReport()





         do case
            case nDevice == 2
               oFr:ShowPreparedReport()

            case nDevice == 1
               oFr:PrintOptions:SetPrinter( cPrinter )
               oFr:PrintOptions:SetCopies( nCopies )
               oFr:PrintOptions:SetShowDialog( .F. )
               oFr:Print()

            case nDevice == 3
               oFr:DoExport( "PDFExport" )

         end

      end





      oFr:DestroyFr()

      ::DestroyTemporal()

   end

Return .T.



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_End() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   if !Empty( ::nRecno )
      ( dbfAlbPrvT )->( dbGoTo( ::nRecno ) )
   end

   if IsTrue( ::lClose )
      CloseFiles()
   end





   ::DestroyAuxiliar()

   WritePProString( "Etiquetas", "Albaran proveedor", ::cFormatoLabel, cPatEmp() + "Empresa.Ini" )

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_PutLabel() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   ( ::cAreaTmpLabel )->lLabel   := !( ::cAreaTmpLabel )->lLabel

   ::oBrwLabel:Refresh()
   ::oBrwLabel:Select()

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_SelectAllLabels( lSelect) ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

    local n            := 0
   local nRecno   := ( ::cAreaTmpLabel )->( Recno() )

    CursorWait()

   ( ::cAreaTmpLabel )->( dbGoTop() )
   while !( ::cAreaTmpLabel )->( eof() )

      ( ::cAreaTmpLabel )->lLabel := lSelect

      ( ::cAreaTmpLabel )->( dbSkip() )

      ::oMtrLabel:Set( ++n )

   end

   ( ::cAreaTmpLabel )->( dbGoTo( nRecno ) )

   ::oBrwLabel:Refresh()

   ::oMtrLabel:Set( 0 )
   ::oMtrLabel:Refresh()

    CursorArrow()

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_AddLabel() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   ( ::cAreaTmpLabel )->nLabel++

   ::oBrwLabel:Refresh()
   ::oBrwLabel:SetFocus()

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_DelLabel() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   if ( ::cAreaTmpLabel )->nLabel > 1
      ( ::cAreaTmpLabel )->nLabel--
   end

   ::oBrwLabel:Refresh()
   ::oBrwLabel:SetFocus()

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_EditLabel() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   ::oBrwLabel:aCols[ 6 ]:Edit()

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_FilterLabel() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   if Empty( ::oFilter )
      ::oFilter      := TDlgFlt():New( aColAlbPrv(), ::cAreaTmpLabel )
   end

   if !Empty( ::oFilter )

      ::oFilter:Resource()

      if ::oFilter:cExpFilter <> nil
         SetWindowText( ::oBtnFilter:hWnd, "Filtro activo" )
      else
         SetWindowText( ::oBtnFilter:hWnd, "Filtrar" )
      end

   end

   ::oBrwLabel:Refresh()
   ::oBrwLabel:SetFocus()

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_LoadAuxiliar() ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   local nRec
   local nOrd





   ( ::cAreaTmpLabel )->( __dbZap() )





   nRec           := ( dbfAlbPrvT )->( Recno() )
   nOrd           := ( dbfAlbPrvT )->( OrdSetFocus( "nNumAlb" ) )

   if ( dbfAlbPrvT )->( dbSeek( ::cSerieInicio + Str( ::nDocumentoInicio, 9 ) + ::cSufijoInicio, .T. ) )



      while ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb >= ::cSerieInicio + Str( ::nDocumentoInicio, 9 ) + ::cSufijoInicio .AND.  ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb <= ::cSerieFin + Str( ::nDocumentoFin, 9 ) + ::cSufijoFin          .AND.  !( dbfAlbPrvT )->( eof() )

         if ( dbfAlbPrvL )->( dbSeek( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb ) )

            while ( ( dbfAlbPrvL )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->cSufAlb == ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb ) .AND. ( dbfAlbPrvL )->( !eof() )

               if !Empty( ( dbfAlbPrvL )->cRef )

                  ( ::cAreaTmpLabel )->( dbAppend() )

                  ( ::cAreaTmpLabel )->cSerAlb  := ( dbfAlbPrvL )->cSerAlb
                  ( ::cAreaTmpLabel )->nNumAlb  := ( dbfAlbPrvL )->nNumAlb
                  ( ::cAreaTmpLabel )->cSufAlb  := ( dbfAlbPrvL )->cSufAlb
                  ( ::cAreaTmpLabel )->cRef     := ( dbfAlbPrvL )->cRef
                  ( ::cAreaTmpLabel )->cRefPrv  := ( dbfAlbPrvL )->cRefPrv
                  ( ::cAreaTmpLabel )->cDetalle := ( dbfAlbPrvL )->cDetalle
                  ( ::cAreaTmpLabel )->nPreDiv  := ( dbfAlbPrvL )->nPreDiv
                  ( ::cAreaTmpLabel )->nIva     := ( dbfAlbPrvL )->nIva
                  ( ::cAreaTmpLabel )->nReq     := ( dbfAlbPrvL )->nReq
                  ( ::cAreaTmpLabel )->nCanEnt  := ( dbfAlbPrvL )->nCanEnt
                  ( ::cAreaTmpLabel )->lControl := ( dbfAlbPrvL )->lControl
                  ( ::cAreaTmpLabel )->cUnidad  := ( dbfAlbPrvL )->cUnidad
                  ( ::cAreaTmpLabel )->nUniCaja := ( dbfAlbPrvL )->nUniCaja
                  ( ::cAreaTmpLabel )->lChgLin  := ( dbfAlbPrvL )->lChgLin
                  ( ::cAreaTmpLabel )->mLngDes  := ( dbfAlbPrvL )->mLngDes
                  ( ::cAreaTmpLabel )->nDtoLin  := ( dbfAlbPrvL )->nDtoLin
                  ( ::cAreaTmpLabel )->nDtoPrm  := ( dbfAlbPrvL )->nDtoPrm
                  ( ::cAreaTmpLabel )->nDtoRap  := ( dbfAlbPrvL )->nDtoRap
                  ( ::cAreaTmpLabel )->nPreCom  := ( dbfAlbPrvL )->nPreCom
                  ( ::cAreaTmpLabel )->lBnfLin1 := ( dbfAlbPrvL )->lBnfLin1
                  ( ::cAreaTmpLabel )->lBnfLin2 := ( dbfAlbPrvL )->lBnfLin2
                  ( ::cAreaTmpLabel )->lBnfLin3 := ( dbfAlbPrvL )->lBnfLin3
                  ( ::cAreaTmpLabel )->lBnfLin4 := ( dbfAlbPrvL )->lBnfLin4
                  ( ::cAreaTmpLabel )->lBnfLin5 := ( dbfAlbPrvL )->lBnfLin5
                  ( ::cAreaTmpLabel )->lBnfLin6 := ( dbfAlbPrvL )->lBnfLin6
                  ( ::cAreaTmpLabel )->nBnfLin1 := ( dbfAlbPrvL )->nBnfLin1
                  ( ::cAreaTmpLabel )->nBnfLin2 := ( dbfAlbPrvL )->nBnfLin2
                  ( ::cAreaTmpLabel )->nBnfLin3 := ( dbfAlbPrvL )->nBnfLin3
                  ( ::cAreaTmpLabel )->nBnfLin4 := ( dbfAlbPrvL )->nBnfLin4
                  ( ::cAreaTmpLabel )->nBnfLin5 := ( dbfAlbPrvL )->nBnfLin5
                  ( ::cAreaTmpLabel )->nBnfLin6 := ( dbfAlbPrvL )->nBnfLin6
                  ( ::cAreaTmpLabel )->nBnfSbr1 := ( dbfAlbPrvL )->nBnfSbr1
                  ( ::cAreaTmpLabel )->nBnfSbr2 := ( dbfAlbPrvL )->nBnfSbr2
                  ( ::cAreaTmpLabel )->nBnfSbr3 := ( dbfAlbPrvL )->nBnfSbr3
                  ( ::cAreaTmpLabel )->nBnfSbr4 := ( dbfAlbPrvL )->nBnfSbr4
                  ( ::cAreaTmpLabel )->nBnfSbr5 := ( dbfAlbPrvL )->nBnfSbr5
                  ( ::cAreaTmpLabel )->nBnfSbr6 := ( dbfAlbPrvL )->nBnfSbr6
                  ( ::cAreaTmpLabel )->nPvpLin1 := ( dbfAlbPrvL )->nPvpLin1
                  ( ::cAreaTmpLabel )->nPvpLin2 := ( dbfAlbPrvL )->nPvpLin2
                  ( ::cAreaTmpLabel )->nPvpLin3 := ( dbfAlbPrvL )->nPvpLin3
                  ( ::cAreaTmpLabel )->nPvpLin4 := ( dbfAlbPrvL )->nPvpLin4
                  ( ::cAreaTmpLabel )->nPvpLin5 := ( dbfAlbPrvL )->nPvpLin5
                  ( ::cAreaTmpLabel )->nPvpLin6 := ( dbfAlbPrvL )->nPvpLin6
                  ( ::cAreaTmpLabel )->nIvaLin1 := ( dbfAlbPrvL )->nIvaLin1
                  ( ::cAreaTmpLabel )->nIvaLin2 := ( dbfAlbPrvL )->nIvaLin2
                  ( ::cAreaTmpLabel )->nIvaLin3 := ( dbfAlbPrvL )->nIvaLin3
                  ( ::cAreaTmpLabel )->nIvaLin4 := ( dbfAlbPrvL )->nIvaLin4
                  ( ::cAreaTmpLabel )->nIvaLin5 := ( dbfAlbPrvL )->nIvaLin5
                  ( ::cAreaTmpLabel )->nIvaLin6 := ( dbfAlbPrvL )->nIvaLin6
                  ( ::cAreaTmpLabel )->nIvaLin  := ( dbfAlbPrvL )->nIvaLin
                  ( ::cAreaTmpLabel )->lIvaLin  := ( dbfAlbPrvL )->lIvaLin
                  ( ::cAreaTmpLabel )->cCodPr1  := ( dbfAlbPrvL )->cCodPr1
                  ( ::cAreaTmpLabel )->cCodPr2  := ( dbfAlbPrvL )->cCodPr2
                  ( ::cAreaTmpLabel )->cValPr1  := ( dbfAlbPrvL )->cValPr1
                  ( ::cAreaTmpLabel )->cValPr2  := ( dbfAlbPrvL )->cValPr2
                  ( ::cAreaTmpLabel )->nFacCnv  := ( dbfAlbPrvL )->nFacCnv
                  ( ::cAreaTmpLabel )->cAlmLin  := ( dbfAlbPrvL )->cAlmLin
                  ( ::cAreaTmpLabel )->nCtlStk  := ( dbfAlbPrvL )->nCtlStk
                  ( ::cAreaTmpLabel )->lLote    := ( dbfAlbPrvL )->lLote
                  ( ::cAreaTmpLabel )->nLote    := ( dbfAlbPrvL )->nLote
                  ( ::cAreaTmpLabel )->cLote    := ( dbfAlbPrvL )->cLote
                  ( ::cAreaTmpLabel )->nNumLin  := ( dbfAlbPrvL )->nNumLin
                  ( ::cAreaTmpLabel )->nUndKit  := ( dbfAlbPrvL )->nUndKit
                  ( ::cAreaTmpLabel )->lKitArt  := ( dbfAlbPrvL )->lKitArt
                  ( ::cAreaTmpLabel )->lKitChl  := ( dbfAlbPrvL )->lKitChl
                  ( ::cAreaTmpLabel )->lKitPrc  := ( dbfAlbPrvL )->lKitPrc
                  ( ::cAreaTmpLabel )->lImpLin  := ( dbfAlbPrvL )->lImpLin
                  ( ::cAreaTmpLabel )->mNumSer  := ( dbfAlbPrvL )->mNumSer
                  ( ::cAreaTmpLabel )->cCodUbi1 := ( dbfAlbPrvL )->cCodUbi1
                  ( ::cAreaTmpLabel )->cCodUbi2 := ( dbfAlbPrvL )->cCodUbi2
                  ( ::cAreaTmpLabel )->cCodUbi3 := ( dbfAlbPrvL )->cCodUbi3
                  ( ::cAreaTmpLabel )->cValUbi1 := ( dbfAlbPrvL )->cValUbi1
                  ( ::cAreaTmpLabel )->cValUbi2 := ( dbfAlbPrvL )->cValUbi2
                  ( ::cAreaTmpLabel )->cValUbi3 := ( dbfAlbPrvL )->cValUbi3
                  ( ::cAreaTmpLabel )->cNomUbi1 := ( dbfAlbPrvL )->cNomUbi1
                  ( ::cAreaTmpLabel )->cNomUbi2 := ( dbfAlbPrvL )->cNomUbi2
                  ( ::cAreaTmpLabel )->cNomUbi3 := ( dbfAlbPrvL )->cNomUbi3
                  ( ::cAreaTmpLabel )->cCodFam  := ( dbfAlbPrvL )->cCodFam
                  ( ::cAreaTmpLabel )->cGrpFam  := ( dbfAlbPrvL )->cGrpFam
                  ( ::cAreaTmpLabel )->mObsLin  := ( dbfAlbPrvL )->mObsLin
                  ( ::cAreaTmpLabel )->nPvpRec  := ( dbfAlbPrvL )->nPvpRec
                  ( ::cAreaTmpLabel )->nUndLin  := nTotNAlbPrv( dbfAlbPrvL )
                  ( ::cAreaTmpLabel )->lLabel   := .T.

                  if ::nCantidadLabels == 1
                  ( ::cAreaTmpLabel )->nLabel   := nTotNAlbPrv( dbfAlbPrvL )
                  else
                  ( ::cAreaTmpLabel )->nLabel   := ::nUnidadesLabels
                  end

               end

               ( dbfAlbPrvL )->( dbSkip() )

            end

         end

         ( dbfAlbPrvT )->( dbSkip() )

      end

   end

   ( dbfAlbPrvT )->( OrdSetFocus( nOrd ) )
   ( dbfAlbPrvT )->( dbGoTo( nRec ) )

   ( ::cAreaTmpLabel )->( dbGoTop() )

   ::oBrwLabel:Refresh()

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_InitLabel( oLabel) ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   local nStartRow

   if ::nFilaInicio > 1
      nStartRow            := oLabel:nStartRow
      nStartRow            += ( ::nFilaInicio - 1 ) * ( oLabel:nLblHeight + oLabel:nVSeparator )

      if nStartRow < oLabel:nBottomRow
         oLabel:nStartRow  := nStartRow
      end
   end

   if ::nColumnaInicio > 1 .AND. ::nColumnaInicio <= oLabel:nLblOnLine
      oLabel:nLblCurrent   := ::nColumnaInicio
   end

Return ( Self )



UTILITY STATIC function TAlbaranProveedoresLabelGenerator_SelectColumn( oCombo) ; local Self AS CLASS TAlbaranProveedoresLabelGenerator := QSelf() AS CLASS TAlbaranProveedoresLabelGenerator

   local oCol
   local cOrd                    := oCombo:VarGet()

   if ::oBrwLabel <> nil

      with object ::oBrwLabel

         for each oCol in :aCols

            if Eq( cOrd, oCol:cHeader )
               oCol:cOrder       := "A"
               oCol:SetOrder()
            else
               oCol:cOrder       := " "
            end

         next

      end

      ::oBrwLabel:Refresh()

   end

Return ( Self )



Static Function DataLabel( oFr, lTemporal )









































   oFr:ClearDataSets()

   if lTemporal
      oFr:SetWorkArea(  "Lineas de albaranes", ( tmpAlbPrvL )->( Select() ), .F., { 0, 0, 0 } )
   else
      oFr:SetWorkArea(  "Lineas de albaranes", ( dbfAlbPrvL )->( Select() ), .F., { 0, 2, 20 } )
   end

   oFr:SetFieldAliases( "Lineas de albaranes", cItemsToReport( aColAlbPrv() ) )

   oFr:SetWorkArea(     "Albaranes", ( dbfAlbPrvT )->( Select() ) )
   oFr:SetFieldAliases( "Albaranes", cItemsToReport( aItmAlbPrv() ) )

   oFr:SetWorkArea(     "Artículos", ( dbfArticulo )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Precios por propiedades", ( dbfArtCom )->( Select() ) )
   oFr:SetFieldAliases( "Precios por propiedades", cItemsToReport( aItmVta() ) )

   oFr:SetWorkArea(     "Incidencias de albaranes", ( dbfAlbPrvI )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de albaranes", cItemsToReport( aIncAlbPrv() ) )

   oFr:SetWorkArea(     "Documentos de albaranes", ( dbfAlbPrvD )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de albaranes", cItemsToReport( aAlbPrvDoc() ) )

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Proveedores", ( dbfPrv )->( Select() ) )
   oFr:SetFieldAliases( "Proveedores", cItemsToReport( aItmPrv() ) )

   oFr:SetWorkArea(     "Almacenes", ( dbfAlm )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Artículos", ( dbfArticulo )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Código de proveedores", ( dbfArtPrv )->( Select() ) )
   oFr:SetFieldAliases( "Código de proveedores", cItemsToReport( aItmArtPrv() ) )

   oFr:SetWorkArea(     "Unidades de medición",  oUndMedicion:Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( oUndMedicion:oDbf ) )

   if lTemporal
      oFr:SetMasterDetail( "Lineas de albaranes", "Albaranes",                {|| ( tmpAlbPrvL )->cSerAlb + Str( ( tmpAlbPrvL )->nNumAlb ) + ( tmpAlbPrvL )->cSufAlb } )
      oFr:SetMasterDetail( "Lineas de albaranes", "Artículos",                {|| ( tmpAlbPrvL )->cRef } )
      oFr:SetMasterDetail( "Lineas de albaranes", "Precios por propiedades",  {|| ( tmpAlbPrvL )->cRef + ( tmpAlbPrvL )->cCodPr1 + ( tmpAlbPrvL )->cCodPr2 + ( tmpAlbPrvL )->cValPr1 + ( tmpAlbPrvL )->cValPr2 } )
      oFr:SetMasterDetail( "Lineas de albaranes", "Incidencias de albaranes", {|| ( tmpAlbPrvL )->cSerAlb + Str( ( tmpAlbPrvL )->nNumAlb ) + ( tmpAlbPrvL )->cSufAlb } )
      oFr:SetMasterDetail( "Lineas de albaranes", "Documentos de albaranes",  {|| ( tmpAlbPrvL )->cSerAlb + Str( ( tmpAlbPrvL )->nNumAlb ) + ( tmpAlbPrvL )->cSufAlb } )
   else
      oFr:SetMasterDetail( "Lineas de albaranes", "Albaranes",                {|| ( dbfAlbPrvL )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->cSufAlb } )
      oFr:SetMasterDetail( "Lineas de albaranes", "Artículos",                {|| ( dbfAlbPrvL )->cRef } )
      oFr:SetMasterDetail( "Lineas de albaranes", "Precios por propiedades",  {|| ( dbfAlbPrvL )->cRef + ( dbfAlbPrvL )->cCodPr1 + ( dbfAlbPrvL )->cCodPr2 + ( dbfAlbPrvL )->cValPr1 + ( dbfAlbPrvL )->cValPr2 } )
      oFr:SetMasterDetail( "Lineas de albaranes", "Incidencias de albaranes", {|| ( dbfAlbPrvL )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->cSufAlb } )
      oFr:SetMasterDetail( "Lineas de albaranes", "Documentos de albaranes",  {|| ( dbfAlbPrvL )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->cSufAlb } )
   end

   oFr:SetMasterDetail(    "Albaranes", "Proveedores",                        {|| ( dbfAlbPrvT )->cCodPrv } )
   oFr:SetMasterDetail(    "Albaranes", "Almacenes",                          {|| ( dbfAlbPrvT )->cCodAlm } )
   oFr:SetMasterDetail(    "Albaranes", "Empresa",                            {|| cCodigoEmpresaEnUso() } )

   oFr:SetResyncPair(      "Lineas de albaranes", "Albaranes" )
   oFr:SetResyncPair(      "Lineas de albaranes", "Artículos" )
   oFr:SetResyncPair(      "Lineas de albaranes", "Precios por propiedades" )
   oFr:SetResyncPair(      "Lineas de albaranes", "Incidencias de albaranes" )
   oFr:SetResyncPair(      "Lineas de albaranes", "Documentos de albaranes" )

   oFr:SetResyncPair(      "Albaranes", "Proveedores" )
   oFr:SetResyncPair(      "Albaranes", "Almacenes" )
   oFr:SetResyncPair(      "Albaranes", "Empresa" )

Return nil



Function DesignLabelAlbPrv( oFr, dbfDoc )

   local oLabel   := TAlbaranProveedoresLabelGenerator():Init()

   if !oLabel:lErrorOnCreate





      DataLabel( oFr, .F. )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraColumnas",  "MainPage",       6 )
         oFr:SetProperty(     "CabeceraColumnas",  "Top",            200 )
         oFr:SetProperty(     "CabeceraColumnas",  "Height",         100 )
         oFr:SetObjProperty(  "CabeceraColumnas",  "DataSet",        "Lineas de albaranes" )

      end





      VariableReport( oFr )





      oFr:DesignReport()





      oFr:DestroyFr()





      oLabel:End()

   else

      Return .F.

   end

Return .T.





Static Function DataReport( oFr )





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "Albaranes", ( dbfAlbPrvT )->( Select() ), .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "Albaranes", cItemsToReport( aItmAlbPrv() ) )

   oFr:SetWorkArea(     "Lineas de albaranes", ( dbfAlbPrvL )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de albaranes", cItemsToReport( aColAlbPrv() ) )

   oFr:SetWorkArea(     "Series de lineas de albaranes", ( dbfAlbPrvS )->( Select() ) )
   oFr:SetFieldAliases( "Series de lineas de albaranes", cItemsToReport( aSerAlbPrv() ) )

   oFr:SetWorkArea(     "Incidencias de albaranes", ( dbfAlbPrvI )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de albaranes", cItemsToReport( aIncAlbPrv() ) )

   oFr:SetWorkArea(     "Documentos de albaranes", ( dbfAlbPrvD )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de albaranes", cItemsToReport( aAlbPrvDoc() ) )

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Proveedor", ( dbfPrv )->( Select() ) )
   oFr:SetFieldAliases( "Proveedor", cItemsToReport( aItmPrv() ) )

   oFr:SetWorkArea(     "Almacenes", ( dbfAlm )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Artículos", ( dbfArticulo )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Código de proveedores", ( dbfArtPrv )->( Select() ) )
   oFr:SetFieldAliases( "Código de proveedores", cItemsToReport( aItmArtPrv() ) )

   oFr:SetWorkArea(     "Unidades de medición",  oUndMedicion:Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( oUndMedicion:oDbf ) )

   oFr:SetMasterDetail( "Albaranes", "Lineas de albaranes",             {|| ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb } )
   oFr:SetMasterDetail( "Albaranes", "Series de lineas de albaranes",   {|| ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb } )
   oFr:SetMasterDetail( "Albaranes", "Incidencias de albaranes",        {|| ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb } )
   oFr:SetMasterDetail( "Albaranes", "Documentos de albaranes",         {|| ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb } )
   oFr:SetMasterDetail( "Albaranes", "Proveedor",                       {|| ( dbfAlbPrvT )->cCodPrv } )
   oFr:SetMasterDetail( "Albaranes", "Almacenes",                       {|| ( dbfAlbPrvT )->cCodAlm } )
   oFr:SetMasterDetail( "Albaranes", "Formas de pago",                  {|| ( dbfAlbPrvT )->cCodPgo } )
   oFr:SetMasterDetail( "Albaranes", "Empresa",                         {|| cCodigoEmpresaEnUso() } )

   oFr:SetMasterDetail( "Lineas de albaranes", "Artículos",             {|| ( dbfAlbPrvL )->cRef } )
   oFr:SetMasterDetail( "Lineas de albaranes", "Código de proveedores", {|| ( dbfAlbPrvT )->cCodPrv + ( dbfAlbPrvL )->cRef } )
   oFr:SetMasterDetail( "Lineas de albaranes", "Unidades de medición",  {|| ( dbfAlbPrvL )->cUnidad } )

   oFr:SetResyncPair(   "Albaranes", "Lineas de albaranes" )
   oFr:SetResyncPair(   "Albaranes", "Series de lineas de albaranes" )
   oFr:SetResyncPair(   "Albaranes", "Incidencias de albaranes" )
   oFr:SetResyncPair(   "Albaranes", "Documentos de albaranes" )
   oFr:SetResyncPair(   "Albaranes", "Empresa" )
   oFr:SetResyncPair(   "Albaranes", "Proveedor" )
   oFr:SetResyncPair(   "Albaranes", "Almacenes" )
   oFr:SetResyncPair(   "Albaranes", "Formas de pago" )

   oFr:SetResyncPair(   "Lineas de albaranes", "Artículos" )
   oFr:SetResyncPair(   "Lineas de albaranes", "Código de proveedores" )
   oFr:SetResyncPair(   "Lineas de albaranes", "Unidades de medición" )

Return nil



Static Function VariableReport( oFr )

   oFr:DeleteCategory(  "Albaranes" )
   oFr:DeleteCategory(  "Lineas de albaranes" )





   oFr:AddVariable(     "Albaranes",             "Total albaran",                       "GetHbVar('nTotAlb')" )
   oFr:AddVariable(     "Albaranes",             "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Albaranes",             "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Albaranes",             "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Albaranes",             "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Albaranes",             "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Albaranes",             "Total neto",                          "GetHbVar('nTotNet')" )
   oFr:AddVariable(     "Albaranes",             "Total primer descuento definible",    "GetHbVar('nTotUno')" )
   oFr:AddVariable(     "Albaranes",             "Total segundo descuento definible",   "GetHbVar('nTotDos')" )
   oFr:AddVariable(     "Albaranes",             "Total " + cImp(),                           "GetHbVar('nTotIva')" )
   oFr:AddVariable(     "Albaranes",             "Total RE",                            "GetHbVar('nTotReq')" )
   oFr:AddVariable(     "Albaranes",             "Total retención",                     "GetHbVar('nTotRet')" )
   oFr:AddVariable(     "Albaranes",             "Bruto primer tipo de " + cImp(),            "GetHbArrayVar('aIvaUno',1)" )
   oFr:AddVariable(     "Albaranes",             "Bruto segundo tipo de " + cImp(),           "GetHbArrayVar('aIvaDos',1)" )
   oFr:AddVariable(     "Albaranes",             "Bruto tercer tipo de " + cImp(),            "GetHbArrayVar('aIvaTre',1)" )
   oFr:AddVariable(     "Albaranes",             "Base primer tipo de " + cImp(),             "GetHbArrayVar('aIvaUno',2)" )
   oFr:AddVariable(     "Albaranes",             "Base segundo tipo de " + cImp(),            "GetHbArrayVar('aIvaDos',2)" )
   oFr:AddVariable(     "Albaranes",             "Base tercer tipo de " + cImp(),             "GetHbArrayVar('aIvaTre',2)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje primer tipo " + cImp(),          "GetHbArrayVar('aIvaUno',3)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje segundo tipo " + cImp(),         "GetHbArrayVar('aIvaDos',3)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje tercer tipo " + cImp(),          "GetHbArrayVar('aIvaTre',3)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje primer tipo RE",           "GetHbArrayVar('aIvaUno',4)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje segundo tipo RE",          "GetHbArrayVar('aIvaDos',4)" )
   oFr:AddVariable(     "Albaranes",             "Porcentaje tercer tipo RE",           "GetHbArrayVar('aIvaTre',4)" )
   oFr:AddVariable(     "Albaranes",             "Importe primer tipo " + cImp(),             "GetHbArrayVar('aIvaUno',5)" )
   oFr:AddVariable(     "Albaranes",             "Importe segundo tipo " + cImp(),            "GetHbArrayVar('aIvaDos',5)" )
   oFr:AddVariable(     "Albaranes",             "Importe tercer tipo " + cImp(),             "GetHbArrayVar('aIvaTre',5)" )
   oFr:AddVariable(     "Albaranes",             "Importe primer RE",                   "GetHbArrayVar('aIvaUno',6)" )
   oFr:AddVariable(     "Albaranes",             "Importe segundo RE",                  "GetHbArrayVar('aIvaDos',6)" )
   oFr:AddVariable(     "Albaranes",             "Importe tercer RE",                   "GetHbArrayVar('aIvaTre',6)" )

   oFr:AddVariable(     "Lineas de albaranes",   "Código del artículo con propiedades",      "CallHbFunc('cCodAlbPrv')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Detalle del artículo",                     "CallHbFunc('cDesAlbPrv')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Total unidades artículo",                  "CallHbFunc('nTotNAlbPrv')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Precio unitario del artículo",             "CallHbFunc('nTotUAlbPrv')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Total línea de albaran",                   "CallHbFunc('nTotLAlbPrv')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Código de barras para primera propiedad",  "CallHbFunc('cBarPrp1')" )
   oFr:AddVariable(     "Lineas de albaranes",   "Código de barras para segunda propiedad",  "CallHbFunc('cBarPrp2')" )

Return nil



Function DesignReportAlbPrv( oFr, dbfDoc )

   local lOpen    := .F.
   local lFlag    := .F.





   if lOpenFiles
      lFlag       := .T.
   else
      if Openfiles()
         lFlag    := .T.
         lOpen    := .T.
      else
         lFlag    := .F.
      end
   end

   if lFlag





      DataReport( oFr )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "CallHbFunc('nTotAlbPrv');"                                 + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "CabeceraColumnas",  "MainPage", 6 )
         oFr:SetProperty(     "CabeceraColumnas",  "Top", 200 )
         oFr:SetProperty(     "CabeceraColumnas",  "Height", 0 )
         oFr:SetProperty(     "CabeceraColumnas",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "CabeceraColumnas",  "DataSet", "Albaranes" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de albaranes" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      VariableReport( oFr )





      oFr:DesignReport()





      oFr:DestroyFr()





      if lOpen
         CloseFiles()
      end

   else

      Return .F.

   end

Return .T.



Function PrintReportAlbPrv( nDevice, nCopies, cPrinter, dbfDoc )

   local oFr
   local cFilePdf       := cPatTmp() + "AlbaranProveedor" +  ( dbfAlbPrvT )->cSerAlb + Alltrim( Str( ( dbfAlbPrvT )->nNumAlb ) ) + ".Pdf"

   IIF( nCopies == nil, nCopies := 1, ) ;
   IIF( nDevice == nil, nDevice := 2, ) ;
   IIF( cPrinter == nil, cPrinter := PrnGetName(), ) ;

   SysRefresh()

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





   DataReport( oFr )





   if !Empty( ( dbfDoc )->mReport )

      oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





      VariableReport( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2
            oFr:ShowPreparedReport()

         case nDevice == 1
            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:Print()

         case nDevice == 3

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatTmp() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .T. )
            oFr:DoExport(     "PDFExport" )

         case nDevice == 6

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatTmp() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .F. )
            oFr:DoExport(     "PDFExport" )

            if file( cFilePdf )

               with object ( TGenMailing():New() )

                  :SetTypeDocument( "nAlbPrv" )
                  :SetDe(           uFieldEmpresa( "cNombre" ) )
                  :SetCopia(        uFieldEmpresa( "cCcpMai" ) )
                  :SetAdjunto(      cFilePdf )
                  :SetPara(         RetFld( ( dbfAlbPrvT )->cCodPrv, dbfPrv, "cMeiInt" ) )
                  :SetAsunto(       "Envio de albaran de proveedor número " + ( dbfAlbPrvT )->cSerAlb + "/" + Alltrim( Str( ( dbfAlbPrvT )->nNumAlb ) ) )
                  :SetMensaje(      "Adjunto le remito nuestro albaran de proveedor " + ( dbfAlbPrvT )->cSerAlb + "/" + Alltrim( Str( ( dbfAlbPrvT )->nNumAlb ) ) + Space( 1 ) )
                  :SetMensaje(      "de fecha " + Dtoc( ( dbfAlbPrvT )->dfecAlb ) + Space( 1 ) )
                  :SetMensaje(      Chr(13)+Chr(10) )
                  :SetMensaje(      Chr(13)+Chr(10) )
                  :SetMensaje(      "Reciba un cordial saludo." )

                  :GeneralResource( dbfAlbPrvT, aItmAlbPrv() )

               end

            end

      end

   end





   oFr:DestroyFr()

Return .T.





FUNCTION nIncUAlbPrv( dbfTmpLin, nDec, nVdv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUAlbPrv( dbfTmpLin, nDec, nVdv )

   if !( dbfTmpLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfTmpLin )->nIva / 100
   end

   IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nIncLAlbPrv( dbfLin, nDec, nRouDec, nVdv )

   local nCalculo := nTotLAlbPrv( dbfLin, nDec, nRouDec, nVdv )

   if !( dbfLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfLin )->nIva / 100
   end

RETURN ( nCalculo )



Static Function YearComboBoxChange()

     if oWndBrw:oWndBar:lAllYearComboBox()
        DestroyFastFilter( dbfAlbPrvT )
      CreateUserFilter( "", dbfAlbPrvT, .F., , , "all" )
     else
        DestroyFastFilter( dbfAlbPrvT )
      CreateUserFilter( "Year( Field->dFecAlb ) == " + oWndBrw:oWndBar:cYearComboBox(), dbfAlbPrvT, .F., , , "Year( Field->dFecAlb ) == " + oWndBrw:oWndBar:cYearComboBox() )
     end

     ( dbfAlbPrvT )->( dbGoTop() )

     oWndBrw:Refresh()

Return nil



FUNCTION cBarPrp1( uAlbPrvL, uTblPro )

   local cBarPrp1    := ""

   IIF( uAlbPrvL == nil, uAlbPrvL := if( !Empty( tmpAlbPrvL ), tmpAlbPrvL, dbfAlbPrvL ), ) ;
   IIF( uTblPro == nil, uTblPro := dbfTblPro, ) ;

   if dbSeekInOrd( ( uAlbPrvL )->cCodPr1 + ( uAlbPrvL )->cValPr1, "cCodPro", uTblPro )
      cBarPrp1       := ( uTblPro )->nBarTbl
   end

RETURN ( cBarPrp1 )



FUNCTION cBarPrp2( uAlbPrvL, uTblPro )

   local cBarPrp2    := ""

   IIF( uAlbPrvL == nil, uAlbPrvL := if( !Empty( tmpAlbPrvL ), tmpAlbPrvL, dbfAlbPrvL ), ) ;
   IIF( uTblPro == nil, uTblPro := dbfTblPro, ) ;

   if dbSeekInOrd( ( uAlbPrvL )->cCodPr2 + ( uAlbPrvL )->cValPr2, "cCodPro", uTblPro )
      cBarPrp2       := ( uTblPro )->nBarTbl
   end

RETURN ( cBarPrp2 )



Function IcgMotor()

   local oDlg
   local aFichero
   local oInforme
   local oBrwFichero
   local oTreeImportacion
   local oImageImportacion

   aFichero                         := {}
   cInforme                         := ""

   oDlg = TDialog():New(,,,,, "ImportarICG",, .F.,,,,,, .F.,,,,,, .F., )





      oBrwFichero                   := TXBrowse():New( oDlg )

      oBrwFichero:bClrSel           := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwFichero:bClrSelFocus      := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwFichero:SetArray( aFichero, , , .F. )

      oBrwFichero:nMarqueeStyle     := 5

      oBrwFichero:lHScroll          := .F.

      oBrwFichero:CreateFromResource( 220 )

      oBrwFichero:bLDblClick        := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( aFichero[ oBrwFichero:nArrayAt ] ) ) }

      with object ( oBrwFichero:AddCol() )
         :cHeader          := "Fichero"
         :bEditValue       := {|| aFichero[ oBrwFichero:nArrayAt ] }
         :nWidth           := 460
      end




      TButton():ReDefine( 200, {||( AddFicheroICG( aFichero, oBrwFichero ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 210, {||( DelFicheroICG( aFichero, oBrwFichero ) )}, oDlg,,, .F.,,,, .F. )








      oInforme := TMultiGet():ReDefine( 230, { | u | If( PCount()==0, cInforme, cInforme:= u ) }, oDlg,,,,,,, .F.,, .F.,, )




      TButton():ReDefine( 1, {||( IcgAlbPrv( aFichero, oDlg, oInforme ) )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:AddFastKey( 116, {|| IcgAlbPrv( aFichero, oDlg, oInforme ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN ( oDlg:nResult == 1 )












Static Function AddFicheroICG( aFichero, oBrwFichero )

   local i
   local cFile
   local aFile
   local nFlag    := nOr( 0x00000800, 0x00000008, 0x00000200, 0x00080000, 0x00200000 )

   cFile          := cGetFile( "All | *.*", "Seleccione los ficheros a importar", "*.*" , , .F., .T., nFlag )
   cFile          := Left( cFile, At( Chr( 0 ) + Chr( 0 ), cFile ) - 1 )

   if !Empty( cFile )

      cFile       := StrTran( cFile, Chr( 0 ), "," )
      aFile       := hb_aTokens( cFile, "," )

      if Len( aFile ) > 1

         for i := 2 to Len( aFile )
            aFile[ i ] := aFile[ 1 ] + "\" + aFile[ i ]
         next

         aDel( aFile, 1, .T. )

      endif

      if IsArray( aFile )

         for i := 1 to Len( aFile )
            aAdd( aFichero, aFile[ i ] )
         next

      else

         aAdd( aFichero, aFile )

      endif

   end

   oBrwFichero:Refresh()

RETURN ( aFichero )



Static Function DelFicheroICG( aFichero, oBrwFichero )

   aDel( aFichero, oBrwFichero:nArrayAt, .T. )

   oBrwFichero:Refresh()

RETURN ( nil )



FUNCTION IcgAlbPrv( aFichero, oDlg, oInforme )

   local nBytes
   local aTotAlb
   local cSerDoc
   local nNumDoc
   local cSufDoc
   local dFecDoc
   local cRefLin
   local cDesLin
   local nUntLin
   local nPvpLin
   local nDtoLin
   local cFilEdm
   local hFilEdm
   local cBuffer

   cInforme                := ""





   for each cFilEdm in aFichero

      if file( cFilEdm )

         cInforme          += "Importando el fichero " + cFilEdm + Chr(13)+Chr(10)





         hFilEdm           := fOpen( cFilEdm )

         fSeek( hFilEdm, 0, 0 )

         SysRefresh()

         cBuffer           := Space( 211 )
         nBytes            := fRead( hFilEdm, @cBuffer, 211 )

         cSerDoc           := SubStr( cBuffer,  9, 1 )
         nNumDoc           := SubStr( cBuffer, 11, 8 )
         cSufDoc           := SubStr( cBuffer,  9, 2 )
         dFecDoc           := SubStr( cBuffer, 20, 8 )

         IcgCabAlbPrv( cSerDoc, nNumDoc, cSufDoc, dFecDoc )

         cBuffer           := Space( 211 )

         nBytes            := fRead( hFilEdm, @cBuffer, 211 )

         cBuffer           := Space( 211 )

         while ( nBytes    := fRead( hFilEdm, @cBuffer, 211 ) ) == 211

            cBuffer        := Alltrim( cBuffer )

            cDesLin        := Upper( AllTrim( SubStr( cBuffer, 26, 30 ) ) )

            nUntLin        := SubStr( cBuffer, 57, 5 )

            if At( "-", nUntLin ) <> 0
               nUntLin     := StrTran( nUntLin, "-", "" )
               nUntLin     := Val( nUntLin ) * -1
            else
               nUntLin     := Val( nUntLin )
            end

            nPvpLin        := Val( SubStr( cBuffer, 63, 7 ) )

            nDtoLin        := Val( SubStr( cBuffer, 71, 7 ) )

            if ( nDtoLin >= 100 )

               cRefLin     := Alltrim( SubStr( cBuffer, 88, 8 ) )



               fRead( hFilEdm, @cBuffer, 1 )

            else

               cRefLin     := Alltrim( SubStr( cBuffer, 87, 8 ) )

            end

            if Left( cDesLin, 1 ) <> "*"
               IcgDetAlbPrv( cSerDoc, cSufDoc, cDesLin, nUntLin, nPvpLin, nDtoLin, cRefLin )
            end

            SysRefresh()

            cBuffer        := Space( 211 )

         end

         fClose( hFilEdm )



         if dbLock( dbfAlbPrvT )

            aTotAlb                 := aTotAlbPrv( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb, dbfAlbPrvT, dbfAlbPrvL, dbfIva, dbfDiv, ( dbfAlbPrvT )->cDivAlb )

            ( dbfAlbPrvT )->nTotNet := aTotAlb[ 1 ]
            ( dbfAlbPrvT )->nTotIva := aTotAlb[ 2 ]
            ( dbfAlbPrvT )->nTotReq := aTotAlb[ 3 ]
            ( dbfAlbPrvT )->nTotAlb := aTotAlb[ 4 ]

            ( dbfAlbPrvT )->( dbUnLock() )

         end

      else

         cInforme                   += "No existe el fichero " + cFilEdm + Chr(13)+Chr(10)

      end

   next

   oInforme:cText( cInforme )

RETURN ( nil )



Static Function IcgCabAlbPrv( cSerDoc, nNumDoc, cSufDoc, dFecDoc )

   local lApp
   local cCodPrv                 := Replicate( "0", RetNumCodPrvEmp() )

   if dbSeekInOrd( cSerDoc + nNumDoc + cSufDoc, "cSuAlb", dbfAlbPrvT )

      lApp                       := .F.
      cSerDoc                    := ( dbfAlbPrvT )->cSerAlb
      nNumAlb                    := ( dbfAlbPrvT )->nNumAlb
      cSufDoc                    := ( dbfAlbPrvT )->cSufAlb

      while ( dbfAlbPrvL )->( dbSeek( cSerDoc + Str( nNumAlb ) + cSufDoc ) )
         if dbLock( dbfAlbPrvL )
            ( dbfAlbPrvL )->( dbDelete() )
            ( dbfAlbPrvL )->( dbUnLock() )
         end
      end

   else

      lApp                       := .T.
      nNumAlb                    := nNewDoc( cSerDoc, dbfAlbPrvT, "nAlbPrv", , dbfCount )

   end

   if lApp
      dbAppe( dbfAlbPrvT )
   else
      dbLock( dbfAlbPrvT )
   end

      ( dbfAlbPrvT )->cSerAlb    := cSerDoc
      ( dbfAlbPrvT )->nNumAlb    := nNumAlb
      ( dbfAlbPrvT )->cSufAlb    := cSufDoc
      ( dbfAlbPrvT )->dFecAlb    := Stod( dFecDoc )
      ( dbfAlbPrvT )->cCodAlm    := oUser():cAlmacen()
      ( dbfAlbPrvT )->cDivAlb    := cDivEmp()
      ( dbfAlbPrvT )->nVdvAlb    := nChgDiv( cDivEmp(), dbfDiv )
      ( dbfAlbPrvT )->cSuAlb     := cSerDoc + nNumDoc + cSufDoc
      ( dbfAlbPrvT )->cCodUsr    := cCurUsr()
      ( dbfAlbPrvT )->cCodDlg    := oUser():cDelegacion()
      ( dbfAlbPrvT )->cCodCaj    := oUser():cCaja()
      ( dbfAlbPrvT )->cTurAlb    := cCurSesion()

      ( dbfAlbPrvT )->cCodPrv    := cCodPrv

      if ( dbfPrv )->( dbSeek( cCodPrv ) )
         ( dbfAlbPrvT )->cNomPrv := ( dbfPrv )->Titulo
         ( dbfAlbPrvT )->cDirPrv := ( dbfPrv )->Domicilio
         ( dbfAlbPrvT )->cPobPrv := ( dbfPrv )->Poblacion
         ( dbfAlbPrvT )->cProPrv := ( dbfPrv )->Provincia
         ( dbfAlbPrvT )->cPosPrv := ( dbfPrv )->CodPostal
         ( dbfAlbPrvT )->cDniPrv := ( dbfPrv )->Nif
      end

   ( dbfAlbPrvT )->( dbUnlock() )

RETURN ( nil )



Static Function IcgDetAlbPrv( cSerDoc, cSufDoc, cDesLin, nUntLin, nPvpLin, nDtoLin, cRefLin )

   if !dbSeekInOrd( cRefLin, "Codigo", dbfArticulo )
      cInforme                += "Articulo " + cRefLin + " no existe en la base de datos, albaran número " + cSerDoc + "/" + Alltrim( Str( nNumAlb ) ) + "/" + RetSufEmp() + Chr(13)+Chr(10)
   end

   ( dbfAlbPrvL )->( dbAppend() )
   ( dbfAlbPrvL )->cSerAlb    := cSerDoc
   ( dbfAlbPrvL )->nNumAlb    := nNumAlb
   ( dbfAlbPrvL )->cSufAlb    := cSufDoc
   ( dbfAlbPrvL )->cAlmLin    := oUser():cAlmacen()
   ( dbfAlbPrvL )->cRef       := cRefLin
   ( dbfAlbPrvL )->cDetalle   := cDesLin
   ( dbfAlbPrvL )->mLngDes    := cDesLin
   ( dbfAlbPrvL )->nUniCaja   := nUntLin
   ( dbfAlbPrvL )->nPreDiv    := nPvpLin
   ( dbfAlbPrvL )->nDtoLin    := nDtoLin
   ( dbfAlbPrvL )->nIva       := nIva( dbfIva, "G" )
   ( dbfAlbPrvL )->( dbUnlock() )

RETURN ( nil )



Function dFechaCaducidadLote( cCodArt, cValPr1, cValPr2, cLote, dbfAlbPrvL, dbfFacPrvL )

   local dFechaCaducidad      := Ctod( "" )

   if dbSeekInOrd( cCodArt + cValPr1 + cValPr2 + cLote, "cRefLote", dbfAlbPrvL )
      dFechaCaducidad         := ( dbfAlbPrvL )->dFecCad
   else
      if dbSeekInOrd( cCodArt + cValPr1 + cValPr2 + cLote, "cRefLote", dbfFacPrvL )
         dFechaCaducidad      := ( dbfFacPrvL )->dFecCad
      end
   end

Return ( dFechaCaducidad )



Static Function EditarNumerosSerie( aTmp, nMode )

   oNumerosSerie:nMode              := nMode

   oNumerosSerie:cCodArt            := aTmp[ 4    ]
   oNumerosSerie:cCodAlm            := aTmp[ 58 ]
   oNumerosSerie:nNumLin            := aTmp[ 63 ]
   oNumerosSerie:lAutoSerializacion := aTmp[ 107 ]

   oNumerosSerie:nTotalUnidades     := nTotNAlbPrv( aTmp )

   oNumerosSerie:uTmpSer            := dbfTmpSer

   if oNumerosSerie:lAutoSerializacion
       oNumerosSerie:AutoSerializa()
   end

   oNumerosSerie:Resource()

Return ( nil )



Static Function AutoNumerosSerie( aTmp, nMode )

   oNumerosSerie:nMode              := nMode

   oNumerosSerie:cCodArt            := aTmp[ 4    ]
   oNumerosSerie:cCodAlm            := aTmp[ 58 ]
   oNumerosSerie:nNumLin            := aTmp[ 63 ]
   oNumerosSerie:lAutoSerializacion := aTmp[ 107 ]

   oNumerosSerie:nTotalUnidades     := nTotNAlbPrv( aTmp )

   oNumerosSerie:uTmpSer            := dbfTmpSer

   if oNumerosSerie:lAutoSerializacion
       oNumerosSerie:AutoSerializa()
   end

Return ( nil )



Static Function EliminarNumeroSerie( aTmp )

   while ( ( dbfTmpSer )->( dbSeek( Str( aTmp[ 63 ], 4 ) + aTmp[ 4 ] ) ) ) .AND. !( dbfTmpSer )->( Eof() )
      ( dbfTmpSer )->( dbDelete() )
   end

Return ( nil )
