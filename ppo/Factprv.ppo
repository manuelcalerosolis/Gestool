#line 112 "hbclass.ch"
   DYNAMIC DivertConstructorCall
















DECLARE HBClass  New( cName AS String, OPTIONAL SuperParams ) AS CLASS HBClass  Create() AS Object  Instance() AS Object  AddClsMethod( cName AS String, @MethodName(), nScope AS Numeric, n2 AS Numeric, n3 AS Numeric )  AddDelegate( cName AS String, cDelegate AS String, cObject AS String, nScope AS Numeric, lPersistent AS LOGICAL )  AddMultiClsData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String )  AddMultiData( cType AS String, uVal, nScope AS Numeric, aDatas AS Array OF String, x AS LOGICAL, lPer AS LOGICAL )  AddMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  AddInLine( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  AddVirtual( cName AS String )  ModMethod( cName AS String, @MethodName(), nScope AS Numeric, lPersistent AS LOGICAL )  ModClsMethod( cName AS String, @MethodName(), nScope AS Numeric )  ModInline( cName AS String, bBlock AS CodeBlock, nScope AS Numeric, lPersistent AS LOGICAL )  SetOnError( @MethodName() )
#line 85 "\Fwh1204\Include\FiveWin.Ch"
   EXTERNAL GetProcAdd
   EXTERNAL TActiveX




extern errorsys
#line 223 ".\Prg\Factprv.prg"
memvar cDbf
memvar cDbfCol
memvar cDbfRec
memvar cDbfAlm
memvar cDbfPrv
memvar cDbfPgo
memvar cDbfIva
memvar cDbfDiv
memvar cDbfArt
memvar cDbfKit
memvar cDbfPro
memvar cDbfTblPro
memvar aTotIva
memvar aIvaUno
memvar aIvaDos
memvar aIvaTre
memvar aDatVcto
memvar aImpVcto
memvar nTotBrt
memvar nTotNet
memvar nTotSup
memvar nTotIva
memvar nTotReq
memvar nTotRet
memvar nTotFac
memvar nTotDto
memvar nTotDpp
memvar nTotUno
memvar nTotDos
memvar nTotImp
memvar nTotUnd
memvar nPagFac
memvar nTipRet
memvar nTotPage
memvar cPinDivFac
memvar cPirDivFac
memvar cPicEurFac
memvar nDinDivFac
memvar nDirDivFac
memvar nVdvDivFac
memvar nPagina
memvar lEnd
memvar aImpVto
memvar aDatVto





static oWndBrw
static oBrwIva
static oInf
static dbfFacPrvT
static dbfRctPrvT
static dbfRctPrvL
static dbfIva
static dbfInci
static dbfFacPrvL
static filFacPrvL
static tmpFacPrvT
static tmpFacPrvP
static tmpFacPrvL
static tmpFacPrvI
static tmpFacPrvS
static dbfFacPrvP
static dbfFacPrvI
static dbfFacPrvD
static dbfFacPrvS
static dbfPedPrvT
static dbfPedPrvL
static dbfPrv
static dbfArtPrv
static dbfFPago
static dbfTmp
static dbfTmpSer
static dbfKit
static dbfArticulo
static dbfUbicaL
static dbfCodebar
static dbfFamilia
static dbfTblCnv
static dbfArtCom
static dbfPro
static dbfDoc
static dbfCajT
static dbfTblPro
static dbfDiv
static dbfUsr
static dbfFlt
static dbfCount
static oBandera
static dbfAlbPrvT
static dbfAlbPrvL
static dbfAlbPrvS
static dbfDelega
static dbfEmp
static dbfAlm
static dbfPedCliL
static dbfAlbCliL
static dbfFacCliL
static dbfFacRecL
static dbfTikCliL
static dbfProLin
static dbfProMat
static dbfHisMov
static oStock
static cNewFile
static cPicEur
static cPicUnd
static cPinDiv
static cPouDiv
static cPorDiv
static cTmpInc
static cTmpDoc
static cTmpPgo
static cTmpSer
static dbfTmpInc
static dbfTmpDoc
static dbfTmpPgo
static cPirDiv
static nDinDiv
static nRinDiv
static oGetTotal
static oGetTotPg
static oGetRet
static oGetNet
static oGetIva
static oGetReq
static oGetPgd
static oGetPdt
static oUsr
static cUsr
static oFntTot
static oBanco
static dbfPrvBnc
static oUndMedicion

static oMnuPgo
static oMnuRec

static aNumAlb          := {}
static nGetNeto         := 0
static nGetIva          := 0
static nGetReq          := 0
static nGetPgd          := 0
static cOldCodCli       := ""
static cOldCodArt       := ""
static cOldPrpArt       := ""
static cOldUndMed       := ""
static lOpenFiles       := .F.
static lExternal        := .F.
static nLabels          := 1
static cFiltroUsuario   := ""
static bEdtRec          := { |aTmp, aGet, dbfFacPrvT, oBrw, bWhen, bValid, nMode, cNumAlb | EdtRec( aTmp, aGet, dbfFacPrvT, oBrw, bWhen, bValid, nMode, cNumAlb ) }
static bEdtDet          := { |aTmp, aGet, dbfFacPrvT, oBrw, bWhen, bValid, nMode, aFac    | EdtDet( aTmp, aGet, dbfFacPrvT, oBrw, bWhen, bValid, nMode ) }
static bEdtInc          := { |aTmp, aGet, dbfFacPrvI, oBrw, bWhen, bValid, nMode, aTmpLin | EdtInc( aTmp, aGet, dbfFacPrvI, oBrw, bWhen, bValid, nMode, aTmpLin ) }
static bEdtDoc          := { |aTmp, aGet, dbfFacPrvD, oBrw, bWhen, bValid, nMode, aTmpLin | EdtDoc( aTmp, aGet, dbfFacPrvD, oBrw, bWhen, bValid, nMode, aTmpLin ) }

static oNumerosSerie
static oBtnNumerosSerie







STATIC FUNCTION OpenFiles( lExt )

   local oBlock

   if lOpenFiles
      MsgStop( "Imposible abrir ficheros de facturas a proveedores" )
      Return ( .F. )
   end

   IIF( lExt == nil, lExt := .F., ) ;

   lExternal            := lExt

   oBlock               := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      DisableAcceso()

      lOpenFiles        := .T.

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVT.DBF" ), ( cCheckArea( "FACPRVT", @dbfFacPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @dbfFacPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVI.DBF" ), ( cCheckArea( "FACPRVI", @dbfFacPrvI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVD.DBF" ), ( cCheckArea( "FACPRVD", @dbfFacPrvD ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVD.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVS.DBF" ), ( cCheckArea( "FACPRVS", @dbfFacPrvS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVP.DBF" ), ( cCheckArea( "FACPRVP", @dbfFacPrvP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatPrv() + "PROVEE.DBF" ), ( cCheckArea( "PROVEE", @dbfPrv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatPrv() + "PROVEE.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PROVART.DBF" ), ( cCheckArea( "PROVART", @dbfArtPrv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PROVART.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodPrv" )

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ArtCodebar.Dbf" ), ( cCheckArea( "CODEBAR", @dbfCodebar ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ArtCodebar.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ARTKIT.DBF" ), ( cCheckArea( "ARTTIK", @dbfKit ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ARTKIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatGrp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatGrp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "ArtDiv.Dbf" ), ( cCheckArea( "ARTCOM", @dbfArtCom ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "ArtDiv.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "CNFFLT.DBF" ), ( cCheckArea( "CNFFLT", @dbfFlt ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "CNFFLT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TBLCNV.DBF" ), ( cCheckArea( "TBLCNV", @dbfTblCnv ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TBLCNV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVT.DBF" ), ( cCheckArea( "ALBPROVT", @dbfAlbPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVL.DBF" ), ( cCheckArea( "ALBPROVL", @dbfAlbPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPRVS.DBF" ), ( cCheckArea( "ALBPRVS", @dbfAlbPrvS ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPRVS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "Cajas.Dbf" ), ( cCheckArea( "CAJAS", @dbfCajT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "Cajas.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDPROVT.DBF" ), ( cCheckArea( "PEDPROVT", @dbfPedPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDPROVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDPROVL.DBF" ), ( cCheckArea( "PEDPROVL", @dbfPedPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIPINCI.DBF" ), ( cCheckArea( "TIPINCI", @dbfInci ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIPINCI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "PRO.DBF" ), ( cCheckArea( "PRO", @dbfPro ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "PRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatArt() + "TBLPRO.DBF" ), ( cCheckArea( "TBLPRO", @dbfTblPro ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatArt() + "TBLPRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatAlm() + "ALMACEN.DBF" ), ( cCheckArea( "ALMACEN", @dbfAlm ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatAlm() + "ALMACEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RDOCUMEN.DBF" ), ( cCheckArea( "RDOCUMEN", @dbfDoc ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RDOCUMEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CTIPO" )

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "USERS.DBF" ), ( cCheckArea( "USERS", @dbfUsr ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "USERS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatAlm() + "UBICAL.DBF" ), ( cCheckArea( "UBICAL", @dbfUbicaL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatAlm() + "UBICAL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DELEGA.DBF" ), ( cCheckArea( "DELEGA", @dbfDelega ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DELEGA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "NCOUNT.DBF" ), ( cCheckArea( "NCOUNT", @dbfCount ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "NCOUNT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "EMPRESA.DBF" ), ( cCheckArea( "EMPRESA", @dbfEmp ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatDat() + "EMPRESA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PedCliL.Dbf" ), ( cCheckArea( "PedCLIL", @dbfPedCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PedCliL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIL.DBF" ), ( cCheckArea( "ALBCLIL", @dbfAlbCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cStkFast" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvT.DBF" ), ( cCheckArea( "RctPrvT", @dbfRctPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "RctPrvL", @dbfRctPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIL.DBF" ), ( cCheckArea( "FACCLIL", @dbfFacCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecL.DBF" ), ( cCheckArea( "FacRecL", @dbfFacRecL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikCliL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKEL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CSTKFAST" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROLIN.DBF" ), ( cCheckArea( "PROLIN", @dbfProLin ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROLIN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMAT.DBF" ), ( cCheckArea( "PROMAT", @dbfProMat ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMAT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "HISMOV.DBF" ), ( cCheckArea( "HISMOV", @dbfHisMov ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "HISMOV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRefMov" )

      dbUseArea( .T., ( cDriver() ), ( cPatPrv() + "PRVBNC.DBF" ), ( cCheckArea( "PRVBNC", @dbfPrvBnc ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatPrv() + "PRVBNC.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end



      oUndMedicion      := UniMedicion():Create( cPatGrp() )
      if !oUndMedicion:OpenFiles()
         lOpenFiles     := .F.
      end

      oBandera          := TBandera():New()

      oStock            := TStock():Create( cPatGrp() )
      if !oStock:lOpenFiles()
         lOpenFiles     := .F.
      else
      oStock:cKit       := dbfKit

      oStock:cPedPrvT   := dbfPedPrvT
      oStock:cPedPrvL   := dbfPedPrvL

      oStock:cAlbPrvT   := dbfAlbPrvT
      oStock:cAlbPrvL   := dbfAlbPrvL
      oStock:cAlbPrvS   := dbfAlbPrvS

      oStock:cFacPrvT   := dbfFacPrvT
      oStock:cFacPrvL   := dbfFacPrvL
      oStock:cFacPrvS   := dbfFacPrvS
      oStock:cRctPrvL   := dbfRctPrvL

      oStock:cPedCliL   := dbfPedCliL
      oStock:cAlbCliL   := dbfAlbCliL
      oStock:cFacCliL   := dbfFacCliL
      oStock:cFacRecL   := dbfFacRecL
      oStock:cTikL      := dbfTikCliL

      oStock:cProducL   := dbfProLin
      oStock:cProducM   := dbfProMat

      oStock:cHisMov    := dbfHisMov
      end

      oBanco            := TBancos():Create()
      if !oBanco:OpenFiles()
         lOpenFiles     := .F.
      end

      oFntTot           := TFont():New( "Arial", 8, 26, .F., .T. )





      public nTotBrt    := 0
      public nTotNet    := 0
      public nTotSup    := 0
      public nTotIva    := 0
      public nTotReq    := 0
      public nTotRet    := 0
      public nTotFac    := 0
      public nTotDto    := 0
      public nTotDpp    := 0
      public nTotUno    := 0
      public nTotDos    := 0
      public nTotImp    := 0
      public nTotUnd    := 0
      public nPagFac    := 0
      public nTipRet    := 0
      public aTotIva    := { { 0,0,nil,0,0,0 }, { 0,0,nil,0,0,0 }, { 0,0,nil,0,0,0 } }
      public aIvaUno    := aTotIva[ 1 ]
      public aIvaDos    := aTotIva[ 2 ]
      public aIvaTre    := aTotIva[ 3 ]





      if oUser():lFiltroVentas()
         cFiltroUsuario       := "Field->cCodUsr == '" + oUser():cCodigo() + "' .and. Field->cCodCaj == '" + oUser():cCaja() + "'"
      end





      oNumerosSerie           := TNumerosSerie()
      oNumerosSerie:lCompras  := .T.
      oNumerosSerie:oStock    := oStock

      EnableAcceso()

   RECOVER

      lOpenFiles        := .F.

      EnableAcceso()

      msgStop( "Imposible abrir todas las bases de datos" )

   end

   ErrorBlock( oBlock )

Return ( lOpenFiles )



Static Function CloseFiles()

   DisableAcceso()

   DestroyFastFilter( dbfFacPrvT, .T., .T. )

   if dbfFacPrvT <> nil
      ( dbfFacPrvT )->( dbCloseArea() )
   end

   if dbfFacPrvL <> nil
      ( dbfFacPrvL )->( dbCloseArea() )
   end

   if dbfFacPrvI <> nil
      ( dbfFacPrvI )->( dbCloseArea() )
   end

   if dbfFacPrvD <> nil
      ( dbfFacPrvD )->( dbCloseArea() )
   end

   if dbfFacPrvS <> nil
      ( dbfFacPrvS )->( dbCloseArea() )
   end

   if dbfRctPrvL <> nil
      ( dbfRctPrvL )->( dbCloseArea() )
   end

   if dbfRctPrvT <> nil
      ( dbfRctPrvT )->( dbCloseArea() )
   end

   if dbfPedPrvT <> nil
      ( dbfPedPrvT )->( dbCloseArea() )
   end

   if dbfPedPrvL <> nil
      ( dbfPedPrvL )->( dbCloseArea() )
   end

   if dbfPrv <> nil
      ( dbfPrv )->( dbCloseArea() )
   end

   if dbfIva <> nil
      ( dbfIva )->( dbCloseArea() )
   end

   if dbfArtPrv <> nil
      ( dbfArtPrv )->( dbCloseArea() )
   end

   if dbfFPago <> nil
      ( dbfFPago )->( dbCloseArea() )
   end

   if dbfArticulo <> nil
      ( dbfArticulo )->( dbCloseArea() )
   end

   if dbfCodebar <> nil
      ( dbfCodebar )->( dbCloseArea() )
   end

   if dbfFamilia <> nil
      ( dbfFamilia )->( dbCloseArea() )
   end

   if dbfKit <> nil
      ( dbfKit )->( dbCloseArea() )
   end

   if !Empty( dbfFlt )
      ( dbfFlt )->( dbCloseArea() )
   end

   if dbfFacPrvP <> nil
      ( dbfFacPrvP )->( dbCloseArea() )
   end

   if dbfArtCom <> nil
      ( dbfArtCom )->( dbCloseArea() )
   end

   if dbfDiv <> nil
      ( dbfDiv )->( dbCloseArea() )
   end

   if ( dbfTblCnv ) <> nil
      ( dbfTblCnv )->( dbCloseArea() )
   end

   if dbfPro <> nil
      ( dbfPro )->( dbCloseArea() )
   end

   if dbfTblPro <> nil
      ( dbfTblPro )->( dbCloseArea() )
   end

   if dbfAlbPrvT <> nil
      ( dbfAlbPrvT )->( dbCloseArea() )
   end

   if dbfAlbPrvL <> nil
      ( dbfAlbPrvL )->( dbCloseArea() )
   end

   if dbfAlbPrvS <> nil
      ( dbfAlbPrvS )->( dbCloseArea() )
   end

   if dbfAlm <> nil
      ( dbfAlm )->( dbCloseArea() )
   end

   if dbfDoc <> nil
      ( dbfDoc )->( dbCloseArea() )
   end

   if dbfCajT <> nil
      ( dbfCajT )->( dbCloseArea() )
   end

   if dbfUbicaL <> nil
      ( dbfUbicaL )->( dbCloseArea() )
   end

   if dbfUsr <> nil
      ( dbfUsr )->( dbCloseArea() )
   end

   if dbfInci <> nil
      ( dbfInci )->( dbCloseArea() )
   end

   if dbfDelega <> nil
      ( dbfDelega )->( dbCloseArea() )
   end

   if dbfCount <> nil
      ( dbfCount )->( dbCloseArea() )
   end

   if dbfEmp <> nil
      ( dbfEmp )->( dbCloseArea() )
   end

   if dbfPedCliL <> nil
      ( dbfPedCliL )->( dbCloseArea() )
   end

   if dbfAlbCliL <> nil
      ( dbfAlbCliL )->( dbCloseArea() )
   end

   if dbfFacCliL <> nil
      ( dbfFacCliL )->( dbCloseArea() )
   end

   if dbfFacRecL <> nil
      ( dbfFacRecL )->( dbCloseArea() )
   end

   if dbfTikCliL <> nil
      ( dbfTikCliL )->( dbCloseArea() )
   end

   if dbfProLin <> nil
      ( dbfProLin )->( dbCloseArea() )
   end

   if dbfProMat <> nil
      ( dbfProMat )->( dbCloseArea() )
   end

   if dbfHisMov <> nil
      ( dbfHisMov )->( dbCloseArea() )
   end

   if dbfPrvBnc <> nil
      ( dbfPrvBnc )->( dbCloseArea() )
   end

   if !Empty( oUndMedicion )
      oUndMedicion:end()
   end

   if oStock <> nil
      oStock:end()
   end

   if oBanco <> nil
      oBanco:CloseFiles()
      oBanco:End()
   end

   dbfFacPrvT  := nil
   dbfFacPrvL  := nil
   dbfFacPrvI  := nil
   dbfFacPrvD  := nil
   dbfFacPrvS  := nil
   dbfRctPrvT  := nil
   dbfRctPrvL  := nil
   dbfPrv      := nil
   dbfIva      := nil
   dbfArtPrv   := nil
   dbfFPago    := nil
   dbfUbicaL   := nil
   dbfArticulo := nil
   dbfCodebar  := nil
   dbfKit      := nil
   dbfFlt      := nil
   dbfFacPrvP  := nil
   dbfArtCom   := nil
   dbfDiv      := nil
   oBandera    := nil
   dbfTblCnv   := nil
   dbfPro      := nil
   dbfTblPro   := nil
   dbfAlbPrvT  := nil
   dbfAlbPrvL  := nil
   dbfAlbPrvS  := nil
   dbfDoc      := nil
   dbfCajT     := nil
   dbfUsr      := nil
   oStock      := nil
   dbfInci     := nil
   dbfDelega   := nil
   dbfCount    := nil
   oBanco      := nil
   dbfEmp      := nil
   dbfPedCliL  := nil
   dbfAlbCliL  := nil
   dbfFacCliL  := nil
   dbfFacRecL  := nil
   dbfTikCliL  := nil
   dbfProLin   := nil
   dbfProMat   := nil
   dbfHisMov   := nil
   dbfPrvBnc   := nil

   lOpenFiles  := .F.

   oWndBrw     := nil

   if !Empty( oFntTot )
      oFntTot:end()
   end

   EnableAcceso()

RETURN .T.



FUNCTION FacPrv( oMenuItem, oWnd, cCodPrv, cCodArt, cNumAlb )

   local oSnd
   local oRpl
   local oImp
   local oRotor
   local oFlt
   local oDel
   local oPrv
   local oPdf
   local oMail
   local oBtnEur
   local nLevel
   local lEuro          := .F.
   local oLiq

   IIF( oMenuItem == nil, oMenuItem := "01048", ) ;
   IIF( oWnd == nil, oWnd := oWnd(), ) ;
   IIF( cCodPrv == nil, cCodPrv := "", ) ;
   IIF( cCodArt == nil, cCodArt := "", ) ;
   IIF( cNumAlb == nil, cNumAlb := "", ) ;





   nLevel               := nLevelUsr( oMenuItem )
   if nAnd( nLevel, 1 ) <> 0
      msgStop( "Acceso no permitido." )
      return .F.
   end





   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

   if !OpenFiles()
      return .F.
   end





   DisableAcceso()





















   oWndBrw := TShell():New( 0, 0, 22, 80, "Facturas de proveedores",, oWnd,,, .F.,,, ( dbfFacPrvT ),,,,, {"Número", "Fecha", "Código", "Nombre", "Su factura", "Número documento", "Pago", "NFC"}, {||( WinAppRec( oWndBrw:oBrw, bEdtRec, dbfFacPrvT, cCodPrv, cCodArt, cNumAlb ) )}, {||( WinEdtRec( oWndBrw:oBrw, bEdtRec, dbfFacPrvT, cCodPrv, cCodArt, cNumAlb ) )}, {||( WinDelRec( oWndBrw:oBrw, dbfFacPrvT, {|| QuiFacPrv() } ) )}, {||( WinDupRec( oWndBrw:oBrw, bEdtRec, dbfFacPrvT, cCodPrv, cCodArt, cNumAlb ) )}, nil, nLevel, "Document_businessman_16", ( ( 0 + ( 114 * 256 ) + ( 198 * 65536 ) ) ),, {||( WinZooRec( oWndBrw:oBrw, bEdtRec, dbfFacPrvT ) )}, .T. )

      oWndBrw:lFechado     := .T.

      oWndBrw:bChgIndex    := {|| if( oUser():lFiltroVentas(), CreateFastFilter( cFiltroUsuario, dbfFacPrvT, .F., , cFiltroUsuario ), CreateFastFilter( "", dbfFacPrvT, .F. ) ) }

      oWndBrw:SetYearComboBoxChange( {|| YearComboBoxChange() } )

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión cerrada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfFacPrvT )->lCloFac }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Zoom16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfFacPrvT )->lSndDoc }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Lbl16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Pagado"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| ChkPagFacPrv( dbfFacPrvT, dbfFacPrvP ) }
         :nWidth           := 20
         :AddResource( "Bullet_Square_Green_16" )
         :AddResource( "Bullet_Square_Yellow_16" )
         :AddResource( "Bullet_Square_Red_16" )
         :AddResource( "ChgPre16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Contabilizado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfFacPrvT )->lContab }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "BmpConta16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Incidencia"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nEstadoIncidencia( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac ) }
         :nWidth           := 20
         :lHide            := .T.
         :AddResource( "Bullet_Square_Red_16" )
         :AddResource( "Bullet_Square_Yellow_16" )
         :AddResource( "Bullet_Square_Green_16" )
         :AddResource( "Informacion_16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Rectificada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| lRectificadaPrv( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac, dbfFacPrvT, dbfRctPrvT ) }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "Document_navigate_cross_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Impreso"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfFacPrvT )->lImprimido }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "IMP16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( dbfFacPrvT )->cSerFac + "/" + Alltrim( Str( ( dbfFacPrvT )->nNumFac ) )  }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :bEditValue       := {|| ( dbfFacPrvT )->cSufFac  }
         :nWidth           := 20
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Su factura"
         :cSortOrder       := "cSuPed"
         :bEditValue       := {|| ( dbfFacPrvT )->cSuPed }
         :nWidth           := 80
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "NFC"
         :cSortOrder       := "cNfc"
         :bEditValue       := {|| ( dbfFacPrvT )->cNFC }
         :nWidth           := 160
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :bEditValue       := {|| ( dbfFacPrvT )->cCodDlg }
         :nWidth           := 60
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión"
         :bEditValue       := {|| Trans( ( dbfFacPrvT )->cTurFac, "######" ) }
         :nWidth           := 60
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número documento"
         :cSortOrder       := "cNumDoc"
         :bEditValue       := {|| ( dbfFacPrvT )->cNumDoc }
         :nWidth           := 80
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecFac"
         :bEditValue       := {|| Dtoc( ( dbfFacPrvT )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( dbfFacPrvT )->cCodCaj }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Usuario"
         :bEditValue       := {|| ( dbfFacPrvT )->cCodUsr }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodPrv"
         :bEditValue       := {|| ( dbfFacPrvT )->cCodPrv }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomPrv"
         :bEditValue       := {|| ( dbfFacPrvT )->cNomPrv }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Pago"
         :cSortOrder       := "cCodPago"
         :bEditValue       := {|| ( dbfFacPrvT )->cCodPago }
         :nWidth           := 40
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( dbfFacPrvT )->nTotNet }
         :cEditPicture     := cPirDiv( ( dbfFacPrvT )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( dbfFacPrvT )->nTotIva }
         :cEditPicture     := cPirDiv( ( dbfFacPrvT )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "R.E."
         :bEditValue       := {|| ( dbfFacPrvT )->nTotReq }
         :cEditPicture     := cPirDiv( ( dbfFacPrvT )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( dbfFacPrvT )->nTotFac }
         :cEditPicture     := cPirDiv( ( dbfFacPrvT )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( if( lEuro, cDivChg(), ( dbfFacPrvT )->cDivFac ), dbfDiv ) }
         :nWidth           := 30
      end

      oWndBrw:lAutoSeek    := .F.
      oWndBrw:cHtmlHelp    := "Factura de proveedor"

      oWndBrw:CreateXFromCode()





   oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

   oWndBrw:AddSeaBar()








   oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )







   oWndBrw:NewAt( "DUP",,, {||( oWndBrw:RecDup() )}, "(D)uplicar", "D",,, 2,, .F. )







   oWndBrw:NewAt( "EDIT",,, {||( oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )







   oWndBrw:NewAt( "ZOOM",,, {||( oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 8,, .F. )







   oDel := oWndBrw:NewAt( "DEL",,, {||( oWndBrw:RecDel() )}, "(E)liminar", "E",, {|This|This:Toggle()}, 16,, .F. )







   oImp := oWndBrw:NewAt( "IMP",,, {||( nGenFacPrv( 1 ) )}, "(I)mprimir", "I",, {|This|This:Toggle()}, 32,, .F. )


      lGenFac( oWndBrw:oBrw, oImp, 1 )





   oWndBrw:NewAt( "SERIE1",,, {||( PrnSerie( oWndBrw:oBrw ) )}, "Imp(r)imir series", "R",,, 32,, .F. )







   oPrv := oWndBrw:NewAt( "PREV1",,, {||( nGenFacPrv( 2 ), oWndBrw:Refresh() )}, "(P)revisualizar", "P",, {|This|This:Toggle()}, 32,, .F. )


      lGenFac( oWndBrw:oBrw, oPrv, 2 )






   oPdf := oWndBrw:NewAt( "DOCLOCK",,, {||( nGenFacPrv( 3 ) )}, "Pd(f)", "F",, {|This|This:Toggle()}, 32,, .F. )


      lGenFac( oWndBrw:oBrw, oPdf, 3 )





   oMail := oWndBrw:NewAt( "Mail",,, {||( GenFacPrv( 6 ) )}, "Correo electrónico",,, {|This|This:Toggle()}, 32,, .F. )


      lGenFac( oWndBrw:oBrw, oMail, 6 )





   oWndBrw:NewAt( "RemoteControl_",,, {||( TFacturaProveedorLabelGenerator():Create() )}, "Eti(q)uetas", "Q",,, 32,, .F. )





   oLiq := oWndBrw:NewAt( "Money2_",,, {||( lLiquida( oWndBrw:oBrw ) )}, "Pagar",,,, 4,, .F. )







      oWndBrw:NewAt( "Money2_",,, {||( aGetSelRec( oWndBrw, {|| lLiquida( oWndBrw:oBrw, ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac ) }, "Liquidar series de facturas", .T., nil, .T., nil ) )}, "Pagar series",,,, 4, oLiq, .F. )






   oWndBrw:NewAt( "BmpConta",,, {||( aGetSelRec( oWndBrw, {|lChk1, lChk2, oTree | CntFacPrv( lChk1, lChk2, .T., oTree, nil, nil, dbfFacPrvT, dbfFacPrvL, dbfFacPrvP, dbfPrv, dbfDiv, dbfArticulo, dbfFPago, dbfIva ) }, "Contabilizar facturas", .F., "Simular resultados", .F., "Contabilizar pagos" ) )}, "(C)ontabilizar", "C",,, 4,, .F. )

   if oUser():lAdministrador()






   oWndBrw:NewAt( "ChgState",,, {||( aGetSelRec( oWndBrw, {|lChk1| lCntFacPrv( lChk1, dbfFacPrvT ) }, "Cambiar estado", .F., "Contabilizado", .T., "" ) )}, "Cambiar Es(t)ado", "T",,, 4,, .F. )

   end








   oSnd := oWndBrw:NewAt( "Lbl",, "Seleccionar facturas para ser enviados", {||lSnd( oWndBrw, dbfFacPrvT )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )





   oBtnEur := oWndBrw:NewAt( "BAL_EURO",,, {||( lEuro := !lEuro, oWndBrw:Refresh() )}, "M(o)neda", "O",,,,, .F. )






   oWndBrw:NewAt( "INFO",,, {||( TTrazaDocumento():Activate( "03", ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac ) )}, "I(n)forme documento", "N",,, 4,, .F. )

if !oUser():lFiltroVentas()






   oFlt := oWndBrw:NewAt( "BFILTER",,, {||( TDlgFlt():New( aItmFacPrv(), dbfFacPrvT, oFlt, .T., oWndBrw ):Resource( "03", nil, dbfFlt ) )}, "(F)iltrar", "F",,,,, .F. )
   lLoadFiltro( "03", aItmFacPrv(), oFlt, oWndBrw, dbfFlt, dbfFacPrvT )

end

   if oUser():lAdministrador()






      oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( TDlgFlt():New( aItmFacPrv(), dbfFacPrvT ):ChgFields(), oWndBrw:Refresh() )}, "Cambiar campos",,, {|This|This:Toggle()}, 4,, .F. )







         oWndBrw:NewAt( "BMPCHG",,, {||( TDlgFlt():New( aColFacPrv(), dbfFacPrvL ):ChgFields(), oWndBrw:Refresh() )}, "Lineas",,,, 4, oRpl, .F. )

   end




   oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,,, 4,, .F. )





      oWndBrw:NewAt( "Businessman_",,, {||( EdtPrv( ( dbfFacPrvT )->cCodPrv ) )}, "Modificar proveedor",,,, 4, oRotor, .F. )





      oWndBrw:NewAt( "INFO",,, {||( InfProveedor( ( dbfFacPrvT )->cCodPrv ) )}, "Informe proveedor",,,, 4, oRotor, .F. )





      oWndBrw:NewAt( "Document_plain_businessman_",,, {||( if( !Empty( ( dbfFacPrvT )->cNumAlb ), ZooAlbPrv( ( dbfFacPrvT )->cNumAlb ), MsgStop( "La factura no proviene de un albarán" ) ) )}, "Visualizar albarán",,,, 4, oRotor, .F. )






      oWndBrw:NewAt( "Money2_businessman_",,, {||( RecPrv( , , { ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac } ) )}, "Modificar recibo",,,, 4, oRotor, .T. )






      oWndBrw:NewAt( "DOCUMENT_USER1_",,, {||( FactCli( nil, nil, nil, nil, nil, { nil, nil, nil, nil, ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac } ) )}, "Generar factura",,,, 2, oRotor, .T. )





   oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .T. )

   oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles() )},, oWndBrw:bLButtonUp )

   EnableAcceso()

   if !Empty( cCodPrv ) .OR. !Empty( cCodArt ) .OR. !Empty( cNumAlb )
      if !Empty( oWndBrw )
         oWndBrw:RecAdd()
      end
      cCodPrv  := nil
      cCodArt  := nil
      cNumAlb  := nil
   end

Return .T.



STATIC FUNCTION EdtRec( aTmp, aGet, dbfFacPrvT, oBrw, cCodPrv, cCodArt, nMode, cNumAlb )

   local n
   local oDlg
    local oFld
   local oBtnOk
   local oBrwLin
   local oBrwPgo
   local oBrwInc
   local oBrwDoc
   local cGetRet
   local oGet        := Array( 6 )
   local cGet        := Array( 6 )
   local oSayLabels  := Array( 7 )
   local cTlfPrv
   local oTlfPrv
   local oBmpDiv
   local oBmpEmp
   local nOrd        := ( dbfFacPrvT )->( ordSetFocus( 1 ) )
   local aControl    := Array( 6 )
   local oSayGas     := Array( 16 )
   local oBmpGeneral

   cTlfPrv           := RetFld( aTmp[ 6 ], dbfPrv, "Telefono" )
   cUsr              := RetFld( aTmp[ 47 ], dbfUsr, "cNbrUse" )

   do case
   case nMode == 1

      if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 1 ]     := cNewSer( "nFacPrv", dbfCount )
      aTmp[ 3 ]     := RetSufEmp()
      aTmp[ 4 ]     := cCurSesion()
      aTmp[ 36 ]     := cDivEmp()
      aTmp[ 37 ]     := nChgDiv( aTmp[ 36 ], dbfDiv )
      aTmp[ 7 ]     := oUser():cAlmacen()
      aTmp[ 8 ]     := oUser():cCaja()
      aTmp[ 38 ]     := .T.
      aTmp[ 43 ]     := cProCnt()
      aTmp[ 47 ]     := cCurUsr()
      aTmp[ 55 ]     := oUser():cDelegacion()
      aTmp[ 17 ]     := Ctod( "" )
      aTmp[ 49 ]     := Ctod( "" )

      if !Empty( cCodPrv )
         aTmp[ 6 ]  := cCodPrv
      end

      if !Empty( cNumAlb )
         aTmp[ 26 ]  := cNumAlb
      end

   case nMode == 4

      if !lCajaOpen( oUser():cCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + oUser():cCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 4 ]  := cCurSesion()
      aTmp[ 8 ]  := oUser():cCaja()
      aTmp[ 38 ]  := .T.
      aTmp[ 17 ]  := Ctod( "" )
      aTmp[ 49 ]  := Ctod( "" )
      aTmp[ 45 ]  := .F.
      aTmp[ 16 ]  := .F.
      aTmp[ 72    ]  := Space( 20 )

   case nMode == 2

      if aTmp[ 16 ] .AND. !ApoloMsgNoYes( "La modificación de esta factura puede provocar descuadres contables." + Chr(13)+Chr(10) + "¿ Desea continuar ?", "Factura ya contabilizada" )
         return .F.
      end

      if aTmp[ 44 ]
         MsgStop( "El documento ha sido recibido por internet", "Imposible modificar" )
         return .F.
      end

      if aTmp[ 45 ] .AND. !oUser():lAdministrador()
         msgStop( "Solo puede modificar los facturas cerradas los administradores." )
         return .F.
      end

   end

   if Empty( aTmp[ 29 ] )
      aTmp[ 29 ]  := Padr( "General", 50 )
   end

   if Empty( aTmp[ 31 ] )
      aTmp[ 31 ]     := Padr( "Pronto pago", 50 )
   end





   if BeginTrans( aTmp, nMode )
      Return .F.
   end





   cOldCodCli           := aTmp[ 6 ]

   cPicUnd              := MasUnd()
   cPinDiv              := cPinDiv( aTmp[ 36 ], dbfDiv )
   cPirDiv              := cPirDiv( aTmp[ 36 ], dbfDiv )
   nDinDiv              := nDinDiv( aTmp[ 36 ], dbfDiv )
   nRinDiv              := nRinDiv( aTmp[ 36 ], dbfDiv )
   cPouDiv              := cPouDiv( aTmp[ 36 ], dbfDiv )
   cPorDiv              := cPorDiv( aTmp[ 36 ], dbfDiv )





   cGet[ 1 ]            := RetFld( aTmp[ 7 ], dbfAlm )
   cGet[ 2 ]            := RetFld( aTmp[ 6 ], dbfPrv )
   cGet[ 3 ]            := RetFld( aTmp[ 23], dbfFPago )
   cGet[ 5 ]            := RetFld( aTmp[ 8 ], dbfCajT )
   cGet[ 6 ]            := RetFld( cCodEmp() + aTmp[ 55 ], dbfDelega, "cNomDlg" )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "facturas a proveedores", "PEDPRV",, .F.,,,,,, .F.,,,,,, .F., )











      oFld := TFolder():ReDefine( 400, {"&Factura", "Da&tos", "&Incidencias", "D&ocumentos"}, { "FACPRV_1","FACPRV_2","PEDCLI_3","PEDCLI_4" }, oDlg,,,,, .F., )





      aGet[ 72 ] := TGetHlp():ReDefine( 570, { | u | If( PCount()==0, aTmp[ 72 ], aTmp[ 72 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||        ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      oBmpGeneral := TBitmap():ReDefine( 990, "facturas_proveedores_48_alpha",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "folder2_red_alpha_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "information_48_alpha",, oFld:aDialogs[3],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "address_book2_alpha_48",, oFld:aDialogs[4],,, .F., .F.,,, .F.,,, .T. )








        aGet[ 6 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],, ( RetPicCodPrvEmp() ), {||    ( loaPrv( aGet, aTmp, dbfPrv, nMode, oGet[ 2 ], oTlfPrv ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwProvee( aGet[ 6 ], oGet[ 2 ] ) )}, nil, "LUPA",, )





      aGet[ 9 ] := TGetHlp():ReDefine( 141, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 14 ] := TGetHlp():ReDefine( 106, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oTlfPrv := TGetHlp():ReDefine( 107, { | u | If( PCount()==0, cTlfPrv, cTlfPrv:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )






      aGet[ 10 ] := TGetHlp():ReDefine( 103, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 10 ], Rtrim( aTmp[ 11 ] ) + Space( 1 ) + Rtrim( aTmp[ 12 ] ) )}, nil, "Environnment_View_16",, )





      aGet[ 11 ] := TGetHlp():ReDefine( 105, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 12 ] := TGetHlp():ReDefine( 108, { | u | If( PCount()==0, aTmp[ 12 ], aTmp[ 12 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 13 ] := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 7 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],,, {||    cAlmacen( aGet[7], dbfAlm, oGet[ 1 ] )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|brwAlmacen( aGet[ 7 ], oGet[ 1 ] )}, nil, "LUPA",, )





      oGet[1] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, cGet[1], cGet[1]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )









      aGet[ 23 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    cFPago( aGet[ 23 ], dbfFPago, oGet[3] )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,, {|Self|BrwFPago( aGet[ 23 ], oGet[3] )}, nil, "LUPA",, )





      oGet[3] := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cGet[3], cGet[3]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ 75 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 75 ], aTmp[ 75 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,, {|Self|( BrwBncPrv( aGet[ 75 ], aGet[ 76 ], aGet[ 77 ], aGet[ 78 ], aGet[ 79 ], aTmp[ 6 ] ) )}, nil, "LUPA",, )





      aGet[ 76 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, aTmp[ 76 ], aTmp[ 76 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lCalcDC( aTmp[ 76 ], aTmp[ 77 ], aTmp[ 78 ], aTmp[ 79 ], aGet[ 78 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 77 ] := TGetHlp():ReDefine( 302, { | u | If( PCount()==0, aTmp[ 77 ], aTmp[ 77 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lCalcDC( aTmp[ 76 ], aTmp[ 77 ], aTmp[ 78 ], aTmp[ 79], aGet[ 78 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 78 ] := TGetHlp():ReDefine( 303, { | u | If( PCount()==0, aTmp[ 78 ], aTmp[ 78 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lCalcDC( aTmp[ 76 ], aTmp[ 77 ], aTmp[ 78 ], aTmp[ 79 ], aGet[ 78 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 79 ] := TGetHlp():ReDefine( 304, { | u | If( PCount()==0, aTmp[ 79 ], aTmp[ 79 ]:= u ) }, oFld:aDialogs[1],, "9999999999", {||    ( lCalcDC( aTmp[ 76 ], aTmp[ 77 ], aTmp[ 78 ], aTmp[ 79 ], aGet[ 78 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )












      aGet[ 8 ] := TGetHlp():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],,, {||    cCajas( aGet[ 8 ], dbfCajT, oGet[ 5 ] )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 8 ], oGet[ 5 ] ) )}, nil, "LUPA",, )





      oGet[ 5 ] := TGetHlp():ReDefine( 166, { | u | If( PCount()==0, cGet[ 5 ], cGet[ 5 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )












        aGet[ 36 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cDivIn( aGet[ 36 ], oBmpDiv, aGet[ 37 ], @cPinDiv, @nDinDiv, @cPirDiv, @nRinDiv, nil, dbfDiv, oBandera ) )},,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ 36 ], oBmpDiv, aGet[ 37 ], dbfDiv, oBandera )}, nil, "LUPA",, )




        oBmpDiv := TBitmap():ReDefine( 171, "BAN_EURO",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .F. )





        aGet[ 37 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 37 ], aTmp[ 37 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.9999",,,,,,, .F., {||        ( .F. )},, .F., .F.,,,,,, nil,,, )








      oBmpEmp := TBitmap():ReDefine( 500,, "Bmp\ImgFacPrv.bmp", oDlg,,, .F., .F.,,, .F.,,, .F. )









      aControl[1] := TButton():ReDefine( 500, {||( AppDeta( oBrwLin, bEdtDet, aTmp) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





      aControl[2] := TButton():ReDefine( 501, {||( EdtDeta( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo )  )},,, .F. )





      aControl[3] := TButton():ReDefine( 502, {||( WinDelRec( oBrwLin, dbfTmp, {|| delDeta() }, {|| RecalculaTotal( aTmp ) } ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )




      aControl[4] := TButton():ReDefine( 503, {||( if( !( dbfTmp )->lControl, WinZooRec( oBrwLin, bEdtDet, dbfTmp, aTmp ), ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )





      TButton():ReDefine( 512, {||( GrpAlb( aGet[ 6 ], aTmp, oBrwLin ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode == 1 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





      aControl[5] := TButton():ReDefine( 524, {||( DbSwapUp( dbfTmp, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





      aControl[6] := TButton():ReDefine( 525, {||( DbSwapDown( dbfTmp, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





      oBrwLin                 := IXBrowse():New( oFld:aDialogs[1] )

      oBrwLin:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwLin:cAlias          := dbfTmp

      oBrwLin:nMarqueeStyle   := 6
      oBrwLin:cName           := "Lineas de facturas a proveedor"

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Cm. Cambio"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmp )->lChgLin }
            :nWidth           := 20
            :lHide            := .T.
            :SetCheck( { "Sel16", "Nil16" } )
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Número"
            :bEditValue       := {|| if( ( dbfTmp )->lKitChl, "", Trans( ( dbfTmp )->nNumLin, "@Z 9999" ) ) }
            :nWidth           := 65
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Código"
            :bEditValue       := {|| ( dbfTmp )->cRef }
            :nWidth           := 80
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "C. Barras"
            :bEditValue       := {|| cCodigoBarrasDefecto( ( dbfTmp )->cRef, dbfCodeBar ) }
            :nWidth           := 100
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Código proveedor"
            :bEditValue       := {|| ( dbfTmp )->cRefPrv }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| if( Empty( ( dbfTmp )->cRef ) .AND. !( dbfTmp )->lControl, ( dbfTmp )->mLngDes, ( dbfTmp )->cDetalle ) }
            :nWidth           := 286
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Prop. 1"
            :bEditValue       := {|| ( dbfTmp )->cValPr1 }
            :nWidth           := 60
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Prop. 2"
            :bEditValue       := {|| ( dbfTmp )->cValPr2 }
            :nWidth           := 60
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Lote"
            :bEditValue       := {|| ( dbfTmp )->cLote }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Caducidad"
            :bEditValue       := {|| ( dbfTmp )->dFecCad }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := cNombreUnidades()
            :bEditValue       := {|| nTotNFacPrv( dbfTmp ) }
            :cEditPicture     := cPicUnd
            :nWidth           := 60
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "UM. Unidad de medición"
            :bEditValue       := {|| ( dbfTmp )->cUnidad }
            :nWidth           := 25
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Almacen"
            :bEditValue       := {|| ( dbfTmp )->cAlmLin }
            :nWidth           := 65
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Importe"
            :bEditValue       := {|| nTotUFacPrv( dbfTmp, nDinDiv ) }
            :cEditPicture     := cPinDiv
            :nWidth           := 90
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% Dto."
            :bEditValue       := {|| ( dbfTmp )->nDtoLin }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 50
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% Prm."
            :bEditValue       := {|| ( dbfTmp )->nDtoPrm }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 40
            :lHide            := .T.
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% " + cImp()
            :bEditValue       := {|| ( dbfTmp )->nIva }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 50
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Total"
            :bEditValue       := {|| nTotLFacPrv( dbfTmp, nDinDiv, nRinDiv ) }
            :cEditPicture     := cPirDiv
            :nWidth           := 90
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         if nMode <> 3
            oBrwLin:bLDblClick   := {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) }
         end

      oBrwLin:CreateFromResource( 190 )









      aGet[ 58 ] := TMultiGet():ReDefine( 290, { | u | If( PCount()==0, aTmp[ 58 ], aTmp[ 58 ]:= u ) }, oFld:aDialogs[1],, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, .F.,, )











       aGet[ 59 ] := TGetHlp():ReDefine( 600, { | u | If( PCount()==0, aTmp[ 59 ], aTmp[ 59 ]:= u ) }, oFld:aDialogs[1],, cPirDiv, {||    ( oSayGas[11]:Refresh(), oSayGas[12]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )








       aGet[ 62 ] := TGetHlp():ReDefine( 601, { | u | If( PCount()==0, aTmp[ 62 ], aTmp[ 62 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[11]:Refresh(), oSayGas[12]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[11] := TSay():ReDefine( 602, {|| Trans( aTmp[ 59 ] * aTmp[ 62 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F. )








      aGet[ 65 ] := TGetHlp():ReDefine( 603, { | u | If( PCount()==0, aTmp[ 65 ], aTmp[ 65 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[11]:Refresh(), oSayGas[12]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 33 ] )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[12] := TSay():ReDefine( 604, {|| Trans( aTmp[ 59 ] * aTmp[ 65 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F. )











      aGet[ 60 ] := TGetHlp():ReDefine( 610, { | u | If( PCount()==0, aTmp[ 60 ], aTmp[ 60 ]:= u ) }, oFld:aDialogs[1],, cPirDiv, {||    ( oSayGas[13]:Refresh(), oSayGas[14]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 63 ] := TGetHlp():ReDefine( 611, { | u | If( PCount()==0, aTmp[ 63 ], aTmp[ 63 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[13]:Refresh(), oSayGas[14]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[13] := TSay():ReDefine( 612, {|| Trans( aTmp[ 60 ] * aTmp[ 63 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F. )








      aGet[ 66 ] := TGetHlp():ReDefine( 613, { | u | If( PCount()==0, aTmp[ 66 ], aTmp[ 66 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[13]:Refresh(), oSayGas[14]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 33 ] )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[14] := TSay():ReDefine( 614, {|| Trans( aTmp[ 60 ] * aTmp[ 66 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F. )











      aGet[ 61 ] := TGetHlp():ReDefine( 620, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, oFld:aDialogs[1],, cPirDiv, {||    ( oSayGas[15]:Refresh(), oSayGas[16]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 64 ] := TGetHlp():ReDefine( 621, { | u | If( PCount()==0, aTmp[ 64 ], aTmp[ 64 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[15]:Refresh(), oSayGas[16]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[15] := TSay():ReDefine( 622, {|| Trans( aTmp[ 61 ] * aTmp[ 64 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F. )








      aGet[ 67 ] := TGetHlp():ReDefine( 623, { | u | If( PCount()==0, aTmp[ 67 ], aTmp[ 67 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[15]:Refresh(), oSayGas[16]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 33 ] )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[16] := TSay():ReDefine( 624, {|| Trans( aTmp[ 61 ] * aTmp[ 67 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F. )









      aGet[ 29 ] := TGetHlp():ReDefine( 199, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )







      aGet[ 30 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      aGet[ 31 ] := TGetHlp():ReDefine( 209, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )







        aGet[ 32 ] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )






      aGet[ 39 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







      aGet[ 40 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 40 ], aTmp[ 40 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      aGet[ 41 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 41 ], aTmp[ 41 ]:= u ) }, oFld:aDialogs[1],, "@!",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







      aGet[ 42 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      oBrwIva                        := TXBrowse():New( oFld:aDialogs[ 1 ] )

      oBrwIva:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwIva:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwIva:SetArray( aTotIva )

      oBrwIva:lHScroll               := .F.
      oBrwIva:lVScroll               := .F.
      oBrwIva:nMarqueeStyle          := 5
      oBrwIva:lRecordSelector        := .F.

      oBrwIva:CreateFromResource( 490 )

      with object ( oBrwIva:aCols[ 1 ] )
         :cHeader       := "Bruto"
         :bStrData      := {|| if( !Empty( aTotIva[ oBrwIva:nArrayAt, 1 ] ), Trans( aTotIva[ oBrwIva:nArrayAt, 2 ], cPirDiv ), "" ) }
         :nWidth        := 82
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 2 ] )
         :cHeader       := "Base"
         :bStrData      := {|| if( !Empty( aTotIva[ oBrwIva:nArrayAt, 2 ] ), Trans( aTotIva[ oBrwIva:nArrayAt, 2 ], cPirDiv ), "" ) }
         :nWidth        := 82
         :cEditPicture  := cPirDiv
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 3 ] )
         :cHeader       := "%" + cImp()
         :bStrData      := {|| if( !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ), aTotIva[ oBrwIva:nArrayAt, 3 ], "" ) }
         :bEditValue    := {|| aTotIva[ oBrwIva:nArrayAt, 3 ] }
         :nWidth        := 50
         :cEditPicture  := "@E 999.99"
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
         :nEditType     := 1
         :bEditWhen     := {|| !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ) }
         :bOnPostEdit   := {|o,x| EdtIva( o, x, aTotIva[ oBrwIva:nArrayAt, 3 ], dbfTmp, dbfIva, oBrwLin ), RecalculaTotal( aTmp ) }
      end

      with object ( oBrwIva:aCols[ 4 ] )
         :cHeader       := "%R.E."
         :bStrData      := {|| if( !Empty( aTotIva[ oBrwIva:nArrayAt, 4 ] ) .AND. aTmp[ 33 ], Trans( aTotIva[ oBrwIva:nArrayAt, 4 ], "@E 99.9" ), "" ) }
         :nWidth        := 50
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 5 ] )
         :cHeader       := cImp()
         :bStrData      := {|| if( !Empty( aTotIva[ oBrwIva:nArrayAt, 5 ] ), Trans( aTotIva[ oBrwIva:nArrayAt, 5 ], cPirDiv ), "" ) }
         :nWidth        := 75
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 6 ] )
         :cHeader       := "R.E."
         :bStrData      := {|| if( !Empty( aTotIva[ oBrwIva:nArrayAt, 6 ] ) .AND. aTmp[ 33 ], Trans( aTotIva[ oBrwIva:nArrayAt, 6 ], cPirDiv ), "" ) }
         :nWidth        := 75
         :cEditPicture  := cPirDiv
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
      end








        oGetNet := TSay():ReDefine( 370, {|| nGetNeto}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



        oGetIva := TSay():ReDefine( 380, {|| nGetIva}, oFld:aDialogs[1],,,, .F.,, .F., .F. )



        oGetReq := TSay():ReDefine( 390, {|| nGetReq}, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      aGet[ 33 ] := TCheckBox():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ) )},,,,, .F., {||         ( nMode <> 3 )}, .F. )




      oGetTotal := TSay():ReDefine( 410, {|| nTotFac}, oFld:aDialogs[1],,,, .F., oFntTot, .F., .F. )
















      aGet[ 1 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 1 ], aTmp[ 1 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( aTmp[ 1 ] >= "A" .AND. aTmp[ 1 ] <= "Z"  )},,,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[ 1 ] ) )}, {||  ( DwSerie( aGet[ 1 ] ) )},,,, nil,,, )

         aGet[ 1 ]:bLostFocus := {|| aGet[ 43 ]:cText( cProCnt( aTmp[ 1 ] ) ) }





        aGet[2] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[2], aTmp[2]:= u ) }, oFld:aDialogs[1],, "999999999",,,,,,, .F., {||        .F.},, .F., .F.,,,,,, nil,,, )




        aGet[3] := TGetHlp():ReDefine( 102, { | u | If( PCount()==0, aTmp[3], aTmp[3]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )






        aGet[5] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[5], aTmp[5]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      aGet[ 18 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 26 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 26 ], aTmp[ 26 ]:= u ) }, oFld:aDialogs[1],, "@R A/#########/##", {||    ( cAlbPrv( aGet, oBrwLin, nMode, aTmp ), RecalculaTotal( aTmp ) )},,,,,, .F., {||         ( nMode == 1 )},, .F., .F.,,,,, {|Self|( brwAlbPrv( aGet[ 26 ], dbfAlbPrvT, dbfAlbPrvL, dbfIva, dbfDiv ) )}, nil, "LUPA",, )






      aGet[ 57 ] := TCheckBox():ReDefine( 550, { | u | If( PCount()==0, aTmp[ 57 ], aTmp[ 57 ]:= u ) }, oFld:aDialogs[1],, {||( ShowKitFacPrv( dbfFacPrvT, oBrwLin, cCodPrv, nil, aGet, aTmp, aControl, oSayGas, oSayLabels, oBrwIva ), RecalculaTotal( aTmp ), .T. )},,,,, .F., {||     ( nMode == 1 )}, .F. )







      aGet[ 51 ] := TComboBox():ReDefine( 440, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, { "Ret. S/Base", "Ret. S/Total" }, oFld:aDialogs[ 1 ],, {||    ( RecalculaTotal( aTmp ) )}, {|Self|( RecalculaTotal( aTmp ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 52 ] := TGetHlp():ReDefine( 450, { | u | If( PCount()==0, aTmp[ 52 ], aTmp[ 52 ]:= u ) }, oFld:aDialogs[ 1 ],, "@E 99.9", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )



      oGetRet := TSay():ReDefine( 491, {|| cGetRet}, oFld:aDialogs[1],,,, .F.,, .F., .F. )

      oSayLabels[ 1 ] := TGroup():ReDefine( 700,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 2 ] := TSay():ReDefine( 701,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 3 ] := TSay():ReDefine( 702,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 4 ] := TSay():ReDefine( 703,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 5 ] := TSay():ReDefine( 704,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 6 ] := TSay():ReDefine( 705,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayLabels[ 7 ] := TSay():ReDefine( 706,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )

      oSayGas[ 1 ] := TSay():ReDefine( 707,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayGas[ 2 ] := TSay():ReDefine( 708,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayGas[ 3 ] := TSay():ReDefine( 709,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayGas[ 4 ] := TSay():ReDefine( 710,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayGas[ 5 ] := TSay():ReDefine( 711,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayGas[ 6 ] := TSay():ReDefine( 712,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayGas[ 7 ] := TSay():ReDefine( 713,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayGas[ 8 ] := TSay():ReDefine( 714,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayGas[ 9 ] := TSay():ReDefine( 715,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )
      oSayGas[ 10] := TSay():ReDefine( 716,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F. )





      aGet[ 47 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[2],,, {||       ( SetUsuario( aGet[ 47 ], oUsr, nil, dbfUsr ) )},,,,,, .F., {||        ( .F. )},, .F., .F.,,,,,, nil,,, )




      oUsr := TGetHlp():ReDefine( 126, { | u | If( PCount()==0, cUsr, cUsr:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||        ( .F. )},, .F., .F.,,,,,, nil,,, )










      aGet[ 17 ] := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, aTmp[ 17 ], aTmp[ 17 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[ 46 ] := TGetHlp():ReDefine( 142, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 56 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[2],, { 270, 271, 272, 273 },,,,, .F., {||     ( .F. )}, )




      aGet[ 55 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oGet[ 6 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cGet[ 6 ], cGet[ 6 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )









      aGet[ 73 ] := TGetHlp():ReDefine( 370, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[ 2 ],, ( Replicate( "X", nLenSubcuentaContaplus() ) ), {||    ( MkSubCta( aGet[ 73 ], nil, aGet[ 73 ]:oHelpText ) )},,,,,, .F., {||     ( aTmp[ 57 ] .AND. nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwChkSubCta( aGet[ 73 ], aGet[ 73 ]:oHelpText ) )}, nil, "Lupa",, 371 )









      aGet[ 43 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 43 ], aTmp[ 43 ]:= u ) }, oFld:aDialogs[2],, "@R ###.######", {||    ( ChkProyecto( aTmp[ 43 ], oGet[ 4 ] ), .T. )}, "N/W*",,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwProyecto( aGet[ 43 ], oGet[ 4 ] ) )}, nil, "Lupa",, )




      oGet[ 4 ] := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, cGet[ 4 ], cGet[ 4 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )






      aGet[ 24 ] := TGetHlp():ReDefine( 132, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[2],, "999999",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )










      aGet[ 20 ] := TMultiGet():ReDefine( 210, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, .F.,, )





      oBrwPgo                 := IXBrowse():New( oFld:aDialogs[2] )

      oBrwPgo:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwPgo:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwPgo:cAlias          := dbfTmpPgo
      oBrwPgo:cName           := "Pagos de facturas a proveedor"

      oBrwPgo:nMarqueeStyle   := 6

      oBrwPgo:CreateFromResource( 220 )

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Pg. Pagado"
            :bStrData         := {|| "" }
            :bBmpData         := {|| nEstadoRecibo( dbfTmpPgo ) }
            :nWidth           := 22
            :AddResource( "Cnt16" )
            :AddResource( "Sel16" )
            :AddResource( "UndoRed16" )
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Cn. Contabilizado"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpPgo )->lConPgo }
            :nWidth           := 22
            :SetCheck( { "Sel16", "Nil16" } )
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Sesión"
            :bEditValue       := {|| Trans( ( dbfTmpPgo )->cTurRec, "######" ) }
            :nWidth           := 40
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpPgo )->dPreCob ) }
            :nWidth           := 75
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Vencimiento"
            :bEditValue       := {|| Dtoc( ( dbfTmpPgo )->dFecVto ) }
            :lHide            := .T.
            :nWidth           := 70
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Cobro"
            :bEditValue       := {|| Dtoc( ( dbfTmpPgo )->dEntrada ) }
            :nWidth           := 75
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpPgo )->cDescrip }
            :nWidth           := 180
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Importe"
            :bEditValue       := {|| nTotRecPrv( dbfTmpPgo, dbfDiv, nil, .T. ) }
            :nWidth           := 85
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Divisa"
            :bEditValue       := {|| cSimDiv( ( dbfTmpPgo )->cDivPgo, dbfDiv ) }
            :nWidth           := 55
         end

         if nMode <> 3
            oBrwPgo:bLDblClick   := {|| ExtEdtRecPrv( dbfTmpPgo, dbfFacPrvT, dbfFacPrvL, dbfFPago, dbfIva, dbfDiv, oBanco, oBandera ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) }
         end





      TButton():ReDefine( 501, {||( ExtEdtRecPrv( dbfTmpPgo, dbfFacPrvT, dbfFacPrvL, dbfFPago, dbfIva, dbfDiv, oBanco, oBandera ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||         ( nMode == 2 )},,, .F. )





        TButton():ReDefine( 502, {||( ExtDelRecPrv( dbfTmpPgo ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||         ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 505, {||( PrnRecPrv( ( dbfTmpPgo )->cSerFac + Str( ( dbfTmpPgo )->nNumFac ) + ( dbfTmpPgo )->cSufFac + Str( ( dbfTmpPgo )->nNumRec ), .F. ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 506, {||( VisRecPrv( ( dbfTmpPgo )->cSerFac + Str( ( dbfTmpPgo )->nNumFac ) + ( dbfTmpPgo )->cSufFac + Str( ( dbfTmpPgo )->nNumRec ), .F. ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )



      oGetTotPg := TSay():ReDefine( 405, {|| nTotFac}, oFld:aDialogs[2],,,, .F.,, .F., .F. )



        oGetPgd := TSay():ReDefine( 400, {|| nGetPgd}, oFld:aDialogs[2],,,, .F.,, .F., .F. )



      oGetPdt := TSay():ReDefine( 410, {|| ( nTotFac - nGetPgd )}, oFld:aDialogs[2],,,, .F.,, .F., .F. )






      aGet[ 48 ] := TCheckBox():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 .AND. lUsrMaster() )}, .F. )




      aGet[ 49 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 49 ], aTmp[ 49 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )




      aGet[ 50 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 .AND. lUsrMaster() )},, .F., .F.,,,,,, nil,,, )





      oBrwInc                 := IXBrowse():New( oFld:aDialogs[ 3 ] )

      oBrwInc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwInc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwInc:cAlias          := dbfTmpInc

      oBrwInc:nMarqueeStyle   := 5
      oBrwInc:cName           := "Incidencias de albaranes a proveedor"

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Resuelta"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpInc )->lListo }
            :nWidth           := 60
            :SetCheck( { "Sel16", "Cnt16" } )
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Código"
            :bEditValue       := {|| ( dbfTmpInc )->cCodTip }
            :nWidth           := 80
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Incidencia"
            :bEditValue       := {|| cNomInci( ( dbfTmpInc )->cCodTip, dbfInci ) }
            :nWidth           := 240
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpInc )->dFecInc ) }
            :nWidth           := 90
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpInc )->mDesInc }
            :nWidth           := 410
         end

         if nMode <> 3
            oBrwInc:bLDblClick   := {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) }
         end

         oBrwInc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( DbDelRec( oBrwInc, dbfTmpInc, nil, nil, .T. ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F.,,,, .F. )





      oBrwDoc                 := TXBrowse():New( oFld:aDialogs[ 4 ] )

      oBrwDoc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDoc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDoc:cAlias          := dbfTmpDoc

      oBrwDoc:nMarqueeStyle   := 5
      oBrwDoc:nRowHeight      := 40
      oBrwDoc:nDataLines      := 2

         with object ( oBrwDoc:AddCol() )
            :cHeader          := "Documento"
            :bEditValue       := {|| Rtrim( ( dbfTmpDoc )->cNombre ) + Chr(13)+Chr(10) + Space( 5 ) + Rtrim( ( dbfTmpDoc )->cRuta ) }
            :nWidth           := 885
         end

         if nMode <> 3
            oBrwDoc:bLDblClick   := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( ( dbfTmpDoc )->cRuta ) ) }
         end

         oBrwDoc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( DbDelRec( oBrwDoc, dbfTmpDoc, nil, nil, .F. ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwDoc, bEdtDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( ShellExecute( oDlg:hWnd, "open", rTrim( ( dbfTmpDoc )->cRuta ) ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )





      TButton():ReDefine( 4, {||( RecalculaFacturaProveedores( aTmp, oDlg ), ( oBrwLin:Refresh() ), RecalculaTotal( aTmp ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      oBtnOk := TButton():ReDefine( 1, {||( EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 3, {||( if( EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg ), GenFacPrv( 1 ), ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( If( ExitNoSave( nMode, dbfTmp ), ( oDlg:end() ), ) )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oFld:aDialogs[1]:AddFastKey( 113, {|| AppDeta( oBrwLin, bEdtDet, aTmp) } )
      oFld:aDialogs[1]:AddFastKey( 114, {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) } )
      oFld:aDialogs[1]:AddFastKey( 115, {|| WinDelRec( oBrwLin, dbfTmp, {|| delDeta() }, {|| RecalculaTotal( aTmp ) } ) } )

      oFld:aDialogs[2]:AddFastKey( 114, {|| ExtEdtRecPrv( dbfTmpPgo, dbfFacPrvT, dbfFacPrvL, dbfFPago, dbfIva, dbfDiv, oBanco, oBandera ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) } )
      oFld:aDialogs[2]:AddFastKey( 115, {|| ExtDelRecPrv( dbfTmpPgo ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) } )

      oFld:aDialogs[3]:AddFastKey( 113, {|| WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 114, {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 115, {|| DbDelRec( oBrwInc, dbfTmpInc, nil, nil, .T. ) } )

      oFld:aDialogs[4]:AddFastKey( 113, {|| WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 114, {|| WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 115, {|| DbDelRec( oBrwDoc, dbfTmpDoc, nil, nil, .F. ) } )

      oDlg:AddFastKey( 116,             {|| EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg ) } )
      oDlg:AddFastKey( 117,             {|| if( EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg ), GenFacPrv( 1 ), ) } )
      oDlg:AddFastKey( 65,                {|| if( GetKeyState( 17 ), CreateInfoArticulo(), ) } )
   end

   oDlg:AddFastKey ( 112, {|| GoHelp() } )

   do case
      case nMode == 1 .AND. lRecogerUsuario() .AND. Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 47 ], dbfUsr ), , oDlg:end() ) }

      case nMode == 1 .AND. lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 47 ], dbfUsr ), AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt ), oDlg:end() ) }

      case nMode == 1 .AND. !lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt ) }

   end









    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|(  RecalculaTotal( aTmp ) )}, .T.,,, {|Self|(  if( !Empty( cNumAlb ), aGet[ 26 ]:lValid(), ), EdtRecMenu( aTmp, oDlg ), ShowKitFacPrv( dbfFacPrvT, oBrwLin, cCodPrv, dbfTmpInc, aGet, aTmp, aControl, oSayGas, oSayLabels, oBrwIva ), oBrwLin:Load(), oBrwPgo:Load(), oBrwInc:Load() )}, oDlg:bRClicked,,, )

   oBmpEmp:End()
   oBmpGeneral:End()





   if oDlg:nResult <> 1
      if len( aNumAlb ) > 0
         for n := 1 to len( aNumAlb )
            if ( dbfAlbPrvT )->( dbSeek( aNumAlb[ n ] ) )
               SetFacturadoAlbaranProveedor( .F., , , dbfAlbPrvT, dbfAlbPrvL, dbfAlbPrvS )
            end
         next
      end
   end

   ( dbfFacPrvT )->( OrdSetFocus( nOrd ) )





   ChkLqdFacPrv( nil, dbfFacPrvT, dbfFacPrvL, dbfFacPrvP, dbfIva, dbfDiv )





   KillTrans( oBrwLin )

RETURN ( oDlg:nResult == 1 )



Static Function EdtRecMenu( aTmp, oDlg )

   oMnuRec := MenuBegin( .F.,,, .F., .F. )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F. )

         MenuBegin( .F.,,, .F., .F. )

            if !lExternal




            MenuAddItem( "&1. Visualizar albarán", "Visualiza el albarán del que proviene", .F.,, {|oMenuItem|( if( !Empty( ( dbfFacPrvT )->cNumAlb ), ZooAlbPrv( ( dbfFacPrvT )->cNumAlb ), MsgStop( "La factura no proviene de un albarán" ) ))},, "Document_plain_businessman_16",,,,, .F.,,, .F. )

            MenuAddItem()




            MenuAddItem( "&2. Modificar proveedor", "Modificar la ficha del proveedor", .F.,, {|oMenuItem|( EdtPrv( aTmp[ 6 ] ) )},, "Businessman_16",,,,, .F.,,, .F. )





            MenuAddItem( "&3. Informe de proveedor", "Abrir el informe del proveedor", .F.,, {|oMenuItem|( InfProveedor( aTmp[ 6 ] ) )},, "Info16",,,,, .F.,,, .F. )
            MenuAddItem()

            end




            MenuAddItem( "&4. Informe del documento", "Abrir el informe del documento", .F.,, {|oMenuItem|( TTrazaDocumento():Activate( "03", ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac ) )},, "Info16",,,,, .F.,,, .F. )

         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMnuRec )

Return ( oMnuRec )



Static Function RecalculaFacturaProveedores( aTmp, oDlg )

   local nRecNum
   local nPreCom




   if !ApoloMsgNoYes( "¡Atención!,"                                      + Chr(13)+Chr(10) +  "todos los precios se recalcularán en función de"  + Chr(13)+Chr(10) +  "los valores en las bases de datos.", "¿ Desea proceder ?" )
      return nil
   end

   oDlg:Disable()

   ( dbfArticulo )->( ordSetFocus( "Codigo" ) )

   nRecNum                          := ( dbfTmp )->( RecNo() )

   ( dbfTmp )->( dbGotop() )
   while !( dbfTmp )->( eof() )





      nPreCom                       := nComPro( ( dbfTmp )->cRef, ( dbfTmp )->cCodPr1, ( dbfTmp )->cValPr1, ( dbfTmp )->cCodPr2, ( dbfTmp )->cValPr2, dbfArtCom )

      if nPrecom  <> 0

         ( dbfTmp )->nPreUnit       := nPreCom

      else

         if uFieldEmpresa( "lCosPrv", .F. )
            nPreCom                 := nPreArtPrv( aTmp[ 6 ], ( dbfTmp )->cRef, dbfArtPrv )
         end

         if nPreCom <> 0
            ( dbfTmp )->nPreUnit    := nPreCom
         else
            ( dbfTmp )->nPreUnit    := nCosto( ( dbfTmp )->cRef, dbfArticulo, dbfKit, .F., aTmp[ 36 ], dbfDiv )
         end





         if uFieldEmpresa( "lCosPrv", .F. )

            nPreCom                 := nDtoArtPrv( aTmp[ 6 ], ( dbfTmp )->cRef, dbfArtPrv )

            if nPreCom <> 0
               ( dbfTmp )->nDtoLin  := nPreCom
            end





            nPreCom                 := nPrmArtPrv( aTmp[ 6 ], ( dbfTmp )->cRef, dbfArtPrv )

            if nPreCom <> 0
               ( dbfTmp )->nDtoPrm  :=  nPreCom
            end

         end

      end

      ( dbfTmp )->( dbSkip() )

   end

   ( dbfTmp )->( dbGoTo( nRecNum ) )

   oDlg:Enable()

return nil



Static Function EdtInc( aTmp, aGet, dbfFacPrvI, oBrw, bWhen, bValid, nMode, aTmpFac )

   local oDlg
   local oNomInci
   local cNomInci       := RetFld( aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], dbfInci )

   if nMode == 1

      aTmp[ 1  ] := aTmpFac[ 1 ]
      aTmp[ 2  ] := aTmpFac[ 2 ]
      aTmp[ 3  ] := aTmpFac[ 3 ]

      if IsMuebles()
         aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]  := .T.
      end

   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "incidencias de facturas a proveedores", "INCIDENCIA",, .F.,,,,,, .F.,,,,,, .F., )








      aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ]:= u ) }, oDlg,,, {||    ( cTipInci( aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], dbfInci, oNomInci ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwIncidencia( dbfInci, aGet[ ( dbfTmpInc )->( FieldPos( "cCodTip" ) ) ], oNomInci ) )}, nil, "LUPA",, )




      oNomInci := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, cNomInci, cNomInci:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



Static Function EdtDoc( aTmp, aGet, dbfAlbPrvD, oBrw, bWhen, bValid, nMode, aTmpLin )

   local oDlg
   local oRuta
   local oNombre
   local oObservacion

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "documento de facturas a proveedor", "DOCUMENTOS",, .F.,,,,,, .F.,,,,,, .F., )




      oNombre := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      oRuta := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oRuta:cText( cGetFile( "Doc ( *.* ) | " + "*.*", "Seleccione el nombre del fichero" ) ) )}, nil, "FOLDER",, )





      oObservacion := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )






STATIC FUNCTION EdtDet( aTmp, aGet, dbfFacPrvL, oBrw, aTmpFac, cCodArt, nMode )

    local oDlg
    local oFld
   local oBtn
    local oTotal
   local cSay2
   local oSay2
   local oBmp
   local cGetIra           := Space( 50 )
   local oGetIra
   local oBrwPrp
   local oSayPr1
   local oSayPr2
   local oSayVp1
   local oSayVp2
   local cSayVp1           := ""
   local cSayVp2           := ""
   local cSayPr1           := ""
   local cSayPr2           := ""
   local nTotal            := 0
   local oBeneficioSobre   := Array( 6 )
   local cBeneficioSobre   := Afill( Array( 6 ), "" )
   local aBeneficioSobre   := { "Costo", "Venta" }
   local nStkAct           := 0
   local oStkAct
   local oSayLote





   cOldCodArt              := aTmp[ 4 ]
   cOldPrpArt              := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]
   cOldUndMed              := aTmp[ 12 ]

   do case
   case nMode == 1

      aTmp[ 13 ]    := 1
      aTmp[ 57  ]    := aTmpFac[ 7 ]
      aTmp[ 62  ]    := nLastNum( dbfTmp )
      aTmp[ 14  ]    := lActCos()
      aTmp[ 87  ]    := Ctod( "" )

      if !Empty( cCodArt )
         aTmp[ 4 ]     := cCodArt
      end

   case nMode == 2

      if !Empty( aTmp[ 4 ] )
         ( dbfArticulo )->( dbSeek( aTmp[ 4 ] ) )
      end

   end





   cBeneficioSobre[ 1 ]    := aBeneficioSobre[ Max( aTmp[ 32 ], 1 ) ]
   cBeneficioSobre[ 2 ]    := aBeneficioSobre[ Max( aTmp[ 33 ], 1 ) ]
   cBeneficioSobre[ 3 ]    := aBeneficioSobre[ Max( aTmp[ 34 ], 1 ) ]
   cBeneficioSobre[ 4 ]    := aBeneficioSobre[ Max( aTmp[ 35 ], 1 ) ]
   cBeneficioSobre[ 5 ]    := aBeneficioSobre[ Max( aTmp[ 36 ], 1 ) ]
   cBeneficioSobre[ 6 ]    := aBeneficioSobre[ Max( aTmp[ 37 ], 1 ) ]





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "lineas a facturas de proveedores", "LALBPRV",, .F.,,,,,, .F.,,,,,, .F., )









      oFld := TFolder():ReDefine( 400, {"&General", "&Precios", "&Observaciones"}, { "LFACPRV_7","LALBPRV_2","LFACPRV_5" }, oDlg,,,,, .F., )








      aGet[ 4 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 4 ], aTmp[ 4 ]:= u ) }, oFld:aDialogs[1],,, {||    ( LoaArt( aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oGetIra, oDlg, oStkAct, oSayLote, oBeneficioSobre, oTotal, nMode ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwArticulo( aGet[4], aGet[6] ) )}, nil, "LUPA",, )








     oSayLote := TSay():ReDefine( 111,, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      aGet[61] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[61], aTmp[61]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 61 ]:bValid   := {|| oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 57 ], aTmp[ 54 ], aTmp[ 55 ], aTmp[ 61 ], aTmp[ 64 ], aTmp[ 58 ], oStkAct ), .T. }






      aGet[ 87 ] := TGetHlp():ReDefine( 113, { | u | If( PCount()==0, aTmp[ 87 ], aTmp[ 87 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 114, )




        aGet[6] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[6], aTmp[6]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 6 ] ) ) .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





        aGet[15] := TMultiGet():ReDefine( 121, { | u | If( PCount()==0, aTmp[15], aTmp[15]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||         ( nMode <> 3 )}, .F.,, )









      aGet[ 9 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( if( lTiva( dbfIva, aTmp[ 9 ], @aTmp[ 80 ] ), ( aGet[ 50 ]:cText( aTmp[ 9 ] ), .T. ), .F. ) )},,,,,, .F., {||     ( lModIva() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 9 ], dbfIva, , .T. ) )}, nil, "LUPA",, )














      aGet[ 54 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aGet[ 54 ], oSayVp1, aTmp[52 ], dbfTblPro ), LoaArt( aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oGetIra, oDlg, oStkAct, oSayLote, oBeneficioSobre, oTotal, nMode ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[ 54 ], oSayVp1, aTmp[ 52 ] ) )}, nil, "LUPA",, )

         aGet[ 54 ]:bChange   := {|| aGet[ 54 ]:Assign(), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 57 ], aTmp[ 54 ], aTmp[ 55 ], aTmp[ 61 ], aTmp[ 64 ], aTmp[ 58 ], oStkAct ) }



      oSayPr1 := TSay():ReDefine( 221, {|| cSayPr1}, oFld:aDialogs[1],,,, .F.,, .F., .F. )




      oSayVp1 := TGetHlp():ReDefine( 222, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 55 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aGet[ 55 ], oSayVp2, aTmp[ 53 ], dbfTblPro ), LoaArt( aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oGetIra, oDlg, oStkAct, oSayLote, oBeneficioSobre, oTotal, nMode ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPrpAct( aGet[ 55 ], oSayVp2, aTmp[ 53 ] ) )}, nil, "LUPA",, )

         aGet[ 55 ]:bChange   := {|| aGet[ 55 ]:Assign(), oStock:nPutStockActual( aTmp[ 4 ], aTmp[ 57 ], aTmp[ 54 ], aTmp[ 55 ], aTmp[ 61 ], aTmp[ 64 ], aTmp[ 58 ], oStkAct ) }



      oSayPr2 := TSay():ReDefine( 231, {|| cSayPr2}, oFld:aDialogs[1],,,, .F.,, .F., .F. )





      oSayVp2 := TGetHlp():ReDefine( 232, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      oBrwPrp := TWBrowse():ReDefine( 100, {|| { "" } }, oFld:aDialogs[1], {""},,,,,,,,,,,,, .F.,,,,, )













      aGet[12] := TGetHlp():ReDefine( 152, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],,, {||    ( oUndMedicion:Existe( aGet[ 12 ], aGet[ 12 ]:oHelpText, "cNombre" ), ValidaMedicion( aTmp, aGet) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oUndMedicion:Buscar( aGet[ 12 ] ), ValidaMedicion( aTmp, aGet ) )}, nil, "LUPA",, 153 )











      aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ], aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 421, )

      aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ] := TGetHlp():ReDefine( 430, { | u | If( PCount()==0, aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ], aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 431, )

      aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ] := TGetHlp():ReDefine( 440, { | u | If( PCount()==0, aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ], aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 441, )

      aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetColor( 8388608 )









        aGet[10] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[10], aTmp[10]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )},,,,,, .F., {||     ( lUseCaj() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 141, )









        aGet[13] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[13], aTmp[13]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )},,,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 151, )









        aGet[7] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[7], aTmp[7]:= u ) }, oFld:aDialogs[1],, cPinDiv, {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )









      aGet[ 16 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )









      aGet[ 17 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 17 ], aTmp[ 17 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )







      aGet[18] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[18], aTmp[18]:= u ) }, oFld:aDialogs[1],, "@E 99.99",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[ 92 ] := TCheckBox():ReDefine( 460, { | u | If( PCount()==0, aTmp[ 92 ], aTmp[ 92 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )

      aGet[ 92 ]:bChange   := {|| if( aTmp[ 92 ], ( aGet[ 9 ]:cText( 0 ), aGet[ 9 ]:HardDisable() ), ( aGet[ 9 ]:HardEnable() ) ) }





      oStkAct := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, nStkAct, nStkAct:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      aGet[ 5 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





        oTotal := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, nTotal, nTotal:= u ) }, oFld:aDialogs[1],, cPirDiv,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )








      aGet[57] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[57], aTmp[57]:= u ) }, oFld:aDialogs[1],,, {||    ( cNomUbica( aTmp, aGet, dbfAlm ), cAlmacen( aGet[57], dbfAlm, oSay2 ), oStock:lPutStockActual( aTmp[ 4 ], aTmp[ 57 ], aTmp[ 54 ], aTmp[ 55 ], aTmp[ 61 ], aTmp[ 64 ], aTmp[ 58 ], oStkAct ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( Self, oSay2 ) )}, nil, "LUPA",, )




        oSay2 := TGetHlp():ReDefine( 241, { | u | If( PCount()==0, cSay2, cSay2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )



      aGet[69] := TSay():ReDefine( 300, {|| aTmp[69]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[72] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[72], aTmp[72]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[72], aGet[75], aTmp[69], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[75] := TGetHlp():ReDefine( 271, { | u | If( PCount()==0, aTmp[75], aTmp[75]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      aGet[70] := TSay():ReDefine( 310, {|| aTmp[70]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[73] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[73], aTmp[73]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[73], aGet[76], aTmp[70], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[76] := TGetHlp():ReDefine( 281, { | u | If( PCount()==0, aTmp[76], aTmp[76]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      aGet[71] := TSay():ReDefine( 320, {|| aTmp[71]}, oFld:aDialogs[1],,,, .F.,, .F., .F. )






      aGet[74] := TGetHlp():ReDefine( 290, { | u | If( PCount()==0, aTmp[74], aTmp[74]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwUbiLin( aGet[74], aGet[77], aTmp[71], dbfUbicaL ) )}, nil, "LUPA",, )




      aGet[77] := TGetHlp():ReDefine( 291, { | u | If( PCount()==0, aTmp[77], aTmp[77]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      oGetIra := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, cGetIra, cGetIra:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( SearchProperty( oGetIra, oBrwPrp ) )}, nil, "Lupa", 411, )









      aGet[ 50 ] := TGetHlp():ReDefine( 80, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[2],, "@E 999.99",,,,,,, .F., {||        .F.},, .F., .F.,,,,,, nil,,, )




        aGet[ 51 ] := TCheckBox():ReDefine( 90, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      aGet[ 19 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[2],, cPinDiv,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 20 ] := TCheckBox():ReDefine( 500, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 26 ] := TGetHlp():ReDefine( 510, { | u | If( PCount()==0, aTmp[ 26 ], aTmp[ 26 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 1 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 20 ], aTmp[ 26 ], aTmp[ 9 ], aGet[ 38 ], aGet[ 44 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 20 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 1 ] := TComboBox():ReDefine( 520, { | u | If( PCount()==0, cBeneficioSobre[ 1 ], cBeneficioSobre[ 1 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 20 ], aGet[ 26 ]:lValid(), aGet[ 38 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 38 ] := TGetHlp():ReDefine( 530, { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfPts( oBeneficioSobre[ 1 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 38 ], aGet[ 26 ], aTmp[ 9 ], aGet[ 44 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 44 ] := TGetHlp():ReDefine( 540, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfIva( oBeneficioSobre[ 1 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 44 ], aGet[ 26 ], aTmp[ 9 ], aGet[ 38 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )









      aGet[ 21 ] := TCheckBox():ReDefine( 1, { | u | If( PCount()==0, aTmp[ 21 ], aTmp[ 21 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 27 ] := TGetHlp():ReDefine( 560, { | u | If( PCount()==0, aTmp[ 27 ], aTmp[ 27 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 2 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 21 ], aTmp[ 27 ], aTmp[ 9 ], aGet[ 39 ], aGet[ 45 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 21 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 2 ] := TComboBox():ReDefine( 570, { | u | If( PCount()==0, cBeneficioSobre[ 2 ], cBeneficioSobre[ 2 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 21 ], aGet[ 27 ]:lValid(), aGet[ 39 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 39 ] := TGetHlp():ReDefine( 580, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfPts( oBeneficioSobre[ 2 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 39 ], aGet[ 27 ], aTmp[ 9 ], aGet[ 45 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 45 ] := TGetHlp():ReDefine( 590, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfIva( oBeneficioSobre[ 2 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 45 ], aGet[ 27 ], aTmp[ 9 ], aGet[ 39 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )









      aGet[ 22 ] := TCheckBox():ReDefine( 600, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 28 ] := TGetHlp():ReDefine( 610, { | u | If( PCount()==0, aTmp[ 28 ], aTmp[ 28 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 3 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 22 ], aTmp[ 28 ], aTmp[ 9 ], aGet[ 40 ], aGet[ 46 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 22 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 3 ] := TComboBox():ReDefine( 620, { | u | If( PCount()==0, cBeneficioSobre[ 3 ], cBeneficioSobre[ 3 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 22 ], aGet[ 28 ]:lValid(), aGet[ 40 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 40 ] := TGetHlp():ReDefine( 630, { | u | If( PCount()==0, aTmp[ 40 ], aTmp[ 40 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfPts( oBeneficioSobre[ 3 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 40 ], aGet[ 28 ], aTmp[ 9 ], aGet[ 46 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 46 ] := TGetHlp():ReDefine( 640, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfIva( oBeneficioSobre[ 3 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 46 ], aGet[ 28 ], aTmp[ 9 ], aGet[ 40 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )









      aGet[ 23 ] := TCheckBox():ReDefine( 650, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 29 ] := TGetHlp():ReDefine( 660, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 4 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 23 ], aTmp[ 29 ], aTmp[ 9 ], aGet[ 41 ], aGet[ 47 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 23 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 4 ] := TComboBox():ReDefine( 670, { | u | If( PCount()==0, cBeneficioSobre[ 4 ], cBeneficioSobre[ 4 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 23 ], aGet[ 29 ]:lValid(), aGet[ 41 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 41 ] := TGetHlp():ReDefine( 680, { | u | If( PCount()==0, aTmp[ 41 ], aTmp[ 41 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfPts( oBeneficioSobre[ 4 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 41 ], aGet[ 29 ], aTmp[ 9 ], aGet[ 47 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 47 ] := TGetHlp():ReDefine( 690, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfIva( oBeneficioSobre[ 4 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 47 ], aGet[ 29 ], aTmp[ 9 ], aGet[ 41 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )









      aGet[ 24 ] := TCheckBox():ReDefine( 700, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 30 ] := TGetHlp():ReDefine( 710, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 5 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 24 ], aTmp[ 30 ], aTmp[ 9 ], aGet[ 42 ], aGet[ 48 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 24 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 5 ] := TComboBox():ReDefine( 720, { | u | If( PCount()==0, cBeneficioSobre[ 5 ], cBeneficioSobre[ 5 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 24 ], aGet[ 30 ]:lValid(), aGet[ 42 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 42 ] := TGetHlp():ReDefine( 730, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfPts( oBeneficioSobre[ 5 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 42 ], aGet[ 30 ], aTmp[ 9 ], aGet[ 48 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 48 ] := TGetHlp():ReDefine( 740, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfIva( oBeneficioSobre[ 5 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 48 ], aGet[ 30 ], aTmp[ 9 ], aGet[ 42 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )









      aGet[ 25 ] := TCheckBox():ReDefine( 750, { | u | If( PCount()==0, aTmp[ 25 ], aTmp[ 25 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 31 ] := TGetHlp():ReDefine( 760, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99", {||    ( lCalPre( oBeneficioSobre[ 6 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 25 ], aTmp[ 31 ], aTmp[ 9 ], aGet[ 43 ], aGet[ 49 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 25 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )






      oBeneficioSobre[ 6 ] := TComboBox():ReDefine( 770, { | u | If( PCount()==0, cBeneficioSobre[ 6 ], cBeneficioSobre[ 6 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 25 ], aGet[ 31 ]:lValid(), aGet[ 43 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,, )








      aGet[ 43 ] := TGetHlp():ReDefine( 780, { | u | If( PCount()==0, aTmp[ 43 ], aTmp[ 43 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfPts( oBeneficioSobre[ 6 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 43 ], aGet[ 31 ], aTmp[ 9 ], aGet[ 49 ], nDinDiv ) )},,,,,, .F., {||     ( !aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 49 ] := TGetHlp():ReDefine( 790, { | u | If( PCount()==0, aTmp[ 49 ], aTmp[ 49 ]:= u ) }, oFld:aDialogs[ 2 ],, cPorDiv, {||    ( CalBnfIva( oBeneficioSobre[ 6 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 49 ], aGet[ 31 ], aTmp[ 9 ], aGet[ 43 ], nDinDiv ) )},,,,,, .F., {||     ( aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )




      aGet[ 14 ] := TCheckBox():ReDefine( 420, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 .AND. lActCos() )}, .F. )










      aGet[ 58 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 58 ], aTmp[ 58 ]:= u ) }, oFld:aDialogs[ 2 ],, { 350, 351, 352 },,,,, .F., {||     ( nMode <> 3 )}, )





      aGet[81] := TMultiGet():ReDefine( 100, { | u | If( PCount()==0, aTmp[81], aTmp[81]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      oBtn := TButton():ReDefine( 1, {||( SaveDeta( aTmp, aGet, oBrw, oDlg, nMode, oTotal, oFld, aTmpFac, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oStkAct, oSayLote, oBrwPrp, oGetIra, oBtn ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 9, {||( GoHelp() )}, oDlg,,, .F.,,,, .F. )




      oBtnNumerosSerie := TButton():ReDefine( 552, {||( EditarNumerosSerie( aTmp, nMode ) )}, oDlg,,, .F.,,,, .F. )

   if nMode <> 3
      oDlg:AddFastKey( 117, {|| oBtnNumerosSerie:Click() } )
      oDlg:AddFastKey( 116, {|| oBtn:SetFocus(), oBtn:Click() } )
   end

   oDlg:AddFastKey ( 112, {|| GoHelp() } )



   oDlg:bStart    := {|| SetDlgMode( aGet, aTmp, oFld, aTmpFac, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oSayLote, oTotal, oBrwPrp, oGetIra ), if( !Empty( cCodArt ), aGet[ 4 ]:lValid(), ), aGet[ 12 ]:lValid() }



    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( EdtDetMenu( aGet[ 4 ], oDlg ) )}, oDlg:bRClicked,,, )

   EndDetMenu()

RETURN ( oDlg:nResult == 1 )



static Function cNomUbica( aTmp, aGet, dbfAlm )

   aTmp[69]      := cGetUbica( aTmp[57], dbfAlm, 1 )
   aTmp[70]      := cGetUbica( aTmp[57], dbfAlm, 2 )
   aTmp[71]      := cGetUbica( aTmp[57], dbfAlm, 3 )

   if Empty( aTmp[69] )
      aGet[69]:Hide()
      aGet[72]:Hide()
      aGet[75]:Hide()
   else
      aGet[69]:Show()
      aGet[72]:Show()
      aGet[75]:Show()
   end

   if Empty( aTmp[70] )
      aGet[70]:Hide()
      aGet[73]:Hide()
      aGet[76]:Hide()
   else
      aGet[70]:Show()
      aGet[73]:Show()
      aGet[76]:Show()
   end

   if Empty( aTmp[71] )
      aGet[71]:Hide()
      aGet[74]:Hide()
      aGet[77]:Hide()
   else
      aGet[71]:Show()
      aGet[74]:Show()
      aGet[77]:Show()
   end

   aGet[69]:Refresh()
   aGet[72]:Refresh()
   aGet[75]:Refresh()
   aGet[70]:Refresh()
   aGet[73]:Refresh()
   aGet[77]:Refresh()
   aGet[71]:Refresh()
   aGet[74]:Refresh()
   aGet[77]:Refresh()

return .T.



STATIC FUNCTION SetDlgMode( aGet, aTmp, oFld, aTmpFac, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oSayLote, oTotal, oBrwPrp, oGetIra )

   local cCodArt  := aGet[ 4 ]:VarGet()

   if !lUseCaj()
      aGet[ 10 ]:Hide()
   else
      aGet[ 10 ]:SetText( cNombreCajas() )
   end

   aGet[ 13 ]:SetText( cNombreUnidades() )

   oBrwPrp:Hide()
   oGetIra:Hide()

   oSayPr1:SetText( "" )
   oSayVp1:SetText( "" )

   oSayPr2:SetText( "" )
   oSayVp2:SetText( "" )





   oFld:aEnable   := { .T., !Empty( aTmp[ 4 ] ), .T. }
   oFld:SetOption( 1 )

   do case
   case nMode == 1

      aGet[4    ]:Show()
      aGet[6]:Show()
      aGet[15 ]:Hide()
      aGet[61   ]:Hide()
      aGet[87 ]:Hide()
      aGet[10 ]:cText( 1 )
      aGet[13]:cText( 1 )
      aGet[57 ]:cText( aTmpFac[ 7 ] )

      aGet[ 9    ]:cText( nIva( dbfIva, cDefIva() ) )
      aGet[ 50 ]:cText( nIva( dbfIva, cDefIva() ) )

      aTmp[ 80    ]  := nReq( dbfIva, cDefIva() )
      aTmp[ 62 ]  := nLastNum( dbfTmp )

      oSayLote:Hide()

   case nMode <> 1 .AND. empty( cCodArt )

      aGet[4    ]:Hide()
      aGet[6]:Hide()
      aGet[15 ]:Show()
      aGet[61   ]:Hide()
      aGet[87 ]:Hide()

      oSayLote:Hide()

   case nMode <> 1 .AND. !empty( cCodArt )

      aGet[4    ]:Show()
      aGet[6]:Show()
      aGet[15 ]:Hide()

      if aTmp[ 59   ]
         aGet[ 61   ]:Show()
         aGet[ 5 ]:Show()
         oSayLote:Show()
      else
         aGet[ 61   ]:Hide()
         aGet[ 87 ]:Hide()
         oSayLote:Hide()
      end

   end

   lCalcDeta( aTmp, aTmpFac, aGet, oTotal )

   if !Empty( aTmp[ 52 ] )
      aGet[ 54 ]:Show()
      aGet[ 54 ]:lValid()
      oSayPr1:Show()
      oSayVp1:Show()
      oSayPr1:SetText( retProp( aTmp[52], dbfPro ) )
   else
      aGet[ 54 ]:Hide()
      oSayPr1:Hide()
      oSayVp1:Hide()
   end

   if !Empty( aTmp[ 53 ] )
      aGet[ 55 ]:Show()
      aGet[ 55 ]:lValid()
      oSayPr2:Show()
      oSayVp2:Show()
      oSayPr2:SetText( retProp(  aTmp[53], dbfPro ) )
   else
      aGet[ 55 ]:Hide()
      oSayPr2:Hide()
      oSayVp2:Hide()
   end





   aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:Hide()
   aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:Hide()
   aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:Hide()

   if oUndMedicion:oDbf:Seek(  aTmp[ 12 ] )

      if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:Show()
      end

      if oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:Show()
      end

      if oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:Show()
      end

   end

   aGet[ 57 ]:lValid()
   aGet[ 4    ]:SetFocus()

Return Nil



STATIC FUNCTION SaveDeta( aTmp, aGet, oBrw, oDlg2, nMode, oTotal, oFld, aTmpFac, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oStkAct, oSayLote, oBrwPrp, oGetIra, oBtn )

   local n
   local i

   oBtn:SetFocus()







   if Empty( aTmp[ 4 ] ) .AND. lRetCodArt()
      MsgStop( "No se pueden añadir lineas sin codificar" )
      return .F.
   end

   if !lMoreIva( aTmp[9] )
      return nil
   end

   if Empty( aTmp[ 57 ] )
      MsgStop( "Código de almacen no puede estar vacio" )
      aGet[ 57 ]:SetFocus()
      Return nil
   end

   if !cAlmacen( aGet[ 57 ], dbfAlm )
      MsgStop( "Código de almacen no encontrado" )
      Return nil
   end





   if ( nMode == 1 ) .AND. ( aTmp[ 95 ] )

      if ( aTmp[ 96 ] )

         AutoNumerosSerie( aTmp, nMode )

      elseif !( dbfTmpSer )->( dbSeek( Str( aTmp[ 62 ], 4 ) + aTmp[ 4 ] ) )

         msgStop( "Tiene que introducir números de serie para este artículo." )

         EditarNumerosSerie( aTmp, nMode )

         Return .F.

      end

   end





   cOldCodArt     := ""
   cOldUndMed     := ""

   if nMode == 1

      if aTmp[ 59 ]
         GraLotArt( aTmp[ 4 ], dbfArticulo, aTmp[ 61 ] )
      end

      if !Empty( oBrwPrp:Cargo )

         for n := 1 to len( oBrwPrp:Cargo )

            for i := 1 to len( oBrwPrp:Cargo[ n ] )

               if IsNum( oBrwPrp:Cargo[ n, i ]:Value ) .AND. oBrwPrp:Cargo[ n, i ]:Value <> 0

                  aTmp[ 13]  := oBrwPrp:Cargo[ n, i ]:Value
                  aTmp[ 52 ]  := oBrwPrp:Cargo[ n, i ]:cCodigoPropiedad1
                  aTmp[ 54 ]  := oBrwPrp:Cargo[ n, i ]:cValorPropiedad1
                  aTmp[ 53 ]  := oBrwPrp:Cargo[ n, i ]:cCodigoPropiedad2
                  aTmp[ 55 ]  := oBrwPrp:Cargo[ n, i ]:cValorPropiedad2
                  aTmp[ 7]  := oBrwPrp:Cargo[ n, i ]:nPrecioCompra

                  WinGather( aTmp, aGet, dbfTmp, oBrw, nMode, nil, .F. )

               end

            next

         next

         aCopy( dbBlankRec( dbfTmp ), aTmp )

         aEval( aGet, {| o, i | if( "GET" $ o:ClassName(), o:cText( aTmp[ i ] ), ) } )

      else

         WinGather( aTmp, aGet, dbfTmp, oBrw, nMode )

      end

      if lEntCon()
         RecalculaTotal( aTmpFac )
         SetDlgMode( aGet, aTmp, oFld, aTmpFac, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oSayLote, oTotal, oBrwPrp, oGetIra )
      else
         oDlg2:End( 1 )
      end

   else

      WinGather( aTmp, aGet, dbfTmp, oBrw, nMode )

      oDlg2:end( 1 )

   end

   if !Empty( aGet[ 12 ] )
      aGet[ 12 ]:lValid()
   end

   if !Empty( oBrwPrp )
      oBrwPrp:Cargo                 := nil
   end

RETURN NIL







STATIC FUNCTION AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt )









   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden modificar registros de una factura con pagos" )
      return .F.
   end

   WinAppRec( oBrwLin, bEdtDet, dbfTmp, aTmp, cCodArt )

RETURN ( RecalculaTotal( aTmp ) )







STATIC FUNCTION EdtDeta( oBrwLin, bEdtDet, aTmp, cLoop )

   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden modificar registros de una factura con pagos" )
      return .F.
   end

   if !( dbfTmp )->lControl
      WinEdtRec( oBrwLin, bEdtDet, dbfTmp, aTmp )
   end

RETURN ( RecalculaTotal( aTmp ) )






STATIC FUNCTION DelDeta()

   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden eliminar registros de una factura con pagos" )
      return .F.
   end

   CursorWait()

   while ( dbfTmpSer )->( dbSeek( Str( ( dbfTmp )->nNumLin, 4 ) ) )
      ( dbfTmpSer )->( dbDelete() )
   end

   if ( dbfTmp )->lKitArt
      dbDelKit( , dbfTmp, ( dbfTmp )->nNumLin )
   end

   CursorWE()

RETURN ( .T. )






FUNCTION nPagFacPrv( cFactura, cFacPrvP, cDivRet, dbfDiv, lOnlyCob, aTmp )

   local nRec
   local nOrd
   local nRinDiv
   local cCodDiv
   local nTotalPagado   := 0

   IIF( cFacPrvP == nil, cFacPrvP := dbfFacPrvP, ) ;
   IIF( cDivRet == nil, cDivRet := cDivEmp(), ) ;
   IIF( lOnlyCob == nil, lOnlyCob := .T., ) ;

   nRinDiv              := nRinDiv( cDivRet, dbfDiv )





   nRec                    := ( cFacPrvP )->( Recno() )

   if !Empty( aTmp )

      cCodDiv              := ( cFacPrvP )->cDivPgo

      ( cFacPrvP )->( dbGoTop() )
      while !( cFacPrvP )->( Eof() )

         if ( lOnlyCob .AND. ( cFacPrvP )->lCobrado .AND. !( cFacPrvP )->lDevuelto ) .OR. ( !lOnlyCob .AND. !( cFacPrvP )->lDevuelto )

            nTotalPagado   += ( cFacPrvP )->nImporte

         end

         ( cFacPrvP )->( dbSkip() )

      end

      ( cFacPrvP )->( dbGoTo( nRec ) )

   else

      nOrd                 := ( cFacPrvP )->( OrdSetFocus( "NNUMFAC" ) )

      if ( cFacPrvP )->( dbSeek( cFactura, .T. ) )

         cCodDiv           := ( cFacPrvP )->cDivPgo

         while ( ( cFacPrvP )->cSerFac + Str( ( cFacPrvP )->nNumFac ) + ( cFacPrvP )->cSufFac = cFactura )

            if ( lOnlyCob .AND. ( cFacPrvP )->lCobrado .AND. !( cFacPrvP )->lDevuelto ) .OR. ( !lOnlyCob .AND. !( cFacPrvP )->lDevuelto )

               nTotalPagado   += ( cFacPrvP )->nImporte

            end

            ( cFacPrvP )->( dbSkip() )

         end

      end

      ( cFacPrvP )->( OrdSetFocus( nOrd ) )

   end

   ( cFacPrvP )->( dbGoTo( nRec ) )

   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      nTotalPagado   := nCnv2Div( nTotalPagado, cCodDiv, cDivRet, dbfDiv )
   else
      nTotalPagado   := Round( nTotalPagado, nRinDiv )
   end

RETURN ( nTotalPagado )



FUNCTION ChkPagFacPrv( dbfFacPrvT, dbfFacPrvP )

    local nBitmap

   do case
   case ( dbfFacPrvT )->lLiquidada
        nBitmap    := 1
   case lRecibosPagados( dbfFacPrvT, dbfFacPrvP )
      nBitmap  := 2
   otherwise
      nBitmap  := 3
   end

RETURN nBitmap






FUNCTION ChkLqdFacPrv( aTmp, dbfFacPrvT, dbfFacPrvL, dbfFacPrvP, dbfIva, dbfDiv )

   local oError
   local oBlock
   local nTotFac
   local cDivFac
   local cNumFac
   local nPagFac

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   if aTmp <> nil
      cNumFac        := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]
      cDivFac        := aTmp[ 36 ]
   else
      cNumFac        := ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac
      cDivFac        := ( dbfFacPrvT )->cDivFac
   end

   nPagFac           := abs( nPagFacPrv( cNumFac, dbfFacPrvP, cDivFac, dbfDiv ) )
   nTotFac           := abs( nTotFacPrv( cNumFac, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, dbfFacPrvP, nil, nil, .F. ) )

   if aTmp <> nil
      aTmp[ 15 ]           := ( ( nPagFac == nTotFac ) .OR. ( nPagFac > nTotFac ) )
   else
      if dbLock( dbfFacPrvT )
         ( dbfFacPrvT )->lLiquidada := ( ( nPagFac == nTotFac ) .OR. ( nPagFac > nTotFac ) )
         ( dbfFacPrvT )->( dbRUnLock() )
      end
   end

   RECOVER USING oError

   end

   ErrorBlock( oBlock )

RETURN NIL



STATIC FUNCTION PrnSerie( oBrw )

    local oDlg
   local oFmtDoc
   local cFmtDoc     := cFormatoDocumento( ( dbfFacPrvT )->cSerFac, "nFacPrv", dbfCount )
   local oSayFmt
   local cSayFmt
   local oSerIni
   local oSerFin
   local nRecno      := ( dbfFacPrvT )->( Recno() )
   local nOrdAnt     := ( dbfFacPrvT )->( OrdSetFocus( 1 ) )
   local cSerIni     := ( dbfFacPrvT )->cSerFac
   local cSerFin     := ( dbfFacPrvT )->cSerFac
   local nDocIni     := ( dbfFacPrvT )->nNumFac
   local nDocFin     := ( dbfFacPrvT )->nNumFac
   local cSufIni     := ( dbfFacPrvT )->cSufFac
   local cSufFin     := ( dbfFacPrvT )->cSufFac
   local oPrinter
   local cPrinter    := PrnGetName()
   local lCopiasPre  := .T.
   local lInvOrden   := .F.
   local oNumCop
   local nNumCop     := if( nCopiasDocumento( ( dbfFacPrvT )->cSerFac, "nFacPrv", dbfCount ) == 0, Max( Retfld( ( dbfFacPrvT )->cCodPrv, dbfPrv, "nCopiasF" ), 1 ), nCopiasDocumento( ( dbfFacPrvT )->cSerFac, "nFacPrv", dbfCount ) )

   if Empty( cFmtDoc )
      cFmtDoc        := cSelPrimerDoc( "FP" )
   end

   cSayFmt           := cNombreDoc( cFmtDoc )

   oDlg = TDialog():New(,,,, "Imprimir series de facturas", "IMPSERDOC",, .F.,,,,,, .F.,,,,,, .F., )









   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z"  )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )









   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z"  )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )









   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999", {||    ( If ( !( dbfFacPrvT )->( dbSeek( cSerIni + Str( nDocIni, 9 ) + cSufIni ) ),    ( msgStop( "Documento no valido" ), .F. ),    ( .T. ) ) )}, "N/W*",,,,, .F.,,, .F., .T.,,,,,, nil,,, )









   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999", {||    ( If ( !( dbfFacPrvT )->( dbSeek( cSerFin  + Str( nDocFin, 9 ) + cSufFin ) ),    ( msgStop( "Documento no valido" ), .F. ),    ( .T. ) ) )}, "N/W*",,,,, .F.,,, .F., .T.,,,,,, nil,,, )








   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##", {||    ( If ( !( dbfFacPrvT )->( dbSeek( cSerIni  + Str( nDocIni, 9 ) + cSufIni ) ),    ( msgStop( "Documento no valido" ), .F. ),    ( .T. ) ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,,, nil,,, )








   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##", {||    ( If ( !( dbfFacPrvT )->( dbSeek( cSerFin  + Str( nDocFin, 9 ) + cSufFin ) ),    ( msgStop( "Documento no valido" ), .F. ),    ( .T. ) ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,,, nil,,, )



   TCheckBox():ReDefine( 500, { | u | If( PCount()==0, lInvOrden, lInvOrden:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 170, { | u | If( PCount()==0, lCopiasPre, lCopiasPre:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oNumCop := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, nNumCop, nNumCop:= u ) }, oDlg,, "999999999", {||    nNumCop > 0},,,,,, .F., {||     !lCopiasPre},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )







   oFmtDoc := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cFmtDoc, cFmtDoc:= u ) }, oDlg,,, {||    ( cDocumento( oFmtDoc, oSayFmt, dbfDoc ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oFmtDoc, oSayFmt, "FP" ) )}, nil, "LUPA",, )





   oSayFmt := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayFmt, cSayFmt:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 92, "Printer_pencil_16",,,,,{|| EdtDocumento( cFmtDoc ) }, oDlg, .F., , .F.,  )




   oPrinter := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cPrinter, cPrinter:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 161, "Printer_preferences_16",,,,,{|| PrinterPreferences( oPrinter ) }, oDlg, .F., , .F.,  )





   TButton():ReDefine( 1, {||(  StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden ), oDlg:end( 1 ) } )

   oDlg:bStart := { || oSerIni:SetFocus() }

    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   ( dbfFacPrvT )->( ordSetFocus( nOrdAnt ) )
   ( dbfFacPrvT )->( dbGoTo( nRecNo ) )

    oBrw:refresh()

RETURN NIL



STATIC FUNCTION StartPrint( cFmtDoc, cDocIni, cDocFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden )

   local nCopyProvee

   oDlg:disable()

   if !lInvOrden

      ( dbfFacPrvT )->( dbSeek( cDocIni, .T. ) )


      while ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + (dbfFacPrvT)->cSufFac >= cDocIni .AND.  ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + (dbfFacPrvT)->cSufFac <= cDocFin

            lChgImpDoc( dbfFacPrvT )

         if lCopiasPre

            nCopyProvee    := if( nCopiasDocumento( ( dbfFacPrvT )->cSerFac, "nFacPrv", dbfCount ) == 0, Max( Retfld( ( dbfFacPrvT )->cCodPrv, dbfPrv, "nCopiasF" ), 1 ), nCopiasDocumento( ( dbfFacPrvT )->cSerFac, "nFacPrv", dbfCount ) )

            GenFacPrv( 1, "Imprimiendo documento : " + ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + (dbfFacPrvT)->cSufFac, cFmtDoc, cPrinter, nCopyProvee )

         else

            GenFacPrv( 1, "Imprimiendo documento : " + ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + (dbfFacPrvT)->cSufFac, cFmtDoc, cPrinter, nNumCop )

         end

      (dbfFacPrvT)->( dbSkip() )

      end

   else

      ( dbfFacPrvT )->( dbSeek( cDocFin ) )



      while ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac >= cDocIni .AND.  ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac <= cDocFin .AND. !( dbfFacPrvT )->( Bof() )

            lChgImpDoc( dbfFacPrvT )

         if lCopiasPre

            nCopyProvee    := if( nCopiasDocumento( ( dbfFacPrvT )->cSerFac, "nFacPrv", dbfCount ) == 0, Max( Retfld( ( dbfFacPrvT )->cCodPrv, dbfPrv, "nCopiasF" ), 1 ), nCopiasDocumento( ( dbfFacPrvT )->cSerFac, "nFacPrv", dbfCount ) )

            GenFacPrv( 1, "Imprimiendo documento : " + ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + (dbfFacPrvT)->cSufFac, cFmtDoc, cPrinter, nCopyProvee )

         else

            GenFacPrv( 1, "Imprimiendo documento : " + ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + (dbfFacPrvT)->cSufFac, cFmtDoc, cPrinter, nNumCop )

         end

      ( dbfFacPrvT )->( dbSkip( -1 ) )

      end

   end

   oDlg:enable()

RETURN NIL







STATIC FUNCTION lCalcDeta( aTmp, aTmpFac, aGet, oTotal )

   oTotal:cText( nTotLFacPrv( aTmp, nDinDiv, nRinDiv ) )





   aGet[ 19 ]:cText( nNetUFacPrv( aTmp, aTmpFac, nDinDiv, nRinDiv, aTmpFac[ 37 ] ) )

   if aTmp[ 20 ]
         aGet[ 26 ]:lValid()
   else
      if aTmp[ 51 ]
         aGet[ 44 ]:lValid()
      else
         aGet[ 38 ]:lValid()
      end
   end

   if aTmp[ 21 ]
         aGet[ 27 ]:lValid()
   else
      if aTmp[ 51 ]
         aGet[ 45 ]:lValid()
      else
         aGet[ 39 ]:lValid()
      end
   end

   if aTmp[ 22 ]
         aGet[ 28 ]:lValid()
   else
      if aTmp[ 51 ]
         aGet[ 46 ]:lValid()
      else
         aGet[ 40 ]:lValid()
      end
   end

   if aTmp[ 23 ]
         aGet[ 29 ]:lValid()
   else
      if aTmp[ 51 ]
         aGet[ 47 ]:lValid()
      else
         aGet[ 41 ]:lValid()
      end
   end

   if aTmp[ 24 ]
         aGet[ 30 ]:lValid()
   else
      if aTmp[ 51 ]
         aGet[ 48 ]:lValid()
      else
         aGet[ 42 ]:lValid()
      end
   end

   if aTmp[ 25 ]
         aGet[ 31 ]:lValid()
   else
      if aTmp[ 51 ]
         aGet[ 49 ]:lValid()
      else
         aGet[ 43 ]:lValid()
      end
   end

   if lActCos()

      if aTmp[ 7 ] <> 0
         aGet[ 14 ]:Click( .T. ):Refresh()
      else
         aGet[ 14 ]:Click( .F. ):Refresh()
      end

   end

RETURN .T.



FUNCTION nNetUFacPrv( uFacPrvL, uFacPrvT, nDec, nRec, nVdv, cPinDiv )

   local nDtoEsp
    local nDtoPP
   local nDtoUno
    local nDtoDos
   local nCalculo
   local nDtoLin
   local nDtoPrm
   local nPorte

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRec == nil, nRec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacPrv( uFacPrvL, nDec, nVdv )

   if ValType( uFacPrvL ) == "A"
      nDtoLin     := uFacPrvL[ 16 ]
      nDtoPrm     := uFacPrvL[ 17 ]
   else
      nDtoLin     := ( uFacPrvL )->nDtoLin
      nDtoPrm     := ( uFacPrvL )->nDtoPrm
   end

   if nDtoLin <> 0
      nCalculo    -= nCalculo * nDtoLin / 100
   end

   if nDtoPrm <> 0
      nCalculo    -= nCalculo * nDtoPrm / 100
   end





   if ValType( uFacPrvT ) == "A"
      nDtoEsp     := uFacPrvT[ 30 ]
      nDtoPP      := uFacPrvT[ 32    ]
      nDtoUno     := uFacPrvT[ 40 ]
      nDtoDos     := uFacPrvT[ 42 ]
      nPorte      := uFacPrvT[ 25 ]
   else
      nDtoEsp     := (uFacPrvT)->NDTOESP
      nDtoPP      := (uFacPrvT)->NDPP
      nDtoUno     := (uFacPrvT)->NDTOUNO
      nDtoDos     := (uFacPrvT)->NDTODOS
      nPorte      := (uFacPrvT)->NPORTES
   end

   if nDtoEsp <> 0
      nCalculo    -= Round( nCalculo * nDtoEsp / 100, nDec )
   end

   if nDtoPP <> 0
      nCalculo    -= Round( nCalculo * nDtoPP  / 100, nDec )
   end

   if nDtoUno <> 0
      nCalculo    -= Round( nCalculo * nDtoUno / 100, nDec )
   end

   if nDtoDos <> 0
      nCalculo    -= Round( nCalculo * nDtoDos / 100, nDec )
   end

   nCalculo       := Round( nCalculo, nDec )

RETURN ( if( cPinDiv <> NIL, Trans( nCalculo, cPinDiv ), nCalculo ) )



FUNCTION nImpUFacPrv( uFacPrvT, dbfFacPrvL, nDec, nVdv, lIva, cPouDiv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lIva == nil, lIva := .F., ) ;

   nCalculo       := nTotUFacPrv( dbfFacPrvL, nDec, nVdv )

   if ValType( uFacPrvT ) == "A"
      nCalculo    -= Round( nCalculo * uFacPrvT[ 30 ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 32    ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 40 ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 42 ]  / 100, nDec )
   else
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoEsp / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDpp    / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoUno / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoDos / 100, nDec )
   end

   if lIva .AND. ( dbfFacPrvL )->nIva <> 0
      nCalculo    += nCalculo * ( dbfFacPrvL )->nIva / 100
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nImpLFacPrv( uFacPrvT, dbfFacPrvL, nDec, nRou, nVdv, lIva, cPouDiv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRou == nil, nRou := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;
   IIF( lIva == nil, lIva := .F., ) ;

   nCalculo       := nTotLFacPrv( dbfFacPrvL, nDec, nRou, nVdv )

   if ValType( uFacPrvT ) == "A"
      nCalculo    -= Round( nCalculo * uFacPrvT[ 30 ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 32    ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 40 ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 42 ]  / 100, nRou )
   else
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoEsp / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDpp    / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoUno / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoDos / 100, nRou )
   end

   if lIva .AND. ( dbfFacPrvL )->nIva <> 0
      nCalculo    += nCalculo * ( dbfFacPrvL )->nIva / 100
   end

RETURN ( if( cPouDiv <> NIL, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nTotFacPrv( cFactura, cFacPrvT, cFacPrvL, cDbfIva, cDbfDiv, cFacPrvP, aTmp, cDivRet, lPic )

    local bCondition
    local nTotalArt
   local lRecargo
   local dFecFac
    local nDtoEsp
    local nDtoPP
   local nDtoUno
   local nDtoDos
    local nPorte
   local nPctRet
   local nRecno
    local cCodDiv
    local cCodPgo
   local nRegIva
   local aTotalUno   := { 0, 0, 0 }
      local aTotalDos   := { 0, 0, 0 }
   local aTotalDto   := { 0, 0, 0 }
    local aTotalDPP    := { 0, 0, 0 }
   local lFacGas     := .F.
   local aNetGas     := { 0, 0, 0 }
   local aPIvGas     := { 0, 0, 0 }
   local aPReGas     := { 0, 0, 0 }

   IIF( cFacPrvT == nil, cFacPrvT := dbfFacPrvT, ) ;
   IIF( cFacPrvL == nil, cFacPrvL := dbfFacPrvL, ) ;
   IIF( cDbfIva == nil, cDbfIva := dbfIva, ) ;
   IIF( cDbfDiv == nil, cDbfDiv := dbfDiv, ) ;
   IIF( cFacPrvP == nil, cFacPrvP := dbfFacPrvP, ) ;
   IIF( cFactura == nil, cFactura := ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac, ) ;
   IIF( lPic == nil, lPic := .F., ) ;

   public nTotBrt    := 0
   public nTotNet    := 0
   public nTotSup    := 0
   public nTotIva    := 0
   public nTotReq    := 0
   public nTotRet    := 0
   public nTotFac    := 0
   public nTotDto    := 0
   public nTotDpp    := 0
   public nTotUno    := 0
   public nTotDos    := 0
   public nTotImp    := 0
   public nTotUnd    := 0
   public nPagFac    := 0
   public nTipRet    := 0
   public aTotIva    := { { 0,0,nil,0,0,0 }, { 0,0,nil,0,0,0 }, { 0,0,nil,0,0,0 } }
   public aIvaUno    := aTotIva[ 1 ]
   public aIvaDos    := aTotIva[ 2 ]
   public aIvaTre    := aTotIva[ 3 ]

   nRecno            := ( cFacPrvL )->( recno() )

   if aTmp <> nil
      dFecFac        := aTmp[ 5 ]
      lRecargo       := aTmp[ 33]
      nDtoEsp        := aTmp[ 30 ]
      nDtoPP         := aTmp[ 32    ]
      nDtoUno        := aTmp[ 40 ]
      nDtoDos        := aTmp[ 42 ]
      nPorte         := aTmp[ 25 ]
      cCodDiv        := aTmp[ 36 ]
      cCodPgo        := aTmp[ 23]
      nTipRet        := aTmp[ 51 ]
      nPctRet        := aTmp[ 52 ]
      nRegIva        := aTmp[ 56 ]
      lFacGas        := aTmp[ 57 ]
      aNetGas        := { aTmp[ 59 ], aTmp[ 60 ], aTmp[ 61 ] }
      aPIvGas        := { aTmp[ 62 ], aTmp[ 63 ], aTmp[ 64 ] }
      aPReGas        := { aTmp[ 65  ], aTmp[ 66  ], aTmp[ 67  ] }
      bCondition     := {|| ( cFacPrvL )->( !eof() ) }
      ( cFacPrvL )->( dbGoTop() )
   else
      dFecFac        := ( cFacPrvT )->dFecFac
      lRecargo       := ( cFacPrvT )->lRecargo
      nDtoEsp        := ( cFacPrvT )->nDtoEsp
      nDtoPP         := ( cFacPrvT )->nDpp
      nDtoUno        := ( cFacPrvT )->nDtoUno
      nDtoDos        := ( cFacPrvT )->nDtoDos
      nPorte         := ( cFacPrvT )->nPortes
      cCodDiv        := ( cFacPrvT )->cDivFac
      cCodPgo        := ( cFacPrvT )->cCodPago
      nTipRet        := ( cFacPrvT )->nTipRet
      nPctRet        := ( cFacPrvT )->nPctRet
      nRegIva        := ( cFacPrvT )->nRegIva
      lFacGas        := ( cFacPrvT )->lFacGas
      aNetGas        := { ( cFacPrvT )->nNetGas1, ( cFacPrvT )->nNetGas2, ( cFacPrvT )->nNetGas3 }
      aPIvGas        := { ( cFacPrvT )->nIvaGas1, ( cFacPrvT )->nIvaGas2, ( cFacPrvT )->nIvaGas3 }
      aPReGas        := { ( cFacPrvT )->nReGas1,  ( cFacPrvT )->nReGas2,  ( cFacPrvT )->nReGas3  }
      bCondition     := {|| ( cFacPrvL )->cSerFac + Str( ( cFacPrvL )->nNumFac ) + ( cFacPrvL )->cSufFac == cFactura .AND. ( cFacPrvL )->( !eof() ) }
      ( cFacPrvL )->( dbSeek( cFactura ) )
   end





   cPinDiv           := cPinDiv( cCodDiv, cDbfDiv )
   cPirDiv           := cPirDiv( cCodDiv, cDbfDiv )
   nDinDiv           := nDinDiv( cCodDiv, cDbfDiv )
   nRinDiv           := nRinDiv( cCodDiv, cDbfDiv )

   if !lFacGas

      while Eval( bCondition )

         if lValLine( cFacPrvL )

            nTotalArt            := nTotLFacPrv( cFacPrvL, nDinDiv, nRinDiv )

            if nTotalArt <> 0

               if ( cFacPrvL )->lGasSup
                  nTotSup        += nTotalArt
               end





               do case
                  case aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 1, 3 ] == ( cFacPrvL )->nIva
                     aTotIva[ 1, 3 ]   := ( cFacPrvL )->nIva
                     aTotIva[ 1, 4 ]   := ( cFacPrvL )->nReq
                     aTotIva[ 1, 1 ]   += nTotalArt

                  case aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 2, 3 ] == ( cFacPrvL )->nIva
                     aTotIva[ 2, 3 ]   := ( cFacPrvL )->nIva
                     aTotIva[ 2, 4 ]   := ( cFacPrvL )->nReq
                     aTotIva[ 2, 1 ]   += nTotalArt

                  case aTotIva[ 3, 3 ] == nil .OR. aTotIva[ 3, 3 ] == ( cFacPrvL )->nIva
                     aTotIva[ 3, 3 ]   := ( cFacPrvL )->nIva
                     aTotIva[ 3, 4 ]   := ( cFacPrvL )->nReq
                     aTotIva[ 3, 1 ]   += nTotalArt

               end

            end

            nTotUnd              += nTotNFacPrv( cFacPrvL )

         end

         ( cFacPrvL )->( dbSkip() )

      end

      ( cFacPrvL )->( dbGoto( nRecno ) )

   else

      aTotIva[ 1, 1 ]   := aNetGas[1]
      aTotIva[ 1, 3 ]   := aPIvGas[1]
      aTotIva[ 1, 4 ]   := aPReGas[1]

      aTotIva[ 2, 1 ]   := aNetGas[2]
      aTotIva[ 2, 3 ]   := aPIvGas[2]
      aTotIva[ 2, 4 ]   := aPReGas[2]

      aTotIva[ 3, 1 ]   := aNetGas[3]
      aTotIva[ 3, 3 ]   := aPIvGas[3]
      aTotIva[ 3, 4 ]   := aPReGas[3]

   end





   aTotIva              := aSort( aTotIva,,, {|x,y| abs( x[1] ) > abs( y[1] ) } )

   aTotIva[ 1, 2 ]            := Round( aTotIva[ 1, 1 ], nRinDiv )
   aTotIva[ 2, 2 ]            := Round( aTotIva[ 2, 1 ], nRinDiv )
   aTotIva[ 3, 2 ]            := Round( aTotIva[ 3, 1 ], nRinDiv )

   nTotBrt              := aTotIva[ 1, 2 ] + aTotIva[ 2, 2 ] + aTotIva[ 3, 2 ]





   nTotBrt              += nPorte





   if !lFacGas

      IF nDtoEsp <> 0

         aTotalDto[1]   := Round( aTotIva[ 1, 2 ] * nDtoEsp / 100, nRinDiv )
         aTotalDto[2]   := Round( aTotIva[ 2, 2 ] * nDtoEsp / 100, nRinDiv )
         aTotalDto[3]   := Round( aTotIva[ 3, 2 ] * nDtoEsp / 100, nRinDiv )

         nTotDto        := aTotalDto[1] + aTotalDto[2] + aTotalDto[3]

         aTotIva[ 1, 2 ]      -= aTotalDto[1]
         aTotIva[ 2, 2 ]      -= aTotalDto[2]
         aTotIva[ 3, 2 ]      -= aTotalDto[3]

      end

      IF nDtoPP <> 0

         aTotalDPP[1]   := Round( aTotIva[ 1, 2 ] * nDtoPP / 100, nRinDiv )
         aTotalDPP[2]   := Round( aTotIva[ 2, 2 ] * nDtoPP / 100, nRinDiv )
         aTotalDPP[3]   := Round( aTotIva[ 3, 2 ] * nDtoPP / 100, nRinDiv )

         nTotDPP      := aTotalDPP[1] + aTotalDPP[2] + aTotalDPP[3]

         aTotIva[ 1, 2 ]      -= aTotalDPP[1]
         aTotIva[ 2, 2 ]      -= aTotalDPP[2]
         aTotIva[ 3, 2 ]      -= aTotalDPP[3]

      end

      IF nDtoUno <> 0

         aTotalUno[1]   := Round( aTotIva[ 1, 2 ] * nDtoUno / 100, nRinDiv )
         aTotalUno[2]   := Round( aTotIva[ 2, 2 ] * nDtoUno / 100, nRinDiv )
         aTotalUno[3]   := Round( aTotIva[ 3, 2 ] * nDtoUno / 100, nRinDiv )

         nTotUno        := aTotalUno[1] + aTotalUno[2] + aTotalUno[3]

         aTotIva[ 1, 2 ]      -= aTotalUno[1]
         aTotIva[ 2, 2 ]      -= aTotalUno[2]
         aTotIva[ 3, 2 ]      -= aTotalUno[3]

      end

      IF nDtoDos <> 0

         aTotalDos[1]   := Round( aTotIva[ 1, 2 ] * nDtoDos / 100, nRinDiv )
         aTotalDos[2]   := Round( aTotIva[ 2, 2 ] * nDtoDos / 100, nRinDiv )
         aTotalDos[3]   := Round( aTotIva[ 3, 2 ] * nDtoDos / 100, nRinDiv )

         nTotDos        := aTotalDos[1] + aTotalDos[2] + aTotalDos[3]

         aTotIva[ 1, 2 ]      -= aTotalDos[1]
         aTotIva[ 2, 2 ]      -= aTotalDos[2]
         aTotIva[ 3, 2 ]      -= aTotalDos[3]

      end

   end





   if nRegIva <= 1

      aTotIva[ 1, 5 ]         := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 3 ] / 100, nRinDiv ), 0 )
      aTotIva[ 2, 5 ]         := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 3 ] / 100, nRinDiv ), 0 )
      aTotIva[ 3, 5 ]         := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 3 ] / 100, nRinDiv ), 0 )





      if lRecargo
         aTotIva[ 1, 6 ]   := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 4 ] / 100, nRinDiv ), 0 )
         aTotIva[ 2, 6 ]   := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 4 ] / 100, nRinDiv ), 0 )
         aTotIva[ 3, 6 ]   := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 4 ] / 100, nRinDiv ), 0 )
      end

   end





   nTotIva           := Round( aTotIva[ 1, 5 ] + aTotIva[ 2, 5 ] + aTotIva[ 3, 5 ], nRinDiv )





   nTotReq           := Round( aTotIva[ 1, 6 ] + aTotIva[ 2, 6 ] + aTotIva[ 3, 6 ], nRinDiv )





   nTotNet           := Round( aTotIva[ 1, 2 ] + aTotIva[ 2, 2 ] + aTotIva[ 3, 2 ], nRinDiv )





   nTotImp           := Round( nTotIva + nTotReq, nRinDiv )





   if isNum( nTipRet )
      if nTipRet <= 1
         nTotRet     := Round( ( nTotNet - nTotSup ) * nPctRet / 100, nRinDiv )
      else
         nTotRet     := Round( ( nTotNet - nTotSup + nTotIva ) * nPctRet / 100, nRinDiv )
      end
   end





   nTotFac           := Round( nTotNet + nTotImp - nTotRet, nRinDiv )





   if cFacPrvP <> nil
      nPagFac        := nPagFacPrv( cFactura, cFacPrvP, cCodDiv, cDbfDiv, .T., aTmp )
   end

   aTotIva           := aSort( aTotIva,,, {|x,y| abs( x[1] ) > abs( y[1] ) } )





   if cDivRet <> nil .AND. cDivRet <> cCodDiv
      nTotNet        := nCnv2Div( nTotNet, cCodDiv, cDivRet, cDbfDiv )
      nTotIva        := nCnv2Div( nTotIva, cCodDiv, cDivRet, cDbfDiv )
      nTotReq        := nCnv2Div( nTotReq, cCodDiv, cDivRet, cDbfDiv )
      nTotFac        := nCnv2Div( nTotFac, cCodDiv, cDivRet, cDbfDiv )
      cPirDiv        := cPirDiv( cDivRet, cDbfDiv )
   end

RETURN ( if( lPic, Trans( nTotFac, cPirDiv ), nTotFac ) )



Static Function RecalculaTotal( aTmp )

   nTotFacPrv( nil, dbfFacPrvT, dbfTmp, dbfIva, dbfDiv, dbfTmpPgo, aTmp )

   if oBrwIva <> nil
      oBrwIva:refresh()
   end

   if oGetNet <> nil
      oGetNet:SetText( Trans( nTotNet, cPirDiv ) )
   end

   if oGetIva <> nil
      oGetIva:SetText( Trans( nTotIva, cPirDiv ) )
   end

   if oGetReq <> nil
      oGetReq:SetText( Trans( nTotReq, cPirDiv ) )
   end

   if oGetTotal <> nil
      oGetTotal:SetText( Trans( nTotFac, cPirDiv ) )
   end

   if oGetRet <> nil
      oGetRet:SetText( Trans( nTotRet, cPirDiv ) )
   end

   if oGetTotPg <> nil
      oGetTotPg:SetText( Trans( nTotFac, cPirDiv ) )
   end

   if oGetPgd <> nil
      oGetPgd:SetText( Trans( nPagFac, cPirDiv ) )
   end

   if oGetPdt <> nil
      oGetPdt:SetText( Trans( nTotFac - nPagFac, cPirDiv ) )
   end

Return .T.



function nVtaFacPrv( cCodPrv, dDesde, dHasta, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, nYear )

   local nCon     := 0
   local nRec     := ( dbfFacPrvT )->( Recno() )





   if ( dbfFacPrvT )->( dbSeek( cCodPrv ) )

      while ( dbfFacPrvT )->cCodPrv == cCodPrv .AND. !( dbfFacPrvT )->( Eof() )



         if ( dDesde == nil .OR. ( dbfFacPrvT )->dFecFac >= dDesde )    .AND. ( dHasta == nil .OR. ( dbfFacPrvT )->dFecFac <= dHasta )    .AND. ( nYear == nil .OR. Year( ( dbfFacPrvT )->dFecFac ) == nYear )

            nCon  += nTotFacPrv( ( dbfFacPrvT )->cSerFac + Str( (dbfFacPrvT)->nNumFac ) + (dbfFacPrvT)->cSufFac, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, nil, nil, cDivEmp(), .F. )

         end

         ( dbfFacPrvT )->( dbSkip() )

      end

   end

   ( dbfFacPrvT )->( dbGoTo( nRec ) )

return nCon






function nCobFacPrv( cCodPrv, dDesde, dHasta, dbfFacPrvT, dbfFacPrvP, dbfIva, dbfDiv, lOnlyCob, nYear )

   local nCob        := 0
   local nOrd        := ( dbfFacPrvT )->( OrdSetFocus( "cCodPrv" ) )
   local nRec        := ( dbfFacPrvT )->( Recno() )

   IIF( lOnlyCob == nil, lOnlyCob := .T., ) ;





   if ( dbfFacPrvT )->( dbSeek( cCodPrv ) )

      while ( dbfFacPrvT )->cCodPrv = cCodPrv .AND. !( dbfFacPrvT )->( Eof() )



         if ( dDesde == nil .OR. ( dbfFacPrvT )->DFECFAC >= dDesde ) .AND. ( dHasta == nil .OR. ( dbfFacPrvT )->DFECFAC <= dHasta ) .AND. ( nYear == nil .OR. Year( ( dbfFacPrvT )->dFecFac ) == nYear )

            nCob  += nPagFacPrv( ( dbfFacPrvT )->cSerFac + Str( (dbfFacPrvT)->nNumFac ) + (dbfFacPrvT)->cSufFac, dbfFacPrvP, cDivEmp(), dbfDiv, lOnlyCob )

         end

         ( dbfFacPrvT )->( dbSkip() )

      end

   end

   ( dbfFacPrvT )->( OrdSetFocus( nOrd ) )
   ( dbfFacPrvT )->( dbGoTo( nRec ) )

return nCob



Static Function nGenFacPrv( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local nFac

   CursorWait()

   for each nFac in ( oWndBrw:oBrw:aSelected )

      ( dbfFacPrvT )->( dbGoTo( nFac ) )

      GenFacPrv( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   next

   CursorWE()

Return ( nil )



Static Function GenFacPrv( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local oDevice
   local nFactura

   if ( dbfFacPrvT )->( Lastrec() ) == 0
      Return nil
   end

   nFactura             := ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac

   IIF( nDevice == nil, nDevice := 1, ) ;
   IIF( cCaption == nil, cCaption := "Imprimiendo facturas de proveedores", ) ;
   IIF( cCodDoc == nil, cCodDoc := cFormatoDocumento( ( dbfFacPrvT )->cSerFac, "nFacPrv", dbfCount ), ) ;
   IIF( nCopies == nil, nCopies := if( nCopiasDocumento( ( dbfFacPrvT )->cSerFac, "nFacPrv", dbfCount ) == 0, Max( Retfld( ( dbfFacPrvT )->cCodPrv, dbfPrv, "nCopiasF" ), 1 ), nCopiasDocumento( ( dbfFacPrvT )->cSerFac, "nFacPrv", dbfCount ) ), ) ;

   if Empty( cCodDoc )
      cCodDoc           := cFirstDoc( "FP", dbfDoc )
   end

   if !lExisteDocumento( cCodDoc, dbfDoc )
      return nil
   end





   if lVisualDocumento( cCodDoc, dbfDoc )

      PrintReportFacPrv( nDevice, nCopies, cPrinter, dbfDoc )

   else





      nTotFacPrv( nFactura, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, dbfFacPrvP )





      ( dbfFacPrvL )->( dbSeek( nFactura ) )
      ( dbfFacPrvP )->( dbSeek( nFactura ) )





      ( dbfPrv   )->( dbSeek( ( dbfFacPrvT )->cCodPrv ) )
      ( dbfAlm   )->( dbSeek( ( dbfFacPrvT )->cCodAlm ) )
      ( dbfFPago )->( dbSeek( ( dbfFacPrvT )->cCodPago) )
      ( dbfDiv   )->( DbSeek( ( dbfFacPrvT )->cDivFac ) )

      private cDbf         := dbfFacPrvT
      private cDbfCol      := dbfFacPrvL
      private cDbfRec      := dbfFacPrvP
      private cDbfAlm      := dbfAlm
      private cDbfPrv      := dbfPrv
      private cDbfPgo      := dbfFPago
      private cDbfIva      := dbfIva
      private cDbfDiv      := dbfDiv
      private cDbfArt      := dbfArticulo
      private cDbfKit      := dbfKit
      private cDbfPro      := dbfPro
      private cDbfTblPro   := dbfTblPro
      private nTotPage     := nTotLFacPrv( dbfFacPrvL )
      private cPinDivFac   := cPinDiv
      private cPirDivFac   := cPirDiv
      private cPicEurFac   := cPicEur
      private nDinDivFac   := nDinDiv
      private nDirDivFac   := nRinDiv
      private nVdvDivFac   := ( dbfFacPrvT )->nVdvFac

      if !Empty( cPrinter )
         oDevice           := TPrinter():New( cCaption, .F., .T., cPrinter )
         oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .F.,, oDevice, cCaption,,, )
      else
         oInf := RptBegin({}, {}, {}, {}, {}, .F.,,,, .T.,,, cCaption,,, )
      end





      if !Empty( oInf ) .AND. oInf:lCreated
         oInf:lAutoLand          := .F.
         oInf:lFinish            := .F.
         oInf:lNoCancel          := .T.
         oInf:bSkip              := {|| FacPrvReportSkipper( dbfFacPrvL ) }

         oInf:oDevice:lPrvModal  := .T.

         do case
            case nDevice == 1
               oInf:bPreview  := {| oDevice | PrintPreview( oDevice ) }

            case nDevice == 3
               oInf:bPreview  := {| oDevice | PrintPdf( oDevice ) }

         end

         SetMargin(  cCodDoc, oInf )
         PrintColum( cCodDoc, oInf )
      end

      RptEnd()

      if !Empty( oInf )



         oInf:Activate(, {||       ( ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac = nFactura )},,,, {||  ( Epage( oInf, cCodDoc ) )},,,,,,,, )

         if nDevice == 1
            oInf:oDevice:end()
         end

      end

      oInf                 := nil

   end

   lChgImpDoc( dbfFacPrvT )

RETURN NIL



Static Function FacPrvReportSkipper( dbfFacPrvL )

   ( dbfFacPrvL )->( dbSkip() )

   nTotPage              += nTotLFacPrv( dbfFacPrvL )

Return nil



STATIC FUNCTION lMoreIva( nCodIva )





    IF aTotIva[ 1, 3 ] == NIL .OR. aTotIva[ 2, 3 ] == NIL .OR. aTotIva[ 3, 3 ] == NIL
        RETURN .T.
    end

    IF aTotIva[ 1, 3 ] == nCodIva .OR. aTotIva[ 2, 3 ] == nCodIva .OR. aTotIva[ 3, 3 ] == nCodIva
        RETURN .T.
    end

   MsgStop( "Factura con mas de 3 tipos de " + cImp(), "Imposible añadir" )

RETURN .F.



STATIC FUNCTION ChgFactu( dbfFacPrvT, oBrw )

   if dbLock( dbfFacPrvT )
      ( dbfFacPrvT )->lLiquidada := !( dbfFacPrvT )->lLiquidada
      ( dbfFacPrvT )->( dbUnLock() )
   end

    oBrw:refresh()

RETURN NIL



STATIC FUNCTION loaPrv( aGet, aTmp, dbfPrv, nMode, oSay, oTlfPrv )

   local lValid      := .F.
   local cNewCodCli  := aGet[ 6 ]:VarGet()
   local lChgCodCli  := ( Empty( cOldCodCli ) .OR. cOldCodCli <> cNewCodCli )

   if Empty( cNewCodCli )
      Return .T.
   elseif At( ".", cNewCodCli ) <> 0
      cNewCodCli := PntReplace( aGet[6], "0", RetNumCodPrvEmp() )
   else
      cNewCodCli := Rjust( cNewCodCli, "0", RetNumCodPrvEmp() )
   end

   if ( dbfPrv )->( dbSeek( cNewCodCli ) )

      if ( dbfPrv )->lBlqPrv
         msgStop( "Proveedor bloqueado, no se pueden realizar operaciones de compra" )
         return .F.
      end

      aGet[6 ]:cText( ( dbfPrv )->Cod )

      if Empty( aGet[9]:varGet() ) .OR. lChgCodCli
         aGet[9]:cText( ( dbfPrv )->Titulo )
      end

      if oTlfPrv <> nil
         oTlfPrv:SetText( ( dbfPrv )->Telefono )
      end

      if Empty( aGet[10]:varGet() ) .OR. lChgCodCli
         aGet[10]:cText( ( dbfPrv )->Domicilio )
      endif

      if Empty( aGet[11]:varGet() ) .OR. lChgCodCli
         aGet[11]:cText( (dbfPrv)->POBLACION )
      endif

      if Empty( aGet[12]:varGet() ) .OR. lChgCodCli
         aGet[12]:cText( (dbfPrv)->PROVINCIA )
      endif

      if Empty( aGet[13]:varGet() ) .OR. lChgCodCli
         aGet[13]:cText( (dbfPrv)->CODPOSTAL )
      endif

      if Empty( aGet[14]:varGet() ) .OR. lChgCodCli
         aGet[14]:cText( (dbfPrv)->NIF )
      endif

      if lChgCodCli
         aGet[ 29 ]:cText( ( dbfPrv )->cDtoEsp )
         aGet[ 30 ]:cText( ( dbfPrv )->nDtoEsp )
         aGet[ 31    ]:cText( ( dbfPrv )->cDtoPP )
         aGet[ 32    ]:cText( ( dbfPrv )->DtoPP )
      end

      if Empty( aGet[ 23 ]:VarGet() ) .OR. lChgCodCli
         aGet[ 23 ]:cText( ( dbfPrv )->fPago )
         aGet[ 23 ]:lValid()





         if RetFld( aTmp[ 23 ], dbfFPago, "LUTLBNC" )

            if dbSeekInOrd( ( dbfPrv )->Cod, "CCODDEF", dbfPrvBnc )

               if !Empty( aGet[ 75 ] )
                  aGet[ 75 ]:cText( ( dbfPrvBnc )->cCodBnc )
                  aGet[ 75 ]:lValid()
               end

               if !Empty( aGet[ 76 ] )
                  aGet[ 76 ]:cText( ( dbfPrvBnc )->cEntBnc )
                  aGet[ 76 ]:lValid()
               end

               if !Empty( aGet[ 77 ] )
                  aGet[ 77 ]:cText( ( dbfPrvBnc )->cSucBnc )
                  aGet[ 77 ]:lValid()
               end

               if !Empty( aGet[ 78 ] )
                  aGet[ 78 ]:cText( ( dbfPrvBnc )->cDigBnc )
                  aGet[ 78 ]:lValid()
               end

               if !Empty( aGet[ 79 ] )
                  aGet[ 79 ]:cText( ( dbfPrvBnc )->cCtaBnc )
                  aGet[ 79 ]:lValid()
               end

            end

         end

      end

      if Empty( aGet[ 51 ]:VarGet() ) .OR. lChgCodCli
         aGet[ 51 ]:oGet:cText(  ( dbfPrv )->nTipRet )
         aGet[ 51 ]:Select(      ( dbfPrv )->nTipRet )
      end

      if Empty( aGet[ 52 ]:VarGet() ) .OR. lChgCodCli
         aGet[ 52 ]:cText( ( dbfPrv )->nPctRet )
      end

      if nMode == 1

         aGet[ 56 ]:nOption( Max( ( dbfPrv )->nRegIva, 1 ) )
         aGet[ 56 ]:Refresh()

         if Empty( aTmp[ 1 ] )

            if !Empty( ( dbfPrv )->Serie )
               aGet[ 1 ]:cText( ( dbfPrv )->Serie )
            end

         else

            if !Empty( ( dbfPrv )->Serie ) .AND. aTmp[ 1 ] <> ( dbfPrv )->Serie .AND. ApoloMsgNoYes( "La serie del proveedor seleccionado es distinta a la anterior.", "¿Desea cambiar la serie?" )
               aGet[ 1 ]:cText( ( dbfPrv )->Serie )
            end

         end

      end

      if lChgCodCli
         aTmp[ 33 ] := ( dbfPrv )->lReq
         aGet[ 33 ]:Refresh()
      end

      if ( dbfPrv )->lMosCom .AND. !Empty( ( dbfPrv )->mComent ) .AND. lChgCodCli
         MsgStop( AllTrim( ( dbfPrv )->mComent ) )
      end

      cOldCodCli  := ( dbfPrv )->Cod
      lValid      := .T.

    ELSE

        msgStop( "Proveedor no encontrado" )

    end

RETURN lValid







STATIC FUNCTION LoaArt( aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oGetIra, oDlg, oStkAct, oSayLote, oBeneficioSobre, oTotal, nMode )

   local nIva
   local nOrdAnt
   local nPreUnt
   local nPreCom
   local cCodFam
   local cPrpArt
   local cCodPrv
   local cCodArt
   local lChgCodArt
   local lSeek       := .F.

   nIva              := 0
   cCodPrv           := aTmpFac[ 6 ]
   cCodArt           := aGet[ 4    ]:VarGet()
   cPrpArt           := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]
   lChgCodArt        := ( Rtrim( cOldCodArt ) <> Rtrim( cCodArt ) .OR. Rtrim( cOldPrpArt ) <> Rtrim( cPrpArt ) )

   if Empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir lineas sin codificar" )
         return .F.
      end

        aGet[9    ]:bWhen    := {|| .T. }

      aGet[6]:Hide()

      aGet[15 ]:Show()
      aGet[15 ]:SetFocus()

      if !Empty( oBrwPrp )
         oBrwPrp:Hide()
      end

   else

      if lModIva()
            aGet[9 ]:bWhen    := {|| .T. }
      else
            aGet[9 ]:bWhen    := {|| .F. }
      end

      aGet[4    ]:Show()
      aGet[6]:Show()
      aGet[15 ]:Hide()

      if !( ( dbfArticulo )->( dbSeek( cCodArt ) ) .OR. ( dbfArticulo )->( dbSeek( Upper( cCodArt ) ) ) )





         nOrdAnt                 := ( dbfArtPrv )->( OrdSetFocus( "cRefPrv" ) )

         if ( dbfArtPrv )->( dbSeek( cCodPrv + cCodArt ) )
            cCodArt              := ( dbfArtPrv )->cCodArt
         end

         ( dbfArtPrv )->( ordSetFocus( nOrdAnt ) )





         cCodArt                 := cSeekCodebar( cCodArt, dbfCodebar, dbfArticulo )





         lSeek                   := ( ( dbfArticulo )->( dbSeek( cCodArt ) ) .OR. ( dbfArticulo )->( dbSeek( Upper( cCodArt ) ) ) )

      else

         lSeek                   := .T.

      end







      if lSeek

         if ( lChgCodArt )

            if ( dbfArticulo )->lObs
               MsgStop( "Artículo catalogado como obsoleto" )
               return .F.
            end






            aTmp[ 59  ]   := ( dbfArticulo )->lLote

            if ( dbfArticulo )->lLote
               oSayLote:Show()
               aGet[ 61   ]:Show()
               aGet[ 61   ]:cText( ( dbfArticulo )->cLote )
               aGet[ 87 ]:Show()
               aGet[ 87 ]:cText( dFechaCaducidad( aTmpFac[ 5 ], ( dbfArticulo )->nDuracion, ( dbfArticulo )->nTipDur ) )
            else
               oSayLote:Hide()
               aGet[ 61   ]:Hide()
               aGet[ 87 ]:Hide()
            end





            cCodFam              := ( dbfArticulo )->Familia
            if !Empty( cCodFam )
               aTmp[78]    := cCodFam
               aTmp[79]    := cGruFam( cCodFam, dbfFamilia )
            end





            if ( dbfArticulo )->lKitArt
               aTmp[ 64 ]     := ( dbfArticulo )->lKitArt
               aTmp[ 67 ]     := lImprimirCompuesto( ( dbfArticulo )->Codigo, dbfArticulo )
               aTmp[ 66 ]     := lPreciosCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )
               if lStockCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )
                  aTmp[ 58 ]  := ( dbfArticulo )->nCtlStock
               else
                  aTmp[ 58 ]  := 3
               end
            else
               aTmp[ 67 ]     := .F.
               aTmp[ 58 ]     := ( dbfArticulo )->nCtlStock
            end






            aTmp[ 95 ]     := ( dbfArticulo )->lNumSer
            aTmp[ 96 ]     := ( dbfArticulo )->lAutSer





            if oStkAct <> nil .AND. aTmp[ 58 ] <= 1
               oStock:nPutStockActual( cCodArt, aTmpFac[ 7 ], , , , aTmp[ 64 ], aTmp[ 58 ], oStkAct )
            end





            nPreUnt                 := aGet[ 7 ]:VarGet()





            oFld:aEnable            := { .T., .T., .T. }
            oFld:refresh()

            aGet[4    ]:cText( ( dbfArticulo )->Codigo )
            aGet[6]:cText( ( dbfArticulo )->Nombre )

            if ( dbfArticulo )->lMosCom .AND. !Empty( ( dbfArticulo )->mComent )
               MsgStop( Trim( ( dbfArticulo )->mComent ) )
            end





            nIva           := nIva( dbfIva, ( dbfArticulo )->TipoIva )
            aGet[ 9    ]:cText( nIva )
            aGet[ 50 ]:cText( nIva )
            aGet[ 51 ]:Click( ( dbfArticulo )->lIvaInc ):Refresh()

            aTmp[ 80 ]  := nReq( dbfIva, ( dbfArticulo )->TipoIva )

            if ( dbfArticulo )->nCajEnt <> 0
               aGet[10]:cText( ( dbfArticulo )->nCajEnt )
            end

            if ( dbfArticulo )->nUniCaja <> 0
               aGet[13]:cText( ( dbfArticulo )->nUniCaja )
            end





            nOrdAnt                 := ( dbfArtPrv )->( OrdSetFocus( "cCodPrv" ) )

            if ( dbfArtPrv )->( dbSeek( cCodPrv + cCodArt ) )

               if !Empty( aGet[ 5 ] )
                  aGet[ 5 ]:cText( ( dbfArtPrv )->cRefPrv )
               end

            else

               if !Empty( aGet[ 5 ] )
                  aGet[ 5 ]:cText( Space( 20 ) )
               end

            end

            ( dbfArtPrv )->( ordSetFocus( nOrdAnt ) )





            aTmp[ 82 ]     := ( dbfArticulo )->PvpRec





            aTmp[ 52 ]     := ( dbfArticulo )->cCodPrp1
            aTmp[ 53 ]     := ( dbfArticulo )->cCodPrp2


            if ( !Empty( aTmp[ 52 ] ) .OR. !Empty( aTmp[ 53 ] ) ) .AND.  ( uFieldEmpresa( "lUseTbl" ) .AND. ( nMode == 1 ) )

               nPreCom           := nCosto( nil, dbfArticulo, dbfKit, .F., aTmpFac[ 36 ], dbfDiv )

               LoadPropertiesTable( cCodArt, nPreCom, aTmp[ 52 ], aTmp[ 53 ], dbfPro, dbfTblPro, dbfArtCom, oBrwPrp, aGet[ 13 ], aGet[ 7 ] )

               oGetIra:Show()

            else

               oBrwPrp:Hide()
               oGetIra:Hide()

               if !Empty( aTmp[ 52 ] )

                  if aGet[ 54 ] <> nil
                     aGet[ 54 ]:Show()
                     aGet[ 54 ]:SetFocus()
                  end

                  if oSayPr1 <> nil
                     oSayPr1:SetText( retProp( ( dbfArticulo )->cCodPrp1, dbfPro ) )
                     oSayPr1:Show()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:Show()
                  end

               else

                  if aGet[ 54 ] <>  nil
                     aGet[ 54 ]:Hide()
                  end

                  if oSayPr1 <> nil
                     oSayPr1:Hide()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:Hide()
                  end

               end

               if !Empty( aTmp[ 53 ] )

                  if aGet[ 55 ] <> nil
                     aGet[ 55 ]:Show()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:SetText( retProp( ( dbfArticulo )->cCodPrp2, dbfPro ) )
                     oSayPr2:Show()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:Show()
                  end

               else

                  if aGet[ 55 ] <> nil
                     aGet[ 55 ]:Hide()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:Hide()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:Hide()
                  end

               end

            end





            if !Empty( aGet[ 12 ] )
               aGet[ 12 ]:cText( ( dbfArticulo )->cUnidad )
               aGet[ 12 ]:lValid()
            else
               aTmp[ 12 ]  := ( dbfArticulo )->cUnidad
            end

            ValidaMedicion( aTmp, aGet)

         end

         cPrpArt                 := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]

         if ( lChgCodArt ) .OR. ( cPrpArt <> cOldPrpArt )





            if !Empty( aGet[ 19 ] )
               aGet[ 19 ]:cText( nNetUFacPrv( aTmp, aTmpFac, nDinDiv, nRinDiv, aTmpFac[ 37 ] ) )
            end

            nPreCom              := nComPro( aTmp[ 4 ], aTmp[ 52 ], aTmp[ 54 ], aTmp[ 53 ], aTmp[ 55 ], dbfArtCom )
            if nPrecom  <> 0

               aGet[ 7 ]:cText( nPreCom )

            else

               if uFieldEmpresa( "lCosPrv", .F. )
                  nPreCom        := nPreArtPrv( cCodPrv, cCodArt, dbfArtPrv )
               end

               if nPreCom <> 0
                  aGet[ 7 ]:cText( nPreCom )
               else
                  aGet[ 7 ]:cText( nCosto( nil, dbfArticulo, dbfKit, .F., aTmpFac[ 36 ], dbfDiv ) )
               end

            end





            if uFieldEmpresa( "lCosPrv", .F. )

               nPreCom           := nDtoArtPrv( cCodPrv, cCodArt, dbfArtPrv )

               if nPreCom <> 0
                  aGet[ 16 ]:cText( nPreCom )
               end





               nPreCom           := nPrmArtPrv( cCodPrv, cCodArt, dbfArtPrv )

               if nPreCom <> 0
                  aGet[ 17 ]:cText( nPreCom )
               end

            end





            aGet[ 26 ]:cText( ( dbfArticulo )->Benef1 )
            aGet[ 27 ]:cText( ( dbfArticulo )->Benef2 )
            aGet[ 28 ]:cText( ( dbfArticulo )->Benef3 )
            aGet[ 29 ]:cText( ( dbfArticulo )->Benef4 )
            aGet[ 30 ]:cText( ( dbfArticulo )->Benef5 )
            aGet[ 31 ]:cText( ( dbfArticulo )->Benef6 )

            aGet[ 20 ]:Click( ( dbfArticulo )->lBnf1 ):Refresh()
            aGet[ 21 ]:Click( ( dbfArticulo )->lBnf2 ):Refresh()
            aGet[ 22 ]:Click( ( dbfArticulo )->lBnf3 ):Refresh()
            aGet[ 23 ]:Click( ( dbfArticulo )->lBnf4 ):Refresh()
            aGet[ 24 ]:Click( ( dbfArticulo )->lBnf5 ):Refresh()
            aGet[ 25 ]:Click( ( dbfArticulo )->lBnf6 ):Refresh()

            aGet[ 38 ]:cText( ( dbfarticulo )->pVenta1  )
            aGet[ 39 ]:cText( ( dbfArticulo )->pVenta2  )
            aGet[ 40 ]:cText( ( dbfArticulo )->pVenta3  )
            aGet[ 41 ]:cText( ( dbfArticulo )->pVenta4  )
            aGet[ 42 ]:cText( ( dbfArticulo )->pVenta5  )
            aGet[ 43 ]:cText( ( dbfArticulo )->pVenta6  )

            aGet[ 44 ]:cText( ( dbfArticulo )->pVtaIva1 )
            aGet[ 45 ]:cText( ( dbfArticulo )->pVtaIva2 )
            aGet[ 46 ]:cText( ( dbfArticulo )->pVtaIva3 )
            aGet[ 47 ]:cText( ( dbfArticulo )->pVtaIva4 )
            aGet[ 48 ]:cText( ( dbfArticulo )->pVtaIva5 )
            aGet[ 49 ]:cText( ( dbfArticulo )->pVtaIva6 )

            oBeneficioSobre[ 1 ]:Select( Max( ( dbfArticulo )->nBnfSbr1, 1 ) )
            oBeneficioSobre[ 2 ]:Select( Max( ( dbfArticulo )->nBnfSbr2, 1 ) )
            oBeneficioSobre[ 3 ]:Select( Max( ( dbfArticulo )->nBnfSbr3, 1 ) )
            oBeneficioSobre[ 4 ]:Select( Max( ( dbfArticulo )->nBnfSbr4, 1 ) )
            oBeneficioSobre[ 5 ]:Select( Max( ( dbfArticulo )->nBnfSbr5, 1 ) )
            oBeneficioSobre[ 6 ]:Select( Max( ( dbfArticulo )->nBnfSbr6, 1 ) )

         end





         lCalcDeta( aTmp, aTmpFac, aGet, oTotal )

      else

         MsgStop( "Artículo no encontrado" )
         Return .F.

      end

   end

   cOldCodArt                    := cCodArt
   cOldPrpArt                    := cPrpArt

Return .T.



STATIC FUNCTION LoadPreCosto( aGet, oGet )

    local xValor   := aGet[4]:varGet()

    IF Empty( xValor )
        RETURN .F.
    end

   if oGet == nil
      return .F.
   end

   IF ( dbfArticulo )->( dbSeek( xValor ) )
      oGet:cText( ( dbfArticulo )->pCosto )
    end

    aGet[4]:bWhen := {|| .F. }

RETURN .F.



STATIC FUNCTION LoadArtPed( aGet )

   local lValid               := .F.
   local xValor               := aGet[4]:varGet()

    IF Empty( xValor )

        aGet[9]:cText( 0 )
      aGet[9]:bWhen       := {|| .T. }

        aGet[6]:cText( Space( 50 ) )
      aGet[6]:bWhen   := {|| .T. }

        RETURN .T.

    end

   if ( dbfArticulo )->( dbSeek( xValor ) )

      aGet[4    ]:cText( ( dbfArticulo )->Codigo )
      aGet[4    ]:bWhen   := {|| .T. }

      aGet[6]:cText( ( dbfArticulo )->Nombre )
      aGet[7]:cText( ( dbfArticulo )->pCosto )

      lValid                  := .T.

   else

      MsgStop( "Artículo no encontrado" )

   end

RETURN lValid



STATIC FUNCTION GetArtPrv( cRefPrv, cCodPrv, aGet )

    local nOrdAnt

   if Empty( cRefPrv )

      return .T.

   else

        nOrdAnt  := ( dbfArtPrv )->( ordSetFocus( 3 ) )

      if ( dbfArtPrv )->( dbSeek( cCodPrv + cRefPrv ) )

         aGet[ 4 ]:cText( ( dbfArtPrv )->cCodArt )
            aGet[ 4 ]:lValid()

      else

         msgStop( "Referencia de proveedor no encontrada" )

      end

        ( dbfArtPrv )->( ordSetFocus( nOrdAnt ) )

   end

return .T.



STATIC FUNCTION SearchFact( oBrw )

    local oDlg
    local xToSearch
    local nNumFac    := 0
    local cCodCli    := (dbfFacPrvT)->CCODPRV
    local dFactura    := date()
    local nIndex    := (dbfFacPrvT)->(OrdNumber())

    oDlg = TDialog():New(,,,,, "FINFACPRV",, .F.,,,,,, .F.,,,,,, .F., )







        TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nNumFac, nNumFac:= u ) }, oDlg,, "999999999", {||     ( xToSearch := nNumFac, .T. )}, "N/W*",,,,, .F., {||         ( nIndex == 1 )},, .F., .F.,,,,,, nil,,, )






        TGetHlp():ReDefine( 140, { | u | If( PCount()==0, dFactura, dFactura:= u ) }, oDlg,,, {||     ( xToSearch := dFactura, .T. )}, "N/W*",,,,, .F., {||         ( nIndex == 2 )},, .F., .F.,,,,,, nil,,, )






        TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cCodCli, cCodCli:= u ) }, oDlg,,, {||    ( xToSearch := cCodCli, .T. )}, "N/W*",,,,, .F., {||         ( nIndex == 3 )},, .F., .F.,,,,,, nil,,, )




        TButton():ReDefine( 504, {||( (dbfFacPrvT)->( dbSeek( xToSearch ) ), oBrw:Refresh() )}, oDlg,,, .F.,,,, .F. )





        TButton():ReDefine( 510, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN NIL



STATIC FUNCTION EPage( oInf, cCodDoc )

   private nPagina      := oInf:nPage
    private lEnd            := oInf:lFinish





   PrintItems( cCodDoc, oInf )

RETURN NIL



STATIC FUNCTION aGetSelRec( oBrw, bAction, cTitle, lHide1, cTitle1, lHide2, cTitle2, bPreAction, bPostAction )

   local oDlg
   local oBtn
   local oBtnCancel
   local oRad
   local nRad        := 1
   local aRet        := {}
   local oTree
   local oChk1
   local oChk2
   local lChk1       := .T.
   local lChk2       := .T.
   local nRecno      := ( dbfFacPrvT )->( Recno() )
   local nOrdAnt     := ( dbfFacPrvT )->( OrdSetFocus( 1 ) )
   local oSerIni
   local oSerFin
   local cSerIni     := ( dbfFacPrvT )->cSerFac
   local cSerFin     := ( dbfFacPrvT )->cSerFac
   local oDocIni
   local oDocFin
   local nDocIni     := ( dbfFacPrvT )->nNumFac
   local nDocFin     := ( dbfFacPrvT )->nNumFac
   local oSufIni
   local oSufFin
   local cSufIni     := ( dbfFacPrvT )->cSufFac
   local cSufFin     := ( dbfFacPrvT )->cSufFac
   local oMtrInf
   local nMtrInf
   local lFechas     := .T.
   local dDesde      := CtoD( "01/01/" + Str( Year( Date() ) ) )
   local dHasta      := Date()
   local oImageList

   IIF( cTitle == nil, cTitle := "", ) ;
   IIF( lHide1 == nil, lHide1 := .F., ) ;
   IIF( cTitle1 == nil, cTitle1 := "", ) ;
   IIF( lHide2 == nil, lHide2 := .F., ) ;
   IIF( cTitle2 == nil, cTitle2 := "", ) ;

   oImageList        := TImageList():New( 16, 16 )
   oImageList:AddMasked( TBitmap():Define( "Bullet_Square_Red_16" ),    ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   oImageList:AddMasked( TBitmap():Define( "Bullet_Square_Green_16" ),  ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )

   oDlg = TDialog():New(,,,, cTitle, "SelectRango",, .F.,,,,,, .F.,,,,,, .F., )



   oRad := TRadMenu():Redefine( { | u | If( PCount()==0, nRad, nRad:= u ) }, oDlg,, { 80, 81 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z" )},,,,,, .T., {||     ( oRad:nOption == 2 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )






   TBtnBmp():ReDefine( 101, "Up16",,,,, {|Self|( dbFirst( dbfFacPrvT, "nNumFac", oDocIni, cSerIni, "nNumFac" ) )}, oDlg, .F.,, .F.,,,,,, !.T.,, .F.,,, .F., !.F. )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z" )},,,,,, .T., {||     ( oRad:nOption == 2 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TBtnBmp():ReDefine( 111, "Down16",,,,, {|Self|( dbLast( dbfFacPrvT, "nNumFac", oDocFin, cSerFin, "nNumFac" ) )}, oDlg, .F.,, .F.,,,,,, !.T.,, .F.,,, .F., !.F. )






   oDocIni := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRad == 2 )},, .F., .T.,,,,,, nil,,, )






   oDocFin := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRad == 2 )},, .F., .T.,,,,,, nil,,, )





   oSufIni := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRad == 2 )},, .F., .F.,,,,,, nil,,, )





   oSufFin := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRad == 2 )},, .F., .F.,,,,,, nil,,, )



   oChk1 := TCheckBox():ReDefine( 160, { | u | If( PCount()==0, lChk1, lChk1:= u ) }, oDlg,,,,,,, .F.,, .F. )



   oChk2 := TCheckBox():ReDefine( 180, { | u | If( PCount()==0, lChk2, lChk2:= u ) }, oDlg,,,,,,, .F.,, .F. )







   TCheckBox():ReDefine( 300, { | u | If( PCount()==0, lFechas, lFechas:= u ) }, oDlg,,,,,,, .F.,, .F. )





   TGetHlp():ReDefine( 310, { | u | If( PCount()==0, dDesde, dDesde:= u ) }, oDlg,,,,,,,,, .F., {||     ( !lFechas )},, .F., .T.,,,,,, nil,,, )





    TGetHlp():ReDefine( 320, { | u | If( PCount()==0, dHasta, dHasta:= u ) }, oDlg,,,,,,,,, .F., {||     ( !lFechas )},, .F., .T.,,,,,, nil,,, )





   oTree             := TTreeView():Redefine( 170, oDlg )
   oTree:bLDblClick  := {|| TreeChanged( oTree ) }





   oMtrInf := TMeter():ReDefine( 200, { | u | If( PCount()==0, nMtrInf, nMtrInf:= u ) },, oDlg, .F.,,, .T.,,,, )

   oMtrInf:SetTotal( ( dbfFacPrvT )->( OrdKeyCount() ) )




   oBtn := TButton():ReDefine( 1, {||( MakSelRec( bAction, bPreAction, bPostAction, cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oBtnCancel, dbfFacPrvT, dbfFacPrvL, oTree, oBrw, oMtrInf ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:bStart := {|| StartGetSelRec( oBrw, oRad, oChk1, oChk2, oSerIni, oSerFin, oDocIni, oDocFin, oSufIni, oSufFin, lHide1, lHide2, cTitle1, cTitle2 ) }

   oDlg:AddFastKey( 116, {|| oBtn:Click() } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oTree:SetImageList( oImageList ) )}, oDlg:bRClicked,,, )

   ( dbfFacPrvT )->( ordSetFocus( nOrdAnt ) )
   ( dbfFacPrvT )->( dbGoTo( nRecNo ) )

   oImageList:End()

   oTree:Destroy()

   oBrw:SetFocus()
   oBrw:Refresh()

RETURN ( aRet )



Static Function StartGetSelRec( oBrw, oRad, oChk1, oChk2, oSerIni, oSerFin, oDocIni, oDocFin, oSufIni, oSufFin, lHide1, lHide2, cTitle1, cTitle2 )

   if !Empty( oBrw ) .AND. ( len( oBrw:oBrw:aSelected ) > 1 )

      oRad:SetOption( 1 )

   else

      oRad:SetOption( 2 )

      oSerIni:Enable()
      oSerFin:Enable()
      oDocIni:Enable()
      oDocFin:Enable()
      oSufIni:Enable()
      oSufFin:Enable()

   end

   if lHide1
      oChk1:Hide()
   else
      SetWindowText( oChk1:hWnd, cTitle1 )
      oChk1:Refresh()
   end

   if lHide2
      oChk2:Hide()
   else
      SetWindowText( oChk2:hWnd, cTitle2 )
      oChk2:Refresh()
   end

Return ( nil )



Static Function TreeChanged( oTree )

   local oItemTree   := oTree:GetItem()

   if !Empty( oItemTree ) .AND. !Empty( oItemTree:bAction )
      Eval( oItemTree:bAction )
   end

RETURN NIL



static function MakSelRec( bAction, bPreAction, bPostAction, cDocIni, cDocFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oBtnCancel, dbfFacPrvT, dbfFacPrvL, oTree, oBrw, oMtrInf )

   local n        := 0
   local nPos     := 0
   local nRec     := ( dbfFacPrvT )->( Recno() )
   local aPos
   local lPre
   local lRet
   local lWhile   := .T.





   if lChk1
      aPos        := { 0, 0 }
      ClientToScreen( oDlg:hWnd, aPos )
      oDlg:Move( aPos[ 1 ] - 22, aPos[ 2 ] - 510 )
   end





   oDlg:Disable()

   oTree:Enable()
   oTree:DeleteAll()

   oBtnCancel:bAction   := {|| lWhile := .F. }
   oBtnCancel:Enable()

   if !Empty( bPreAction )
      lPre              := Eval( bPreAction )
   end

   if !IsLogic( lPre ) .OR. lPre

      if ( nRad == 1 )

         for each nPos in ( oBrw:oBrw:aSelected )

            ( dbfFacPrvT )->( dbGoTo( nPos ) )

            if lFechas .OR.( ( dbfFacPrvT )->dFecFac >= dDesde .AND. ( dbfFacPrvT )->dFecFac <= dHasta )

               lRet  := Eval( bAction, lChk1, lChk2, oTree, dbfFacPrvT, dbfFacPrvL )

               if IsFalse( lRet )
                  exit
               end

            end

            oMtrInf:Set( ++n )

            SysRefresh()

            if !lWhile
               exit
            end

         next

      else

         ( dbfFacPrvT )->( dbSeek( cDocIni, .T. ) )




         while ( lWhile )                                                                                         .AND. ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac, 9 ) + ( dbfFacPrvT )->cSufFac >= cDocIni   .AND.  ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac, 9 ) + ( dbfFacPrvT )->cSufFac <= cDocFin   .AND.  !( dbfFacPrvT )->( eof() )

            if lFechas .OR.( ( dbfFacPrvT )->dFecFac >= dDesde .AND. ( dbfFacPrvT )->dFecFac <= dHasta )

               lRet  := Eval( bAction, lChk1, lChk2, oTree, dbfFacPrvT, dbfFacPrvL )

               if IsFalse( lRet )
                  exit
               end

            end

            oMtrInf:Set( ( dbfFacPrvT )->( OrdKeyNo() ) )

            ( dbfFacPrvT )->( dbSkip() )

            SysRefresh()

         end

      end

      if !Empty( bPostAction )
         Eval( bPostAction )
      end

   end

   oMtrInf:Set( ( dbfFacPrvT )->( LastRec() ) )

   ( dbfFacPrvT )->( dbGoTo( nRec ) )

   if lChk1
      WndCenter( oDlg:hWnd )
   end

   oBtnCancel:bAction   := {|| oDlg:End() }

   oDlg:Enable()

   if oBrw <> nil
      oBrw:Refresh()
   end

RETURN ( nil )






STATIC FUNCTION ContFactu( lSimula, lPago, oTree )

    local n
   local nAsiento    := 0
    local cCtaVent
    local nPosicion
    local nPosIva
    local dFecha
   local aTotFac
   local nTotFac
   local nTotRet
   local aTotIva
    local cConcepto
   local cConCompr
    local cSubCtaIva
    local cSubCtaReq
   local cRuta
   local cCodEmp
   local nImpDeta
   local nDinDiv     := nDinDiv( ( dbfFacPrvT )->cDivFac, dbfDiv )
   local nRinDiv     := nRinDiv( ( dbfFacPrvT )->cDivFac, dbfDiv )
    local aSimula        := {}
    local aIva            := {}
    local aVentas        := {}
   local cCodDiv     := ( dbfFacPrvT )->cDivFac
   local cCtaPrv     := cPrvCta( ( dbfFacPrvT )->cCodPrv, dbfPrv )
   local cCtaPrvVta  := cPrvCtaVta( ( dbfFacPrvT )->cCodPrv, dbfPrv )
   local nFactura    := ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac
   local cFactura    := ( dbfFacPrvT )->cSerFac + "/" + Ltrim( Str( ( dbfFacPrvT )->nNumFac ) ) + "/" + ( dbfFacPrvT )->cSufFac
   local nNumFac     := ( dbfFacPrvT )->nNumFac
   local cCodPro     := Left( ( dbfFacPrvT )->cCodPro, 3 )
   local cClave      := Right( ( dbfFacPrvT )->cCodPro, 6 )
   local lErrorFound := .F.
   local cTerNif     := ( dbfFacPrvT )->cDniPrv
   local cTerNom     := ( dbfFacPrvT )->cNomPrv
   local lReturn





   if ( dbfFacPrvT )->lContab
      oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " ya contabilizada.", 0 ) )
      lErrorFound    := .T.
   end

   if !ChkRuta( cRutCnt() )
      oTree:Select( oTree:Add( "Factura : " + rtrim( cFactura ) + " ruta no valida.", 0 ) )
      lErrorFound    := .T.
   end





   cRuta             := cRutCnt()
   cCodEmp           := cCodEmpCnt( ( dbfFacPrvT )->cSerFac )

   if Empty( cCtaPrvVta )
      cCtaPrvVta     := cCtaPrv()
   end

   if !ChkSubCta( cRutCnt(), cCodEmp, cCtaPrv, , .F., .F. )
      oTree:Select( oTree:Add( "Factura : " + rtrim( cFactura ) + " subcuenta " + cCtaPrv + " no encontada.", 0 ) )
      lErrorFound    := .T.
   end





   aTotFac           := aTotFacPrv( nFactura, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, dbfFacPrvP )
   nTotFac           := aTotFac[ 4 ]
   aTotIva           := aTotFac[ 5 ]
   nTotRet           := aTotFac[ 6 ]





   if ( dbfFacPrvT )->lFacGas

      aAdd( aVentas, { ( dbfFacPrvT )->SubCta, aTotFac[ 1 ] } )





      for n := 1 to Len( aTotIva )

         if ( dbfFacPrvT )->nRegIva == 2
            cSubCtaIva  := uFieldEmpresa( "cCtaCeeRpt" )
            cSubCtaReq  := uFieldEmpresa( "cCtaCeeSpt" )
         else
            cSubCtaIva  := cSubCuentaIva(       aTotIva[ n, 3 ], ( dbfFacPrvT )->lRecargo, cRuta, cCodEmp, dbfIva, .F. )
            cSubCtaReq  := cSubCuentaRecargo(   aTotIva[ n, 3 ], ( dbfFacPrvT )->lRecargo, cRuta, cCodEmp, dbfIva )
         end

         nPosIva        := aScan( aIva, {|x| x[ 1 ] == aTotIva[ n, 3 ] } )
         if nPosIva == 0
            aAdd( aIva, { aTotIva[ n, 3 ], cSubCtaIva, cSubCtaReq, aTotIva[ n, 1 ] } )
         else
            aIva[ nPosIva, 4 ]   += aTotIva[ n, 1 ]
         end

      next

   else





      if ( dbfFacPrvL )->( dbSeek( nFactura ) )

         while ( ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac == nFactura .AND. !( dbfFacPrvL )->( eof() ) )

            nImpDeta       := nTotLFacPrv( dbfFacPrvL, nDinDiv, nRinDiv )

            if nImpDeta <> 0

               cCtaVent    := RetCtaCom( ( dbfFacPrvL )->cRef, dbfArticulo )
               if Empty( cCtaVent )
                  cCtaVent := cCtaPrvVta + RetGrpVta( ( dbfFacPrvL )->cRef, cRuta, cCodEmp, dbfArticulo, ( dbfFacPrvL )->nIva )
               end

               nPosicion   := aScan( aVentas, {|x| x[1] == cCtaVent } )

               if nPosicion == 0
                  aadd( aVentas, { cCtaVent, nImpDeta } )
               else
                  aVentas[ nPosicion, 2 ] += nImpDeta
               end





               if ( dbfFacPrvT )->nRegIva == 2
                  cSubCtaIva  := uFieldEmpresa( "cCtaCeeRpt" )
                  cSubCtaReq  := uFieldEmpresa( "cCtaCeeSpt" )
               else
                  cSubCtaIva  := cSubCuentaIva( ( dbfFacPrvL )->nIva, ( dbfFacPrvT )->lRecargo, cRuta, cCodEmp, dbfIva, .F. )
                  cSubCtaReq  := cSubCuentaRecargo( ( dbfFacPrvL )->nIva, ( dbfFacPrvT )->lRecargo, cRuta, cCodEmp, dbfIva )
               end

               nPosIva        := aScan( aIva, {|x| x[1] == ( dbfFacPrvL )->nIva } )
               if nPosIva == 0
                  aadd( aIva, { ( dbfFacPrvL )->nIva, cSubCtaIva, cSubCtaReq, nImpDeta } )
               else
                  aIva[ nPosIva, 4 ]   += nImpDeta
               end

            end

            ( dbfFacPrvL )->( dbSkip() )

         end

      else

         oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " factura sin artículos.", 0 ) )

         lErrorFound    := .T.

      end

   end





   for n := 1 TO Len( aVentas )

      if ( dbfFacPrvT )->nDtoEsp <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( dbfFacPrvT )->nDtoEsp / 100, nRinDiv )
      end

      if ( dbfFacPrvT )->nDpp <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( dbfFacPrvT )->nDpp / 100, nRinDiv )
      end

      if ( dbfFacPrvT )->nDtoUno <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( dbfFacPrvT )->nDtoUno / 100, nRinDiv )
      end

      if ( dbfFacPrvT )->nDtoDos <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( dbfFacPrvT )->nDtoDos / 100, nRinDiv )
      end

   next





   for n := 1 to Len( aIva )

      if ( dbfFacPrvT )->nDtoEsp <> 0
         aIva[ n, 4 ] -= Round( aIva[ n, 4 ] * ( dbfFacPrvT )->nDtoEsp / 100, nRinDiv )
      end

      if ( dbfFacPrvT )->nDpp <> 0
         aIva[ n, 4 ] -= Round( aIva[ n, 4 ] * ( dbfFacPrvT )->nDpp / 100, nRinDiv )
      end

      if ( dbfFacPrvT )->nDtoUno <> 0
         aIva[ n, 4 ] -= Round( aIva[ n, 4 ] * ( dbfFacPrvT )->nDtoUno / 100, nRinDiv )
      end

      if ( dbfFacPrvT )->nDtoDos <> 0
         aIva[ n, 2 ] -= Round( aIva[ n, 4 ] * ( dbfFacPrvT )->nDtoDos / 100, nRinDiv )
      end

   next





   for n := 1 TO len( aVentas )
      if !ChkSubCta( cRutCnt(), cCodEmp, aVentas[ n, 1 ], , .F., .F. )
         oTree:Select( oTree:Add( "Factura : " + rtrim( cFactura ) + " subcuenta " + aVentas[ n, 1 ] + " no encontada.", 0 ) )
         lErrorFound    := .T.
      end
   next





   for n := 1 to len( aIva )

      if !ChkSubCta( cRuta, cCodEmp, aIva[ n, 2 ], , .F., .F. )
         oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " subcuenta " + aIva[ n, 2 ] + " no encontada.", 0 ) )
         lErrorFound    := .T.
      end

      if !ChkSubCta( cRuta, cCodEmp, aIva[ n, 3 ], , .F., .F. )
         oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " subcuenta " + aIva[ n, 3 ] + " no encontada.", 0 ) )
         lErrorFound    := .T.
      end

   next

   if nTotRet <> 0

      if !ChkSubCta( cRuta, cCodEmp, cCtaRet(), , .F., .F. )
         oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " subcuenta " + cCtaRet() + " no encontada.", 0 ) )
         lErrorFound    := .T.
      end

   end





   if !ChkFecha( , , ( dbfFacPrvT )->dFecFac, .F. )
      oTree:Select( oTree:Add(  "Factura : " + Rtrim( cFactura ) + " asiento fuera de fechas.", 0 ) )
      lErrorFound    := .T.
   end





   if lSimula .OR. !lErrorFound

      if Empty( ( dbfFacPrvT )->dFecEnt )
         dFecha      := ( dbfFacPrvT )->dFecFac
      else
         dFecha      := ( dbfFacPrvT )->dFecEnt
      end

      cConCompr      := "S/Fcta."
      if !Empty( ( dbfFacPrvT )->cSuPed )
         nNumFac     := Val( ( dbfFacPrvT )->cSuPed )
         cConCompr   += " N." + Rtrim( ( dbfFacPrvT )->cSuPed )
      elseif !Empty( ( dbfFacPrvT )->cNumDoc )
         cConCompr   += " Doc. " + Rtrim( ( dbfFacPrvT )->cNumDoc )
      else
         cConCompr   += " N." + Rtrim( cFactura )
      end
      cConcepto      := cConCompr + Space( 1 ) + DtoC( ( dbfFacPrvT )->dFecFac )
      cConCompr      += Space( 1 ) + Rtrim( ( dbfFacPrvT )->cNomPrv )





      if OpenDiario( , cCodEmp )
         nAsiento    := RetLastAsi()
      else
         oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " imposible abrir ficheros de contaplus.", 0 ) )
         return .F.
      end

























      aAdd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, cCtaPrv, , , cConcepto, nTotFac, nNumFac, , , , ( dbfFacPrvT )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )





      for n := 1 TO len( aVentas )





















         aAdd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, aVentas[ n, 1 ], , aVentas[ n, 2 ], cConCompr, , nNumFac, , , , ( dbfFacPrvT )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

      next





      if ( dbfFacPrvT )->nRegIva == 2

         for n := 1 to len( aIva )

            if aIva[ n, 1 ] <> 0 .OR. uFieldEmpresa( "lConIva" )





















               aadd( aSimula, MkAsiento(  nAsiento,  cCodDiv, dFecha,  aIva[ n, 3 ], aIva[ n, 2 ], Round( aIva[ n, 1 ] * aIva[ n, 4 ] / 100, nRinDiv ), cConCompr, Round( aIva[ n, 1 ] * aIva[ n, 4 ] / 100, nRinDiv ), nNumFac, aIva[ n, 4 ], aIva[ n, 1 ], If( ( dbfFacPrvT )->lRecargo, nPReq( dbfIva, aIva[ n, 1 ] ), 0 ), ( dbfFacPrvT )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

            end

         next

      else

         for n := 1 to len( aIva )

            if aIva[ n, 1 ] <> 0 .OR. uFieldEmpresa( "lConIva" )





















               aadd( aSimula, MkAsiento(  nAsiento,  cCodDiv, dFecha,  aIva[ n, 2 ], cCtaPrv, Round( aIva[ n, 1 ] * aIva[ n, 4 ] / 100, nRinDiv ), cConCompr, , nNumFac, aIva[ n, 4 ], aIva[ n, 1 ], If( ( dbfFacPrvT )->lRecargo, nPReq( dbfIva, aIva[ n, 1 ] ), 0 ), ( dbfFacPrvT )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

            end

         next





         if ( dbfFacPrvT )->lRecargo

            for n := 1 to len( aIva )

               if aIva[ n, 1 ] <> 0 .OR. uFieldEmpresa( "lConIva" )





















                  aadd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, aIva[ n, 3 ], , Round( nPReq( dbfIva, aIva[ n, 1 ] ) * aIva[ n, 4 ] / 100, nRinDiv ), cConCompr, , nNumFac, , , , ( dbfFacPrvT )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

               end

            next

         end

      end





      if nTotRet <> 0





















         aadd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, cCtaRet(), , , cConCompr, nTotRet, nNumFac, , , , ( dbfFacPrvT )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

      end






      if lPago .AND. ( dbfFacPrvP )->( dbSeek( nFactura ) )

         while ( ( dbfFacPrvP )->cSerFac + Str( ( dbfFacPrvP )->nNumFac ) + ( dbfFacPrvP )->cSufFac = nFactura ) .AND. !( dbfFacPrvP )->( eof() )

            lReturn  := CntRecPrv( lSimula, oTree, nAsiento, aSimula, .T., dbfRctPrvT, dbfFacPrvP, dbfPrv, dbfFPago, dbfDiv )

            if IsFalse( lReturn )
               exit
            end

            ( dbfFacPrvP )->( dbSkip() )

         end

      end





      if !lSimula

         lReturn  := ChgContabilizado( .T., cFactura, nAsiento, oTree )

      else

         lReturn  := msgTblCon( aSimula, cCodDiv, dbfDiv, !lErrorFound, cFactura, {|| aWriteAsiento( aSimula, cCodDiv, .T., oTree, cFactura, nAsiento ), ChgContabilizado( .T., cFactura, nAsiento, oTree ) } )

      end

      CloseDiario()

   end

Return ( lReturn )












STATIC FUNCTION GrpAlb( oGet, aTmp, oBrw )

   local oDlg
   local oBrwLin
   local cDetalle    := ""
   local aAlbaranes  := {}
    local nItem         := 1
    local cCodPrv        := oGet:varGet()
   local nOrd        := ( dbfAlbPrvT )->( ordSetFocus( "CCODPRV" ) )

   if Empty( cCodPrv )
        MsgStop( "Es necesario codificar un proveedor" )
      ( dbfAlbPrvT )->( ordSetFocus( nOrd ) )
      return .T.
   end






   if !( dbfAlbPrvT )->( dbSeek( cCodPrv ) )
        MsgStop( "No existen albaranes por facturar." )
      return .T.
   end

   while ( ( dbfAlbPrvT )->cCodPrv = cCodPrv .AND. !( dbfAlbPrvT )->(Eof()) )

      if !( dbfAlbPrvT )->lFacturado






         aAdd( aAlbaranes, {  ( dbfAlbPrvT )->lFacturado , ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb , ( dbfAlbPrvT )->cSuAlb  , ( dbfAlbPrvT )->dFecAlb , ( dbfAlbPrvT )->cCodPrv , ( dbfAlbPrvT )->cNomPrv , nTotAlbPrv( ( dbfAlbPrvT )->cSerAlb + Str( ( dbfAlbPrvT )->nNumAlb ) + ( dbfAlbPrvT )->cSufAlb, dbfAlbPrvT, dbfAlbPrvL, dbfIva, dbfDiv, nil, nil, .T. ) } )

      endif

      (dbfAlbPrvT)->( DbSkip(1) )

   end





   if Len( aAlbaranes ) == 0
        MsgStop( "No existen albaranes por facturar." )
      Return .T.
   end






    oDlg = TDialog():New(,,,,, "SET_ALBARAN",, .F.,,,,,, .F.,,,,,, .F., )

   oBrwLin                       := IXBrowse():New( oDlg )

   oBrwLin:bClrSel               := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
   oBrwLin:bClrSelFocus          := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

   oBrwLin:SetArray( aAlbaranes, , , .F. )

   oBrwLin:nMarqueeStyle         := 5
   oBrwLin:cName                 := "Factura de proveedor.Agrupar albaranes"

   oBrwLin:bRClicked             := {| nRow, nCol, nFlags | oBrwLin:RButtonDown( nRow, nCol, nFlags ) }

   oBrwLin:CreateFromResource( 130 )

      with object ( oBrwLin:addCol() )
         :cHeader       := "Sl. Seleccionado"
         :bStrData      := {|| "" }
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 1 ] }
         :nWidth        := 18
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Albarán"
         :nWidth        := 80
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 2 ] }
         :cEditPicture  := "@R #/999999999/##"
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Su albarán"
         :nWidth        := 80
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 3 ] }
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Fecha"
         :nWidth        := 80
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 4 ] }
         :nDataStrAlign := 3
         :nHeadStrAlign := 3
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Código"
         :nWidth        := 80
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 5 ] }
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Proveedor"
         :nWidth        := 200
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 6 ] }
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Total"
         :nWidth        := 80
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 7 ] }
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
      end




      TButton():ReDefine( 514, {||( aAlbaranes[ oBrwLin:nArrayAt, 1 ] := !aAlbaranes[ oBrwLin:nArrayAt, 1 ], oBrwLin:Refresh() )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 517, {||( aEval( aAlbaranes, { |aItem| aItem[1] := .F. } ), oBrwLin:Refresh() )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 516, {||( aEval( aAlbaranes, { |aItem| aItem[1] := .T. } ), oBrwLin:Refresh() )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 1, {||( oDlg:End( 1 ) )}, oDlg,,, .F.,,,, .F. )





        TButton():ReDefine( 2, {||( oDlg:End() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   CursorWait()





   ( dbfAlbPrvT )->( ordSetFocus( 1 ) )

   if oDlg:nResult == 1

      for nItem := 1 to Len( aAlbaranes )

         if aAlbaranes[ nItem, 1 ]

            aAdd( aNumAlb, aAlbaranes[ nItem, 2 ] )

            if ( dbfAlbPrvT )->( dbSeek( aAlbaranes[ nItem, 2 ] ) )
               SetFacturadoAlbaranProveedor( !( dbfAlbPrvT )->lFacturado, , , dbfAlbPrvT, dbfAlbPrvL, dbfAlbPrvS )
            end

            if ( dbfAlbPrvL )->( dbSeek( aAlbaranes[ nItem, 2 ] ) )

               cDetalle                := "Albaran Nº" + ( dbfAlbPrvL )->cSerAlb + "/" + AllTrim( Str( ( dbfAlbPrvL )->nNumAlb ) ) + "/" + Rtrim( ( dbfAlbPrvL )->cSufAlb )
               if !Empty( Alltrim( aAlbaranes[ nItem, 3 ] ) )
                  cDetalle             += " - " + Alltrim( aAlbaranes[ nItem, 3 ] )
               end
               cDetalle                += " - Fecha " + Dtoc( aAlbaranes[ nItem, 4 ] )

               ( dbfTmp )->( dbAppend() )

               ( dbfTmp )->cDetalle    := cDetalle
               ( dbfTmp )->lControl    := .T.

               AddLineasAlbaranProveedor( aAlbaranes[ nItem, 2 ], .T. )

            end

            oBrw:Refresh()

         end

      next






      nTotFacPrv( nil, dbfFacPrvT, dbfTmp, dbfIva, dbfDiv, dbfFacPrvP, aTmp )

   end

   ( dbfAlbPrvT )->( ordSetFocus( nOrd ) )





   oBrwLin:CloseData()

   CursorWE()

RETURN .T.







STATIC FUNCTION cAlbPrv( aGet, oBrw, nMode, aTmp )

   local lValid   := .F.
   local cAlbaran := aGet[ 26 ]:varGet()

   if nMode <> 1 .OR. Empty( cAlbaran )
      return .T.
   end

   if ( dbfAlbPrvT )->( dbSeek( cAlbaran ) )

      if ( dbfAlbPrvT )->lFacturado

         MsgStop( "Albaran facturado" )
         lValid   := .F.

      else

         aGet[ 6 ]:cText( ( dbfAlbPrvT )->cCodPrv )
         aGet[ 6 ]:lValid()

         aGet[ 7 ]:cText( ( dbfAlbPrvT )->cCodAlm )
         aGet[ 7 ]:lValid()

         aGet[ 8 ]:cText( ( dbfAlbPrvT )->cCodCaj )
         aGet[ 8 ]:lValid()

         aGet[ 23]:cText( ( dbfAlbPrvT )->cCodPgo )
         aGet[ 23]:lValid()

         aGet[ 29 ]:cText( ( dbfAlbPrvT )->cDtoEsp )
         aGet[ 30 ]:cText( ( dbfAlbPrvT )->nDtoEsp )

         aGet[ 31    ]:cText( ( dbfAlbPrvT )->cDpp )
         aGet[ 32    ]:cText( ( dbfAlbPrvT )->nDpp )

         aGet[ 39 ]:cText( ( dbfAlbPrvT )->cDtoUno )
         aGet[ 40 ]:cText( ( dbfAlbPrvT )->nDtoUno )

         aGet[ 41 ]:cText( ( dbfAlbPrvT )->cDtoDos )
         aGet[ 42 ]:cText( ( dbfAlbPrvT )->nDtoDos )

         aGet[ 56 ]:nOption( Max( ( dbfPrv )->nRegIva, 1 ) )
         aGet[ 56 ]:Refresh()

         aGet[ 20 ]:cText( ( dbfAlbPrvT )->cObserv )

         aGet[ 46 ]:cText( ( dbfAlbPrvT )->cSuAlb )





         AddLineasAlbaranProveedor( cAlbaran )





         oBrw:Refresh()





         SetFacturadoAlbaranProveedor( .T., , , dbfAlbPrvT, dbfAlbPrvL, dbfAlbPrvS )

      end

      aGet[ 26 ]:bWhen           := {|| .F. }





      if aScan( aNumAlb, cAlbaran ) == 0
         aAdd( aNumAlb, cAlbaran )
      end

   else

        MsgStop( "Albaran no encontrado." )

   end

   nTotFacPrv( nil, dbfFacPrvT, dbfTmp, dbfIva, dbfDiv, dbfFacPrvP, aTmp )

RETURN lValid



FUNCTION mkFacPrv( cPath, oMeter )

    IF oMeter <> NIL
        oMeter:cText    := "Generando Bases"
        sysrefresh()
    end

   CreateFiles( cPath )

    rxFacPrv( cPath, oMeter )

RETURN NIL



FUNCTION rxFacPrv( cPath, oMeter )

    local dbfFacPrvT
    local dbfFacPrvL

   IIF( cPath == nil, cPath := cPatEmp(), ) ;





   if !lExistTable( cPath + "FacPrvT.DBF" ) .OR.  !lExistTable( cPath + "FacPrvL.DBF" ) .OR.  !lExistTable( cPath + "FacPrvI.Dbf" ) .OR.  !lExistTable( cPath + "FacPrvD.Dbf" ) .OR.  !lExistTable( cPath + "FacPrvS.Dbf" )
      CreateFiles( cPath )
   end





   fEraseIndex( cPath + "FacPrvT.CDX" )
   fEraseIndex( cPath + "FacPrvL.CDX" )
   fEraseIndex( cPath + "FacPrvI.CDX" )
   fEraseIndex( cPath + "FacPrvD.CDX" )
   fEraseIndex( cPath + "FacPrvS.CDX" )

   dbUseArea( .T., cDriver(), cPath + "FACPRVT.DBF", cCheckArea( "FACPRVT", @dbfFacPrvT ), .F. )

   if !( dbfFacPrvT )->( neterr() )

      ( dbfFacPrvT )->( __dbPack() )

      ( dbfFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "NNUMFAC", "CSERFAC + STR( NNUMFAC ) + CSUFFAC", {|| Field->CSERFAC + STR( Field->NNUMFAC ) + Field->CSUFFAC } ) )

      ( dbfFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "DFECFAC", "DFECFAC", {|| Field->DFECFAC } ) )

      ( dbfFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "CCODPRV", "CCODPRV", {|| Field->CCODPRV } ) )

      ( dbfFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "CNOMPRV", "Upper( CNOMPRV )", {|| Upper( Field->CNOMPRV ) } ) )

      ( dbfFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "cSuPed", "Upper( cSuPed )", {|| Upper( Field->cSuPed ) } ) )

      ( dbfFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "cNumDoc", "Upper( cNumDoc )", {|| Upper( Field->cNumDoc ) } ) )

      ( dbfFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "cNfc", "Upper( cNfc )", {||  Upper( Field->cNfc ) } ) )

      ( dbfFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "CTURFAC", "CTURFAC + CSUFFAC + cCodCaj", {|| Field->CTURFAC + Field->CSUFFAC + Field->cCodCaj } ) )

      ( dbfFacPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT)->( ordCreate( cPath + "FacPrvT.Cdx", "cCodUsr", "Field->cCodUsr + Dtos( Field->dFecChg ) + Field->cTimChg", {|| Field->cCodUsr + Dtos( Field->dFecChg ) + Field->cTimChg } ) )

      ( dbfFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "cCodPago", "cCodPago", {|| Field->cCodPago } ) )

      ( dbfFacPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de proveedores" )
   end





   dbUseArea( .T., cDriver(), cPath + "FACPRVL.DBF", cCheckArea( "FACPRVL", @dbfFacPrvL ), .F. )
   if !( dbfFacPrvL )->( neterr() )
      ( dbfFacPrvL )->( __dbPack() )

      ( dbfFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvL )->( ordCreate( cPath + "FACPRVL.CDX", "NNUMFAC", "CSERFAC + STR( NNUMFAC ) + CSUFFAC", {|| Field->CSERFAC + STR( Field->NNUMFAC ) + Field->CSUFFAC } ) )

      ( dbfFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvL )->( ordCreate( cPath + "FACPRVL.CDX", "cRef", "cRef + cValPr1 + cValPr2", {|| Field->cRef + Field->cValPr1 + Field->cValPr2 }, ) )

      ( dbfFacPrvL )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfFacPrvL )->( ordCreate( cPath + "FacPrvL.Cdx", "cRefLote", "cRef + cValPr1 + cValPr2 + cLote", {|| Field->cRef + Field->cValPr1 + Field->cValPr2 + Field->cLote } ) )

      ( dbfFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvL )->( ordCreate( cPath + "FACPRVL.CDX", "Lote", "cLote", {|| Field->cLote }, ) )

      ( dbfFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvL )->( ordCreate( cPath + "FACPRVL.CDX", "cRefPrv", "cSerFac + Str( nNumFac ) + cSufFac + cRef + cRefPrv", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + Field->cRef + Field->cRefPrv } ) )

      ( dbfFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}, , , , , , , , , .T. ) )
      ( dbfFacPrvL )->( ordCreate( cPath + "FACPRVL.CDX", "cRefFec", "cRef + dTos( dFecFac )", {|| Field->cRef + dTos( Field->dFecFac ) } ) )

      ( dbfFacPrvL )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de proveedores" )
   end

   dbUseArea( .T., cDriver(), cPath + "FacPrvI.DBF", cCheckArea( "FacPrvI", @dbfFacPrvT ), .F. )
   if !( dbfFacPrvT )->( neterr() )
      ( dbfFacPrvT )->( __dbPack() )

      ( dbfFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FacPrvI.CDX", "nNumFac", "cSerie + Str( nNumFac ) + cSufFac", {|| Field->cSerie + STR( Field->nNumFac ) + Field->cSufFac } ) )

      ( dbfFacPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de proveedores" )
   end

   dbUseArea( .T., cDriver(), cPath + "FacPrvD.DBF", cCheckArea( "FacPrvD", @dbfFacPrvT ), .F. )
   if !( dbfFacPrvT )->( neterr() )
      ( dbfFacPrvT )->( __dbPack() )

      ( dbfFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FacPrvD.CDX", "nNumFac", "cSerFac + STR( nNumFac ) + cSufFac", {|| Field->cSerFac + STR( Field->nNumFac ) + Field->cSufFac } ) )

      ( dbfFacPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de proveedores" )
   end

   dbUseArea( .T., cDriver(), cPath + "FacPrvS.DBF", cCheckArea( "FacPrvS", @dbfFacPrvT ), .F. )
   if !( dbfFacPrvT )->( neterr() )
      ( dbfFacPrvT )->( __dbPack() )

      ( dbfFacPrvT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FacPrvS.CDX", "nNumFac", "cSerFac + Str( nNumFac ) + cSufFac + Str( nNumLin )", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nNumLin ) } ) )

      ( dbfFacPrvT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FacPrvS.CDX", "cRefSer", "cRef + cAlmLin + cNumSer", {|| Field->cRef + Field->cAlmLin + Field->cNumSer } ) )

      ( dbfFacPrvT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfFacPrvT )->( ordCreate( cPath + "FacPrvS.CDX", "cNumSer", "cNumSer", {|| Field->cNumSer } ) )

      ( dbfFacPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de numeros de series de Facaranes de proveedores" )
   end


RETURN NIL



STATIC FUNCTION BeginTrans( aTmp, nMode )

   local oError
   local oBlock
   local lErrors  := .F.
   local cDbf     := "FPrvL"
   local cDbfInc  := "FPrvI"
   local cDbfDoc  := "FPrvD"
   local cDbfPgo  := "FPrvP"
   local cDbfSer  := "FPrvS"
   local nFactura := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]

   oBlock         := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      CursorWait()

      aNumAlb     := {}

      cNewFile    := cGetNewFileName( cPatTmp() + cDbf )
      cTmpInc     := cGetNewFileName( cPatTmp() + cDbfInc )
      cTmpDoc     := cGetNewFileName( cPatTmp() + cDbfDoc )
      cTmpPgo     := cGetNewFileName( cPatTmp() + cDbfPgo )
      cTmpSer     := cGetNewFileName( cPatTmp() + cDbfSer )





      dbCreate( cNewFile, aSqlStruct( aColFacPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFile, cCheckArea( cDbf, @dbfTmp ), .F. )

      if !( dbfTmp )->( neterr() )
         ( dbfTmp )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmp )->( OrdCreate( cNewFile, "nNumLin", "Str( nNumLin, 4 )", {|| Str( Field->nNumLin ) } ) )

         ( dbfTmp )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmp )->( OrdCreate( cNewFile, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
      end





      if ( dbfFacPrvL )->( dbSeek( nFactura ) )
         while ( ( dbfFacPrvL )->CSERFAC + Str( ( dbfFacPrvL )->NNUMFAC ) + ( dbfFacPrvL )->CSUFFAC == nFactura .AND. !( dbfFacPrvL )->( eof() ) )
            dbPass( dbfFacPrvL, dbfTmp, .T. )
            ( dbfFacPrvL )->( dbSkip() )
         end
      end

      ( dbfTmp )->( dbGoTop() )





      dbCreate( cTmpInc, aSqlStruct( aIncFacPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpInc, cCheckArea( cDbfInc, @dbfTmpInc ), .F. )
      if !( dbfTmpInc )->( neterr() )
         ( dbfTmpInc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpInc )->( ordCreate( cTmpInc, "Recno", "Recno()", {|| Recno() } ) )
      end





      if ( dbfFacPrvI )->( dbSeek( nFactura ) )
         while ( ( dbfFacPrvI )->cSerie + Str( ( dbfFacPrvI )->nNumFac ) + ( dbfFacPrvI )->cSufFac == nFactura ) .AND. ( dbfFacPrvI )->( !eof() )
            dbPass( dbfFacPrvI, dbfTmpInc, .T. )
            ( dbfFacPrvI )->( dbSkip() )
         end
      end

      ( dbfTmpInc )->( dbGoTop() )





      dbCreate( cTmpDoc, aSqlStruct( aFacPrvDoc() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpDoc, cCheckArea( cDbfDoc, @dbfTmpDoc ), .F. )
      if !( dbfTmpDoc )->( neterr() )
         ( dbfTmpDoc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpDoc )->( ordCreate( cTmpDoc, "Recno", "Recno()", {|| Recno() } ) )
      end





      if ( dbfFacPrvD )->( dbSeek( nFactura ) )
         while ( ( dbfFacPrvD )->cSerFac + Str( ( dbfFacPrvD )->nNumFac ) + ( dbfFacPrvD )->cSufFac == nFactura ) .AND. ( dbfFacPrvD )->( !eof() )
            dbPass( dbfFacPrvD, dbfTmpDoc, .T. )
            ( dbfFacPrvD )->( dbSkip() )
         end
      end

      ( dbfTmpDoc )->( dbGoTop() )





      dbCreate( cTmpSer, aSqlStruct( aSerFacPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpSer, cCheckArea( cDbf, @dbfTmpSer ), .F. )

      if !( dbfTmpSer )->( neterr() )
         ( dbfTmpSer )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpSer )->( OrdCreate( cTmpSer, "nNumLin", "Str( nNumLin, 4 ) + cRef", {|| Str( Field->nNumLin, 4 ) + Field->cRef } ) )
      end





      if ( dbfFacPrvS )->( dbSeek( nFactura ) )
         while ( ( dbfFacPrvS )->cSerFac + Str( ( dbfFacPrvS )->nNumFac ) + ( dbfFacPrvS )->cSufFac == nFactura .AND. !( dbfFacPrvS )->( eof() ) )
            dbPass( dbfFacPrvS, dbfTmpSer, .T. )
            ( dbfFacPrvS )->( dbSkip() )
         end
      end

      ( dbfTmpSer )->( dbGoTop() )





      dbCreate( cTmpPgo, aSqlStruct( aItmRecPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpPgo, cCheckArea( cDbfPgo, @dbfTmpPgo ), .F. )
      if !( dbfTmpPgo )->( neterr() )

         ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
         ( dbfTmpPgo )->( ordCreate( cTmpPgo, "cRecDev", "cRecDev", {|| Field->cRecDev } ) )

         ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
         ( dbfTmpPgo )->( ordCreate( cTmpPgo, "nNumFac", "cSerFac + Str( nNumFac ) + cSufFac + Str( nNumRec )", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nNumRec ) }, ) )

         ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpPgo )->( ordCreate( cTmpPgo, "Recno", "Recno()", {|| Recno() } ) )

      end





      if ( dbfFacPrvP )->( dbSeek( nFactura ) ) .AND. nMode <> 4
         while ( ( dbfFacPrvP )->cSerFac + Str( ( dbfFacPrvP )->nNumFac ) + ( dbfFacPrvP )->cSufFac == nFactura ) .AND. ( dbfFacPrvP )->( !eof() )
            dbPass( dbfFacPrvP, dbfTmpPgo, .T. )
            ( dbfFacPrvP )->( dbSkip() )
         end
      end

      ( dbfTmpPgo )->( dbGoTop() )

      CursorWE()

   RECOVER USING oError

      msgStop( "Imposible crear tablas temporales." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      KillTrans()

      lErrors     := .T.

   end

   ErrorBlock( oBlock )

RETURN ( lErrors )



function aIncFacPrv()

   local aIncFacPrv  := {}

   aAdd( aIncFacPrv, { "cSerie",  "C",    1,  0, "Serie de factura" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "nNumFac", "N",    9,  0, "Número de factura" ,             "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "cSufFac", "C",    2,  0, "Sufijo de factura" ,             "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "cCodTip", "C",    3,  0, "Tipo de incidencia" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "dFecInc", "D",    8,  0, "Fecha de la incidencia" ,        "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "mDesInc", "M",   10,  0, "Descripción de la incidencia" ,  "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "lListo",  "L",    1,  0, "Lógico de listo" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "lAviso",  "L",    1,  0, "Lógico de aviso" ,               "",                   "", "( cDbfCol )" } )

return ( aIncFacPrv )



function aFacPrvDoc()

   local aFacPrvDoc  := {}

   aAdd( aFacPrvDoc, { "cSerFac", "C",    1,  0, "Serie de facturas" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "nNumFac", "N",    9,  0, "Número de facturas" ,              "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "cSufFac", "C",    2,  0, "Sufijo de facturas" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "cNombre", "C",  250,  0, "Nombre del documento" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "cRuta",   "C",  250,  0, "Ruta del documento" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "mObsDoc", "M",   10,  0, "Observaciones del documento" ,     "",                   "", "( cDbfCol )" } )

return ( aFacPrvDoc )



STATIC FUNCTION EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDec, oDlg )

   local aTbl
   local nItem
   local nNumLin
   local cSerFac
   local nNumNFC
   local nNumFac
   local cSufFac
   local dFecFac
   local oError
   local oBlock

   if Empty( aTmp[ 1 ] )
      aTmp[ 1 ]  := "A"
   end

   nNumLin              := 1
   cSerFac              := aTmp[ 1 ]
   nNumFac              := aTmp[ 2 ]
   cSufFac              := aTmp[ 3 ]
   dFecFac              := aTmp[ 5 ]





   if !lValidaOperacion( aTmp[ 5 ] )
      Return .F.
   end





   if Empty( aTmp[ 6 ] )
      msgStop( "Proveedor no puede estar vacío." )
      aGet[ 6 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 7 ] )
      msgStop( "Almacen no puede estar vacío." )
      aGet[ 7 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 8 ] )
      msgStop( "Caja no puede estar vacía." )
      aGet[ 8 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 23 ] )
      msgStop( "Forma de pago no puede estar vacía." )
      aGet[ 23 ]:SetFocus()
      return .F.
   end

   if !aTmp[ 57 ] .AND. ( dbfTmp )->( lastrec() ) == 0
      MsgStop( "No puede almacenar un documento sin líneas." )
      return .F.
   end





   CursorWait()

   oDlg:Disable()

   oMsgText( "Archivando" )

   oBlock      := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   BeginTransaction()





   aTmp[ 53 ]  := GetSysDate()
   aTmp[ 54 ]  := Time()





   do case
   case nMode == 1 .OR. nMode == 4





      nNumFac           := nNewDoc( cSerFac, dbfFacPrvT, "NFACPRV", , dbfCount )
      aTmp[ 2 ]  := nNumFac

      nNumNFC           := nNewNFC( cSerFac, dbfFacPrvT, "NFACPRV", dbfCount )
      aTmp[ 72    ]  := nNumNFC

      aTmp[ 28 ]  := !Empty( aNumAlb ) .OR. !Empty( aTmp[ 26 ] )

   case nMode == 2





      while ( dbfFacPrvL )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) .AND. !( dbfFacPrvL )->( eof() ) )
         if dbLock( dbfFacPrvL )
            ( dbfFacPrvL )->( dbDelete() )
            ( dbfFacPrvL )->( dbUnLock() )
         end
      end

      while ( dbfFacPrvI )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) .AND. !( dbfFacPrvI )->( eof() ) )
         if dbLock( dbfFacPrvI )
            ( dbfFacPrvI )->( dbDelete() )
            ( dbfFacPrvI )->( dbUnLock() )
         end
      end

      while ( dbfFacPrvD )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) .AND. !( dbfFacPrvD )->( eof() ) )
         if dbLock( dbfFacPrvD )
            ( dbfFacPrvD )->( dbDelete() )
            ( dbfFacPrvD )->( dbUnLock() )
         end
      end

      while ( dbfFacPrvP )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) .AND. !( dbfFacPrvP )->( eof() ) )
         if dbLock( dbfFacPrvP )
            ( dbfFacPrvP )->( dbDelete() )
            ( dbfFacPrvP )->( dbUnLock() )
         end
      end

      while ( dbfFacPrvS )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) )
         if dbLock( dbfFacPrvS )
            ( dbfFacPrvS )->( dbDelete() )
            ( dbfFacPrvS )->( dbUnLock() )
         end
      end

   end





   ( dbfTmp )->( dbClearFilter() )

   oMsgProgress()
   oMsgProgress():SetRange( 0, ( dbfTmp )->( LastRec() ) )





   ( dbfTmp )->( dbGoTop() )
   while !( dbfTmp )->( eof() )

      aTbl                                               := dbScatter( dbfTmp )
      aTbl[ 1 ]                                   := cSerFac
      aTbl[ 2 ]                                   := nNumFac
      aTbl[ 3 ]                                   := cSufFac
      aTbl[ 14 ]                                   := .F.
      aTbl[ 19 ]                                   := nNetUFacPrv( aTbl, aTmp, nDinDiv, nRinDiv )
      aTbl[ ( dbfFacPrvL )->( FieldPos( "dFecFac" ) ) ]  := aTmp[ 5 ]





      AppRefPrv(  aTbl[ 5 ], aTmp[ 6 ], aTbl[ 4 ], aTbl[ 16 ], aTbl[ 17 ], aTmp[ 36 ], aTbl[ 7 ], dbfArtPrv )





      if ( dbfArticulo )->( dbSeek( ( dbfTmp )->cRef ) ) .AND. ( dbfTmp )->lChgLin
         CambioPrecio( aTmp[ 5 ], dbfArticulo, dbfTmp )
      end

      dbGather( aTbl, dbfFacPrvL, .T. )

      ( dbfTmp )->( dbSkip() )

      oMsgProgress():Deltapos(1)

   end





   ( dbfTmpInc )->( dbGoTop() )
   while ( dbfTmpInc )->( !eof() )
      dbPass( dbfTmpInc, dbfFacPrvI, .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpInc )->( dbSkip() )
   end





   ( dbfTmpDoc )->( dbGoTop() )
   while ( dbfTmpDoc )->( !eof() )
      dbPass( dbfTmpDoc, dbfFacPrvD, .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpDoc )->( dbSkip() )
   end





   ( dbfTmpSer )->( dbGoTop() )
   while ( dbfTmpSer )->( !eof() )
      dbPass( dbfTmpSer, dbfFacPrvS, .T., cSerFac, nNumFac, cSufFac, dFecFac )
      ( dbfTmpSer )->( dbSkip() )
   end





   ( dbfTmpPgo )->( dbGoTop() )

   while ( dbfTmpPgo )->( !eof() )

      if ( dbfTmpPgo )->cCodPrv <> aTmp[ 6 ]
         ( dbfTmpPgo )->cCodPrv := aTmp[ 6 ]
      end

      if ( dbfTmpPgo )->cNomPrv <> aTmp[ 9 ]
         ( dbfTmpPgo )->cNomPrv := aTmp[ 9 ]
      end

      ( dbfTmpPgo )->( dbSkip() )

   end





   ( dbfTmpPgo )->( dbGoTop() )
   while ( dbfTmpPgo )->( !eof() )
      dbPass( dbfTmpPgo, dbfFacPrvP, .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpPgo )->( dbSkip() )
   end





   aTmp[ 68 ]  := nTotNet
   aTmp[ 74 ]  := nTotSup
   aTmp[ 69 ]  := nTotIva
   aTmp[ 70 ]  := nTotReq
   aTmp[ 71 ]  := nTotFac





   WinGather( aTmp, , dbfFacPrvT, , nMode )





   GenPgoFacPrv( cSerFac + Str( nNumFac ) + cSufFac, dbfFacPrvT, dbfFacPrvL, dbfFacPrvP, dbfPrv, dbfFPago, dbfDiv )

   if nMode == 1

      if Len( aNumAlb ) > 0

         for nItem := 1 to Len( aNumAlb )

            if ( dbfAlbPrvT )->( dbSeek( aNumAlb[ nItem ] ) )





               SetFacturadoAlbaranProveedor( .T., , , dbfAlbPrvT, dbfAlbPrvL, dbfAlbPrvS, cSerFac + Str( nNumFac ) + cSufFac )







            end

         next

      end

   end





   dbCommitAll()

   CommitTransaction()

   RECOVER USING oError

      RollBackTransaction()
      msgStop( "Imposible almacenar documentos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end
   ErrorBlock( oBlock )

   oMsgText()
   EndProgress()

   oDlg:Enable()
   oDlg:End( 1 )

   CursorWE()

RETURN .T.



STATIC FUNCTION KillTrans( oBrwLin )





   if !Empty( dbfTmp ) .AND. ( dbfTmp )->( Used() )
      ( dbfTmp )->( dbCloseArea() )
   end

   if !Empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )
      ( dbfTmpInc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpDoc ) .AND. ( dbfTmpDoc )->( Used() )
      ( dbfTmpDoc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpPgo ) .AND. ( dbfTmpPgo )->( Used() )
      ( dbfTmpPgo )->( dbCloseArea() )
   end

   if !Empty( dbfTmpSer ) .AND. ( dbfTmpSer )->( Used() )
      ( dbfTmpSer )->( dbCloseArea() )
   end

   dbfTmp            := nil
   dbfTmpInc         := nil
   dbfTmpDoc         := nil
   dbfTmpPgo         := nil
   dbfTmpSer         := nil

   dbfErase( cNewFile )
   dbfErase( cTmpInc  )
   dbfErase( cTmpDoc  )
   dbfErase( cTmpPgo  )
   dbfErase( cTmpSer  )

   aNumAlb           := {}

   if !Empty( oMnuRec )
      oMnuRec:End()
   end

   memory( -1 )

   if oBrwLin <> nil
      oBrwLin:CloseData()
   end

RETURN NIL



STATIC FUNCTION CreateFiles( cPath )

   if !lExistTable( cPath + "FACPRVT.DBF" )
      dbCreate( cPath + "FACPRVT.DBF", aSqlStruct( aItmFacPrv() ), cDriver() )
   end
   if !lExistTable( cPath + "FACPRVL.DBF" )
      dbCreate( cPath + "FACPRVL.DBF", aSqlStruct( aColFacPrv() ), cDriver() )
   end
   if !lExistTable( cPath + "FACPRVI.DBF" )
      dbCreate( cPath + "FACPRVI.DBF", aSqlStruct( aIncFacPrv() ), cDriver() )
   end
   if !lExistTable( cPath + "FACPRVD.DBF" )
      dbCreate( cPath + "FACPRVD.DBF", aSqlStruct( aFacPrvDoc() ), cDriver() )
   end
   if !lExistTable( cPath + "FACPRVS.DBF" )
      dbCreate( cPath + "FACPRVS.DBF", aSqlStruct( aSerFacPrv() ), cDriver() )
   end

RETURN NIL







FUNCTION dFecFacPrv( cFacPrv, dbfFacPrvT )

    local dFecFac    := Ctod("")

    IF (dbfFacPrvT)->( dbSeek( cFacPrv ) )
        dFecFac    := (dbfFacPrvT)->DFECFAC
    end

RETURN ( dFecFac )






FUNCTION cPrvFacPrv( cFacPrv, dbfFacPrvT )

    local cCodPrv    := ""

    IF (dbfFacPrvT)->( dbSeek( cFacPrv ) )
        cCodPrv    := (dbfFacPrvT)->CCODPRV
    end

RETURN ( cCodPrv )






FUNCTION cNbrFacPrv( cFacPrv, dbfFacPrvT )

    local cNomPrv    := ""

    IF (dbfFacPrvT)->( dbSeek( cFacPrv ) )
        cNomPrv    := (dbfFacPrvT)->CNOMPRV
    end

RETURN ( cNomPrv )



FUNCTION nEstFacPrv( cFacPrv, dbfFacPrvT, dbfFacPrvP )

   local nBitmap  := 3

   if ( dbfFacPrvT )->( dbSeek( cFacPrv ) )
      nBitmap     := ChkPagFacPrv( dbfFacPrvT, dbfFacPrvP )
   end

RETURN nBitmap






STATIC FUNCTION ChgContabilizado( lContabilizado, cFactura, nAsiento, oTree )

   local lReturn  := .T.

   if dbDialogLock( dbfFacPrvT )
      ( dbfFacPrvT )->lContab := lContabilizado
      ( dbfFacPrvT )->( dbUnlock() )
   else
      lReturn     := .F.
   end

   if !Empty( oTree )
      oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " asiento generado num. " + Alltrim( Str( nAsiento ) ), 1 ) )
   end

Return ( lReturn )



STATIC FUNCTION ImpFactura( oBrw, aGet, aTmp )

    local oDlg
    local oBrwFac
    local oGetDes
    local cGetDes
    local cSelFac    := ""
    local aLinFac    := {}

    local nChgDiv    := aTmp[ 37 ]

    IF Empty( aGet[ 6 ]:varGet() )
        msgStop( "Es necesario codificar un proveedor" )
        RETURN .T.
    end

    oDlg = TDialog():New(,,,,, "IMPFACPRV",, .F.,,,,,, .F.,,,,,, .F., )







        oGetDes := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cGetDes, cGetDes:= u ) }, oDlg,,, {||        ( loadFac( cGetDes, oBrwFac, @aLinFac ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( oGetDes:cText( cGetFile( "*.dat", "Seleccione el fichero de la factura" ) ) )}, nil, "LUPA",, )





        oBrwFac := TListBox():ReDefine( 120, { | u | If( PCount()==0, cSelFac, cSelFac:= u ) }, {},, oDlg,,,,,,,,, .F.,, )





        TButton():ReDefine( 1, {||(  appdFac( aGet, cSelFac, oBrwFac:aItems, aLinFac, nChgDiv ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

        oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN NIL







STATIC FUNCTION loadFac( cGetDes, oBrwFac, aLinFac )

    local    a1
    local a2
   local cIni
    local cSep
    local oText
    local nCont        := 0

    IF empty( cGetDes )
        RETURN .T.
    end

    CursorWait()

    IF    file( cGetDes )

        oText             := TTxtFile():New( cGetDes )
        oText:Open()





        aLinFac            := {}
        oBrwFac:reset()





        WHILE !oText:lEof()

            a1    := oText:cGetStr( 6 )
                    oText:cGetStr( 1 )
            a2    := oText:cGetStr( 6 )
                    oText:cGetStr( 1 )

            ++nCont
            aadd( aLinFac, {} )

            oBrwFac:Add( a1 + space( 1 ) + substr( a2, 1, 2 ) + "/" + substr( a2, 3, 2 ) + "/" + substr( a2, 5, 2 ) )

            WHILE !oText:lEof()





                cIni    := oText:cGetStr( 1 )

                IF cIni == chr( 255 )
                    EXIT
                end











                aadd( aLinFac[ nCont ], {  cIni + oText:cGetStr( 5 ), oText:cGetStr( 13 ),    oText:cGetStr( 30 ),    oText:cGetStr(  7 ),    oText:cGetStr(  7 ), oText:cGetStr(  1 ) } )





                cSep    := oText:cGetStr( 1 )

                IF cSep == chr( 254 )
                    LOOP
                end

            end

        end

      oText:Close()

    ELSE

        msgAlert( "Fichero no encontrado" )

    end

    oBrwFac:setFocus()

    CursorWe()

RETURN .T.







STATIC FUNCTION appdFac( aGet, cSelFac, aSelFac, aLinFac, nChgDiv )

   local n
    local nIva
   local nSelFac

   nSelFac     := AScan( aSelFac, { | cItem | Upper( AllTrim( cItem ) ) == Upper( AllTrim( cSelFac ) ) } )
   if nSelFac  <> 0

      aGet[ 18 ]:cText( substr( cSelFac, 1, 6 ) )

        FOR n := 1 TO len( aLinFac[ nSelFac ] )

            (dbfTmp)->( dbAppend() )

            (dbfTmp)->CREF            := aLinFac[ nSelFac, n, 1 ]
            (dbfTmp)->CDETALLE     := aLinFac[ nSelFac, n, 3 ]
            (dbfTmp)->NUNICAJA    := val( aLinFac[ nSelFac, n, 4 ] ) / 100
            (dbfTmp)->NPREUNIT     := val( aLinFac[ nSelFac, n, 5 ] ) / 100





            DO CASE
            CASE aLinFac[ nSelFac, n, 6 ] == "1"
                nIva    := 7
            CASE aLinFac[ nSelFac, n, 6 ] == "2"
                nIva    := 16
            CASE aLinFac[ nSelFac, n, 6 ] == "3"
                nIva    := 4
            end

            (dbfTmp)->NIVA            := nIva





            IF ( dbfArticulo )->( DbSeek( ( dbfTmp )->CREF ) )





                IF (dbfTmp)->NPREUNIT <> ( dbfArticulo )->PCOSTO / nChgDiv
                    (dbfTmp)->LCHGLIN    := .T.
                end





            (dbfTmp)->NBNFLIN1   := ( dbfArticulo )->BENEF1
            (dbfTmp)->NBNFLIN2   := ( dbfArticulo )->BENEF2
            (dbfTmp)->NBNFLIN3   := ( dbfArticulo )->BENEF3
            (dbfTmp)->NBNFLIN4   := ( dbfArticulo )->BENEF4
            (dbfTmp)->NBNFLIN5   := ( dbfArticulo )->BENEF5
            (dbfTmp)->NBNFLIN6   := ( dbfArticulo )->BENEF6






            (dbfTmp)->NPVPLIN1   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN1 / 100 + ( dbfTmp )->NPREUNIT
                IF ( dbfArticulo )->LIVAINC
               (dbfTmp)->NPVPLIN1 += (dbfTmp)->NPVPLIN1 * nIva / 100
                end

            (dbfTmp)->NPVPLIN2   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN2 / 100 + ( dbfTmp )->NPREUNIT
                IF ( dbfArticulo )->LIVAINC
               (dbfTmp)->NPVPLIN2 += (dbfTmp)->NPVPLIN2 * nIva / 100
            end

            (dbfTmp)->NPVPLIN3   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN3 / 100 + ( dbfTmp )->NPREUNIT
                IF ( dbfArticulo )->LIVAINC
               (dbfTmp)->NPVPLIN3 += (dbfTmp)->NPVPLIN3 * nIva / 100
                end

            (dbfTmp)->NPVPLIN4   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN4 / 100 + ( dbfTmp )->NPREUNIT
                IF ( dbfArticulo )->LIVAINC
               (dbfTmp)->NPVPLIN4 += (dbfTmp)->NPVPLIN4 * nIva / 100
                end

            (dbfTmp)->NPVPLIN5   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN5 / 100 + ( dbfTmp )->NPREUNIT
                IF ( dbfArticulo )->LIVAINC
               (dbfTmp)->NPVPLIN5 += (dbfTmp)->NPVPLIN5 * nIva / 100
                end

            (dbfTmp)->NPVPLIN6   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN6 / 100 + ( dbfTmp )->NPREUNIT
                IF ( dbfArticulo )->LIVAINC
               (dbfTmp)->NPVPLIN6 += (dbfTmp)->NPVPLIN6 * nIva / 100
                end

            ELSE

                (dbfTmp)->LCHGLIN        := .T.

            end

        NEXT

        (dbfTmp)->( dbGoTop() )

    end

RETURN NIL






FUNCTION GenPgoFacPrv( cNumFac, dbfFacPrvT, dbfFacPrvL, dbfFacPrvP, dbfPrv, dbfFPago, dbfDiv, aTmp )

   local nCobro
   local cCodPgo
   local cSerFac
   local nNumFac
   local cSufFac
   local cDivFac
   local nVdvFac
   local dFecFac
   local cCodPrv
   local cNomPrv
   local cCodUsr
   local cCodCaj
   local nTotal
   local nTotCob
   local nDec
   local nInc        := 0
   local n           := 0
   local nTotAcu     := 0
   local nPlazos     := 0
   local cBanco
   local cEntidad
   local cSucursal
   local cControl
   local cCuenta

   if aTmp <> nil
      cSerFac        := aTmp[ 1 ]
      nNumFac        := aTmp[ 2 ]
      cSufFac        := aTmp[ 3 ]
      cDivFac        := aTmp[ 36 ]
      nVdvFac        := aTmp[ 37 ]
      dFecFac        := aTmp[ 5 ]
      cCodPgo        := aTmp[ 23]
      cCodPrv        := aTmp[ 6 ]
      cNomPrv        := aTmp[ 9 ]
      cCodUsr        := aTmp[ 47 ]
      cCodCaj        := aTmp[ 8 ]
      cEntidad       := aTmp[ 76 ]
      cSucursal      := aTmp[ 77 ]
      cControl       := aTmp[ 78 ]
      cCuenta        := aTmp[ 79 ]
      cBanco         := aTmp[ 75 ]
   else
      cSerFac        := ( dbfFacPrvT )->cSerFac
      nNumFac        := ( dbfFacPrvT )->nNumFac
      cSufFac        := ( dbfFacPrvT )->cSufFac
      cDivFac        := ( dbfFacPrvT )->cDivFac
      nVdvFac        := ( dbfFacPrvT )->nVdvFac
      dFecFac        := ( dbfFacPrvT )->dFecFac
      cCodPgo        := ( dbfFacPrvT )->cCodPago
      cCodPrv        := ( dbfFacPrvT )->cCodPrv
      cNomPrv        := ( dbfFacPrvT )->cNomPrv
      cCodUsr        := ( dbfFacPrvT )->cCodUsr
      cCodCaj        := ( dbfFacPrvT )->cCodCaj
      cEntidad       := ( dbfFacPrvT )->cEntBnc
      cSucursal      := ( dbfFacPrvT )->cSucBnc
      cControl       := ( dbfFacPrvT )->cDigBnc
      cCuenta        := ( dbfFacPrvT )->cCtaBnc
      cBanco         := ( dbfFacPrvT )->cBanco
   end





   nTotal            := nTotFacPrv( cNumFac, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, dbfFacPrvP, nil, nil, .F. )
   nTotCob           := nPagFacPrv( cNumFac, dbfFacPrvP, nil, dbfDiv, .F. )
   nDec              := nRouDiv( cDivFac, dbfDiv )

   if nTotal <> nTotCob





      if ( dbfFacPrvP )->( dbSeek( cNumFac ) )
         while cNumFac == ( dbfFacPrvP )->cSerFac + Str( ( dbfFacPrvP )->nNumFac ) + ( dbfFacPrvP )->cSufFac .AND. !( dbfFacPrvP )->( eof() )
            if !( dbfFacPrvP )->lCobrado .AND. dbLock( dbfFacPrvP )
               ( dbfFacPrvP )->( dbDelete() )
               ( dbfFacPrvP )->( dbUnLock() )
            else
               nInc  := ( dbfFacPrvP )->nNumRec
            end
            ( dbfFacPrvP )->( dbSkip() )
         end
      end

      nTotal            -= nPagFacPrv( cNumFac, dbfFacPrvP, nil, dbfDiv, .F. )





      if ( dbfFPago )->( dbSeek( cCodPgo ) )

         nTotAcu        := nTotal
         nPlazos        := Max( ( dbfFPago )->nPlazos, 1 )

         for n := 1 to nPlazos

            if n <> nPlazos
               nTotAcu  -= Round( nTotal / nPlazos, nDec )
            end

            ( dbfFacPrvP)->( dbAppend() )

            ( dbfFacPrvP )->cSerFac    := cSerFac
            ( dbfFacPrvP )->nNumFac    := nNumFac
            ( dbfFacPrvP )->cSufFac    := cSufFac
            ( dbfFacPrvP )->cCodPrv    := cCodPrv
            ( dbfFacPrvP )->cNomPrv    := cNomPrv
            ( dbfFacPrvP )->nNumRec    := ++nInc
            ( dbfFacPrvP )->nImporte   := if( n <> nPlazos, Round( nTotal / nPlazos, nDec ), Round( nTotAcu, nDec ) )
            ( dbfFacPrvP )->cTurRec    := cCurSesion()
            ( dbfFacPrvP )->cDescrip   := "Recibo nº" + AllTrim( Str( ( dbfFacPrvP )->nNumRec ) ) + " de factura " + cSerFac  + "/" + allTrim( Str( nNumFac ) ) + "/" + cSufFac
            ( dbfFacPrvP )->cDivPgo    := cDivFac
            ( dbfFacPrvP )->nVdvPgo    := nVdvFac
            ( dbfFacPrvP )->lCobRado   := ( ( dbfFPago )->nCobRec == 1 )
            ( dbfFacPrvP )->dPreCob    := dFecFac
            ( dbfFacPrvP )->dFecVto    := dNexDay( dFecFac + ( dbfFPago )->nPlaUno + ( ( dbfFPago )->nDiaPla * ( n - 1 ) ), dbfPrv )
            ( dbfFacPrvP )->cCtaRec    := ( dbfFPago )->cCtaCobro
            ( dbfFacPrvP )->dFecChg    := GetSysDate()
            ( dbfFacPrvP )->cTimChg    := Time()
            ( dbfFacPrvP )->cCodPgo    := cCodPgo
            ( dbfFacPrvP )->lNotArqueo := .F.
            ( dbfFacPrvP )->cCodCaj    := cCodCaj
            ( dbfFacPrvP )->cCodUsr    := cCodUsr

            if ( dbfFPago )->lUtlBnc
               ( dbfFacPrvP )->cBncEmp := ( dbfFPago )->cBanco
               ( dbfFacPrvP )->cEntEmp := ( dbfFPago )->cEntBnc
               ( dbfFacPrvP )->cSucEmp := ( dbfFPago )->cSucBnc
               ( dbfFacPrvP )->cDigEmp := ( dbfFPago )->cDigBnc
               ( dbfFacPrvP )->cCtaEmp := ( dbfFPago )->cCtaBnc
            end

            ( dbfFacPrvP )->cBncPrv    := cBanco
            ( dbfFacPrvP )->cEntPrv    := cEntidad
            ( dbfFacPrvP )->cSucPrv    := cSucursal
            ( dbfFacPrvP )->cDigPrv    := cControl
            ( dbfFacPrvP )->cCtaPrv    := cCuenta

            if ( dbfFPago )->nCobRec == 1
               ( dbfFacPrvP )->dEntrada:= dNexDay( dFecFac + ( dbfFPago )->nPlaUno + ( ( dbfFPago )->nDiaPla * ( n - 1 ) ), dbfPrv )
            end

            ( dbfFacPrvP )->( dbUnLock() )

         next

      end

   end

RETURN NIL






function nTotVFacPrv( cCodArt, dbfFacPrvL, nDinDiv, nDirDiv )

   local nTotVta  := 0
   local nRecno   := ( dbfFacPrvL )->( Recno() )

   if ( dbfFacPrvL )->( dbSeek( cCodArt ) )

      while ( dbfFacPrvL )->CREF == cCodArt .AND. !( dbfFacPrvL )->( eof() )

         nTotVta  += nTotLFacPrv( dbfFacPrvL, nDinDiv, nDirDiv )
         ( dbfFacPrvL )->( dbSkip() )

      end

   end

   ( dbfFacPrvL )->( dbGoTo( nRecno ) )

return ( nTotVta )






function nTotDFacPrv( cCodArt, dbfFacPrvL, cCodAlm )

   local nTotVta  := 0
   local nRecno   := ( dbfFacPrvL )->( Recno() )

   if ( dbfFacPrvL )->( dbSeek( cCodArt ) )

      while ( dbfFacPrvL )->CREF == cCodArt .AND. !( dbfFacPrvL )->( eof() )

         if cCodAlm <> nil
            if cCodAlm == ( dbfFacPrvL )->cAlmLin
               nTotVta  += nTotNFacPrv( dbfFacPrvL )
            end
         else
            nTotVta     += nTotNFacPrv( dbfFacPrvL )
         end

         ( dbfFacPrvL )->( dbSkip() )

      end

   end

   ( dbfFacPrvL )->( dbGoTo( nRecno ) )

return ( nTotVta )



static function lNotOpen()

   if NetErr()
      msgAlert( "Imposible abrir ficheros." )
      CloseFiles()
      return .T.
   end

return .F.






FUNCTION lConFacPrv( cFacPrv, dbfFacPrvT )

   local lConFac  := .F.

   if dbSeekInOrd( cFacPrv, "nNumFac", dbfFacPrvT )
      lConFac     := ( dbfFacPrvT )->lContab
   end

RETURN ( lConFac )







FUNCTION dPrvFacPrv( cFacPrv, dbfFacPrvT )

   local cCodPrv  := ""

   if dbSeekInOrd( cFacPrv, "nNumFac", dbfFacPrvT )
      cCodPrv     := (dbfFacPrvT)->cCodPrv
    end

RETURN ( cCodPrv )







FUNCTION cPgoFacPrv( cFacPrv, dbfFacPrvT )

   local cCodPgo  := ""

   if dbSeekInOrd( cFacPrv, "nNumFac", dbfFacPrvT )
      cCodPgo     := ( dbfFacPrvT )->cCodPago
   end

RETURN ( cCodPgo )



FUNCTION cNomFacPrv( cFacPrv, dbfFacPrvT )

   local cNomPrv := ""

   if dbSeekInOrd( cFacPrv, "nNumFac", dbfFacPrvT )
      cNomPrv  := ( dbfFacPrvT )->cNomPrv
    end

RETURN ( cNomPrv )



FUNCTION cCodFacPrv( cFacPrv, uFacPrvT )

   local cCodPrv := ""

   if ValType( uFacPrvT ) == "O"

      if uFacPrvT:SeekInOrd( cFacPrv, "nNumFac" )
         cCodPrv  := uFacPrvT:cCodPrv
      end

   else

      if dbSeekInOrd( cFacPrv, "nNumFac", dbfFacPrvT )
         cCodPrv  := ( uFacPrvT )->cCodPrv
      end

   end

RETURN ( cCodPrv )






static function lRecibosPagados( uFacPrv, dbfFacPrvP )

   local cNumFac
   local lRecPgd  := .F.
   local nRecAct  := ( dbfFacPrvP )->( Recno() )
   local nOrdAct  := ( dbfFacPrvP )->( OrdSetFocus( "NNUMFAC" ) )

   if ValType( uFacPrv ) == "A"
      cNumFac     := uFacPrv[ 1 ] + Str( uFacPrv[ 2 ], 9 ) + uFacPrv[ 3 ]
   else
      cNumFac     := ( uFacPrv )->CSERFAC + Str( ( uFacPrv )->NNUMFAC ) + ( uFacPrv )->CSUFFAC
   end

   if ( dbfFacPrvP )->( dbSeek( cNumFac ) )
      while cNumFac == ( dbfFacPrvP )->cSerFac + Str( ( dbfFacPrvP )->nNumFac ) + ( dbfFacPrvP )->cSufFac .AND. !( dbfFacPrvP )->( eof() )
         if ( dbfFacPrvP )->lCobrado .AND. !( dbfFacPrvP )->lDevuelto
            lRecPgd   := .T.
            exit
         end
         ( dbfFacPrvP )->( dbSkip() )
      end
   end

   ( dbfFacPrvP )->( OrdSetFocus( nOrdAct ) )
   ( dbfFacPrvP )->( dbGoTo( nRecAct) )

return ( lRecPgd )



function dFecVtoPrv( nVto )

   local dVto     := Ctod( "  /  /  " )

   IIF( nVto == nil, nVto := 1, ) ;

   if nVto <= len( aDatVcto )
      dVto        := aDatVcto[ nVto ]
   end

return ( dVto )



function nImpVtoPrv( nVto )

   local nImp     := 0

   IIF( nVto == nil, nVto := 1, ) ;

   if nVto <= len( aImpVcto )
      nImp        := aImpVcto[ nVto ]
   end

return ( nImp )



static function lGenFac( oBrw, oBtn, nDevice )

   local bAction

   IIF( nDevice == nil, nDevice := 1, ) ;

   if Empty( oBtn )
      return nil
   end

   IF !( dbfDoc )->( dbSeek( "FP" ) )








         oWndBrw:NewAt( "DOCUMENT",,, {||( msgStop( "No hay facturas de proveedores predefinidos" ) )}, "No hay documentos", "N",,, 4, oBtn, .F. )

   ELSE

      WHILE ( dbfDoc )->cTipo == "FP" .AND. !( dbfDoc )->( eof() )

         bAction  := bGenFac( nDevice, "Imprimiendo facturas de proveedores", ( dbfDoc )->Codigo )

         oWndBrw:NewAt( "Document", , , bAction, Rtrim( ( dbfDoc )->cDescrip ) , , , , , oBtn )

         ( dbfDoc )->( dbSkip() )

      end

   end

   SysRefresh()

return nil



static function bGenFac( nDevice, cTitle, cCodDoc )

   local bGen
   local nDev  := by( nDevice )
   local cTit  := by( cTitle  )
   local cCod  := by( cCodDoc )

   if nDev == 1
      bGen     := {|| nGenFacPrv( nDevice, cTit, cCod ) }
   else
      bGen     := {|| nGenFacPrv( nDevice, cTit, cCod ) }
   end

return bGen






FUNCTION nNetLFacPrv( uFacPrvL, uFacPrvT, nDec, nRec, nVdv, cPirDiv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nRec == nil, nRec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nNetUFacPrv( uFacPrvL, nDec, nRec, nVdv )

   nCalculo       *= nTotNFacPrv( uFacPrvL )





   if ValType( uFacPrvL ) == "A"

      if uFacPrvL[ 8 ]<> 0
         nCalculo    -= nCalculo * uFacPrvL[ 8 ] / 100
      end

   else

      if ( uFacPrvL )->nDto <> 0
         nCalculo    -= nCalculo * ( uFacPrvL )->nDto / 100
      end

   end

   nCalculo          := Round( nCalculo, nRec )

RETURN ( if( cPirDiv <> NIL, Trans( nCalculo, cPirDiv ), nCalculo ) )



FUNCTION cProFacPrv( cFacPro, dbfFacPrvT )

   local cCodPro := ""

   if dbSeekInOrd( cFacPro, "nNumFac", dbfFacPrvT )
      cCodPro  := ( dbfFacPrvT )->cCodPro
   end

RETURN ( cCodPro )



FUNCTION nTotNFacPrv( uDbf )

   local nTotUnd

   IIF( uDbf == nil, uDbf := dbfFacPrvL, ) ;

   do case
      case ValType( uDbf ) == "A"
         nTotUnd  := uDbf[ 13 ]
         nTotUnd  *= NotCaja( uDbf[ 10 ] )
         nTotUnd  *= NotCero( uDbf[ 63 ] )
         nTotUnd  *= NotCero( uDbf[ 84 ] )
         nTotUnd  *= NotCero( uDbf[ 85 ] )
         nTotUnd  *= NotCero( uDbf[ 86 ] )

      case ValType( uDbf ) == "O"
         nTotUnd  := uDbf:nUniCaja
         nTotUnd  *= NotCaja( uDbf:nCanEnt )
         nTotUnd  *= NotCero( uDbf:nUndKit )
         nTotUnd  *= NotCero( uDbf:nMedUno )
         nTotUnd  *= NotCero( uDbf:nMedDos )
         nTotUnd  *= NotCero( uDbf:nMedTre )

      otherwise
         nTotUnd  := ( uDbf )->nUniCaja
         nTotUnd  *= NotCaja( ( uDbf )->nCanEnt )
         nTotUnd  *= NotCero( ( uDbf )->nUndKit )
         nTotUnd  *= NotCero( ( uDbf )->nMedUno )
         nTotUnd  *= NotCero( ( uDbf )->nMedDos )
         nTotUnd  *= NotCero( ( uDbf )->nMedTre )

   end

RETURN ( nTotUnd )



FUNCTION nBrtLFacPrv( uTmpLin, nDec, nRec, nVdv, cPorDiv )

   local nCalculo := 0

   IIF( nDec == nil, nDec := 2, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacPrv( uTmpLin, nDec, nVdv, cPorDiv )
   nCalculo       *= nTotNFacPrv( uTmpLin )

   nCalculo       := Round( nCalculo / nVdv, nRec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nIvaUFacPrv( dbfTmp, nDec, nVdv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacPrv( dbfTmp, nDec, nVdv )

   if !( dbfTmp )->lIvaLin
      nCalculo    += nCalculo * ( dbfTmp )->nIva / 100
   end

   if nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nIvaLFacPrv( dbfFac, dbfLin, nDec, nRou, nVdv, lDto, lPntVer, cPorDiv )

   local nCalculo := nImpLFacPrv( dbfFac, dbfLin, nDec, nRou, nVdv )

   nCalculo       := Round( nCalculo * ( dbfLin )->nIva / 100, nRou )

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )







FUNCTION aTotFacPrv( cFactura, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, dbfFacPrvP, cDivRet )

   nTotFacPrv( cFactura, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, dbfFacPrvP, nil, cDivRet )

RETURN ( { nTotNet, nTotIva, nTotReq, nTotFac, aTotIva, nTotRet } )



static function QuiFacPrv( lDetail, lSetCnt )

   local nOrdAnt
   local cFactura

   IIF( lDetail == nil, lDetail := .T., ) ;
   IIF( lSetCnt == nil, lSetCnt := .T., ) ;

   if ( dbfFacPrvT )->lCloFac .AND. !oUser():lAdministrador()
      msgStop( "Solo puede eliminar facturas cerradas los administradores." )
      Return .F.
   end

   CursorWait()

   cFactura          := ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac

   if lDetail
      DelDetalle( cFactura )
   end





   nOrdAnt           := ( dbfAlbPrvT )->( OrdSetFocus( "cNumFac" ) )

   if ( dbfAlbPrvT )->( dbSeek( cFactura ) )

      while ( dbfAlbPrvT )->cNumFac == cFactura .AND. !( dbfAlbPrvT )->( eof() )

         SetFacturadoAlbaranProveedor( .F., oStock, , dbfAlbPrvT, dbfAlbPrvL, dbfAlbPrvS )

         ( dbfAlbPrvT )->( dbSkip() )

      end

   end

   ( dbfAlbPrvT )->( OrdSetFocus( nOrdAnt ) )

   if lSetCnt
      nPutDoc( ( dbfFacPrvT )->cSerFac, ( dbfFacPrvT )->nNumFac, ( dbfFacPrvT )->cSufFac, dbfFacPrvT, "nFacPrv" )
   end

   CursorWE()

Return .T.



Static Function DelDetalle( cFactura )

   local nOrdAnt

   IIF( cFactura == nil, cFactura := ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac, ) ;

   CursorWait()





   nOrdAnt           := ( dbfFacPrvL )->( OrdSetFocus( "nNumFac" ) )

   while ( dbfFacPrvL )->( dbSeek( cFactura ) ) .AND. !( dbfFacPrvL )->( eof() )
      if dbDialogLock( dbfFacPrvL )
         ( dbfFacPrvL )->( dbDelete() )
         ( dbfFacPrvL )->( dbUnLock() )
      end
   end

   ( dbfFacPrvL )->( OrdSetFocus( nOrdAnt ) )

   while ( dbfFacPrvP )->( dbSeek( cFactura ) ) .AND. !( dbfFacPrvP )->( eof() )
      if dbLock( dbfFacPrvP )
         ( dbfFacPrvP )->( dbDelete() )
         ( dbfFacPrvP )->( dbUnLock() )
      end
   end

   while ( dbfFacPrvI )->( dbSeek( cFactura ) .AND. !( dbfFacPrvI )->( eof() ) )
      if dbLock( dbfFacPrvI )
         ( dbfFacPrvI )->( dbDelete() )
         ( dbfFacPrvI )->( dbUnLock() )
      end
   end

   while ( dbfFacPrvD )->( dbSeek( cFactura ) .AND. !( dbfFacPrvD )->( eof() ) )
      if dbLock( dbfFacPrvD )
         ( dbfFacPrvD )->( dbDelete() )
         ( dbfFacPrvD )->( dbUnLock() )
      end
   end

   while ( dbfFacPrvS )->( dbSeek( cFactura ) .AND. !( dbfFacPrvS )->( eof() ) )
      if dbLock( dbfFacPrvS )
         ( dbfFacPrvS )->( dbDelete() )
         ( dbfFacPrvS )->( dbUnLock() )
      end
   end

   CursorWe()

RETURN NIL



FUNCTION aDocFacPrv()

   local aDoc  := {}





   aAdd( aDoc, { "Empresa",         "EM" } )
   aAdd( aDoc, { "Factura",         "FP" } )
   aAdd( aDoc, { "Proveedor",       "PR" } )
   aAdd( aDoc, { "Almacen",         "AL" } )
   aAdd( aDoc, { "Divisas",         "DV" } )
   aAdd( aDoc, { "Formas de pago",  "PG" } )
   aAdd( aDoc, { "Recibos",         "RP" } )

RETURN ( aDoc )



function aItmFacPrv()

   local aItmFacPrv  := {}

   aAdd( aItmFacPrv, { "CSERFAC"    ,"C",  1, 0, "Serie de factura"                         ,"",                   "", "( cDbf )", "A" } )
   aAdd( aItmFacPrv, { "NNUMFAC"    ,"N",  9, 0, "Número de factura"                        ,"'999999999'",        "", "( cDbf )", 0 } )
   aAdd( aItmFacPrv, { "CSUFFAC"    ,"C",  2, 0, "Sufijo de factura"                        ,"",                   "", "( cDbf )", Space( 2 ) } )
   aAdd( aItmFacPrv, { "CTURFAC"    ,"C",  6, 0, "Sesión del factura"                       ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "DFECFAC"    ,"D",  8, 0, "Fecha de la factura"                      ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODPRV"    ,"C", 12, 0, "Código del proveedor"                     ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODALM"    ,"C",  3, 0, "Código de almacen"                        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODCAJ"    ,"C",  3, 0, "Código de caja"                           ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CNOMPRV"    ,"C", 35, 0, "Nombre del proveedor"                     ,"'@!'",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDIRPRV"    ,"C", 35, 0, "Domicilio del proveedor"                  ,"'@!'",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CPOBPRV"    ,"C", 25, 0, "Población del proveedor"                  ,"'@!'",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CPROVPROV"  ,"C", 20, 0, "Provincia del proveedor"                  ,"'@!'",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CPOSPRV"    ,"C",  5, 0, "Código postal del proveedor"              ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDNIPRV"    ,"C", 30, 0, "DNI/CIF del proveedor"                    ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LLIQUIDADA" ,"L",  1, 0, "Lógico de la liquidación"                 ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LCONTAB"    ,"L",  1, 0, "Lógico de la contabilización"             ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "DFECENT"    ,"D",  8, 0, "Fecha de entrada"                         ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CSUPED"     ,"C", 50, 0, "Su factura"                               ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCONDENT"   ,"C", 20, 0, "Condición de entrada"                     ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "MCOMENT"    ,"M", 10, 0, "Comentarios"                              ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CEXPED"     ,"C", 20, 0, "Expedición"                               ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "COBSERV"    ,"C", 20, 0, "Observaciones"                            ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODPAGO"   ,"C",  2, 0, "Código del tipo de pago"                  ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NBULTOS"    ,"N",  3, 0, "Número de bultos"                         ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NPORTES"    ,"N",  6, 0, "Valor de los portes"                      ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CNUMALB"    ,"C", 12, 0, "Número de albaran"                        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CSUFALB"    ,"C",  2, 0, "Sufijo de albaran"                        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LIMPALB"    ,"L",  1, 0, "Factura importada desde albaranes"        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDTOESP"    ,"C", 50, 0, "Descripción de descuento especial"        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NDTOESP"    ,"N",  5, 2, "Porcentaje de descuento especial"         ,"'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDPP"       ,"C", 50, 0, "Descripción descuento por pronto pago"    ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NDPP"       ,"N",  5, 2, "Porcentaje de descuento por pronto pago"  ,"'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LRECARGO"   ,"L",  1, 0, "Lógico para recargo"                      ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NIRPF"      ,"N",  4, 1, ""                                         ,"'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODAGE"    ,"C",  3, 0, "Código del agente"                        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDIVFAC"    ,"C",  3, 0, "Código de divisa"                         ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NVDVFAC"    ,"N", 13, 6, "Valor del cambio de la divisa"            ,"'@E 999,999.999999'","", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LSNDDOC"    ,"L",  1, 0, "Enviar documento por internet"            ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDTOUNO"    ,"C", 25, 0, "Descripción de primer descuento personalizado", "",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NDTOUNO"    ,"N",  5, 2, "Porcentaje de primer descuento personalizado",  "",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDTODOS"    ,"C", 25, 0, "Descripción de segundo descuento personalizado","",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NDTODOS"    ,"N",  5, 2, "Porcentaje de segundo descuento personalizado", "",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODPRO"    ,"C",  9, 0, "Código de proyecto en contabilidad",            "",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LRECDOC"    ,"L",  1, 0, "Documento recibido por internet"          ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LCLOFAC"    ,"L",  1, 0, ""                                         ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CNUMDOC"    ,"C", 50, 0, "Número de documento"                      ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODUSR"    ,"C",  3, 0, "Código de usuario",                        "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LIMPRIMIDO" ,"L",  1, 0, "Lógico de imprimido del documento",        "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "DFECIMP"    ,"D",  8, 0, "Última fecha de impresión del documento",  "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CHORIMP"    ,"C",  5, 0, "Hora de la última impresión del documento","",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTipRet"    ,"N",  1, 0, "Tipo de retención ( 1. Base / 2. Base+IVA )","",                 "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nPctRet"    ,"N",  6, 2, "Porcentaje de retención IRPF",             "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "dFecChg"    ,"D",  8, 0, "Fecha de modificación del documento",      "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cTimChg"    ,"C",  5, 0, "Hora de modificación del documento",       "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cCodDlg"    ,"C",  2, 0, "Código delegación",                        "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nRegIva"    ,"N",  1, 0, "Régimen de " + cImp(),                    "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "lFacGas"    ,"L",  1, 0, "Lógico factura de gastos",                 "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "mComGas"    ,"M", 10, 0, "Comentario de gastos",                     "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nNetGas1"   ,"N", 16, 6, "Primer importe neto de gastos",            "cPirDivFac",         "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nNetGas2"   ,"N", 16, 6, "Segundo importe neto de gastos",           "cPirDivFac",         "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nNetGas3"   ,"N", 16, 6, "Tercer importe neto de gastos",            "cPirDivFac",         "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nIvaGas1"   ,"N",  6, 2, "Porcentaje primer tipo " + cImp() + " de gastos",    "'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nIvaGas2"   ,"N",  6, 2, "Porcentaje segundo tipo " + cImp() + " de gastos",   "'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nIvaGas3"   ,"N",  6, 2, "Porcentaje tercer tipo " + cImp() + " de gastos",    "'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nReGas1"    ,"N",  6, 2, "Porcentaje primer R.E. de gastos",         "'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nReGas2"    ,"N",  6, 2, "Porcentaje segundo R.E. de gastos",        "'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nReGas3"    ,"N",  6, 2, "Porcentaje tercer R.E. de gastos",         "'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTotNet"    ,"N", 16, 6, "Total neto",                               "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTotIva"    ,"N", 16, 6, "Total " + cImp(),                         "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTotReq"    ,"N", 16, 6, "Total req",                                "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTotFac"    ,"N", 16, 6, "Total factura",                            "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cNFC"       ,"C", 20, 0, "Código NFC" ,                              "'@!",                "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "SubCta"     ,"C", 12, 0, "Código subcuenta para gastos enlace contaplus", "",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTotSup"    ,"N", 16, 6, "Total gastos suplidos",                    "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cBanco"     ,"C", 50, 0, "Nombre del banco del proveedor" ,          "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cEntBnc"    ,"C",  4, 0, "Entidad de la cuenta bancaria del proveedor" ,          "",      "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cSucBnc"    ,"C",  4, 0, "Sucursal de la cuenta bancaria del proveedor" ,         "",      "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cDigBnc"    ,"C",  2, 0, "Dígito de control de la cuenta bancaria del proveedor" ,"",      "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cCtaBnc"    ,"C", 10, 0, "Cuenta bancaria del proveedor" ,                        "",      "", "( cDbf )", nil } )

return ( aItmFacPrv )



function aCalFacPrv()





























   local aCalFacPrv :=  {{"aTotIva[1,1]", "N", 16,  6, "Bruto primer tipo de " + cImp(),    "cPirDivFac",         "aTotIva[1,1] != 0" }, { "aTotIva[2,1]", "N", 16,  6, "Bruto segundo tipo de " + cImp(),   "cPirDivFac",         "aTotIva[2,1] != 0" }, { "aTotIva[3,1]", "N", 16,  6, "Bruto tercer tipo de " + cImp(),    "cPirDivFac",         "aTotIva[3,1] != 0" }, { "aTotIva[1,2]", "N", 16,  6, "Base primer tipo de " + cImp(),     "cPirDivFac",         "aTotIva[1,2] != 0" }, { "aTotIva[2,2]", "N", 16,  6, "Base segundo tipo de " + cImp(),    "cPirDivFac",         "aTotIva[2,2] != 0" }, { "aTotIva[3,2]", "N", 16,  6, "Base tercer tipo de " + cImp(),     "cPirDivFac",         "aTotIva[3,2] != 0" }, { "aTotIva[1,3]", "N",  6,  2, "Porcentaje primer tipo " + cImp(),  "'@R 99 %'",          "aTotIva[1,3] != 0" }, { "aTotIva[2,3]", "N",  6,  2, "Porcentaje segundo tipo " + cImp(), "'@R 99 %'",          "aTotIva[2,3] != 0" }, { "aTotIva[3,3]", "N",  6,  2, "Porcentaje tercer tipo " + cImp(),  "'@R 99 %'",          "aTotIva[3,3] != 0" }, { "aTotIva[1,4]", "N",  6,  2, "Porcentaje primer tipo RE",   "'@R 99 %'",          "aTotIva[1,4] != 0" }, { "aTotIva[2,4]", "N",  6,  2, "Porcentaje segundo tipo RE",  "'@R 99 %'",          "aTotIva[2,4] != 0" }, { "aTotIva[3,4]", "N",  6,  2, "Porcentaje tercer tipo RE",   "'@R 99 %'",          "aTotIva[3,4] != 0" }, { "Round( aTotIva[1,2] * aTotIva[1,3] / 100, nDouDivFac )",   "N", 16, 6, "Importe primer tipo " + cImp(),  "cPirDivFac", "aTotIva[1,2] != 0" }, { "Round( aTotIva[2,2] * aTotIva[2,3] / 100, nDouDivFac )",   "N", 16, 6, "Importe segundo tipo " + cImp(), "cPirDivFac", "aTotIva[2,2] != 0" }, { "Round( aTotIva[3,2] * aTotIva[3,3] / 100, nDouDivFac )",   "N", 16, 6, "Importe tercer tipo " + cImp(),  "cPirDivFac", "aTotIva[3,2] != 0" }, { "Round( aTotIva[1,2] * aTotIva[1,4] / 100, nDouDivFac )",   "N", 16, 6, "Importe primer RE",        "cPirDivFac", "aTotIva[1,2] != 0" }, { "Round( aTotIva[2,2] * aTotIva[2,4] / 100, nDouDivFac )",   "N", 16, 6, "Importe segundo RE",       "cPirDivFac", "aTotIva[2,2] != 0" }, { "Round( aTotIva[3,2] * aTotIva[3,4] / 100, nDouDivFac )",   "N", 16, 6, "Importe tercer RE",        "cPirDivFac", "aTotIva[3,2] != 0" }, { "nTotBrt",      "N", 16,  6, "Total bruto",                 "cPirDivFac",         "lEnd" }, { "nTotDto",      "N", 16,  6, "Total descuento",             "cPirDivFac",         "lEnd" }, { "nTotDpp",      "N", 16,  6, "Total descuento pronto pago", "cPirDivFac",         "lEnd" }, { "nTotNet",      "N", 16,  6, "Total neto",                  "cPirDivFac",         "lEnd" }, { "nTotIva",      "N", 16,  6, "Total " + cImp(),                   "cPirDivFac",         "lEnd" }, { "nTotReq",      "N", 16,  6, "Total RE",                    "cPirDivFac",         "lEnd" }, { "nTotRet",      "N", 16,  6, "Total retenciones por IRPF",  "cPirDivFac",         "lEnd" }, { "nTotFac",      "N", 16,  6, "Total factura",               "cPirDivFac",         "lEnd" }, { "nTotPage",     "N", 16,  6, "Total página",                "cPirDivFac",         "!lEnd" }, { "nPagina",      "N",  2,  0, "Número de página",            "'99'",               "" }, { "lEnd",         "L",  1,  0, "Fin del documento",           "",                   "" } }

return ( aCalFacPrv )



function aColFacPrv()

   local aColFacPrv  := {}

   aAdd( aColFacPrv, { "CSERFAC"    ,"C",  1, 0, "Serie de factura"            ,"",                    "", "( cDbfCol )", "A" } )
   aAdd( aColFacPrv, { "NNUMFAC"    ,"N",  9, 0, "Número de factura"           ,"'999999999'",         "", "( cDbfCol )", 0 } )
   aAdd( aColFacPrv, { "CSUFFAC"    ,"C",  2, 0, "Sufijo de factura"           ,"",                    "", "( cDbfCol )", Space( 2 ) } )
   aAdd( aColFacPrv, { "CREF"       ,"C", 18, 0, "Referencia artículo"         ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CREFPRV"    ,"C", 20, 0, "Referencia del proveedor"    ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CDETALLE"   ,"C",240, 0, "Detalle de articulo"         ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPREUNIT"   ,"N", 16, 6, "Precio unitario"             ,"cPinDivFac",          "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NDTO"       ,"N",  6, 2, ""                            ,"'@E 99,99'",          "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVA"       ,"N",  6, 2, "Porcentaje de " + cImp()    ,"'@E 99,99'",          "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NCANENT"    ,"N", 16, 6, "Cajas recibidas"             ,"MasUnd()",            "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LCONTROL"   ,"L",  1, 0, "Control reservado"           ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CUNIDAD"    ,"C",  2, 0, "Unidad de venta"             ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NUNICAJA"   ,"N", 16, 6, "Unidades recibidas"          ,"MasUnd()",            "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LCHGLIN"    ,"L",  1, 0, "Cambio de precio"            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "MLNGDES"    ,"M", 10, 0, "Descripción larga de artículo","",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NDTOLIN"    ,"N",  6, 2, "Descuento lineal"            ,"'@E 999,99'",         "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NDTOPRM"    ,"N",  6, 2, "Descuento por promoción"     ,"'@E 999,99'",         "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NDTORAP"    ,"N",  6, 2, "Descuento por rappels"       ,"'@E 999,99'",         "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPRECOM"    ,"N", 16, 6, "Precio de compra"            ,"cPinDivFac",          "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN1"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN2"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN3"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN4"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN5"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN6"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN1"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN2"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN3"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN4"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN5"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN6"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR1"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR2"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR3"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR4"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR5"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR6"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN1"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN2"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN3"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN4"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN5"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN6"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN1"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN2"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN3"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN4"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN5"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN6"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN"    ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LIVALIN"    ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODPR1"    ,"C", 10, 0, "Código de la propiedad 1",     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODPR2"    ,"C", 10, 0, "Código de la propiedad 2",     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CVALPR1"    ,"C", 10, 0, "Valor de la propiedad 1" ,     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CVALPR2"    ,"C", 10, 0, "Valor de la propiedad 2" ,     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NFACCNV"    ,"N", 16, 6, "Factor de conversión de la compra", "",              "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CALMLIN"    ,"C",  3, 0, "Código del almacen" ,          "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NCTLSTK"    ,"N",  1, 0, "Tipo de stock de la línea",    "'9'",                "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LLOTE"      ,"L",  1, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NLOTE"      ,"N",  9, 0, "",                             "'999999999'",        "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CLOTE"      ,"C", 12, 0, "Número de lote",               "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NNUMLIN"    ,"N",  4, 0, "Número de la línea",           "9999",               "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NUNDKIT"    ,"N", 16, 6, "Unidades del producto kit",    "MasUnd()",           "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LKITART"    ,"L",  1, 0, "Línea con escandallo",         "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LKITCHL"    ,"L",  1, 0, "Línea pertenciente a escandallo", "",                "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LKITPRC"    ,"L",  1, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LIMPLIN"    ,"L",  1, 0, "Imprimir linea",               "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "MNUMSER"    ,"M", 10, 0, "" ,                            "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODUBI1"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODUBI2"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODUBI3"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CVALUBI1"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CVALUBI2"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CVALUBI3"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CNOMUBI1"   ,"C", 30, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CNOMUBI2"   ,"C", 30, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CNOMUBI3"   ,"C", 30, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODFAM"    ,"C", 16, 0, "Código de familia",            "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CGRPFAM"    ,"C",  3, 0, "Código del grupo de familia",  "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NREQ"       ,"N", 16, 6, "Recargo de equivalencia",      "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "MOBSLIN"    ,"M", 10, 0, "Observacion de línea",         "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nPvpRec"    ,"N", 16, 6, "Precio de venta recomendado",  "cPinDivFac",         "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nNumMed"    ,"N",  1, 0, "Número de mediciones",         "MasUnd()",           "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nMedUno"    ,"N", 16, 6, "Primera unidad de medición",   "MasUnd()",           "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nMedDos"    ,"N", 16, 6, "Segunda unidad de medición",   "MasUnd()",           "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nMedTre"    ,"N", 16, 6, "Tercera unidad de medición",   "MasUnd()",           "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "dFecCad"    ,"D",  8, 0, "Fecha de caducidad",           "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nUndLin"    ,"N",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "lLabel"     ,"L",  1, 0, "Lógico de etiqueta",           "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nLabel"     ,"N",  5, 0, "Número de etiquetas",          "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cSuPed"     ,"C", 10, 0, "Su pedido",                    "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "lGasSup"    ,"L",  1, 0, "Linea de gastos suplidos",     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "dFecFac"    ,"D",  8, 0, "Fecha de la factura",          "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cCodPrv"    ,"C", 12, 0, "Código de proveedor",          "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "lNumSer"    ,"L",  1, 0, "Lógico solicitar numero de serie", "",                "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "lAutSer"    ,"L",  1, 0, "Lógico de autoserializar",     "",                    "", "( cDbfCol )" } )

return ( aColFacPrv )



function aCocFacPrv()




   local aCocFacPrv  := {{"( Descrip( cDbfCol ) )",                                           "C", 50, 0, "Descripción larga",           "",            "Descripción", "" }, { "( nTotNFacPrv( cDbfCol ) )",                                       "N", 16, 6, "Total unidades",              "cPinDivFac",  cNombreUnidades(),    "" }, { "( nTotUFacPrv( cDbfCol, nDinDivFac, nVdvDivFac ) )",               "N", 16, 6, "Precio unitario de factura",  "cPinDivFac",  "Precio",      "" }, { "( nTotLFacPrv( cDbfCol, nDinDivFac, nDirDivFac, nVdvDivFac ) )",   "N", 16, 6, "Total linea de factura",      "cPirDivFac",  "Total",       "" } }

return ( aCocFacPrv )



function aSerFacPrv()

   local aColFacPrv  := {}

   aAdd( aColFacPrv,  { "cSerFac", "C",  1,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "nNumFac", "N",  9,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cSufFac", "C",  2,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "dFecFac", "D",  8,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "nNumLin", "N",  4,   0, "Número de la línea",               "'9999'",            "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cRef",    "C", 18,   0, "Referencia del artículo",          "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cAlmLin", "C",  3,   0, "Código de almacen",                "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "lUndNeg", "L",  1,   0, "Lógico de unidades en negativo",   "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cNumSer", "C", 30,   0, "Numero de serie",                  "",                  "", "( cDbfCol )" } )

return ( aColFacPrv )



STATIC FUNCTION lLiquida( oBrw, cFactura, cDivFac )

   IIF( cFactura == nil, cFactura := ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac, ) ;
   IIF( cDivFac == nil, cDivFac := ( dbfFacPrvT )->cDivFac, ) ;

   if ( dbfFacPrvT )->lLiquidada
      MsgStop( "Factura ya pagada" )
      return .F.
   end





   ( dbfFacPrvP )->( dbGoTop() )

   if ( dbfFacPrvP )->( dbSeek( cFactura ) )

      while ( dbfFacPrvP )->cSerFac + Str( ( dbfFacPrvP )->nNumFac ) + ( dbfFacPrvP )->cSufFac == cFactura .AND. !( dbfFacPrvP )->( eof() )

         if Empty( ( dbfFacPrvP )->cTipRec ) .AND. !( dbfFacPrvP )->lCobrado

            EdtRecPrv( ( dbfFacPrvP )->cSerFac + Str( ( dbfFacPrvP )->nNumFac ) + ( dbfFacPrvP )->cSufFac, .F. )

            exit

         end

         ( dbfFacPrvP )->( dbSkip() )

      end





      ChkLqdFacPrv( nil, dbfFacPrvT, dbfFacPrvL, dbfFacPrvP, dbfIva, dbfDiv )

   end

   oBrw:Refresh()
   oBrw:SetFocus()

return .T.



Function SynFacPrv( cPath )

   local oError
   local oBlock      := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   local aTotFac
   local aNumSer
   local cNumSer

   BEGIN SEQUENCE

   dbUseArea( .T., cDriver(), cPath + "FacPRVT.DBF", cCheckArea( "FacPRVT", @dbfFacPrvT ), .F. )
   ordListAdd( cPath + "FacPRVT.CDX" )

   dbUseArea( .T., cDriver(), cPath + "FacPrvL.DBF", cCheckArea( "FacPrvL", @dbfFacPrvL ), .F. )
   ordListAdd( cPath + "FacPrvL.CDX" )

   dbUseArea( .T., cDriver(), cPath + "FacPrvS.DBF", cCheckArea( "FacPrvS", @dbfFacPrvS ), .F. )
   ordListAdd( cPath + "FacPrvS.CDX" )

   dbUseArea( .T., cDriver(), cPath + "FacPRVI.DBF", cCheckArea( "FacPRVI", @dbfFacPrvI ), .F. )
   ordListAdd( cPath + "FacPRVI.CDX" )

   dbUseArea( .T., cDriver(), cPatArt() + "FAMILIAS.DBF", cCheckArea( "FAMILIAS", @dbfFamilia ), .F. )
   ordListAdd( cPatArt() + "FAMILIAS.CDX" )

   dbUseArea( .T., cDriver(), cPatArt() + "ARTICULO.DBF", cCheckArea( "ARTICULO", @dbfArticulo ), .F. )
   ordListAdd( cPatArt() + "ARTICULO.CDX" )

   dbUseArea( .T., cDriver(), cPatArt() + "PROVART.DBF", cCheckArea( "PROVART", @dbfArtPrv ), .F. )
   ordListAdd( cPatArt() + "PROVART.CDX" )

   dbUseArea( .T., cDriver(), cPatDat() + "TIVA.DBF", cCheckArea( "TIVA", @dbfIva ), .T. )
   ordListAdd( cPatDat() + "TIVA.CDX" )

   dbUseArea( .T., cDriver(), cPatDat() + "DIVISAS.DBF", cCheckArea( "DIVISAS", @dbfDiv ), .T. )
   ordListAdd( cPatDat() + "DIVISAS.CDX" )

   while !( dbfFacPrvP )->( eof() )

      if Empty( ( dbfFacPrvP )->cCodCaj )
         ( dbfFacPrvP )->cCodCaj := "000"
      end

      if !( ( dbfFacPrvP )->cSerFac >= "A" .AND. ( dbfFacPrvP )->cSerFac <= "Z" )
         ( dbfFacPrvP )->( dbDelete() )
      end

      ( dbfFacPrvP )->( dbSkip() )

      SysRefresh()

   end

   while !( dbfFacPrvT )->( eof() )

      if Empty( ( dbfFacPrvT )->cCodCaj )
         ( dbfFacPrvT )->cCodCaj := "000"
      end

      if !( ( dbfFacPrvT )->cSerFac >= "A" .AND. ( dbfFacPrvT )->cSerFac <= "Z" )
         ( dbfFacPrvT )->( dbDelete() )
      end





      if ( dbfFacPrvT )->nTotFac == 0 .AND. dbLock( dbfFacPrvT )

         aTotFac                 := aTotFacPrv( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, dbfFacPrvP, ( dbfFacPrvT )->cDivFac )

         ( dbfFacPrvT )->nTotNet := aTotFac[1]
         ( dbfFacPrvT )->nTotIva := aTotFac[2]
         ( dbfFacPrvT )->nTotReq := aTotFac[3]
         ( dbfFacPrvT )->nTotFac := aTotFac[4]

         ( dbfFacPrvT )->( dbUnLock() )

      end

      ( dbfFacPrvT )->( dbSkip() )

      SysRefresh()

   end

   while !( dbfFacPrvL )->( eof() )

      if !( dbfFacPrvT )->( dbSeek( ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac ) )

         ( dbfFacPrvL )->( dbDelete() )

      else

         if Empty( ( dbfFacPrvL )->cLote ) .AND. !Empty( ( dbfFacPrvL )->nLote )
            ( dbfFacPrvL )->cLote   := AllTrim( Str( ( dbfFacPrvL )->nLote ) )
         end

         if !Empty( ( dbfFacPrvL )->cRef ) .AND. Empty( ( dbfFacPrvL )->cCodFam )
            ( dbfFacPrvL )->cCodFam := RetFamArt( ( dbfFacPrvL )->cRef, dbfArticulo )
         end

         if !Empty( ( dbfFacPrvL )->cRef ) .AND. !Empty( ( dbfFacPrvL )->cCodFam )
            ( dbfFacPrvL )->cGrpFam := cGruFam( ( dbfFacPrvL )->cCodFam, dbfFamilia )
         end

         if Empty( ( dbfFacPrvL )->nReq )
            ( dbfFacPrvL )->nReq    := nPReq( dbfIva, ( dbfFacPrvL )->nIva )
         end

         if ( dbfFacPrvL )->dFecFac <> ( dbfFacPrvT )->dFecFac
            ( dbfFacPrvL )->dFecFac := ( dbfFacPrvT )->dFecFac
         end

         if !Empty( ( dbfFacPrvL )->mNumSer )

            aNumSer                       := hb_aTokens( ( dbfFacPrvL )->mNumSer, "," )
            for each cNumSer in aNumSer
               ( dbfFacPrvS )->( dbAppend() )
               ( dbfFacPrvS )->cSerFac    := ( dbfFacPrvL )->cSerFac
               ( dbfFacPrvS )->nNumFac    := ( dbfFacPrvL )->nNumFac
               ( dbfFacPrvS )->cSufFac    := ( dbfFacPrvL )->cSufFac
               ( dbfFacPrvS )->cRef       := ( dbfFacPrvL )->cRef
               ( dbfFacPrvS )->cAlmLin    := ( dbfFacPrvL )->cAlmLin
               ( dbfFacPrvS )->nNumLin    := ( dbfFacPrvL )->nNumLin
               ( dbfFacPrvS )->cNumSer    := cNumSer
            next

            ( dbfFacPrvL )->mNumSer       := ""

         end

      end

      ( dbfFacPrvL )->( dbSkip() )

      SysRefresh()

   end

   while !( dbfFacPrvI )->( eof() )

      if !( dbfFacPrvT )->( dbSeek( ( dbfFacPrvI )->cSerie + Str( ( dbfFacPrvI )->nNumFac ) + ( dbfFacPrvI )->cSufFac ) )
         ( dbfFacPrvI )->( dbDelete() )
      end

      ( dbfFacPrvI )->( dbSkip() )

      SysRefresh()

   end



   while !( dbfFacPrvS )->( eof() )

      if !( dbfFacPrvT )->( dbSeek( ( dbfFacPrvS )->cSerFac + Str( ( dbfFacPrvS )->nNumFac ) + ( dbfFacPrvS )->cSufFac ) )

         ( dbfFacPrvS )->( dbDelete() )

      else

         if ( dbfFacPrvS )->dFecFac <> ( dbfFacPrvT )->dFecFac
            ( dbfFacPrvS )->dFecFac    := ( dbfFacPrvT )->dFecFac
         end

      end

      ( dbfFacPrvS )->( dbSkip() )

      SysRefresh()

   end

   RECOVER USING oError

      msgStop( "Imposible sincronizar factura de proveedores" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   if !Empty( dbfFacPrvT ) .AND. ( dbfFacPrvT )->( Used() )
      ( dbfFacPrvT )->( dbCloseArea() )
   end

   if !Empty( dbfFacPrvL ) .AND. ( dbfFacPrvL )->( Used() )
      ( dbfFacPrvL )->( dbCloseArea() )
   end

   if !Empty( dbfFacPrvS ) .AND. ( dbfFacPrvS )->( Used() )
      ( dbfFacPrvS )->( dbCloseArea() )
   end

   if !Empty( dbfFacPrvI ) .AND. ( dbfFacPrvI )->( Used() )
      ( dbfFacPrvI )->( dbCloseArea() )
   end

   if !Empty( dbfArticulo ) .AND. ( dbfArticulo )->( Used() )
      ( dbfArticulo )->( dbCloseArea() )
   end

   if !Empty( dbfFamilia ) .AND. ( dbfFamilia )->( Used() )
      ( dbfFamilia )->( dbCloseArea() )
   end

   if !Empty( dbfArtPrv ) .AND. ( dbfArtPrv )->( Used() )
      ( dbfArtPrv )->( dbCloseArea() )
   end

   if !Empty( dbfIva ) .AND. ( dbfIva )->( Used() )
      ( dbfIva )->( dbCloseArea() )
   end

   if !Empty( dbfDiv ) .AND. ( dbfDiv )->( Used() )
      ( dbfDiv )->( dbCloseArea() )
   end

return nil



_HB_CLASS TFacturasProveedorSenderReciver ; UTILITY FUNCTION TFacturasProveedorSenderReciver(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TFacturasProveedorSenderReciver" , {TSenderReciverItem():classh} ) ) ; ;

   _HB_MEMBER CreateData(); IIF( .F., s_oClass:ModMethod( "CreateData", @TFacturasProveedorSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "CreateData", @TFacturasProveedorSenderReciver_CreateData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER RestoreData(); IIF( .F., s_oClass:ModMethod( "RestoreData", @TFacturasProveedorSenderReciver_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "RestoreData", @TFacturasProveedorSenderReciver_RestoreData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER SendData(); IIF( .F., s_oClass:ModMethod( "SendData", @TFacturasProveedorSenderReciver_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SendData", @TFacturasProveedorSenderReciver_SendData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER ReciveData(); IIF( .F., s_oClass:ModMethod( "ReciveData", @TFacturasProveedorSenderReciver_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "ReciveData", @TFacturasProveedorSenderReciver_ReciveData(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Process(); IIF( .F., s_oClass:ModMethod( "Process", @TFacturasProveedorSenderReciver_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Process", @TFacturasProveedorSenderReciver_Process(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TFacturasProveedorSenderReciver ;



UTILITY STATIC function TFacturasProveedorSenderReciver_CreateData() ; local Self AS CLASS TFacturasProveedorSenderReciver := QSelf() AS CLASS TFacturasProveedorSenderReciver

   local oBlock
   local oError
   local lSnd        := .F.
   local dbfFacPrvT
   local dbfFacPrvL
   local dbfFacPrvI
   local dbfFacPrvP
   local cFileName   := "FacPrv" + StrZero( ::nGetNumberToSend(), 6 ) + "." + RetSufEmp()

   ::oSender:SetText( "Enviando facturas a proveedores" )

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVT.DBF" ), ( cCheckArea( "FACPRVT", @dbfFacPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @dbfFacPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvI.DBF" ), ( cCheckArea( "FacPrvI", @dbfFacPrvI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvP.DBF" ), ( cCheckArea( "FacPrvP", @dbfFacPrvP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end





   rxFacPrv( cPatSnd() )
   rxRecPrv( cPatSnd() )

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FACPRVT.DBF" ), ( cCheckArea( "FACPRVT", @tmpFacPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FACPRVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @tmpFacPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacPrvI.DBF" ), ( cCheckArea( "FacPrvI", @tmpFacPrvI ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FacPrvI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacPrvP.DBF" ), ( cCheckArea( "FacPrvP", @tmpFacPrvP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FacPrvP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   if !Empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( dbfFacPrvT )->( LastRec() )
   end

   while !( dbfFacPrvT )->( eof() )

      if ( dbfFacPrvT )->lSndDoc

         lSnd  := .T.

         dbPass( dbfFacPrvT, tmpFacPrvT, .T. )
         ::oSender:SetText( ( dbfFacPrvT )->cSerFac + "/" + AllTrim( Str( ( dbfFacPrvT )->nNumFac ) ) + "/" + AllTrim( ( dbfFacPrvT )->cSufFac ) + "; " + Dtoc( ( dbfFacPrvT )->dFecFac ) + "; " + AllTrim( ( dbfFacPrvT )->cCodPrv ) + "; " + ( dbfFacPrvT )->cNomPrv )

         if ( dbfFacPrvL )->( dbSeek( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac ) )
            while ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac == ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac .AND. !( dbfFacPrvL )->( eof() )
               dbPass( dbfFacPrvL, tmpFacPrvL, .T. )
               ( dbfFacPrvL )->( dbSkip() )
            end
         end

         if ( dbfFacPrvI )->( dbSeek( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac ) )
            while ( dbfFacPrvI )->cSerFac + Str( ( dbfFacPrvI )->nNumFac ) + ( dbfFacPrvI )->cSufFac == ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac .AND. !( dbfFacPrvI )->( eof() )
               dbPass( dbfFacPrvI, tmpFacPrvI, .T. )
               ( dbfFacPrvI )->( dbSkip() )
            end
         end

         if ( dbfFacPrvP )->( dbSeek( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac ) )
            while ( dbfFacPrvP )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac == ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac .AND. !( dbfFacPrvP )->( eof() )
               dbPass( dbfFacPrvP, tmpFacPrvP, .T. )
               ( dbfFacPrvP )->( dbSkip() )
            end
         end

      end

      ( dbfFacPrvT )->( dbSkip() )

      if !Empty( ::oSender:oMtr )
         ::oSender:oMtr:Set( ( dbfFacPrvT )->( OrdKeyNo() ) )
      end

   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfFacPrvT )->( dbCloseArea() )
   ( dbfFacPrvL )->( dbCloseArea() )
   ( dbfFacPrvI )->( dbCloseArea() )
   ( dbfFacPrvP )->( dbCloseArea() )
   ( tmpFacPrvT )->( dbCloseArea() )
   ( tmpFacPrvL )->( dbCloseArea() )
   ( tmpFacPrvI )->( dbCloseArea() )
   ( tmpFacPrvP )->( dbCloseArea() )

   if lSnd





      ::oSender:SetText( "Comprimiendo facturas de proveedores" )

      if ::oSender:lZipData( cFileName )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay facturas de proveedores para enviar" )

   end

Return ( Self )



UTILITY STATIC function TFacturasProveedorSenderReciver_RestoreData() ; local Self AS CLASS TFacturasProveedorSenderReciver := QSelf() AS CLASS TFacturasProveedorSenderReciver

   local oBlock
   local oError
   local dbfFacPrvT

   if ::lSuccesfullSend





      oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvT.DBF" ), ( cCheckArea( "FacPrvT", @dbfFacPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

         lSelectAll( oWndBrw, dbfFacPrvT, "lSndDoc", .F., .T., .T. )

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

      ( dbfFacPrvT )->( dbCloseArea() )

   end

Return ( Self )



UTILITY STATIC function TFacturasProveedorSenderReciver_SendData() ; local Self AS CLASS TFacturasProveedorSenderReciver := QSelf() AS CLASS TFacturasProveedorSenderReciver

   local cFileName         := "FacPrv" + StrZero( ::nGetNumberToSend(), 6 ) + "." + RetSufEmp()

   if File( cPatOut() + cFileName )





      if ftpSndFile( cPatOut() + cFileName, cFileName, 2000, ::oSender )
         ::lSuccesfullSend := .T.
         ::IncNumberToSend()
         ::oSender:SetText( "Fichero enviado " + cFileName )
      else
         ::oSender:SetText( "ERROR al enviar fichero" )
      end

   end

Return ( Self )



UTILITY STATIC function TFacturasProveedorSenderReciver_ReciveData() ; local Self AS CLASS TFacturasProveedorSenderReciver := QSelf() AS CLASS TFacturasProveedorSenderReciver

   local n
   local aExt        := aRetDlgEmp()





   ::oSender:SetText( "Recibiendo facturas de proveedores" )

   for n := 1 to len( aExt )
      ftpGetFiles( "FacPrv*." + aExt[ n ], cPatIn(), 2000, ::oSender )
   next

   ::oSender:SetText( "Facturas de proveedores recibidas" )

Return Self



UTILITY STATIC function TFacturasProveedorSenderReciver_Process() ; local Self AS CLASS TFacturasProveedorSenderReciver := QSelf() AS CLASS TFacturasProveedorSenderReciver

   local m
   local oStock
   local dbfFacPrvT
   local dbfFacPrvL
   local dbfFacPrvP
   local aFiles      := Directory( cPatIn() + "FacPrv*.*" )
   local oBlock
   local oError





   ::oSender:SetText( "Recibiendo facturas de proveedores" )

   for m := 1 to len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      oBlock         := ErrorBlock( { | oError | ApoloBreak( oError ) } )

      BEGIN SEQUENCE





      if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )







         if lExistTable( cPatSnd() + "FacPrvT.DBF" ) .AND. lExistTable( cPatSnd() + "FacPrvL.DBF" ) .AND. lExistTable( cPatSnd() + "FacPrvP.DBF" )

            dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacPrvT.DBF" ), ( cCheckArea( "FacPrvT", @tmpFacPrvT ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
            if !lAIS() ; ordListAdd( ( cPatSnd() + "FacPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacPrvL.DBF" ), ( cCheckArea( "FacPrvL", @tmpFacPrvL ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
            if !lAIS() ; ordListAdd( ( cPatSnd() + "FacPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatSnd() + "FacPrvP.Dbf" ), ( cCheckArea( "FacPrvP", @tmpFacPrvP ) ), if(.F. .OR. .F., !.F., NIL), .T.,, )
            if !lAIS() ; ordListAdd( ( cPatSnd() + "FacPrvP.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvT.DBF" ), ( cCheckArea( "FacPrvT", @dbfFacPrvT ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvL.DBF" ), ( cCheckArea( "FacPrvL", @dbfFacPrvL ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvP.DBF" ), ( cCheckArea( "FacPrvP", @dbfFacPrvP ) ), if(.T. .OR. .F., !.F., NIL), .F.,, )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            oStock            := TStock():New()
            oStock:cFacPrvT   := dbfFacPrvT
            oStock:cFacPrvL   := dbfFacPrvL

            while ( tmpFacPrvT )->( !eof() )






               if lValidaOperacion( ( tmpFacPrvT )->dFecFac, .F. ) .AND.  !( dbfFacPrvT )->( dbSeek( ( tmpFacPrvT )->cSerFac + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac ) )

                  dbPass( tmpFacPrvT, dbfFacPrvT, .T. )
                  ::oSender:SetText( "Añadido     : " + ( tmpFacPrvT )->cSerFac + "/" + AllTrim( Str( ( tmpFacPrvT )->nNumFac ) ) +"/" + AllTrim( ( tmpFacPrvT )->cSufFac ) + "; " + Dtoc( ( tmpFacPrvT )->dFecFac ) + "; " + AllTrim( ( tmpFacPrvT )->cCodPrv ) + ( tmpFacPrvT )->cNomPrv )

                  if ( tmpFacPrvL )->( dbSeek( ( tmpFacPrvT )->cSerFac + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac ) )
                     while ( tmpFacPrvL )->cSerFac + Str( ( tmpFacPrvL )->nNumFac ) + ( tmpFacPrvL )->cSufFac == ( tmpFacPrvT )->cSerFac + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac .AND. !( tmpFacPrvL )->( eof() )
                        dbPass( tmpFacPrvL, dbfFacPrvL, .T. )
                        ( tmpFacPrvL )->( dbSkip() )
                     end
                  end





                  if ( tmpFacPrvP )->( dbSeek( ( tmpFacPrvT )->cSerFac + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac ) )
                     while ( tmpFacPrvP )->cSerFac + Str( ( tmpFacPrvP )->nNumFac ) + ( tmpFacPrvP )->cSufFac == ( tmpFacPrvT )->cSerFac + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac .AND. !( tmpFacPrvP )->( eof() )
                        dbPass( tmpFacPrvP, dbfFacPrvP, .T. )
                        ( tmpFacPrvP )->( dbSkip() )
                     end
                  end







               else

                  ::oSender:SetText( "Desestimado : " + ( tmpFacPrvT )->cSerFac + "/" + AllTrim( Str( ( tmpFacPrvT )->nNumFac ) ) +"/" + AllTrim( ( tmpFacPrvT )->cSufFac ) + "; " + Dtoc( ( tmpFacPrvT )->dFecFac ) + "; " + AllTrim( ( tmpFacPrvT )->cCodPrv ) + ( tmpFacPrvT )->cNomPrv )

               end

               ( tmpFacPrvT )->( dbSkip() )

            end

            ( dbfFacPrvT )->( dbCloseArea() )
            ( dbfFacPrvL )->( dbCloseArea() )
            ( dbfFacPrvP )->( dbCloseArea() )
            ( tmpFacPrvT )->( dbCloseArea() )
            ( tmpFacPrvL )->( dbCloseArea() )
            ( tmpFacPrvP )->( dbCloseArea() )

            oStock:end()

         end

      end

      ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

      RECOVER USING oError

         ( dbfFacPrvT )->( dbCloseArea() )
         ( dbfFacPrvL )->( dbCloseArea() )
         ( dbfFacPrvP )->( dbCloseArea() )
         ( tmpFacPrvT )->( dbCloseArea() )
         ( tmpFacPrvL )->( dbCloseArea() )
         ( tmpFacPrvP )->( dbCloseArea() )

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

   next

Return Self



Static Function nEstadoIncidencia( cNumFac )

   local nEstado  := 0

   if ( dbfFacPrvI )->( dbSeek( cNumFac ) )

      while ( dbfFacPrvI )->cSerie + Str( ( dbfFacPrvI )->nNumFac ) + ( dbfFacPrvI )->cSufFac == cNumFac .AND. !( dbfFacPrvI )->( Eof() )

         if ( dbfFacPrvI )->lListo
            do case
               case nEstado == 0 .OR. nEstado == 3
                    nEstado := 3
               case nEstado == 1
                    nEstado := 2
            end
         else
            do case
               case nEstado == 0
                    nEstado := 1
               case nEstado == 3
                    nEstado := 2
            end
         end

         ( dbfFacPrvI )->( dbSkip() )

      end

   end

Return ( nEstado )



FUNCTION aEtqFacPrv( dbfDocFld, dbfDocCol )

   local aDoc  := {}

   aAdd( aDoc, { "Empresa",         "EM" } )
   aAdd( aDoc, { "Proveedor",       "PR" } )
   aAdd( aDoc, { "Artículos",       "AR" } )
   aAdd( aDoc, { "Factura cabecera","FP" } )
   aAdd( aDoc, { "Factura líneas",  "FX" } )

RETURN ( aDoc )



Function AppFacPrv( cCodPrv, cCodArt, lOpenBrowse )

   local nLevel         := nLevelUsr( "01048" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 2 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv( nil, nil, cCodPrv, cCodArt )
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( .T. )
         WinAppRec( nil, bEdtRec, dbfFacPrvT, cCodPrv, cCodArt )
         CloseFiles()
      end

   end

RETURN .T.



Function bGenEdtFacPrv( nNumFac )

   local bGen
   local cDoc           := by( nNumFac )

   bGen                 := {|| EdtFacPrv( nNumFac ) }

return ( bGen )



FUNCTION EdtFacPrv( nNumFac, lOpenBrowse )

   local nLevel         := nLevelUsr( "01048" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", dbfFacPrvT )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", dbfFacPrvT )
            nTotFacPrv()
            WinEdtRec( nil, bEdtRec, dbfFacPrvT )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION ZooFacPrv( nNumFac, lOpenBrowse )

   local nLevel         := nLevelUsr( "01048" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", dbfFacPrvT )
            oWndBrw:RecZoom()
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", dbfFacPrvT )
            nTotFacPrv()
            WinZooRec( nil, bEdtRec, dbfFacPrvT )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION DelFacPrv( nNumFac, lOpenBrowse )

   local nLevel         := nLevelUsr( "01048" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", dbfFacPrvT )
            WinDelRec( nil, dbfFacPrvT, {|| QuiFacPrv() } )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", dbfFacPrvT )
            WinDelRec( nil, dbfFacPrvT, {|| QuiFacPrv() } )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

Return nil



FUNCTION PrnFacPrv( nNumFac, lOpenBrowse )

   local nLevel         := nLevelUsr( "01048" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", dbfFacPrvT )
            GenFacPrv( 1 )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", dbfFacPrvT )
            nTotFacPrv()
            GenFacPrv( 1 )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION VisFacPrv( nNumFac, lOpenBrowse )

   local nLevel         := nLevelUsr( "01048" )

   IIF( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) <> 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", dbfFacPrvT )
            GenFacPrv( 2 )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", dbfFacPrvT )
            nTotFacPrv()
            GenFacPrv( 2 )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

Return nil



static function lRecibosPagadosTmp( dbfTmpPgo )

   local lRecPgd  := .F.
   local nRecAct  := ( dbfTmpPgo )->( Recno() )

   while !( dbfTmpPgo )->( eof() )
      if ( dbfTmpPgo )->lCobrado .AND. !( dbfTmpPgo )->lDevuelto
         lRecPgd  := .T.
         exit
      end
      ( dbfTmpPgo )->( dbSkip() )
   end

   ( dbfTmpPgo )->( dbGoTo( nRecAct) )

return ( lRecPgd )



static function ShowKitFacPrv( dbfMaster, oBrw, cCodPrv, dbfTmpInc, aGet, aTmp, aControl, oSayGas, oSayLabels, oBrwIva )

   if !Empty( aGet )

      if lUsrMaster() .OR. oUser():lCambiarPrecio()
         aGet[ ( dbfMaster )->( FieldPos( "lRecargo" ) ) ]:HardEnable()
      else
         aGet[ ( dbfMaster )->( FieldPos( "lRecargo" ) ) ]:HardDisable()
      end

      if !Empty( cCodPrv )
         aGet[ ( dbfMaster )->( FieldPos( "cCodPrv" ) ) ]:cText( cCodPrv )
         aGet[ ( dbfMaster )->( FieldPos( "cCodPrv" ) ) ]:lValid()
      end

      aGet[ ( dbfMaster )->( FieldPos( "cCodPrv" ) ) ]:SetFocus()

      aGet[ ( dbfMaster )->( FieldPos( "SubCta" ) ) ]:lValid()

      if !Empty( aTmp ) .AND. aTmp[ 57 ]

         oBrw:Hide()
         oBrwIva:Hide()
         aEval( aControl, {| o | o:Hide() } )

         oSayLabels[1]:Hide()
         oSayLabels[2]:Hide()
         oSayLabels[3]:Hide()
         oSayLabels[4]:Hide()
         oSayLabels[5]:Hide()

         aGet[ 29 ]:Hide()
         aGet[ 31    ]:Hide()
         aGet[ 30 ]:Hide()
         aGet[ 32    ]:Hide()
         aGet[ 39 ]:Hide()
         aGet[ 40 ]:Hide()
         aGet[ 41 ]:Hide()
         aGet[ 42 ]:Hide()

         aEval( oSayGas, {| o | o:Show() } )

         aGet[ 58  ]:Show()
         aGet[ 59 ]:Show()
         aGet[ 60 ]:Show()
         aGet[ 61 ]:Show()
         aGet[ 62 ]:Show()
         aGet[ 63 ]:Show()
         aGet[ 64 ]:Show()
         aGet[ 65  ]:Show()
         aGet[ 66  ]:Show()
         aGet[ 67  ]:Show()

      else

         oBrw:Show()
         oBrwIva:Show()
         aEval( aControl, {| o | o:Show() } )

         oSayLabels[1]:Show()
         oSayLabels[2]:Show()
         oSayLabels[3]:Show()
         oSayLabels[4]:Show()
         oSayLabels[5]:Show()

         aGet[ 29 ]:Show()
         aGet[ 31    ]:Show()
         aGet[ 30 ]:Show()
         aGet[ 32    ]:Show()
         aGet[ 39 ]:Show()
         aGet[ 40 ]:Show()
         aGet[ 41 ]:Show()
         aGet[ 42 ]:Show()

         aEval( oSayGas, {| o | o:Hide() } )

         aGet[ 58  ]:Hide()
         aGet[ 58  ]:Hide()
         aGet[ 59 ]:Hide()
         aGet[ 60 ]:Hide()
         aGet[ 61 ]:Hide()
         aGet[ 62 ]:Hide()
         aGet[ 63 ]:Hide()
         aGet[ 64 ]:Hide()
         aGet[ 65  ]:Hide()
         aGet[ 66  ]:Hide()
         aGet[ 67  ]:Hide()

      end

   end





   if !Empty( dbfTmpInc )

      while !( dbfTmpInc )->( Eof() )
         if ( dbfTmpInc )->lAviso .AND. !( dbfTmpInc )->lListo
            MsgInfo( Trim( ( dbfTmpInc )->mDesInc ), "¡Incidencia!" )
         end
         ( dbfTmpInc )->( dbSkip() )
      end

      ( dbfTmpInc )->( dbGoTop() )

   end

   oBrw:Refresh()

return nil



STATIC FUNCTION ValidaMedicion( aTmp, aGet )

   local cNewUndMed  := aGet[ 12 ]:VarGet





   if ( Empty( cOldUndMed ) .OR. cOldUndMed <> cNewUndMed )

      if oUndMedicion:oDbf:Seek( aTmp[ 12 ] )

         if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
            if !Empty( aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:cText( ( dbfArticulo )->nLngArt )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:Show()
            else
               aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]  := ( dbfArticulo )->nLngArt
            end
         else
            if !Empty( aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:Hide()
            else
               aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
            if !Empty( aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:cText( ( dbfArticulo )->nAltArt )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:Show()
            else
               aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]  := ( dbfArticulo )->nAltArt
            end

         else
            if !Empty( aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:Hide()
            else
                 aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
            if !Empty( aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:cText( ( dbfArticulo ) ->nAncArt )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:Show()
            else
               aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]  := ( dbfArticulo )->nAncArt
            end
         else
            if !Empty( aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:Hide()
            else
               aTmp[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]  := 0
            end
         end

      else

         if !Empty( aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ] )
            aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:Hide()
            aGet[ ( dbfFacPrvL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ] )
            aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:Hide()
            aGet[ ( dbfFacPrvL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ] )
            aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:Hide()
            aGet[ ( dbfFacPrvL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
         end

      end

      cOldUndMed := cNewUndMed

   end

RETURN .T.



Function IsFacPrv( cPath )

   IIF( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "FacPrvT.Dbf" )
      dbCreate( cPath + "FacPrvT.Dbf", aSqlStruct( aItmFacPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "FacPrvL.Dbf" )
      dbCreate( cPath + "FacPrvL.Dbf", aSqlStruct( aColFacPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "FacPrvI.Dbf" )
      dbCreate( cPath + "FacPrvI.Dbf", aSqlStruct( aIncFacPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "FacPrvD.Dbf" )
      dbCreate( cPath + "FacPrvD.Dbf", aSqlStruct( aFacPrvDoc() ), cDriver() )
   end




   if !lExistIndex( cPath + "FacPrvT.Cdx" ) .OR.  !lExistIndex( cPath + "FacPrvL.Cdx" ) .OR.  !lExistIndex( cPath + "FacPrvI.Cdx" ) .OR.  !lExistIndex( cPath + "FacPrvD.Cdx" )

      rxFacPrv( cPath )

   end

Return ( nil )



FUNCTION cPrpFacPrv( cFacPrvL )

   local cReturn     := ""

   IIF( cFacPrvL == nil, cFacPrvL := if( !Empty( tmpFacPrvL ), tmpFacPrvL, dbfFacPrvL ), ) ;

   cReturn           += Alltrim( ( cFacPrvL )->cRef )

   if !Empty( ( cFacPrvL )->cValPr1 )
      cReturn        += "."
      cReturn        += Alltrim( ( cFacPrvL )->cValPr1 )
   end

   if !Empty( ( cFacPrvL )->cValPr2 )
      cReturn        += "."
      cReturn        += Alltrim( ( cFacPrvL )->cValPr2 )
   end

RETURN ( cReturn )







FUNCTION cDesFacPrv( cFacPrvT, cFacPrvL, cFacPrvS )

   local cReturn     := ""

   IIF( cFacPrvT == nil, cFacPrvT := dbfFacPrvT, ) ;
   IIF( cFacPrvL == nil, cFacPrvL := dbfFacPrvL, ) ;
   IIF( cFacPrvS == nil, cFacPrvS := dbfFacPrvS, ) ;

   if ( dbfFacPrvT )->lFacGas
      cReturn        := Rtrim( ( cFacPrvT )->cDetalle )
   else
      cReturn        := Descrip( cFacPrvL, cFacPrvS )
   end

RETURN ( cReturn )



Function cCtaFacPrv( cFacPrvT, cFacPrvP, cBncPrv )

   local cCtaFacPrv  := ""

   IIF( cFacPrvT == nil, cFacPrvT := dbfFacPrvT, ) ;
   IIF( cFacPrvP == nil, cFacPrvP := dbfFacPrvP, ) ;
   IIF( cBncPrv == nil, cBncPrv := dbfPrvBnc, ) ;

   cCtaFacPrv        := Rtrim( ( cFacPrvT )->cEntBnc + ( cFacPrvT )->cSucBnc + ( cFacPrvT )->cDigBnc + ( cFacPrvT )->cCtaBnc )

   if Empty( cCtaFacPrv )
      if dbSeekInOrd( ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac, "nNumFac", cFacPrvP )
         cCtaFacPrv  := cProveeCuenta( ( cFacPrvP )->cCodPrv, cBncPrv )
      end
   end

Return ( cCtaFacPrv )












Function lRectificadaPrv( cNumFac, cFacPrvT, cRctPrvT )

   local lRectificada   := .F.

   IIF( cFacPrvT == nil, cFacPrvT := dbfFacPrvT, ) ;
   IIF( cRctPrvT == nil, cRctPrvT := dbfRctPrvT, ) ;
   IIF( cNumFac == nil, cNumFac := ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac, ) ;

   if dbSeekInOrd( cNumFac, "CNUMFAC", cRctPrvT )
      lRectificada      := .T.
   end

return ( lRectificada )






FUNCTION nTotLFacPrv( uFacPrvL, nDec, nRec, nVdv, cPirDiv )

   local nCalculo
   local nDtoLin
   local nDtoPrm

   IIF( uFacPrvL == nil, uFacPrvL := if( !Empty( tmpFacPrvL ), tmpFacPrvL, dbfFacPrvL ), ) ;
   IIF( nDec == nil, nDec := nDinDiv(), ) ;
   IIF( nRec == nil, nRec := nRinDiv(), ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nTotUFacPrv( uFacPrvL, nDec, nVdv )

   do case
   case ValType( uFacPrvL ) == "A"
      nDtoLin        := uFacPrvL[ 16 ]
      nDtoPrm        := uFacPrvL[ 17 ]
   case ValType( uFacPrvL ) == "C"
      nDtoLin        := ( uFacPrvL )->nDtoLin
      nDtoPrm        := ( uFacPrvL )->nDtoPrm
   case ValType( uFacPrvL ) == "O"
      nDtoLin        := uFacPrvL:nDtoLin
      nDtoPrm        := uFacPrvL:nDtoPrm
   end

   if nDtoLin <> 0
      nCalculo       -= nCalculo * nDtoLin / 100
   end

   if nDtoPrm <> 0
      nCalculo       -= nCalculo * nDtoPrm / 100
   end

   nCalculo          *= nTotNFacPrv( uFacPrvL )

   if nRec <> nil
      nCalculo       := Round( nCalculo, nRec )
   end

RETURN ( if( cPirDiv <> NIL, Trans( nCalculo, cPirDiv ), nCalculo ) )



FUNCTION nTotUFacPrv( uFacPrvL, nDec, nVdv, cPinDiv )

    local nCalculo

   IIF( uFacPrvL == nil, uFacPrvL := if( !Empty( tmpFacPrvL ), tmpFacPrvL, dbfFacPrvL ), ) ;
   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   do case
   case ValType( uFacPrvL ) == "O"
      nCalculo    := uFacPrvL:nPreUnit       / NotCero( nVdv )
   case ValType( uFacPrvL ) == "A"
      nCalculo    := uFacPrvL[ 7 ]   / NotCero( nVdv )
   case ValType( uFacPrvL ) == "C"
      nCalculo    := ( uFacPrvL )->nPreUnit  / NotCero( nVdv )
   end

   nCalculo       := Round( nCalculo, nDec )

RETURN ( ( if( cPinDiv <> nil, Trans( nCalculo, cPinDiv ), nCalculo ) )  )



FUNCTION cBarPrp1FacPrv( uFacPrvL, uTblPro )

   local cBarPrp1    := ""

   IIF( uFacPrvL == nil, uFacPrvL := if( !Empty( tmpFacPrvL ), tmpFacPrvL, dbfFacPrvL ), ) ;
   IIF( uTblPro == nil, uTblPro := dbfTblPro, ) ;

   if dbSeekInOrd( ( uFacPrvL )->cCodPr1 + ( uFacPrvL )->cValPr1, "cCodPro", uTblPro )
      cBarPrp1       := ( uTblPro )->nBarTbl
   end

RETURN ( cBarPrp1 )



FUNCTION cBarPrp2FacPrv( uFacPrvL, uTblPro )

   local cBarPrp2    := ""

   IIF( uFacPrvL == nil, uFacPrvL := if( !Empty( tmpFacPrvL ), tmpFacPrvL, dbfFacPrvL ), ) ;
   IIF( uTblPro == nil, uTblPro := dbfTblPro, ) ;

   if dbSeekInOrd( ( uFacPrvL )->cCodPr2 + ( uFacPrvL )->cValPr2, "cCodPro", uTblPro )
      cBarPrp2       := ( uTblPro )->nBarTbl
   end

RETURN ( cBarPrp2 )





_HB_CLASS TFacturaProveedorLabelGenerator ; UTILITY FUNCTION TFacturaProveedorLabelGenerator(...); static s_oClass ; local oClassInstance ; local nScope ; nScope := 1 ; if s_oClass == NIL ; s_oClass := IIF(.F.,, HBClass():New( "TFacturaProveedorLabelGenerator" , { HBObject():Classh } ) ) ;

   _HB_MEMBER { oDlg} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oDlg" }, .F., .F. ), )
   _HB_MEMBER { oFld} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFld" }, .F., .F. ), )

   _HB_MEMBER { oSerieInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSerieInicio" }, .F., .F. ), )
   _HB_MEMBER { cSerieInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cSerieInicio" }, .F., .F. ), )

   _HB_MEMBER { oSerieFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oSerieFin" }, .F., .F. ), )
   _HB_MEMBER { cSerieFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cSerieFin" }, .F., .F. ), )

   _HB_MEMBER { nDocumentoInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nDocumentoInicio" }, .F., .F. ), )
   _HB_MEMBER { nDocumentoFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nDocumentoFin" }, .F., .F. ), )

   _HB_MEMBER { cSufijoInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cSufijoInicio" }, .F., .F. ), )
   _HB_MEMBER { cSufijoFin} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cSufijoFin" }, .F., .F. ), )

   _HB_MEMBER { oFormatoLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFormatoLabel" }, .F., .F. ), )
   _HB_MEMBER { cFormatoLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cFormatoLabel" }, .F., .F. ), )

   _HB_MEMBER { nFilaInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nFilaInicio" }, .F., .F. ), )
   _HB_MEMBER { nColumnaInicio} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nColumnaInicio" }, .F., .F. ), )

   _HB_MEMBER { nRecno} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nRecno" }, .F., .F. ), )

   _HB_MEMBER { oBrwLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBrwLabel" }, .F., .F. ), )

   _HB_MEMBER { nCantidadLabels} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nCantidadLabels" }, .F., .F. ), )
   _HB_MEMBER { nUnidadesLabels} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nUnidadesLabels" }, .F., .F. ), )

   _HB_MEMBER { oMtrLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oMtrLabel" }, .F., .F. ), )
   _HB_MEMBER { nMtrLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "nMtrLabel" }, .F., .F. ), )

   _HB_MEMBER { oFilter} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oFilter" }, .F., .F. ), )

   _HB_MEMBER { lClose} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "lClose" }, .F., .F. ), )

   _HB_MEMBER { lErrorOnCreate} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "lErrorOnCreate" }, .F., .F. ), )

   _HB_MEMBER { oBtnFilter} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBtnFilter" }, .F., .F. ), )
   _HB_MEMBER { oBtnSiguiente} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBtnSiguiente" }, .F., .F. ), )
   _HB_MEMBER { oBtnAnterior} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBtnAnterior" }, .F., .F. ), )
   _HB_MEMBER { oBtnCancel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "oBtnCancel" }, .F., .F. ), )

   _HB_MEMBER { aSearch} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "aSearch" }, .F., .F. ), )

   _HB_MEMBER { cFileTmpLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cFileTmpLabel" }, .F., .F. ), )
   _HB_MEMBER { cAreaTmpLabel} ; IIF( !.F., s_oClass:AddMultiData(,, nScope + IIF( .F., 32, 0 ), { "cAreaTmpLabel" }, .F., .F. ), )

   _HB_MEMBER New(); IIF( .F., s_oClass:ModMethod( "New", @TFacturaProveedorLabelGenerator_New(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "New", @TFacturaProveedorLabelGenerator_New(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER Init(); IIF( .F., s_oClass:ModMethod( "Init", @TFacturaProveedorLabelGenerator_Init(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Init", @TFacturaProveedorLabelGenerator_Init(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER Create(); IIF( .F., s_oClass:ModMethod( "Create", @TFacturaProveedorLabelGenerator_Create(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "Create", @TFacturaProveedorLabelGenerator_Create(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER lCreateAuxiliar(); IIF( .F., s_oClass:ModMethod( "lCreateAuxiliar", @TFacturaProveedorLabelGenerator_lCreateAuxiliar(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lCreateAuxiliar", @TFacturaProveedorLabelGenerator_lCreateAuxiliar(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER lCreateTemporal(); IIF( .F., s_oClass:ModMethod( "lCreateTemporal", @TFacturaProveedorLabelGenerator_lCreateTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lCreateTemporal", @TFacturaProveedorLabelGenerator_lCreateTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER PrepareTemporal( oFr); IIF( .F., s_oClass:ModMethod( "PrepareTemporal", @TFacturaProveedorLabelGenerator_PrepareTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "PrepareTemporal", @TFacturaProveedorLabelGenerator_PrepareTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));
   _HB_MEMBER DestroyTemporal(); IIF( .F., s_oClass:ModMethod( "DestroyTemporal", @TFacturaProveedorLabelGenerator_DestroyTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DestroyTemporal", @TFacturaProveedorLabelGenerator_DestroyTemporal(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER End(); IIF( .F., s_oClass:ModMethod( "End", @TFacturaProveedorLabelGenerator_End(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "End", @TFacturaProveedorLabelGenerator_End(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER BotonAnterior(); IIF( .F., s_oClass:ModMethod( "BotonAnterior", @TFacturaProveedorLabelGenerator_BotonAnterior(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "BotonAnterior", @TFacturaProveedorLabelGenerator_BotonAnterior(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER BotonSiguiente(); IIF( .F., s_oClass:ModMethod( "BotonSiguiente", @TFacturaProveedorLabelGenerator_BotonSiguiente(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "BotonSiguiente", @TFacturaProveedorLabelGenerator_BotonSiguiente(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER PutLabel(); IIF( .F., s_oClass:ModMethod( "PutLabel", @TFacturaProveedorLabelGenerator_PutLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "PutLabel", @TFacturaProveedorLabelGenerator_PutLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER SelectAllLabels(); IIF( .F., s_oClass:ModMethod( "SelectAllLabels", @TFacturaProveedorLabelGenerator_SelectAllLabels(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SelectAllLabels", @TFacturaProveedorLabelGenerator_SelectAllLabels(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER AddLabel(); IIF( .F., s_oClass:ModMethod( "AddLabel", @TFacturaProveedorLabelGenerator_AddLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "AddLabel", @TFacturaProveedorLabelGenerator_AddLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER DelLabel(); IIF( .F., s_oClass:ModMethod( "DelLabel", @TFacturaProveedorLabelGenerator_DelLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "DelLabel", @TFacturaProveedorLabelGenerator_DelLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER EditLabel(); IIF( .F., s_oClass:ModMethod( "EditLabel", @TFacturaProveedorLabelGenerator_EditLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "EditLabel", @TFacturaProveedorLabelGenerator_EditLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER FilterLabel(); IIF( .F., s_oClass:ModMethod( "FilterLabel", @TFacturaProveedorLabelGenerator_FilterLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "FilterLabel", @TFacturaProveedorLabelGenerator_FilterLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER LoadAuxiliar(); IIF( .F., s_oClass:ModMethod( "LoadAuxiliar", @TFacturaProveedorLabelGenerator_LoadAuxiliar(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "LoadAuxiliar", @TFacturaProveedorLabelGenerator_LoadAuxiliar(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER lPrintLabels(); IIF( .F., s_oClass:ModMethod( "lPrintLabels", @TFacturaProveedorLabelGenerator_lPrintLabels(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "lPrintLabels", @TFacturaProveedorLabelGenerator_lPrintLabels(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER InitLabel( oLabel); IIF( .F., s_oClass:ModMethod( "InitLabel", @TFacturaProveedorLabelGenerator_InitLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "InitLabel", @TFacturaProveedorLabelGenerator_InitLabel(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

   _HB_MEMBER SelectColumn( oCombo); IIF( .F., s_oClass:ModMethod( "SelectColumn", @TFacturaProveedorLabelGenerator_SelectColumn(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ), s_oClass:AddMethod( "SelectColumn", @TFacturaProveedorLabelGenerator_SelectColumn(), nScope + IIF( .F., 16, 0 ) + IIF( .F., 1024, 0 ), .F. ));

; IF .F. ; __clsActive(s_oClass:hClass) ; s_oClass:Refresh() ; ELSE ; s_oClass:Create() ; END ; oClassInstance := __clsInst( s_oClass:hClass ) ; IF __ObjHasMsg( oClassInstance, "InitClass" ); oClassInstance:InitClass( hb_aParams() ) ; END ; ELSE ; oClassInstance := __clsInst( s_oClass:hClass ) ; END ; IF PCount() > 0 ; DIVERT TO (@DivertConstructorCall()) OF s_oClass ; END ; RETURN oClassInstance AS CLASS TFacturaProveedorLabelGenerator ;



UTILITY STATIC function TFacturaProveedorLabelGenerator_New() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   local oError
   local oBlock

   oBlock                  := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ::cSerieInicio       := ( dbfFacPrvT )->cSerFac
      ::cSerieFin          := ( dbfFacPrvT )->cSerFac

      ::nDocumentoInicio   := ( dbfFacPrvT )->nNumFac
      ::nDocumentoFin      := ( dbfFacPrvT )->nNumFac

      ::cSufijoInicio      := ( dbfFacPrvT )->cSufFac
      ::cSufijoFin         := ( dbfFacPrvT )->cSufFac

      ::nRecno             := ( dbfFacPrvT )->( Recno() )

      ::cFormatoLabel      := GetPvProfString( "Etiquetas", "Factura proveedor", Space( 3 ), cPatEmp() + "Empresa.Ini" )
      if len( ::cFormatoLabel ) < 3
         ::cFormatoLabel   := Space( 3 )
      end

      ::nMtrLabel          := 0

      ::nFilaInicio        := 1
      ::nColumnaInicio     := 1

      ::nCantidadLabels    := 1
      ::nUnidadesLabels    := 1

      ::aSearch            := { "Código", "Nombre" }

      ::lErrorOnCreate     := .F.

   RECOVER USING oError

      ::lErrorOnCreate     := .T.

      msgStop( "Error en la creación de generador de etiquetas" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end
   ErrorBlock( oBlock )

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_Init() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   local oError
   local oBlock
   local lError            := .F.

   oBlock                  := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if !lOpenFiles
         OpenFiles()
         ::lClose          := .T.
      end

      ::cSerieInicio       := ( dbfFacPrvT )->cSerFac
      ::cSerieFin          := ( dbfFacPrvT )->cSerFac

      ::nDocumentoInicio   := ( dbfFacPrvT )->nNumFac
      ::nDocumentoFin      := ( dbfFacPrvT )->nNumFac

      ::cSufijoInicio      := ( dbfFacPrvT )->cSufFac
      ::cSufijoFin         := ( dbfFacPrvT )->cSufFac

      ::nCantidadLabels    := 1
      ::nUnidadesLabels    := 1

      ::lErrorOnCreate     := .F.

   RECOVER USING oError

      ::lErrorOnCreate     := .T.

      msgStop( "Error en la creación de generador de etiquetas" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end
   ErrorBlock( oBlock )

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_Create() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   local oBtnPrp
   local oBtnMod
   local oBtnZoo
   local oGetOrd
   local cGetOrd     := Space( 100 )
    local oCbxOrd
   local cCbxOrd     := "Código"
   local aCbxOrd     := { "Código", "Nombre" }

   ::New()

   if !::lErrorOnCreate .AND. ::lCreateAuxiliar()

      ::oDlg = TDialog():New(,,,,, "SelectLabels_0",, .F.,,,,,, .F.,,,,,, .F., )





         ::oFld := TPages():Redefine( 10, ::oDlg, {"SelectLabels_1", "SelectLabels_2"},,,, )









         TBitmap():ReDefine( 500, "EnvioEtiquetas",, ::oDlg,,, .F., .F.,,, .F.,,, .F. )








         ::oSerieInicio := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::cSerieInicio, ::cSerieInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "@!", {||    ( ::cSerieInicio >= "A" .AND. ::cSerieInicio <= "Z" )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( ::oSerieInicio ) )}, {||  ( DwSerie( ::oSerieInicio ) )},,,, nil,,, )









         ::oSerieFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::cSerieFin, ::cSerieFin:= u ) }, ::oFld:aDialogs[ 1 ],, "@!", {||    ( ::cSerieFin >= "A" .AND. ::cSerieFin <= "Z" )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( ::oSerieFin ) )}, {||  ( DwSerie( ::oSerieFin ) )},,,, nil,,, )





         TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::nDocumentoInicio, ::nDocumentoInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





         TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::nDocumentoFin, ::nDocumentoFin:= u ) }, ::oFld:aDialogs[ 1 ],, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




         TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::cSufijoInicio, ::cSufijoInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "##",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




         TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::cSufijoFin, ::cSufijoFin:= u ) }, ::oFld:aDialogs[ 1 ],, "##",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )





         TGetHlp():ReDefine( 180, { | u | If( PCount()==0, ::nFilaInicio, ::nFilaInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





         TGetHlp():ReDefine( 190, { | u | If( PCount()==0, ::nColumnaInicio, ::nColumnaInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





         ::oFormatoLabel := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::cFormatoLabel, ::cFormatoLabel:= u ) }, ::oFld:aDialogs[ 1 ],,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 161 )

            ::oFormatoLabel:bValid  := {|| cDocumento( ::oFormatoLabel, ::oFormatoLabel:oHelpText, dbfDoc, "FL" ) }
            ::oFormatoLabel:bHelp   := {|| BrwDocumento( ::oFormatoLabel, ::oFormatoLabel:oHelpText, "FL" ) }

         TBtnBmp():ReDefine( 220, "Printer_pencil_16",,,,,{|| EdtDocumento( ::cFormatoLabel ) }, ::oFld:aDialogs[ 1 ], .F., , .F., "Modificar formato de etiquetas" )



         TRadMenu():Redefine( { | u | If( PCount()==0, ::nCantidadLabels, ::nCantidadLabels:= u ) }, ::oFld:aDialogs[ 1 ],, { 200, 201 },,,,, .F.,, )








         TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::nUnidadesLabels, ::nUnidadesLabels:= u ) }, ::oFld:aDialogs[ 1 ],, "99999",,,,,,, .F., {||     ( ::nCantidadLabels == 2 )},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )









         oGetOrd := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, cGetOrd, cGetOrd:= u ) }, ::oFld:aDialogs[ 2 ],,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "FIND",, )

         oGetOrd:bChange   := {| nKey, nFlags, oGet | AutoSeek( nKey, nFlags, oGet, ::oBrwLabel, ::cAreaTmpLabel ) }
         oGetOrd:bValid    := {|| ( ::cAreaTmpLabel )->( OrdScope( 0, nil ) ), ( ::cAreaTmpLabel )->( OrdScope( 1, nil ) ), ::oBrwLabel:Refresh(), .T. }





         oCbxOrd := TComboBox():ReDefine( 210, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, ::oFld:aDialogs[ 2 ],,,,,,, .F.,,,,,, )

         oCbxOrd:bChange   := {|| ::SelectColumn( oCbxOrd ) }




         TButton():ReDefine( 100, {||( ::PutLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 110, {||( ::SelectAllLabels( .T. ) )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 120, {||( ::SelectAllLabels( .F. ) )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 130, {||( ::AddLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 140, {||( ::DelLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 150, {||( ::EditLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         oBtnMod := TButton():ReDefine( 160, {||( nil )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         oBtnZoo := TButton():ReDefine( 165, {||( nil )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         ::oBtnFilter := TButton():ReDefine( 170, {||( ::FilterLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         oBtnPrp := TButton():ReDefine( 220, {||( nil )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )

         ::oBrwLabel                 := TXBrowse():New( ::oFld:aDialogs[ 2 ] )

         ::oBrwLabel:nMarqueeStyle   := 5
         ::oBrwLabel:nColSel         := 2

         ::oBrwLabel:lHScroll        := .F.
         ::oBrwLabel:cAlias          := ::cAreaTmpLabel

         ::oBrwLabel:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
         ::oBrwLabel:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
         ::oBrwLabel:bLDblClick      := {|| ::PutLabel() }

         ::oBrwLabel:CreateFromResource( 180 )

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Sl. Seleccionada"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->lLabel }
            :nWidth           := 20
            :SetCheck( { "Sel16", "Nil16" } )
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Código"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->cRef }
            :nWidth           := 80
            :cSortOrder       := "cRef"
            :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Nombre"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->cDetalle }
            :nWidth           := 250
            :cSortOrder       := "cDetalle"
            :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Prp. 1"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->cValPr1 }
            :nWidth           := 40
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Prp. 2"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->cValPr2 }
            :nWidth           := 40
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "N. etiquetas"
            :bEditValue       := {|| ( ::cAreaTmpLabel )->nLabel }
            :cEditPicture     := "@E 99,999"
            :nWidth           := 80
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :nEditType        := 1
            :bOnPostEdit      := {|o,x| if( dbDialogLock( ::cAreaTmpLabel ), ( ( ::cAreaTmpLabel )->nLabel := x, ( ::cAreaTmpLabel )->( dbUnlock() ) ), ) }
         end






         ::oMtrLabel := TMeter():ReDefine( 190, { | u | If( PCount()==0, ::nMtrLabel, ::nMtrLabel:= u ) }, ( ::cAreaTmpLabel  )->( lastrec() ), ::oFld:aDialogs[ 2 ], .F.,, "", .F.,,,, )

         ::oMtrLabel:nClrText   := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )
         ::oMtrLabel:nClrBar    := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )
         ::oMtrLabel:nClrBText  := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )








         ::oBtnAnterior := TButton():ReDefine( 20, {||( ::BotonAnterior() )}, ::oDlg,,, .F.,,,, .F. )




         ::oBtnSiguiente := TButton():ReDefine( 30, {||( ::BotonSiguiente() )}, ::oDlg,,, .F.,,,, .F. )




         ::oBtnCancel := TButton():ReDefine( 2, {||( ::oDlg:End() )}, ::oDlg,,, .F.,,,, .F. )

      ::oDlg:bStart  := {|| ::oBtnAnterior:Hide(), ::oFormatoLabel:lValid(), oBtnMod:Hide(), oBtnZoo:Hide(), oBtnPrp:Hide() }

      ::oDlg:Activate( ::oDlg:bLClicked, ::oDlg:bMoved, ::oDlg:bPainted, .T.,,,, ::oDlg:bRClicked,,, )

      ::End()

   end

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_lCreateAuxiliar() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   local oBlock
   local oError
   local lCreateAuxiliar   := .T.

   oBlock                  := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ::cAreaTmpLabel      := "Lbl" + cCurUsr()
      ::cFileTmpLabel      := cGetNewFileName( cPatTmp() + "Lbl" )

      dbCreate( ::cFileTmpLabel, aSqlStruct( aColFacPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), ::cFileTmpLabel, ::cAreaTmpLabel, .F. )

      if!( ::cAreaTmpLabel )->( neterr() )
         ( ::cAreaTmpLabel )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
         ( ::cAreaTmpLabel )->( OrdCreate( ::cFileTmpLabel, "cRef", "cRef", {|| Field->cRef } ) )

         ( ::cAreaTmpLabel )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
         ( ::cAreaTmpLabel )->( OrdCreate( ::cFileTmpLabel, "cDetalle", "Upper( cDetalle )", {|| Upper( Field->cDetalle ) } ) )
      end

      ( ::cAreaTmpLabel )->( OrdsetFocus( "cRef" ) )

   RECOVER USING oError

      lCreateAuxiliar      := .F.

      MsgStop( "Imposible crear fichero temporal" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

Return ( lCreateAuxiliar )



UTILITY STATIC function TFacturaProveedorLabelGenerator_BotonAnterior() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   ::oFld:GoPrev()

   ::oBtnAnterior:Hide()

   SetWindowText( ::oBtnSiguiente:hWnd, "Siguien&te >" )

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_BotonSiguiente() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   do case
      case ::oFld:nOption == 1

         if Empty( ::cFormatoLabel )

            MsgStop( "Debe cumplimentar un formato de etiquetas" )

         else

            ::LoadAuxiliar()

            ::oFld:GoNext()
            ::oBtnAnterior:Show()
            SetWindowText( ::oBtnSiguiente:hWnd, "&Terminar" )

         end

      case ::oFld:nOption == 2

         if ::lPrintLabels()

            SetWindowText( ::oBtnCancel:hWnd, "&Cerrar" )

         end

   end

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_lCreateTemporal() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   local n
   local nRec
   local oBlock
   local oError
   local nBlancos
   local lCreateTemporal   := .T.

   oBlock                  := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      tmpFacPrvL           := "LblFac"
      filFacPrvL           := cGetNewFileName( cPatTmp() + "LblFac" )

      dbCreate( filFacPrvL, aSqlStruct( aColFacPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), filFacPrvL, tmpFacPrvL, .F. )

      ( tmpFacPrvL )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
      ( tmpFacPrvL )->( OrdCreate( filFacPrvL, "nNumFac", "cSerFac + Str( nNumFac ) + cSufFac", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac } ) )

      nRec                 := ( ::cAreaTmpLabel )->( Recno() )

      ( ::cAreaTmpLabel )->( dbGoTop() )
      while !( ::cAreaTmpLabel )->( eof() )

         if ( ::cAreaTmpLabel )->lLabel
            for n := 1 to ( ::cAreaTmpLabel )->nLabel
               dbPass( ::cAreaTmpLabel, tmpFacPrvL, .T. )
            next
         end

         ( ::cAreaTmpLabel )->( dbSkip() )

      end
      ( tmpFacPrvL )->( dbGoTop() )

      ( ::cAreaTmpLabel )->( dbGoTo( nRec ) )

   RECOVER USING oError

      lCreateTemporal      := .F.

      MsgStop( "Imposible abrir ficheros de artículos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

Return ( lCreateTemporal )



UTILITY STATIC function TFacturaProveedorLabelGenerator_DestroyTemporal() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   if ( tmpFacPrvL )->( Used() )
      ( tmpFacPrvL )->( dbCloseArea() )
   end

   dbfErase( filFacPrvL )

   tmpFacPrvL           := nil

   SysRefresh()

Return ( .T. )



UTILITY STATIC function TFacturaProveedorLabelGenerator_PrepareTemporal( oFr) ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   local n
   local nBlancos       := 0
   local nPaperHeight   := oFr:GetProperty( "MainPage", "PaperHeight" ) * 3.77953
   local nHeight        := oFr:GetProperty( "CabeceraColumnas", "Height" )
   local nColumns       := oFr:GetProperty( "MainPage", "Columns" )
   local nItemsInColumn := int( nPaperHeight / nHeight )

   nBlancos             := ( ::nColumnaInicio - 1 ) * nItemsInColumn
   nBlancos             += ( ::nFilaInicio - 1 )

   for n := 1 to nBlancos
      dbPass( dbBlankRec( dbfFacPrvL ), tmpFacPrvL, .T. )
   next

   ( tmpFacPrvL )->( dbGoTop() )

Return ( .T. )



UTILITY STATIC function TFacturaProveedorLabelGenerator_lPrintLabels() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   local oFr

   local nCopies      := 1
   local nDevice      := 2
   local cPrinter     := PrnGetName()

   if ::lCreateTemporal()

      SysRefresh()

      oFr                  := frReportManager():New()

      oFr:LoadLangRes(     "Spanish.Xml" )

      oFr:SetIcon( 1 )

      oFr:SetTitle(        "Diseñador de documentos" )






      oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





      DataLabel( oFr, .T. )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





         ::PrepareTemporal( oFr )





         oFr:PrepareReport()





         do case
            case nDevice == 2
               oFr:ShowPreparedReport()

            case nDevice == 1
               oFr:PrintOptions:SetPrinter( cPrinter )
               oFr:PrintOptions:SetCopies( nCopies )
               oFr:PrintOptions:SetShowDialog( .F. )
               oFr:Print()

            case nDevice == 3
               oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
               oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
               oFr:SetProperty(  "PDFExport", "Outline",          .T. )
               oFr:DoExport(     "PDFExport" )

         end

      end





      oFr:DestroyFr()





      ::DestroyTemporal()

   end

Return .T.



UTILITY STATIC function TFacturaProveedorLabelGenerator_End() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   if !Empty( ::nRecno )
      ( dbfFacPrvT )->( dbGoTo( ::nRecno ) )
   end

   if IsTrue( ::lClose )
      CloseFiles()
   end

   if !Empty( ::cAreaTmpLabel ) .AND. ( ::cAreaTmpLabel )->( Used() )
      ( ::cAreaTmpLabel )->( dbCloseArea() )
   end

   dbfErase( ::cFileTmpLabel )

   WritePProString( "Etiquetas", "Factura proveedor", ::cFormatoLabel, cPatEmp() + "Empresa.Ini" )

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_PutLabel() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   ( ::cAreaTmpLabel )->lLabel   := !( ::cAreaTmpLabel )->lLabel

   ::oBrwLabel:Refresh()
   ::oBrwLabel:Select()

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_SelectAllLabels( lSelect) ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

    local n            := 0
   local nRecno   := ( ::cAreaTmpLabel )->( Recno() )

    CursorWait()

   ( ::cAreaTmpLabel )->( dbGoTop() )
   while !( ::cAreaTmpLabel )->( eof() )

      ( ::cAreaTmpLabel )->lLabel := lSelect

      ( ::cAreaTmpLabel )->( dbSkip() )

      ::oMtrLabel:Set( ++n )

   end

   ( ::cAreaTmpLabel )->( dbGoTo( nRecno ) )

   ::oBrwLabel:Refresh()

   ::oMtrLabel:Set( 0 )
   ::oMtrLabel:Refresh()

    CursorArrow()

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_AddLabel() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   ( ::cAreaTmpLabel )->nLabel++

   ::oBrwLabel:Refresh()
   ::oBrwLabel:SetFocus()

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_DelLabel() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   if ( ::cAreaTmpLabel )->nLabel > 1
      ( ::cAreaTmpLabel )->nLabel--
   end

   ::oBrwLabel:Refresh()
   ::oBrwLabel:SetFocus()

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_EditLabel() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   ::oBrwLabel:aCols[ 6 ]:Edit()

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_FilterLabel() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   if Empty( ::oFilter )
      ::oFilter      := TDlgFlt():New( aColFacPrv(), ::cAreaTmpLabel )
   end

   if !Empty( ::oFilter )

      ::oFilter:Resource()

      if ::oFilter:cExpFilter <> nil
         SetWindowText( ::oBtnFilter:hWnd, "Filtro activo" )
      else
         SetWindowText( ::oBtnFilter:hWnd, "Filtrar" )
      end

   end

   ::oBrwLabel:Refresh()
   ::oBrwLabel:SetFocus()

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_LoadAuxiliar() ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   local nRec
   local nOrd





   ( ::cAreaTmpLabel )->( __dbZap() )





   nRec           := ( dbfFacPrvT )->( Recno() )
   nOrd           := ( dbfFacPrvT )->( OrdSetFocus( "nNumFac" ) )

   if ( dbfFacPrvT )->( dbSeek( ::cSerieInicio + Str( ::nDocumentoInicio, 9 ) + ::cSufijoInicio, .T. ) )



      while ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac >= ::cSerieInicio + Str( ::nDocumentoInicio, 9 ) + ::cSufijoInicio .AND.  ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac <= ::cSerieFin + Str( ::nDocumentoFin, 9 ) + ::cSufijoFin          .AND.  !( dbfFacPrvT )->( eof() )

         if ( dbfFacPrvL )->( dbSeek( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac ) )

            while ( ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac == ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac ) .AND. ( dbfFacPrvL )->( !eof() )

               if !Empty( ( dbfFacPrvL )->cRef )

                  ( ::cAreaTmpLabel )->( dbAppend() )

                  ( ::cAreaTmpLabel )->cSerFac  := ( dbfFacPrvL )->cSerFac
                  ( ::cAreaTmpLabel )->nNumFac  := ( dbfFacPrvL )->nNumFac
                  ( ::cAreaTmpLabel )->cSufFac  := ( dbfFacPrvL )->cSufFac
                  ( ::cAreaTmpLabel )->cRef     := ( dbfFacPrvL )->cRef
                  ( ::cAreaTmpLabel )->cRefPrv  := ( dbfFacPrvL )->cRefPrv
                  ( ::cAreaTmpLabel )->cDetalle := ( dbfFacPrvL )->cDetalle
                  ( ::cAreaTmpLabel )->nPreUnit := ( dbfFacPrvL )->nPreUnit
                  ( ::cAreaTmpLabel )->nIva     := ( dbfFacPrvL )->nIva
                  ( ::cAreaTmpLabel )->nReq     := ( dbfFacPrvL )->nReq
                  ( ::cAreaTmpLabel )->nCanEnt  := ( dbfFacPrvL )->nCanEnt
                  ( ::cAreaTmpLabel )->lControl := ( dbfFacPrvL )->lControl
                  ( ::cAreaTmpLabel )->cUnidad  := ( dbfFacPrvL )->cUnidad
                  ( ::cAreaTmpLabel )->nUniCaja := ( dbfFacPrvL )->nUniCaja
                  ( ::cAreaTmpLabel )->lChgLin  := ( dbfFacPrvL )->lChgLin
                  ( ::cAreaTmpLabel )->mLngDes  := ( dbfFacPrvL )->mLngDes
                  ( ::cAreaTmpLabel )->nDtoLin  := ( dbfFacPrvL )->nDtoLin
                  ( ::cAreaTmpLabel )->nDtoPrm  := ( dbfFacPrvL )->nDtoPrm
                  ( ::cAreaTmpLabel )->nDtoRap  := ( dbfFacPrvL )->nDtoRap
                  ( ::cAreaTmpLabel )->nPreCom  := ( dbfFacPrvL )->nPreCom
                  ( ::cAreaTmpLabel )->lBnfLin1 := ( dbfFacPrvL )->lBnfLin1
                  ( ::cAreaTmpLabel )->lBnfLin2 := ( dbfFacPrvL )->lBnfLin2
                  ( ::cAreaTmpLabel )->lBnfLin3 := ( dbfFacPrvL )->lBnfLin3
                  ( ::cAreaTmpLabel )->lBnfLin4 := ( dbfFacPrvL )->lBnfLin4
                  ( ::cAreaTmpLabel )->lBnfLin5 := ( dbfFacPrvL )->lBnfLin5
                  ( ::cAreaTmpLabel )->lBnfLin6 := ( dbfFacPrvL )->lBnfLin6
                  ( ::cAreaTmpLabel )->nBnfLin1 := ( dbfFacPrvL )->nBnfLin1
                  ( ::cAreaTmpLabel )->nBnfLin2 := ( dbfFacPrvL )->nBnfLin2
                  ( ::cAreaTmpLabel )->nBnfLin3 := ( dbfFacPrvL )->nBnfLin3
                  ( ::cAreaTmpLabel )->nBnfLin4 := ( dbfFacPrvL )->nBnfLin4
                  ( ::cAreaTmpLabel )->nBnfLin5 := ( dbfFacPrvL )->nBnfLin5
                  ( ::cAreaTmpLabel )->nBnfLin6 := ( dbfFacPrvL )->nBnfLin6
                  ( ::cAreaTmpLabel )->nBnfSbr1 := ( dbfFacPrvL )->nBnfSbr1
                  ( ::cAreaTmpLabel )->nBnfSbr2 := ( dbfFacPrvL )->nBnfSbr2
                  ( ::cAreaTmpLabel )->nBnfSbr3 := ( dbfFacPrvL )->nBnfSbr3
                  ( ::cAreaTmpLabel )->nBnfSbr4 := ( dbfFacPrvL )->nBnfSbr4
                  ( ::cAreaTmpLabel )->nBnfSbr5 := ( dbfFacPrvL )->nBnfSbr5
                  ( ::cAreaTmpLabel )->nBnfSbr6 := ( dbfFacPrvL )->nBnfSbr6
                  ( ::cAreaTmpLabel )->nPvpLin1 := ( dbfFacPrvL )->nPvpLin1
                  ( ::cAreaTmpLabel )->nPvpLin2 := ( dbfFacPrvL )->nPvpLin2
                  ( ::cAreaTmpLabel )->nPvpLin3 := ( dbfFacPrvL )->nPvpLin3
                  ( ::cAreaTmpLabel )->nPvpLin4 := ( dbfFacPrvL )->nPvpLin4
                  ( ::cAreaTmpLabel )->nPvpLin5 := ( dbfFacPrvL )->nPvpLin5
                  ( ::cAreaTmpLabel )->nPvpLin6 := ( dbfFacPrvL )->nPvpLin6
                  ( ::cAreaTmpLabel )->nIvaLin1 := ( dbfFacPrvL )->nIvaLin1
                  ( ::cAreaTmpLabel )->nIvaLin2 := ( dbfFacPrvL )->nIvaLin2
                  ( ::cAreaTmpLabel )->nIvaLin3 := ( dbfFacPrvL )->nIvaLin3
                  ( ::cAreaTmpLabel )->nIvaLin4 := ( dbfFacPrvL )->nIvaLin4
                  ( ::cAreaTmpLabel )->nIvaLin5 := ( dbfFacPrvL )->nIvaLin5
                  ( ::cAreaTmpLabel )->nIvaLin6 := ( dbfFacPrvL )->nIvaLin6
                  ( ::cAreaTmpLabel )->nIvaLin  := ( dbfFacPrvL )->nIvaLin
                  ( ::cAreaTmpLabel )->lIvaLin  := ( dbfFacPrvL )->lIvaLin
                  ( ::cAreaTmpLabel )->cCodPr1  := ( dbfFacPrvL )->cCodPr1
                  ( ::cAreaTmpLabel )->cCodPr2  := ( dbfFacPrvL )->cCodPr2
                  ( ::cAreaTmpLabel )->cValPr1  := ( dbfFacPrvL )->cValPr1
                  ( ::cAreaTmpLabel )->cValPr2  := ( dbfFacPrvL )->cValPr2
                  ( ::cAreaTmpLabel )->nFacCnv  := ( dbfFacPrvL )->nFacCnv
                  ( ::cAreaTmpLabel )->cAlmLin  := ( dbfFacPrvL )->cAlmLin
                  ( ::cAreaTmpLabel )->nCtlStk  := ( dbfFacPrvL )->nCtlStk
                  ( ::cAreaTmpLabel )->lLote    := ( dbfFacPrvL )->lLote
                  ( ::cAreaTmpLabel )->nLote    := ( dbfFacPrvL )->nLote
                  ( ::cAreaTmpLabel )->cLote    := ( dbfFacPrvL )->cLote
                  ( ::cAreaTmpLabel )->nNumLin  := ( dbfFacPrvL )->nNumLin
                  ( ::cAreaTmpLabel )->nUndKit  := ( dbfFacPrvL )->nUndKit
                  ( ::cAreaTmpLabel )->lKitArt  := ( dbfFacPrvL )->lKitArt
                  ( ::cAreaTmpLabel )->lKitChl  := ( dbfFacPrvL )->lKitChl
                  ( ::cAreaTmpLabel )->lKitPrc  := ( dbfFacPrvL )->lKitPrc
                  ( ::cAreaTmpLabel )->lImpLin  := ( dbfFacPrvL )->lImpLin
                  ( ::cAreaTmpLabel )->mNumSer  := ( dbfFacPrvL )->mNumSer
                  ( ::cAreaTmpLabel )->cCodUbi1 := ( dbfFacPrvL )->cCodUbi1
                  ( ::cAreaTmpLabel )->cCodUbi2 := ( dbfFacPrvL )->cCodUbi2
                  ( ::cAreaTmpLabel )->cCodUbi3 := ( dbfFacPrvL )->cCodUbi3
                  ( ::cAreaTmpLabel )->cValUbi1 := ( dbfFacPrvL )->cValUbi1
                  ( ::cAreaTmpLabel )->cValUbi2 := ( dbfFacPrvL )->cValUbi2
                  ( ::cAreaTmpLabel )->cValUbi3 := ( dbfFacPrvL )->cValUbi3
                  ( ::cAreaTmpLabel )->cNomUbi1 := ( dbfFacPrvL )->cNomUbi1
                  ( ::cAreaTmpLabel )->cNomUbi2 := ( dbfFacPrvL )->cNomUbi2
                  ( ::cAreaTmpLabel )->cNomUbi3 := ( dbfFacPrvL )->cNomUbi3
                  ( ::cAreaTmpLabel )->cCodFam  := ( dbfFacPrvL )->cCodFam
                  ( ::cAreaTmpLabel )->cGrpFam  := ( dbfFacPrvL )->cGrpFam
                  ( ::cAreaTmpLabel )->mObsLin  := ( dbfFacPrvL )->mObsLin
                  ( ::cAreaTmpLabel )->nPvpRec  := ( dbfFacPrvL )->nPvpRec
                  ( ::cAreaTmpLabel )->nUndLin  := nTotNFacPrv( dbfFacPrvL )
                  ( ::cAreaTmpLabel )->lLabel   := .T.

                  if ::nCantidadLabels == 1
                  ( ::cAreaTmpLabel )->nLabel   := nTotNFacPrv( dbfFacPrvL )
                  else
                  ( ::cAreaTmpLabel )->nLabel   := ::nUnidadesLabels
                  end

               end

               ( dbfFacPrvL )->( dbSkip() )

            end

         end

         ( dbfFacPrvT )->( dbSkip() )

      end

   end

   ( dbfFacPrvT )->( OrdSetFocus( nOrd ) )
   ( dbfFacPrvT )->( dbGoTo( nRec ) )

   ( ::cAreaTmpLabel )->( dbGoTop() )

   ::oBrwLabel:Refresh()

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_InitLabel( oLabel) ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   local nStartRow

   if ::nFilaInicio > 1
      nStartRow            := oLabel:nStartRow
      nStartRow            += ( ::nFilaInicio - 1 ) * ( oLabel:nLblHeight + oLabel:nVSeparator )

      if nStartRow < oLabel:nBottomRow
         oLabel:nStartRow  := nStartRow
      end
   end

   if ::nColumnaInicio > 1 .AND. ::nColumnaInicio <= oLabel:nLblOnLine
      oLabel:nLblCurrent   := ::nColumnaInicio
   end

Return ( Self )



UTILITY STATIC function TFacturaProveedorLabelGenerator_SelectColumn( oCombo) ; local Self AS CLASS TFacturaProveedorLabelGenerator := QSelf() AS CLASS TFacturaProveedorLabelGenerator

   local oCol
   local cOrd                    := oCombo:VarGet()

   if ::oBrwLabel <> nil

      with object ::oBrwLabel

         for each oCol in :aCols

            if Eq( cOrd, oCol:cHeader )
               oCol:cOrder       := "A"
               oCol:SetOrder()
            else
               oCol:cOrder       := " "
            end

         next

      end

      ::oBrwLabel:Refresh()

   end

Return ( Self )



Static Function DataLabel( oFr, lTemporal )





   oFr:ClearDataSets()

   if lTemporal
      oFr:SetWorkArea(  "Lineas de facturas", ( tmpFacPrvL )->( Select() ), .F., { 0, 0, 0 } )
   else
      oFr:SetWorkArea(  "Lineas de facturas", ( dbfFacPrvL )->( Select() ), .F., { 0, 2, 20 } )
   end

   oFr:SetFieldAliases( "Lineas de facturas", cItemsToReport( aColFacPrv() ) )

   oFr:SetWorkArea(     "Facturas", ( dbfFacPrvT )->( Select() ) )
   oFr:SetFieldAliases( "Facturas", cItemsToReport( aItmFacPrv() ) )

   oFr:SetWorkArea(     "Artículos", ( dbfArticulo )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Precios por propiedades", ( dbfArtCom )->( Select() ) )
   oFr:SetFieldAliases( "Precios por propiedades", cItemsToReport( aItmVta() ) )

   oFr:SetWorkArea(     "Incidencias de facturas", ( dbfFacPrvI )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de facturas", cItemsToReport( aIncFacPrv() ) )

   oFr:SetWorkArea(     "Documentos de facturas", ( dbfFacPrvD )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de facturas", cItemsToReport( aFacPrvDoc() ) )

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Proveedores", ( dbfPrv )->( Select() ) )
   oFr:SetFieldAliases( "Proveedores", cItemsToReport( aItmPrv() ) )

   oFr:SetWorkArea(     "Almacenes", ( dbfAlm )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Artículos", ( dbfArticulo )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Código de proveedores", ( dbfArtPrv )->( Select() ) )
   oFr:SetFieldAliases( "Código de proveedores", cItemsToReport( aItmArtPrv() ) )

   oFr:SetWorkArea(     "Unidades de medición",  oUndMedicion:Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( oUndMedicion:oDbf ) )

   oFr:SetWorkArea(     "Bancos", ( dbfPrvBnc )->( Select() ) )
   oFr:SetFieldAliases( "Bancos", cItemsToReport( aPrvBnc() ) )

   if lTemporal
      oFr:SetMasterDetail( "Lineas de facturas", "Facturas",                  {|| ( tmpFacPrvL )->cSerFac + Str( ( tmpFacPrvL )->nNumFac ) + ( tmpFacPrvL )->cSufFac } )
      oFr:SetMasterDetail( "Lineas de facturas", "Artículos",                 {|| ( tmpFacPrvL )->cRef } )
      oFr:SetMasterDetail( "Lineas de facturas", "Precios por propiedades",   {|| ( tmpFacPrvL )->cRef + ( tmpFacPrvL )->cCodPr1 + ( tmpFacPrvL )->cCodPr2 + ( tmpFacPrvL )->cValPr1 + ( tmpFacPrvL )->cValPr2 } )
      oFr:SetMasterDetail( "Lineas de facturas", "Incidencias de facturas",   {|| ( tmpFacPrvL )->cSerFac + Str( ( tmpFacPrvL )->nNumFac ) + ( tmpFacPrvL )->cSufFac } )
      oFr:SetMasterDetail( "Lineas de facturas", "Documentos de facturas",    {|| ( tmpFacPrvL )->cSerFac + Str( ( tmpFacPrvL )->nNumFac ) + ( tmpFacPrvL )->cSufFac } )
   else
      oFr:SetMasterDetail( "Lineas de facturas", "Facturas",                  {|| ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac } )
      oFr:SetMasterDetail( "Lineas de facturas", "Artículos",                 {|| ( dbfFacPrvL )->cRef } )
      oFr:SetMasterDetail( "Lineas de facturas", "Precios por propiedades",   {|| ( dbfFacPrvL )->cRef + ( dbfFacPrvL )->cCodPr1 + ( dbfFacPrvL )->cCodPr2 + ( dbfFacPrvL )->cValPr1 + ( dbfFacPrvL )->cValPr2 } )
      oFr:SetMasterDetail( "Lineas de facturas", "Incidencias de facturas",   {|| ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac } )
      oFr:SetMasterDetail( "Lineas de facturas", "Documentos de facturas",    {|| ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac } )
   end

   oFr:SetMasterDetail(    "Facturas", "Proveedores",                         {|| ( dbfFacPrvT )->cCodPrv } )
   oFr:SetMasterDetail(    "Facturas", "Almacenes",                           {|| ( dbfFacPrvT )->cCodAlm } )
   oFr:SetMasterDetail(    "Facturas", "Formas de pago",                      {|| ( dbfFacPrvT )->cCodPago} )
   oFr:SetMasterDetail(    "Facturas", "Bancos",                              {|| ( dbfFacPrvT )->cCodPrv } )
   oFr:SetMasterDetail(    "Facturas", "Empresa",                             {|| cCodigoEmpresaEnUso() } )

   oFr:SetResyncPair(      "Lineas de facturas", "Facturas" )
   oFr:SetResyncPair(      "Lineas de facturas", "Artículos" )
   oFr:SetResyncPair(      "Lineas de facturas", "Precios por propiedades" )
   oFr:SetResyncPair(      "Lineas de facturas", "Incidencias de facturas" )
   oFr:SetResyncPair(      "Lineas de facturas", "Documentos de facturas" )

   oFr:SetResyncPair(      "Facturas", "Proveedores" )
   oFr:SetResyncPair(      "Facturas", "Almacenes" )
   oFr:SetResyncPair(      "Facturas", "Formas de pago" )
   oFr:SetResyncPair(      "Facturas", "Bancos" )
   oFr:SetResyncPair(      "Facturas", "Empresa" )

Return nil



Function DesignLabelFacPrv( oFr, dbfDoc )

   local oLabel   := TFacturaProveedorLabelGenerator():Init()

   if !oLabel:lErrorOnCreate





      DataLabel( oFr, .F. )






      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraColumnas",  "MainPage",       6 )
         oFr:SetProperty(     "CabeceraColumnas",  "Top",            200 )
         oFr:SetProperty(     "CabeceraColumnas",  "Height",         100 )
         oFr:SetObjProperty(  "CabeceraColumnas",  "DataSet",        "Lineas de facturas" )

      end





      VariableReport( oFr )





      oFr:DesignReport()





      oFr:DestroyFr()





      oLabel:DestroyTemporal()





      oLabel:End()

   else

      Return .F.

   end

Return .T.







Static Function DataReport( oFr )





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "Facturas", ( dbfFacPrvT )->( Select() ), .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "Facturas", cItemsToReport( aItmFacPrv() ) )

   oFr:SetWorkArea(     "Lineas de facturas", ( dbfFacPrvL )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de facturas", cItemsToReport( aColFacPrv() ) )

   oFr:SetWorkArea(     "Incidencias de facturas", ( dbfFacPrvI )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de facturas", cItemsToReport( aIncFacPrv() ) )

   oFr:SetWorkArea(     "Documentos de facturas", ( dbfFacPrvD )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de facturas", cItemsToReport( aFacPrvDoc() ) )

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Proveedores", ( dbfPrv )->( Select() ) )
   oFr:SetFieldAliases( "Proveedores", cItemsToReport( aItmPrv() ) )

   oFr:SetWorkArea(     "Almacenes", ( dbfAlm )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Artículos", ( dbfArticulo )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Código de proveedores", ( dbfArtPrv )->( Select() ) )
   oFr:SetFieldAliases( "Código de proveedores", cItemsToReport( aItmArtPrv() ) )

   oFr:SetWorkArea(     "Unidades de medición",  oUndMedicion:Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( oUndMedicion:oDbf ) )

   oFr:SetWorkArea(     "Bancos", ( dbfPrvBnc )->( Select() ) )
   oFr:SetFieldAliases( "Bancos", cItemsToReport( aPrvBnc() ) )

   oFr:SetMasterDetail( "Facturas", "Lineas de facturas",      {|| ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Incidencias de facturas", {|| ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Documentos de facturas",  {|| ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Proveedores",             {|| ( dbfFacPrvT )->cCodPrv } )
   oFr:SetMasterDetail( "Facturas", "Almacenes",               {|| ( dbfFacPrvT )->cCodAlm } )
   oFr:SetMasterDetail( "Facturas", "Formas de pago",          {|| ( dbfFacPrvT )->cCodPago} )
   oFr:SetMasterDetail( "Facturas", "Bancos",                  {|| ( dbfFacPrvT )->cCodPrv } )
   oFr:SetMasterDetail( "Facturas", "Empresa",                 {|| cCodigoEmpresaEnUso() } )

   oFr:SetMasterDetail( "Lineas de facturas", "Artículos",               {|| ( dbfFacPrvL )->cRef } )
   oFr:SetMasterDetail( "Lineas de facturas", "Código de proveedores",   {|| ( dbfFacPrvT )->cCodPrv + ( dbfFacPrvL )->cRef } )
   oFr:SetMasterDetail( "Lineas de facturas", "Unidades de medición",    {|| ( dbfFacPrvL )->cUnidad } )

   oFr:SetResyncPair(   "Facturas", "Lineas de facturas" )
   oFr:SetResyncPair(   "Facturas", "Incidencias de facturas" )
   oFr:SetResyncPair(   "Facturas", "Documentos de facturas" )
   oFr:SetResyncPair(   "Facturas", "Proveedores" )
   oFr:SetResyncPair(   "Facturas", "Almacenes" )
   oFr:SetResyncPair(   "Facturas", "Formas de pago" )
   oFr:SetResyncPair(   "Facturas", "Bancos" )

   oFr:SetResyncPair(   "Lineas de facturas", "Artículos" )
   oFr:SetResyncPair(   "Lineas de facturas", "Código de proveedores" )
   oFr:SetResyncPair(   "Lineas de facturas", "Unidades de medición" )

Return nil



Static Function VariableReport( oFr )

   oFr:DeleteCategory(  "Facturas" )
   oFr:DeleteCategory(  "Lineas de facturas" )





   oFr:AddVariable(     "Facturas",             "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Facturas",             "Total factura",                       "GetHbVar('nTotFac')" )
   oFr:AddVariable(     "Facturas",             "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Facturas",             "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Facturas",             "Total primer descuento definible",    "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Facturas",             "Total segundo descuento definible",   "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Facturas",             "Total neto",                          "GetHbVar('nTotNet')" )
   oFr:AddVariable(     "Facturas",             "Total " + cImp(),                           "GetHbVar('nTotIva')" )
   oFr:AddVariable(     "Facturas",             "Total RE",                            "GetHbVar('nTotReq')" )
   oFr:AddVariable(     "Facturas",             "Total retenciones por IRPF",          "GetHbVar('nTotRet')" )
   oFr:AddVariable(     "Facturas",             "Total impuestos",                     "GetHbVar('nTotImp')" )
   oFr:AddVariable(     "Facturas",             "Total unidades",                      "GetHbVar('nTotUnd')" )
   oFr:AddVariable(     "Facturas",             "Bruto primer tipo de " + cImp(),            "GetHbArrayVar('aIvaUno',1)" )
   oFr:AddVariable(     "Facturas",             "Bruto segundo tipo de " + cImp(),           "GetHbArrayVar('aIvaDos',1)" )
   oFr:AddVariable(     "Facturas",             "Bruto tercer tipo de " + cImp(),            "GetHbArrayVar('aIvaTre',1)" )
   oFr:AddVariable(     "Facturas",             "Base primer tipo de " + cImp(),             "GetHbArrayVar('aIvaUno',2)" )
   oFr:AddVariable(     "Facturas",             "Base segundo tipo de " + cImp(),            "GetHbArrayVar('aIvaDos',2)" )
   oFr:AddVariable(     "Facturas",             "Base tercer tipo de " + cImp(),             "GetHbArrayVar('aIvaTre',2)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje primer tipo " + cImp(),          "GetHbArrayVar('aIvaUno',3)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje segundo tipo " + cImp(),         "GetHbArrayVar('aIvaDos',3)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje tercer tipo " + cImp(),          "GetHbArrayVar('aIvaTre',3)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje primer tipo RE",           "GetHbArrayVar('aIvaUno',4)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje segundo tipo RE",          "GetHbArrayVar('aIvaDos',4)" )
   oFr:AddVariable(     "Facturas",             "Porcentaje tercer tipo RE",           "GetHbArrayVar('aIvaTre',4)" )
   oFr:AddVariable(     "Facturas",             "Importe primer tipo " + cImp(),             "GetHbArrayVar('aIvaUno',5)" )
   oFr:AddVariable(     "Facturas",             "Importe segundo tipo " + cImp(),            "GetHbArrayVar('aIvaDos',5)" )
   oFr:AddVariable(     "Facturas",             "Importe tercer tipo " + cImp(),             "GetHbArrayVar('aIvaTre',5)" )
   oFr:AddVariable(     "Facturas",             "Importe primer RE",                   "GetHbArrayVar('aIvaUno',6)" )
   oFr:AddVariable(     "Facturas",             "Importe segundo RE",                  "GetHbArrayVar('aIvaDos',6)" )
   oFr:AddVariable(     "Facturas",             "Importe tercer RE",                   "GetHbArrayVar('aIvaTre',6)" )

   oFr:AddVariable(     "Facturas",             "Cuenta bancaria proveedor",                 "CallHbFunc('cCtaFacPrv')" )

   oFr:AddVariable(     "Lineas de facturas",   "Código del artículo con propiedades",       "CallHbFunc('cPrpFacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Detalle del artículo",                      "CallHbFunc('cDesFacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Total unidades artículo",                   "CallHbFunc('nTotNFacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Precio unitario de factura",                "CallHbFunc('nTotUFacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Total línea de factura",                    "CallHbFunc('nTotLFacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Código de barras para primera propiedad",   "CallHbFunc('cBarPrp1FacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Código de barras para segunda propiedad",   "CallHbFunc('cBarPrp2FacPrv')" )

Return nil



Function DesignReportFacPrv( oFr, dbfDoc )

   local lOpen    := .F.
   local lFlag    := .F.





   if lOpenFiles
      lFlag       := .T.
   else
      if Openfiles()
         lFlag    := .T.
         lOpen    := .T.
      else
         lFlag    := .F.
      end
   end

   if lFlag





      DataReport( oFr )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "CallHbFunc('nTotFacPrv');"                                 + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "CabeceraColumnas",  "MainPage", 6 )
         oFr:SetProperty(     "CabeceraColumnas",  "Top", 200 )
         oFr:SetProperty(     "CabeceraColumnas",  "Height", 0 )
         oFr:SetProperty(     "CabeceraColumnas",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "CabeceraColumnas",  "DataSet", "Facturas" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de facturas" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      VariableReport( oFr )





      oFr:SetTabTreeExpanded( 16, .F. )
      oFr:DesignReport()





      oFr:DestroyFr()





      if lOpen
         CloseFiles()
      end

   else

      Return .F.

   end

Return .T.



Function PrintReportFacPrv( nDevice, nCopies, cPrinter, dbfDoc )

   local oFr
   local cFilePdf       := cPatTmp() + "FacturaProveedor" + StrTran( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac, " ", "" ) + ".Pdf"

   IIF( nDevice == nil, nDevice := 2, ) ;
   IIF( nCopies == nil, nCopies := 1, ) ;
   IIF( cPrinter == nil, cPrinter := PrnGetName(), ) ;

   SysRefresh()

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





   DataReport( oFr )






   if !Empty( ( dbfDoc )->mReport )

      oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





      VariableReport( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2
            oFr:PrepareReport()
            oFr:ShowPreparedReport()

         case nDevice == 1
            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:PrepareReport()
            oFr:Print()

         case nDevice == 3
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatTmp() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .T. )
            oFr:DoExport(     "PDFExport" )

         case nDevice == 6

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatTmp() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf  )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .F. )
            oFr:DoExport(     "PDFExport" )

            if file( cFilePdf )

               with object ( TGenMailing():New() )

                  :SetTypeDocument( "nFacPrv" )
                  :SetDe(           uFieldEmpresa( "cNombre" ) )
                  :SetCopia(        uFieldEmpresa( "cCcpMai" ) )
                  :SetAdjunto(      cFilePdf )
                  :SetPara(         RetFld( ( dbfFacPrvT )->cCodPrv, dbfPrv, "cMeiInt" ) )
                  :SetAsunto(       "Envio de factura de proveedor número " + ( dbfFacPrvT )->cSerFac + "/" + Alltrim( Str( ( dbfFacPrvT )->nNumFac ) ) )
                  :SetMensaje(      "Adjunto le remito nuestra factura de proveedor " + ( dbfFacPrvT )->cSerFac + "/" + Alltrim( Str( ( dbfFacPrvT )->nNumFac ) ) + Space( 1 ) )
                  :SetMensaje(      "de fecha " + Dtoc( ( dbfFacPrvT )->dfecFac ) + Space( 1 ) )
                  :SetMensaje(      Chr(13)+Chr(10) )
                  :SetMensaje(      Chr(13)+Chr(10) )
                  :SetMensaje(      "Reciba un cordial saludo." )

                  :GeneralResource( dbfFacPrvT, aItmFacPrv() )

               end

            end

      end

   end





   oFr:DestroyFr()

Return .T.





FUNCTION nIncUFacPrv( dbfTmpLin, nDec, nVdv )

   local nCalculo

   IIF( nDec == nil, nDec := 0, ) ;
   IIF( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacPrv( dbfTmpLin, nDec, nVdv )

   if !( dbfTmpLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfTmpLin )->nIva / 100
   end

    IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
    end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nIncLFacPrv( dbfLin, nDec, nRouDec, nVdv )

   local nCalculo := nTotLFacPrv( dbfLin, nDec, nRouDec, nVdv )

   if !( dbfLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfLin )->nIva / 100
   end

RETURN ( nCalculo )



Static Function YearComboBoxChange()

     if oWndBrw:oWndBar:lAllYearComboBox()
        DestroyFastFilter( dbfFacPrvT )
      CreateUserFilter( "", dbfFacPrvT, .F., , , "all" )
     else
        DestroyFastFilter( dbfFacPrvT )
      CreateUserFilter( "Year( Field->dFecFac ) == " + oWndBrw:oWndBar:cYearComboBox(), dbfFacPrvT, .F., , , "Year( Field->dFecFac ) == " + oWndBrw:oWndBar:cYearComboBox() )
     end

     ( dbfFacPrvT )->( dbGoTop() )

     oWndBrw:Refresh()

Return nil



Static Function AddLineasAlbaranProveedor( cAlbaran, lNewLin )

   local nNumLin
   local nNewLin

   IIF( lNewLin == nil, lNewLin := .F., ) ;





   if ( dbfAlbPrvL )->( dbSeek( cAlbaran ) )

      while ( ( dbfAlbPrvL )->cSerAlb + Str( ( dbfAlbPrvL )->nNumAlb ) + ( dbfAlbPrvL )->cSufAlb == cAlbaran ) .AND. !( dbfAlbPrvL )->( eof() )

         nNumLin                 := ( dbfAlbPrvL )->nNumLin

         ( dbfTmp )->( dbAppend() )

         if lNewLin
            nNewLin              := nLastNum( dbfTmp )
            ( dbfTmp )->nNumLin  := nNewLin
         else
            ( dbfTmp )->nNumLin  := nNumLin
         end

         ( dbfTmp )->cRef        := ( dbfAlbPrvL )->cRef
         ( dbfTmp )->cDetalle    := ( dbfAlbPrvL )->cDetalle
         ( dbfTmp )->mLngDes     := ( dbfAlbPrvL )->mLngDes
         ( dbfTmp )->mNumSer     := ( dbfAlbPrvL )->mNumSer
         ( dbfTmp )->nIva        := ( dbfAlbPrvL )->nIva
         ( dbfTmp )->nReq        := ( dbfAlbPrvL )->nReq
         ( dbfTmp )->nPreUnit    := ( dbfAlbPrvL )->nPreDiv
         ( dbfTmp )->nPreCom     := ( dbfAlbPrvL )->nPreCom
         ( dbfTmp )->nUniCaja    := ( dbfAlbPrvL )->nUniCaja
         ( dbfTmp )->nCanEnt     := ( dbfAlbPrvL )->nCanEnt
         ( dbfTmp )->nDtoLin     := ( dbfAlbPrvL )->nDtoLin
         ( dbfTmp )->nDtoPrm     := ( dbfAlbPrvL )->nDtoPrm
         ( dbfTmp )->nDtoRap     := ( dbfAlbPrvL )->nDtoRap
         ( dbfTmp )->cAlmLin     := ( dbfAlbPrvL )->cAlmLin
         ( dbfTmp )->nUndKit     := ( dbfAlbPrvL )->nUndKit
         ( dbfTmp )->lKitChl     := ( dbfAlbPrvL )->lKitChl
         ( dbfTmp )->lKitArt     := ( dbfAlbPrvL )->lKitArt
         ( dbfTmp )->lKitPrc     := ( dbfAlbPrvL )->lKitPrc
         ( dbfTmp )->lIvaLin     := ( dbfAlbPrvL )->lIvaLin
         ( dbfTmp )->cCodPr1     := ( dbfAlbPrvL )->cCodPr1
         ( dbfTmp )->cCodPr2     := ( dbfAlbPrvL )->cCodPr2
         ( dbfTmp )->cValPr1     := ( dbfAlbPrvL )->cValPr1
         ( dbfTmp )->cValPr2     := ( dbfAlbPrvL )->cValPr2
         ( dbfTmp )->nBnfLin1    := ( dbfAlbPrvL )->nBnfLin1
         ( dbfTmp )->nBnfLin2    := ( dbfAlbPrvL )->nBnfLin2
         ( dbfTmp )->nBnfLin3    := ( dbfAlbPrvL )->nBnfLin3
         ( dbfTmp )->nBnfLin4    := ( dbfAlbPrvL )->nBnfLin4
         ( dbfTmp )->nBnfLin5    := ( dbfAlbPrvL )->nBnfLin5
         ( dbfTmp )->nBnfLin6    := ( dbfAlbPrvL )->nBnfLin6
         ( dbfTmp )->lBnfLin1    := ( dbfAlbPrvL )->lBnfLin1
         ( dbfTmp )->lBnfLin2    := ( dbfAlbPrvL )->lBnfLin2
         ( dbfTmp )->lBnfLin3    := ( dbfAlbPrvL )->lBnfLin3
         ( dbfTmp )->lBnfLin4    := ( dbfAlbPrvL )->lBnfLin4
         ( dbfTmp )->lBnfLin5    := ( dbfAlbPrvL )->lBnfLin5
         ( dbfTmp )->lBnfLin6    := ( dbfAlbPrvL )->lBnfLin6
         ( dbfTmp )->nPvpLin1    := ( dbfAlbPrvL )->nPvpLin1
         ( dbfTmp )->nPvpLin2    := ( dbfAlbPrvL )->nPvpLin2
         ( dbfTmp )->nPvpLin3    := ( dbfAlbPrvL )->nPvpLin3
         ( dbfTmp )->nPvpLin4    := ( dbfAlbPrvL )->nPvpLin4
         ( dbfTmp )->nPvpLin5    := ( dbfAlbPrvL )->nPvpLin5
         ( dbfTmp )->nPvpLin6    := ( dbfAlbPrvL )->nPvpLin6
         ( dbfTmp )->nIvaLin1    := ( dbfAlbPrvL )->nIvaLin1
         ( dbfTmp )->nIvaLin2    := ( dbfAlbPrvL )->nIvaLin2
         ( dbfTmp )->nIvaLin3    := ( dbfAlbPrvL )->nIvaLin3
         ( dbfTmp )->nIvaLin4    := ( dbfAlbPrvL )->nIvaLin4
         ( dbfTmp )->nIvaLin5    := ( dbfAlbPrvL )->nIvaLin5
         ( dbfTmp )->nIvaLin6    := ( dbfAlbPrvL )->nIvaLin6
         ( dbfTmp )->lLote       := ( dbfAlbPrvL )->lLote
         ( dbfTmp )->nLote       := ( dbfAlbPrvL )->nLote
         ( dbfTmp )->cLote       := ( dbfAlbPrvL )->cLote
         ( dbfTmp )->mObsLin     := ( dbfAlbPrvL )->mObsLin
         ( dbfTmp )->cRefPrv     := ( dbfAlbPrvL )->cRefPrv
         ( dbfTmp )->cUnidad     := ( dbfAlbPrvL )->cUnidad
         ( dbfTmp )->nNumMed     := ( dbfAlbPrvL )->nNumMed
         ( dbfTmp )->nMedUno     := ( dbfAlbPrvL )->nMedUno
         ( dbfTmp )->nMedDos     := ( dbfAlbPrvL )->nMedDos
         ( dbfTmp )->nMedTre     := ( dbfAlbPrvL )->nMedTre
         ( dbfTmp )->dFecCad     := ( dbfAlbPrvL )->dFecCad





         if ( dbfAlbPrvS )->( dbSeek( cAlbaran + Str( nNumLin ) ) )

            while ( ( dbfAlbPrvS )->cSerAlb + Str( ( dbfAlbPrvS )->nNumAlb ) + ( dbfAlbPrvS )->cSufAlb + Str( ( dbfAlbPrvS )->nNumLin ) == cAlbaran + Str( nNumLin ) ) .AND. !( dbfAlbPrvS )->( eof() )

               ( dbfTmpSer )->( dbAppend() )

               if lNewLin
                  ( dbfTmpSer )->nNumLin  := nNewLin
               else
                  ( dbfTmpSer )->nNumLin  := nNumLin
               end

               ( dbfTmpSer )->cSerFac     := ( dbfAlbPrvS )->cSerAlb
               ( dbfTmpSer )->nNumFac     := ( dbfAlbPrvS )->nNumAlb
               ( dbfTmpSer )->cSufFac     := ( dbfAlbPrvS )->cSufAlb
               ( dbfTmpSer )->cRef        := ( dbfAlbPrvS )->cRef
               ( dbfTmpSer )->cAlmLin     := ( dbfAlbPrvS )->cAlmLin
               ( dbfTmpSer )->lUndNeg     := ( dbfAlbPrvS )->lUndNeg
               ( dbfTmpSer )->cNumSer     := ( dbfAlbPrvS )->cNumSer

               ( dbfAlbPrvS )->( dbSkip() )

            end

         end

         ( dbfAlbPrvL )->( dbSkip() )

      end

      ( dbfTmp )->( dbGoTop() )

   end

Return ( nil )



Function BrwFacPrv( oGet, oIva )

    local oDlg
    local oBrw
   local nOrd
   local oGet1
   local cGet1
   local oCbxOrd
   local cCbxOrd
   local aCbxOrd

   if !OpenFiles()
      Return .F.
   end

   aCbxOrd           := { "Número", "Fecha", "Proveedor", "Nombre" }
   nOrd              := GetBrwOpt( "BrwFacPrv" )
   nOrd              := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrd ]

   oDlg = TDialog():New(,,,, "Facturas rectificativas de clientes", "HelpEntry",, .F.,,,,,, .F.,,,,,, .F., )






        oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, dbfFacPrvT ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, dbfFacPrvT, nil, nil, .F. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( dbfFacPrvT )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:refresh(), oGet1:SetFocus() )},,,, .F.,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := dbfFacPrvT
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Factura de proveedores.Browse"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( dbfFacPrvT )->cSerFac + "/" + RTrim( Str( ( dbfFacPrvT )->nNumFac ) ) + "/" + ( dbfFacPrvT )->cSufFac }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecFac"
         :bEditValue       := {|| Dtoc( ( dbfFacPrvT )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Proveedor"
         :cSortOrder       := "cCodPrv"
         :bEditValue       := {|| Rtrim( ( dbfFacPrvT )->cCodPrv ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomPrv"
         :bEditValue       := {|| Rtrim( ( dbfFacPrvT )->cNomPrv ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotFacPrv( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, dbfFacPrvP, nil, cDivEmp(), .T. ) }
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end





        TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )





        TButton():ReDefine( 501, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )




        TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   if oDlg:nResult == 1
      oGet:cText( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac )
      oGet:bWhen   := {|| .F. }
   end

   SetBrwOpt( "BrwFacPrv", ( dbfFacPrvT )->( OrdNumber() ) )

   ( dbfFacPrvT )->( dbClearFilter() )

   CloseFiles()





   oBrw:CloseData()

RETURN ( oDlg:nResult == 1 )



Static Function EditarNumerosSerie( aTmp, nMode )

   AutoNumerosSerie( aTmp, nMode )

   oNumerosSerie:Resource()

Return ( nil )



Static Function AutoNumerosSerie( aTmp, nMode )

   oNumerosSerie:nMode              := nMode

   oNumerosSerie:cCodArt            := aTmp[ 4    ]
   oNumerosSerie:cCodAlm            := aTmp[ 57 ]
   oNumerosSerie:nNumLin            := aTmp[ 62 ]
   oNumerosSerie:lAutoSerializacion := aTmp[ 96 ]

   oNumerosSerie:nTotalUnidades     := nTotNFacPrv( aTmp )

   oNumerosSerie:uTmpSer            := dbfTmpSer

   if oNumerosSerie:lAutoSerializacion
       oNumerosSerie:AutoSerializa()
   end

Return ( nil )



FUNCTION BrowseInformesFacPrv( oGet, oGet2 )

    local oDlg
    local oBrw
   local oGet1
   local cGet1
   local oCbxOrd
   local cCbxOrd
   local nOrd
   local aCbxOrd

   if !OpenFiles()
      Return .F.
   end

   aCbxOrd           := { "Número", "Fecha", "Proveedor", "Nombre" }
   nOrd              := GetBrwOpt( "BrwFacPrv" )
   nOrd              := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrd ]

   oDlg = TDialog():New(,,,, "Facturas de proveedor", "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F., )






        oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, dbfFacPrvT ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, dbfFacPrvT, nil, nil, .F. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( dbfFacPrvT )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:refresh(), oGet1:SetFocus() )},,,, .F.,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := dbfFacPrvT
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Factura de proveedor.Browse informes"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( dbfFacPrvT )->cSerFac + "/" + RTrim( Str( ( dbfFacPrvT )->nNumFac ) ) + "/" + ( dbfFacPrvT )->cSufFac }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecFac"
         :bEditValue       := {|| Dtoc( ( dbfFacPrvT )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Proveedor"
         :cSortOrder       := "cCodPrv"
         :bEditValue       := {|| Rtrim( ( dbfFacPrvT )->cCodPrv ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| Rtrim( ( dbfFacPrvT )->cNomPrv ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotFacPrv( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, dbfFacPrvP, nil, cDivEmp(), .F. ) }
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end





        TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )





        TButton():ReDefine( 501, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )




        TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   if oDlg:nResult == 1
      oGet:cText( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac )
      oGet2:cText( ( dbfFacPrvT )->cNomPrv )
   end

   SetBrwOpt( "BrwFacPrv", ( dbfFacPrvT )->( OrdNumber() ) )

   ( dbfFacPrvT )->( dbClearFilter() )

   CloseFiles()





   oBrw:CloseData()

RETURN ( oDlg:nResult == 1 )



FUNCTION lValidInformeFacPrv( oGet, oGet2 )

   local lClose   := .F.
   local lValid   := .F.
    local xValor     := oGet:varGet()

   if Empty( xValor )
      return .T.
   end

   if !OpenFiles()
      Return .F.
   end

   if ( dbfFacPrvT )->( dbSeek( xValor ) )

      oGet:cText( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac )

      oGet2:cText( ( dbfFacPrvT )->cNomPrv )

      lValid   := .T.

   else

      msgStop( "Factura no encontrada" )

   end

   CloseFiles()

RETURN lValid
